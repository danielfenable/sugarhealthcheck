/*
     YUI 3.15.0 (build 834026e)
     Copyright 2014 Yahoo! Inc. All rights reserved.
     Licensed under the BSD License.
     http://yuilibrary.com/license/
     */
YUI.add('datatable-body',function(Y,NAME){var Lang=Y.Lang,isArray=Lang.isArray,isNumber=Lang.isNumber,isString=Lang.isString,fromTemplate=Lang.sub,htmlEscape=Y.Escape.html,toArray=Y.Array,bind=Y.bind,YObject=Y.Object,valueRegExp=/\{value\}/g,EV_CONTENT_UPDATE='contentUpdate';Y.namespace('DataTable').BodyView=Y.Base.create('tableBody',Y.View,[],{CELL_TEMPLATE:'<td {headers} class="{className}">{content}</td>',ROW_TEMPLATE:'<tr id="{rowId}" data-yui3-record="{clientId}" class="{rowClass}">{content}</tr>',TBODY_TEMPLATE:'<tbody class="{className}"></tbody>',getCell:function(seed,shift){var tbody=this.tbodyNode,row,cell,index,rowIndexOffset;if(seed&&tbody){if(isArray(seed)){row=tbody.get('children').item(seed[0]);cell=row&&row.get('children').item(seed[1]);}else if(Y.instanceOf(seed,Y.Node)){cell=seed.ancestor('.'+this.getClassName('cell'),true);}
if(cell&&shift){rowIndexOffset=tbody.get('firstChild.rowIndex');if(isString(shift)){switch(shift){case'above':shift=[-1,0];break;case'below':shift=[1,0];break;case'next':shift=[0,1];break;case'previous':shift=[0,-1];break;}}
if(isArray(shift)){index=cell.get('parentNode.rowIndex')+
shift[0]-rowIndexOffset;row=tbody.get('children').item(index);index=cell.get('cellIndex')+shift[1];cell=row&&row.get('children').item(index);}}}
return cell||null;},getClassName:function(){var host=this.host,args;if(host&&host.getClassName){return host.getClassName.apply(host,arguments);}else{args=toArray(arguments);args.unshift(this.constructor.NAME);return Y.ClassNameManager.getClassName.apply(Y.ClassNameManager,args);}},getRecord:function(seed){var modelList=this.get('modelList'),tbody=this.tbodyNode,row=null,record;if(tbody){if(isString(seed)){seed=tbody.one('#'+seed);}
if(Y.instanceOf(seed,Y.Node)){row=seed.ancestor(function(node){return node.get('parentNode').compareTo(tbody);},true);record=row&&modelList.getByClientId(row.getData('yui3-record'));}}
return record||null;},getRow:function(id){var tbody=this.tbodyNode,row=null;if(tbody){if(id){id=this._idMap[id.get?id.get('clientId'):id]||id;}
row=isNumber(id)?tbody.get('children').item(id):tbody.one('#'+id);}
return row;},render:function(){var table=this.get('container'),data=this.get('modelList'),displayCols=this.get('columns'),tbody=this.tbodyNode||(this.tbodyNode=this._createTBodyNode());this._createRowTemplate(displayCols);if(data){tbody.setHTML(this._createDataHTML(displayCols));this._applyNodeFormatters(tbody,displayCols);}
if(tbody.get('parentNode')!==table){table.appendChild(tbody);}
this.bindUI();return this;},refreshRow:function(row,model,colKeys){var col,cell,len=colKeys.length,i;for(i=0;i<len;i++){col=this.getColumn(colKeys[i]);if(col!==null){cell=row.one('.'+this.getClassName('col',col._id||col.key));this.refreshCell(cell,model);}}
return this;},refreshCell:function(cell,model,col){var content,formatterFn,formatterData,data=model.toJSON();cell=this.getCell(cell);model||(model=this.getRecord(cell));col||(col=this.getColumn(cell));if(col.nodeFormatter){formatterData={cell:cell.one('.'+this.getClassName('liner'))||cell,column:col,data:data,record:model,rowIndex:this._getRowIndex(cell.ancestor('tr')),td:cell,value:data[col.key]};keep=col.nodeFormatter.call(host,formatterData);if(keep===false){cell.destroy(true);}}else if(col.formatter){if(!col._formatterFn){col=this._setColumnsFormatterFn([col])[0];}
formatterFn=col._formatterFn||null;if(formatterFn){formatterData={value:data[col.key],data:data,column:col,record:model,className:'',rowClass:'',rowIndex:this._getRowIndex(cell.ancestor('tr'))};content=formatterFn.call(this.get('host'),formatterData);if(content===undefined){content=formatterData.value;}}
if(content===undefined||content===null||content===''){content=col.emptyCellValue||'';}}else{content=data[col.key]||col.emptyCellValue||'';}
cell.setHTML(col.allowHTML?content:Y.Escape.html(content));return this;},getColumn:function(name){if(Y.instanceOf(name,Y.Node)){name=name.get('className').match(new RegExp(this.getClassName('col')+'-([^ ]*)'))[1];}
if(this.host){return this.host._columnMap[name]||null;}
var displayCols=this.get('columns'),col=null;Y.Array.some(displayCols,function(_col){if((_col._id||_col.key)===name){col=_col;return true;}});return col;},_afterColumnsChange:function(){this.render();},_afterDataChange:function(e){var type=(e.type.match(/:(add|change|remove)$/)||[])[1],index=e.index,displayCols=this.get('columns'),col,changed=e.changed&&Y.Object.keys(e.changed),key,row,i,len;for(i=0,len=displayCols.length;i<len;i++){col=displayCols[i];if(col.hasOwnProperty('nodeFormatter')){this.render();this.fire(EV_CONTENT_UPDATE);return;}}
switch(type){case'change':for(i=0,len=displayCols.length;i<len;i++){col=displayCols[i];key=col.key;if(col.formatter&&!e.changed[key]){changed.push(key);}}
this.refreshRow(this.getRow(e.target),e.target,changed);break;case'add':index=Math.min(index,this.get('modelList').size()-1);this._setColumnsFormatterFn(displayCols);row=Y.Node.create(this._createRowHTML(e.model,index,displayCols));this.tbodyNode.insert(row,index);this._restripe(index);break;case'remove':this.getRow(index).remove(true);this._restripe(index-1);break;default:this.render();}
this.fire(EV_CONTENT_UPDATE);},_restripe:function(index){var task=this._restripeTask,self;index=Math.max((index|0),0);if(!task){self=this;this._restripeTask={timer:setTimeout(function(){if(!self||self.get('destroy')||!self.tbodyNode||!self.tbodyNode.inDoc()){self._restripeTask=null;return;}
var odd=[self.CLASS_ODD,self.CLASS_EVEN],even=[self.CLASS_EVEN,self.CLASS_ODD],index=self._restripeTask.index;self.tbodyNode.get('childNodes').slice(index).each(function(row,i){row.replaceClass.apply(row,(index+i)%2?even:odd);});self._restripeTask=null;},0),index:index};}else{task.index=Math.min(task.index,index);}},_afterModelListChange:function(){var handles=this._eventHandles;if(handles.dataChange){handles.dataChange.detach();delete handles.dataChange;this.bindUI();}
if(this.tbodyNode){this.render();}},_applyNodeFormatters:function(tbody,displayCols){var host=this.host||this,data=this.get('modelList'),formatters=[],linerQuery='.'+this.getClassName('liner'),rows,i,len;for(i=0,len=displayCols.length;i<len;++i){if(displayCols[i].nodeFormatter){formatters.push(i);}}
if(data&&formatters.length){rows=tbody.get('childNodes');data.each(function(record,index){var formatterData={data:record.toJSON(),record:record,rowIndex:index},row=rows.item(index),i,len,col,key,cells,cell,keep;if(row){cells=row.get('childNodes');for(i=0,len=formatters.length;i<len;++i){cell=cells.item(formatters[i]);if(cell){col=formatterData.column=displayCols[formatters[i]];key=col.key||col.id;formatterData.value=record.get(key);formatterData.td=cell;formatterData.cell=cell.one(linerQuery)||cell;keep=col.nodeFormatter.call(host,formatterData);if(keep===false){cell.destroy(true);}}}}});}},bindUI:function(){var handles=this._eventHandles,modelList=this.get('modelList'),changeEvent=modelList.model.NAME+':change';if(!handles.columnsChange){handles.columnsChange=this.after('columnsChange',bind('_afterColumnsChange',this));}
if(modelList&&!handles.dataChange){handles.dataChange=modelList.after(['add','remove','reset',changeEvent],bind('_afterDataChange',this));}},_createDataHTML:function(displayCols){var data=this.get('modelList'),html='';if(data){data.each(function(model,index){html+=this._createRowHTML(model,index,displayCols);},this);}
return html;},_createRowHTML:function(model,index,displayCols){var data=model.toJSON(),clientId=model.get('clientId'),values={rowId:this._getRowId(clientId),clientId:clientId,rowClass:(index%2)?this.CLASS_ODD:this.CLASS_EVEN},host=this.host||this,i,len,col,token,value,formatterData;for(i=0,len=displayCols.length;i<len;++i){col=displayCols[i];value=data[col.key];token=col._id||col.key;values[token+'-className']='';if(col._formatterFn){formatterData={value:value,data:data,column:col,record:model,className:'',rowClass:'',rowIndex:index};value=col._formatterFn.call(host,formatterData);if(value===undefined){value=formatterData.value;}
values[token+'-className']=formatterData.className;values.rowClass+=' '+formatterData.rowClass;}
if(!values.hasOwnProperty(token)||data.hasOwnProperty(col.key)){if(value===undefined||value===null||value===''){value=col.emptyCellValue||'';}
values[token]=col.allowHTML?value:htmlEscape(value);}}
values.rowClass=values.rowClass.replace(/\s+/g,' ');return fromTemplate(this._rowTemplate,values);},_getRowIndex:function(row){var tbody=this.tbodyNode,index=1;if(tbody&&row){if(row.ancestor('tbody')!==tbody){return null;}
while(row=row.previous()){index++;}}
return index;},_createRowTemplate:function(displayCols){var html='',cellTemplate=this.CELL_TEMPLATE,i,len,col,key,token,headers,tokenValues,formatter;this._setColumnsFormatterFn(displayCols);for(i=0,len=displayCols.length;i<len;++i){col=displayCols[i];key=col.key;token=col._id||key;formatter=col._formatterFn;headers=(col._headers||[]).length>1?'headers="'+col._headers.join(' ')+'"':'';tokenValues={content:'{'+token+'}',headers:headers,className:this.getClassName('col',token)+' '+
(col.className||'')+' '+
this.getClassName('cell')+' {'+token+'-className}'};if(!formatter&&col.formatter){tokenValues.content=col.formatter.replace(valueRegExp,tokenValues.content);}
if(col.nodeFormatter){tokenValues.content='';}
html+=fromTemplate(col.cellTemplate||cellTemplate,tokenValues);}
this._rowTemplate=fromTemplate(this.ROW_TEMPLATE,{content:html});},_setColumnsFormatterFn:function(displayCols){var Formatters=Y.DataTable.BodyView.Formatters,formatter,col,i,len;for(i=0,len=displayCols.length;i<len;i++){col=displayCols[i];formatter=col.formatter;if(!col._formatterFn&&formatter){if(Lang.isFunction(formatter)){col._formatterFn=formatter;}else if(formatter in Formatters){col._formatterFn=Formatters[formatter].call(this.host||this,col);}}}
return displayCols;},_createTBodyNode:function(){return Y.Node.create(fromTemplate(this.TBODY_TEMPLATE,{className:this.getClassName('data')}));},destructor:function(){(new Y.EventHandle(YObject.values(this._eventHandles))).detach();},_getRowId:function(clientId){return this._idMap[clientId]||(this._idMap[clientId]=Y.guid());},initializer:function(config){this.host=config.host;this._eventHandles={modelListChange:this.after('modelListChange',bind('_afterModelListChange',this))};this._idMap={};this.CLASS_ODD=this.getClassName('odd');this.CLASS_EVEN=this.getClassName('even');}},{Formatters:{}});},'3.15.0',{"requires":["datatable-core","view","classnamemanager"]});