/*
     YUI 3.15.0 (build 834026e)
     Copyright 2014 Yahoo! Inc. All rights reserved.
     Licensed under the BSD License.
     http://yuilibrary.com/license/
     */
YUI.add('datatable-keynav',function(Y,NAME){var arrEach=Y.Array.each,DtKeyNav=function(){};DtKeyNav.KEY_NAMES={8:'backspace',9:'tab',13:'enter',27:'esc',32:'space',33:'pgup',34:'pgdown',35:'end',36:'home',37:'left',38:'up',39:'right',40:'down',112:'f1',113:'f2',114:'f3',115:'f4',116:'f5',117:'f6',118:'f7',119:'f8',120:'f9',121:'f10',122:'f11',123:'f12'};DtKeyNav.ARIA_ACTIONS={left:'_keyMoveLeft',right:'_keyMoveRight',up:'_keyMoveUp',down:'_keyMoveDown',home:'_keyMoveRowStart',end:'_keyMoveRowEnd',pgup:'_keyMoveColTop',pgdown:'_keyMoveColBottom'};DtKeyNav.ATTRS={focusedCell:{setter:'_focusedCellSetter'},keyIntoHeaders:{value:true}};Y.mix(DtKeyNav.prototype,{keyActions:null,_keyNavSubscr:null,_keyNavTHead:null,_keyNavNestedHeaders:false,_keyNavColPrefix:null,_keyNavColRegExp:null,initializer:function(){this.onceAfter('render',this._afterKeyNavRender);this._keyNavSubscr=[this.after('focusedCellChange',this._afterKeyNavFocusedCellChange),this.after('focusedChange',this._afterKeyNavFocusedChange)];this._keyNavColPrefix=this.getClassName('col','');this._keyNavColRegExp=new RegExp(this._keyNavColPrefix+'(.+?)(\\s|$)');this.keyActions=Y.clone(DtKeyNav.ARIA_ACTIONS);},destructor:function(){arrEach(this._keyNavSubscr,function(evHandle){if(evHandle&&evHandle.detach){evHandle.detach();}});},_afterKeyNavFocusedCellChange:function(e){var newVal=e.newVal,prevVal=e.prevVal;if(prevVal){prevVal.set('tabIndex',-1);}
if(newVal){newVal.set('tabIndex',0);if(this.get('focused')){newVal.scrollIntoView();newVal.focus();}}else{this.set('focused',null);}},_afterKeyNavFocusedChange:function(e){var cell=this.get('focusedCell');if(e.newVal){if(cell){cell.scrollIntoView();cell.focus();}else{this._keyMoveFirst();}}else{if(cell){cell.blur();}}},_afterKeyNavRender:function(){var cbx=this.get('contentBox');this._keyNavSubscr.push(cbx.on('keydown',this._onKeyNavKeyDown,this),cbx.on('click',this._onKeyNavClick,this));this._keyNavTHead=(this._yScrollHeader||this._tableNode).one('thead');this._keyMoveFirst();this._keyNavNestedHeaders=(this.get('columns').length!==this.head.theadNode.all('th').size());},_onKeyNavClick:function(e){var cell=e.target.ancestor((this.get('keyIntoHeaders')?'td, th':'td'),true);if(cell){this.focus();this.set('focusedCell',cell);}},_onKeyNavKeyDown:function(e){var keyCode=e.keyCode,keyName=DtKeyNav.KEY_NAMES[keyCode]||keyCode,action;arrEach(['alt','ctrl','meta','shift'],function(modifier){if(e[modifier+'Key']){keyCode=modifier+'-'+keyCode;keyName=modifier+'-'+keyName;}});action=this.keyActions[keyCode]||this.keyActions[keyName];if(typeof action==='string'){if(this[action]){this[action].call(this,e);}else{this._keyNavFireEvent(action,e);}}else{action.call(this,e);}},_keyNavFireEvent:function(action,e){var cell=e.target.ancestor('td, th',true);if(cell){this.fire(action,{cell:cell,row:cell.ancestor('tr'),record:this.getRecord(cell),column:this.getColumn(cell.get('cellIndex'))},e);}},_keyMoveFirst:function(){this.set('focusedCell',(this.get('keyIntoHeaders')?this._keyNavTHead.one('th'):this._tbodyNode.one('td')),{src:'keyNav'});},_keyMoveLeft:function(e){var cell=this.get('focusedCell'),index=cell.get('cellIndex'),row=cell.ancestor();e.preventDefault();if(index===0){return;}
cell=row.get('cells').item(index-1);this.set('focusedCell',cell,{src:'keyNav'});},_keyMoveRight:function(e){var cell=this.get('focusedCell'),row=cell.ancestor('tr'),section=row.ancestor(),inHead=section===this._keyNavTHead,nextCell,parent;e.preventDefault();nextCell=cell.next();if(row.get('rowIndex')!==0&&inHead&&this._keyNavNestedHeaders){if(nextCell){cell=nextCell;}else{parent=this._getTHParent(cell);if(parent&&parent.next()){cell=parent.next();}else{return;}}}else{if(!nextCell){return;}else{cell=nextCell;}}
this.set('focusedCell',cell,{src:'keyNav'});},_keyMoveUp:function(e){var cell=this.get('focusedCell'),cellIndex=cell.get('cellIndex'),row=cell.ancestor('tr'),rowIndex=row.get('rowIndex'),section=row.ancestor(),sectionRows=section.get('rows'),inHead=section===this._keyNavTHead,parent;e.preventDefault();if(!inHead){rowIndex-=section.get('firstChild').get('rowIndex');}
if(rowIndex===0){if(inHead||!this.get('keyIntoHeaders')){return;}
section=this._keyNavTHead;sectionRows=section.get('rows');if(this._keyNavNestedHeaders){key=this._getCellColumnName(cell);cell=section.one('.'+this._keyNavColPrefix+key);cellIndex=cell.get('cellIndex');row=cell.ancestor('tr');}else{row=section.get('firstChild');cell=row.get('cells').item(cellIndex);}}else{if(inHead&&this._keyNavNestedHeaders){key=this._getCellColumnName(cell);parent=this._columnMap[key]._parent;if(parent){cell=section.one('#'+parent.id);}}else{row=sectionRows.item(rowIndex-1);cell=row.get('cells').item(cellIndex);}}
this.set('focusedCell',cell);},_keyMoveDown:function(e){var cell=this.get('focusedCell'),cellIndex=cell.get('cellIndex'),row=cell.ancestor('tr'),rowIndex=row.get('rowIndex')+1,section=row.ancestor(),inHead=section===this._keyNavTHead,tbody=(this.body&&this.body.tbodyNode),sectionRows=section.get('rows'),key,children;e.preventDefault();if(inHead){if(this._keyNavNestedHeaders){key=this._getCellColumnName(cell);children=this._columnMap[key].children;rowIndex+=(cell.getAttribute('rowspan')||1)-1;if(children){cell=section.one('#'+children[0].id);}else{cell=tbody.one('.'+this._keyNavColPrefix+key);section=tbody;sectionRows=section.get('rows');}
cellIndex=cell.get('cellIndex');}else{row=tbody.one('tr');cell=row.get('cells').item(cellIndex);}}
rowIndex-=sectionRows.item(0).get('rowIndex');if(rowIndex>=sectionRows.size()){if(!inHead){return;}
section=tbody;row=section.one('tr');}else{row=sectionRows.item(rowIndex);}
this.set('focusedCell',row.get('cells').item(cellIndex));},_keyMoveRowStart:function(e){var row=this.get('focusedCell').ancestor();this.set('focusedCell',row.get('firstChild'),{src:'keyNav'});e.preventDefault();},_keyMoveRowEnd:function(e){var row=this.get('focusedCell').ancestor();this.set('focusedCell',row.get('lastChild'),{src:'keyNav'});e.preventDefault();},_keyMoveColTop:function(e){var cell=this.get('focusedCell'),cellIndex=cell.get('cellIndex'),key,header;e.preventDefault();if(this._keyNavNestedHeaders&&this.get('keyIntoHeaders')){key=this._getCellColumnName(cell);header=this._columnMap[key];while(header._parent){header=header._parent;}
cell=this._keyNavTHead.one('#'+header.id);}else{cell=(this.get('keyIntoHeaders')?this._keyNavTHead:this._tbodyNode).get('firstChild').get('cells').item(cellIndex);}
this.set('focusedCell',cell,{src:'keyNav'});},_keyMoveColBottom:function(e){var cell=this.get('focusedCell'),cellIndex=cell.get('cellIndex');this.set('focusedCell',this._tbodyNode.get('lastChild').get('cells').item(cellIndex),{src:'keyNav'});e.preventDefault();},_focusedCellSetter:function(cell){if(cell instanceof Y.Node){var tag=cell.get('tagName').toUpperCase();if((tag==='TD'||tag==='TH')&&this.get('contentBox').contains(cell)){return cell;}}else if(cell===null){return cell;}
return Y.Attribute.INVALID_VALUE;},_getTHParent:function(thCell){var key=this._getCellColumnName(thCell),parent=this._columnMap[key]&&this._columnMap[key]._parent;if(parent){return thCell.ancestor().ancestor().one('.'+this._keyNavColPrefix+parent.key);}
return null;},_getCellColumnName:function(cell){return cell.getData('yui3-col-id')||this._keyNavColRegExp.exec(cell.get('className'))[1];}});Y.DataTable.KeyNav=DtKeyNav;Y.Base.mix(Y.DataTable,[DtKeyNav]);},'3.15.0',{"requires":["datatable-base"]});