/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({extendsFrom:'DnbView',plugins:['Connector'],events:{'click .importContacts':'importContacts','click .backToContactsList':'backToContactsList','click .dnb-cnt-prem':'baseGetContactDetails','click .dnb-cnt-std':'baseGetContactDetails','click [data-action="show-more"]':'invokePagination'},selectors:{'load':'#dnb-bal-result-loading','rslt':'#dnb-bal-result','rsltList':'ul#dnb-results-list','contactrslt':'#dnb-bal-contact-list'},initialize:function(options){this._super('initialize',[options]);this.initDashlet();app.events.on('dnbbal:invoke',this.invokeBAL,this);var originalMeta=app.metadata.getView('','dnb-bal-results');if(originalMeta.import_enabled_modules){this.import_enabled_modules=originalMeta.import_enabled_modules;}
this.paginationCallback=this.baseContactsBAL;this.rowTmpl=app.template.get(this.name+'.dnb-contact-row');this.resultTemplate=app.template.get(this.name+'.dnb-bal-contacts-rslt');this.resultCountTmpl=app.lang.get('LBL_DNB_BAL_RSLT_CNT',this.module);},_render:function(){app.view.View.prototype._renderHtml.call(this);this.$('#importType').select2();},loadData:function(options){this.checkConnector('ext_rest_dnb',_.bind(this.loadDataWithValidConnector,this),_.bind(this.handleLoadError,this),['test_passed']);},loadDataWithValidConnector:function(){this.template=app.template.get(this.name+'.dnb-bal-hint');this.render();this.dnbError=null;this.initPaginationParams();},handleLoadError:function(connector){var showAdmin=app.acl.hasAccess('admin','Administration');if(showAdmin){this.dnbError={'errMsg':'LBL_DNB_NOT_CONFIGURED','errorLink':this.commonConst.connectorSettingsURL,'label':'LBL_DNB_BAL'};}else{this.dnbError={'errMsg':'LBL_DNB_CONNECTOR_ERR','label':'LBL_DNB_BAL'};}
this.template=app.template.get('dnb.dnb-sidepane-error');this.render();},invokeBAL:function(balParams){if(!_.isEmpty(balParams)){this.initPaginationParams();this.balParams=balParams;this.buildAList(this.setApiPaginationParams(balParams));}else{this.loadData();}},buildAList:function(balParams){if(this.disposed){return;}
this.template=this.resultTemplate;if(this.listData&&this.listData.count){delete this.listData['count'];}
this.render();this.$(this.selectors.load).removeClass('hide');this.$(this.selectors.rslt).addClass('hide');balParams.contactType=this.module;this.baseContactsBAL(balParams,this.renderBAL);},renderBAL:function(dnbApiResponse){var dnbContactsList={},appendRecords=false;if(this.resetPaginationFlag){this.initPaginationParams();}
if(dnbApiResponse.product){var apiContactList=this.getJsonNode(dnbApiResponse.product,this.contactConst.contactsPath);this.formattedRecordSet=this.formatContactList(apiContactList,this.contactsListDD);this.recordCount=this.getJsonNode(dnbApiResponse.product,this.contactConst.srchCount);var nextPage=this.paginateRecords();if(_.isNull(this.currentPage)){this.currentPage=nextPage;dnbContactsList.product=this.currentPage;}else{dnbContactsList.product=nextPage;appendRecords=true;}
if(this.recordCount){dnbContactsList.count=this.recordCount;}}else if(dnbApiResponse.errmsg){dnbContactsList.errmsg=dnbApiResponse.errmsg;}
this.renderPage(dnbContactsList,appendRecords);},backToContactsList:function(){if(this.disposed){return;}
this.template=this.resultTemplate;if(this.listData&&this.listData.count){delete this.listData['count'];}
this.render();this.$(this.selectors.load).removeClass('hide');this.$(this.selectors.rslt).addClass('hide');var dupeCheckParams={'type':this.module,'apiResponse':this.currentPage,'module':'contactsPage'};this.baseDuplicateCheck(dupeCheckParams,this.renderPage);},importContacts:function(){var module=this.$('#importType').val();this.baseImportContact(module);},invokePagination:function(){this._super('invokePagination',[this.paginationCallback,this.balParams,this.renderBAL]);}})