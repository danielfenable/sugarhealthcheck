/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({extendsFrom:'SubpanelListView',contextEvents:{'list:deleterow:fire':'onDeleteRow','list:addrow:fire':'onAddRow'},hasValidModels:true,initialize:function(options){this._super('initialize',[options]);this.template=app.template.getView('subpanel-list-create');this.dataView='subpanel-list-create';this.context.set({dataView:this.dataView,isCreateSubpanel:true});},bindDataChange:function(){this._super('bindDataChange');var link=this.context.get('link');this.context.parent.on('subpanel:validateCollection:'+link,this.validateModels,this);this.context.parent.on('subpanel:resetCollection:'+link,this.resetSubpanel,this);this.collection.on('add remove',this.render,this);this.resetSubpanel();},resetSubpanel:function(){this.collection.reset();this._addBeanToList(true);},render:function(){this._super('render');this._toggleFields(true);_.defer(_.bind(function(){this.checkButtons();},this));},_toggleFields:function(isEdit){isEdit=isEdit||false;_.each(this.collection.models,function(model){this.toggleFields(this.rowFields[model.get('id')],isEdit)
if(isEdit){this.context.trigger("list:editrow:fire",model,{def:{}});}},this);},checkButtons:function(){var delBtns=this.$('.deleteBtn'),addBtns=this.$('.addBtn');if(delBtns&&!$(delBtns[0]).hasClass('disabled')){$(delBtns[0]).addClass('disabled');}
if(addBtns&&addBtns.length>1){_.each(addBtns,function(btn,index){if(index<addBtns.length-1){$(btn).addClass('disabled');}})}},addActions:function(){if(this.actionsAdded){return;}
if(this.meta&&_.isObject(this.meta.rowactions)){this.addRowActions();}
this.actionsAdded=true;},addRowActions:function(){var _generateMeta=function(label,css_class,buttons){return{'type':'fieldset','fields':[{'type':'rowactions-create','label':label||'','css_class':css_class,'buttons':buttons||[],'no_default_action':true}],'value':false,'sortable':false};};var def=this.meta.rowactions;this.rightColumns.push(_generateMeta(def.label,def.css_class,def.actions));},validateModels:function(callback,fromCreateView){fromCreateView=fromCreateView||false;var returnCt=0;this.hasValidModels=true;_.each(this.collection.models,function(model){model.doValidate(this.getFields(this.module),_.bind(function(isValid){returnCt++;if(this.hasValidModels&&!isValid){this.hasValidModels=isValid;}
if(returnCt===this.collection.length){if(fromCreateView){callback(!this.hasValidModels);}else{callback(this.hasValidModels);}}},this));},this);},onAddRow:function(){this.validateModels(_.bind(this._addBeanToList,this));},onDeleteRow:function(model){this.context.get('collection').remove(model);this.checkButtons();},_addBeanToList:function(hasValidModels){if(hasValidModels){var beanId=app.utils.generateUUID(),bean=app.data.createBean(this.module);bean.set({id:beanId});bean._module=this.module;if(this.context.parent&&this.context.parent.has('model')){var parentModel=this.context.parent.get('model'),userId=parentModel.get('assigned_user_id'),userName=parentModel.get('assigned_user_name');if(userId){bean.set('assigned_user_id',userId);}
if(userName){bean.set('assigned_user_name',userName);}}
bean=this._addCustomFieldsToBean(bean);this.collection.add(bean);}
this.checkButtons();},_addCustomFieldsToBean:function(bean){return bean;},_dispose:function(){this.context.parent.off(null,null,this);this._super('_dispose');}})