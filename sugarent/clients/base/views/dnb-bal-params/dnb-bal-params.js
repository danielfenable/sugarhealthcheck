/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({extendsFrom:'DnbView',plugins:['ErrorDecoration','Tooltip'],events:{'change [name="dnb_bal_sale"]':'toggleFormControls','change [name="dnb_bal_founding"]':'toggleFormControls','change [name="dnb_bal_offer_amt"]':'toggleFormControls','change [name="dnb_bal_ipo_price_range"]':'toggleFormControls','change [name="dnb_bal_ipo_date"]':'toggleFormControls','change [name="dnb_bal_emp_cnt"]':'toggleFormControls','change [name="dnb_bal_net_income"]':'toggleFormControls','change [name="dnb_bal_net_income_growth"]':'toggleFormControls','change [name="dnb_bal_assets"]':'toggleFormControls','change [name="dnb_bal_emp_grwth"]':'toggleFormControls','change [name="dnb_bal_mkt_cap"]':'toggleFormControls','change [name="dnb_bal_ipo_date_option_bef_aft"]':'toggleFormControls','click .dnb-bal-add-btn':'populateTagContainer','click .tagcontainer .select2-search-choice-close':'removeTag','change [name="dnb_bal_ctry"]':'mapSelect2Params','change [name="dnb_bal_prescreen_score"]':'mapSelect2Params','change [name="dnb_bal_job_fn"]':'mapSelect2Params','change [name="dnb_bal_ind_code_type"]':'modifyIndustryModel','shown #dnb_bal_accordian':'handlePanelShown','hidden #dnb_bal_accordian':'handlePanelHidden','mouseenter [rel="tooltip"]':'showTooltip','mouseleave [rel="tooltip"]':'hideTooltip'},initialize:function(options){this._super('initialize',[options]);this.balSelector=options.meta.balSelector;this.balParamGroups=options.meta.balParamGroups;app.events.register('dnbbal:invoke',this);app.error.errorName2Keys['comparison']='ERR_DNB_BAL_COMPARISON';app.error.errorName2Keys['taglimit']='LBL_DNB_BAL_PARAM_LIMIT_ERR';this.modelAttr=_.pluck(this.balSelector,'modelKey');this.model.addValidationTask('comparison_check',_.bind(this._doValidateComparison,this));var fields={};_.each(_.pluck(options.meta.panels,'rows'),function(rowObj){_.each(rowObj,function(fieldsList){_.each(_.flatten(fieldsList.fields),function(fieldObj){fields[fieldObj.name]=fieldObj;if(!_.isUndefined(fieldObj.tooltip)){fieldObj.tooltip=app.lang.get(fieldObj.tooltip);}});});});this.moduleFields=fields;var moduleNumber=1;_.each(options.meta.panels,function(panelItem){panelItem.moduleNumber=moduleNumber++;},this);app.events.register('dnbbal:param:add',this);app.events.register('dnbbal:param:remove',this);app.events.register('dnbbal:param:err',this);this.layout.on('dnbbal:param:add',this.setPanelComplete,this);this.layout.on('dnbbal:param:remove',this.setPanelIncomplete,this);this.layout.on('dnbbal:param:err',this.alertValidationError,this);this.layout.on('dnbbal:param:clear',this.clearParams,this);this.tagTmpl1=app.template.get(this.name+'.tagtmpl1');this.tagTmpl2=app.template.get(this.name+'.tagtmpl2');},loadData:function(){this.title=this.meta.title;this.render();},handlePanelShown:function(event){this.$(event.target).siblings('div').addClass('active');var paramHeader=this.$(event.target).siblings('div').children('.dnb-params-header');this.$(paramHeader).addClass('hide');},handlePanelHidden:function(event){this.$(event.target).siblings('div').removeClass('active');var paramGrpKey=this.$(event.target).data('paramgrp');if(this.balParamGroups[paramGrpKey]){var paramGrp=this.balParamGroups[paramGrpKey],panelHeader=[],tempStr;var setParamKeys=_.filter(_.keys(paramGrp),function(paramKey){return this.model.has(paramKey);},this);_.each(setParamKeys,function(paramKey){if(paramGrp[paramKey].id){if(paramGrp[paramKey].label){tempStr=app.lang.get(paramGrp[paramKey].label)+':'+this.model.get(paramKey+'Tags');}else{var industryCodeType=this.model.get(paramKey).IndustryCodeTypeCode,industryLabel;if(industryCodeType==='3599'){industryLabel=app.lang.get('LBL_DNB_BAL_SIC');}else if(industryCodeType==='700'){industryLabel=app.lang.get('LBL_DNB_BAL_NAICS');}
tempStr=industryLabel+':'+this.model.get(paramKey+'Tags');}}else if(paramGrp[paramKey].select2){var selector='[name="'+paramGrp[paramKey].select2+'"]';var select2Data=this.$(selector).select2('data'),selectedData;if(_.isArray(select2Data)){selectedData=_.map(select2Data,function(selectedObj){return selectedObj.text;},this);tempStr=app.lang.get(paramGrp[paramKey].label)+':'+selectedData.join(',');}else{selectedData=select2Data.text;tempStr=app.lang.get(paramGrp[paramKey].label)+':'+selectedData;}}
panelHeader.push(tempStr);},this);if(panelHeader.length>0){var panelHeaderStr=' : '+panelHeader.join(' , '),paramHeader=this.$(event.target).siblings('div').children('.dnb-params-header');this.$(paramHeader).removeClass('hide').text(panelHeaderStr);}}},toggleFormControls:function(event){var selector=event.currentTarget.name;if(selector){var formControls=this.$('[name="'+selector+'"]').closest('.record-cell').siblings('.toggleCandidate');_.each(formControls,function(frmCntrl){if(event.val==='btw'){this.$(frmCntrl).removeClass('hide');}else{this.$(frmCntrl).addClass('hide');}},this);}},populateTagContainer:function(event){var balSelectorName=this.$(event.currentTarget).data('event');if(balSelectorName){var paramMeta=this.balSelector[balSelectorName];if(_.isString(paramMeta.operator)){this.handleComparisonOperator(paramMeta);}else if(_.isString(paramMeta.modelSubKey)){this.handleFreeFormTags(paramMeta);}else if(_.isArray(paramMeta.operator)){this.handleMiscOperators(paramMeta);}}},appendTag:function(tagId,tagText,contSlct,tmpl,tagParent){var compiledTmpl=tmpl({'tagText':tagText,'tagId':tagId,'tagParent':tagParent});this.$(contSlct).append(compiledTmpl);},setPanelComplete:function(selector){if(!this.$(selector).hasClass('complete')){this.$(selector).addClass('complete');}},removeTag:function(event){var selector=event.currentTarget,tagContainer='#'+this.$(selector).closest('ul').attr('id');var modelKey=this.$(selector).siblings('div').attr('id'),parentKey=this.$(selector).siblings('div').data('parentkey'),triggerParam;if(selector){this.$(selector).closest('li').remove();}
if(this.model.has(modelKey)){this.model.unset(modelKey);triggerParam=modelKey;}else{var modelAttr=_.clone(this.model.get(parentKey));var tagCount=this.$(tagContainer).children().length;if(tagCount===0){this.model.unset(parentKey);triggerParam=parentKey;}else{delete modelAttr[modelKey];this.model.set(parentKey,modelAttr);triggerParam=modelKey;}}
var tags=_.map(this.$(tagContainer).children(),function(tag){return this.$(tag).children('div').text().trim();},this);if(tags.length>0){this.model.set(parentKey+'Tags',tags.join(','));}else{this.model.unset(parentKey+'Tags');}
this.triggerBAL();this.layout.trigger('dnbbal:param:remove',triggerParam);},setPanelIncomplete:function(modelKey){var disablePanelFlag=false,selector;var paramGrp=_.find(_.keys(this.balParamGroups),function(paramGrpKey){return _.has(this.balParamGroups[paramGrpKey],modelKey);},this);if(this.balParamGroups[paramGrp]){disablePanelFlag=_.find(_.keys(this.balParamGroups[paramGrp]),function(paramKey){return this.model.has(paramKey);},this);var balParamMeta=this.balParamGroups[paramGrp][modelKey];if(balParamMeta.id){selector=this.$('#'+balParamMeta.id).closest('.accordion-body').siblings('div').children('.step-circle');}else if(balParamMeta.select2){var select2Selector='[name="'+balParamMeta.select2+'"]';selector=this.$(select2Selector).closest('.accordion-body').siblings('div').children('.step-circle');}
if(_.isUndefined(disablePanelFlag)&&this.$(selector).hasClass('complete')){this.$(selector).removeClass('complete');}}},mapSelect2Params:function(event){var modelMeta=this.balSelector[event.target.name];var modelKey=modelMeta.modelKey,modelSubKey=modelMeta.modelSubKey,modelAttr;if(this.model.has(modelKey)){modelAttr=_.clone(this.model.get(modelKey));}else{modelAttr={};}
if(event.added){var paramIndex;if(_.isEmpty(modelAttr)){paramIndex=1;}else{paramIndex=_.keys(modelAttr).length+1;}
if(modelMeta.multiple){modelAttr[modelSubKey+paramIndex]=event.added.id;}else{modelAttr[modelSubKey]=event.added.id;}}else if(event.removed){var removedData=event.removed.id;_.each(modelAttr,function(value,key){if(value===removedData){delete modelAttr[key];}},this);}
var accordionHeader=this.$(event.target).closest('.accordion-body').siblings('.accordion-heading').children('.step-circle');if(!_.isEmpty(modelAttr)){this.model.set(modelKey,modelAttr);this.layout.trigger('dnbbal:param:add',accordionHeader);}else{this.model.unset(modelKey);this.layout.trigger('dnbbal:param:remove',modelKey);}
this.triggerBAL();this.showSidePanel();},modifyIndustryModel:function(){if(this.model.has('industryCode')){app.alert.show('dnb-industry-warning',{level:'confirmation',title:'LBL_WARNING',messages:'LBL_DNB_BAL_INDUSTRY_WARN',onConfirm:_.bind(function(){this.model.unset('industryCode');this.model.unset('industryCodeTags');this.$('#dnb-ind-code-tags').empty();},this),onCancel:_.bind(function(){var changedIndustryCode=this.model.get('dnb_bal_ind_code_type');if(changedIndustryCode==='3599'){this.model.set('dnb_bal_ind_code_type','700');}else if(changedIndustryCode==='700'){this.model.set('dnb_bal_ind_code_type','3599');}},this)});}},handleComparisonOperator:function(paramMeta){var tagCount=this.$(paramMeta.container).children().length;if(tagCount<paramMeta.tagLimit){var fields={};var operatorKey=paramMeta.operator;fields[operatorKey]=this.moduleFields[operatorKey];fields[operatorKey].objType='operator';fields[paramMeta.upperLimit]=this.moduleFields[paramMeta.upperLimit];fields[paramMeta.upperLimit].objType='upperLimit';fields[paramMeta.upperLimit].required=true;if(this.model.get(operatorKey)==='btw'){fields[paramMeta.lowerLimit]=this.moduleFields[paramMeta.lowerLimit];fields[paramMeta.lowerLimit].required=true;fields[paramMeta.lowerLimit].objType='lowerLimit';}
this.model.doValidate(fields,_.bind(function(isValid){if(isValid){this.mapComparisonToApi(paramMeta);}else{this.layout.trigger('dnbbal:param:err');}},this));}else{this.layout.trigger('dnbbal:param:err','taglimit');}},mapComparisonToApi:function(paramMeta){var modelAttr={},modelKey=paramMeta.modelKey;this.clearValidationErrors(this.moduleFields);var operator=this.model.get(paramMeta.operator),upperLimit=this.model.get(paramMeta.upperLimit),lowerLimit=this.model.get(paramMeta.lowerLimit),operatorSelector='[name="'+paramMeta.operator+'"]',lowKey,highKey;if(paramMeta.keyType){var keyType=this.model.get(paramMeta.keyType);lowKey=paramMeta[keyType].lowKey;highKey=paramMeta[keyType].highKey;}else{lowKey=paramMeta.lowKey;highKey=paramMeta.highKey;}
var tagText=this.$(operatorSelector).select2('data').text;if(operator==='btw'){tagText=tagText+' '+lowerLimit+' '+app.lang.get('LBL_DNB_AND')+' '+upperLimit;modelAttr[lowKey]=lowerLimit;modelAttr[highKey]=upperLimit;}else{tagText=tagText+' '+upperLimit;if(operator==='lte'){modelAttr[highKey]=upperLimit;}else if(operator==='gte'){modelAttr[lowKey]=upperLimit;}}
this.model.set(modelKey+'Tags',tagText);this.appendTag(modelKey,tagText,paramMeta.container,this.tagTmpl1);this.model.set(modelKey,modelAttr);this.triggerBAL();this.showSidePanel();var accordionHeader=this.$(paramMeta.container).closest('.accordion-body').siblings('.accordion-heading').children('.step-circle');this.layout.trigger('dnbbal:param:add',accordionHeader);this.model.unset(paramMeta.upperLimit);this.model.unset(paramMeta.lowerLimit);},_doValidateComparison:function(fields,errors,callback){errors={};var comparisonField=_.find(fields,function(fieldObj){return fieldObj.objType==='operator';});if(!_.isUndefined(comparisonField)){var comparisonType=this.model.get(comparisonField.name);var upperLimitField=_.find(fields,function(fieldObj){return fieldObj.objType==='upperLimit';});var upperLimit=this.model.get(upperLimitField.name);if(_.isUndefined(upperLimit)){errors[upperLimitField.name]=errors[upperLimitField.name]||{};}
if(comparisonType==='btw'){var lowerLimitField=_.find(fields,function(fieldObj){return fieldObj.objType==='lowerLimit';});var lowerLimit=this.model.get(lowerLimitField.name);if(_.isUndefined(lowerLimit)){errors[lowerLimitField.name]=errors[lowerLimitField.name]||{};}else if(lowerLimit>=upperLimit){errors[lowerLimitField.name]=errors[lowerLimitField.name]||{};errors[lowerLimitField.name].comparison=true;}}}
callback(null,fields,errors);},handleFreeFormTags:function(paramMeta){var tagCount=this.$(paramMeta.container).children().length;if(tagCount<paramMeta.tagLimit){var fields={};fields[paramMeta.inputKey]=this.moduleFields[paramMeta.inputKey];fields[paramMeta.inputKey].objType='freeform';this.model.doValidate(fields,_.bind(function(isValid){if(isValid){this.mapFreeFormToApi(paramMeta,tagCount);}else{this.layout.trigger('dnbbal:param:err');}},this));}else{this.layout.trigger('dnbbal:param:err','taglimit');}},mapFreeFormToApi:function(paramMeta,tagCount){var modelAttr={},tagText,modelKey=paramMeta.modelKey,tagIndex;this.clearValidationErrors(this.moduleFields);tagIndex=tagCount+1;tagText=this.model.get(paramMeta.inputKey);var tagId=paramMeta.tagLimit>1?paramMeta.modelSubKey+tagIndex:paramMeta.modelSubKey;this.appendTag(tagId,tagText,paramMeta.container,this.tagTmpl2,modelKey);this.model.unset(paramMeta.inputKey);var tags=_.map(this.$(paramMeta.container).children(),function(tag){return this.$(tag).children('div').text().trim();},this);this.model.set(modelKey+'Tags',tags.join(','));_.each(tags,function(tagItem,index){var tagIndex=index+1;if(paramMeta.tagLimit>1){modelAttr[paramMeta.modelSubKey+tagIndex]=tagItem;}else{modelAttr[paramMeta.modelSubKey]=tagItem;}},this);this.model.set(modelKey,modelAttr);this.triggerBAL();this.showSidePanel();var accordionHeader=this.$(paramMeta.container).closest('.accordion-body').siblings('.accordion-heading').children('.step-circle');this.layout.trigger('dnbbal:param:add',accordionHeader);},triggerBAL:function(){var balAttr=_.intersection(this.modelAttr,_.keys(this.model.attributes)),balParams={};_.each(balAttr,function(paramName){var tmpAttr=this.model.get(paramName);if(!_.isUndefined(tmpAttr)){_.each(_.keys(tmpAttr),function(key){balParams[key]=tmpAttr[key];});}},this);this.trigger('dnbbal:invoke',balParams);},handleMiscOperators:function(paramMeta){var tagCount=this.$(paramMeta.container).children().length;if(tagCount<paramMeta.tagLimit){var fields={};_.each(paramMeta.operator,function(operatorKey){fields[operatorKey]=this.moduleFields[operatorKey];},this);if(paramMeta.tagSource){fields[paramMeta.tagSource]=this.moduleFields[paramMeta.tagSource];}
this.model.doValidate(fields,_.bind(function(isValid){if(isValid){this.mapMiscOperatorToApi(paramMeta,tagCount);}else{this.layout.trigger('dnbbal:param:err');}},this));}else{this.layout.trigger('dnbbal:param:err','taglimit');}},mapMiscOperatorToApi:function(paramMeta,tagCount){var modelAttr={},tagText,modelKey=paramMeta.modelKey,tagIndex;this.clearValidationErrors(this.moduleFields);_.each(paramMeta.operator,function(operatorKey,index){modelAttr[paramMeta.modelSubKey[index]]=this.model.get(operatorKey);},this);var tagSource,tagId;if(paramMeta.tagSource){tagSource=paramMeta.tagSource;tagIndex=tagCount+1;tagText=this.model.get(tagSource);tagId=paramMeta.tagDest+tagIndex;}else{tagSource=_.last(paramMeta.operator);tagText=this.model.get(tagSource);tagId=modelKey;if(modelKey==='radiusSearch'){var tagTextParts=[];tagTextParts.push(this.model.get('dnb_bal_distance'));tagTextParts.push(this.$('[name="dnb_bal_distance_units"]').select2('data').text);tagTextParts.push(app.lang.get('LBL_DNB_FROM'));tagTextParts.push(tagText);tagText=tagTextParts.join(' ');this.model.unset('dnb_bal_distance');}}
this.appendTag(tagId,tagText,paramMeta.container,this.tagTmpl2,modelKey);this.model.unset(tagSource);var tags=_.map(this.$(paramMeta.container).children(),function(tag){return this.$(tag).children('div').text().trim();},this);if(modelKey==='radiusSearch'){this.model.set(modelKey+'Tags',tagText);}else{this.model.set(modelKey+'Tags',tags.join(','));}
if(paramMeta.tagDest){_.each(tags,function(tagItem,index){var tagIndex=index+1;if(paramMeta.tagDest==='IndustryCode-'){tagItem=tagItem+'*';}
modelAttr[paramMeta.tagDest+tagIndex]=tagItem;},this);}
this.model.set(modelKey,modelAttr);this.triggerBAL();this.showSidePanel();var accordionHeader=this.$(paramMeta.container).closest('.accordion-body').siblings('.accordion-heading').children('.step-circle');this.layout.trigger('dnbbal:param:add',accordionHeader);},alertValidationError:function(errorType){var msg;if(_.isUndefined(errorType)){msg=app.lang.get('ERR_RESOLVE_ERRORS');}else{msg=app.lang.get(app.error.errorName2Keys[errorType]);}
app.alert.show('dnb-bal-param-warning',{level:'error',messages:msg});},showTooltip:function(e){this.$(e.currentTarget).tooltip('show');},hideTooltip:function(e){this.$(e.currentTarget).tooltip('hide');},unbindDom:function(){this.$('[rel="tooltip"]').each(function(){$(this).tooltip('destroy');});unbindTooltips('[rel="tooltip"]');this._super('unbindDom');},clearParams:function(){_.each(this.balSelector,function(balSlctObj){if(balSlctObj.container){this.$(balSlctObj.container).empty();}},this);this.clearValidationErrors(this.moduleFields);this.$('.step-circle').removeClass('complete');this.$('.dnb-params-header').empty();this.model.clear();this.triggerBAL();this.loadData();},showSidePanel:function(event){var defaultLayout=this.closestComponent('sidebar');if(defaultLayout){defaultLayout.trigger('sidebar:toggle',true);}}})