/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({plugins:['Editable','ErrorDecoration','Tooltip','EllipsisInline','MergeDuplicates'],extendsFrom:'ListView',events:{'click [data-mode=preview]':'togglePreview','click [data-action=copy]':'triggerCopy','click [data-action=delete]':'triggerDelete'},_defaultSettings:{merge_relate_fetch_concurrency:2,merge_relate_fetch_timeout:90000,merge_relate_fetch_limit:20,merge_relate_update_concurrency:4,merge_relate_update_timeout:90000,merge_relate_max_attempt:3},mergeFields:[],rowFields:{},primaryRecord:{},toggled:false,isPreviewOpen:false,relatedFieldsMap:['id_name','type_name'],fieldNameBlacklist:['date_entered','date_modified','modified_user_id','created_by','deleted'],fieldTypesBlacklist:['team_list','link','id','password'],relatesBlacklist:['assigned_user_link','modified_user_link','created_by_link','teams','team_link','team_count_link','campaigns','archived_emails','email_addresses','email_addresses_primary','forecastworksheets','currencies'],relatesBlacklistForModule:{Accounts:['revenuelineitems'],Opportunities:['accounts'],Leads:['meetings_parent','calls_parent'],Prospects:['tasks'],Bugs:['project'],RevenueLineItems:['campaign_revenuelineitems']},mergeStat:null,mergeProgressModel:null,mergeRelatedCollection:null,validArrayAttributes:[{type:'datetimecombo',source:'db'},{type:'datetime',source:'db'},{type:'varchar',source:'db'},{type:'enum',source:'db'},{type:'multienum',source:'db'},{type:'text',source:'db'},{type:'date',source:'db'},{type:'time',source:'db'},{type:'currency',source:'db',calculated:false},{type:'int',source:'db'},{type:'long',source:'db'},{type:'double',source:'db'},{type:'float',source:'db'},{type:'short',source:'db'},{dbType:'varchar',source:'db'},{dbType:'double',source:'db'},{type:'relate'},{type:'parent'},{type:'image'},{type:'teamset'},{type:'email'}],flattenFieldTypes:['fieldset','fullname'],generatedValues:null,initialize:function(options){this._super('initialize',[options]);this._initSettings();this._initializeMergeFields();this._initializeMergeCollection(this._prepareRecords());this.action='list';this._delegateEvents();},_delegateEvents:function(){this.layout.on('mergeduplicates:save:fire',this.triggerSave,this);app.events.on('preview:open',_.bind(this.onPreviewToggle,this,true),this);app.events.on('preview:close',_.bind(this.onPreviewToggle,this,false),this);this.on('render',this._showAlertIfIdentical,this);},_initSettings:function(){var configSettings=app.config.mergeDuplicates&&{merge_relate_fetch_concurrency:app.config.mergeDuplicates.mergeRelateFetchConcurrency,merge_relate_fetch_timeout:app.config.mergeDuplicates.mergeRelateFetchTimeout,merge_relate_fetch_limit:app.config.mergeDuplicates.mergeRelateFetchLimit,merge_relate_update_concurrency:app.config.mergeDuplicates.mergeRelateUpdateConcurrency,merge_relate_update_timeout:app.config.mergeDuplicates.mergeRelateUpdateTimeout,merge_relate_max_attempt:app.config.mergeDuplicates.mergeRelateMaxAttempt};this._settings=_.extend(this._defaultSettings,configSettings,this.meta&&this.meta.settings||{});return this;},_prepareRecords:function(){var records=this._validateModelsForMerge(this.context.get('selectedDuplicates'));this.setPrimaryRecord(this._findPrimary(records));return records;},_findPrimary:function(models){var primary=this.context.has('primaryRecord')&&_.findWhere(models,{id:this.context.get('primaryRecord').id});return primary||_.find(models,function(model){return app.acl.hasAccessToModel('edit',model);});},_initializeMergeFields:function(){var meta=app.metadata.getView(this.module,'record'),fieldDefs=app.metadata.getModule(this.module).fields;this.mergeFields=_.chain(meta.panels).map(function(panel){return this.flattenFieldsets(panel.fields);},this).flatten().filter(function(field){return field.name&&this.validMergeField(fieldDefs[field.name]);},this).value();},_initializeMergeCollection:function(records){var ids=(_.pluck(records,'id'));if(this.collection){this.collection.filterDef=[];this.collection.filterDef.push({'id':{'$in':ids}});this.collection.comparator=function(model){return _.indexOf(ids,model.get('id'));};}},triggerSave:function(){var self=this,alternativeModels=_.without(this.collection.models,this.primaryRecord),alternativeModelNames=[];_.each(alternativeModels,function(model){alternativeModelNames.push(app.utils.getRecordName(model));},this);this.clearValidationErrors(this.getFieldNames());app.alert.show('merge_confirmation',{level:'confirmation',messages:app.lang.get('LBL_MERGE_DUPLICATES_CONFIRM')+' '+
Handlebars.Utils.escapeExpression(alternativeModelNames.join(', '))+'. '+
app.lang.get('LBL_MERGE_DUPLICATES_PROCEED'),onConfirm:_.bind(this._savePrimary,this)});},_savePrimary:function(){var self=this,fields=this.getFieldNames().filter(function(field){return app.acl.hasAccessToModel('edit',this.primaryRecord,field);},this);this.primaryRecord.trigger('duplicate:unformat:field');this.primaryRecord.save({},{fieldsToValidate:fields,success:function(){self.primaryRecord.trigger('duplicate:format:field');self.primaryRecord.trigger('mergeduplicates:primary:saved');},error:function(error){if(error.status===409){app.utils.resolve409Conflict(error,self.primaryRecord,function(model,isDatabaseData){if(model){if(isDatabaseData){self.resetRadioSelection(model.id);}else{self._savePrimary();}}});}},lastModified:this.primaryRecord.get('date_modified'),showAlerts:true,viewed:true});},_removeMerged:function(){var self=this,models=_.without(this.collection.models,this.primaryRecord);async.forEach(models,function(model,callback){self.collection.remove(model);model.destroy({success:function(){callback.call();}});},function(){self.primaryRecord.trigger('mergeduplicates:primary:merged');});},getFieldNames:function(){var fields=[],fieldDefs=app.metadata.getModule(this.module).fields;_.each(this.mergeFields,function(mergeField){var def=fieldDefs[mergeField.name];_.each(this.relatedFieldsMap,function(relatedField){if(!_.isUndefined(def[relatedField])&&!_.isUndefined((fieldDefs[def[relatedField]].name))){fields.push(fieldDefs[def[relatedField]].name);}});var related_fields=mergeField.related_fields||def.related_fields||undefined;if(!_.isUndefined(related_fields)&&_.isArray(related_fields)){_.each(related_fields,function(rField){fields.push(rField);});}
fields.push(def.name);},this);return _.unique(fields);},_generateMetadata:function(fields){this.generatedValues={teamsets:[]};_.each(fields,function(field){if(field.type==='teamset'){var teams={};this.collection.each(function(model){_.each(model.get(field.name),function(team){teams[team.id]=team;});});this.generatedValues.teamsets[field.name]=_.values(teams);field.maxHeight=_.size(teams);field.noRadioBox=true;}},this);var models=this.collection.without(this.primaryRecord);fields=_.sortBy(fields,function(field){return _.every(models,function(model){return _.isEqual(this.primaryRecord.get(field.name),model.get(field.name));},this);},this);return{type:'list',panels:[{fields:fields}]};},_isSimilar:function(primary,models){return _.every(models,function(model){var modelFields=this.rowFields[model.id],primaryFields=this.rowFields[primary.id];return _.every(modelFields,function(field,index){return field.equals(primaryFields[index]);},this);},this);},validMergeField:function(fieldDef){if(!fieldDef||fieldDef.auto_increment===true||!this._validMergeFieldName(fieldDef)||!this._validMergeFieldType(fieldDef)||this._isDuplicateMergeDisabled(fieldDef)){return false;}
if(this._isDuplicateMergeEnabled(fieldDef)){return true;}
return this._validMergeFieldAttributes(fieldDef);},_validMergeFieldName:function(defs){return!_.contains(this.fieldNameBlacklist,defs.name);},_validMergeFieldType:function(defs){return!_.contains(this.fieldTypesBlacklist,defs.type);},_isDuplicateMergeDisabled:function(defs){if(!_.isUndefined(defs.duplicate_merge)&&(defs.duplicate_merge==='disabled'||defs.duplicate_merge===false)){return true;}
return false;},_isDuplicateMergeEnabled:function(defs){if(!_.isUndefined(defs.duplicate_merge)&&(defs.duplicate_merge==='enabled'||defs.duplicate_merge===true)){return true;}
return false;},_validMergeFieldAttributes:function(defs){defs.dbType=defs.dbType||defs.type;defs.source=defs.source||'db';defs.calculated=defs.calculated||false;if(defs.calculated!==false){return false;}
return _.some(this.validArrayAttributes,function(o){return _.chain(o).keys().every(function(key){return o[key]===defs[key];}).value();});},flattenFieldsets:function(defs){var fieldsetFilter=function(field){return(field.type&&_.isArray(field.fields)&&_.contains(this.flattenFieldTypes,field.type));},fields=_.reject(defs,fieldsetFilter,this),fieldsets=_.filter(defs,fieldsetFilter,this),sort=_.chain(defs).pluck('name').value()||[],sortTemp=[];while(fieldsets.length){var fieldsNames=_.chain(fieldsets).pluck('fields').flatten().pluck('name').value();sortTemp=[];_.each(sort,function(value){if(value===_.first(fieldsets).name){sortTemp=sortTemp.concat(fieldsNames);}else{sortTemp=sortTemp.concat(value);}},this);sort=sortTemp;fieldsets=_.chain(fieldsets).pluck('fields').flatten().value();fields=fields.concat(_.reject(fieldsets,fieldsetFilter));fieldsets=_.filter(fieldsets,fieldsetFilter);}
fields=_.sortBy(fields,function(value,index){var result=index,name=value;if(!_.isUndefined(value.name)){name=value.name;_.each(sort,function(valueSort,indexSort){if(valueSort==name){result=indexSort;}});}
return result;});return fields;},onPreviewToggle:function(open){this.isPreviewOpen=open;this.$('[data-mode=preview]').toggleClass('on',open);},togglePreview:function(evt){if(this.isPreviewOpen){app.events.trigger('preview:close');}else{this.updatePreviewRecord(this.primaryRecord);}},updatePreviewRecord:function(model){var module=model.module||model.get('module');var previewCollection=app.data.createBeanCollection(module,[model]);app.events.trigger('preview:render',model,previewCollection,false);},updatePrimaryTitle:function(title){this.$('[data-container=primary-title]').text(title);},_renderHtml:function(){this.meta=this._generateMetadata(this.mergeFields);this._super("_renderHtml");this.rowFields={};_.each(this.fields,function(field){if(field.model.id&&_.isUndefined(field.parent)){this.rowFields[field.model.id]=this.rowFields[field.model.id]||[];this.rowFields[field.model.id].push(field);}},this);this.setPrimaryEditable(this.primaryRecord.id);this.setDraggable();},_showAlertIfIdentical:function(){if(!this.collection.length){return;}
var self=this,alternatives=this.collection.without(this.primaryRecord);if(this._isSimilar(this.primaryRecord,alternatives)){app.alert.show('merge_confirmation_identical',{level:'confirmation',messages:app.lang.get('TPL_MERGE_DUPLICATES_IDENTICAL',this.module),onConfirm:function(){self.layout.trigger('mergeduplicates:save:fire');}});}},setDraggable:function(){var self=this,mergeContainer=this.$('[data-container=merge-container]');mergeContainer.find('[data-container=primary-label]').sortable({connectWith:self.$('[data-container=primary-label]'),appendTo:mergeContainer,axis:'x',disableSelection:true,cursor:'move',placeholder:'primary-lbl-placeholder-span',start:function(event,ui){self.$('[data-container=primary-label]').addClass('primary-lbl-placeholder');},stop:_.bind(self._onStopSorting,self)});mergeContainer.find('[data-container=primary-label].disabled').sortable('option','disabled',true);},_onStopSorting:function(event,ui){var self=this,droppedTo=ui.item.parents('[data-record-id]');self.$('[data-container=primary-label]').removeClass('primary-lbl-placeholder');if(droppedTo.length===0){self.$('[data-container=primary-label]').sortable('cancel');return;}
if(self.primaryRecord&&self.primaryRecord.id!==droppedTo.data('record-id')){var changedAttributes=self.primaryRecord.changedAttributes(self.primaryRecord.getSyncedAttributes());if(!_.isEmpty(changedAttributes)){app.alert.show('change_primary_confirmation',{level:'confirmation',messages:app.lang.get('LBL_MERGE_UNSAVED_CHANGES'),onConfirm:function(){self.primaryRecord.revertAttributes();self.setPrimaryEditable(droppedTo.data('record-id'));},onCancel:function(){self.$('[data-record-id='+self.primaryRecord.get('id')+'] '+'[data-container=primary-label]').sortable('cancel');}});return;}
self.setPrimaryEditable(droppedTo.data('record-id'));}},checkCopyRadioButtons:function(){if(!this.primaryRecord){return;}
_.each(this.mergeFields,function(field){var model=this.primaryRecord,element=this.$('[data-field-name='+field.name+'][data-record-id='+model.id+']'),others=this.$('[data-field-name='+field.name+'][data-record-id!='+model.id+']'),editAccess=app.acl.hasAccessToModel('edit',model,field.name);element.prop('disabled',!editAccess||field.readonly);if(!editAccess||field.readonly){others.prop('disabled',true);return;}
_.each(others,function(domElement){var el=$(domElement),readAccess=app.acl.hasAccessToModel('read',this.collection.get(el.data('record-id')),field.name);el.prop('disabled',!readAccess);},this);},this);},setPrimaryEditable:function(id){var oldPrimaryRecord=this.primaryRecord,newPrimaryRecord=this.collection.get(id||null);if(!_.isUndefined(newPrimaryRecord)&&newPrimaryRecord!==oldPrimaryRecord){this.setPrimaryRecord(newPrimaryRecord);}
if(!this.primaryRecord){return;}
if(oldPrimaryRecord&&oldPrimaryRecord!==this.primaryRecord){this.toggleFields(this.rowFields[oldPrimaryRecord.id],false);}
this.primaryRecord.trigger('duplicate:format:field');this.toggleFields(this.rowFields[this.primaryRecord.id],true);this.updatePrimaryTitle(app.utils.getRecordName(this.primaryRecord));if(this.isPreviewOpen){this.updatePreviewRecord(this.primaryRecord);}
this.$('.primary-edit-mode').removeClass('primary-edit-mode');this.$('[data-record-id='+this.primaryRecord.id+']').addClass('primary-edit-mode');this.resetRadioSelection(this.primaryRecord.id);this.checkCopyRadioButtons();this._disableRemovePrimary();if(this.collection.length<=2){this.$('[data-action=delete]').css('visibility','hidden');}},_disableRemovePrimary:function(){var disableRemovePrimary=!_.some(this.collection.models,function(model){return model!==this.primaryRecord&&app.acl.hasAccessToModel('edit',model);},this);this.$('[data-record-id='+this.primaryRecord.get('id')+']').find('[data-action=delete]').css('visibility',(disableRemovePrimary?'hidden':'visible'));},resetRadioSelection:function(modelId){this.$('[data-record-id='+modelId+'] input[type=radio]').attr('checked',true);},setPrimaryRecord:function(model){if(this.primaryRecord===model){return;}
if(this.primaryRecord instanceof Backbone.Model){this.primaryRecord.off(null,null,this);}
this.primaryRecord=model;this.primaryRecord.on('change',function(model){this.updatePrimaryTitle(app.utils.getRecordName(this.primaryRecord));},this);this.primaryRecord.on('mergeduplicates:primary:saved',function(){this._mergeRelatedRecords();},this);this.primaryRecord.on('mergeduplicates:related:merged',function(){this._onRelatedMerged();},this);this.primaryRecord.on('mergeduplicates:primary:merged',function(){app.alert.dismiss('mergeduplicates_merging');this._showSuccessMessage();app.drawer.close(true,this.primaryRecord);},this);},triggerCopy:function(evt){var currentTarget=this.$(evt.currentTarget),recordId=currentTarget.data('record-id'),recordItemId=currentTarget.data('record-item-id'),fieldName=currentTarget.data('field-name'),fieldDefs=app.metadata.getModule(this.module).fields,model;if(_.isUndefined(this.primaryRecord)||_.isUndefined(this.primaryRecord.id)||_.isUndefined(recordId)||_.isUndefined(fieldName)||_.isUndefined(fieldDefs[fieldName])){return;}
model=this.collection.get(recordId);if(_.isUndefined(model)){return;}
if(!app.acl.hasAccessToModel('edit',this.primaryRecord,fieldName)||!app.acl.hasAccessToModel('read',model,fieldName)){return;}
var data=_.extend({},currentTarget.data(),{checked:currentTarget.prop('type')==='checkbox'?currentTarget.prop('checked'):true});if(this.triggerBefore('duplicate:field',{model:model,data:data})===false){return;}
if(model===this.primaryRecord){this.revert(fieldName);}else{this.copy(fieldName,model);}},copy:function(fieldName,model){this._setRelatedFields(fieldName,model);this.primaryRecord.set(fieldName,model.get(fieldName));this.primaryRecord.trigger('duplicate:field:'+fieldName,model!==this.primaryRecord?model:null,model!==this.primaryRecord?model.get(fieldName):null);},revert:function(fieldName){var syncedAttributes=this.primaryRecord.getSyncedAttributes();this._setRelatedFields(fieldName,this.primaryRecord,true);this.primaryRecord.set(fieldName,!_.isUndefined(syncedAttributes[fieldName])?syncedAttributes[fieldName]:this.primaryRecord.get(fieldName));this.primaryRecord.trigger('duplicate:field:'+fieldName,this.primaryRecord,this.primaryRecord.get(fieldName));},triggerDelete:function(evt){var recordId=this.$(evt.currentTarget).closest('[data-record-id]').data('recordId'),model=this.collection.get(recordId),self=this;if(this.collection.length<=2||!recordId||!model){return;}
if(model===this.primaryRecord){var allow=_.some(this.collection.models,function(model){return model!==this.primaryRecord&&app.acl.hasAccessToModel('edit',model);},this);if(!allow){return;}}
app.alert.show('record-delete-confirm',{level:'confirmation',messages:app.lang.get('LBL_MERGE_DUPLICATES_REMOVE',this.module),onConfirm:function(){self.deleteFromMerge(model);self.$('[data-container="merge-container"]').attr('class',function(){return $(this).attr('class').replace(/\b(num\-cols\-)(\d+)\b/g,'$1'+self.collection.length);});}});},deleteFromMerge:function(model){this.collection.remove(model,{silent:true});var selModelEl='[data-container=merge-record][data-record-id='+model.get('id')+']';if(model===this.primaryRecord){var primary=this._findPrimary(this.collection.models),selNewPrimaryEl='[data-container=merge-record][data-record-id='+primary.get('id')+']',primaryEl=this.$(selNewPrimaryEl).find('[data-container=primary-label]'),primaryLabel=this.$(selModelEl).find('[data-container=primary-label-span]');primaryEl.append(primaryLabel);this.setPrimaryEditable(primary.get('id'));}
this.$(selModelEl).remove();if(this.collection.length<=2){this.$('[data-action=delete]').css('visibility','hidden');}},_setRelatedFields:function(fieldName,model,synced){synced=synced||false;var fieldDefs=app.metadata.getModule(this.module).fields;defs=fieldDefs[fieldName],syncedAttributes=synced?model.getSyncedAttributes():{},fields=_.union(defs.populate_list,defs.related_fields);_.each(this.relatedFieldsMap,function(field){if(!_.isUndefined(defs[field])&&!_.isUndefined(fieldDefs[defs[field]].name)){fields.push(fieldDefs[defs[field]].name);};});_.each(fields,function(relatedField){if(_.isUndefined(fieldDefs[relatedField])){return;}
this.primaryRecord.set(relatedField,!_.isUndefined(syncedAttributes[relatedField])?syncedAttributes[relatedField]:model.get(relatedField));},this);},_getRelatedLinks:function(){var fieldDefs=app.metadata.getModule(this.module).fields,excludedLinks=this._getExcludedRelatedLinks();return _.filter(fieldDefs,function(field){return!_.isUndefined(field.type)&&field.type==='link'&&!_.contains(excludedLinks,field.name)&&this._isValidRelateLink(field)&&this._isValidRelateLinkType(field);},this);},_getExcludedRelatedLinks:function(){var excludedLinks=[],fieldDefs=app.metadata.getModule(this.module).fields;_.each(this.mergeFields,function(mergeField){var def=fieldDefs[mergeField.name];if(def.type==='relate'&&!_.isUndefined(def.link)){excludedLinks.push(def.link);}},this);return excludedLinks;},_isValidRelateLink:function(link){if(!link||!link.name){return false;}
var module=app.data.getRelatedModule(this.module,link.name);if(_.isEmpty(app.metadata.getModule(module))){return false;}
if(_.contains(this.relatesBlacklist,link.name)){return false;}
if(!_.isUndefined(this.relatesBlacklistForModule[this.module])&&_.contains(this.relatesBlacklistForModule[this.module],link.name)){return false;}
if(!_.isUndefined(link.duplicate_merge)&&(link.duplicate_merge==='disabled'||link.duplicate_merge==='false'||link.duplicate_merge===false)){return false;}
return true;},_isValidRelateLinkType:function(link){if(!_.isUndefined(link.link_type)&&link.link_type==='one'){return false;}
return true;},_mergeRelatedRecords:function(){var self=this,alternativeModels=_.without(this.collection.models,this.primaryRecord),relatedLinks=_.pluck(this._getRelatedLinks(),'name'),progressView,queue,tasks=[];this.mergeStat={records:this.collection.models.length,total:0,total_errors:0,total_fetch_errors:0};this.mergeProgressModel=new Backbone.Model({isStopped:false});this.mergeRelatedCollection=this.getMergeRelatedCollection();if(!alternativeModels||!alternativeModels.length){self.primaryRecord.trigger('mergeduplicates:related:merged');return;}
if(!relatedLinks||!_.isArray(relatedLinks)||!relatedLinks.length){self.primaryRecord.trigger('mergeduplicates:related:merged');return;}
progressView=this._getProgressView();progressView.reset();progressView.setTotalRecords(alternativeModels.length*relatedLinks.length);this.mergeProgressModel.trigger('massupdate:start');_.each(relatedLinks,function(link){_.each(alternativeModels,function(model){tasks.push({collection:self._createRelatedCollection(model,link)});});});queue=async.queue(function(task,callback){if(self.mergeProgressModel.get('isStopped')){callback.call();return;}
self._mergeRelatedCollection(task.collection,callback);},this._settings.merge_relate_fetch_concurrency);queue.drain=function(){var finishMerge=function(){self.mergeProgressModel.trigger('massupdate:end');if(!self.mergeProgressModel.get('isStopped')){self.primaryRecord.trigger('mergeduplicates:related:merged');}};self.mergeRelatedCollection.queue.running()?self.mergeRelatedCollection.queue.drain=finishMerge:finishMerge();};queue.push(tasks,function(err){});},getMergeRelatedCollection:function(){var constructor=Backbone.Collection.extend({method:'create',queue:null,view:null,id:this.primaryRecord.id,module:this.primaryRecord.module,attempt:0,initialize:function(models,options){this.view=options.view;this.queue=async.queue(_.bind(function(task,callback){this.sync('update',this,{chunk:task,queueSuccess:callback});},this),this.view._settings.merge_relate_update_concurrency);this.on('add',function(model,options){this.queue.push({link_name:model.link.name,ids:_.pluck(this.models,'id')},function(err){});this.reset();},this);},sync:function(method,model,options){var apiMethod=options.method||this.method,url=app.api.buildURL(this.module,method,{link:true,id:this.id},options.params),callbacks={success:function(data,response){model.view.mergeStat.total=model.view.mergeStat.total+options.chunk.ids.length;options.queueSuccess();if(_.isFunction(options.success)){options.success(model,data,response);}},error:function(xhr,status,error){model.attempt=model.attempt+1;model.view.mergeProgressModel.trigger('massupdate:item:attempt',model);if(model.attempt<=(model.view._settings.merge_relate_max_attempt)){app.api.call(apiMethod,url,options.chunk,callbacks);}else{model.attempt=0;model.view.mergeStat.total_errors=model.view.mergeStat.total_errors+1;model.view.mergeProgressModel.trigger('massupdate:item:fail',model);}},complete:function(xhr,status){if(_.isFunction(options.complete)){options.complete(xhr,status);}}};app.api.call(apiMethod,url,options.chunk,callbacks);}}),collection=new constructor([],{view:this});return collection;},_onRelatedMerged:function(){var self=this;if(this.mergeStat.total_fetch_errors>0||this.mergeStat.total_errors>0){app.alert.show('final_confirmation',{level:'confirmation',messages:app.lang.get('LBL_MERGE_DUPLICATES_FAIL_PROCESS',this.module),onConfirm:function(){self._onMergeRelatedCompleted();},onCancel:function(){self.mergeProgressModel.trigger('massupdate:end');},autoClose:false});return;}
this._onMergeRelatedCompleted();},_onMergeRelatedCompleted:function(){app.alert.show('mergeduplicates_merging',{level:'process',title:app.lang.get('LBL_SAVING',this.module)});this._removeMerged();},_createRelatedCollection:function(model,link){var relatedCollection=app.data.createRelatedCollection(model,link);return _.extend(relatedCollection,{attempt:0,maxAllowAttempt:this._settings.merge_relate_max_attempt,objectName:app.data.getRelatedModule(this.primaryRecord.module,link)});},_mergeRelatedCollection:function(collection,callback,offset){if(this.mergeProgressModel.get('isStopped')){callback.call();return;}
offset=offset||0;var self=this,onCollectionMerged=function(){self.mergeProgressModel.trigger('massupdate:item:processed');callback.call();};collection.fetch({relate:true,limit:this._settings.merge_relate_fetch_limit,offset:offset,fields:['id'],apiOptions:{timeout:this._settings.merge_relate_fetch_timeout,skipMetadataHash:true},success:function(data,response,options){if(!data||!data.models||!data.models.length){onCollectionMerged.call();return;}
self.mergeRelatedCollection.add(data.models);if(!_.isUndefined(data.next_offset)&&data.next_offset!==-1){self._mergeRelatedCollection(collection,callback,data.next_offset);}else{onCollectionMerged.call();}},error:function(){collection.attempt=collection.attempt+1;self.mergeProgressModel.trigger('massupdate:item:attempt',collection);if(collection.attempt<=collection.maxAllowAttempt){self._mergeRelatedCollection(collection,callback,offset);}else{self.mergeStat.total_fetch_errors=self.mergeStat.total_fetch_errors+1;self.mergeProgressModel.trigger('massupdate:item:fail',collection);onCollectionMerged.call();}}});},_getProgressView:function(){var progressView=this.layout.getComponent('merge-duplicates-progress');if(!progressView){progressView=app.view.createView({context:this.context,name:'merge-duplicates-progress',layout:this.layout,model:this.mergeProgressModel});this.layout._components.push(progressView);this.layout.$el.append(progressView.$el);}
progressView.render();return progressView;},_showSuccessMessage:function(){app.alert.show('mergerelated_final_notice',{level:'success',messages:app.lang.get('TPL_MERGE_DUPLICATES_STAT',this.module,{stat:this.mergeStat}),autoClose:true,autoCloseDelay:8000});},bindDataChange:function(){if(!this.collection){return;}
this.collection.on('reset',function(coll){if(coll.length){_.each(coll.models,function(model){model.readonly=!app.acl.hasAccessToModel('edit',model);},this);this.setPrimaryRecord(this._findPrimary(coll.models));}
if(this.disposed){return;}
this.render();},this);},_dispose:function(){if(!_.isEmpty(this.primaryRecord)){this.primaryRecord.off(null,null,this);}
this._super('_dispose');}})