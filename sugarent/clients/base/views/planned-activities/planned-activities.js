/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({extendsFrom:'HistoryView',_defaultSettings:{date:'today',limit:10,visibility:'user'},initialize:function(options){this.plugins=_.union(this.plugins,['LinkedModel']);this._super('initialize',[options]);},initDashlet:function(){this._super('initDashlet');if(!this.meta.last_state){this.meta.last_state={id:this.dashModel.get('id')+':'+this.name,defaults:{}};}
this.settings.on('change:date',function(model,value){var specificDateKey=app.user.lastState.key('date',this);app.user.lastState.set(specificDateKey,value);},this);this.settings.set('date',this.getDate());this.tbodyTag='ul[data-action="pagination-body"]';},_initEvents:function(){this.events=_.extend(this.events,{'click [data-action=date-switcher]':'dateSwitcher'});this._super('_initEvents');this.on('planned-activities:close-record:fire',this.heldActivity,this);this.before('render:rows',function(data){this.updateInvitation(this.collection,data);return false;},null,this);return this;},updateInvitation:function(collection,data){var tab=this.tabs[this.settings.get('activeTab')];if(!data.length||!tab.invitations){return;}
this._fetchInvitationActions(tab,_.pluck(data,'id'));},heldActivity:function(model){var self=this;var name=Handlebars.Utils.escapeExpression(app.utils.getRecordName(model)).trim();var context=app.lang.getModuleName(model.module).toLowerCase()+' '+name;app.alert.show('close_activity_confirmation:'+model.get('id'),{level:'confirmation',messages:app.utils.formatString(app.lang.get('LBL_PLANNED_ACTIVITIES_DASHLET_CONFIRM_CLOSE'),[context]),onConfirm:function(){model.save({status:'Held'},{showAlerts:true,success:self._getRemoveModelCompleteCallback()});}});},createRecord:function(event,params){var self=this,bwcExceptions=['Emails'],meta=app.metadata.getModule(params.module)||{};if(meta.isBwcEnabled&&!_.contains(bwcExceptions,params.module)){this._createBwcRecord(params.module,params.link);return;}
if(this.module!=='Home'){this.createRelatedRecord(params.module,params.link);}else{app.drawer.open({layout:'create-actions',context:{create:true,module:params.module}},function(context,model){if(!model){return;}
self.context.resetLoadFlag();self.context.set('skipFetch',false);if(_.isFunction(self.loadData)){self.loadData();}else{self.context.loadData();}});}},_createBwcRecord:function(module,link){if(this.module!=='Home'){app.bwc.createRelatedRecord(module,this.model,link);return;}
var params={return_module:this.module,return_id:this.model.id};var route=app.bwc.buildRoute(module,null,'EditView',params);app.router.navigate(route,{trigger:true});},_initTabs:function(){this._super('_initTabs');_.each(this.tabs,function(tab){if(!tab.invitation_actions){return;}
tab.invitations=this._createInvitationsCollection(tab);},this);return this;},_createInvitationsCollection:function(tab){return app.data.createBeanCollection(tab.module,null,{link:{name:tab.module.toLowerCase(),bean:app.data.createBean('Users',{id:app.user.get('id')})}});},_getRecordsTemplate:function(module){this._recordsTpl=this._recordsTpl||{};if(!this._recordsTpl[module]){this._recordsTpl[module]=app.template.getView(this.name+'.records',module)||app.template.getView(this.name+'.records',this.module)||app.template.getView(this.name+'.records')||app.template.getView('history.records',this.module)||app.template.getView('history.records')||app.template.getView('tabbed-dashlet.records',this.module)||app.template.getView('tabbed-dashlet.records');}
return this._recordsTpl[module];},_getFilters:function(index){var today=app.date().format('YYYY-MM-DD'),tab=this.tabs[index],filter={},filters=[],defaultFilters={today:{$lte:today},future:{$gt:today}};filter[tab.filter_applied_to]=defaultFilters[this.getDate()];filters.push(filter);return filters;},tabSwitcher:function(event){var tab=this.tabs[this.settings.get('activeTab')];if(tab.invitations){tab.invitations.dataFetched=false;}
this._super('tabSwitcher',[event]);},dateSwitcher:function(event){var date=this.$(event.currentTarget).val();if(date===this.getDate()){return;}
this.settings.set('date',date);this.loadData();},getDate:function(){var date=app.user.lastState.get(app.user.lastState.key('date',this),this);return date||this.settings.get('date')||this._defaultSettings.date;},loadDataForTabs:function(tabs,options){_.each(tabs,function(tab){if(tab.invitations){tab.invitations.dataFetched=false;}},this);this._super('loadDataForTabs',[tabs,options]);},_fetchInvitationActions:function(tab,addedIds){this.invitationActions=tab.invitation_actions;tab.invitations.filterDef={'id':{'$in':addedIds||this.collection.pluck('id')}};tab.invitations.fetch({relate:true,success:_.bind(function(collection){if(this.disposed){return;}
_.each(collection.models,function(invitation){var model=this.collection.get(invitation.get('id'));model.set('invitation',invitation);},this);if(!_.isEmpty(addedIds)){_.each(addedIds,function(id){var model=this.collection.get(id);this._renderRow(model);this._renderAvatars();},this);return;}
this.render();this._renderAvatars();},this),complete:function(){tab.invitations.dataFetched=true;}});},_renderHtml:function(){if(this.meta.config){this._super('_renderHtml');return;}
var tab=this.tabs[this.settings.get('activeTab')];if(tab.overdue_badge){this.overdueBadge=tab.overdue_badge;}
if(!this.collection.length||!tab.invitations||tab.invitations.dataFetched){this._super('_renderHtml');return;}
this._fetchInvitationActions(tab);}})