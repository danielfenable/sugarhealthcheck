/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({extendsFrom:'FlexListView',plugins:['ListColumnEllipsis','ListRemoveLinks'],initialize:function(options){options.meta=options.meta||{};options.meta.selection={type:'single',label:'LBL_LINK_SELECT'};this._super('initialize',[options]);this.context._fetchCalled=true;this._buildList();},parseFields:function(){},_buildList:function(){var dataInDb=this.context.get('dataInDb'),modelToSave=this.context.get('modelToSave'),modelInDb,copyOfModelToSave,originalId;if(!_.isEmpty(dataInDb)&&!_.isEmpty(modelToSave)){modelInDb=app.data.createBean(modelToSave.module,dataInDb);copyOfModelToSave=app.data.createBean(modelToSave.module);originalId=modelToSave.get('id');copyOfModelToSave.set(app.utils.deepCopy(modelToSave.attributes));this._buildFieldDefinitions(copyOfModelToSave,modelInDb);copyOfModelToSave.set('id',originalId+'-client');modelInDb.set('id',originalId+'-database');copyOfModelToSave.set('_dataOrigin','client');modelInDb.set('_dataOrigin','database');copyOfModelToSave.set('_modified_by',app.lang.get('LBL_YOU'));modelInDb.set('_modified_by',modelInDb.get('modified_by_name'));this._populateMissingDataFromDatabase(copyOfModelToSave,modelInDb);this.collection.add([copyOfModelToSave,modelInDb]);}},_buildFieldDefinitions:function(modelToSave,modelInDb){var fieldsThatDiffer,fieldDefinition,modifiedByColumnDef={name:'_modified_by',type:'base',label:'LBL_MODIFIED',sortable:false};fieldsThatDiffer=app.utils.compareBeans(modelToSave,modelInDb);fieldsThatDiffer=_.filter(fieldsThatDiffer,function(name){return name!=='modified_by_name';});fieldDefinition=this._getFieldViewDefinition(fieldsThatDiffer);fieldDefinition=_.union([modifiedByColumnDef],fieldDefinition);this._fields=this._createCatalog(fieldDefinition);},_patchField:function(fieldMeta,i){var isVisible=(fieldMeta.name!=='date_modified');return _.extend({sortable:false,selected:isVisible,position:++i},fieldMeta,{sortable:false});},_getFieldViewDefinition:function(fieldNames){var fieldDefs=[],moduleViewDefs=app.metadata.getView(this.module,'record'),addFieldDefinition=function(definition){if(definition.name&&(_.indexOf(fieldNames,definition.name)!==-1)){fieldDefs.push(app.utils.deepCopy(definition));}};_.each(moduleViewDefs.panels,function(panel){_.each(panel.fields,function(field){if(field.fields&&_.isArray(field.fields)){_.each(field.fields,function(field){addFieldDefinition(field);});}else{addFieldDefinition(field);}});});return fieldDefs;},_populateMissingDataFromDatabase:function(modelToSave,modelInDb){_.each(modelInDb.attributes,function(value,attribute){if(!modelToSave.has(attribute)||!app.utils.hasDefaultValueChanged(attribute,modelToSave)){modelToSave.set(attribute,value);}})},addPreviewEvents:function(){this._super("addPreviewEvents");this.context.off('list:preview:fire',null,this);this.context.on('list:preview:fire',function(model){app.events.trigger('preview:render',model,this.collection,false,undefined,false);app.events.trigger('preview:pagination:hide');},this);},addActions:function(){this._super("addActions");this.rightColumns.push({type:'rowaction',css_class:'btn',tooltip:'LBL_PREVIEW',event:'list:preview:fire',icon:'fa-eye'});}})