/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({className:'sweetspot-searchbar',events:{'keyup input':'keyUpHandler','click [data-action=configure]':'initConfig'},initialize:function(options){this._super('initialize',[options]);this.collection=this.layout.collection||app.data.createMixedBeanCollection();app.events.on('app:sync:complete sweetspot:reset',this.initLibrary,this);this.lastTerm='';this.layout.on('hide',function(){this.lastTerm='';},this);},initConfig:function(evt){this.layout.toggle();this.layout.trigger('sweetspot:config');},initLibrary:function(){this.internalLibrary=[];this.temporaryLibrary={};this.addToInternalLibrary(this.getSweetspotActions());this.internalLibrary=this._formatInternalLib();},_formatInternalLib:function(){var lib=_.chain(this.internalLibrary).map(function(item){return JSON.stringify(item);}).uniq().map(function(item){return JSON.parse(item)}).value();return lib;},getSweetspotActions:function(){var actionsById=app.metadata.getSweetspotActions();var prefs=app.user.getPreference('sweetspot');var data=prefs&&prefs.hotkeys;_.each(data,function(customSetting){if(!actionsById[customSetting.action]){return;}
actionsById[customSetting.action].keyword=customSetting.keyword;});return _.flatten(actionsById);},addToInternalLibrary:function(items){this.internalLibrary=this.internalLibrary.concat(items);},addToTemporaryLibrary:function(items){_.each(items,function(item){this.temporaryLibrary[item.id]=item;},this);},getTemporaryLibrary:function(){var now=new Date().getTime();var tooOld=now-300000;var updatedLibrary={};var recordList=[];_.each(this.temporaryLibrary,function(item){if(item.timestamp>tooOld){updatedLibrary[item.id]=item;recordList.push(item);}});this.temporaryLibrary=updatedLibrary;return recordList;},getLibrary:function(){return this.internalLibrary.concat(this.getTemporaryLibrary());},applyQuickSearch:function(later){var term=this.$('input').val();if(!later&&term===this.lastTerm){return;}
var results={};if(!later&&!_.isEmpty(term)){this.fireSearchRequest(term);}
if(!_.isEmpty(term)){results=this.doSearch(term);}
this.sendResults(results);this.lastTerm=term;},doSearch:function(term){var options={keys:['module','name'],threshold:'0.3',includeScore:true};var keywordFuse=new Fuse(this.internalLibrary,{keys:['keyword'],threshold:'0.0'});var keywords=keywordFuse.search(term);keywords=keywords.slice(0,5);var actionsFuse=new Fuse(_.difference(this.internalLibrary,keywords),options);var actions=actionsFuse.search(term);actions=_.sortBy(actions,function(obj){return[obj.score,obj.item.weight];});actions=actions.slice(0,6);var recordsFuse=new Fuse(_.toArray(this.temporaryLibrary),options);var records=recordsFuse.search(term);var showMore=records.length>3;records=records.slice(0,3);return{actions:_.compact(_.pluck(actions,'item')),keywords:keywords,records:_.compact(_.pluck(records,'item')),showMore:showMore,term:term};},sendResults:function(results){this.layout.trigger('sweetspot:results',results);},keyUpHandler:function(evt){if(!this.layout.isVisible()){return;}
this.debouncedSearch(evt);},debouncedSearch:_.debounce(function(event){this.applyQuickSearch();},200),fireSearchRequest:function(term){var self=this;this.collection.query=term;this.collection.fetch({query:term,fields:['name','id'],module_list:[],limit:4,success:function(collection){var now=new Date().getTime();var formattedRecords=[];_.each(collection.toJSON(),function(record){if(!record.id){return;}
var formattedRecord={id:record.id,name:record.name||app.utils.formatNameModel(record._module,record),module:record._module,label:app.lang.getModuleIconLabel(record._module),route:'#'+app.router.buildRoute(record._module,record.id),timestamp:now,weight:40};formattedRecords.push(formattedRecord);});self.addToTemporaryLibrary(formattedRecords);self.applyQuickSearch(true);}});}})