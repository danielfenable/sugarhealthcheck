/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({extendsFrom:'DnbView',duns_num:'',importFlag:false,companyList:null,keyword:null,plugins:['Connector'],events:{'click a.dnb-company-name':'dunsClickHandler','click .showMoreData':'showMoreData','click .showLessData':'showLessData','click .importDNBData':'importAccount','click .dnb_checkbox':'importCheckBox','click .clearDNBResults':'clearDNBResults','click .backToList':'backToCompanyList','click [data-action="show-more"]':'invokePagination'},selectors:{'load':'div#dnb-company-list-loading','rslt':'div#dnb-search-results','rsltList':'ul#dnb-results-list'},configuredKey:'dnb:account:create:configured',initialize:function(options){this._super('initialize',[options]);this.initDashlet();this.loadData();this.initPaginationParams();this.rowTmpl=app.template.get('dnb.dnb-account-row');this.resultTemplate=app.template.get(this.name);this.resultCountTmpl=app.lang.get('LBL_DNB_BAL_ACCT_HEADER');},loadData:function(){if(this.disposed){return;}
this.template=app.template.get(this.name+'.dnb-search-hint');this.render();this.checkConnector('ext_rest_dnb',_.bind(this.loadDataWithValidConnector,this),_.bind(this.handleLoadError,this),['test_passed']);},loadDataWithValidConnector:function(){if(this.disposed)return;this.template=app.template.get(this.name+'.dnb-search-hint');this.render();this.context.off('update:account').on('update:account',this.dnbSearch,this);this.errmsg=null;},handleLoadError:function(connector){if(this.disposed)return;this.errmsg='LBL_DNB_NOT_CONFIGURED';this.template=app.template.get(this.name+'.dnb-need-configure');this.render();this.context.off('update:account',this.dnbSearch);},backToCompanyList:function(){if(this.disposed){return;}
this.template=this.resultTemplate;if(this.listData&&this.listData.count){delete this.listData['count'];}
this.render();this.$(this.selectors.load).toggleClass('hide',false);this.$(this.selectors.rslt).toggleClass('hide',true);this.$('.importDNBData').hide();var dupeCheckParams={'type':'duns','apiResponse':this.currentPage,'module':'dunsPage'};this.baseDuplicateCheck(dupeCheckParams,this.renderPage);},renderCompanyList:function(dnbSrchApiResponse){var dnbSrchResults={},appendRecords=false;if(this.resetPaginationFlag){this.initPaginationParams();}
if(dnbSrchApiResponse.product){var apiCompanyList=this.getJsonNode(dnbSrchApiResponse.product,this.commonJSONPaths.srchRslt);this.formattedRecordSet=this.formatSrchRslt(apiCompanyList,this.searchDD);this.recordCount=this.getJsonNode(dnbSrchApiResponse.product,this.commonJSONPaths.srchCount);var nextPage=this.paginateRecords();if(_.isNull(this.currentPage)){this.currentPage=nextPage;dnbSrchResults.product=this.currentPage;}else{dnbSrchResults.product=nextPage;appendRecords=true;}
if(this.recordCount){dnbSrchResults.count=this.recordCount;}}else if(dnbSrchApiResponse.errmsg){dnbSrchResults.errmsg=dnbSrchApiResponse.errmsg;}
this.renderPage(dnbSrchResults,appendRecords);},invokePagination:function(){this._super('invokePagination',[this.baseAccountsBAL,this.balParams,this.renderCompanyList]);},dnbSearch:function(){if(this.disposed){return;}
var searchString=this.closestComponent('sidebar').getComponent('main-pane').$('[data-fieldname=name] input').val()
if(!searchString||searchString.length<3){return;}
if(!this.keyword||(this.keyword&&this.keyword!==searchString)){this.keyword=searchString;this.template=this.resultTemplate;if(this.listData&&this.listData.count){delete this.listData['count'];}
this.render();this.$('table#dnb_company_list').empty();this.$(this.selectors.load).toggleClass('hide',false);this.$(this.selectors.rslt).toggleClass('hide',true);this.$('.clearDNBResults').attr('disabled','disabled');this.$('.clearDNBResults').removeClass('enabled');this.$('.clearDNBResults').addClass('disabled');this.companyList=null;var balParams={'KeywordText':searchString};this.balParams=balParams;this.baseAccountsBAL(this.setApiPaginationParams(balParams),this.renderCompanyList);}},clearDNBResults:function(){this.$('table#dnb_company_list').empty();this.template=app.template.get(this.name+'.dnb-search-hint');this.render();},dunsClickHandler:function(evt){var duns_num=evt.target.id;this.dnbProduct=null;if(duns_num){this.template=app.template.get(this.name+'.dnb-company-details');this.render();this.$('div#dnb-company-detail-loading').show();this.$('div#dnb-company-details').hide();this.$('.importDNBData').hide();this.baseCompanyInformation(duns_num,this.compInfoProdCD.lite,app.lang.get('LBL_DNB_BACK_TO_SRCH'),this.renderCompanyDetails);}},renderCompanyDetails:function(companyDetails){if(this.disposed){return;}
this.dnbProduct={};if(companyDetails.product){var duns_num=this.getJsonNode(companyDetails.product,this.appendSVCPaths.duns);if(!_.isUndefined(duns_num)){this.duns_num=duns_num;this.dnbProduct.product=this.formatCompanyInfo(companyDetails.product,this.accountsDD);}}
if(companyDetails.errmsg){this.dnbProduct.errmsg=companyDetails.errmsg;}
this.render();this.$('div#dnb-company-detail-loading').hide();this.$('div#dnb-company-details').show();if(this.dnbProduct.errmsg){this.$('.importDNBData').hide();}else{this.$('.importDNBData').show();}},importAccount:function(){this.importAccountsData(this.importFlag);this.importFlag=true;},importCheckBox:function(){var dnbCheckBoxes=this.$('.dnb_checkbox:checked');this.$('.importDNBData').toggleClass('disabled',dnbCheckBoxes.length===0);}})