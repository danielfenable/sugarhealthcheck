/*
 * Your installation or use of this SugarCRM file is subject to the applicable
 * terms available at
 * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
 * If you do not agree to all of the applicable terms or do not have the
 * authority to bind the entity as an authorized representative, then do not
 * install or use this SugarCRM file.
 *
 * Copyright (C) SugarCRM Inc. All rights reserved.
 */
(function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={exports:{},id:n,loaded:false};e[n].call(r.exports,r,r.exports,i);r.loaded=true;return r.exports}i.m=e;i.c=t;i.p="";return i(0)})({0:function(e,t,i){e.exports=i(316)},316:function(e,t,i){window.SUGAR=i(317);i(318);i(319);i(320);i(321);i(322);i(323);i(324);i(325);i(326);i(327);i(328);i(329);i(330);i(331);i(332);i(333);i(334);i(335);i(336);i(337);i(338);i(339);i(340);i(341);i(342);i(343);i(344);i(345);i(346);i(347);i(348);i(349);i(350);i(351);i(352);i(353);i(354);i(355);i(356);i(357);i(358);i(359);i(360);i(361);i(362);i(363);i(364);i(365);i(366);i(367);i(368);i(369);i(370);i(371);if(["e2e","debug","qa"].indexOf("store")!==-1){i(372)}},317:function(e,t){var i=i||{};i.Api=function(){var e;var t={read:"GET",update:"PUT",create:"POST","delete":"DELETE"};var i=["read","update","create","delete"];var n=0;var r=function(e){e()};var a={};var s={};var o=function(e,t,i){e=e||{};e.xhr=e.xhr||{};this.request=e;this.status=e.xhr.status;this.responseText=e.xhr.responseText;this.textStatus=t;this.errorThrown=i;if(typeof this.responseText==="string"&&this.responseText.length>0){try{var n=this.request.xhr.getResponseHeader("Content-Type");if(n&&n.indexOf("application/json")===0){this.payload=JSON.parse(this.responseText);this.code=this.payload.error;this.message=this.payload.error_message}}catch(r){}}};_.extend(o.prototype,{toString:function(){return"HTTP error: "+this.status+"\ntype: "+this.textStatus+"\nerror: "+this.errorThrown+"\nresponse: "+this.responseText+"\ncode: "+this.code+"\nmessage: "+this.message}});var l=function(e,t){this.params=e;this.debug=t;this.numExecuted=0;this.state={}};_.extend(l.prototype,{execute:function(e,t,i){if(e){this.params.headers=this.params.headers||{};this.params.headers["OAuth-Token"]=e}if(t){this.params.headers=this.params.headers||{};this.params.headers["X-Metadata-Hash"]=t}if(i){this.params.headers=this.params.headers||{};this.params.headers["X-Userpref-Hash"]=i}this.state=_.extend(this.state,s);if(this.debug){console.log("====== Ajax Request Begin ======");console.log(this.params.type+" "+this.params.url);var r=this.params.data?JSON.parse(this.params.data):null;if(r&&r.password)r.password="***";console.log("Payload: ",this.params.data?r:"N/A");var a=$.extend({},this.params);delete a.data;console.log("params: ",a);console.log("====== Request End ======")}if(this.numExecuted==0){var o=this.params.complete;this.params.complete=function(){n--;if(_.isFunction(o))o.apply(this,arguments)}}this.xhr=$.ajax(this.params);n++;this.numExecuted++}});var u=function(e,t){var i=e.contents||{};this.status=e.status||200;this.statusText=e.status_text||"";this.responseText=_.isObject(i)?JSON.stringify(i):i;this.readyState=4;this._parent=t.xhr;this.headers=e.headers};_.extend(u.prototype,{isResolved:function(){return this._parent.isResolved()},getResponseHeader:function(e){return this.headers[e]},getAllResponseHeaders:function(){return _.reduce(this.headers,function(e,t,i){return e.concat(i+": "+t+"\n")},"")}});function f(e){var f,c,d,p,h,g,m,v,y,S=null,b=null,E=null,x=null,R=[],A={},T=0;d=e&&e.keyValueStore;f=e&&e.serverUrl||"/rest/v10";m=e&&e.defaultErrorHandler||null;c=e&&e.platform||"";p=e&&e.clientID||"sugar";h=(e&&e.timeout||30)*1e3;v=false;y=!(e&&e.disableBulkApi);if(e&&e.externalLoginUICallback&&_.isFunction(e.externalLoginUICallback)){S=e.externalLoginUICallback}if(d){if(!$.isFunction(d.set)||!$.isFunction(d.get)||!$.isFunction(d.cut)){throw new Error("Failed to initialize Sugar API: key/value store provider is invalid")}var C=function(){b=d.get("AuthAccessToken");E=d.get("AuthRefreshToken");x=d.get("DownloadToken")};if($.isFunction(d.initAsync)){d.initAsync(C)}else{C()}if($.isFunction(d.on)){d.on("cache:clean",function(e){e(["AuthAccessToken","AuthRefreshToken","DownloadToken"])})}}g=false;if(e&&e.reset)n=0;var O=function(e){if(e){b=e.access_token;E=e.refresh_token;x=e.download_token;if(d){d.set("AuthAccessToken",b);d.set("AuthRefreshToken",E);d.set("DownloadToken",x)}}else{b=null;E=null;x=null;if(d){d.cut("AuthAccessToken");d.cut("AuthRefreshToken");d.cut("DownloadToken")}}};var w=function(e,t,i){return function(n,a,s){var l=new o(t,a,s);var u=function(){if(R.length==0||e.refreshingToken(t.params.url)){if(i.error){i.error(l)}else if($.isFunction(e.defaultErrorHandler)){e.defaultErrorHandler(l)}}else{for(var n=0;n<R.length;++n){if(R[n]._oerror)R[n]._oerror(l)}}e.setRefreshingToken(false)};var f,d=true;if(e.needRefreshAuthToken(t.params.url,l.code)){if(t._dequeuing){if(t._oerror)t._oerror(l);e.resetAuth();return}R.push(t);e.setRefreshingToken(true);var p={complete:function(){if(d){while(f=R.shift()){if(f._ocomplete)f._ocomplete.call(this,f)}}},success:function(){e.setRefreshingToken(false);d=false;r(function(){while(f=R.shift()){f._dequeuing=true;f.execute(e.getOAuthToken())}})},error:u};if(!("crosstab"in window)||!crosstab.supported){e.login(null,{refresh:true},{complete:p.complete,success:p.success,error:p.error});return}crosstab(function(){crosstab.on("auth:refresh:complete",function(e){var t=e.data;switch(t){case"success":p.success();break;case"error":p.error();break;case"complete":p.complete();crosstab.off("auth:refresh:complete");break}});crosstab.broadcastMaster("auth:refresh")})}else if(e.needQueue(t.params.url)){R.push(t)}else if(v&&l.status==401&&l.payload&&l.payload.url&&l.payload.platform==c){e.handleExternalLogin(l,u)}else{u()}}};return{clientID:p,serverUrl:f,defaultErrorHandler:m,timeout:h,debug:false,abortRequest:function(e){var t=A[e];if(t){t.aborted=true;if(t.xhr){t.xhr.aborted=true;t.xhr.abort()}}},getRequest:function(e){return A[e]},setRefreshTokenSuccessCallback:function(e){if(_.isFunction(e))r=e},call:function(e,i,n,r,s){var o,u,f=t[e],c=this,d=this.getOAuthToken();s=s||{};r=r||{};var p={type:f,dataType:"json",headers:{},timeout:s.timeout||this.timeout,contentType:"application/json"};if(!s.url){p.url=i}if(r.success){p.success=function(e,t){o.status=e&&e.status?e.status:t;r.success(e,o)}}p.complete=function(){A[o.uid]=null;if(!g&&r.complete){r.complete(o)}};if(s.iframe===true){if(d){n=n||{};n["OAuth-Token"]=d;p.data=n}}else{if(n&&(e=="create"||e=="update"||e=="delete")){p.data=JSON.stringify(n)}}if(p.type!=="GET"){p.processData=false}o=new l(_.extend(p,s),this.debug);p.error=w(c,o,r);o._oerror=r.error;o._ocomplete=r.complete;o.uid=T++;A[o.uid]=o;u=[d,s.skipMetadataHash?null:this.getMetadataHash(),s.skipMetadataHash?null:this.getUserprefHash()];if(this.isLoginRequest(i)){o.execute()}else if(this.isAuthRequest(i)){o.execute(d)}else if(p.bulk&&y){var h=a[p.bulk]||[];if(!a[p.bulk]){a[p.bulk]=h}h.push({request:o,args:u})}else{o.execute.apply(o,u)}return o},triggerBulkCall:function(e){if(!y){return}e=e||true;var t=a[e],i=[],n=_.last(this.serverUrl.split("/"));if(!t){return}_.each(t,function(e){var t=e.request.params,r=e.args,a=r[0],s=r[1],o=r[2];if(a){t.headers=t.headers||{};t.headers["OAuth-Token"]=a}if(s){t.headers=t.headers||{};t.headers["X-Metadata-Hash"]=s}if(o){t.headers=t.headers||{};t.headers["X-Userpref-Hash"]=o}if(t.url!=""){t.url=n+t.url.substring(this.serverUrl.length)}i.push(t)},this);this.call("create",this.buildURL("bulk"),{requests:i},{success:function(e,i){_.each(t,function(t,n){var r=t.request,a=e[n],s=a.contents||{},o=new u(a,i),l;r.xhr=o;if(r.aborted===true||s.error){r.status="error";if(_.isFunction(r.params.error)){r.params.error.call(r.params,r,"error",o.statusText)}}else{if(_.isFunction(r.params.success)){r.params.success.call(r.params,s,"success")}}if(_.isFunction(r.params.complete)){r.params.complete.call(r.params,r)}})}});a[e]=null},clearBulkQueue:function(){a={}},buildURL:function(e,t,n,r){r=r||{};var a=[];var s;a.push(this.serverUrl);if(e){a.push(e)}if(t!="create"&&n&&n.id){a.push(n.id)}if(n&&n.link&&t!="file"){a.push("link");if(_.isString(n.link)){a.push(n.link)}}if(t&&$.inArray(t,i)===-1){a.push(t)}if(n&&n.relatedId){a.push(n.relatedId)}if(n&&t=="file"&&n.field){a.push(n.field);if(n.fileId)a.push(n.fileId)}s=a.join("/");_.each(r,function(e,t){if(e===null||e===undefined){delete r[t]}});r=$.param(r);if(r.length>0){s+="?"+r}return s},buildFileURL:function(e,t){var i={};t=t||{};if(e.field&&t.htmlJsonFormat!==false){i.format="sugar-html-json"}if(t.deleteIfFails===true){i.delete_if_fails=true}if(t.passOAuthToken){i.oauth_token=this.getOAuthToken()}if(t.passDownloadToken){i.download_token=this.getDownloadToken()}if(!_.isUndefined(t.forceDownload)){i.force_download=t.forceDownload?1:0}if(t.cleanCache===true){i[(new Date).getTime()]=1}if(t.platform!==undefined){i.platform=t.platform}else if(c){i.platform=c}if(t.keep===true){i.keep=1}return this.buildURL(e.module,"file",e,i)},getOAuthToken:function(){return d?d.get("AuthAccessToken")||b:b},getRefreshToken:function(){return d?d.get("AuthRefreshToken")||E:E},getDownloadToken:function(){return d?d.get("DownloadToken")||x:x},getMetadataHash:function(){return d?d.get("meta:hash"):null},getUserprefHash:function(){return d?d.get("userpref:hash"):null},getMetadata:function(e,t,i,n,r){r=r||{};var a=r.params||{},s,o;if(t){a.type_filter=t.join(",")}if(i){a.module_filter=i.join(",")}if(c){a.platform=c}s="read";if(r&&r.getPublic){s="public"}a.module_dependencies=1;o=this.buildURL("metadata",s,null,a);return this.call(s,o,null,n)},records:function(e,t,i,n,r,a){var s=this.buildURL(t,e,i,n);return this.call(e,s,i,r,a)},relationships:function(e,t,i,n,r,a){var s=this.buildURL(t,null,i,n);return this.call(e,s,i.related,r,a)},favorite:function(e,t,i,n,r){var a=i?"favorite":"unfavorite";var s=this.buildURL(e,a,{id:t});return this.call("update",s,null,n,r)},follow:function(e,t,i,n,r){n=n||{};r=r||{};var a=i?"create":"delete",s=i?"subscribe":"unsubscribe",o=this.buildURL(e,s,{id:t});return this.call(a,o,null,n,r)},enumOptions:function(e,t,i,n){var r=this.buildURL(e+"/enum/"+t);return this.call("read",r,null,i,n)},bulk:function(e,t,i){var n=this.buildURL("bulk");return this.call("create",n,e,t,i)},fileDownload:function(e,t,i){i=i||{};var n={};n.success=function(n){if(i.iframe){i.iframe.prepend('<iframe class="hide" src="'+e+'"></iframe>')}else{window.location.href=e}if(_.isFunction(t.success)){t.success.apply(arguments)}};if(_.isFunction(t.error)){n.error=t.error}if(_.isFunction(t.complete)){n.complete=t.complete}return this.call("read",this.buildURL("ping"),{},n,{processData:false})},file:function(e,t,i,n,r){var a={files:i,processData:false};if(e==="delete"){a.iframe=false}else if(!r||r.iframe!==false){a.iframe=true;r=r||{};r.passOAuthToken=true}if(!r||r.deleteIfFails!==false){r=r||{};r.deleteIfFails=true}n.success=_.wrap(n.success,function(e,t,i){if(t.error&&_.isFunction(n.error)){n.error(t)}else if(_.isFunction(e)){e(t)}});return this.call(e,this.buildFileURL(t,r),null,n,a)},count:function(e,t,i,n){n=n||{};var r=this.buildURL(e,"count",t,n);return this.call("read",r,null,i)},exportRecords:function(e,t,i,n){var r=this;var a=this.buildURL(e.module,"record_list");n=n||{};return this.call("create",a,{records:e.uid},{success:function(a){e=_.omit(e,["uid","module"]);if(n.platform!==undefined){e.platform=n.platform}else if(c){e.platform=c}r.fileDownload(r.buildURL(a.module_name,"export",{relatedId:a.id},e),i,{iframe:t})}})},search:function(e,t,i){i=i||{};var n=null;if(i.data){n=i.data;delete i.data}var r="read";if(i.fetchWithPost){r="create"}var a=i.useNewApi?"globalsearch":"search";var s=this.buildURL(null,a,null,e);return this.call(r,s,n,t,i)},login:function(e,t,i){var n,r,a,s,o;e=e||{};i=i||{};r=function(e){O(e);if(i.success)i.success(e)};a=function(e){O();if(i.error)i.error(e)};if(t&&t.refresh){n=_.extend({grant_type:"refresh_token",client_id:this.clientID,client_secret:"",refresh_token:this.getRefreshToken(),platform:c?c:"base"},t)}else{n=_.extend({grant_type:"password",username:e.username,password:e.password,client_id:this.clientID,platform:c?c:"base",client_secret:""},t);n.client_info=t}s="create";o=this.buildURL("oauth2","token",n,{platform:c});return this.call(s,o,n,{success:r,error:a,complete:i.complete})},me:function(e,t,i,n){var r=this.buildURL("me",e,t,i);return this.call(e,r,t,n)},css:function(e,t,i){var n={platform:e,themeName:t};var r=this.buildURL("css","read",{},n);return this.call("read",r,{},i)},logout:function(e,t){e=e||{};var i={token:this.getOAuthToken()};var n=this.buildURL("oauth2","logout",i);var r=e.complete;e.complete=function(){O();if(r)r()};return this.call("create",n,i,e,t)},ping:function(e,t,i){return this.call("read",this.buildURL("ping",e,null,{platform:c}),null,t,_.extend({skipMetadataHash:true},i||{}))},signup:function(e,t,i){var n=e;n.client_info=t;var r="create";var a=this.buildURL("Leads","register",n);return this.call(r,a,n,i)},verifyPassword:function(e,t){var i={password_to_verify:e};var n="create";var r=this.buildURL("me/password",n);return this.call(n,r,i,t)},updatePassword:function(e,t,i){var n={new_password:t,old_password:e};var r="update";var a=this.buildURL("me/password",r);return this.call(r,a,n,i)},info:function(e){var t=this.buildURL("ServerInfo");return this.call("read",t,null,e)},isAuthenticated:function(){return typeof this.getOAuthToken()==="string"&&this.getOAuthToken().length>0},resetAuth:function(){O()},needRefreshAuthToken:function(e,t){return!g&&(typeof this.getRefreshToken()==="string"&&this.getRefreshToken().length>0)&&!this.isAuthRequest(e)&&t==="invalid_grant"},needQueue:function(e){return g&&!this.isAuthRequest(e)},isAuthRequest:function(e){return new RegExp("/oauth2/").test(e)},isLoginRequest:function(e){return new RegExp("/oauth2/token").test(e)},refreshingToken:function(e){return g&&this.isAuthRequest(e)},setRefreshingToken:function(e){g=e},handleExternalLogin:function(e,t){var i,n;if(!self.isLoginRequest(request.params.url)){R.push(request)}self.setRefreshingToken(true);$(window).on("message",function(e){if(!e.originalEvent.origin||e.originalEvent.origin!=window.location.origin){return}$(window).on("message",null);n=$.parseJSON(e.originalEvent.data);if(!n||!n.access_token){t()}self.setRefreshingToken(false);O(n);r(function(){while(i=R.shift()){i.execute(self.getOAuthToken())}})});if(_.isFunction(S)){S(e.payload.url,"_blank","width=600,height=400,centerscreen=1,resizable=1")}},isExternalLogin:function(){return v},setExternalLogin:function(e){v=e},setExternalLoginUICallback:function(e){if(_.isFunction(e)){S=e}},getStateProperty:function(e){return s[e]},setStateProperty:function(e,t){s[e]=t},clearStateProperty:function(e){delete s[e]},resetState:function(){s={}}}}return{getInstance:function(t){return e||this.createInstance(t)},createInstance:function(t){e=new f(t);if(!("crosstab"in window)||!crosstab.supported){return e}crosstab(function(){crosstab.on("auth:refresh",_.bind(function(){if(this._runningRefreshToken){return}this._runningRefreshToken=true;var e=this;this.login(null,{refresh:true},{complete:function(){crosstab.broadcast("auth:refresh:complete","complete")},success:function(){delete e._runningRefreshToken;crosstab.broadcast("auth:refresh:complete","success")},error:function(){delete e._runningRefreshToken;crosstab.broadcast("auth:refresh:complete","error")}})},e))});return e},getCallsInProgressCount:function(){return n},HttpError:o,HttpRequest:l}}();e.exports=i},318:function(e,t){var i=window.SUGAR;var i=i||{};i.App=function(){var e,t={};var n=false;var r=[];var a=function(e){return e instanceof $?e:$(e)};function s(e){var t=_.uniqueId("SugarApp_");e=e||{};return _.extend({appId:t,$rootEl:a(e.el||"body"),$contentEl:a(e.contentEl||"#content"),additionalComponents:{}},this,Backbone.Events)}return{init:function(t){e=e||_.extend(this,new s(t));_.extend(e,e.beforeEvent);e.events.register("app:init",this);e.events.register("app:start",this);e.events.register("app:sync",this);e.events.register("app:sync:complete",this);e.events.register("app:sync:error",this);e.events.register("app:sync:public:error",this);e.events.register("app:login",this);e.events.register("app:login:success",this);e.events.register("app:logout",this);e.events.register("app:view:change",this);e.events.register("app:locale:change",this);e.events.register("lang:direction:change",this);if(e.cache){e.cache.init(this)}var n=e.utils.capitalize(e.config?e.config.appId:"")+"Controller";var r=this[n]||this.Controller;this.controller=new r;e.api=i.Api.getInstance({defaultErrorHandler:t&&t.defaultErrorHandler?t.defaultErrorHandler:i.App.error.handleHttpError,serverUrl:e.config.serverUrl,platform:e.config.platform,timeout:e.config.serverTimeout,keyValueStore:e[e.config.authStore||"cache"],clientID:e.config.clientID,disableBulkApi:e.config.disableBulkApi,externalLoginUICallback:t&&t.externalLoginUICallback});this._init(t);return e},_init:function(t){var i=this;var n=function(n){if(!e){return}if(n){i.trigger("app:sync:public:error",n);return}i._initModules();i._loadConfig();if(!t.silent){e.trigger("app:init",i)}if(t.callback&&_.isFunction(t.callback)){t.callback(e)}};var r=function(t){if(e.config.loadCss){e.loadCss(t)}else{t()}};if(e.config.syncConfig!==false){var a={getPublic:true};r(function(){e.metadata.sync(n,a)})}else{r(function(){n()})}return e},_initModules:function(){_.each(t,function(e){if(_.isFunction(e.init)){e.init(this)}},this)},_loadConfig:function(){e.config=e.config||{};e.config=_.extend(e.config,e.metadata.getConfig())},loadCss:function(t){e.api.css(e.config.platform,e.config.themeName,{success:function(i){if(e.config.loadCss==="url"){_.each(i.url,function(t){$("<link>").attr({rel:"stylesheet",href:e.utils.buildUrl(t)}).appendTo("head")})}else{_.each(i.text,function(e){$("<style>").html(e).appendTo("head")})}if(_.isFunction(t)){t()}}})},start:function(){e.events.registerAjaxEvents();e.trigger("app:start",this);e.routing.start()},destroy:function(){if(Backbone.history){Backbone.history.stop()}e=null},augment:function(i,n,r){this[i]=n;t[i]=n;if(r&&n.init&&_.isFunction(n.init)){n.init.call(n,e)}},sync:function(t){var i=this;t=t||{};if(t.getPublic){return i.syncPublic(t)}if(t.callback){r.push(t.callback)}if(n){return}n=true;async.waterfall([function(n){i.isSynced=false;i.trigger("app:sync");var r=!t.noUserUpdate&&(t.language||e.cache.get("langHasChanged"));if(r){var a=t.language||e.lang.getLanguage();i.user.updateLanguage(a,n);e.cache.cut("langHasChanged")}else{n()}},function(e){async.parallel([function(e){i.user.load(e)},function(e){i.metadata.sync(function(t){i.data.declareModels();e(t)},t)}],function(t){e(t)})},function(e){var t=i.metadata.getServerInfo();i.config.sugarLogic=i.config.sugarLogic||{};if(t&&i.config.sugarLogic.enabled&&i.utils.versionCompare(t.version,i.config.sugarLogic.minServerVersion,">=")){i.fetchSugarLogic(e)}else{i.config.sugarLogic.enabled=false;e()}},function(e){if(i.offline){i.offline.start({migrate:true,callback:e})}else e()}],function(e){if(e){i.trigger("app:sync:error",e)}else{i.isSynced=true;i.trigger("app:sync:complete")}_.each(r,function(t){t(e)});n=false;r=[]})},syncPublic:function(e){e=e||{};e.getPublic=true;this.metadata.sync(e.callback,e)},navigate:function(t,i,n){var r,a,s;t=t||e.controller.context;i=i||t.get("model");a=i.id;s=t.get("module")||i.module;r=this.router.buildRoute(s,a,n);this.router.navigate(r,{trigger:true})},login:function(t,i,n){n=n||{};i=i||{};i.current_language=e.lang.getLanguage();e.api.login(t,i,{success:function(i){e.trigger("app:login:success",i,t.username);if(n.success)n.success(i)},error:function(t){e.error.handleHttpError(t);if(n.error)n.error(t)},complete:n.complete})},logout:function(t,i,n){var r,a;t=t||{};r=t.complete;a=t.error;t.complete=function(t){e.trigger("app:logout",i);if(r){r(t)}};t.error=function(t){e.error.handleHttpError(t);if(a)a(t)};return e.api.logout(t,n)},fetchSugarLogic:function(t){if(e.config.sugarLogic.isDynamic){e.api.call("read",e.api.buildURL("ExpressionEngine","functions"),null,{success:function(i){e.cacheSugarLogicExpressions(i);e.loadSugarLogic(i,t)},error:function(e){t(e)}},{dataType:"application/text"})}else t()},cacheSugarLogicExpressions:function(t){e.cache.set("sugarlogic",t)},_loadSugarLogic:function(){return e.cache.get("sugarlogic")},loadSugarLogic:function(t,i){return e.compileJs(t||e._loadSugarLogic(),i)},compileJs:function(t,i){try{eval.call(window,t);if(i)i()}catch(n){e.logger.fatal("Failed to compile js");if(i)i(n);return n}return null},isServerCompatible:function(e){var t=this.config.supportedServerFlavors,i=this.config.minServerVersion,n,r,a;if(_.isEmpty(t)&&!i){return true}n=!!(_.isEmpty(t)||e&&_.contains(t,e.flavor));r=!!(!i||e&&this.utils.versionCompare(e.version,i,">="));if(n&&r){return true}else if(!r){a={code:"server_version_incompatible",label:"ERR_SERVER_VERSION_INCOMPATIBLE"}}else{a={code:"server_flavor_incompatible",label:"ERR_SERVER_FLAVOR_INCOMPATIBLE"}}a.server_info=e;return a},modules:t}}()},319:function(module,exports){(function(app){var _doWhenStack=[],_doWhenLocked=false,_doWhenInterval=false,_doWhenretryCount=0,_startDoWhenInterval=function(){if(!_doWhenInterval){_doWhenInterval=window.setInterval(app.utils._doWhenCheck,50)}};app.augment("utils",{capitalize:function(e){return e?e.charAt(0).toUpperCase()+(e.length>1?e.substr(1):""):""},capitalizeHyphenated:function(e){return this._classify(e,"-")},classify:function(e){return this._classify(e,"_")},_classify:function(e,t){var i=this,n="";t=t||"_";if(!e||e.lastIndexOf(t)===-1){n=i.capitalize(e)}else{var r=e.split(t);_.each(r,function(e){n+=i.capitalize(e)})}return n},extendClass:function(e,t,i,n,r){var a=null,s=null;if(_.isObject(n)){t=_.isObject(n.extendsFrom)?n.extendsFrom:e[r+"Custom"+n.extendsFrom]||e[r+n.extendsFrom]||e["Custom"+n.extendsFrom]||e[n.extendsFrom]||t;a=e[i]=t.extend(n)}else{a=e[i]=t}return a},formatNumber:function(e,t,i,n,r){t=t||i;var a=e;if(_.isNaN(e)||!_.isFinite(e)){return a}if(_.isString(e)){e=parseFloat(e,10);if(_.isNaN(e)){return a}}if(!_.isNumber(e)){if(!_.isNull(e)&&!_.isUndefined(e)){app.logger.warn("formatNumber: invalid variable type ("+typeof a+")")}return a}e=parseFloat(e.toFixed(t),10).toFixed(i).toString();return _.isString(n)&&_.isString(r)?this.addNumberSeparators(e,n,r):e},formatNumberLocale:function(e){return this.formatNumber(e,app.user.getPreference("decimal_precision")||2,app.user.getPreference("decimal_precision")||2,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".")},formatName:function(e,t){return t.replace(/(f)|(l)|(s)/g,function(t,i,n,r){if(i){return e.first_name||""}if(n){return e.last_name||""}if(r&&(e.last_name||e.first_name)){return e.salutation||""}return""}).replace(/^( )?,/g,"").replace(/, $/g,"").replace(/  /g," ").trim()},formatNameModel:function(e,t,i){i=i||app.user.getPreference("default_locale_name_format");t=t||{};var n=app.metadata.getModule(e)||{fields:{}};var r=n.nameFormat||{};return _.reduce(i.split(""),function(e,i){if(i<"a"||i>"z"){return e+i}if(!r[i]){return e}var a,s=n.fields[r[i]]&&n.fields[r[i]].type==="enum"&&!_.isEmpty(n.fields[r[i]].options);if(s){var o=app.lang.getAppListStrings(n.fields[r[i]].options);a=o[t[r[i]]]||t[r[i]]||""}return e+(a||t[r[i]]||"")},"").replace(/^( )?,/g,"").replace(/, +$/g,"").replace(/  /g," ").trim()},formatNameLocale:function(e){return this.formatName(e,app.user.getPreference("default_locale_name_format"))},addNumberSeparators:function(e,t,i){var n=e.split(".");var r=/(\d+)(\d{3})/;while(t!==""&&r.test(n[0])){n[0]=n[0].toString().replace(r,"$1"+t+"$2")}return n[0]+(n.length>1&&n[1]!==""?i+n[1]:"")},addNumberSeperators:function(e,t,i){app.logger.warn("`addNumberSeperators` is deprecated since 7.7 and will be removed in 7.9."+"Please use `addNumberSeparators` instead.");return this.addNumberSeparators(e,t,i)},unformatNumberString:function(e,t,i,n){n=n||false;if(typeof t==="undefined"||typeof i==="undefined"){return e}if(!_.isString(e)){if(_.isFinite(e)){e.toString()}else{e=""}}if(t!==""){var r=new RegExp("\\"+t,"g");e=e.replace(r,"")}e=e.replace(i,".");if(e.length>0&&n){var a=parseFloat(e);if(a==e){return a}}return e},unformatNumberStringLocale:function(e,t){return this.unformatNumberString(e,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".",t)},formatString:function(e,t){for(var i in t){e=e.replace("{"+i+"}",t[i])}return e},regexEscape:function e(t){if(typeof e.specialRegExp=="undefined"){var i=["/",".","*","+","?","|","(",")","[","]","{","}","\\","-",",","^","$","#"];e.specialRegExp=new RegExp("(\\"+i.join("|\\")+")","g")}return t.replace(e.specialRegExp,"\\$1")},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,i=e=="x"?t:t&3|8;return i.toString(16)})},cookie:{setCookie:function(e,t,i,n){var r=new Date,a;r.setDate(r.getDate()+i);a=encodeURIComponent(t);if(i){a+="; expires="+r.toUTCString()}if(n){a+="; path="+n}document.cookie=e+"="+a},getCookie:function(e){var t,i,n,r=document.cookie.split(";");for(t=0;t<r.length;t++){i=r[t].substr(0,r[t].indexOf("="));n=r[t].substr(r[t].indexOf("=")+1);i=i.replace(/^\s+|\s+$/g,"");if(i===e){return decodeURIComponent(n)}}}},isValidEmailAddress:function(e){return/^.+@.+$/gi.test(e)},doWhen:function(e,t,i,n){_doWhenStack.push({check:e,fn:t,obj:i,overrideContext:n});_doWhenretryCount=50;_startDoWhenInterval()},_doWhenCheck:function(){if(_doWhenStack.length===0){_doWhenretryCount=0;if(_doWhenInterval){clearInterval(_doWhenInterval);_doWhenInterval=null}return}if(_doWhenLocked){return}_doWhenLocked=true;var tryAgain=$.isReady;if(!tryAgain){tryAgain=_doWhenretryCount>0&&_doWhenStack.length>0}var notAvail=[];var executeItem=function(e,t){if(t.overrideContext){if(t.overrideContext===true){e=t.obj}else{e=t.overrideContext}}if(t.fn){t.fn.call(e,t.obj)}};var i,len,item,test;for(i=0,len=_doWhenStack.length;i<len;i=i+1){item=_doWhenStack[i];if(item){test=item.check;if(typeof test=="string"&&eval(test)||typeof test=="function"&&test()){executeItem(this,item);_doWhenStack[i]=null}else{notAvail.push(item)}}}_doWhenretryCount--;if(tryAgain){for(i=_doWhenStack.length-1;i>-1;i--){item=_doWhenStack[i];if(!item||!item.check){_doWhenStack.splice(i,1)}}_startDoWhenInterval()}else{if(_doWhenInterval){clearInterval(_doWhenInterval);_doWhenInterval=null}}_doWhenLocked=false},versionCompare:function(e,t,i){return version_compare(e,t,i)},extendFrom:function(e,t,i){e.prototype=new t;_.extend(e.prototype,i)},deepCopy:function(e){return _.isObject(e)?JSON.parse(JSON.stringify(e)):e},compareBeans:function(e,t){var i;if(e.module!==t.module){throw Error("Only beans of the same module can be compared.")}i=_.reduce(e.attributes,function(i,n,r){if(r!=="id"&&r.indexOf("_")!==0){if(!this.areBeanValuesEqual(n,t.get(r))&&this.hasDefaultValueChanged(r,e)){i.push(r)}}return i},[],this);return i},areBeanValuesEqual:function(e,t){var i=function(e){if(_.isObject(e)&&_.isEmpty(e)){return""}else if(!_.isObject(e)&&(_.isUndefined(e)||_.isNull(e))){return""}else{return e}};e=i(e);t=i(t);return _.isObject(e)&&_.isEqual(e,t)||!_.isObject(e)&&e===t},hasDefaultValueChanged:function(e,t){var i=t._defaults?t._defaults[e]:"";return!this.areBeanValuesEqual(i,t.get(e))},isConnectivityError:function(e){return e.status===0||e.textStatus==="timeout"},getTimestamp:function(e,t){t=t||{};var i=e?new Date(e):new Date,n=i.toISOString();if(!t.msecPrecision){n=n.replace(/\.\d{3}/,"")}return n.replace(/Z/,"+00:00")},buildUrl:function(e){if(e.indexOf("http")!==0&&!_.isEmpty(app.config.siteUrl)){e=app.config.siteUrl.replace(/\/+$/,"")+"/"+e}return e},getChangedProps:function(e,t,i){function n(e){if(_.isObject(e)){if(_.isArray(e)){return"array"}return"object"}return"other"}function r(e,t){if(i)return _.isEqual(e,t);var a=n(e),s=n(t);if(a===s&&_.contains(["object","array"],a)){if(a==="array"&&e.length!==t.length){return false}var o=_.keys(e),l=_.keys(t);if(o.length!==l.length||!_.isEqual(o.sort(),l.sort())){return false}return!_.any(e,function(i,n){return!r(e[n],t[n])})}else{return i?e===t:e==t}}var a={};_.each(e,function(i,n){if(!r(e[n],t[n])){a[n]=i}});return a},getParentLayout:function(e){var t;if(e.view&&e.view.layout){t=e.view.layout}else{t=e.layout}return t},isSortable:function(e,t){var i=app.metadata.getModule(e).fields[t.name],n=true;if(i&&!_.isUndefined(i.sortable)){n=i.sortable}if(t&&!_.isUndefined(t.sortable)){n=t.sortable}return n},stripHttpPrefix:function(e){return e.replace(/^https?:\/\//,"")},hardRefresh:function(){window.location.reload(true)},isDirectionRTL:function(e){var t="A-Za-zÀ-ÖØ-öø-ʸ̀-֐ࠀ-῿"+"Ⰰ-﬜﷾-﹯﻽-￿",i="֑-߿יִ-﷽ﹰ-ﻼ",n=new RegExp("^[^"+t+"]*["+i+"]");return n.test(e)}})})(SUGAR.App)},320:function(e,t){(function(e){var t="";var i=function(e){return t+e};var n={store:stash,init:function(){t=e.config.env+":"+e.config.appId+":";e.events.register("cache:clean",this)},has:function(e){if(this.store===stash){return window.localStorage.getItem(i(e))!==null}else{this.store.has(i(e))}},get:function(e){return this.store.get(i(e))},set:function(e,t){try{this.store.set(i(e),t)}catch(n){if(n.name.toLowerCase().indexOf("quota")>-1){this.clean();this.store.set(i(e),t)}}},add:function(e,t){try{this.store.add(i(e),t)}catch(n){if(n.name.toLowerCase().indexOf("quota")>-1){this.clean();this.store.add(i(e),t)}}},clean:function(){var e=[],t={};this.trigger("cache:clean",function(t){e=_.union(t,e)});_.each(e,function(e){t[e]=this.get(e)},this);this.cutAll();_.each(t,function(e,t){if(!_.isUndefined(e)){this.set(t,e)}},this)},cut:function(e){if(this.store.has(i(e))){this.store.cut(i(e))}},cutAll:function(e){if(e===true)return this.store.cutAll();var i=this.store.getAll();var n=_.keys(i);for(var r=0,a=n.length;r<a;r++){if(n[r].indexOf(t)===0){this.store.cut(n[r])}}}};_.extend(n,Backbone.Events);e.augment("cache",n)})(SUGAR.App)},321:function(e,t){(function(e){e.augment("events",_.extend({register:function(e,t){t.on(e,function(){var t=[].slice.call(arguments,0);t.unshift(e);this.trigger.apply(this,t)},this)},unregister:function(e,t){e.off(t)},registerAjaxEvents:function(){var e=this;$(document).off("ajaxStop");$(document).off("ajaxStart");$(document).on("ajaxStart",function(t){e.trigger("ajaxStart",t)});$(document).on("ajaxStop",function(t){e.trigger("ajaxStop",t)})}},Backbone.Events))})(SUGAR.App)},322:function(e,t){(function(e){var t=/\s+/;var i=function(e,i,n,r){if(!n)return true;if(typeof n==="object"){for(var a in n){e[i].apply(e,[a,n[a]].concat(r))}return false}if(t.test(n)){var s=n.split(t);for(var o=0,l=s.length;o<l;o++){e[i].apply(e,[s[o]].concat(r))}return false}return true};var n=function(e,t){var i=false;var n,r,a=-1,s=e.length;switch(t.length){case 0:case 1:case 2:case 3:while(++a<s)i=(n=e[a]).callback.call(n.ctx,t[0],t[1],t[2])===false||i;break;default:while(++a<s)i=(n=e[a]).callback.apply(n.ctx,t)===false||i}return!i};_.extend(e,{beforeEvent:{before:function(e,t,n){if(!i(this,"before",e,[t,n])||!t){return this}this._before||(this._before={});var r=this._before[e]||(this._before[e]=[]);r.push({callback:t,context:n,ctx:n||this});return this},triggerBefore:function(e){var i=false;if(!this._before){return!i}var r=Array.prototype.slice.call(arguments,1);if(t.test(e)){var a=e.split(t);for(var s=0,o=a.length;s<o;s++){i=!this["triggerBefore"].apply(this,[a[s]].concat(r))||i}return!i}var l=this._before[e];var u=this._before.all;if(l){i=n(l,r)===false}if(u){i=n(u,r)===false||i}return!i},offBefore:function(e,t,n){var r,a,s,o,l,u,f,c;if(!this._before||!i(this,"offBefore",e,[t,n])){return this}if(!e&&!t&&!n){this._before=void 0;return this}o=e?[e]:_.keys(this._before);for(l=0,u=o.length;l<u;l++){e=o[l];if(s=this._before[e]){this._before[e]=r=[];if(t||n){for(f=0,c=s.length;f<c;f++){a=s[f];if(t&&t!==a.callback||n&&n!==a.ctx){r.push(a)}}}if(!r.length){delete this._before[e]}}}return this}}})})(SUGAR.App)},323:function(e,t){(function(e){var t={plugins:{view:{},field:{},layout:{},model:{},collection:{}},_get:function(e,t){if(this.plugins[t]&&this.plugins[t][e]){return this.plugins[t][e]}},attach:function(e,t){_.each(e.plugins,function(i,n){var r=null;if(_.isObject(i)){var a=_.keys(i)[0];r=i[a];i=a}var s=this._get(i,t);if(s&&!this._isPluginDisabled(e,i)){var o=_.extend({},_.isFunction(e.events)?e.events():e.events,s.events);

_.extend(e,s);if(r){_.extend(e,r);if(r.events){_.extend(o,r.events)}}e.events=o;if(_.isFunction(s.onAttach)){s.onAttach.call(e,e,s)}}},this)},detach:function(e,t){_.each(e.plugins,function(i){var n=this._get(i,t);if(n&&_.isFunction(n.onDetach)){n.onDetach.call(e,e,n)}},this)},_isPluginDisabled:function(e,t){return!!_.find(e.disabledPlugins,function(e){return e===t})},register:function(e,t,i){if(!_.isArray(t)){t=[t]}_.each(t,function(t){this.plugins[t]=this.plugins[t]||{};this.plugins[t][e]=i},this)}};e.augment("plugins",t,false)})(SUGAR.App)},324:function(e,t){(function(e){var t={init:function(){this.initialize()},initialize:function(e){e=e||{};this.remoteLogging=e.remoteLogging||false;this.statusCodes=e.statusCodes?_.extend(this.statusCodes,e.statusCodes):this.statusCodes;if(!e.disableOnError){this.enableOnError()}},_callCustomHandler:function(e,t,i){if(t){t.apply(this,_.union([e],i||[]))}else{this.handleStatusCodesFallback(e)}},_handleFineGrainedError:function(t,i){var n="handle"+e.utils.classify(t.code)+"Error";(this[n]||i||this.handleStatusCodesFallback).call(this,t)},statusCodes:{0:function(e,t,i){if(e.textStatus==="timeout"){this._callCustomHandler(e,this.handleTimeoutError)}else{this.handleStatusCodesFallback(e,t,i)}},400:function(e){this._handleFineGrainedError(e,this.handleUnspecified400Error)},401:function(e){this._handleFineGrainedError(e,this.handleUnauthorizedError)},403:function(e){this._callCustomHandler(e,this.handleForbiddenError)},404:function(e){this._callCustomHandler(e,this.handleNotFoundError,_.rest(arguments))},405:function(e){this._callCustomHandler(e,this.handleMethodNotAllowedError)},409:function(e){this._callCustomHandler(e,this.handleMethodConflictError)},412:function(e){this._callCustomHandler(e,this.handleHeaderPreconditionFailed)},422:function(e,t){e.model=t;this._callCustomHandler(e,this.handleValidationError,_.rest(arguments))},424:function(e,t){e.model=t;this._callCustomHandler(e,this.handleMethodFailureError,_.rest(arguments))},500:function(e){this._callCustomHandler(e,this.handleServerError)},503:function(e){this._callCustomHandler(e,this.handleServerError)}},remoteLogging:false,errorName2Keys:{maxValue:"ERROR_MAXVALUE",minValue:"ERROR_MINVALUE",maxLength:"ERROR_MAX_FIELD_LENGTH",minLength:"ERROR_MIN_FIELD_LENGTH",datetime:"ERROR_DATETIME",required:"ERROR_FIELD_REQUIRED",email:"ERROR_EMAIL",primaryEmail:"ERROR_PRIMARY_EMAIL",duplicateEmail:"ERROR_DUPLICATE_EMAIL",number:"ERROR_NUMBER",isBefore:"ERROR_IS_BEFORE",isAfter:"ERROR_IS_AFTER",greaterThan:"ERROR_IS_GREATER_THAN",lessThan:"ERROR_IS_LESS_THAN"},getErrorString:function(t,i){var n=i.module||"";return e.lang.get(this.errorName2Keys[t]||t,n,i)},handleValidationError:function(t){var i=t.responseText;var n=t.model;e.alert.dismissAll();_.each(i,function(t,i){var n="";if(_.isObject(t)){_.each(t,function(e,t){n+="(Message) "+this.getErrorString(t,e)+"\n"},this)}else{n=t}e.logger.debug("validation failed for field `"+i+"`:\n"+n)},this)},handleHttpError:function(t,i,n){if(e.error.statusCodes[t.status]){e.error.statusCodes[t.status].call(e.error,t,i,n)}else{e.error.handleStatusCodesFallback(t)}},handleUnhandledError:function(t,i,n){e.logger.fatal(t+" at "+i+" on line "+n)},handleStatusCodesFallback:function(t){e.logger.error(t.toString())},handleRenderError:function(t,i,n){var r="render_error_"+t.module+"_"+t.name;var a="error";var s,o;switch(i){case"_renderHtml":s=e.lang.get("ERR_RENDER_FAILED_TITLE");o=[e.lang.get("ERR_RENDER_FAILED_MSG"),e.lang.get("ERR_CONTACT_TECH_SUPPORT")];break;case"_renderField":s=e.lang.get("ERR_RENDER_FIELD_FAILED_TITLE");o=[e.utils.formatString(e.lang.get("ERR_RENDER_FIELD_FAILED_MSG"),[n.name]),e.lang.get("ERR_CONTACT_TECH_SUPPORT")];break;case"view_render_denied":s=e.lang.get("ERR_NO_VIEW_ACCESS_TITLE");a="warning";o=[e.utils.formatString(e.lang.get("ERR_NO_VIEW_ACCESS_MSG"),[t.module])];break;case"layout_render":s=e.lang.get("ERR_LAYOUT_RENDER_TITLE");o=[e.lang.get("ERR_LAYOUT_RENDER_MSG")];break;default:s=e.lang.get("ERR_GENERIC_TITLE");o=[e.lang.get("ERR_INTERNAL_ERR_MSG"),e.lang.get("ERR_CONTACT_TECH_SUPPORT")];e.logger.error("handleRenderError called for render error caught in "+i+", but we have no corresponding handler!");break}e.alert.show(r,{level:a,title:s,messages:o})},enableOnError:function(e,t){var i,n=this;if(this.overloaded){return false}i=window.onerror;window.onerror=function(r,a,s){if(e){e.call(t)}else{n.handleUnhandledError(r,a,s)}if(i){i()}};this.overloaded=true;return true},throwErrorWithCallStack:function(e,t){if(_.isString(e)){e=new Error(e)}e.message=e.message+"; "+e.stack;if(t){return e}throw e}};e.augment("error",t,false)})(SUGAR.App)},325:function(module,exports){(function(app){var _header="(function() {\n  var template = Handlebars.template, templates = Handlebars.templates = Handlebars.templates || {};\n",_footer="})();",_templates={},_sources={},_templateManager;_templateManager={init:function(){_templates=app.config.cacheMeta?app.cache.get("templates")||{}:{};var src="";_.each(_templates,function(e){src+=e});try{eval(_header+src+_footer)}catch(e){app.logger.error("Failed to eval templates retrieved from local storage:\n"+e)}},_add:function(e,t,i){var n=e[0],r=this.get(n,false);if(r&&!i){return}if(r&&i&&_sources[n]!=t){_templates[n]=Handlebars.templates[n]=null}_sources[n]=t},_compile:function(e,t,i){Handlebars.templates=Handlebars.templates||{};_templates[e[0]]=Handlebars.templates[e[0]]=i||!e[1]?this.compile(e[0],t):e[1];return _templates[e[0]]},compile:function(key,src){try{_templates[key]="templates['"+key+"'] = template("+Handlebars.precompile(src)+");\n";eval(_header+_templates[key]+_footer)}catch(e){app.logger.error("Failed to compile or eval template "+key+".\n"+e)}return this.get(key,false)||this.empty},get:function(e,t){t=_.isUndefined(t)||t;if(t&&!Handlebars.templates[e]&&_sources[e]){this._compile([e],_sources[e])}return Handlebars.templates?Handlebars.templates[e]:null},_getView:function(e,t,i){var n=e+(t?"."+t:"");return[n,this.get(n,i)]},getView:function(e,t){return this._getView(e,t,true)[1]},_getField:function(e,t,i,n,r,a){var s,o="f."+e+".",l=o+(i?i+".":"")+t;i+=".";s=this.get(o+i+t,a)||this.get(o+t,a);if(!s&&!r){s=this.get(o+i+n,a)||this.get(o+n,a);if(!s){s=this.get("f.base."+t,a)||this.get("f.base."+n,a)}}return[l,s]},getField:function(e,t,i,n){return this._getField(e,t,i,n,false,true)[1]},_getLayout:function(e,t,i){var n="l."+(t?t+".":"")+e;return[n,this.get(n,i)]},getLayout:function(e,t){return this._getLayout(e,t,true)[1]},setView:function(e,t,i,n){return this._add(this._getView(e,t,false),i,n)},setField:function(e,t,i,n,r){return this._add(this._getField(e,t,i,null,true,false),n,r)},setLayout:function(e,t,i,n){return this._add(this._getLayout(e,t,false),i,n)},set:function(e,t){if(e.views){_.each(e.views,function(e,i){if(i!="_hash"){_.each(e.templates,function(e,n){n=i==n?n:i+"."+n;this.setView(n,null,e,t)},this)}},this)}if(e.fields){_.each(e.fields,function(e,i){if(i!="_hash"){_.each(e.templates,function(e,n){this.setField(i,n,null,e,t)},this)}},this)}if(e.layouts){_.each(e.layouts,function(e,i){if(i!="_hash"){_.each(e.templates,function(e,n){n=i==n?n:i+"."+n;this.setLayout(n,null,e,t)},this)}},this)}},empty:function(){return""}};app.augment("template",_templateManager)})(SUGAR.App)},326:function(e,t){(function(e){e.Context=Backbone.Model.extend({initialize:function(e){Backbone.Model.prototype.initialize.call(this,e);this.id=this.cid;this.parent=null;this.children=[];this._fetchCalled=false},clear:function(e){var t=this.get("collection");t&&t.abortFetchRequest();e=_.extend({clearAllListeners:true},e||{});_.each(this.children,function(t){t.clear(e)});this.children=[];this.parent=null;_.each(this.attributes,function(t){if(t&&t.off===Backbone.Events.off){if(e.clearAllListeners){t.off();if(_.isFunction(t.dispose)){t.dispose()}}else{t.off(null,null,this)}}},this);delete e.clearAllListeners;this.off();Backbone.Model.prototype.clear.call(this,e);this.resetLoadFlag()},resetLoadFlag:function(e){e=_.isUndefined(e)?true:e;this._fetchCalled=false;if(this.get("model")){this.get("model").dataFetched=false}if(this.get("collection")){this.get("collection").dataFetched=false}if(e){_.each(this.children,function(e){e.resetLoadFlag()})}},isCreate:function(){return this.get("create")===true},getChildContext:function(t){var i,n=t.forceNew||false;delete t.forceNew;var r=t.cid||t.name||t.link||t.module;if(r&&!n){i=_.find(this.children,function(e){return e.cid==r||e.get("link")==r||e.get("module")==r})}if(!i){i=e.context.getContext(t);this.children.push(i);i.parent=this}if(t.link){var a=this.get("model");i.set({parentModel:a,parentModule:a?a.module:null})}else if(!t.module){i.set({module:this.get("module")})}this.trigger("context:child:add",i);return i},prepare:function(e){if(!e&&(this.get("model")||this.get("collection")))return;var t=this.get("modelId"),i=this.get("create"),n=this.get("link");this.set(n?this._prepareRelated(n,t,i):this._prepare(t,i));return this},_prepare:function(t,i){var n,r,a=this.get("module"),s=this.get("mixed"),o;if(t){n=e.data.createBean(a,{id:t});o=[n]}else if(i===true){n=e.data.createBean(a);o=[n]}else{n=e.data.createBean(a)}r=s===true?e.data.createMixedBeanCollection(o):e.data.createBeanCollection(a,o);return{collection:r,model:n}},_prepareRelated:function(t,i,n){var r,a,s=this.get("parentModel");s=s||e.data.createBean(this.get("parentModule"),{id:this.get("parentModelId")});if(i){r=e.data.createRelatedBean(s,i,t);a=e.data.createRelatedCollection(s,t,[r])}else if(n===true){r=e.data.createRelatedBean(s,null,t);a=e.data.createRelatedCollection(s,t,[r])}else{r=e.data.createRelatedBean(s,null,t);a=e.data.createRelatedCollection(s,t)}if(!this.has("parentModule")){this.set({parentModule:s.module},{silent:true})}if(!this.has("module")){this.set({module:r.module},{silent:true})}return{parentModel:s,collection:a,model:r}},loadData:function(t){if(this.isDataFetched()||this.get("create")===true)return;var i,n=this.get("modelId"),r=this.get("module"),a=e.config.orderByDefaults&&r?e.config.orderByDefaults[r]:null;t=t||{};i=n?this.get("model"):this.get("collection");if(a&&i instanceof e.BeanCollection&&!i.orderBy){i.orderBy=a}if(i&&(i instanceof e.Bean||i instanceof e.BeanCollection)){if(this.get("dataView")&&_.isString(this.get("dataView"))){i.setOption("view",this.get("dataView"))}if(this.get("fields")){i.setOption("fields",this.get("fields"))}if(this.get("limit")){i.setOption("limit",this.get("limit"))}if(this.get("module_list")){i.setOption("module_list",this.get("module_list"))}if(this.get("viewed")){i.setOption("viewed",this.get("viewed"))}t.context=this;if(this.get("skipFetch")!==true){i.fetch(t)}this._fetchCalled=true}else{e.logger.warn("Skipping fetch because model is not Bean, Bean Collection, or it is not defined, module: "+this.get("module"))}},reloadData:function(e){e=e||{};this.resetLoadFlag(e.recursive);this.loadData(e);this.trigger("reload",this,e)},isDataFetched:function(){var e=this.get("modelId")?this.get("model"):this.get("collection");return this._fetchCalled||e&&!!e.dataFetched}});e.augment("context",{getContext:function(t){return new e.Context(t)}})})(SUGAR.App)},327:function(e,t){(function(e){var t=Backbone.View.extend({initialize:function(){this.context=e.context.getContext();e.events.on("app:sync:complete",function(){e.api.setStateProperty("loadingAfterSync",true);_.each(e.additionalComponents,function(e){if(e&&_.isFunction(e._setLabels)){e._setLabels()}e.render()});e.router.start();e.api.clearStateProperty("loadingAfterSync")});e.events.on("app:login:success",function(){e.sync()})},loadView:function(t){var i=this.layout;if(!e.triggerBefore("app:view:change")||!e.triggerBefore("app:view:load")){return}this.context.clear({silent:true});this.context.set(t);this.context.prepare();this.layout=e.view.createLayout({name:t.layout,module:t.module,context:this.context});if(i){var n=document.createDocumentFragment();n.appendChild(i.el)}e.$contentEl.append(this.layout.$el);this.layout.initComponents();if(!t||t&&!t.skipFetch){this.layout.loadData()}this.layout.render();if(i){i.dispose()}e.trigger("app:view:change",t.layout,t)},loadAdditionalComponents:function(t){_.each(e.additionalComponents,function(e){if(e){e.remove();e.dispose()}});e.additionalComponents={};_.each(t,function(t,i){if(t.target){var n=this.$(t.target);if(t.layout){if(!n.get(0)){e.logger.error('Unable to place additional component "'+i+'": the target specified does not exist.');return}e.additionalComponents[i]=e.view.createLayout({context:this.context,name:t.layout,el:n});e.additionalComponents[i].initComponents()}else{e.additionalComponents[i]=e.view.createView({name:t.view||i,context:this.context,el:n})}e.additionalComponents[i].render()}else{e.logger.error('Unable to place additional component "'+i+'": no target specified.')}})}});e.augment("Controller",t,false);e.events.on("app:init",function(e){e.controller.setElement(e.$rootEl)},e.controller).on("app:start",function(e){e.controller.loadAdditionalComponents(e.config.additionalComponents)})})(SUGAR.App)},328:function(e,t){(function(e){var t;e.augment("routing",{beforeRoute:function(t,i){if(!this.triggerBefore("route",{route:t,args:i}))return false;if(_.indexOf(e.config.unsecureRoutes,t)>=0)return true;if(!e.api.isAuthenticated()){e.router.login();return false}else if(!e.isSynced){Backbone.history.stop();e.sync();return false}return true},after:function(e,t){},setRoutes:function(e){t=e},start:function(){var i={};if(t){i.customRoutes=t}e.augment("router",new e.Router(i),false);e.events.trigger("router:start",e.router);e.router.start()}});_.extend(e.routing,e.beforeEvent);e.Router=Backbone.Router.extend({initialize:function(e){e=e||{};this._previousFragment="";this._currentFragment="";if(e.customRoutes){this.customRoutes=e.customRoutes;this._bindCustomRoutes()}},_bindCustomRoutes:function(){if(!this.customRoutes)return;this.customRoutes.reverse();_.each(this.customRoutes,function(e){this.route(e.route,e.name,e.callback)},this)},_routeHandler:function(t){var i=Array.prototype.slice.call(arguments,1),n=t.route;if(e.routing.beforeRoute(n,i)){this._previousFragment=this._currentFragment;this._currentFragment=this.getFragment();t.apply(this,i);e.routing.after(n,i)}},_moduleExists:function(t){if(t&&_.isUndefined(e.metadata.getModule(t))){e.error.handleHttpError({status:404});return false}return true},route:function(e,t,i){if(!i)i=this[t];i.route=t;i=_.wrap(i,this._routeHandler);Backbone.Router.prototype.route.call(this,e,t,i)},getFragment:function(){return Backbone.history.getFragment()},navigate:function(e,t){Backbone.Router.prototype.navigate.apply(this,arguments);if(!(t&&t.trigger)){this._previousFragment=this._currentFragment;this._currentFragment=this.getFragment()}return this},getPreviousFragment:function(){return this._previousFragment},goBack:function(){e.logger.debug("Navigating back...");window.history.back()},go:function(e){window.history.go(e)},start:function(){e.logger.info("Router Started");Backbone.history.stop();return Backbone.history.start()},refresh:function(){Backbone.history.loadUrl(Backbone.history.fragment)},buildRoute:function(t,i,n){var r;if(e.utils&&_.isFunction(e.utils.customBuildRoute)){r=e.utils.customBuildRoute.apply(this,arguments);if(!_.isEmpty(r)){return r}}if(t){r=_.isString(t)?t:t.get("module");if(i){r+="/"+i}if(n){r+="/"+n}}else{r=n}return r},index:function(){e.logger.debug("Route changed to index");if(e.config.defaultModule){this.navigate(e.config.defaultModule,{trigger:true})}else if(e.acl.hasAccess("read","Home")){this.navigate("Home",{trigger:true})}},list:function(t){if(!this._moduleExists(t)){return}e.logger.debug("Route changed to list of "+t);e.controller.loadView({module:t,layout:"records"})},layout:function(t,i){if(!this._moduleExists(t)){return}e.logger.debug("Route changed to layout: "+i+" for "+t);e.controller.loadView({module:t,layout:i})},create:function(t){if(!this._moduleExists(t)){return}e.logger.debug("Route changed: create "+t);e.controller.loadView({module:t,create:true,layout:"edit"})},login:function(){e.logger.debug("Logging in");e.controller.loadView({module:"Login",layout:"login",create:true});e.events.trigger("app:login");if(e.config.externalLogin){e.api.ping(null,{success:function(){e.events.trigger("app:login:success");e.router.refresh()},error:function(){e.alert.show("needs_login_error",{level:"error",messages:e.lang.getAppString("LBL_PORTAL_INVALID_CREDS_TITLE"),title:e.lang.get("LBL_PORTAL_INVALID_CREDS_TITLE")})}})}},logout:function(t){t=t==="1";e.logger.debug("Logging out: "+t);e.logout({complete:function(){e.router.navigate("#");if(t){window.location.reload()}else{if(e.config.externalLogin){e.controller.loadView({module:"Login",layout:"logout",skipFetch:true,create:true})}else{e.router.login()}}},success:function(t,i){e.events.trigger("app:logout:success",t)}},t)},record:function(t,i,n,r){if(!this._moduleExists(t)){return}var a=e.controller.context.get("collection"),s=e.controller.context.get("listCollection"),o={module:t,layout:r||"record",action:n||"detail"};if(i!=="create"){_.extend(o,{modelId:i})}else{_.extend(o,{create:true});o.layout="create"}if(a&&a.module===t&&a.get(i)){o.listCollection=a}if(s&&s.module===t&&s.get(i)){o.listCollection=s}e.controller.loadView(o)},redirect:function(e,t){this.navigate(e,_.extend({trigger:true,replace:true},t))}})})(SUGAR.App)},329:function(e,t){(function(e){e.augment("lang",{direction:"ltr",get:function(e,t,i){var n=this.getModString(e,t,i)||this.getAppString(e,i)||e;return n},getModString:function(e,t,i){var n;if(_.isArray(t)){_.find(t,function(t){n=this._get("mod_strings",e,t,i);return!_.isEmpty(n)},this)}else{n=this._get("mod_strings",e,t,i)}return n},getAppString:function(e,t){return this._get("app_strings",e,null,t)},getAppListStrings:function(t){var i=e.metadata.getStrings("app_list_strings")[t]||{};if(_.isArray(i)){var n={};_.each(i,function(e){if(_.isString(e)){n[e]=e}else if(_.isArray(e)&&e.length===2){n[e[0]]=e[1]}});i=n}return i},getModuleName:function(e,t){t=t||{};var i=!t.plural&&this.getModString("LBL_MODULE_NAME_SINGULAR",e)||this.getModString("LBL_MODULE_NAME",e);if(!i&&!_.isUndefined(t.defaultValue)){i=this.get(t.defaultValue)}return i||e},getAppListKeys:function(t){var i=[],n=e.metadata.getStrings("app_list_strings")[t]||{};if(_.isArray(n)){_.each(n,function(e){if(e.length===2){i.push(e[0])}})}else if(_.isObject(n)){i=_.keys(n)}return i},_get:function(t,i,n,r){var a,s=e.metadata.getStrings(t);s=n?s[n]:s;if(!s||!_.isString(s[i])){return}a=this._sanitize(s[i]);if(!_.isUndefined(r)&&a.indexOf("{{")>-1){i="lang."+(n?i+"."+n:i);var o=Handlebars.templates[i];a=o?o(r):e.template.compile(i,a)(r)}return a},_sanitize:function(e){return e.slice(-1)===":"?e.slice(0,-1):e},getLanguage:function(){return this._currentLanguage},setLanguage:function(t,i,n){var r=this;n=n||{};_.each(Handlebars.templates,function(e,t){if(t.indexOf("lang.")===0){delete Handlebars.templates[t]}});if(n.noSync===true){this.updateLanguage(t);return}e.sync({callback:function(a){var s=false;if(!a){r.updateLanguage(t);s=!e.api.isAuthenticated()&&!n.noUserUpdate;e.cache.set("langHasChanged",s)}if(i)i(a)},getPublic:!e.api.isAuthenticated(),noUserUpdate:n.noUserUpdate||false,language:t,forceRefresh:true,metadataTypes:["labels"]})},updateLanguage:function(t){e.cache.set("lang",t);e.user.setPreference("language",t);e.trigger("app:locale:change");this.setCurrentLanguage(t)},setDefaultLanguage:function(e){this._defaultLanguage=e},getDefaultLanguage:function(){return this._defaultLanguage},setCurrentLanguage:function(e){this._currentLanguage=e;this.setDirection(e)},setDirection:function(t){var i=["he_IL","ar_SA"],n=_.contains(i,t),r=this.direction;this.direction=n?"rtl":"ltr";if(this.direction!==r){e.trigger("lang:direction:change")}}})})(SUGAR.App)},330:function(module,exports){(function(app){var _keyPrefix="meta:";var _metadata={};var _mdLoaded={};var _syncing=false;function _setHash(e,t){var i=t?"public:":"";app.cache.set(_keyPrefix+i+"hash",e._hash)}function _cacheMeta(e){app.cache.set(_keyPrefix+"data",e)}function _getCachedMeta(){return app.cache.get(_keyPrefix+"data")}function _injectLabels(e,t){_.each(t,function(i,n){if(n!=="_hash"){e[n]=t[n]}});delete e.labels}function _fetchLabels(e,t){var i,n,r,a=app.user.getLanguage();i=e.ordered_labels||e.labels;app.lang.setDefaultLanguage(i["default"]);if(t.language&&i[t.language]){n=t.language}else if(i[a]){n=a}else{n=app.lang.getDefaultLanguage();if(app.user.id){app.user.updateLanguage(n)}}app.lang.setCurrentLanguage(n);r=app.utils.buildUrl(i[n]);app.api.call("read",r,null,{success:function(e){try{e=_.isString(e)?JSON.parse(e):e}catch(i){app.logger.fatal("Failed to parse labels data: "+i);t.error({code:"sync_failed",label:"ERR_SYNC_FAILED"});return}t.success(e)},error:function(e){e.code="sync_failed";e.label="ERR_SYNC_FAILED";t.error(e)}})}function _initCustomComponents(e,t){var i=this,n=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each({layout:"layout",view:"view",fieldTemplate:"field",data:"data"},function(r,a){if(i._metaTypeIsSeparatedByPlatform(e,a,n)){_.each(n,function(n){var s=e[a+"s"][n];i._sortAndDeclareComponents(s,r,t,n)})}_.each(e[a+"s"],function(e,i){if(r==="view"&&e.templates){_.each(e.templates,function(e,n){var r=i===n;n=r?n:i+"."+n;app.template.setView(n,t,e,true)})}if(r==="layout"&&e.templates){_.each(e.templates,function(e,n){n=i===n?n:i+"."+n;app.template.setLayout(n,t,e,true)})}if(r==="field"&&e.templates){_.each(e.templates,function(e,n){app.template.setField(i,n,t,e,true)})}})},this)}app.augment("metadata",{fieldTypeMap:{varchar:"text",datetime:"datetimecombo",multienum:"enum",text:"textarea",decimal:"float"},_patchMetadata:function(e,t){if(!t||t._patched===true){return t}_.each(t.views,function(i){if(i.meta){_.each(i.meta.panels,function(i){i.fields=this._patchFields(e,t,i.fields)},this)}},this);t._patched=true;return t},_patchFields:function(e,t,i){var n=this;_.each(i,function(r,a){var s=_.isString(r)?r:r.name;var o=t.fields[s];if(r.fields){r.fields=n._patchFields(e,t,r.fields);return}if(!_.isEmpty(o)){if(_.isString(r)){r={name:r}}if(_.isObject(r.displayParams)){_.extend(r,r.displayParams);delete r.displayParams}r.type=r.type||o.custom_type||o.type||"base";r.type=n.fieldTypeMap[r.type]||r.type;r.label=r.label||o.vname||r.name;i[a]=r}else{if(r===""){r={view:"detail"};i[a]=r}}},this);return i},_sortControllers:function(type,components,module){var updated={},nameMap={},entries={},updateWeights=function(e){var t=e.controller;if(e.type==="base"){entries["Base"+app.utils.capitalize(type)].weight=-99999}if(_.isObject(t)&&_.isString(t.extendsFrom)&&entries[t.extendsFrom]&&!updated[t.extendsFrom]){entries[t.extendsFrom].weight--;updated[t.extendsFrom]=true;updateWeights(entries[t.extendsFrom])}};_.each(components,function(entry,name){if(entry.controller){var controller=entry.controller,className=(module||"")+app.utils.capitalizeHyphenated(name)+app.utils.capitalize(type);nameMap[className]=name;if(_.isString(controller)){try{controller=eval("["+controller+"][0]")}catch(e){app.logger.error("Failed to eval view controller for "+className+": "+e+":\n"+entry.controller)}}entries[className]={type:name,controller:controller,weight:0}}});_.each(entries,function(e,t){var i=e.controller,n;if(_.isObject(i)&&_.isString(i.extendsFrom)){n="Custom"+i.extendsFrom;if(n in entries&&t!=n){i.extendsFrom=n}}});_.each(entries,function(e){updated={};updateWeights(e)});return _.sortBy(entries,"weight")},_sortAndDeclareComponents:function(e,t,i,n){var r,a=this;if(!_.isUndefined(e)&&e){r=a._sortControllers(t,e,i);if(t==="data"){var s,o;_.each(r,function(e){if(e.type==="model"){s=e.controller}else if(e.type==="collection"){o=e.controller}});app.data.declareModelClass(i,null,n,s);app.data.declareCollectionClass(i,n,o)}else{_.each(r,function(e){app.view.declareComponent(t,e.type,i,e.controller,true,n)})}}},_metaTypeIsSeparatedByPlatform:function(e,t,i){if(!_.isUndefined(e[t+"s"])){for(var n=0;n<i.length;n++){if(!_.isUndefined(e[t+"s"][i[n]])){if(_.isUndefined(e[t+"s"][i[n]].controller)){return true}}}}return false},_declareClasses:function(e){var t=this,i=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each(["field","view","layout","data"],function(n){var r;if(t._metaTypeIsSeparatedByPlatform(e,n,i)){_.each(i,function(i){r=e[n+"s"][i];t._sortAndDeclareComponents(r,n,null,i)},this)}},this);_.each(e.modules,function(e,t){_initCustomComponents.call(this,e,t)},this)},getModules:function(){return _metadata.modules},getHiddenSubpanels:function(){return _metadata.hidden_subpanels},getModule:function(e,t){var i=this.getModules();if(i)i=i[e];if(i&&t)i=i[t];return i},getRelationship:function(e){return _metadata.relationships?_metadata.relationships[e]:null},getField:function(e){var t=_metadata.fields?_metadata.fields[e]||_metadata.base:null;return t?app.metadata.copy(t,{field:e}):t},getView:function(e,t){var i=e?this.getModule(e,"views"):_metadata.views;if(t){if(i&&i[t]&&!_.isUndefined(i[t].meta)){i=i[t].meta}else if(_metadata.views&&_metadata.views[t]&&!_.isUndefined(_metadata.views[t].meta)){i=_metadata.views[t].meta}else{i=null}}return i?app.metadata.copy(i,{module:e,view:t}):i},getLayout:function(e,t){var i=this.getModule(e,"layouts");if(t){if(i&&i[t]){i=i[t].meta}else if(_metadata.layouts&&_metadata.layouts[t]){i=_metadata.layouts[t].meta}else{i=null}}return i?app.metadata.copy(i,{module:e,layout:t}):i},getModuleNames:function(e){var t=["enabled","!enabled","visible","!visible","display_tab","!display_tab","show_subpanels","!show_subpanels","quick_create","!quick_create"];arguments=Array.prototype.slice.call(arguments);if(arguments.length>=1&&!_.isObject(arguments[0])){app.logger.warn("getModuleNames no longer accepts visible and access params.");var i=_.clone(arguments);e={};if(i[0]){e.filter="display_tab"}e.access=i[1]}e=e||{};var n=[];var r=_.isUndefined(_metadata.modules_info);if(r){n=_.clone(app.user.get("module_list"));if(e.access){n=_.filter(n,function(t){return app.acl.hasAccess(e.access,t)})}return n||[]}var a,s=false;if(e.filter){if(!_.isArray(e.filter)){e.filter=[e.filter]}a=[];_.each(e.filter,function(e){if(e&&_.indexOf(t,e)>-1){a.push(e);s=e==="display_tab"}else if(e){app.logger.warn("Can't filter getModuleNames by "+e)}});if(_.isEmpty(a)){a=undefined}}n=_.chain(_metadata.modules_info).keys().without("_hash").value();if(a){_.each(a,function(t){var i=t.charAt(0)==="!";if(i){var r=app.metadata.getModuleNames({filter:t.substring(1),access:e.access});n=_.difference(n,r)}else{n=_.filter(n,function(e){return _metadata.modules_info[e][t]})}})}if(!_.isEmpty(app.user.get("module_list"))){if(s){n=_.intersection(app.user.get("module_list"),n)}else if(!a){n=_.union(app.user.get("module_list"),n)}}if(e.access){n=_.filter(n,function(t){return app.acl.hasAccess(e.access,t)})}return n},getStrings:function(e){return _metadata[e]||{}},getFullModuleList:function(){return _metadata.full_module_list||{}},getConfig:function(){return _metadata.config||{}},getBaseCurrencyId:function(){return"-99"},getCurrency:function(e){return this.getCurrencies()[e]},getCurrencies:function(){return _metadata.currencies||{}},getLogoUrl:function(){return _metadata.logo_url},getServerInfo:function(){return _metadata.server_info||{}},getModuleTabMap:function(){return _metadata.module_tab_map||{}},getTabMappedModule:function(e){var t=this.getModuleTabMap();return t[e]||e},getFilterOperators:function(e){var t=_metadata.filters&&_metadata.filters.operators&&_metadata.filters.operators.meta||{};var i=e&&this.getModule(e,"filters");var n=i&&i.operators&&i.operators.meta;if(n){return _.extend({},t,n)}return t},get:function(){return _metadata},getEditableDropdownFilter:function(e){var t=_metadata.editable_dropdown_filters;if(t&&t[e]){return app.metadata.copy(t[e])}return{}},copy:function(e,t){return app.utils.deepCopy(e)},set:function(e,t,i){_.each(e.modules,function(e,t){this._patchMetadata(t,e)},this);this._declareClasses(e);app.config=_.extend(app.config||{},e.config);app.template.set(e,e._hash&&e._hash!=this.getHash(t));if(!_.isEmpty(e._hash))_setHash(e,t);if(!i){var n=e._override_values||[];delete e._override_values;_.each(e,function(e,t){_metadata[t]=_.isObject(e)&&!_.contains(n,t)?_.extend(_metadata[t]||{},e):e})}else{_metadata=e}if(app.config.cacheMeta&&!t){_cacheMeta(_metadata)}if(app.config.env!="prod"){this._dev_data=_metadata}},getHash:function(e){var t=e?_keyPrefix+"public:hash":_keyPrefix+"hash";return app.cache.get(t)||_metadata._hash||""},sync:function(e,t){_syncing=true;t=t||{};t.params=t.params||{};var i=this,n=t.metadataTypes||(t.getPublic?app.config.publicMetadataTypes:app.config.metadataTypes)||[],r=function(n){app.logger.debug("Failed fetching metadata");if(!t.getPublic){app.error.handleHttpError(n)}e.call(i,n)},a=e;e=function(e){_syncing=false;if(_.isFunction(a))a(e)};app.api.getMetadata(i.getHash(t.getPublic),n,[],{success:function(a){var s;t=t||{};if(!_.isEmpty(a)){app.logger.debug("Updating metadata");if(_mdLoaded[t.getPublic?"public:md":"md"]&&i.getHash(t.getPublic)==a._hash&&!t.forceRefresh){app.logger.debug("Skipping update as metadata hash matches");return e.call(i)}if(_.isEmpty(n)||_.include(n,"server_info")&&!t.getPublic){s=app.isServerCompatible(a.server_info);if(s!==true){return e(s)}}_mdLoaded[t.getPublic?"public:md":"md"]=true;if(a.jssource){i._loadJSSource(a,t,e,r,i)}else{if(a.labels||a.ordered_labels){_fetchLabels(a,{language:t.language,success:function(n){_injectLabels(a,n);i.set(a,t.getPublic);e.call(i)},error:r})}else{e.call(i)}}}else{e.call(i,{code:"sync_failed",label:"ERR_SYNC_FAILED"})}},error:r},t)},isSyncing:function(){return _syncing},_loadJSSource:function(e,t,i,n,r){var a,s=this._checkJSSourceUpdated(e,!!t.getPublic);if(s==="reload"){return app.utils.hardRefresh()}else if(s){SUGAR.jssource=false;a=document.createElement("script");a.src=app.utils.buildUrl(e.jssource);document.head.appendChild(a)}async.parallel([function(e){if(s){app.utils.doWhen("SUGAR.jssource",function(){r._declareClasses(SUGAR.jssource);e()})}else{e()}},function(i){_fetchLabels(e,{language:t.language,success:function(n){_injectLabels(e,n);r.set(e,t.getPublic);i()},error:function(){n.apply(r,arguments);i()}})}],function(e,t){if(i){i.call(r)}})},_checkJSSourceUpdated:function(e,t){if(t){if(this._publicJSSourceFile){if(this._publicJSSourceFile!=e.jssource){return"reload"}return false}else{this._publicJSSourceFile=e.jssource;return true}}if(e.jssource_public&&this._publicJSSourceFile&&e.jssource_public!=this._publicJSSourceFile){app.utils.hardRefresh();return"reload"}if(this._jsSourceFile){if(this._jsSourceFile!=e.jssource){return"reload"}return false}return true},init:function(){_.bindAll(this,"storageHandler");window.addEventListener("storage",this.storageHandler);if(app.config.cacheMeta){var e=_getCachedMeta();if(e)this.set(e,false)}app.events.on("cache:clean",function(e){e([_keyPrefix+"public:hash",_keyPrefix+"hash",_keyPrefix+"data"])})},storageHandler:function(){if(!_syncing&&(this.getHash()!=_metadata._hash&&_mdLoaded["md"]||app.api.getUserprefHash()&&app.user.get("_hash")&&app.api.getUserprefHash()!=app.user.get("_hash"))){_syncing=true;_mdLoaded["md"]=false;app.sync({getPublic:!app.api.isAuthenticated()})}},clearCache:function(){app.cache.cut(_keyPrefix+"public:hash");app.cache.cut(_keyPrefix+"hash");app.cache.cut(_keyPrefix+"data")},reset:function(){_metadata={};this.clearCache()}},false)})(SUGAR.App)},331:function(e,t){(function(e){e.augment("acl",{_accessToAny:{},action2permission:{view:"read",readonly:"read",edit:"write",detail:"read",list:"read",disabled:"write"},init:function(e){if(e){e.events.on("app:sync:complete",this.clearCache,this)}},clearCache:function(){this._accessToAny={}},_hasAccess:function(e,t){var i;if(t.access==="no"){i="no"}else{i=t[e]}return i!=="no"},_hasAccessToField:function(e,t,i){var n;e=this.action2permission[e]||e;if(t.fields[i]&&t.fields[i][e]){n=t.fields[i][e]}return n!=="no"},hasAccess:function(t,i,n,r,a){var s=e.user.getAcls()[i];var o=true;

if(s||a){s=s||{};if(a){s=e.utils.deepCopy(s);s.fields=s.fields||{};_.extend(s.fields,a.fields);var l=s.fields;_.extend(s,a);s.fields=l}o=this._hasAccess(t,s);if(r&&s.fields&&o){o=this._hasAccessToField(t,s,r);var u=e.metadata.getModule(i);var f=u&&u.fields?u.fields[r]:null;if(o&&f&&f.group){o=this._hasAccessToField(t,s,f.group)}}}return o},hasAccessToModel:function(e,t,i){var n,r,a,s,o=true;if(t){n=t.id;r=t.module;a=t.original_assigned_user_id||t.get("assigned_user_id");s=t.get("_acl")||{fields:{}}}if(e=="edit"&&!n){e="create"}if(o===true){o=this.hasAccess(e,r,a,i,s)}return o},hasAccessToAny:function(t){if(_.isUndefined(this._accessToAny[t])){this._accessToAny[t]=_.some(e.user.getAcls(),function(e,i){return this.hasAccess(t,i)},this)}return this._accessToAny[t]}},true)})(SUGAR.App)},332:function(e,t){(function(e){var t=Backbone.Model.extend({load:function(t){e.api.me("read",null,null,{success:function(i){if(i&&i.current_user){if(i.current_user._hash){e.cache.set("userpref:hash",i.current_user._hash)}e.user.set(i.current_user);var n=e.user.getPreference("language");if(e.lang.getLanguage()!=n){e.lang.setLanguage(n,null,{noUserUpdate:true,noSync:e.isSynced||e.metadata.isSyncing()})}}if(t)t()},error:function(i){e.error.handleHttpError(i);if(t)t(i)}})},loadLocale:function(t){e.api.call("read",e.api.buildURL("locale"),null,{success:function(e){if(t)t(e)},error:function(i){e.error.handleHttpError(i);if(t)t(i)}})},getLanguage:function(){return e.user.getPreference("language")||e.cache.get("lang")},updateLanguage:function(t,i){var n=function(n){if(!n)e.lang.updateLanguage(t);if(i)i(n)};this.update("update",{preferred_language:t},n)},updateProfile:function(e,t){var i=function(e){if(t)t(e)};this.update("update",e,i)},updatePreferences:function(t,i){var n=this;if(e.api.isAuthenticated()){e.api.call("update",e.api.buildURL("me/preferences"),t,{success:function(r){if(r._hash){e.cache.set("userpref:hash",r._hash);e.user.set({_hash:r._hash})}_.each(t,function(e,t){if(r[t]){n.setPreference(t,r[t])}});if(i)i()},error:function(t){e.error.handleHttpError(t);if(i)i(t)}})}else{if(i)i()}},update:function(t,i,n){if(e.api.isAuthenticated()){e.api.me(t,i,null,{success:function(t){if(t.current_user){if(t.current_user._hash){e.cache.set("userpref:hash",t.current_user._hash)}e.user.set(t.current_user)}if(n)n()},error:function(t){e.error.handleHttpError(t);if(n)n(t)}})}else{n()}},getAcls:function(){return e.user.get("acl")||{}},getPreference:function(t){var i=e.user.get("preferences")||{};return i[t]},setPreference:function(t,i){var n=e.user.get("preferences")||{};n[t]=i;return e.user.set("preferences",n)},getCurrency:function(){var t=e.user.get("preferences"),i={};if(t){i.currency_id=t.currency_id;i.currency_iso=t.currency_iso;i.currency_name=t.currency_name;i.currency_rate=t.currency_rate;i.currency_show_preferred=t.currency_show_preferred;i.currency_symbol=t.currency_symbol}return i},lastState:function(){var t=":",i="last-state",n={},r=[];var a=function(n){var r=n.split(t),a=[e.user.id,i];a=a.concat(r);return a.join(t)};var s=function(e){var t;if(e.meta&&e.meta.last_state){t=e.meta.last_state.id}return t};return{get:function(t){var i,n;if(!_.isUndefined(t)){n=a(t);i=e.cache.get(n)||this.defaults(t)}return i},set:function(t,i){if(!_.isUndefined(t)&&!_.isUndefined(i)){var n=a(t);e.cache.set(n,i)}},preserve:function(e){if(!_.isUndefined(e)){r.push(e)}},key:function(e,t){var i=s(t);return this.buildKey(e,i,t.module)},buildKey:function(e,i,n){var r,a=[];if(i){if(n){a.push(n)}a.push(i,e);r=a.join(t)}return r},defaults:function(e){return n[e]},register:function(e){var t=s(e);if(t){_.each(e.meta.last_state.defaults,function(t,i){n[this.key(i,e)]=t},this)}},remove:function(t){var i;if(!_.isUndefined(t)){i=a(t);e.cache.cut(i)}},_getPreservedKeys:function(){var e=[];_.each(r,function(t){e.push(a(t))});return e}}}()});e.events.on("app:logout",function(t){if(t===true){e.user.clear({silent:true})}});e.events.on("cache:clean",function(t){t(e.user.lastState._getPreservedKeys())});e.augment("user",new t,false)})(SUGAR.App)},333:function(e,t){(function(e){e.augment("logger",{levels:{TRACE:{value:1,name:"TRACE"},DEBUG:{value:2,name:"DEBUG"},INFO:{value:3,name:"INFO"},WARN:{value:4,name:"WARN"},ERROR:{value:5,name:"ERROR"},FATAL:{value:6,name:"FATAL"}},ConsoleWriter:{write:function(t,i){if(!window.console)window.console={};if(!window.console.log)window.console.log=function(){};if(t.value<=e.logger.levels.INFO.value){console.log(i)}else if(t.value==e.logger.levels.WARN.value){console.warn(i)}else{console.error(i)}}},ServerWriter:{write:function(t,i){if(t.value<e.logger.levels.WARN.value){return}if(!e.api.isAuthenticated()){return}var n=e.config.logger&&e.config.logger.writeToServer||false;if(!n||!i.trim().length){return}var r=e.api.buildURL(undefined,"logger");var a={level:t.name.toLowerCase(),message:i};e.api.call("create",r,a,{success:function(e){if(!e.status){throw"Failed to write log message {"+i+"} onto server"}},error:function(e){throw e}})}},SimpleFormatter:{format:function(e,t,i){var n=i.getUTCFullYear()+"-"+(i.getUTCMonth()+1)+"-"+i.getUTCDate()+" "+i.getUTCHours()+":"+i.getUTCMinutes()+":"+i.getUTCSeconds();return e.name+"["+n+"]: "+t}},trace:function(e){this.log(this.levels.TRACE,e)},debug:function(e){this.log(this.levels.DEBUG,e)},info:function(e){this.log(this.levels.INFO,e)},warn:function(e){this.log(this.levels.WARN,e)},error:function(e){this.log(this.levels.ERROR,e)},fatal:function(e){this.log(this.levels.FATAL,e)},getLevel:function(){var t=e.config.logLevel;if(t){return this.levels[e.config.logLevel]}t=e.config.logger&&e.config.logger.level;t=t&&this.levels[t.toUpperCase()]||this.levels.ERROR;return t},log:function(t,i){try{var n=this.getLevel();if(t.value<n.value){return}i=i||"<none>";if(_.isFunction(i))i=i.call(this);if(_.isObject(i)){try{i=JSON.stringify(i)}catch(r){i=i.toString()}}var a=e.config.logger,s=this[e.config.logFormatter];if(!s){s=a&&this[a.formatter]||this.SimpleFormatter}i=s.format(t,i,new Date);var o=this[e.config.logWriter];if(!o){o=a&&this[a.consoleWriter]||this.ConsoleWriter}var l=a&&this[a.serverWriter]||this.ServerWriter;o.write(t,i);l.write(t,i)}catch(r){console.log("Failed to log message {"+i+"} due to exception: "+r)}}},false)})(SUGAR.App)},334:function(e,t){(function(e){var t=moment;_.extend(t,{InvalidException:function(e,t){this.name="InvalidException";this.message=e;this.date=t},_cachedFormats:{},_serverDateFormat:"YYYY-MM-DD",convertFormat:function(e){if(t._cachedFormats[e]){return t._cachedFormats[e]}var i={d:"DD",m:"MM",Y:"YYYY",H:"HH",h:"hh",i:"mm"};var n=e;_.each(i,function(e,t){n=n.replace(t,e)});t._cachedFormats[e]=n;return n},compare:function(e,i){var n=moment(e),r=moment(i);if(!n.isValid()){throw new t.InvalidException("Invalid date passed for comparison.",e)}if(!r.isValid()){throw new t.InvalidException("Invalid date passed for comparison.",i)}if(n.isBefore(r)){return-1}if(n.isAfter(r)){return 1}return 0},getUserDateFormat:function(t){t=t||e.user;return this.convertFormat(t.getPreference("datepref"))},getUserTimeFormat:function(t){t=t||e.user;return this.convertFormat(t.getPreference("timepref"))},phpStrToTime:function(e,t){var i,n,r,a,s,o,l,u,f,c,d,p=false;if(!e){return p}e=e.replace(/^\s+|\s+$/g,"").replace(/\s{2,}/g," ").replace(/[\t\r\n]/g,"").toLowerCase();n=e.match(/^(\d{1,4})([\-\.\/\:])(\d{1,2})([\-\.\/\:])(\d{1,4})(?:\s(\d{1,2}):(\d{2})?:?(\d{2})?)?(?:\s([A-Z]+)?)?$/);if(n&&n[2]===n[4]){if(n[1]>1901){switch(n[2]){case"-":{if(n[3]>12||n[5]>31){return p}return new Date(n[1],parseInt(n[3],10)-1,n[5],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}case".":{return p}case"/":{if(n[3]>12||n[5]>31){return p}return new Date(n[1],parseInt(n[3],10)-1,n[5],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}}}else if(n[5]>1901){switch(n[2]){case"-":{if(n[3]>12||n[1]>31){return p}return new Date(n[5],parseInt(n[3],10)-1,n[1],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}case".":{if(n[3]>12||n[1]>31){return p}return new Date(n[5],parseInt(n[3],10)-1,n[1],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}case"/":{if(n[1]>12||n[3]>31){return p}return new Date(n[5],parseInt(n[1],10)-1,n[3],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}}}else{switch(n[2]){case"-":{if(n[3]>12||n[5]>31||n[1]<70&&n[1]>38){return p}a=n[1]>=0&&n[1]<=38?+n[1]+2e3:n[1];return new Date(a,parseInt(n[3],10)-1,n[5],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}case".":{if(n[5]>=70){if(n[3]>12||n[1]>31){return p}return new Date(n[5],parseInt(n[3],10)-1,n[1],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}if(n[5]<60&&!n[6]){if(n[1]>23||n[3]>59){return p}r=new Date;return new Date(r.getFullYear(),r.getMonth(),r.getDate(),n[1]||0,n[3]||0,n[5]||0,n[9]||0)/1e3}return p}case"/":{if(n[1]>12||n[3]>31||n[5]<70&&n[5]>38){return p}a=n[5]>=0&&n[5]<=38?+n[5]+2e3:n[5];return new Date(a,parseInt(n[1],10)-1,n[3],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}case":":{if(n[1]>23||n[3]>59||n[5]>59){return p}r=new Date;return new Date(r.getFullYear(),r.getMonth(),r.getDate(),n[1]||0,n[3]||0,n[5]||0)/1e3}}}}if(e==="now"){return t===null||isNaN(t)?(new Date).getTime()/1e3|0:t|0}if(!isNaN(i=Date.parse(e))){return i/1e3|0}if(n=e.match(/^([0-9]{4}-[0-9]{2}-[0-9]{2})[ t]([0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]+)?)([\+-][0-9]{2}(:[0-9]{2})?|z)/)){if(n[4]=="z"){n[4]="Z"}else if(n[4].match(/^([\+-][0-9]{2})$/)){n[4]=n[4]+":00"}if(!isNaN(i=Date.parse(n[1]+"T"+n[2]+n[4]))){return i/1e3|0}}s=t?new Date(t*1e3):new Date;o={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6};l={yea:"FullYear",mon:"Month",day:"Date",hou:"Hours",min:"Minutes",sec:"Seconds"};function h(e,t,i){var n,r=o[t];if(typeof r!=="undefined"){n=r-s.getDay();if(n===0){n=7*i}else if(n>0&&e==="last"){n-=7}else if(n<0&&e==="next"){n+=7}s.setDate(s.getDate()+n)}}function _(e){var t=e.split(" "),i=t[0],n=t[1].substring(0,3),r=/\d+/.test(i),a=t[2]==="ago",o=(i==="last"?-1:1)*(a?-1:1);if(r){o*=parseInt(i,10)}if(l.hasOwnProperty(n)&&!t[1].match(/^mon(day|\.)?$/i)){return s["set"+l[n]](s["get"+l[n]]()+o)}if(n==="wee"){return s.setDate(s.getDate()+o*7)}if(i==="next"||i==="last"){h(i,n,o)}else if(!r){return false}return true}f="(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec"+"|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?"+"|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?)";c="([+-]?\\d+\\s"+f+"|"+"(last|next)\\s"+f+")(\\sago)?";n=e.match(new RegExp(c,"gi"));if(!n){return p}for(d=0,u=n.length;d<u;d++){if(!_(n[d])){return p}}return s.getTime()/1e3}});var i={};_.extend(t,{parse:function(e,t){var i=new Date("Jan 1, 1970 00:00:00"),n="",r,a,s,o,l,u;if(e instanceof Date)return e;if(!t){t=this.guessFormat(e)}if(t===false){if(/^\d+$/.test(e)){return new Date(e)}return false}r=$.trim(e);t=$.trim(t)+" ";for(a=0;a<t.length;a++){s=t.charAt(a);if(s===":"||s==="/"||s==="-"||s==="."||s===" "||s==="a"||s==="A"){o=r.indexOf(s);if(o===-1)o=r.length;l=r.substring(0,o);r=r.substring(o+1);switch(n){case"m":if(!(l>0&&l<13))return false;i.setMonth(l-1);break;case"d":if(!(l>0&&l<32))return false;i.setDate(l);break;case"Y":if(l>0===false)return false;i.setYear(l);break;case"h":u=t.substring(t.length-4);l=parseInt(l,10);var f=$.trim(u.toLowerCase());if(f==="i a"||f===s+"ia"){var c=r.substring(r.length-2).toLowerCase();if(c==="pm"){if(l<12){l+=12}}else if(c==="am"&&l===12){l=0}}i.setHours(l);break;case"H":i.setHours(l);break;case"i":l=l.substring(0,2);i.setMinutes(l);break;case"s":i.setSeconds(l);break}n=""}else{n=s}}return i},guessFormat:function(e){if(typeof e!=="string")return false;var t="",i,n,r,a,s,o,l,u;if(e.indexOf(" ")!==-1){t=e.substring(e.indexOf(" ")+1,e.length);e=e.substring(0,e.indexOf(" "))}i="/";if(e.indexOf("/")!==-1){}else if(e.indexOf("-")!==-1){i="-"}else if(e.indexOf(".")!==-1){i="."}else{return false}n=e.split(i);r="";if(n[0].length===4){r="Y"+i+"m"+i+"d"}else if(n[2].length===4){r="m"+i+"d"+i+"Y"}else{return false}a="";s=[];if(t!==""){s.push("i");o=":";if(t.indexOf(".")===2){o="."}if(t.split(o).length===3){s.push("s")}l="";u=t.substring(t.length-2,t.length);if(u.toLowerCase()==="am"||u.toLowerCase()==="pm"){s.unshift("h");if(u.toLowerCase()===u){l="lower"}else{l="upper"}}else{s.unshift("H")}a=s.join(o);if(t.indexOf(" ")!==-1){a+=" "}if(l&&l==="upper"){a+="A"}else if(l&&l==="lower"){a+="a"}r=r+" "+a}return r},parseFormat:function(e){if(!(e in i)){var t={},n,r;for(n=0;n<e.length;n++){r=e.charAt(n);switch(r){case"m":case"n":t.month=r;break;case"d":case"j":t.day=r;break;case"Y":t.year=r;break;case"H":case"h":case"g":t.hours=r;break;case"i":t.minutes=r;break;case"s":t.seconds=r;break;case"A":case"a":t.amPm=r;break;default:break}}i[e]=t}return i[e]},format:function(e,t){if(!_.isDate(e))return"";var i="",n,r,a,s,o,l;for(n=0;n<t.length;n++){r=t.charAt(n);switch(r){case"\\":i+=t.charAt(n+1);n++;break;case"m":case"n":o=e.getMonth()+1;i+=o<10&&r==="m"?"0"+o:o;break;case"d":case"j":a=e.getDate();i+=a<10&&r==="d"?"0"+a:a;break;case"Y":i+=e.getFullYear();break;case"H":case"h":case"g":s=e.getHours();if(r==="h"||r==="g"){s=s>12?s-12:s;s=s===0?12:s}i+=s<10&&r!=="g"?"0"+s:s;break;case"i":o=e.getMinutes();i+=o<10?"0"+o:o;break;case"s":l=e.getSeconds();i+=l<10?"0"+l:l;break;case"a":case"A":if(e.getHours()<12)i+=r==="a"?"am":"AM";else i+=r==="a"?"pm":"PM";break;default:i+=r}}return i},roundTime:function(e){if(!e.getMinutes)return 0;var t=e.getMinutes();if(t<1){t=0}else if(t<16){t=15}else if(t<31){t=30}else if(t<46){t=45}else{t=0;e.setHours(e.getHours()+1)}e.setMinutes(t);return e},UTCtoLocalTime:function(e){if(!(e instanceof Date))return e;return new Date(this.toUTC(e))},UTCtoTimezone:function(e,t){if(!(e instanceof Date)||undefined===t||null===t){return e}t=parseFloat(t)*60*60*1e3;t-=e.getTimezoneOffset()*60*1e3*-1;return new Date(this.toUTC(e)+t)},toUTC:function(e){if(!(e instanceof Date)){return e}var t=e.getFullYear(),i=e.getMonth(),n=e.getDate(),r=e.getHours(),a=e.getMinutes(),s=e.getSeconds(),o=e.getMilliseconds();return Date.UTC(t,i,n,r,a,s,o)},getRelativeTimeLabel:function(e){var t=new Date;var i=t.getTime()<e.getTime();var n=i?e-t:t-e;var r=1e3,a=r*60,s=a*60,o=s*24,l={str:"",value:undefined};if(isNaN(n)||n<0){return l}if(n<r*2){l.str="LBL_TIME_AGO_NOW";return l}if(n<a){l.str=i?"LBL_TIME_UNTIL_SECONDS":"LBL_TIME_AGO_SECONDS";l.value=Math.floor(n/r);return l}if(n<a*2){l.str=i?"LBL_TIME_UNTIL_MINUTE":"LBL_TIME_AGO_MINUTE";return l}if(n<s){l.str=i?"LBL_TIME_UNTIL_MINUTES":"LBL_TIME_AGO_MINUTES";l.value=Math.floor(n/a);return l}if(n<s*2){l.str=i?"LBL_TIME_UNTIL_HOUR":"LBL_TIME_AGO_HOUR";return l}if(n<o){l.str=i?"LBL_TIME_UNTIL_HOURS":"LBL_TIME_AGO_HOURS";l.value=Math.floor(n/s);return l}if(n>o&&n<o*2){l.str=i?"LBL_TIME_UNTIL_DAY":"LBL_TIME_AGO_DAY";return l}if(n<o*365){l.str=i?"LBL_TIME_UNTIL_DAYS":"LBL_TIME_AGO_DAYS";l.value=Math.floor(n/o);return l}else{l.str=i?"LBL_TIME_UNTIL_YEAR":"LBL_TIME_AGO_YEAR";return l}},parseDisplayDefault:function(e,t){var i,n,r,a,s,o,l,u,f=t?t:new Date,c,d,p,h;if(!e)return e;o=function(e,t){var i=e.getDate();e.setMonth(e.getMonth()+t);if(e.getDate()<i){e.setDate(1);e.setDate(e.getDate()-1)}return e};l=function(e){var t,i,n,r;t=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];i=f.getDay();e=e.toLowerCase();for(var n=7;n--;){if(e===t[n]){e=n<=i?n+7:n;break}}r=e-i;return r};i={day:function(e){return new Date(f.setDate(f.getDate()+e))},week:function(e){return new Date(f.setDate(f.getDate()+e*7))},month:function(e){return o(f,e)},year:function(e){return o(f,e*12)},now:function(){return f},"next monday":function(){return new Date(f.setDate(f.getDate()+l("monday")))},"next friday":function(){return new Date(f.setDate(f.getDate()+l("friday")))},"first of next month":function(){f.setDate(1);var e=f.setMonth(f.getMonth()+1);return new Date(e)}};if(e&&e.indexOf("&")>=0){r=e.split("&");a=r[0];s=r[1]}else{a=e}if(a.match(/\b(now|day|week|month|year)/g)){if(a.indexOf("now")===0){d="now"}else if(a.indexOf("first day of next month")!==-1){d="firstnextmonth"}else{p=a.split(" ");c=p[0];d=p[1]}if(d.match("now")){n=i.now()}else if(d.match("firstnextmonth")){n=i["first of next month"]()}else if(d.match("days?")){n=i.day(parseInt(c,10))}else if(d.match("weeks?")){n=i.week(parseInt(c,10))}else if(d.match("months?")){n=i.month(parseInt(c,10))}else if(d.match("years?")){n=i.year(parseInt(c,10))}else{if(!i[a]){return}n=i[a]()}}else{if(!i[a]){return}n=i[a]()}u=function(e){var t,i,n;t=/^(\d\d?).(\d{2}).?([ap]m)?$/.exec(s);if(t&&t.length>2){i=t[1];if(i){if(t[3]==="pm"){if(i<12){i=parseInt(i,10)+12}}else{if(i==="12"){i="0"}}e.setHours(parseInt(i,10))}n=t[2];if(n){e.setMinutes(parseInt(n,10))}}}(n);return n},toDatepickerFormat:function(e){if(_.isUndefined(e)||!e)return"";var t,i={y:"yy",Y:"yyyy",m:"mm",d:"dd"};t=e.replace(/[yYmd]/g,function(e){return i[e]});return t},stripIsoTimeDelimterAndTZ:function(e){if(!_.isUndefined(e)&&e){return e.replace("T"," ").substr(0,19)}},isIso:function(e){var t,i;t=e.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/);if(t){return true}if(e.match(/[T\+Z ]/g)){i=e.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])/);if(i)return true}return false},compareDates:function(i,n){e.logger.warn("date.compareDates() was called and is deprecated. "+"Please update code to use date.compare()");return t.compare(i,n)},isDateAfter:function(i,n){e.logger.warn("date.isDateAfter() was called and is deprecated. "+"Please update code to use date(date1).isAfter(date2)");return t(i).isAfter(n)},isDateBefore:function(i,n){e.logger.warn("date.isDateBefore() was called and is deprecated. "+"Please update code to use date(date1).isBefore(date2)");return t(i).isBefore(n)},isDateOn:function(i,n){e.logger.warn("date.isDateOn() was called and is deprecated. "+"Please update code to use date.isSame()");return t(i).isSame(n)},isDateBetween:function(i,n,r,a){e.logger.warn("date.isDateBetween() was called and is deprecated. "+"Please update code to use date.isBetween()");return t(i).isBetween(n,r,a)}});_.extend(t.fn,{formatUser:function(e,i){var n=t.getUserDateFormat(i);if(!e){n+=" "+t.getUserTimeFormat(i)}return this.format(n)},formatServer:function(e){var i=e&&t._serverDateFormat;return this.format(i)},isBetween:function(e,t,i){i=_.isUndefined(i)?true:i;var n=this.isAfter(e)&&this.isBefore(t);if(i&&!n){n=this.isSame(e)||this.isSame(t)}return n}});_.extend(t.duration.fn,{format:function(){var t=[],i=this.minutes(),n=this.hours(),r=Math.floor(this.asDays());if(r>0){t.push(r);t.push(e.lang.get(r===1?"LBL_DURATION_DAY":"LBL_DURATION_DAYS"))}if(n>0){t.push(n);t.push(e.lang.get(n===1?"LBL_DURATION_HOUR":"LBL_DURATION_HOURS"))}if(i>0){t.push(i);t.push(e.lang.get(i===1?"LBL_DURATION_MINUTE":"LBL_DURATION_MINUTES"))}return t.join(" ")}});e.augment("date",t)})(SUGAR.App)},335:function(e,t){(function(e){e.augment("math",{_math:function(e,t,i,n,r){n=_.isFinite(n)&&n>=0?parseInt(n):6;r=r||false;var a;var s=Math.pow(10,n);var o=parseFloat(t)*s;var l=!_.isUndefined(i)?parseFloat(i)*s:undefined;switch(e){case"round":a=Math.round(o)/s;break;case"add":a=(o+l)/s;break;case"sub":a=(o-l)/s;break;case"mul":a=this.round(o*l/s/s,n,r);break;case"div":a=this.round(o/l,n,r);break;default:return t}return r&&!_.isString(a)?a.toFixed(n):a},round:function(e,t,i){return this._math("round",e,null,t,i)},add:function(e,t,i,n){return this._math("add",e,t,i,n)},sub:function(e,t,i,n){return this._math("sub",e,t,i,n)},mul:function(e,t,i,n){return this._math("mul",e,t,i,n)},div:function(e,t,i,n){return this._math("div",e,t,i,n)},isDifferentWithPrecision:function(t,i,n){var r=e.metadata.getConfig(),a=n||e.user.getPreference("decimal_precision"),n=_.isFinite(a)?a:r.defaultCurrencySignificantDigits||2,s=this._math("round",this.getDifference(t,i,true),null,n),o=n===0?0:this._math("div",.1,Math.pow(10,n-1));return s===0?false:s>=o},getDifference:function(e,t,i){var n=this._math("sub",e,t),i=_.isUndefined(i)?false:i;return i?Math.abs(n):n}},false)})(SUGAR.App)},336:function(e,t){(function(e){e.augment("currency",{getBaseCurrencyId:function(){return e.metadata.getBaseCurrencyId()},getBaseCurrency:function(){var t=e.metadata.getBaseCurrencyId(),i=e.metadata.getCurrency(t);i.currency_id=t;return i},getCurrenciesSelector:function(t){var i={};_.each(e.metadata.getCurrencies(),function(e,n){i[n]=t(e)});return i},getCurrencySymbol:function(t){var i=e.metadata.getCurrency(t);return i?i.symbol:""},formatAmount:function(t,i,n,r,a,s){if(!_.isFinite(t)){return t}var o,l=e.metadata.getConfig();i=i||this.getBaseCurrencyId();s=s||"";if(!_.isFinite(n)){if(_.isFinite(l.defaultCurrencySignificantDigits)){n=l.defaultCurrencySignificantDigits}else{n=2}}a=a||l.defaultDecimalSeparator||".";r=!_.isUndefined(r)?r:l.defaultNumberGroupingSeparator||",";o=this.getCurrencySymbol(i)||this.getCurrencySymbol(this.getBaseCurrencyId());t=e.utils.formatNumber(t,n,n,r,a);return o+s+t},formatAmountLocale:function(t,i,n){var r=e.user.getPreference("decimal_separator");var a=e.user.getPreference("number_grouping_separator");n=_.isFinite(n)?n:e.user.getPreference("decimal_precision");return this.formatAmount(t,i,n,a,r)},unformatAmount:function(t,i,n,r){r=r||false;t=t.toString().replace(/^[^\d\.\,-]+/,"");return e.utils.unformatNumberString(t,i,n,r)},unformatAmountLocale:function(t,i){var n,r,a=e.metadata.getConfig();n=e.user.getPreference("decimal_separator")||a.defaultDecimalSeparator||".";r=e.user.getPreference("number_grouping_separator")||a.defaultNumberGroupingSeparator||",";return this.unformatAmount(t,r,n,i)},convertAmount:function(t,i,n){var r;var a;if(i==n){return e.math.round(t,undefined,true)}r=e.metadata.getCurrency(i);a=e.metadata.getCurrency(n);return this.convertWithRate(t,r.conversion_rate,a.conversion_rate)},convertToBase:function(e,t){return this.convertAmount(e,t,this.getBaseCurrencyId())},convertFromBase:function(e,t){return this.convertAmount(e,this.getBaseCurrencyId(),t)},convertWithRate:function(t,i,n){i=i||1;n=n||1;return e.math.mul(e.math.div(t,i,undefined,true),n,undefined,true)}},false)})(SUGAR.App)},337:function(e,t){(function(e){e.events.on("app:init",function(){_.mixin({isEmptyValue:function(e){return!_.isNumber(e)&&!_.isBoolean(e)&&!_.isDate(e)&&_.isEmpty(e)},changed:function(e,t){if(_.isEmpty(e)&&_.isEmpty(t)){return}var i={};var n=_.keys(_.extend(i,t,e));_.each(n,function(n){var r=false;if(!_.has(e,n)||!_.has(t,n)||!_.isEqual(e[n],t[n])){r=true}i[n]=r});return i}})})})(SUGAR.App)},338:function(e,t){(function(e){Backbone.Model.prototype.doValidate=function(e,t){t(this.isValid())};e.augment("Bean",Backbone.Model.extend({constructor:function(t,i){e.plugins.attach(this,"model");Backbone.Model.prototype.constructor.call(this,t,i)},initialize:function(t){Backbone.Model.prototype.initialize.call(this,t);this.setSyncedAttributes(t);this._bindEvents();this._relatedCollections=null;this._activeFetchRequest=null;if(this.isNew()&&this._defaults){_.each(this._defaults,function(e,t){if(!this.has(t)){this.set(t,e,{silent:true})}},this)}if(this.fields){this.fields=e.metadata.copy(this.fields,{bean:this})}this.addValidationTask("sidecar",_.bind(this._doValidate,this))},fetch:function(e){e=_.extend({},this.getOption(),e);this.abortFetchRequest();this._activeFetchRequest=Backbone.Model.prototype.fetch.call(this,e);return this._activeFetchRequest},getFetchRequest:function(){return this._activeFetchRequest},abortFetchRequest:function(){var t=this.getFetchRequest();if(t){e.api.abortRequest(t.uid)}},_bindEvents:function(){this.on("sync",function(){this.setSyncedAttributes(this.attributes);this._checkAcl()},this)},_checkAcl:function(){var e=this.get("_acl");var t=e&&e.fields||{};this._prevAcls=this._prevAcls||{};var i=_.changed(t,this._prevAcls);this._prevAcls=t;if(!i){return}var n=false;_.each(i,function(e,t){if(e){n=true;this.trigger("acl:change:"+t)}else{delete i[t]}},this);if(n){this.trigger("acl:change",i)}},dispose:function(){e.plugins.detach(this,"model")},_setRelatedCollection:function(e,t){if(!this._relatedCollections)this._relatedCollections={};this._relatedCollections[e]=t},getRelatedCollection:function(t){if(this._relatedCollections&&this._relatedCollections[t]){return this._relatedCollections[t]}return e.data.createRelatedCollection(this,t)},isValidAsync:function(e,t){e=e||this.fields;async.waterfall(_.flatten([function(t){t(null,e,{})},_.sortBy(this._validationTasks)]),function(e,i,n){if(!e){var r=_.isEmpty(n);if(_.isFunction(t)){t(r,n)}}})},doValidate:function(e,t){var i=this;this.trigger("validation:start");this.isValidAsync(e,function(e,n){if(e){i.trigger("validation:success")}i.trigger("validation:complete",i._processValidationErrors(n));if(_.isFunction(t)){t(e)}})},_doValidate:function(i,n,r){var a;_.each(i,function(i,r){if(_.isString(i)){r=i;i=this.fields[r]}a=this.get(r);if(i){t(n,e.validation.requiredValidator(i,i.name,this,a),r,"required");if(a||a===0){_.each(e.validation.validators,function(e,s){t(n,e(i,a,this),r,s)},this)}}},this);r(null,i,n)},addValidationTask:function(e,t){this._validationTasks=this._validationTasks||{};this._validationTasks[e]=t},removeValidationTask:function(e){if(this._validationTasks){this._validationTasks=_.omit(this._validationTasks,e)}},_processValidationErrors:function(t){var i=true;if(!_.isEmpty(t)){e.error.handleValidationError(this,t);_.each(t,function(e,t){this.trigger("error:validation:"+t,e)},this);this.trigger("error:validation",t);i=false}return i},save:function(e,t){var i=true,n=this;if(t&&t.fieldsToValidate){this.doValidate(t.fieldsToValidate,function(i){if(i)Backbone.Model.prototype.save.call(n,e,t)});return}return Backbone.Model.prototype.save.call(this,e,t)},canHaveAttachments:function(){return _.has(this.fields,"attachment_list")},getFiles:function(t,i){i=i||{};i.passOAuthToken=false;return e.api.file("read",{module:this.module,id:this.id},null,t,i)},copy:function(t,i,n){var r={};var a=e.metadata.getModule(this.module).fields;i=i||_.pluck(a,"name");_.each(i,function(i){var n=a[i],s;if(!n||n.duplicate_on_record_copy==="no"){return}s=n.duplicate_on_record_copy==="always"||i!=="id"&&n.type!=="link"&&!n.auto_increment;if(s&&t.has(i)){var o=t.get(i);if(_.isObject(o)){o=e.utils.deepCopy(o)}r[i]=o}});this.set(r,n);this.isCopied=true},isCopy:function(){return this.isCopied===true},uploadFile:function(t,i,n,r){n=n||{};r=r||{};return e.api.file("create",{id:r.temp!==true?this.id:"temp",module:this.module,field:t},i,n,r)},favorite:function(e,t){t=t||{};t.favorite=true;return this.save({my_favorite:!!e},t)},follow:function(e,t){t=t||{};e=e||false;t.following=true;return this.save({following:e},t)},isFavorite:function(){var e=this.get("my_favorite");return e==="1"||e===true},getChangeDiff:function(e,t){var i={};e=e||{};t=t||[];_.each(this.attributes,function(n,r){if(_.contains(t,r))return;var a=e[r];if(!_.isEqual(a,n)){i[r]=a}});return i},toJSON:function(e){var t=e&&e.fields?e.fields:_.keys(this.attributes),i={};_.each(t,function(t){var n=this.get(t);if(_.isObject(n)&&_.isFunction(n.toJSON)){n=n.toJSON(e)}i[t]=n},this);return i},toString:function(){return"bean:"+this.module+"/"+(this.id?this.id:"<no-id>")},revertAttributes:function(t){t=t||{};t.revert=true;var i=this.changedAttributes(this.getSynced());this.set(e.utils.deepCopy(i)||{},t);if(!t.silent){this.trigger("attributes:revert")}},setSyncedAttributes:function(t){this._syncedAttributes=t?e.utils.deepCopy(t):{}},getSyncedAttributes:function(){e.logger.warn("Data.Bean.getSyncedAttributes is deprecated. "+"Please update your code to use Data.Bean.getSynced");return this._syncedAttributes},getSynced:function(e){return e?this._syncedAttributes[e]:this._syncedAttributes},setDefaultAttributes:function(t){e.logger.warn("Data.Bean.setDefaultAttributes is deprecated. "+"Please update your code to use Data.Bean.setDefault");this._defaults={};this.setDefault(t)},setDefaultAttribute:function(t,i){e.logger.warn("Data.Bean.setDefaultAttribute is deprecated. "+"Please update your code to use Data.Bean.setDefault");this.setDefault(t,i)},removeDefaultAttribute:function(t){e.logger.warn("Data.Bean.removeDefaultAttribute is deprecated. "+"We consider it as a bad practice so the method will be "+"removed in 7.8. Please update your code to stop using it.");if(this._defaults){if(!this.hasOwnProperty("_defaults")){this._defaults=_.clone(this._defaults)}delete this._defaults[t]}},getDefaultAttribute:function(t){e.logger.warn("Data.Bean.getDefaultAttribute is deprecated. "+"Please update your code to use Data.Bean.getDefault");return this.getDefault(t)},getDefaultAttributes:function(){e.logger.warn("Data.Bean.getDefaultAttributes is deprecated. "+"Please update your code to use Data.Bean.getDefault");return this.getDefault()},getDefault:function(e){var t=_.clone(this._defaults)||{};if(_.isUndefined(e)){return t}return t[e]},setDefault:function(e,t){var i;if(_.isObject(e)){i=e}else{(i={})[e]=t}this._defaults=_.extend({},this._defaults,i);this.attributes=_.defaults(this.attributes,i);return this},setOption:function(e,t){var i;if(_.isObject(e)){i=e}else{(i={})[e]=t}this._persistentOptions=_.extend({},this._persistentOptions,i);return this},unsetOption:function(e){if(e){this.setOption(e,void 0)}else{this._persistentOptions={}}return this},getOption:function(e){if(e){return this._persistentOptions[e]}return this._persistentOptions}},{merge:function(e,t,i){return _.extend(e,t)}}),false);function t(e,t,i,n){if(_.isUndefined(t))return;if(_.isUndefined(e[i])){e[i]={}}e[i][n]=t}})(SUGAR.App)},339:function(e,t){(function(e){e.augment("BeanCollection",Backbone.Collection.extend({_activeFetchRequest:null,constructor:function(t,i){e.plugins.attach(this,"collection");if(i&&i.link){this.link=i.link;delete i.link}Backbone.Collection.prototype.constructor.call(this,t,i)},initialize:function(t,i){if(!_.isEmpty(i)){i=e.utils.deepCopy(i);this.setOption(i);e.logger.warn("You should not pass persistent fetch options in initialize "+"(The options hash is supposed to be Backbone.js options hash, allowing you "+"to pass Backbone options used when setting the models into the collection)."+" Please use setOption() instead.")}this._initOptions=i;this.bindCollectionEvents();Backbone.Collection.prototype.initialize.call(this,t,i);this.total=null},bindCollectionEvents:function(){this.on("data:sync:complete",function(){var e=this.getFetchRequest();if(e){this._activeFetchRequest=null}},this);this.on("remove",this._decrementTotal,this)},_decrementTotal:function(){if(this.total){this.total--}},dispose:function(){e.plugins.detach(this,"collection")},_prepareModel:function(e,t){var i=e._search;delete e._search;e=Backbone.Collection.prototype._prepareModel.call(this,e,t);if(e&&!e.link)e.link=this.link;if(i){e.searchInfo=i}return e},fetch:function(e){e=_.extend({},this.getOption(),e);this.abortFetchRequest();e.fields=this.fields=e.fields||this.fields||null;e.myItems=_.isUndefined(e.myItems)?this.myItems:e.myItems;e.favorites=_.isUndefined(e.favorites)?this.favorites:e.favorites;e.query=_.isUndefined(e.query)?this.query:e.query;this._activeFetchRequest=Backbone.Collection.prototype.fetch.call(this,e);return this.getFetchRequest()},getFetchRequest:function(){if(_.isFunction(this._activeFetchRequest)){return this._activeFetchRequest()}else{return this._activeFetchRequest}},abortFetchRequest:function(){var t=this.getFetchRequest();if(t){e.api.abortRequest(t.uid);this._activeFetchRequest=null}},resetPagination:function(){var e={offset:0,next_offset:0,page:1};var t=_.keys(e);this.resetOptions(t);var i=this.getOption();_.each(t,function(t){this[t]=i[t]||e[t]},this)},resetOptions:function(e){if(_.isEmpty(this._initOptions)&&_.isEmpty(this.getOption())){this.unsetOption()}else{_.each(e,function(e){if(!_.isUndefined(this._initOptions[e])){this.setOption(e,this._initOptions[e])}else if(!_.isEmpty(this.options)&&_.has(this.options,e)){this.unsetOption(e)}},this)}},paginate:function(t){t=t||{};var i=t.limit||e.config.maxQueryResult;t.page=t.page||1;t.page--;if(i){t.offset=this.offset+t.page*i}if(t.add){t=_.extend({update:true,remove:false},t)}this.fetch(t)},fetchTotal:function(t){t=t||{};if(!_.isNull(this.total)&&_.isFunction(t.success)){t.success.call(this,this.total);return}t.success=_.wrap(t.success,_.bind(function(e,t){this.total=parseInt(t.record_count,10);if(e&&_.isFunction(e)){
e(this.total)}},this));var i=this.module;var n=null;t.filter=t.filterDef||this.filterDef;if(this.link){n={id:this.link.bean.id,link:this.link.name};i=this.link.bean.module}var r=_.pick(t,"success","complete","error");t=_.omit(t,"success","complete","error");return e.api.count(i,n,r,t)},hasAtLeast:function(t,i){i=i||{};var n="read";i.fields=["id"];delete i.view;i.silent=true;i.success=_.wrap(i.success,_.bind(function(e,i){var n=i.records.length;var r=n>=t;var a={length:n,hasMore:i.next_offset!==-1};if(_.isFunction(e)){e(r,a)}this.reset(null,{silent:true})},this));var r=this.module;var a=null;var s="records";i.filter=i.filterDef||this.filterDef;i.limit=i.limit||t;if(this.link){a={id:this.link.bean.id,link:this.link.name};r=this.link.bean.module;s="relationships"}var o=_.pick(i,"success","complete","error");i=_.omit(i,"success","complete","error");i=e.data.parseOptionsForSync(n,this,i);return e.api[s](n,r,a,i.params,o,i.apiOptions)},getPageNumber:function(t){var i=1;var n=e.config.maxQueryResult;if(t){n=t.limit||n}if(this.offset&&n){i=Math.ceil(this.offset/n)}return i},toString:function(){return"coll:"+(this.link?this.link.bean.module+"/"+this.link.bean.id+"/":"")+this.module+"-"+this.length},getNext:function(e,t){var i=-1,n=null,r=this;if(this.hasNextModel(e)){i=this.getModelIndex(e);if(i+1>=this.length){this.paginate({add:true,success:function(e,n,a){t.apply(r,[r.at(i+1),"next"])}})}else{t.apply(r,[r.at(i+1),"next"])}}},getPrev:function(e,t){var i=-1,n=null,r=this;if(this.hasPreviousModel(e)){i=this.getModelIndex(e);n=this.at(i-1)}t.apply(r,[n,"prev"])},hasNextModel:function(e){var t=this.getModelIndex(e),i=!_.isUndefined(this.next_offset)?parseInt(this.next_offset,10):-1;return t>=0&&(this.length>t+1||i!==-1)},hasPreviousModel:function(e){return this.getModelIndex(e)>0},getModelIndex:function(e){return this.indexOf(this.get(e.id))},setOption:function(e,t){var i;if(_.isObject(e)){i=e}else{(i={})[e]=t}this._persistentOptions=_.extend({},this._persistentOptions,i);return this},unsetOption:function(e){if(e){this.setOption(e,void 0)}else{this._persistentOptions={}}return this},getOption:function(e){if(e){return this._persistentOptions[e]}return this._persistentOptions},clone:function(){var e=Backbone.Collection.prototype.clone.call(this);e.link=_.clone(this.link);e.setOption(_.clone(this.getOption()));return e}}),false)})(SUGAR.App)},340:function(e,t){(function(e){e.augment("MixedBeanCollection",e.BeanCollection.extend({_prepareModel:function(t,i){var n=t instanceof e.Bean?t.module:t._module;this.model=e.data.getBeanClass(n);return e.BeanCollection.prototype._prepareModel.call(this,t,i)},fetch:function(t){t=t||{};t.module_list=this.module_list=t.module_list||this.module_list||e.metadata.getModuleNames({filter:"visible"});return e.BeanCollection.prototype.fetch.call(this,t)},groupByModule:function(){return _.groupBy(this.models,function(e){return e.module})},toString:function(){return"mcoll:"+this.length}}),false)})(SUGAR.App)},341:function(e,t){(function(e){var t={};var i={};var n=_.extend({beanModel:e.Bean,beanCollection:e.BeanCollection,mixedBeanCollection:e.MixedBeanCollection,init:function(){var t=_.bind(this.sync,this);e.Bean.prototype.sync=t;e.BeanCollection.prototype.sync=t;e.events.register("data:sync:start",this);e.events.register("data:sync:complete",this);e.events.register("data:sync:success",this);e.events.register("data:sync:error",this);e.events.register("data:sync:abort",this)},reset:function(e){this.resetModel(e);this.resetCollection(e)},resetModel:function(e){if(e){delete t[e]}else{t={}}},resetCollection:function(e){if(e){delete i[e]}else{i={}}},declareModel:function(t,i,n,r,a){n=n||e.config.platform||"base";var s=this.declareModelClass(t,i,n,r);this.declareCollectionClass(t,n,a)},declareModelClass:function(i,n,r,a){var s=e.utils.capitalize(r);i=i||s+"Model";this.resetModel(i);var o=n?n.fields:{};var l=null;_.each(_.values(o),function(e){if(!_.isUndefined(e["default"])){if(l===null){l={}}l[e.name]=e["default"]}});var u={_defaults:l,module:i,fields:o};var f=t[s+"Model"]||t["BaseModel"]||this.beanModel;a=_.extend(a||{},u);return e.utils.extendClass(t,f,i,a,s)},declareCollectionClass:function(n,r,a){var s=e.utils.capitalize(r);var o=n||s+"Model";var l=t[o];n=n||s+"Collection";if(!l){return}this.resetCollection(n);var u={model:l,module:n,offset:0};var f=i[s+"Collection"]||i["BaseCollection"]||this.beanCollection;a=_.extend(a||{},u);return e.utils.extendClass(i,f,n,a,s)},mergeModel:function(e,i){var n=i?i.fields:{};var r=null;_.each(_.values(n),function(e){if(!_.isUndefined(e["default"])){if(r===null){r={}}r[e.name]=e["default"]}});var a={_defaults:r,module:e,fields:n};_.extend(t[e].prototype,a)},getModelClasses:function(){return t},getCollectionClasses:function(){return i},declareModels:function(i){i=i||e.metadata.getModules();_.each(i,function(e,i){if(!t[i]){this.declareModel(i,e)}else{this.mergeModel(i,e)}},this)},getBeanClass:function(e){return t[e]||Backbone.Model},createBean:function(i,n,r){return t[i]?new t[i](n,r):new e.data.beanModel(n,r)},createBeanCollection:function(t,n,r){return i[t]?new i[t](n,r):new e.data.beanCollection(n,r)},createRelatedBean:function(e,t,i,n){var r=this.getRelatedModule(e.module,i);n=n||{};if(_.isString(t)){n.id=t;t=this.createBean(r,n)}else if(_.isNull(t)){t=this.createBean(r,n)}else{t.set(n)}t.link={name:i,bean:e,isNew:true};t.setOption("relate",true);return t},createRelatedCollection:function(e,t,i){var n=this.getRelatedModule(e.module,t);var r=this.createBeanCollection(n,i,{link:{name:t,bean:e}});r.setOption("relate",true);e._setRelatedCollection(t,r);return r},createMixedBeanCollection:function(t){return new e.data.mixedBeanCollection(t)},canHaveMany:function(t,i){var n=e.metadata.getModule(t);if(!n||!n.fields||!n.fields[i]){return false}if(n.fields[i].link_type){return n.fields[i].link_type==="many"}var r=n.fields[i].relationship;var a=e.metadata.getRelationship(r);var s=a.relationship_type.split("-");var o;if(n.fields[i].side){o=n.fields[i].side==="left"?s[0]:s[2]}else if(a.lhs_module!==a.rhs_module){o=t===a.rhs_module?s[0]:s[2]}else{o=s[0]==="many"||s[2]==="many"?"many":"one"}return o==="many"},getRelateFields:function(t,i){var n=e.metadata.getModule(t);if(!n.fields[i]){return[]}var r=n.fields[i].relationship;var a=this.getRelatedModule(t,i);var s=e.metadata.getModule(a).fields;var o=_.find(s,function(e){return e.type=="link"&&e.relationship==r});if(o){o=_.filter(s,function(e){return e.type=="relate"&&e.link==o.name})}return o||[]},getRelationshipFields:function(t,i){var n=null;var r=e.metadata.getModule(t).fields[i];if(r.rel_fields){var a=r.relationship;var s=this.getRelatedModule(t,i);var o=e.metadata.getModule(s).fields;var l=_.find(o,function(e){return e.type=="link"&&e.relationship==a});if(l){l=_.find(o,function(e){return e.link==l.name&&e.link_type=="relationship_info"})}if(l&&l.relationship_fields){var u=_.keys(r.rel_fields);_.each(l.relationship_fields,function(e,t){if(_.include(u,t)){if(!n)n=[];n.push(e)}})}}return n},getRelatedModule:function(t,i){var n=e.metadata.getModule(t);if(!n||!n.fields||!n.fields[i]){return false}var r=n.fields[i]&&n.fields[i].relationship;var a=e.metadata.getRelationship(r);if(!a){return n.fields[i].module||false}return n.fields[i].module||(t===a.rhs_module?a.lhs_module:a.rhs_module)},getRelatedNameField:function(t,i){return _.find(e.metadata.getModule(t).fields,function(e){if(e.name!==i&&e.id_name===i){return e}},this)},getEditableFields:function(t,i){var n={};_.each(i,function(i){if(e.acl.hasAccessToModel("edit",t,i)){n[i]=t.get(i)}});n["id"]=t.get("id");return n},sync:function(t,i,n){e.logger.trace("data-sync-"+(n.relate?"relate-":"")+t+": "+i);n=this.parseOptionsForSync(t,i,n);var r=this.getSyncCallbacks(t,i,n),a=null;i.dataFetched=false;this.trigger("data:sync:start",t,i,n);i.trigger("data:sync:start",t,n);if(_.isFunction(n.endpoint)){n.endpoint(t,i,n,r)}else if(i.link&&i.link.bean&&n.relate===true){var s=null;if(t=="create"||t=="update"){s=this.getEditableFields(i,n.fields);if(t=="update"&&i.link.isNew){t="create"}}a=e.api.relationships(t,i.link.bean.module,{id:i.link.bean.id,link:i.link.name,relatedId:i.id,related:s},n.params,r,n.apiOptions)}else if(n.favorite){a=e.api.favorite(i.module,i.id,i.isFavorite(),r,n.apiOptions)}else if(n.following){a=e.api.follow(i.module,i.id,i.get("following"),r,n.apiOptions)}else{if(n.query||i instanceof e.MixedBeanCollection){a=e.api.search(n.params,r,n.apiOptions)}else if(i.module){a=e.api.records(t,i.module,t=="update"||t=="create"?this.getEditableFields(i,n.fields):i.attributes,n.params,r,n.apiOptions)}else{e.logger.error("Unable to sync model with no module")}}return a},parseOptionsForSync:function(t,i,n){n=n||{};n.params=_.extend({},n.params);n.filterDef=n.filter||i.filterDef;n.method=t;if(n.view&&_.isString(n.view)&&t=="read"){n.params.view=n.view}if(n.fields&&t=="read"){n.params.fields=n.fields.join(",")}if(n.viewed===true){n.params.viewed="1"}if(t=="read"&&i instanceof e.BeanCollection){if(n.offset&&n.offset!==0){n.params.offset=n.offset}if(n.limit||e.config&&e.config.maxQueryResult){n.params.max_num=n.limit||e.config.maxQueryResult}if(i.orderBy&&i.orderBy.field){n.params.order_by=i.orderBy.field+":"+i.orderBy.direction}if(n.myItems===true){n.params.my_items="1"}if(n.favorites===true){n.params.favorites="1"}if(!_.isEmpty(n.filterDef)){var r=e.utils.deepCopy(n.filterDef);if(_.has(r,"filter")){r=r.filter}if(!_.isArray(r)){r=[r]}n.params.filter=r}if(!_.isEmpty(n.query)){n.params.q=n.query;if(_.isEmpty(n.module_list)&&i.module){n.module_list=[i.module]}}if(n.module_list){n.params.module_list=n.module_list.join(",")}}if(t==="update"&&n.lastModified){n.apiOptions=n.apiOptions||{};n.apiOptions.headers=n.apiOptions.headers||{};n.apiOptions.headers["X-TIMESTAMP"]=n.lastModified}return n},getSyncCallbacks:function(e,t,i){return{success:this.getSyncSuccessCallback(e,t,i),error:this.getSyncErrorCallback(e,t,i),complete:this.getSyncCompleteCallback(e,t,i),abort:this.getSyncAbortCallback(e,t,i)}},getSyncSuccessCallback:function(t,i,n){var r=this;return function(a,s){i.inSync=true;i.original_assigned_user_id=i.get("assigned_user_id");if(t=="read"&&i instanceof e.BeanCollection){var o=n.offset||0;a=a||{};if(a.next_offset){i.offset=a.next_offset!=-1?a.next_offset:o+(a.records||[]).length;i.next_offset=a.next_offset;i.page=i.getPageNumber(n)}i.total=_.isNumber(a.total)?a.total:null;if(i instanceof e.MixedBeanCollection){i.xmod_aggs=a.xmod_aggs||null;i.tags=a.tags||null}a=a.records||[];r._updateCollectionProperties(i,n)}if(n.relate===true){i.link.isNew=false;if(t!="read"){if(i.link.bean){var l=i.link.bean.getSynced(),u=_.reduce(a.record,function(e,t,i){if(!_.isEqual(l[i],t)){e[i]=t}return e},{});i.link.bean.set(u);i.link.bean.setSyncedAttributes(a.record)}a=a.related_record;if(t=="delete"){i.set(a);delete i.link}}}i.dataFetched=true;if(n.success)n.success(i,a,n);i.trigger("sync",i,a,n,s);r.trigger("data:sync:success",t,i,n,s);i.inSync=null}},getSyncErrorCallback:function(t,i,n){return _.bind(function(r){if(r.request&&r.request.aborted){var a=this.getSyncAbortCallback(t,i,n);return a(r.request)}e.error.handleHttpError(r,i,n);this.trigger("data:sync:error",t,i,n,r);i.trigger("data:sync:error",t,n,r);if(_.isFunction(n.error)){n.error(r)}},this)},getSyncCompleteCallback:function(e,t,i){return _.bind(function(n){this.trigger("data:sync:complete",e,t,i,n);t.trigger("data:sync:complete",e,i,n);if(_.isFunction(i.complete)){i.complete(n)}i.previousModels=null;i={}},this)},getSyncAbortCallback:function(e,t,i){return _.bind(function(n){this._updateCollectionProperties(t,i);this.trigger("data:sync:abort",e,t,i,n);t.trigger("data:sync:abort",e,i,n)},this)},_updateCollectionProperties:function(e,t){t=t||{};e.myItems=t.myItems;e.favorites=t.favorites;e.query=t.query;e.modelList=t.modelList;e.filterDef=t.filterDef}},Backbone.Events);e.augment("data",n,false)})(SUGAR.App)},342:function(e,t){(function(e){e.augment("validation",{validators:function(){var t=function(e,t,i){var n=_.isUndefined(e[i])?e.validation?e.validation[i]:null:e[i];if(_.contains(["int","float","decimal","currency"],e.type)&&_.isFinite(n)){if(e.type=="int"){t=parseInt(t)}else{t=parseFloat(t)}if(i=="max"){if(t>n)return n}else if(i=="min"){if(t<n)return n}else if(i=="greaterthan"){if(t<=n)return n}else if(i=="lessthan"){if(t>=n)return n}}};var i=function(t,i,n,r){if(_.indexOf(["date","datetimecombo"],t.type)!==-1&&t.validation&&t.validation.type===n){var a=r.fields[t.validation.compareto];if(!_.isUndefined(a)&&_.indexOf(["date","datetimecombo"],a.type)!=-1){var s=Date.parse(r.get(a.name));i=Date.parse(i.toString());if(!_.isNaN(s)&&!_.isNaN(i)){var o=e.lang.get(a.label||a.vname||a.name,r.module);if(n=="isbefore"){return s<i?o:undefined}if(n=="isafter"){return s>i?o:undefined}}}}};return{maxLength:function(e,t){if(_.isNumber(t)){t=t.toString()}if(_.isNumber(e.len)&&_.isString(t)){var i=e.len;t=t||"";t=t.toString();if(t.length>i){return i}}},minLength:function(e,t){if(_.isNumber(e.minlen)){var i=e.minlen;t=t||"";t=t.toString();if(t.length<i){return i}}},url:function(e,t){},email:function(t,i){var n;if(t.type=="email"||t.type==="email-text"){if(i.length>0){_.each(i,function(i){if(i.email_address===""&&(_.isUndefined(t.required)||t.required==false)){return}if(!e.utils.isValidEmailAddress(i.email_address)){if(!n)n=[];n.push(i.email_address)}})}if(n&&n.length>0){return n}}},primaryEmail:function(e,t){if(e.type=="email"){if(t.length>0&&!_.find(t,function(e){return e.primary_address=="1"})){return true}}},duplicateEmail:function(e,t){if(e.type=="email"){var i=_.pluck(t,"email_address"),n=[],r=i.length,a,s;for(a=0;a<r;a++){for(s=a+1;s<r;s++){if(i[a]==i[s])n.push(i[a])}}if(n&&n.length>0){return n}}},datetime:function(t,i){var n,r,a,s,o,l,u,f;function c(e,t,i){var n=parseInt(e,10);return!isNaN(n)&&n>=t&&n<=i}if(t.type==="date"||t.type==="datetimecombo"){if(_.isNaN(Date.parse(i))&&_.isNaN(Date.parse(i.replace(/[\.\-]/g,"/")))){return i}else{if(!e.date.isIso(i)){l=i.replace(/[\.\-]/g,"/").split("/");r=_.filter(l,function(e,t){return e.length===3||e.length>4});if(r.length){return i}if(/([\.\/\-])\1/.test(i)===true){return i}a=e.user.getPreference("datepref");s=a.match(/[.\/\-\s].*?/);o=a.split(s);for(u=0,f=o.length;u<f;u++){n=l[u];switch(o[u].toLowerCase().charAt(0)){case"m":if(!c(n,1,12)){return i}break;case"d":if(!c(n,1,31)){return i}break}}}else{if(i.charAt(0)==="0")return i}}}},minValue:function(e,i){return t(e,i,"min")},maxValue:function(e,i){return t(e,i,"max")},greaterThan:function(e,i){return t(e,i,"greaterthan")},lessThan:function(e,i){return t(e,i,"lessthan")},number:function(e,t){if(_.indexOf(["int","float","decimal","currency"],e.type)!=-1){return _.isBoolean(t)||_.isString(t)&&t.trim().length==0||isNaN(parseFloat(t))||!_.isFinite(t)?true:undefined}},isBefore:function(e,t,n){return i(e,t,"isbefore",n)},isAfter:function(e,t,n){return i(e,t,"isafter",n)}}}(),requiredValidator:function(e,t,i,n){if(e.required===true&&t!=="id"&&e.type!=="image"&&_.isUndefined(e.auto_increment)){var r=i.get(t);var a=_.isUndefined(r);var s=_.isNull(n)||n===""||n===false||_.isArray(n)&&this._isArrayEmpty(n)||n instanceof Backbone.Collection&&n.length==0;if(a&&_.isUndefined(n)||s){return true}}},_isArrayEmpty:function(e){return _.every(e,_.isEmpty)}},false)})(SUGAR.App)},343:function(e,t){(function(e){var t="meta:hashes",i,n,r,a=["offline:enabled","offline:failure","offline:prefetch:start","offline:prefetch:complete","offline:prefetch:progress","offline:api:read:success","offline:status:update","offline:server:read","offline:data:updated","offline:data:sync:success","offline:tx:create","offline:tx:success","offline:tx:delete","offline:tx:error","offline:tx:rollback","offline:wins:completed","offline:encryption:start","offline:encryption:complete"];var s={combiners:["$or","$and"],filterKeys:{my_items:{$owner:""},favorites:{$favorite:"_this"}}};e.augment("offline",{_parsedFiltersCache:{},INITIALIZED_TS_KEY:"offline:initialized_ts",STATE:{OK:0,WARNING:1,ERROR:2},userEnabled:true,noConnection:false,status:null,init:function(){this.SYNC_ACTIONS_SYMBOLS=_.invert(this.SYNC_ACTIONS);e.events.on("app:start",function(){if(e.isSynced)this.start()},this).on("app:logout",function(){this._uninitialize()},this).on("app:sync",function(){this._uninitialize()},this)},isSupported:function(t){return e.utils.versionCompare(t.version||"",e.config.offline.minServerVersion,">=")},_registerEvents:function(){_.each(a,function(t){e.events.unregister(e,t);e.events.register(t,e)})},_initialize:function(){if(this._initialized){return}this._uninitialize();$(document).on("ajaxComplete",this._onAjaxComplete);i=e.data.beanModel;n=e.data.beanCollection;r=e.data.mixedBeanCollection;e.data.beanModel=this.declareOfflineBean();e.data.beanCollection=this.declareOfflineBeanCollection();e.data.mixedBeanCollection=this.declareOfflineMixedBeanCollection();e.data.reset();e.data.declareModels();this.storage.init(e.metadata.get());this.api.override();this.syncManager.httpErrorHandler=_.bind(e.error.handleStatusCodesFallback,e.error);this.syncManager.init();this._registerSyncExecutors();this.status={state:this.STATE.OK};this._initialized=true;e.logger.debug("Offline initialized")},_registerSyncExecutors:function(){_.each(e.config.offline.syncManager.executors,function(t,i){var n=new(e.offline[e.utils.capitalize(i)+"SyncExecutor"])(t);e.offline.syncManager.registerExecutor(n)})},_initStorage:function(){return e.offline.storage.open({env:e.config.env,name:e.config.appId,size:e.config.offline.storageSize,adapter:e.offline[e.config.offline.storageAdapter+"Adapter"]})},uninitialize:function o(t){t=t||function(){};if(!this._initialized){t();return}e.logger.debug("Offline mode disabled");this.syncManager.dispose();this.dropStorage(_.bind(function(e){this._uninitialize();t()},this))},_uninitialize:function(){if(!this._initialized){return}this.stopMonitorStatus();$(document).off("ajaxComplete",this._onAjaxComplete);e.offline.api.restore();e.data.beanModel=i;e.data.beanCollection=n;e.data.mixedBeanCollection=r;e.data.reset();e.data.declareModels();e.status=null;e.offlineEnabled=false;this._initialized=false;e.logger.debug("Offline uninitialized")},start:function(t){t=t||{};e.config.offline=_.extend({enabled:true,prefetch:{},storageSize:5,storageProvider:"sql",storageAdapter:"webSql",syncTimeout:5e3,debug:{render:false,online:true,forceMigrate:false,syncManagerEnabled:true,monitorStatus:true}},e.config.offline||{});if(e.config.offline.debug.ignoreEnabled)e.config.offlineEnabled=true;var i=this,n=this.isSupported(e.metadata.getServerInfo());e.offlineEnabled=e.config.offlineEnabled&&e.config.offline.enabled&&this.userEnabled&&n;var r=e.cache.get("offline:version");t.migrate=t.migrate||!r;this._registerEvents();var a=function(){i.startSyncManager();i.startMonitorStatus();e.logger.debug("Offline started");if(t.callback)t.callback();e.trigger("offline:enabled",true)};if(e.offlineEnabled||r&&!e.offlineEnabled){var s=this._initStorage();if(s&&!e.offlineEnabled){i.uninitialize(t.callback);return}else if(s){this._initialize();var o=[];if(t.migrate){o.push(function u(t){var i=e.utils.deepCopy(e.metadata.get());i.modules=_.omit(i.modules,e.config.offline.exclude);e.offline.upgrade(i,t)});o.push(e.offline.migrate)}var l=e.cache.get("offline:encrypted");if(e.config.offline.dbEncryptionEnabled&&!l){o.push(e.offline.encrypt)}if(o.length){async.waterfall(o,function(n){if(n){e.trigger("offline:failure",n);i.uninitialize(t.callback)}else{a()}})}else{a()}}else{e.logger.error("Storage unavailable");e.offlineEnabled=false;e.trigger("offline:failure",i.Error.StorageUnavailableError)}}if(!e.offlineEnabled){this.uninitialize(t.callback);e.trigger("offline:enabled",false)}},disable:function(t){var i=function(i){e.logger.debug("Offline stopped");e.trigger("offline:enabled",false);if(t){t(i)}};this.uninitialize(i)},dropStorage:function(i){e.logger.debug("Dropping storage");this.storage.drop(function(n){e.cache.cut("offline:version");e.cache.cut(t);e.cache.cut("offline:encrypted");if(n)e.logger.error("Failed to drop storage: "+n);if(i)i(n)})},SYNC_ACTIONS:{CREATE:1,UPDATE:2,DELETE:3,LINK:4,UNLINK:5,FAVORITE:6,FOLLOW:7},SYNC_ACTIONS_SYMBOLS:null,TRANSACTION_STATUSES:{UNRECOVERABLE:[403,405,422,500]},upgrade:function(i,n){var r=this,a=e.cache.get(t);e.logger.debug("Upgrading offline storage");e.offline.storage.upgrade(i,a,{success:function(t,i){e.logger.debug("Successfully upgraded offline storage");r.storeOfflineMeta(t);e.cache.set("offline:version",r.storage.getSqlStorageVersion());n(null,t,i)},error:function(t){e.logger.error("Failed to upgrade offline storage. "+t);n(t)}})},encrypt:function(t){if(e.offline.storage.isEncryptionSupported()){e.trigger("offline:encryption:start");_.defer(function(){e.offline.storage.encrypt(function i(){e.logger.debug("Successfully encrypted offline storage");e.trigger("offline:encryption:complete");e.cache.set("offline:encrypted",true);t()},function n(i){e.logger.error("Failed to encrypt offline storage. "+i);e.trigger("offline:encryption:complete",e.offline.Error.EncryptionFailedError);t()})})}else{t()}},migrate:function(t,i,n){var r=[],a=!e.config.offline.debug.forceMigrate&&i&&i._hash===t._hash&&i._userId===e.user.get("id")&&i.siteUrl===e.utils.stripHttpPrefix(e.config.siteUrl);var s=function(t){if(!t){e.logger.debug("Successfully migrated offline storage")}else{t.label=e.lang.get("ERR_OFFLINE_STORAGE_CREATE");e.logger.error("Failed to migrate offline storage. "+t)}n(t)};e.offline.storage.resetMigrationSummary();if(!a){e.logger.debug("Migrating offline storage");r=[function o(t){e.offline.utils.getServerTime(function(i,n){if(i){e.logger.error("Failed to get server time: "+i);i=new e.offline.Error("server_time_unavailable","Failed to retrieve server time","ERR_OFFLINE_SERVERTIME_UNAVAILABLE",i);t(i)}else{e.cache.set(e.offline.INITIALIZED_TS_KEY,n);t()}})},function l(n){e.offline.storage.migrate(t,i,{forceDrop:e.config.offline.debug.forceMigrate,success:n,error:n})}];async.series(r,s)}else{s()}},compactStorage:function(t){e.offline.storage.compact(t)},clearStorage:function(t){e.offline.storage.migrate(e.metadata.get(),null,{forceDrop:true,success:t.callback,error:t.callback})},storeOfflineMeta:function(i){var n={};n._hash=i._hash;n._userId=e.user.id;n.relationships={_hash:i.relationships._hash};n.siteUrl=e.utils.stripHttpPrefix(e.config.siteUrl);n.modules={};_.chain(i.modules).omit(e.config.offline.exclude).each(function(e,t){if(e._hash){n.modules[t]={_hash:e._hash,fields:{_hash:e.fields._hash}};_.each(e.fields,function(e,i){if(i==="_hash"){return}n.modules[t].fields[i]={type:e.type,name:e.name}})}});e.cache.set(t,n)},isOnline:function(){return e.config.offline.debug.online&&window.navigator.onLine},isOfflineEnabled:function(t){return(e.config.offline.exclude||[]).indexOf(t)===-1},startSyncManager:function(){if(e.config.offline.enabled&&!e.offline.syncManager.isStarted&&e.api.isAuthenticated()){e.offline.syncManager.start()}},stopSyncManager:function(){e.offline.syncManager.stop()},startMonitorStatus:function(){if(this._monitorIntervalId||!e.config.offline.debug.monitorStatus)return;var t=this,i=function(){async.parallel({transactions:function(i){t.storage.exec([{op:"countTransactions"}],function(e){i(null,e)},function n(t){e.logger.error("Failed to count transactions: "+t);i(t)})},isOutOfSpace:function(e){t.storage.isOutOfSpace(function(t){e(null,t)})}},function(i,n){var r=n.transactions||{};r.noConnection=t.noConnection||!t.isOnline();r.isSyncing=t.syncManager.isSyncing();r.lastSyncTs=t.syncManager.lastSyncTs;r.isOutOfSpace=n.isOutOfSpace;if(r.failedTransactions>0||r.isOutOfSpace){r.state=t.STATE.ERROR}else if(r.noConnection||r.totalTransactions>0){r.state=t.STATE.WARNING}else{r.state=t.STATE.OK}t.status=r;e.trigger("offline:status:update",r)})};i();this._monitorIntervalId=window.setInterval(i,e.config.offline.monitorTimeout||1e4)},stopMonitorStatus:function(){window.clearInterval(this._monitorIntervalId);this._monitorIntervalId=null},_onAjaxComplete:function(t,i){e.offline.noConnection=!i.aborted&&!i.status},convertReadRecordsFilter:function(t,i){var n=[];var r=t.filter?t.filter:[];var a,o,l,u;_.each(s.filterKeys,function(e,i){if(!_.isUndefined(t[i])){n.push(e)}});if(_.isEmpty(r)&&_.isEmpty(n)){return}a=!_.isEmpty(n)||!_.find(s.combiners,function(e){return r[0][e]});if(a){r=[{$and:_.union(r,n)}]}o=JSON.stringify({module:i,filter:r});if(this._parsedFiltersCache[o]){return this._parsedFiltersCache[o]}l=this._convertFilterRecursive(r,[]);if(!l){this._parsedFiltersCache[o]={isSupported:false};return this._parsedFiltersCache[o]}u=e.offline.storage.convertFilter(i,l)||{};this._parsedFiltersCache[o]={filter:l,filterFields:u.fields,filterSql:u.sql,isSupported:!!u.sql};return this._parsedFiltersCache[o]},_convertFilterRecursive:function l(e,t){if(_.isArray(e)){_.each(e,function(e){l(e,t)})}else if(_.isObject(e)){_.each(e,function(e,i){if(_.contains(s.combiners,i)){var n=[];t.push({operator:i,filters:n});l(e,n)}else{if(_.isObject(e)){_.each(e,function(e,n){t.push({field:i,condition:n,value:e})})}else{t.push({field:i,value:e,condition:"$equals"})}}})}return t.length?t:null},Error:function(e,t,i,n,r){this.code=e;this.message=t;this.label=i;this.err=n;this.sqlInfo=r}},false);_.extend(e.offline.Error.prototype,{localizedMessage:function(){var t;try{t=e.lang.get(this.label||"ERR_OFFLINE")}catch(i){t="Offline Error";e.logger.fatal("Failed to localize offline error. "+i)}return t},toString:function(){var t=this.localizedMessage()+": ("+this.code+") "+this.message;if(this.err){var i;try{i=JSON.stringify(this.err)}catch(n){i=this.err.toString()}t+="\nOriginal error: "+i}if(this.sqlInfo){var r=/\\\"/g,a,s;if(e.config.env==="dev"){a=this.sqlInfo.failedSql;s=this.sqlInfo.transactionSql}else{a=this.sqlInfo.failedSql.sql;s=_.map(this.sqlInfo.transactionSql,function(e){return{module:e.module,sql:_.map(e.sql,function(e){return{sql:e.sql}})}})}t+=". Failed SQL: "+JSON.stringify(a).replace(r,'"');t+=". All SQL in transaction: "+JSON.stringify(s).replace(r,'"')}return t}});_.extend(e.offline.Error,{OfflineDisabledError:new e.offline.Error("offline_disabled","Offline Mode is disabled","Offline is not initialized"),OutOfSpaceError:new e.offline.Error("out_of_space","Out of space","ERR_OFFLINE_OUT_OF_SPACE"),StorageUnavailableError:new e.offline.Error("storage_unavailable","Failed to open db","ERR_OFFLINE_STORAGE_UNAVAILABLE"),EncryptionFailedError:new e.offline.Error("encryption_failed","Failed to encrypt local storage.","ERR_OFFLINE_ENCRYPTION_FAILED"),UnknownError:new e.offline.Error("unknown","Unknown error")})})(SUGAR.App)},344:function(e,t){(function(e){e.offline.utils={notImplemented:function(){throw new Error("Not implemented. Please override this method with your implementation")},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,i=e=="x"?t:t&3|8;return i.toString(16)})},isDataSynchronized:function(t){if(t instanceof e.Bean){return t.get("_client_date_modified")===t.get("date_modified")}else if(_.isObject(t)){return t._client_date_modified&&t.date_modified&&t._client_date_modified===t.date_modified}else return false},prepareHighlightQuery:function(e){var t="(\\*|\\%)+";e=e?e.trim().replace(/[-\[\]{}()+.,\\\^$|#\s]/g,"\\$&").replace(new RegExp("(^"+t+")|("+t+"$)","g"),"").replace(/%|\*/g,".*").replace(/_|\?/g,"."):"";return e},prepareQuery:function(e){e=e?e.trim().replace(/[-\[\]{}()+.,\\\^$|#\s]/g,"\\$&").replace(/%|\*/g,".*").replace(/_|\?/g,"."):"";return"^"+e},checkIsEmptyQuery:function(e){e=e?e:"";e=e.replace(/%|\*/g,"").replace(/_|\?/g,"");e=e.trim();return _.isEmpty(e)},compileHighlightRegExp:function(e){e=this.prepareHighlightQuery(e);return new RegExp("([^\\s:-;,><]*"+e+"[^\\s:-;,><]*)","i")},compileSearchRegExp:function(e){return new RegExp(this.prepareQuery(e))},actionToSymbol:function(t){var i=t._tx_action||t.action,n=t._tx_related_id||t.relate;return e.offline.SYNC_ACTIONS_SYMBOLS[i]+(n?"_RELATED":"")},getTxAge:function(e){return parseInt((new Date-new Date(e._tx_ts))/1e3,10)},getCleanedParams:function(e){return _.omit(e,["changedFields","skipServerSync","skipOfflineRead","serverSyncSuccess","deferSync","initialState","forceServerSync","relate"])},actionToString:function(t){if(t===e.offline.SYNC_ACTIONS.CREATE){return"createSingle"}else if(t===e.offline.SYNC_ACTIONS.UPDATE||t===e.offline.SYNC_ACTIONS.LINK){return"updateValuesSingle"}else if(t===e.offline.SYNC_ACTIONS.DELETE||t===e.offline.SYNC_ACTIONS.UNLINK){return"hardDeleteSingle"}else if(t===e.offline.SYNC_ACTIONS.FAVORITE||t===e.offline.SYNC_ACTIONS.FOLLOW){return"updateValuesSingle"}else{throw new Error("Invalid action")}},isRecordAssignedToLoginUser:function(t){return t.assigned_user_id&&t.assigned_user_id===e.user.id},getOfflineModules:function(){return _.filter(_.keys(e.metadata.get().modules),function(t){return e.offline.isOfflineEnabled(t)})},getBeforeAndAfter:function(e,t){t=t||{};var i={};_.each(e,function(e,n){if(n==="_client_date_modified"||n==="id"||e===t[n]){return}i[n]={after:e,before:t[n]?t[n]:null}},this);return _.isEmpty(i)?null:i},getInitialState:function(e,t){var i=JSON.parse(e._tx_updated_fields);_.each(i,function(e,i){if(i==="email"){return}t[i]=e.before});return t},fetchPageByPage:function(t,i,n,r,a){var s=a.maxRecords||20,o=a.pageSize||20;r=r||0;_.extend(i,{offset:i.offset||0,max_num:o,order_by:i.order_by||"date_modified:DESC"});e.offline.api.callOriginalApi("records",["read",t,null,i,{success:function(l){if(_.isEmpty(l.records)){return a.callback()}n({module:t,records:l.records,callback:function(u){if(u){return a.callback(u)}var f=r>=s;r+=o;i.offset+=o;if(a.iterator){a.iterator(f?s:r)}if(f||l.next_offset===-1){a.callback()}else{e.offline.utils.fetchPageByPage.call(e.offline.utils,t,i,n,r,a)}}})},error:a.callback}])},ping:function(t){var i=+new Date;e.offline.api.callOriginalApi("ping",[null,{success:function(){var e=new Date-i;t(null,e)},error:function(e){t(e)}}])},getServerTime:function(t){e.offline.api.callOriginalApi("ping",["whattimeisit",{success:function(e){t(null,e)},error:t},{skipMetadataHash:true}])},shouldUpdateLastViewedDate:function(e){return e&&e.viewed},callOnce:function(e){var t={success:false,error:false,complete:false};_.each(e,function(i,n){e[n]=function(){if(t[n]){return}t[n]=true;i.apply(this,arguments);i=null}})},paginate:function(e,t){var i=0,n,r=[];if(_.isEmpty(e)){return r}function a(e,i){var n=i*t,r=(i+1)*t;return e.slice(n,r)}n=a(e,i);while(!_.isEmpty(n)){r.push(n);n=a(e,++i)}return r},getStoppableAsyncFlow:function(t,i,n){var r=false,a;a=_.map(i,function(t){return function i(){if(r){e.logger.debug("Async flow interrupted");n()}else{t.apply(null,arguments)}}});async[t](a,n);return function s(){r=true}}}})(SUGAR.App)},345:function(e,t){(function(e){e.offline.syncManager={httpErrorHandler:null,lastSyncTs:null,syncExecutors:[],_currentExecutor:null,start:function(){this.intervalId=window.setInterval(this._runSyncIteration,e.config.offline.syncManager.syncTimeout*1e3||1e4)},stop:function(){window.clearInterval(this.intervalId)},dispose:function(){e.events.off("offline:data:sync:success",null,this);this.syncExecutors=[];this.stop()},init:function(){this.dispose();e.events.on("offline:data:sync:success",function(){this._runSyncIteration()},this)},registerExecutor:function(e){t.syncExecutors.push(e);t.syncExecutors=_.sortBy(t.syncExecutors,function(e){return e.getPriority()})},isSyncing:function(){var e=false;_.each(t.syncExecutors,function(t){e=e||t.isWorking()});return e},_syncErrorHandler:function(i){if(i instanceof SUGAR.Api.HttpError){if(e.utils.isConnectivityError(i)){return}else if(i.status===412&&t.httpErrorHandler){t.stop();t.httpErrorHandler(i)}else{e.logger.error(i)}}else if(i instanceof e.offline.Error){t.stop();var n=i===e.offline.Error.OfflineDisabledError?i:new e.offline.Error("synchronization_error","Synchronization failed","ERR_OFFLINE_SYNC_ERROR",i);e.trigger("offline:failure",n);e.logger.error(i)}else if(i){e.logger.error(i);

}},_runSyncIteration:function(i){if(!e.offline.isOnline()||!e.config.offline.debug.syncManagerEnabled||!e.config.offline.syncManager.enabled||_.isEmpty(t.syncExecutors)){if(i)i();return}var n=[];_.each(t.syncExecutors,function(e){n.push(function(){t._currentExecutor=e;e.sync.apply(e,arguments)})});async.series(n,function(e){t._currentExecutor=null;t.lastSyncTs=new Date;t._syncErrorHandler(e);if(i)i(e)})},sync:function(t){if(e.offlineEnabled){this._runSyncIteration(t)}},startRecordsPreloader:function(e){e=e||{};t.stop();if(t._currentExecutor){t._currentExecutor.stop()}var i=e.callback;t.recordsPreloader.start(_.extend(e,{callback:function(e){t.start();if(i)i(e)}}))}};var t=e.offline.syncManager})(SUGAR.App)},346:function(e,t){(function(e){var t;e.offline.api={originalMethods:{},NO_CONNECTION_ERROR:{status:0,textStatus:"error",toString:function(){return"No internet connection"}},SERVER_READ_STATUS:{start:1,finish:2,error:3},override:function(){_.extend(this.originalMethods,{records:e.api.records,relationships:e.api.relationships,favorite:e.api.favorite,follow:e.api.follow,search:e.api.search,file:e.api.file});_.extend(e.api,{records:this.records,relationships:this.relationships,favorite:this.favorite,follow:this.follow,search:this.search,file:this.file})},restore:function(){if(_.isEmpty(this.originalMethods))return;_.extend(e.api,{records:this.originalMethods["records"],relationships:this.originalMethods["relationships"],favorite:this.originalMethods["favorite"],follow:this.originalMethods["follow"],search:this.originalMethods["search"],file:this.originalMethods["file"]});this.originalMethods={}},records:function(i,n,r,a,s,o){if(e.offline.isOfflineEnabled(n)||_.contains(e.config.offline.customOfflineModules||[],n)){return t._executeOfflineApi(i,n,r,a,s,t.originalMethods["records"],o)}else{return t.originalMethods["records"].call(e.api,i,n,r,e.offline.utils.getCleanedParams(a),s,o)}},relationships:function(i,n,r,a,s,o){var l=e.data.getRelatedModule(n,r.link);if(e.offline.isOfflineEnabled(n)&&e.offline.isOfflineEnabled(l)){a.relate=true;r.relatedModule=l;return t._executeOfflineApi(i,n,r,a,s,t.originalMethods["relationships"],o)}else{return t.originalMethods["relationships"].call(e.api,i,n,r,e.offline.utils.getCleanedParams(a),s,o)}},favorite:function(i,n,r,a,s){s=s||{};if(e.offline.isOfflineEnabled(i)){return t._executeOfflineApi("favorite",i,{id:n,my_favorite:r},s,a,t.originalMethods["favorite"])}else{return t.originalMethods["favorite"].apply(e.api,arguments)}},follow:function(i,n,r,a,s){s=s||{};if(e.offline.isOfflineEnabled(i)){return t._executeOfflineApi("follow",i,{id:n,following:r},s,a,t.originalMethods["follow"])}else{return t.originalMethods["follow"].apply(e.api,arguments)}},search:function(e,i,n){return t._executeOfflineApi("search",null,null,e,i,null,n)},file:function(i,n,r,a,s){var o=a.success,l=n.module;if(_.contains(["create","delete"],i)){a.success=function(t,i,r){var a={id:n.id};a[n.field]=_.isEmpty(t.record)?"":t.record[n.field];e.offline.storage.saveRecords({serverData:a,module:l,ignoreRecordDirtiness:true,callback:_.bind(o,e.api,t,i,r)})}}return t.originalMethods["file"].apply(e.api,arguments)},callOriginalApi:function(i,n){var r,a,s,o,l={search:1,ping:1,follow:3,favorite:3,file:3,records:4,relationships:4};if(_.isString(i)){if(i==="read"){r=e.api.call;a=n[3]}else{r=t.originalMethods[i]||e.api[i];a=n[l[i]]}}else{r=i;_.find(t.originalMethods,function(e,t){if(e===i){a=n[l[t]];return true}})}o=_.last(n)||{};var u=a["error"],f=function(){e.logger.debug("Original API callback suppressed. Offline layer is not initialized")},c=o.catchServerRequest||function(){};if(!e.offlineEnabled){return u?u.call(this,e.offline.Error.OfflineDisabledError):f()}_.each(a,function(t,i){if(_.isFunction(t)){a[i]=function(){c(null);if(!e.offlineEnabled){return u?u.call(this,e.offline.Error.OfflineDisabledError):f()}else{t.apply(this,arguments)}}}});s=r.apply(e.api,n);c(s)},_executeOfflineApi:function(e,t,i,n,r,a,s){s=s||{};var o,l={method:e,module:t,data:i,params:n,callbacks:r,originalApi:a,options:s};s.catchServerRequest=function(e){o=e};function u(){return o}switch(e){case"search":this.readMixedCollection(l);break;case"read":var f=i&&i.link?i.relatedId:i?i.id:null,c=f?this.readSingle:this.readCollection;c.call(this,l);break;default:this.createUpdateDelete(l)}return u}};t=e.offline.api})(SUGAR.App)},347:function(e,t){(function(e){var t={readSingle:function i(t){var i={"offline:api:read:success":{}},n=false,r=t.method,a=t.module,s=t.data,o=t.params,l=t.callbacks,u=t.options;function f(){if(l.error)l.error({status:404})}e.offline.utils.callOnce(l);function c(){e.offline.storage.sync("read",s,a,_.extend({},o,{ts:e.utils.getTimestamp(),success:function(t){var i=!o.skipServerSync&&e.offline.isOnline();if(t){if(l.success){l.success(t);n=true}i=i&&e.offline.utils.isDataSynchronized(t)}else if(!i){f()}if(i){d(t)}else{p()}},error:function(e){if(l.error)l.error(e);h(e)},complete:l.complete}))}function d(t){var f=o.relate?"relationships":"records";e.offline.api.callOriginalApi(f,[r,a,s,e.offline.utils.getCleanedParams(o),{success:function(u){e.offline.api.cacheRequest(r,a,s,o);e.offline.storage.saveRecords({serverData:u,module:a,relationshipData:o.relate?s:null,callback:function(r){if(!r){if(!n&&l.success){l.success(u)}i["offline:data:updated"]={isCollection:false,action:t?"update":"create",id:s.id,date_modified:e.utils.getTimestamp(u.date_modified)};p()}else{h(r)}}})},error:function(t){if(l.error)l.error(t);if(t===e.offline.Error.OfflineDisabledError){return}var n=o.relate?s.relatedModule:a,r=o.relate?s.relatedId:s.id;switch(t.status){case 412:return;case 403:case 404:i["offline:data:updated"]={isCollection:false,action:"delete",status:t.status,module:n,data:s,id:s.id}}var u=o.relate?{module:a,data:s,relate:o.relate}:{module:n,id:r,relate:o.relate};e.offline.storage.resolveError({nonTransactionResolve:u,error:t,callback:function(e){if(e){h(e)}else{p()}}})}},u])}function p(){e.logger.debug("readSyncSingle success");_.each(i,function(t,i){e.trigger(i,t)})}function h(t){e.logger.error("readSyncSingle failed. "+t)}c()}};_.extend(e.offline.api,{readSingle:_.bind(t.readSingle,t),_readSingleScope:t})})(SUGAR.App)},348:function(e,t){(function(e){var t={readCollection:function i(t){var i=t.method,n=t.module,r=t.data,a=r&&r.relatedModule||n,s=t.params,o=t.callbacks,l=t.options,u=[],f;e.offline.utils.callOnce(o);if(n==="Recents"){e.offline.utils.callOnce(o);return this._readRecentsCollection(i,n,r,s,o,l)}if(n==="TxLog"){s.skipServerSync=true}if(!s.skipOfflineRead){f=this._getOfflineReadParams(a,s);if(!f.skipOfflineRead){u.push(_.bind(function d(e){this._offlineRead(e,i,n,r,f,o,l)},this))}}if(e.offline.isOnline()){if(!s.skipServerSync){u.push(_.bind(function(e){if(s.filter&&f&&!f.skipOfflineRead){s.fields=_.union(s.fields?s.fields.split(","):[],f.filterParsed.filterFields).join()}this._serverRead(e,i,n,r,s,o,l)},this))}}else{if(o.error){var c=_.extend({},e.offline.api.NO_CONNECTION_ERROR,{request:{params:l}});o.error(c)}}async.waterfall(u,_.bind(function p(e,t){this._onReadCollectionComplete(e,t,o)},this))},_offlineRead:function(t,i,n,r,a,s,o){e.offline.storage.sync("read",r,n,_.extend({},a,{ts:e.utils.getTimestamp(),success:function l(i){var r;i=i||[];i=!_.isArray(i)?[i]:i;if(n==="TxLog"){var o;o=i.pop().totalTransactions;i=_.map(i,function(e){e.id=e._tx_uid;return e});var l=(a.offset||0)+i.length;r=o>l?l:-1;e.offline.storage.fillTxLogData(i,function(){s.success({records:i,next_offset:r})})}else{r=a.max_num>i.length||a.serverNextOffset===-1?-1:(a.offset||0)+i.length;var u={records:i,next_offset:r};if(s.success)s.success(u)}t()},error:function(e){if(s.error)s.error(e);t(e)},complete:s.complete}))},_getOfflineReadParams:function n(t,i){var n=e.utils.deepCopy(i),r,a,s,o;s=e.offline.convertReadRecordsFilter(n,t);if(s){if(s.isSupported){n.filterParsed=s}else{n.skipOfflineRead=true}}if(n.order_by){r=n.order_by.split(":")[0];a=n.order_by.split(":")[1];if(r==="email"){n.order_by=["email1",a].join(":")}else if(r==="name"){o=e.metadata.getModule(t,"fields").name;if(o.group){n.order_by=[o.group,a].join(":")}}}return n},_serverRead:function(t,i,n,r,a,s,o){var l=a.relate?"relationships":"records";var u=e.offline.api.SERVER_READ_STATUS;var f=false;var c=false;e.trigger("offline:server:read",{status:u.start,apiOptions:o});e.offline.api.callOriginalApi(l,[i,n,r,e.offline.utils.getCleanedParams(a),{success:function(l){e.offline.api.cacheRequest(i,n,r,a);if(s.success)s.success(l);l=l||{};if(a.serverSyncSuccess&&l.records){a.serverSyncSuccess({records:l.records,next_offset:l.next_offset},a)}if(!_.isEmpty(l.records)){f=true;e.offline.storage.saveRecords({module:n,serverData:l.records,relationshipData:a.relate?r:null,callback:function(i){t(i,l);if(!i&&!a.skipOfflineRead){e.trigger("offline:data:updated",{isCollection:true,action:"update",module:n,relationsData:r,serverNextOffset:l.next_offset,requestParams:a,cid:o.cid})}}})}else{t(null,l)}},error:function(e){c=true;if(s.error)s.error(e);t(e)},complete:function(){e.trigger("offline:server:read",{status:c?u.error:u.finish,apiOptions:o,dataUpdated:f});if(s.complete){s.complete(arguments)}}},o])},_onReadCollectionComplete:function(t,i,n){if(t){if(n.error){n.error(t)}if(t instanceof e.offline.Error&&t!==e.offline.Error.OfflineDisabledError){e.logger.error("readSyncCollection failed. "+t)}}else{e.logger.debug("readSyncCollection success");e.trigger("offline:api:read:success")}if(n.complete){n.complete(i)}},_readRecentsCollection:function r(t,i,n,a,s,o){var l=this;async.waterfall([function u(t){var i=e.offline.utils.getOfflineModules(),n=a.module_list?a.module_list.split(","):i,r=_.chain(i).without("Teams").intersection(n).value(),o=_.map(r,function(t){return{op:"readRecents",module:t,options:{max_num:e.config.fetchLimit.recents}}});var l=function(e,i){s.complete(e||i);t(e,i)};e.offline.storage.exec(o,function(e){if(!e){e=[]}else if(!_.isArray(e)){e=[e]}e=_.sortBy(e,function(e){return-new Date(e._last_viewed_date)});s.success({records:e,next_offset:-1});l(null,e)},l)},function f(n,r){if(!e.offline.isOnline()||a.skipServerSync){r();return}var s=e.offline.api.SERVER_READ_STATUS;var l=false;var u=false;a=e.offline.utils.getCleanedParams(a);a.module_list=_.intersection(a.module_list.split(","),e.offline.utils.getOfflineModules()).join(",");e.trigger("offline:server:read",{status:s.start,apiOptions:o});e.offline.api.callOriginalApi("records",[t,i,null,a,{success:function(t){if(!_.isEmpty(t.records)){var i=t.records,n=[];l=true;n.push(function(i){e.offline.storage.saveRecords({serverData:t.records,callback:i})});n.push(function(n){e.offline.storage.exec([{op:"readLastViewed",options:{ids:_.pluck(t.records,"id")}}],function(e){if(e){if(!_.isArray(e)){e=[e]}i=_.reject(i,function t(i){var n=_.findWhere(e,{bean_id:i.id});return n&&new Date(n.date_last_viewed)-0>new Date(i._last_viewed_date)-0})}n()},n)});async.series(n,function a(t,n){if(!t){e.offline.storage.exec(_.map(i,function(t){return{op:"updateLastViewed",data:t,module:t._module,options:{ts:e.utils.getTimestamp(t._last_viewed_date)}}}),function a(){e.trigger("offline:data:updated",{isCollection:true,action:"update",module:"Recents",cid:o.cid});r()},r)}r(t)})}else{r()}},error:function(e){u=true;r(e)},complete:function(){e.trigger("offline:server:read",{status:u?s.error:s.finish,apiOptions:o,dataUpdated:l})}},o])}],function(e,t){l._onReadCollectionComplete(e,t,s)})}};_.extend(e.offline.api,{readCollection:_.bind(t.readCollection,t),_readCollectionScope:t})})(SUGAR.App)},349:function(e,t){(function(e){var t={readMixedCollection:function i(t){var i=t.method,n=t.data,r=t.params,a=t.callbacks,s=t.options,o=[];e.offline.utils.callOnce(a);if(!r.skipOfflineRead){o.push(_.bind(function u(e){this._offlineRead(e,i,n,r,a,s)},this))}if(e.offline.isOnline()){if(!r.skipServerSync){o.push(_.bind(function f(e){this._serverRead(e,i,n,r,a,s)},this))}}else{if(a.error){var l=_.extend({},e.offline.api.NO_CONNECTION_ERROR,{request:{params:s}});a.error(l)}}async.waterfall(o,_.bind(function c(e,t){this._onReadCollectionComplete(e,t,a)},this))},_offlineRead:function n(t,i,r,a,s,o){e.offline.storage.sync("search",null,null,_.extend({},a,{ts:e.utils.getTimestamp(),success:function l(i){var n=a.module_list&&a.module_list.split(",").length>1,r,o,l,u={};i=i||[];i=!_.isArray(i)?[i]:i;if(!e.offline.utils.checkIsEmptyQuery(a.q)){o=e.offline.utils.compileSearchRegExp(a.q);l=e.offline.utils.compileHighlightRegExp(a.q);_.each(a.module_list.split(","),function(t){u[t]=e.metadata.getModule(t).fields});_.each(i,function(t){r=t._module||t.module;t._search={isOffline:true};_.each(e.offline.storage.offlineMeta[r].searchFields,function(e){var i=e.name,n=t[i];if((_.isString(n)||_.isNumber(n))&&o.test(n)){t._search.highlighted=t._search.highlighted||{};t._search.highlighted[i]={module:r,text:n.toString().replace(l,"<strong>$1</strong>"),label:u[r][i].vname}}})})}if(n){i=_.sortBy(i,function(e){return e._client_date_modified}).reverse()}if(n){var f=a.max_num||e.config.maxQueryResult;i=i.splice(a.offset||0,f)}var c=a.max_num>i.length?-1:(a.offset||0)+i.length;var d={records:i,next_offset:c};if(s.success)s.success(d);t()},error:function(e){if(s.error)s.error(e);t(e)},complete:s.complete}))},_serverRead:function(t,i,n,r,a,s){var o=false;var l=false;var u=e.offline.api.SERVER_READ_STATUS;e.trigger("offline:server:read",{status:u.start,apiOptions:s});e.offline.api.callOriginalApi(i,[e.offline.utils.getCleanedParams(r),{success:function(i){if(a.success)a.success(i);i=i||{};if(r.serverSyncSuccess&&i.records){r.serverSyncSuccess({records:i.records,next_offset:i.next_offset},r)}if(!_.isEmpty(i.records)){o=true;e.offline.storage.saveRecords({serverData:i.records,callback:function(i){t(i);if(!i&&!r.skipOfflineRead){e.trigger("offline:data:updated",{isCollection:true,action:"update",mixedCollection:true,requestParams:r,cid:s.cid})}}})}else{t()}},error:function(e){l=true;if(a.error){a.error(e)}t(e)},complete:function(){e.trigger("offline:server:read",{status:l?u.error:u.finish,apiOptions:s,dataUpdated:o});if(a.complete){a.complete(arguments)}}},s])},_onReadCollectionComplete:function(t,i,n){if(t){if(t instanceof e.offline.Error&&t!==e.offline.Error.OfflineDisabledError){e.logger.error("readSyncMixedCollection failed. "+t)}}else{e.logger.debug("Read mixed collection success")}if(n.complete){n.complete(i)}}};_.extend(e.offline.api,{readMixedCollection:_.bind(t.readMixedCollection,t),_readMixedCollectionScope:t})})(SUGAR.App)},350:function(e,t){(function(e){var t={createUpdateDelete:function i(t){var i=this,n=t.method,r=t.module,a=t.data,s=t.params||{},o=t.callbacks,l=t.originalApi,u=t.options;if(!s.deferSync&&e.offline.isOnline()){async.waterfall([function f(t){e.offline.storage.readTransactions({limit:1,success:function(e){t(null,e)},error:t})}],function c(t,f){if(t&&o.error){e.logger.error("createUpdateDeleteSync failed"+t);o.error(t)}else{if(f){i._offlineSync(n,r,a,s,o)}else{i._serverSync(n,r,a,s,o,l,u)}}})}else{i._offlineSync(n,r,a,s,o)}},_isInitialStateRequired:function n(e,t,i,r){return e==="update"||e==="favorite"||e==="follow"||(e==="create"||e==="delete")&&i.link},_offlineSync:function r(t,i,n,a,s){var o=this;async.series([function l(r){if(o._isInitialStateRequired(t,i,n,a)){var s=a.relate?n.relatedModule:i,l=a.relate?n.relatedId:n.id;e.offline.storage.readSingleRawRecord(s,{id:l},{success:function(e){a.initialState=e;r()},error:r})}else r()}],function(r){if(r){var o="Failed to read initial record during offline sync. Module: {0}, data: {1}";o=e.utils.formatString(o,[i,JSON.stringify(n||{})]);e.logger.error(o);if(s.error){s.error(r)}return}e.offline.storage.sync(t,n,i,_.extend({},{ts:e.utils.getTimestamp(),success:function(i){e.trigger("offline:data:sync:success",i);if(s.success)s.success(i);e.logger.trace("Successfully executed: "+t)},error:function(e){if(s.error){s.error(e)}},complete:s.complete},a))})},_serverSync:function a(t,i,n,r,s,o,l){var u=this;var f=function(a){var o,l=e.acl.hasAccessToModel("access",e.data.createBean(i,a));if(t==="delete"||!l){o=[function(t){e.offline.storage.sync("delete",n,i,_.extend(r,{hardDelete:true,success:function(){t()},error:t}))}];if(r.relate){o.push(function(t){e.offline.storage.saveRecords({serverData:a.record,module:i,callback:t})});o.push(function(t){e.offline.storage.saveRecords({serverData:a.related_record,module:n.relatedModule,callback:t})})}async.series(o,function f(t){if(t){e.logger.error(t);s.error(t)}else{s.success(a)}})}else{var u=t!=="follow"?a:{id:n.id,following:n.following};if(_.isObject(u)){o=[function(t){e.offline.storage.saveRecords({serverData:r.relate?u.record:u,module:i,callback:t})}];if(r.relate){o.push(function(t){e.offline.storage.saveRecords({serverData:u.related_record,module:i,relationshipData:n,callback:t})})}if(t==="create"&&!r.relate||t==="create"&&(r.relate&&!n.relatedId)){o.push(function(t){e.offline.storage.updateLastViewed(r.relate?u.related_record:u,{module:r.relate?n.relatedModule:i,callback:t})})}if(t!=="delete"){o.push(function(t){e.offline.storage.markToBeSynced({module:r.relate?n.relatedModule:i,callback:t,action:"update",record:r.relate?u.related_record:u})})}async.series(o,function c(t){if(t){e.logger.error(t);s.error(t)}else{s.success(a);e.trigger("offline:data:updated",{isCollection:false,action:"update"})}})}else{s.success(a)}}};var c=function(a){if(a&&e.utils.isConnectivityError(a)){u._offlineSync(t,i,n,r,s)}else{if(s.error)s.error(a)}};if(t==="favorite"||t==="follow"){e.offline.api.callOriginalApi(o,[i,n.id,t==="favorite"?n.my_favorite:n.following,{success:f,error:c,complete:s.complete}])}else{if(t==="create"&&!n.relatedId){var d=n.link?n.related:n;d.id=e.utils.generateUUID()}e.offline.api.callOriginalApi(o,[t,i,n,e.offline.utils.getCleanedParams(r),{success:f,error:c,complete:s.complete},l])}}};_.extend(e.offline.api,{createUpdateDelete:_.bind(t.createUpdateDelete,t),_createUpdateDeleteScope:t})})(SUGAR.App)},351:function(e,t){(function(e){var t={_rStack:[],_rTs:{},_getPseudoUrl:function(e,t,i,n){var r=n.relate?i:i?{id:i.id}:null;var a=JSON.stringify({module:t,data:r,params:_.pick(n,"max_num","offset","relate","favorites","my_items")});return a},handleServerSyncSkip:function(e,t,i,n){if(n.skipServerSync||n.forceServerSync||n.skipOfflineRead){return}var r=this._getPseudoUrl(e,t,i,n);if(this._shouldSuppressRemoteSync(r)){n.skipServerSync=true}},_shouldSuppressRemoteSync:function(t){return _.contains(this._rStack,t)&&(new Date).getTime()-this._rTs[t]<e.config.offline.httpThrottleTimeout},cacheRequest:function(t,i,n,r){var a=this._getPseudoUrl(t,i,n,r),s=this._rStack,o=this._rTs,l=e.config.offline.httpThrottleCacheSize;var u=s.indexOf(a);if(u>-1){s.splice(u,1)}s.splice(0,0,a);o[a]=(new Date).getTime();if(s.length>l){delete o[s.pop()]}return{rStack:s,rTs:o}}};_.extend(e.offline.api,{handleServerSyncSkip:_.bind(t.handleServerSyncSkip,t),cacheRequest:_.bind(t.cacheRequest,t),_httpThrottlingScope:t})})(SUGAR.App)},352:function(e,t){(function(e){var t="No records found using this filter",i="%";e.offline.syncManager.recordsPreloader={_requestTime:0,start:function(t){var i=this;e.trigger("offline:prefetch:start");t=t||{};var n=t.callback;_.extend(t,{callback:function(t){if(t){e.logger.error("Prefetch failed. "+t)}else{e.logger.debug("Successfully prefetched modules")}i._requestTime=0;e.trigger("offline:prefetch:complete",t);if(n){n(t)}}});if(!_.isEmpty(t.relatedModules)){this.preloadRelationships(t)}else{if(_.isEmpty(t.modules)){t.modules=e.config.offline.prefetch.staticModules}this._prefetch(t)}},preloadRelationships:function(t){var i=this,n=[],r=e.config.offline.prefetch.relationships.pageSize,a=t.relatedModules;_.each(a,function(a,s){n.push(function(n){async.waterfall([function o(i){e.offline.storage.sync("read",undefined,s,_.extend(t,{max_num:a.maxThreshold,selectFields:"id",success:function(e){i(null,e)},error:i}))},function l(t,n){var o=e.offline.utils.paginate(t,r),l=a.relationships;i._fetchRelatedModules({relatedModules:l,parentModule:s,pagedRecords:o,pageSize:r,callback:n})}],n)})});async.series(n,t.callback)},_fetchRelatedModules:function(t){var i=[],n=this;if(_.isEmpty(t.pagedRecords)){return t.callback(null)}_.each(t.pagedRecords,function(r){var a={},s={};_.each(t.relatedModules,function(t,i){var n={};n[t.rhs_key]={$in:_.pluck(r,"id")};a[i]=[n];s[i]=e.config.offline.prefetch.relationships.maxThreshold});i.push(function(e){n._prefetch({modules:s,parentModule:t.parentModule,relatedModules:t.relatedModules,callback:e,filter:a,skipRecordsCount:true,pageSize:t.pageSize})})});async.series(i,t.callback)},_prefetch:function(i){var n=[],r=this,a=i.modules;_.each(a,function(a,s){if(!e.metadata.getModule(s)||!e.acl.hasAccess("list",s)){e.logger.debug("Skipping prefetch of "+s+". Either metadata is missing or no access is given");return}n.push(function(n){var o;o=[function(n){if(!i.skipRecordsCount){r._calculateEstimatedTimePerModule(s,i,function(i,r,a){if(i){e.logger.error("Calculating estimated prefetching time failed in module "+s+"."+i);n(i)}else if(a){e.logger.debug("Successfully calculated prefetching time for module "+s+". Estimated time is "+r);n(i,r,a)}else{n(t)}})}else{n(null,null,e.config.offline.prefetch.maxThreshold)}},function(e,t,n){r._prefetchModule(_.extend({},i,{maxRecords:a,moduleName:s,estimatedTime:e,recordsCount:t,callback:n}))}];async.waterfall(o,function(e){if(e===t){n()}else{n(e)}})})},this);async.series(n,function(t){if(t)e.error.handleHttpError(t);if(i.callback){i.callback(t)}})},_prefetchModule:function(t){var i=t.pageSize||e.config.offline.prefetch.pageSize,n=0,r=this,a=+new Date,s=t.maxRecords||e.config.offline.prefetch.maxThreshold,o=t.recordsCount,l=t.moduleName,u=e.metadata.getModule(l,"mergedFields"),f,c,d,p,h;if(o&&o<s){c=o}else{c=s}f={max_num:i,offset:n,fields:u.join(",")};if(t.filter){f.filter=t.filter[l]||t.filter}d=function(t){e.offline.storage.saveRecords.call(e.offline.storage,{module:t.module,serverData:t.records,callback:t.callback})};p=function(e){var i=+new Date,n;r._requestTime=i-a;n=r._getEstimatedTime(c-e);h=r._getProgressValue(e,c);r._processPrefetchProgress(_.extend({},t,{estimatedTime:n,progressValue:h}));a=i};r._processPrefetchProgress(_.extend({},t,{estimatedTime:t.estimatedTime,progressValue:r._getProgressValue(n,c)}));e.offline.utils.fetchPageByPage(l,f,d,null,{callback:t.callback,maxRecords:c,pageSize:i,iterator:p})},_processPrefetchProgress:function(t){var n=_.extend({},t,{estimatedTime:t.estimatedTime,module:t.moduleName});n.progressValue=t.parentModule?"":t.progressValue+i;e.trigger("offline:prefetch:progress",n)},_calculateEstimatedTimePerModule:function(t,i,n){var r=this;if(!r._requestTime){e.offline.utils.ping(function(e,a){r._requestTime=a;r._getRecordsCount(t,i,n)})}else{r._getRecordsCount(t,i,n)}},_getEstimatedTime:function(t){var i=e.config.offline.prefetch.pageSize||20;return this._requestTime&&(t/i/1e3*this._requestTime).toFixed(2)},_getRecordsCount:function(t,i,n){var r=this;e.api.call("create",e.api.buildURL(t,"filter/count"),{filter:i.filter},{success:function(e){var t=parseInt(e.record_count,10);n(null,r._getEstimatedTime(t),t)},error:function(e){n(e)}})},_getProgressValue:function(e,t){if(e>t){e=t}return Math.round(e/t*100)}}})(SUGAR.App)},353:function(e,t){(function(e){var t=function(e){this._module=e};_.extend(t.prototype,{combiners:{$or:" OR ",$and:" AND "},conditions:{base:{$equals:"=",$not_equals:"!=",$lt:"<",$lte:"<=",$gt:">",$gte:">=",$starts:function(e,t){return e+' LIKE "'+t+'%"'},$ends:function(e,t){return e+' LIKE "%'+t+'"'},$contains:function(e,t){return e+' LIKE "%'+t+'%"'},$not_contains:function(e,t){return e+' NOT LIKE "%'+t+'%"'},$in:function(e,t,i){t=i.value;return e+" IN ("+(_.isArray(t)?t.map(this._quotStr).join():t)+")"},$not_in:function(e,t,i){t=i.value;return e+" NOT IN ("+(_.isArray(t)?t.map(this._quotStr).join():t)+")"},$is_null:function(e){return e+" ISNULL"},$not_null:function(e){return e+" NOTNULL"},$empty:function(e){return"("+e+'="")'},$not_empty:function(e){return"("+e+'!="")'},$dateBetween:function(t,i,n){i=n.value;var r=e.date.utc(i[0]).startOf("day").toDate();var a=e.date.utc(i[1]).endOf("day").toDate();r=this._quotStr(this._getValue(r,t));a=this._quotStr(this._getValue(a,t));return t+" BETWEEN "+r+" AND "+a},$between:function(e,t,i){t=i.value;return e+" BETWEEN "+this._quotStr(t[0])+" AND "+this._quotStr(t[1])},$dateRange:function(e,t,i){t=i.value;var n=this._parseRange(t);if(n){var r={field:e,value:n[0],condition:"$gte"};var a={field:e,value:n[1],condition:"$lte"};return this._buildCondition(r)+" AND "+this._buildCondition(a)}return false}},byType:{tag:{$in:function(e,t,i){t=i.value.join("|");return e+' REGEXP "^.*""name"":""('+t+')"".*$"'},$not_in:function(e,t,i){var n=e+" ISNULL OR "+e+' REGEXP "^((?!';n+=_.map(i.value,function(e){return'""name"":""'+e+'""'}).join("|");n+=').)*$"';return n},$empty:function(e){return e+'="[]" OR '+e+" ISNULL"},$not_empty:function(e){return e+'!="[]" AND '+e+" NOTNULL"}},team_list:{$equals:function(e,t){return'team_name LIKE "%""id"":""'+t+'""%"'},$not_equals:function(e,t){return'team_name NOT LIKE "%""id"":""'+t+'""%"'}},json:{},email:{},teamset:{},metadata:{},multienum:{}}},customFilters:{$favorite:function(){return{filter:{field:"my_favorite",condition:"$equals",value:1}}},$owner:function(){return e.metadata.getModule(this._module,"fields").assigned_user_id?{sql:'"assigned_user_id"='+this._quotStr(e.user.get("id")),fields:["assigned_user_id"]}:false},$tracker:function(t){var i=this._parseDate(t.value);return i?{sql:'id IN (SELECT bean_id FROM _view_dates WHERE bean_module="'+this._module+'" AND date_last_viewed>="'+e.utils.getTimestamp(i)+'")'}:false},$creator:function(){return{filter:{field:"created_by",condition:"$equals",value:e.user.get("id")},fields:["created_by"]}},$following:function(){return{filter:{field:"following",condition:"$equals",value:1}}}},getExtractedFields:function(){return _.unique(this._filterFields)},buildSql:function(e,t){var i;this._filterFields=[];i=this._buildSql(e,"");if(t&&t.omitParentheses&&i){i=i.replace(/^\(|\)$/g,"")}return i},_buildSql:function i(e,t,n){for(var r=0,a=e.length;r<a;r++){var s=e[r];var o;if(s.operator){o=i.call(this,s.filters,"",this.combiners[s.operator]);if(o){t+="("+o+")"}}else{o=this._buildCondition(s);if(o){t+=o}}if(o&&a-r>1){t+=n}else if(o===false){return false}}return t},_buildCondition:function(e){var t,i,n,r,a,s,o;t=this.customFilters[e.field];if(t){t=t.call(this,e);if(t===false){return false}else if(t.sql){this._filterFields.push.apply(this._filterFields,t.fields);return t.sql}else if(t.filter){e=t.filter}}r=this._getCondition(e);if(!r){return false}i=e.field;n=e.value;a=this._getField(i);s=this._getValue(n,i);if(!a){return false}if(i.indexOf(".")!==-1){return this._processLink(e)}if(_.isFunction(r)){o=r.call(this,a,s,{field:i,value:n})}else if(_.isString(r)){o=a+r+this._quotStr(s)}if(o){this._filterFields.push(i);return o}return false},_processLink:function(i){var n=i.field;var r=n.split(".");var a=r[0];var s=e.offline.storage.getRelationshipByLink(this._module,a);var o=e.offline.storage.relTypes;var l=function(e){return new t(e).buildSql([{operator:"$and",filters:[{field:n,condition:"$equals",value:i.value}]}],{omitParentheses:true})};var u,f,c,d;n=r[1];if(s.relationship_type===o.MANY_TO_MANY){d=e.offline.storage._wrapManyToManyRelationship(this._module,a);c=l(d.dataTable);if(c){f="SELECT lt."+d.parentKey+" FROM "+d.parentModule+" lt INNER JOIN "+d.relationshipTable+" jt ON lt."+d.parentKey+"="+"jt."+d.parentIdColumn+" INNER JOIN "+d.dataTable+" rt ON rt."+d.childKey+"="+"jt."+d.childIdColumn;u=d.parentKey+" IN ("+f+" WHERE rt."+c+")"}}else if(s.relationship_type===o.ONE_TO_MANY){c=l(s.rhs_module);if(c){f="SELECT lt."+s.lhs_key+" FROM "+s.lhs_table+" lt INNER JOIN "+s.rhs_table+" rt ON lt."+s.lhs_key+"="+"rt."+s.rhs_key;u=s.lhs_key+" IN ("+f+" WHERE rt."+c+")"}}else if(s.relationship_type===o.ONE_TO_ONE){}return u||false},_getCondition:function(t){var i=t.condition;var n=this.conditions;var r=e.metadata.getModule(this._module).fields[t.field];var a=r&&r.type;return n.byType[a]?n.byType[a][i]:n.base[i]},_quotStr:function(e){return'"'+e+'"'},_getValue:function(t,i){return e.offline.storage._getValue(t,i,this._module,e.metadata.getModule(this._module).fields)},_getField:function(e){var t=e;switch(e){case"date_modified":t="_client_date_modified";break}return t},_dateRanges:{yesterday:["days",-1,-1],today:["days",0,0],tomorrow:["days",1,1],last_7_days:["days",-6,0],next_7_days:["days",0,6],last_30_days:["days",-29,0],next_30_days:["days",0,29],next_month:["months",1,1],this_month:["months",0,0],last_month:["months",-1,0],last_year:["years",-1,0],this_year:["years",0,0],next_year:["years",1,1]},_parseRange:function(t){var i=this._dateRanges[t];if(!i){return false}var n=i[0];var r=e.date.utc().add(i[1],n).startOf(n).toDate();var a=e.date.utc().add(i[2],n).endOf(n).toDate();return[e.utils.getTimestamp(r),e.utils.getTimestamp(a)]},_parseDate:function(t){var i=e.date.utc();var n="month";var r;switch(t){case"first day of this month":r=i.startOf(n);break;case"first day of next month":r=i.add(1,"month").startOf(n);break;case"last day of this month":r=i.endOf("month");break;case"last day of next month":r=i.add(1,n).endOf(n);break}if(r){return r.toDate()}r=e.date.phpStrToTime(t);if(r){return new Date(r*1e3)}return false}});e.offline.SqlFilterBuilder=t})(SUGAR.App)},354:function(e,t){(function(e){function t(e){return e.replace(/'/g,"''")}var i=function(e,t,i){this.name=e;this.definition=t;this._tableName=e;this.fields=i;var n=_.map(this.fields,function(e){return'"'+e.name+'"'});n.unshift('"_acl"');n.unshift('"_deleted"');n.unshift('"_client_date_modified"');n.unshift('"id"');var r=_.map(n,function(e){return e+"=?"});var a="("+n.join(",")+")";var s="SET "+r.join(",");var o=[];_.times(n.length,function(){o.push("?")});var l="("+o.join(",")+")";this.sqlCreate='INSERT INTO "'+this._tableName+'" '+a+" VALUES "+l;this.sqlReplace='REPLACE INTO "'+this._tableName+'" '+a+" VALUES "+l;this.sqlUpdate='UPDATE "'+this._tableName+'" '+s+" WHERE id=?";this.sqlMarkDeleted="UPDATE "+this._tableName+" SET _deleted=1 WHERE id=?";this.sqlResetDeleted="UPDATE "+this._tableName+" SET _deleted=0 WHERE id=?";this.sqlDelete='DELETE FROM "'+this._tableName+'" WHERE id=?';this.sqlSelectOne="SELECT * FROM "+this._tableName+" WHERE id=? AND _deleted!=1";this.sqlSelectOneWithDeleted="SELECT * FROM "+this._tableName+" WHERE id=?"};_.extend(i.prototype,{buildSqlReadModuleRecordsByIds:function(e){var t=" WHERE ";if(_.isArray(e)){t+='"id" IN ("'+e.join('","')+'")'}else{t+='"id" = "'+e+'"'}return"SELECT * FROM "+this._tableName+t},getSchema:function(t,n){var r=[],a=[],s=[];a.push('"id" TEXT PRIMARY KEY COLLATE NOCASE');a.push('"_client_date_modified" TEXT COLLATE NOCASE');a.push('"_deleted" INTEGER');a.push('"_acl" TEXT COLLATE NOCASE');function o(e,t){return'"'+e+'"'+t}_.each(this.fields,function(t){if(_.isEmpty(t.name)){return}var r=i.getSqlTypeByMetaType(t.type),l=o(t.name,r);if(_.contains(a,l)){e.logger.warn(l+" column already exists in "+this.name+" table. Skipping")}else{a.push(l);if(t.type==="email"&&!n.fields.email1){a.push(o("email1",r))}}if(t.unified_search===true){var u=this.name+"_"+t.name+"_IDX";s.push("DROP INDEX IF EXISTS "+u);s.push("CREATE INDEX "+u+' ON "'+this._tableName+'" ("'+t.name+'" COLLATE NOCASE)')}},this);r.push('DROP TABLE IF EXISTS "'+this._tableName+'"');r.push('CREATE TABLE "'+this._tableName+'" ('+a.join(",")+")");_.each(s,function(e){r.push(e)});return r},buildSqlSelectMany:function(t){var n=t.offset||0;var r=t.max_num||e.config.maxQueryResult;var a=t.selectFields;var s=_.isEmpty(a)?"*":_.isArray(a)?a.join():a;var o=(t.order_by||"_client_date_modified:DESC").replace(":"," ");var l="SELECT {0} FROM {1} "+i.buildWhere(this.name,t,{andSql:"_deleted!=1"})+" ORDER BY {4} LIMIT {2},{3}";return e.utils.formatString(l,[s,this._tableName,n,r,o])},buildSqlUpdate:function(e,t){var i=_.map(t,function(e){return e+"=?"});var n="SET "+i.join(",");return'UPDATE "'+this._tableName+'" '+n+" WHERE id=?";

}});i.DEFAULT_TEXT_COLUMN_TYPE=" TEXT COLLATE NOCASE";i.getSqlTypeByMetaType=function n(e){var t;switch(e){case"bool":case"boolean":case"int":case"integer":t=" INTEGER";break;case"float":case"double":case"currency":t=" REAL";break;default:t=this.DEFAULT_TEXT_COLUMN_TYPE;break}return t};i.buildWhere=function(t,n,r){var a=i.buildSearchQuery(t,n,r);var s=n.filter;var o,l;if(n.filterParsed&&n.filterParsed.isSupported){o=n.filterParsed.filterSql}else{s=e.offline.convertReadRecordsFilter(n,t);o=s&&s.isSupported?s.filterSql:""}l=_.compact([o,a,r.andSql]).join(" AND ");return l?"WHERE "+l:""};i.buildSearchQuery=function(i,n,r){if(!n.q){return""}var a=n.q.indexOf("?")!==-1||n.q.indexOf("*")!==-1;var s;n.q=t(n.q.trim());s=_.map(e.offline.storage.offlineMeta[i].searchFields,function(e){return e.name+(a?" GLOB '":" LIKE '")+n.q+(a?"*":"%")+"'"}).join(" OR ");return s?"("+s+")":""};i.buildFilterQuery=function(t,i){if(!i){return}var n=new e.offline.SqlFilterBuilder(t);var r=n.buildSql(i);var a=n.getExtractedFields();return{sql:r,fields:a}};i.relationships={getCreateSchemaStatements:function(t){var i=[];_.each(t,function(t){if(t.type===e.offline.storage.relTypes.MANY_TO_MANY){i.push(e.utils.formatString('DROP TABLE IF EXISTS "{0}"',[t.relationshipTable]));var n="",r=t.additionalColumns;if(!_.isEmpty(r)){var a=[];_.each(r,function(t,i){a.push(e.utils.formatString('"{0}" TEXT COLLATE NOCASE',[i]))},this);n=a.join(",")}if(t.primaryFlagModule){n+='"primary_flag" INTEGER DEFAULT 0'}var s='CREATE TABLE "{0}" ("{1}" TEXT COLLATE NOCASE, "{2}" TEXT COLLATE NOCASE, "_client_date_modified" TEXT COLLATE NOCASE, "_deleted" INTEGER,{3} PRIMARY KEY ("{1}","{2}"))';s=s.replace(/\{0\}/g,t.relationshipTable);s=s.replace(/\{1\}/g,t.parentIdColumn);s=s.replace(/\{2\}/g,t.childIdColumn);s=s.replace(/\{3\}/g,n?n+",":"");i.push(s)}},this);return i},_getRelColumnsAliasSql:function(t){var i="";if(!_.isEmpty(t.additionalColumns)){i+=",";var n=[];_.each(t.additionalColumns,function(t,i){n.push(e.utils.formatString("r.{0} AS {1}",[i,t]))},this);i+=n.join(",")}return i},buildSqlSelectSingleRelated:function(t,i){var n=e.offline.storage.getRelationshipByLink(t,i.link),r=n.type;if(r===e.offline.storage.relTypes.MANY_TO_MANY){var a=this._getRelColumnsAliasSql(n);var s=e.utils.formatString('SELECT d.*,r.*{0} FROM {1} AS d JOIN {2} AS r ON (d.id=r.{3} AND r.{5}="{6}") WHERE (d._deleted!=1 AND r._deleted!=1 AND d.id="{4}")',[a,i.relatedModule,n.relationshipTable,n.childIdColumn,i.relatedId,n.parentIdColumn,i.id]);if(n.singleModule){var o=e.utils.formatString('SELECT d.*,r.*{0} FROM {1} AS d JOIN {2} AS r ON (d.id=r.{3} AND r.{5}="{6}") WHERE (d._deleted!=1 AND d.id="{4}")',[a,i.relatedModule,n.relationshipTable,n.parentIdColumn,i.relatedId,n.childIdColumn,i.id]);s=s+" UNION "+o}return s}else{return e.utils.formatString('SELECT * FROM {0} WHERE id="{1}" AND _deleted!=1',[i.relatedModule,i.relatedId])}},buildSqlSelectManyRelated:function(t,n,r){var a="SELECT * FROM {0} ",s=e.offline.storage.getRelationshipByLink(t,n.link),o=s.type,l=r.offset||0,u=r.max_num||e.config.maxQueryResult,f="",c=(r.order_by||"_client_date_modified:DESC").replace(":"," "),d,p,h;if(o===e.offline.storage.relTypes.MANY_TO_MANY){d=this._getRelColumnsAliasSql(s);h=i.buildWhere(s.childModule,r,{andSql:'(r._deleted!=1 AND d._deleted!=1 AND r.{4}="{5}")'});p="SELECT d.*,r.*{6} FROM {0} AS r JOIN {1} AS d ON r.{2}=d.id "+h;f=e.utils.formatString(p,[s.relationshipTable,s.parentModule,s.childIdColumn,s.childIdColumn,s.parentIdColumn,n.id,d]);if(s.singleModule){var _=e.utils.formatString(p,[s.relationshipTable,s.childModule,s.parentIdColumn,s.childIdColumn,s.childIdColumn,n.id,d]);f=f+" UNION "+_}c=(r.order_by||"d._client_date_modified:DESC, d._last_fetched:ASC").replace(/:/g," ")}else if(o===e.offline.storage.relTypes.ONE_TO_MANY||o===e.offline.storage.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN){h=i.buildWhere(s.childModule,r,{andSql:'({1}="{2}" AND _deleted!=1)'});f=e.utils.formatString(a+h,[s.childModule,s.parentIdColumn,n.id])}f=f+" ORDER BY {2} LIMIT {0},{1}";return e.utils.formatString(f,[l,u,c])},buildSqlReplaceRelationship:function(t,i,n){n=n||{};var r=i.relDef||e.offline.storage.getRelationshipByLink(t,i.link),a=r.type;if(a===e.offline.storage.relTypes.ONE_TO_MANY||a===e.offline.storage.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN){if(!i.id||n.skipUpdateRelRecord){return}var s=n.ts?e.utils.formatString(', _client_date_modified="{0}"',[n.ts]):"",o=r.parentNameFieldDef;if(o&&i.related&&_.isEmpty(i.related[o.name])){s+=e.utils.formatString(', {0}=(SELECT {1} FROM {2} WHERE id="{3}")',[o.name,"name",t,i.id]);if(_.isEmpty(i.related["parent_type"])&&a===e.offline.storage.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN){s+=e.utils.formatString(', parent_type="{0}"',[t])}}return e.utils.formatString('UPDATE {0} SET {1}="{2}"{3} WHERE id="{4}"',[r.childModule,r.parentIdColumn,i.id,s,i.relatedId])}else{var l='REPLACE INTO "{0}" ({1}) VALUES ({2})',u=[],f;f=[r.parentIdColumn,r.childIdColumn,"_client_date_modified","_deleted"];if(!i.id&&r){i.id=i.related[r.parentIdColumn]}if(!i.id){return}var c=[i.id,i.relatedId,n.ts||e.utils.getTimestamp(),0];_.each(r.additionalColumns,function(e,t){if(i.related&&!_.isEmpty(i.related[e])){f.push(t);c.push(i.related[e])}});if(r.primaryFlagModule){if(i.id){f.push("primary_flag");c.push(1);u.push({sql:e.utils.formatString('UPDATE "{0}" SET "{3}"={4} WHERE {1}="{2}"',[r.relationshipTable,r.childIdColumn,i.relatedId,"primary_flag","0"])})}}f='"'+f.join('","')+'"';c='"'+c.join('","')+'"';if(r.originalType===e.offline.storage.relTypes.ONE_TO_MANY){u.push({sql:e.utils.formatString('DELETE FROM "{0}" WHERE {1}="{2}"',[r.relationshipTable,r.childIdColumn,i.relatedId])})}else if(r.originalType===e.offline.storage.relTypes.ONE_TO_ONE){u.push({sql:e.utils.formatString('DELETE FROM "{0}" WHERE {1}="{2}"',[r.relationshipTable,r.parentIdColumn,i.id])})}u.push({sql:e.utils.formatString(l,[r.relationshipTable,f,c])});if(e.offline.storage._shouldCustomRelUpdateChild(r,n)){var d=r.primaryFlagModule?e.metadata.getModule(r.primaryFlagModule):null,p=d?e.data.getRelateFields(r.primaryFlagModule,r.link)[0]:e.data.getRelateFields(r.childModule,r.name)[0];if(p){[].push.apply(u,this.buildCustomRelUpdateChild(p,r,i,false))}}return u}},buildDeleteRelationship:function(t,i,n){n=n||{};var r=i.relDef||e.offline.storage.getRelationshipByLink(t,i.link),a=r.type,s;if(a===e.offline.storage.relTypes.ONE_TO_MANY||a===e.offline.storage.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN){if(n.skipUpdateRelRecord){return}var o=n.ts?',_client_date_modified="'+n.ts+'"':"";if(a===e.offline.storage.relTypes.ONE_TO_MANY){var l=r.parentNameFieldDef;if(l){s="UPDATE {0} SET {1}=NULL, "+l.name+'=NULL {3} WHERE id="{2}"'}else{s='UPDATE {0} SET {1}=NULL {3} WHERE id="{2}"'}}else{s='UPDATE {0} SET parent_type=NULL, parent_name=NULL, {1}=NULL {3} WHERE id="{2}"'}return e.utils.formatString(s,[r.childModule,r.parentIdColumn,i.relatedId,o])}else{var u=[];if(!i.id&&r){i.id=i.related[r.parentIdColumn]||n.initialState&&n.initialState[r.parentIdColumn]}if(!i.id){return}if(r.singleModule){var f;if(n.hardDelete){s='DELETE FROM {0} WHERE (({1}="{2}" AND {3}="{4}") OR ({3}="{2}" AND {1}="{4}"))';f=s.replace(/\{0\}/g,r.relationshipTable).replace(/\{1\}/g,r.parentIdColumn).replace(/\{2\}/g,i.id).replace(/\{3\}/g,r.childIdColumn).replace(/\{4\}/g,i.relatedId)}else{s='UPDATE {0} SET _deleted=1,_client_date_modified="{5}" WHERE (({1}="{2}" AND {3}="{4}") OR ({3}="{2}" AND {1}="{4}"))';f=s.replace(/\{0\}/g,r.relationshipTable).replace(/\{1\}/g,r.parentIdColumn).replace(/\{2\}/g,i.id).replace(/\{3\}/g,r.childIdColumn).replace(/\{4\}/g,i.relatedId).replace(/\{5\}/g,n.ts||e.utils.getTimestamp())}return f}else{var c=r.primaryFlagModule?", primary_flag=0":"";s=n.hardDelete?'DELETE FROM {0} WHERE {1}="{2}" AND {3}="{4}"':"UPDATE {0} SET _deleted=1"+c+',_client_date_modified="{5}" WHERE {1}="{2}" AND {3}="{4}"';u.push({sql:e.utils.formatString(s,[r.relationshipTable,r.parentIdColumn,i.id,r.childIdColumn,i.relatedId,n.ts||e.utils.getTimestamp()])})}if(r.primaryFlagModule){u.push({sql:'UPDATE {0} SET primary_flag=1 WHERE {1}="{2}" AND _client_date_modified=(SELECT MAX(_client_date_modified) FROM {0} WHERE {1}="{2}" AND _deleted<>1)'.replace(/\{0\}/g,r.relationshipTable).replace(/\{1\}/g,r.childIdColumn).replace(/\{2\}/g,i.relatedId)})}if(e.offline.storage._shouldCustomRelUpdateChild(r,n)){var d=r.primaryFlagModule?e.data.getRelateFields(r.primaryFlagModule,r.link)[0]:e.data.getRelateFields(r.childModule,r.name)[0];if(d){[].push.apply(u,this.buildCustomRelUpdateChild(d,r,i,true))}}return u}},buildCustomRelUpdateChild:function(t,i,n,r){var a=i.originalType===e.offline.storage.relTypes.ONE_TO_ONE,s,o,l,u,f,c,d,p,h=[];if(a){s=i.parentIdColumn;o=i.childIdColumn;l=i.childModule;u=i.parentModule;f=r?"":n.relatedId;c=n.id}else{s=i.childIdColumn;o=n.relatedModule?i.parentIdColumn:i.childIdColumn;l=i.parentModule;u=i.childModule;f=r?"":n.id;c=n.relatedId}d=r?"''":e.utils.formatString("(SELECT name FROM {0} WHERE id='{1}')",[u,f]);p="UPDATE {0} SET {1}={2}, {3}='{4}' WHERE id='{5}'";if(a&&!r){var _="(SELECT {0} FROM {1} WHERE id='{2}')",g="UPDATE {0} SET {1}={2}, {3}='{4}' WHERE id={5}",m=e.utils.formatString(_,[o,l,c]),v=e.utils.formatString(_,[s,u,f]),y=e.utils.formatString(_,["name",u,f]);h.push({sql:e.utils.formatString(g,[u,t.name,"''",s,"",m])});h.push({sql:e.utils.formatString(g,[l,t.name,"''",o,"",v])});h.push({sql:e.utils.formatString(p,[l,t.name,y,o,f,c])})}else if(i.primaryFlagModule){f=e.utils.formatString('(SELECT {0} FROM {1} WHERE {2}="{3}" AND primary_flag=1 AND _deleted<>1)',[o,i.relationshipTable,i.childIdColumn,n.relatedId]);d=e.utils.formatString("(SELECT name FROM {0} WHERE id={1})",[t.module,f]);var S="UPDATE {0} SET {1}={2} WHERE id='{3}'",b="UPDATE {0} SET {1}={2} WHERE id='{3}' AND {4}",E=e.utils.formatString("EXISTS (SELECT id FROM {0} WHERE id={1})",[u,f]);h.push({sql:e.utils.formatString(b,[l,t.name,d,c,E])});h.push({sql:e.utils.formatString(S,[l,o,f,c])})}else{h.push({sql:e.utils.formatString(p,[l,t.name,d,o,f,c])})}return h},buildSqlUpdateChildren:function(i,n){var r=[],a=e.offline.storage._getModuleRelationships(i),s=_.filter(a,function(t){return t.type!==e.offline.storage.relTypes.MANY_TO_MANY&&t.parentModule===i},this);_.each(s,function(i){if(i.parentNameFieldDef){r.push(e.utils.formatString("UPDATE {0} SET {1}='{2}' WHERE {3}='{4}'",[i.childModule,i.parentNameFieldDef.name,t(n.name),i.parentIdColumn,n.id]))}},this);return r.length>0?r:null},buildSqlCleanRelationships:function(t,i,n){n=n||{};var r,a={},s=[],o,l;r=e.offline.storage._getModuleRelationships(t);_.each(r,function(r){if(r.type!==e.offline.storage.relTypes.MANY_TO_MANY){if(n.skipOneToManyChildren){return}if(r.parentModule===t){var u=r.childModule;o=r.parentIdColumn;l=e.metadata.getModule(u);if(l.fields[o]){a[u]=a[u]||{};a[u][o]="parent_id"}}}else{var f=r.relationshipTable;o=r.parentIdColumn;s.push(e.utils.formatString('DELETE FROM {0} WHERE {1}="{2}"',[f,o,i.id]))}},this);_.each(a,function(t,i){var n=e.metadata.getModule(i).fields,r;_.each(t,function(n,r){var a=e.data.getRelatedNameField(i,r);if(a){t[a.name]="parent_name"}});r=_.keys(t);if(_.contains(r,"parent_id")&&_.contains(r,"parent_name")&&n["parent_type"]){t["parent_type"]="parent_type"}});_.each(a,function(t,n){var r=[],a=[],o="UPDATE {0} SET {1} WHERE {2}";_.each(t,function(e,t){r.push(t+"=NULL");if(e==="parent_id"){a.push(t+'="'+i.id+'"')}});r=r.join(",");a=a.join(" OR ");s.push(e.utils.formatString(o,[n,r,a]))});return s}};i.init=function(e){};i.getDropTableStatement=function(e){return"DROP TABLE "+e};i.getSelectTablesStatement=function(){return"SELECT tbl_name FROM sqlite_master WHERE type='table' AND tbl_name!='__WebKitDatabaseInfoTable__'"};i.getDropTableStatements=function(e){return _.map(e,function(e){return i.getDropTableStatement(e)})};i.getAlterTableStatement=function(t,n){var r=n.name,a=i.getSqlTypeByMetaType(n.type);return e.utils.formatString('ALTER TABLE {0} ADD COLUMN "{1}" {2}',[t,r,a])};i.getResetDateModifiedStatement=function(t,i){return e.utils.formatString('UPDATE {0} SET _client_date_modified=date_modified WHERE id="{1}"',[t,i.id])};i.getStatsRetrieveStatements=function(e){var t="(SELECT COUNT(*) FROM {0}) AS {0}, (SELECT COUNT(*) FROM {0} JOIN _view_dates ON {0}.id=_view_dates.bean_id) AS {0}_Viewed",i=[];_.each(e.modules,function(e){var n=t.replace(/\{0\}/g,e);i.push(n)});return"SELECT "+i.join(", ")};i.transactionLog={getCreateSchemaStatements:function(){var e=[];e.push('DROP TABLE IF EXISTS "_tx_log"');e.push('CREATE TABLE "_tx_log" ("_tx_uid" TEXT COLLATE NOCASE PRIMARY KEY, "_tx_action" INTEGER, "_tx_ts" TEXT COLLATE NOCASE, "_tx_bean_id" TEXT COLLATE NOCASE,"_tx_bean_module" TEXT COLLATE NOCASE, "_tx_related_id" TEXT COLLATE NOCASE, "_tx_related_module" TEXT COLLATE NOCASE, "_tx_updated_fields" TEXT COLLATE NOCASE, "_tx_link" TEXT COLLATE NOCASE, "_tx_error" TEXT COLLATE NOCASE, "_tx_error_count" INTEGER DEFAULT 0)');e.push("DROP INDEX IF EXISTS _tx_log_ts_IDX");e.push('CREATE INDEX _tx_log_ts_IDX ON "_tx_log" ("_tx_ts")');e.push("DROP INDEX IF EXISTS _tx_log_bean_id_IDX");e.push('CREATE INDEX _tx_log_bean_id_IDX ON "_tx_log" ("_tx_bean_id" COLLATE NOCASE)');return e},getCountAssociatedTransactionsStatements:function(t){return e.utils.formatString('SELECT COUNT(*) AS count FROM _tx_log WHERE _tx_bean_id="{0}" AND _tx_uid!="{1}"',[t._tx_bean_id,t._tx_uid])},getReadTransactionsStatements:function(t){var i="ORDER BY ";if(t.errFirst){i+='"_tx_error_count" = 0, '}i+='"_tx_ts" '+(t.dateAsc?"ASC":"DESC");return e.utils.formatString('SELECT * FROM "_tx_log" {0} LIMIT ?,?',[i])},sqlTxLogAction:'INSERT INTO "_tx_log" ("_tx_action", "_tx_ts", "_tx_bean_id", "_tx_bean_module", "_tx_related_id", "_tx_related_module", "_tx_updated_fields", "_tx_uid", "_tx_link") VALUES (?,?,?,?,?,?,?,?,?)',updateTransaction:function(t,i){var n=[];_.each(i,function(e,t){n.push(t+"="+"'"+e+"'")});return e.utils.formatString("UPDATE _tx_log SET "+n.join(",")+" WHERE _tx_uid='{0}'",[t])},getTxLog:'SELECT * FROM "_tx_log" WHERE _tx_uid = ?',_deleteTransaction:"DELETE FROM _tx_log WHERE _tx_uid = ?",clearTransactionLog:"DELETE FROM _tx_log",countTransactions:"SELECT (SELECT COUNT(*) FROM _tx_log WHERE _tx_error in ("+e.offline.TRANSACTION_STATUSES.UNRECOVERABLE.join(",")+")) AS failedTransactions, (SELECT COUNT(*) FROM _tx_log) AS totalTransactions"};i.lastViewed={buildRead:function(e){return'SELECT * FROM "_view_dates" ORDER BY "date_last_viewed"'+(e?"":"DESC")+" LIMIT ?"},buildReadForRecords:function(e){return'SELECT * FROM "_view_dates" WHERE "bean_id" IN ("'+e.join('","')+'")'},buildReadForModule:function(e){return'SELECT "'+e+'".*, "_view_dates"."date_last_viewed" as "_last_viewed_date" FROM "'+e+'" INNER JOIN "_view_dates" ON "_view_dates"."bean_id" = "'+e+'"."id" WHERE _deleted != 1 ORDER BY "_view_dates"."date_last_viewed" DESC LIMIT ?'},getCreateSchemaStatements:function(){var e=[];e.push('DROP TABLE IF EXISTS "_view_dates"');e.push('CREATE TABLE "_view_dates" ("bean_id" TEXT COLLATE NOCASE PRIMARY KEY, "bean_module" TEXT COLLATE NOCASE, "date_last_viewed" TEXT COLLATE NOCASE)');return e},buildReplace:function(t,i,n){var r=n.ts||e.utils.getTimestamp();return e.utils.formatString('REPLACE INTO "_view_dates" ("bean_id","bean_module", "date_last_viewed") VALUES ("{0}","{1}","{2}")',[i.id,t,r])},buildDelete:function(t,i){return e.utils.formatString('DELETE FROM _view_dates WHERE bean_id="{0}"',[i.id])},buildFindViewedBefore:function(t,i){return e.utils.formatString('SELECT name, id, date_last_viewed FROM {0} AS d LEFT JOIN _view_dates AS v on d.id=v.bean_id WHERE (date_last_viewed IS NULL OR date_last_viewed < "{1}")',[t,i.expirationDate])},buildCleanupMyModule:function(t){return e.utils.formatString('DELETE FROM _view_dates WHERE bean_module="{0}"',[t])}};i.sync={getCreateSchemaStatements:function(){var e=[];e.push('DROP TABLE IF EXISTS "_to_be_synced"');e.push('CREATE TABLE "_to_be_synced" ("bean_id" TEXT COLLATE NOCASE PRIMARY KEY, "bean_module" TEXT COLLATE NOCASE, "action" TEXT COLLATE NOCASE)');return e},getMarkToBeSyncedSql:function(t,i){return e.utils.formatString('REPLACE INTO "_to_be_synced" ("bean_id","bean_module", "action") VALUES ("{0}","{1}","{2}")',[i.record.id,t,i.action])},getResetToBeSyncedSql:function(e,t){var i=_.pluck(t.records,"id");return'DELETE FROM "_to_be_synced" WHERE "bean_id" IN ("'+i.join('","')+'")'},getReadToBeSyncedSql:function(t,i,n){var r=e.utils.formatString('SELECT * FROM "_to_be_synced" WHERE bean_module="{0}" ORDER BY bean_id',[t]);if(!_.isUndefined(n.offset)){r+=e.utils.formatString(" LIMIT {0},{1}",[n.offset,n.max_num])}return r}};i.upgrade={getUpgrade1Sql:function(t){var n=[];_.each(t.relationships,function(t){if(t.primary_flag_column){n.push(e.utils.formatString('ALTER TABLE {0} ADD COLUMN "primary_flag" INTEGER DEFAULT 0',[t["join_table"]]))}});Array.prototype.push.apply(n,i.sync.getCreateSchemaStatements());return n}};e.offline.SqlHelper=i})(SUGAR.App)},355:function(e,t){(function(e){function t(){throw new Error("Not implemented. Please override this method with your implementation")}var i={createTransaction:"offline:tx:create",deleteTransaction:"offline:tx:delete"};e.offline.storage={_regularSyncOperations:["create","update","favorite","delete","follow"],relTypes:{ONE_TO_ONE:"one-to-one",ONE_TO_MANY:"one-to-many",MANY_TO_MANY:"many-to-many",ONE_TO_MANY_BY_ROLE_COLUMN:"one-to-many-byRoleColumn"},offlineMeta:{},_execQueue:null,_migrationSummary:{},getMigrationSummary:function(){return this._migrationSummary},resetMigrationSummary:function(){this._migrationSummary={}},exec:function(t,n,r){this._exec(t,function a(r){if(n)n(r);_.each(t,function(t){var n=i[t.op];if(n){e.trigger(n,{txOptions:t.options})}})},function s(t){if(r)r.apply(this,arguments);e.trigger("offline:failure",t||e.offline.UnknownError)})},_exec:function(e,i,n){t()},execAndSpecificReturn:function(t,i){var n=!_.isEmpty(i)&&i.regularSync,r=i.dbSuccess;if(n&&_.contains(this._regularSyncOperations,i.method)){if(i.method!=="delete"){t.unshift({op:"createTransaction",data:i.data,module:i.module,options:i});t.push({op:"readSingle",data:i.data,module:i.module,options:i})}else{t.push({op:"readSingle",data:i.data,module:i.module,options:_.extend(i,{readDeleted:true})});i.dbSuccess=function(e){r.call(this,e?{id:e.id}:{id:i.data.id})}}if(i.relate){t.push({op:"readSingleRelated",data:i.data,module:i.module,options:i});i.dbSuccess=function(e){r.call(this,{record:e[0],related_record:e[1]})}}var a=i.action===e.offline.SYNC_ACTIONS.LINK||i.action===e.offline.SYNC_ACTIONS.UNLINK;if(!a){t.push({op:"updateLastViewed",data:i.relate?{id:i.data.relatedId}:i.data,module:i.relate?i.data.relatedModule:i.module,options:i})}if(i.method!=="delete"){t.push({op:"markToBeSynced",data:{action:"update",record:{id:i.relate?i.data.relatedId:i.data.id}},module:i.relate?i.data.relatedModule:i.module})}}this.exec(t,i.dbSuccess,i.dbFailure)},_executeSynchronized:function(e){this._execQueue.push(e)},init:function(e){this.computeOfflineMeta(e);this._init(e);if(!this._execQueue){this.initExecQueue()}},initExecQueue:function(){var e=this;this._execQueue=async.queue(function(t,i){t.call(e,i)},1)},_init:function(e){},computeOfflineMeta:function(e){_.each(e.modules,function(e,t){this.offlineMeta[t]={}},this);this.prepareOfflineRelationships(e.relationships);this.offlineMeta.modules=e.modules;_.each(e.modules,function(t,i){var n=this.offlineMeta[i];n.fields=this._getOfflineModuleFields(t,n);n.searchFields=this._getOfflineModuleSearchFields(e,t,n)},this)},_getOfflineModuleFields:function n(e,t){var i=_.pluck(e.fields,"name");var n=_.union(["date_modified"],t.oneToManyRelFields,i);var r=[{type:"boolean",name:"my_favorite"},{type:"boolean",name:"following"},{type:"date",name:"_last_fetched"}];var a=_.where(e.fields,{link_type:"relationship_info"});_.each(a,function(e){_.each(e.relationship_fields,function(e,i){t.fieldsBlacklist=t.fieldsBlacklist||[];if(i!=="id"&&!_.contains(t.fieldsBlacklist,e)){t.fieldsBlacklist.push(e)}})});_.each(e.fields,function(e){if(_.isObject(e)&&e.type!=="link"&&e.name!=="id"&&!_.contains(t.fieldsBlacklist,e.name)&&!_.findWhere(r,{name:e.name})&&_.contains(n,e.name)){r.push(e)}},this);return r},_getOfflineModuleSearchFields:function r(e,t,i){var n=e.server_info,r=n&&n.fts&&n.fts.enabled&&t.ftsEnabled;return _.select(i.fields,function(e){return e.unified_search||e.name==="name"||r&&e.full_text_search&&e.full_text_search.enabled},this)},prepareOfflineRelationships:function a(e){var t={};_.each(e,function(e,i){if(i==="_hash"||e.relationship_type==="user-based"){return false}var n=this.getRelationshipType(e);var r=n===this.relTypes.ONE_TO_MANY||n===this.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN?"_wrapOneToManyRelationship":"_wrapManyToManyRelationship";t[i]=this[r](e,n);t[i].type=n},this);this.offlineMeta.relationships=_.extend({},this.offlineMeta.relationships,t)},getRelationshipType:function(e){if(!_.isEmpty(e["join_table"])){return this.relTypes.MANY_TO_MANY}else if(_.isEmpty(e["join_table"])&&_.isEmpty(e["relationship_role_column"])){return this.relTypes.ONE_TO_MANY}else if(_.isEmpty(e["join_table"])&&!_.isEmpty(e["relationship_role_column"])){return this.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN}},getRelationshipByLink:function(t,i){var n=e.metadata.getModule(t).fields[i].relationship;return this.getAdjustedRelationship(t,n)},getAdjustedRelationship:function s(e,t){var i=this.offlineMeta.relationships[t];if(!i){return null}var n=i.type===this.relTypes.MANY_TO_MANY&&e===i.parentModule;if(n){i=_.extend({},i,{parentModule:i.childModule,childModule:i.parentModule,parentIdColumn:i.childIdColumn,childIdColumn:i.parentIdColumn})}return i},getCUTransactionParams:function(t,i,n){var r,a,s,o,l=null,u=null,f=n.txId||e.utils.generateUUID(),c=e.utils.getTimestamp(null,{msecPrecision:true});if(n.relate){r=i.relatedId;a=i.relatedModule;s=i.id;o=t;l=i.link;if(n.action===e.offline.SYNC_ACTIONS.UNLINK){u={before:{module:i.relatedModule,id:i.relatedId},after:null}}else if(n.action===e.offline.SYNC_ACTIONS.LINK){var d=this.getRelationshipByLink(t,i.link);if(d.type===this.relTypes.MANY_TO_MANY){u={before:null,after:{module:i.relatedModule,id:i.relatedId}}}else{var p=n.initialState[d.parentIdColumn],h=d.type===this.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN;if(p){u={before:{module:h?n.initialState["parent_type"]:t,id:h?n.initialState["parent_id"]:n.initialState[d.parentIdColumn]},after:{module:i.relatedModule,id:i.relatedId}}}else{u={before:null,after:{module:i.relatedModule,id:i.relatedId}}}}}else{u=e.offline.utils.getBeforeAndAfter(i.related,n.initialState)}}else{r=i.id;a=t;s=null;o=null;if(n.action!==e.offline.SYNC_ACTIONS.DELETE){u=e.offline.utils.getBeforeAndAfter(i,n.initialState)}}if(u){u=JSON.stringify(u)}return[n.action,c,r,a,s,o,u,f,l]},_wrapOneToManyRelationship:function(t,i){var n=this._getParentModule(t),r=this._isParentOnRight(n,t),a=r?t.lhs_key:t.rhs_key,s=r?t.lhs_module:t.rhs_module,o=this.offlineMeta[s],l="parent_type";o.oneToManyRelFields=o.oneToManyRelFields||[];if(!_.contains(o.oneToManyRelFields,a)){o.oneToManyRelFields.push(a)}if(i===this.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN&&!_.contains(o.oneToManyRelFields,l)){o.oneToManyRelFields.push(l)}return{name:t.name,parentModule:n,childModule:s,parentIdColumn:a,parentNameFieldDef:e.data.getRelatedNameField(s,a)}},_wrapManyToManyRelationship:function(t){var i=this._getParentModule(t);var n=this.offlineMeta[i];var r=this._isParentOnRight(i,t);var a=r?t.lhs_module:t.rhs_module;var s=r?t.lhs_table:t.rhs_table;var o=e.metadata.getModule(i,"fields");var l={};var u=_.findWhere(o,{link_type:"relationship_info",link:s});if(u){l=_.omit(u.relationship_fields,"id")}var f={name:t.name,parentModule:i,relationshipTable:t.join_table,childModule:a,childIdColumn:r?t.join_key_rhs:t.join_key_lhs,parentIdColumn:r?t.join_key_lhs:t.join_key_rhs,childKey:r?t.lhs_key:t.rhs_key,parentKey:r?t.rhs_key:t.lhs_key,additionalColumns:l,singleModule:t.lhs_module===t.rhs_module,originalType:t.relationship_type};if(t.primary_flag_column){f.primaryFlagModule=t.primary_flag_side==="rhs"?t.lhs_module:t.rhs_module;f.link=t[t.primary_flag_side+"_table"]}return f},_isParentOnRight:function(e,t){var i=this.getRelationshipType(t);if(i===this.relTypes.MANY_TO_MANY){return e===t.rhs_module}else{return t.rhs_key==="id"}},_getModuleRelationships:function(t){var i=e.metadata.getModule(t),n=e.offline.utils.getOfflineModules(),r=[];_.each(i.fields,function(e){if(e.type==="link"){var i=this.getAdjustedRelationship(t,e.relationship);if(i&&_.contains(n,i.parentModule)&&_.contains(n,i.childModule)){r.push(i)}}},this);return r},_shouldCustomRelUpdateChild:function(e,t){return e.originalType===this.relTypes.ONE_TO_MANY&&!t.skipUpdateRelRecord||e.originalType===this.relTypes.ONE_TO_ONE||!!e.primaryFlagModule},_getParentModule:function(e){return e.rhs_key==="id"?e.rhs_module:e.lhs_module},openDb:function(e,i,n){t()},migrate:function(e,i,n){t()},isEncryptionSupported:function(){return false},encrypt:function(e,i){t()},upgrade:function(t,i,n){n=n||{};var r=parseInt(this.getSqlStorageVersion(),10),a=parseInt(e.cache.get("offline:version"),10),s=r-a,o,l=[],u=n.success||function(){},f=n.error||function(){};if(!s){e.logger.debug("Version has not changed. No actual upgrade required");u(t,i);return}i=this._getUpgradedMeta(i);while(s--){o=a+s;if(this._upgrade[o]){l.unshift(this._upgrade[o](t))}}if(_.isEmpty(l)){e.logger.debug("Storage structure has not changed");u(t,i)}else{this._runUpgrade(_.flatten(l),function c(){u(t,i)},function d(e){f(e)})}},_runUpgrade:function(e,i,n){t()},_getUpgradedMeta:function(t){var i={modules:{},relationships:t.relationships,_hash:t.hash,_userId:t.userId};delete t.relationships;delete t.hash;delete t.userId;_.chain(t).omit(e.config.offline.exclude).each(function(e,t){i.modules[t]={_hash:e.hash,fields:{_hash:e.fieldsHash}}});return i},drop:function(e){t()},getDetails:function(){return{type:e.config.offline.storageAdapter}},isOutOfSpace:function(e){this._isOutOfSpace(e)},open:function(t){t=_.extend({env:"dev",name:"sidecar",size:5,version:"1.0"},t);var i=t.name+"-"+t.env,n=t.size*1024*1024,r=t.version;try{this.openDb(i,r,n)}catch(a){e.logger.fatal("Failed to open database: "+i+" "+r+" ("+n+" bytes). "+a);return false}return true},sync:function(t,i,n,r){this._executeSynchronized(function(a){var s=this;e.logger.trace("storageAdapter: "+t+"-"+n+(i&&i.id?"-"+i.id:""));r=_.extend({regularSync:true,method:t,dbSuccess:function l(e){a();if(r.success)r.success(e);if(r.complete)r.complete(e)},dbFailure:function u(e){a();if(r.error)r.error(e);if(r.complete)r.complete(e)}},r||{});switch(t){case"read":r.dbSuccess=function f(e){a();if(r.success){e=s._parseReadSuccessResponse(i,n,e,r)}if(r.complete)r.complete(e)};var o=i&&i.link?i.relatedId:i?i.id:null;if(o){this._readSimpleOrRelated(n,i,r)}else{if(r.relate){this._readManyRelatedRecords(n,i,r)}else if(n==="TxLog"){this._readTxLogRecords(n,i,r)}else{this._readManyRecords(n,r)}}break;case"create":if(r.relate){this._createRelatedRecord(n,i,r)}else{this._createRecord(n,i,r)}break;case"update":if(r.relate){this._updateRelatedRecord(n,i,r)}else{this._updateRecord(n,i,r)}break;case"delete":if(r.relate){this._unlinkRecord(n,i,r)}else if(r.hardDelete){this._hardDeleteRecord(n,i,r)}else{this._softDeleteRecord(n,i,r)}break;case"favorite":this._favorite(n,i,r);break;case"follow":this._follow(n,i,r);break;case"search":r.max_num=r.max_num||e.config.maxQueryResult;if(r.module_list.split(",").length>1){r=_.omit(r,"offset");r.max_num=e.config.offline.maxMixedCollectionQueryResult||30}r.dbSuccess=function c(e){a();if(r.success)r.success(e);if(r.complete)r.complete(e)};this._search(r);break;default:break}})},_parseReadSuccessResponse:function(e,t,i,n){if(i){var r=false;if(n.relate){r=_.isEmpty(e.relatedId)}else{r=_.isUndefined(e)}if(r&&!_.isArray(i)){i=[i]}else if(!r&&_.isArray(i)){i=i[0]}}n.success(i);return i},_readTxLogRecords:function(e,t,i){i=_.extend({limit:i.max_num,count:true,errFirst:true},i||{});this.exec([{op:"readTransactions",bean:null,data:t,options:i}],i.dbSuccess,i.dbFailure)},saveRecords:function(e){var t=e.serverData,i=this;if(!(t instanceof Array)){t=[t]}this._executeSynchronized(function(n){var r=_.map(t,function(t){return function(n){i._saveRecord({data:t,module:e.module||t._module,callback:n,ignoreRecordDirtiness:e.ignoreRecordDirtiness,relationshipData:e.relationshipData})}});async.series(r,function(t){n();e.callback(t)})})},_saveRecord:function(t){var i=t.callback,n=t.relationshipData,r=this;async.waterfall([function a(e){r.exec([{op:"readSingle",data:{id:t.data.id},module:n?n.relatedModule:t.module,options:{readDeleted:true}}],function(t){e(null,t)},e)},function s(i,a){var s=[],o=i?e.offline.utils.actionToString(e.offline.SYNC_ACTIONS.UPDATE):e.offline.utils.actionToString(e.offline.SYNC_ACTIONS.CREATE);if(t.ignoreRecordDirtiness||!(i&&!e.offline.utils.isDataSynchronized(i))){var l=t.data;if(l.date_modified){l._client_date_modified=l.date_modified}l._last_fetched=e.utils.getTimestamp();s=[{op:o,module:n?n.relatedModule:t.module,data:l,options:{initialState:i}}];if(n){var u=_.clone(n);_.extend(u,{related:t.data,relatedId:t.data.id});s.push({op:"createLink",module:t.module,data:u,options:{ts:e.utils.getTimestamp(l.date_modified)}})}}if(s.length>0){r.exec(s,a,a)}else{a()}}],i)},resolveSuccess:function(e){this._executeSynchronized(function(t){this._resolveTransaction({transaction:e.transaction,module:e.module,serverData:e.serverData,relationshipData:e.relationshipData,callback:function(){t();if(e.callback){e.callback.apply(this,arguments)}}})})},_resolveTransaction:function(t){var i=t.callback,n=t.relationshipData,r=false,a=false,s=e.utils.getTimestamp(),o=this;async.waterfall([function l(e){o.exec([{op:"countAssociatedTransactions",options:{txData:t.transaction}}],function(t){r=t&&t.count>0;e()},e)},function u(e){if(!n){e();return}o.exec([{op:"countAssociatedTransactions",options:{txData:{_tx_uid:t.transaction._tx_uid,_tx_bean_id:t.transaction._tx_related_id}}}],function(t){a=t&&t.count>0;e()},e)},function f(e){o.exec([{op:"readSingle",data:{id:t.serverData.id},module:n?n.relatedModule:t.module,options:{readDeleted:true}}],function(t){e(null,t)},e)},function c(i,l){var u=t.transaction,f=u._tx_action,c=u._tx_bean_module;if(f===e.offline.SYNC_ACTIONS.CREATE){f=e.offline.SYNC_ACTIONS.UPDATE}var d=[{op:"deleteTransaction",data:null,module:null,options:{txId:u._tx_uid}}];function p(e){d.push({op:"updateValuesSingle",data:_.pick(e,"id","date_modified"),module:c})}if(n){if(f===e.offline.SYNC_ACTIONS.UPDATE||f===e.offline.SYNC_ACTIONS.LINK||f===e.offline.SYNC_ACTIONS.UNLINK){if(!_.isEmpty(n.related)){if(!r){n.related._last_fetched=s;d.push({op:"updateValuesSingle",module:n.relatedModule,data:n.related});d.push({op:"resetDateModified",data:{id:n.related.id},module:n.relatedModule})}else{p(n.related)}}if(n.record&&!a){n.record._last_fetched=s;d.push({op:"updateValuesSingle",module:n.recordModule,data:n.record});d.push({op:"resetDateModified",data:{id:n.record.id},module:n.recordModule})}}if(f===e.offline.SYNC_ACTIONS.UNLINK&&!a&&!r){d.push({op:"deleteLink",module:n.recordModule,data:{id:n.id,link:n.link,related:n.related,relatedId:n.relatedId,relatedModule:n.relatedModule},options:{hardDelete:true}})}}else{if(f===e.offline.SYNC_ACTIONS.DELETE){d.push({op:"hardDeleteSingle",module:c,data:t.serverData});d.push({op:"deleteLastViewed",data:t.serverData,module:c})}else if(!r){t.serverData._last_fetched=s;d.push({op:e.offline.utils.actionToString(f),data:t.serverData,module:c});d.push({op:"resetDateModified",data:{id:t.serverData.id},module:c})}else{p(t.serverData)}}o.exec(d,function h(){e.trigger("offline:tx:success",{tx:u});l()},function g(e){l(e)})}],i)},resolveError:function(t){var i,n,r;if(t.nonTransactionResolve&&!(t.error.status===404||t.error.status===403)){t.callback();return}if(!e.utils.isConnectivityError(t.error)&&!t.nonTransactionResolve){e.trigger("offline:tx:error",{tx:t.txLog,errorCode:t.error.status})}switch(t.error.status){
case 0:if(t.callback){_.defer(t.callback,t.error)}break;case 409:t.error.record=t.error.record||t.error.payload&&t.error.payload.record||{};var a=t.txLog,s=e.offline.utils.getOfflineModules(),o=[];if(!_.contains(s,a._tx_bean_module)||_.isEmpty(e.utils.getChangedProps(t.updatedFields,t.error.record))){o.push({op:"deleteTransaction",options:{txId:a._tx_uid}})}else{var l={op:"updateValuesSingle",data:null,module:a._tx_bean_module};o=[l,{op:"updateTransaction",data:{txLog:_.extend(_.clone(a),{_tx_error_count:a._tx_error_count+1,_tx_error:t.error.status})}}]}this._executeSynchronized(function(i){var n=function(e){i();if(t.callback){t.callback(e)}};if(l){this.exec([{op:"countAssociatedTransactions",options:{txData:a}}],_.bind(function(i){if(i&&i.count>0){l.data=_.pick(t.error.record,"id","date_modified")}else{l.data=e.utils.deepCopy(t.error.record);l.data._last_fetched=e.utils.getTimestamp()}this.exec(o,n,n)},this),n)}else{this.exec(o,n,n)}});break;case 404:if(t.nonTransactionResolve){if(t.nonTransactionResolve.relate){i=[{op:"deleteLink",module:t.nonTransactionResolve.module,data:t.nonTransactionResolve.data}]}else{i=[{op:"hardDeleteSingle",module:t.nonTransactionResolve.module,data:{id:t.nonTransactionResolve.id}}]}}else{n=t.txLog._tx_bean_module,r=t.txLog._tx_bean_id;i=[{op:"hardDeleteSingle",module:n,data:{id:r}}];i.push({op:"deleteTransaction",data:null,module:null,options:{txId:t.txLog._tx_uid}})}this._executeSynchronized(function(e){this.exec(i,function(){e();if(t.callback){t.callback()}},function(i){e();if(t.callback){t.callback(i)}})});break;case 422:if(t.txLog){i=[{op:"deleteTransaction",data:null,module:null,options:{txId:t.txLog._tx_uid}},{op:"updateValuesSingle",data:{id:t.txLog._tx_bean_id,date_modified:t.txLog._tx_ts,_client_date_modified:t.txLog._tx_ts},module:t.txLog._tx_bean_module}]}this._executeSynchronized(function(e){this.exec(i,function(){e();if(t.callback){t.callback()}},function(i){e();if(t.callback){t.callback(i)}})});break;case 403:var u;if(t.nonTransactionResolve){n=t.relate?t.nonTransactionResolve.data.relatedModule:t.nonTransactionResolve.module;var f=t.relate?t.nonTransactionResolve.data.id:t.nonTransactionResolve.id;u={op:"hardDeleteSingle",module:n,data:{id:f},options:{skipRelationshipsClean:true}}}else{u={op:"updateTransaction",data:{txLog:_.extend(t.txLog,{_tx_error_count:++t.txLog._tx_error_count,_tx_error:t.error.status})}}}this._executeSynchronized(function(e){this.exec([u],function(){e();if(t.callback){t.callback(t.nonTransactionResolve?null:t.error)}},function(i){e();if(t.callback){t.callback(i)}})});break;case 500:default:this._executeSynchronized(function(e){this.exec([{op:"updateTransaction",data:{txLog:_.extend(t.txLog,{_tx_error_count:++t.txLog._tx_error_count,_tx_error:t.error.status})}}],function(){e();if(t.callback){t.callback(t.error)}},function(i){e();if(t.callback){t.callback(i)}})});break}},rollbackTransaction:function(t,i,n){i=i||{};var r=this;this._executeSynchronized(function(a){this.exec([{op:"countAssociatedTransactions",options:{txData:t}}],function(s){i.resetDirty=!s||s.count===0;var o=[{op:"deleteTransaction",options:{txId:t._tx_uid}}];var l;if(t._tx_action===e.offline.SYNC_ACTIONS.UPDATE){l=r._getRollbackUpdateTasks}else if(t._tx_action===e.offline.SYNC_ACTIONS.CREATE){l=r._getRollbackCreateTasks}else if(t._tx_action===e.offline.SYNC_ACTIONS.DELETE){l=r._getRollbackDeleteTasks}else if(t._tx_action===e.offline.SYNC_ACTIONS.FAVORITE){l=r._getRollbackFavoriteTasks}else if(t._tx_action===e.offline.SYNC_ACTIONS.FOLLOW){l=r._getRollbackFollowTasks}else if(t._tx_action===e.offline.SYNC_ACTIONS.UNLINK){l=r._getRollbackUnlinkTasks}else if(t._tx_action===e.offline.SYNC_ACTIONS.LINK){l=r._getRollbackLinkTasks}l=_.bind(l,r);o=o.concat(l(t,i));r.exec(o,function u(){a();e.trigger("offline:tx:rollback",{tx:t});n()},function f(e){a();n(e)})},function s(e){a();n(e)})})},_getRollbackUpdateTasks:function(e,t){var i=this._getTxUpdatedFields(e),n=e._tx_bean_module,r={id:e._tx_bean_id};_.each(i,function(e,t){r[t]=e.before},this);var a=[{op:"updateValuesSingle",data:r,module:n,options:t}];if(t.resetDirty){a.push({op:"resetDateModified",module:n,data:r})}return a},_getRollbackCreateTasks:function(e,t){return[{op:"hardDeleteSingle",data:{id:e._tx_bean_id},module:e._tx_bean_module,options:t}]},_getRollbackDeleteTasks:function(e){return[{op:"resetDeletedSingle",data:{id:e._tx_bean_id},module:e._tx_bean_module}]},_getRollbackFavoriteTasks:function(e,t){var i=this._getTxUpdatedFields(e),n=e._tx_bean_module;var r={id:e._tx_bean_id,my_favorite:i.my_favorite.before};if(i.following){r.following=i.following.before}var a=[{op:"updateValuesSingle",data:r,module:n,options:t}];if(t.resetDirty){a.push({op:"resetDateModified",module:n,data:{id:e._tx_bean_id}})}return a},_getRollbackFollowTasks:function(e,t){var i=this._getTxUpdatedFields(e),n=e._tx_bean_module;var r=[{op:"updateValuesSingle",data:{id:e._tx_bean_id,following:!!i.following.before},module:n,options:t}];if(t.resetDirty){r.push({op:"resetDateModified",module:n,data:{id:e._tx_bean_id}})}return r},_getRollbackUnlinkTasks:function(e,t){var i=[{op:"createLink",module:e._tx_related_module,data:{id:e._tx_related_id,link:e._tx_link,related:{id:e._tx_bean_id},relatedId:e._tx_bean_id,relatedModule:e._tx_bean_module}}];if(t.resetDirty){i.push({op:"resetDateModified",module:e._tx_bean_module,data:{id:e._tx_bean_id}})}return i},_getRollbackLinkTasks:function(e,t){var i=this._getTxUpdatedFields(e),n;if(i.before){n=[{op:"createLink",module:i.before.module,data:{id:i.before.id,link:e._tx_link,related:{id:e._tx_bean_id},relatedId:e._tx_bean_id,relatedModule:e._tx_bean_module}}]}else{n=[{op:"deleteLink",module:e._tx_related_module,data:{id:e._tx_related_id,link:e._tx_link,related:{id:e._tx_bean_id},relatedId:e._tx_bean_id,relatedModule:e._tx_bean_module}}]}if(t.resetDirty){n.push({op:"resetDateModified",module:e._tx_bean_module,data:{id:e._tx_bean_id}})}return n},_getTxUpdatedFields:function(e){return _.isString(e._tx_updated_fields)?JSON.parse(e._tx_updated_fields):e._tx_updated_fields},readSingleRawRecord:function(e,t,i){this._executeSynchronized(function(n){this.exec([{op:"readSingle",data:t,module:e,options:_.extend(i,{readDeleted:true})}],function r(){n();if(i.success){i.success.apply(this,arguments)}},function a(){n();if(i.error){i.error.apply(this,arguments)}})})},readRecordsByIds:function(e,t,i){this._executeSynchronized(function(n){this.exec([{op:"readModuleRecords",data:{id:t},module:e}],function r(){n();if(i.success){i.success.apply(this,arguments)}},function a(){n();if(i.error){i.error.apply(this,arguments)}})})},readTransactions:function(e,t){this._executeSynchronized(function(i){this.exec([{op:"readTransactions",bean:null,data:t,options:e}],function n(t){i();if(e.success){e.success.apply(this,arguments)}},function r(){i();if(e.error){e.error.apply(this,arguments)}})})},getStats:function(t){t=t||{};t=_.defaults(t,{modules:e.offline.utils.getOfflineModules(),success:function(t){e.logger.debug(t)},error:function(t){e.logger.error("getStats failed. "+t)}});var i={count:{},viewed:{}},n=this;this._executeSynchronized(function(e){async.series([function r(e){n.getRecordsCount(t,function(t,n){_.each(n,function(e,t){if(t.indexOf("_Viewed")!==-1){i.viewed[t.replace("_Viewed","")]=e;delete n[t]}});i.count=n;e(t,n)})},function a(e){n.getStorageSize(t,function(t,n){if(!t){_.extend(i,n)}e(t,n)})}],function s(n){e();if(n){t.error(n)}else{t.success(i)}})})},getRecordsCount:function(e,t){this.exec([{op:"getStats",data:null,module:null,options:e}],function(e){t(null,e)},t)},_NO_STORAGE_INFO:{dbSize:-1,totalDiskSpace:-1,freeDiskSpace:-1},getStorageSize:function(e,t){t(null,_.clone(this._NO_STORAGE_INFO))},compact:function(t){t=t||{};var i=(new Date).getTime(),n=new Date(i-1e3*60*60*24*(e.config.offline.defaultPurgeInterval||7)),r=this;var a=_.keys(e.config.offline.prefetch.staticModules||[]),s=_.filter(e.offline.utils.getOfflineModules(),function(e){return!_.contains(a,e)});t=_.defaults(t,{modules:s,expirationDate:e.utils.getTimestamp(n),callback:function(t){e.logger.debug(t||"Offline DB cleaning up completed")}});var o=[];if(t.flushTransactions){o.push(function l(e){r.exec([{op:"clearTransactionLog"}],function(){e()},e)})}_.each(t.modules,function(e){o.push(function(i){r._cleanUpModule(e,t.expirationDate,i)})});this._executeSynchronized(function(i){async.series(o,function(n){i();if(n){e.logger.error("Failed to clean up database. "+n)}t.callback(n)})})},_cleanUpModule:function(e,t,i){var n=this;async.waterfall([function r(i){n.exec([{op:"findViewedBefore",module:e,options:{expirationDate:t}}],function(e){i(null,e)},i)},function a(t,i){if(_.isEmpty(t)){return i()}var r=[];t=_.isArray(t)?t:[t];_.each(t,function(t){r.push(function(i){n._hardDeleteRecord(e,{id:t.id},{skipOneToManyChildren:true,dbSuccess:function(){i()},dbFailure:function(e){i(e)}})})});async.series(r,i)}],function s(e,t){i(e)})},_favorite:function(t,i,n){n.action=e.offline.SYNC_ACTIONS.FAVORITE;i={id:i.id,my_favorite:i.my_favorite,_client_date_modified:n.ts};if(i.my_favorite){i.following=true}this.execAndSpecificReturn([{op:"updateValuesSingle",data:i,module:t,options:n}],_.extend({data:i,module:t},n))},_follow:function(t,i,n){n.action=e.offline.SYNC_ACTIONS.FOLLOW;this.execAndSpecificReturn([{op:"updateValuesSingle",data:{id:i.id,following:i.following,_client_date_modified:n.ts},module:t,options:n}],_.extend({data:i,module:t},n))},_updateRecord:function(t,i,n){n.action=e.offline.SYNC_ACTIONS.UPDATE;i._client_date_modified=n.ts;if(e.offline.utils.isRecordAssignedToLoginUser(i)){i.following=true}this.execAndSpecificReturn([{op:"updateValuesSingle",data:i,module:t,options:n}],_.extend({data:i,module:t},n))},_updateRelatedRecord:function(t,i,n){n.action=e.offline.SYNC_ACTIONS.UPDATE;i.related._client_date_modified=n.ts;if(e.offline.utils.isRecordAssignedToLoginUser(i.related)){i.related.following=true}var r=[{op:"updateValuesSingle",data:i.related,module:i.relatedModule,options:n}];var a=this.getRelationshipByLink(t,i.link),s=this.getRelationshipType(a);var o=e.data.getRelationshipFields(t,i.link),l=!_.isEmpty(_.pick(i.related,o));if(s===this.relTypes.MANY_TO_MANY&&l){r.push({op:"createLink",module:t,data:i,options:n})}this.execAndSpecificReturn(r,_.extend({data:i,module:t},n))},_createRecord:function(t,i,n){i.id=i.id||e.utils.generateUUID();i.date_entered=i._client_date_modified=n.ts;if(e.offline.utils.isRecordAssignedToLoginUser(i)){i.following=true}n.action=e.offline.SYNC_ACTIONS.CREATE;this.execAndSpecificReturn([{op:"createSingle",data:i,module:t,options:n}],_.extend({data:i,module:t},n))},_createRelatedRecord:function(t,i,n){var r=this;i.related._client_date_modified=n.ts;if(i.relatedId){var a=function(){n.action=e.offline.SYNC_ACTIONS.LINK;r.execAndSpecificReturn([{op:"createLink",module:t,data:i,options:n}],_.extend({data:i,module:t},n))};var s=function(e){var t=e[0],i=e[1];if(!_.isEmpty(i)){return n.dbSuccess({record:t,relatedRecord:i})}else{a()}};var o=e.offline.storage.getRelationshipByLink(t,i.link),l=e.offline.storage.getRelationshipType(o);if(l===e.offline.storage.relTypes.MANY_TO_MANY){r.exec([{op:"readSingle",data:i,module:t,options:_.extend(n,{readDeleted:true})},{op:"readSingleRelated",module:t,data:i,options:n}],s,n.dbFailure)}else{a()}}else{var u=e.utils.generateUUID();i.relatedId=i.related.id=u;n.action=e.offline.SYNC_ACTIONS.CREATE;if(e.offline.utils.isRecordAssignedToLoginUser(i.related)){i.related.following=true}this.execAndSpecificReturn([{op:"createSingle",module:i.relatedModule,data:i.related,options:n},{op:"createLink",module:t,data:i,options:n}],_.extend({data:i,module:t},n))}},_softDeleteRecord:function(t,i,n){n.action=e.offline.SYNC_ACTIONS.DELETE;this.execAndSpecificReturn([{op:"createTransaction",module:t,data:i,options:n},{op:"softDeleteSingle",module:t,data:i,options:n}],_.extend({data:i,module:t},n))},_hardDeleteRecord:function(t,i,n){n.action=e.offline.SYNC_ACTIONS.DELETE;this.execAndSpecificReturn([{op:"hardDeleteSingle",module:t,data:i,options:n},{op:"deleteLastViewed",data:i,module:t}],_.extend({data:i,module:t},n))},_unlinkRecord:function(t,i,n){n.action=e.offline.SYNC_ACTIONS.UNLINK;var r=[{op:"deleteLink",module:t,data:i,options:n}];if(!n.hardDelete){r.push({op:"createTransaction",module:t,data:i,options:n})}this.execAndSpecificReturn(r,_.extend({data:i,module:t},n))},_readSimpleOrRelated:function(e,t,i){var n={op:i.relate?"readSingleRelated":"readSingle",data:t,module:e,options:i};var r=[n];if(this._shouldUpdateLastViewedDate(i)){r.splice(0,0,{op:"updateLastViewed",data:i.relate?{id:t.relatedId}:t,module:i.relate?t.relatedModule:e,options:i});r.splice(0,0,{op:"markToBeSynced",module:i.relate?t.relatedModule:e,data:{action:"update",record:{id:i.relate?t.relatedId:t.id}}})}this.exec(r,i.dbSuccess,i.dbFailure)},_readManyRecords:function(e,t){this.exec([{op:"readMany",module:e,options:t}],t.dbSuccess,t.dbFailure)},_readManyRelatedRecords:function(e,t,i){this.exec([{op:"readManyRelated",module:e,data:t,options:i}],i.dbSuccess,i.dbFailure)},_search:function(e){if(_.isString(e.order_by)){e.order_by=e.order_by.replace("date_modified","_client_date_modified")}this.exec([{op:"search",options:e}],e.dbSuccess,e.dbFailure)},_shouldUpdateLastViewedDate:function(e){return e&&e.viewed},fillTxLogData:function(e,t){_.each(e,function(e){if(e._tx_updated_fields){e._tx_updated_fields=JSON.parse(e._tx_updated_fields)}});var i={};function n(e,t){var n=e["_tx_"+t+"_module"];if(!n){return}if(!_.has(i,n)){i[n]=[]}i[n].push(e["_tx_"+t+"_id"])}_.each(e,function(e){n(e,"bean");n(e,"related")});function r(e,t,i){var n=e["_tx_"+t+"_id"];if(!n){return}var r=e["_tx_"+t+"_module"];if(!_.isArray(i[r])){e[t]=i[r]}else{e[t]=_.find(i[r],function(e){return e.id===n})}}this._executeSynchronized(function(n){this.readModuleRecords(i,function(i,a){n();if(!i){_.each(e,function(e){r(e,"bean",a);r(e,"related",a)})}t(i,e)})})},readModuleRecords:function(e,t,i){var n=this;_.each(e,function(t,i){var r={op:"readModuleRecords",module:i,data:{id:t},options:{}};e[i]=function(e){n.exec([r],function(t){e(null,t)},e)}});async.parallel(e,t)},markToBeSynced:function(e){this.exec([{op:"markToBeSynced",module:e.module,data:{action:e.action,record:e.record}}],e.callback,e.callback)},resetToBeSynced:function(e){this.exec([{op:"resetToBeSynced",module:e.module,data:{records:e.records}}],e.callback,e.callback)},readToBeSynced:function(e){this.exec([{op:"readToBeSynced",module:e.module,options:e}],function(t){t=t||[];if(!_.isArray(t)){t=[t]}e.callback({records:t})},e.callback)},updateLastViewed:function(e,t){this.exec([{op:"updateLastViewed",data:e,module:t.module,options:t}],t.callback,t.callback)}}})(SUGAR.App)},356:function(e,t){(function(e){var t={},i={},n,r,a=["email","teamset","multienum","metadata","json","tag"];function s(e){return _.isEmpty(e)||_.isEmpty(e.fields)&&_.isEqual(_.keys(e),["fields"])}function o(t,i){if(t.code===4){return e.offline.Error.OutOfSpaceError}return new e.offline.Error(t.code,t.message,null,t,i)}function l(i,n){var r=[n.id,n._client_date_modified?e.utils.getTimestamp(n._client_date_modified):undefined,n._deleted==1?1:0,s(n._acl)?null:JSON.stringify(n._acl)],a=e.metadata.getModule(i).fields;_.each(t[i].fields,function(e){r.push(u(n[e.name],e.name,i,a))});return r}function u(t,n,r,a){var o=a[n];if(n==="_acl"){t=s(t)?null:JSON.stringify(t)}else if(n==="_deleted"){t=t==1?1:0}else if(_.isUndefined(t)){t=null}else if(_.isBoolean(t)){t=t?1:0}else if(_.contains(i[r],n)){t=JSON.stringify(t)}else if(n==="_client_date_modified"||t&&o&&(o.type==="datetime"||o.type==="datetimecombo")&&!isNaN(Date.parse(t))){t=e.utils.getTimestamp(t)}if(o&&(t||t===0)&&e.offline.SqlHelper.getSqlTypeByMetaType(o.type)===e.offline.SqlHelper.DEFAULT_TEXT_COLUMN_TYPE){t=String(t)}return t}_.extend(e.offline.storage,{_version:"2.0",_getValues:l,_getValue:u,_init:function(){t={};i={};e.offline.SqlHelper.init(this.offlineMeta);_.each(this.offlineMeta.modules,function(n,r){t[r]=new e.offline.SqlHelper(r,n,this.offlineMeta[r].fields);i[r]=[];_.each(n.fields,function(e){if(_.contains(a,e.type)){i[r].push(e.name)}})},this)},convertFilter:function(t,i){return e.offline.SqlHelper.buildFilterQuery(t,i)},getSqlStorageVersion:function(){return this._version},openDb:function(t,i,a){if(n)return n;n=this._openDb(t,i,a);if(n){r=t}else{throw new Error("`openDatabase` returned nothing")}e.logger.debug("Opened database "+t+" "+i+" ("+a+" bytes)");return n},_openDb:function(t,i,n){if(e.config.offline.storageAdapter==="native"){return window.sqlitePlugin.openDatabase({name:t,bgType:1,encrypt:e.config.offline.dbEncryptionEnabled})}else{return window.openDatabase(t,i,t,n)}},migrate:function(i,n,r){var a=this,s=[],o=false,l=false,u=false;r=r||{};n=n||{modules:{},relationships:{},serverInfo:{}};a.init(i);if(r.forceDrop||_.isEmpty(n)||n._userId!==e.user.get("id")||i.relationships._hash!==n.relationships._hash||n.siteUrl!==e.utils.stripHttpPrefix(e.config.siteUrl)){o=true;l=true;u=true;a._migrationSummary={storageRebuilt:true};_.each(i.modules,function(i,n){if(e.offline.isOfflineEnabled(n)){s.push(t[n].getSchema(n,i))}})}else if(i._hash!==n._hash){var f=_.filter(_.keys(n.modules),function(t){return e.offline.isOfflineEnabled(t)}),c=_.filter(_.keys(i.modules),function(t){return e.offline.isOfflineEnabled(t)}),d=[],p=[];_.each(f,function(t){if(!_.contains(c,t)){d.push(t);s.push(e.offline.SqlHelper.getDropTableStatement(t));s.push(e.offline.SqlHelper.lastViewed.buildCleanupMyModule(t));o=true}},this);_.each(c,function(e){if(!_.contains(f,e)){p.push(e);s.push(t[e].getSchema(e,i.modules[e]));o=true}},this);_.each(i.modules,function(t,r){if(_.contains(p,r)){return}if(n.modules[r]._hash!==t._hash&&t.fields._hash!==n.modules[r].fields._hash){var a=_.difference(_.keys(i.modules[r].fields),_.keys(n.modules[r].fields));_.each(a,function(t){var n=i.modules[r].fields[t];if(_.isEmpty(n.name))return;s.push(e.offline.SqlHelper.getAlterTableStatement(r,n))})}},this)}if(o){e.offline.storage.prepareOfflineRelationships(i.relationships);s.push(e.offline.SqlHelper.relationships.getCreateSchemaStatements(this.offlineMeta.relationships))}if(l){s.push(e.offline.SqlHelper.transactionLog.getCreateSchemaStatements())}if(u){s.push(e.offline.SqlHelper.lastViewed.getCreateSchemaStatements())}s.push(e.offline.SqlHelper.sync.getCreateSchemaStatements());if(s.length===0){e.logger.debug("No actual migration required");return r.success()}this._execRawStatements(_.flatten(s),function h(){if(r.success){r.success()}},function g(e){if(r.error){r.error(e)}})},isEncryptionSupported:function(){return _.isFunction(n.encrypt)},encrypt:function(e,t){n.encrypt(e,t)},_upgrade:{1:function(t){return e.offline.SqlHelper.upgrade.getUpgrade1Sql(t)}},_runUpgrade:function(e,t,i){this._execRawStatements(e,t,i)},_execRawStatements:function(t,i,r){var a;n.transaction(function(i){_.each(t,function(t){a=t;e.logger.trace(t);i.executeSql(t)})},function s(e){if(r){r(o(e),{failedSql:a,transactionSql:t})}},i)},_exec:function(t,i,r){var a=[],s=[],l,u,f=this;_.each(t,function(e){var t=_.clone(e.data),i=_.clone(e.options),n=f._sqlHandlers[e.op](e.module,t,i);if(!n){return}if(!n.module&&e.options){if(e.options.relate&&e.op!=="readSingle"){n.module=e.data.relatedModule}else{n.module=e.module}}if(e.module){l=e.module}s.push(n)});function c(e){return _.any(e,function(e){return _.isArray(e.sql)?c(e.sql):/^\s*(UPDATE|INSERT|REPLACE)/i.test(e.sql)})}if(e.config.offline.debug.outOfSpace&&c(s)){_.defer(function(){if(r){r(o({code:4},{failedSql:{sql:"SELECT 1;",params:[]},transactionSql:s}))}});return}n.transaction(function(t){_.each(s,function(i){function n(i){e.logger.trace("Executing SQL: "+i.sql);e.logger.trace("Params: "+(i.params?i.params:"(no params)"));u=i;t.executeSql(i.sql,i.params,function n(e,t){t=t?f._recordSetToArray(t,i.module||l):[];if(i.module){t=_.map(t,function(e){e._module=i.module;return e})}a=a.concat(t)})}if(_.isArray(i.sql)){_.each(i.sql,n)}else{n(i)}})},function d(e){if(r){r(o(e,{failedSql:{sql:u.sql,params:u.params},transactionSql:s}))}},function p(){if(a.length===1){a=a[0]}else if(a.length===0){a=null}i(a)})},_isOutOfSpace:function(t){var i=this;if(e.config.offline.debug.outOfSpace){_.defer(t,true);return}n.transaction(function(e){var t=i._sqlHandlers["updateTransaction"]("Module",{txLog:{_tx_uid:"tx_id",_tx_error_count:0}});t.sql+=" AND 1 <> 1";e.executeSql(t.sql,t.params)},function(e){t(e.code===4)},function(){t(false)})},drop:function(t){var i=this;n.transaction(function(t){t.executeSql(e.offline.SqlHelper.getSelectTablesStatement(),null,function(t,n){var r=e.offline.SqlHelper.getDropTableStatements(_.map(i._recordSetToArray(n),function(e){return e.tbl_name}));_.each(r,function(e){t.executeSql(e)})})},function r(e){if(t)t(o(e))},function a(){if(t)t()})},_sqlHandlers:{readSingle:function(e,i,n){n=n||{};return t[e]?{sql:n.readDeleted?t[e].sqlSelectOneWithDeleted:t[e].sqlSelectOne,params:[i.id]}:null},search:function(e,i,n){var r=n.module_list.split(","),a=[];_.each(r,function(e){a.push({sql:t[e].buildSqlSelectMany(n),params:null,module:e})});return{sql:a}},readSingleRelated:function(t,i,n){n=n||{};return{sql:e.offline.SqlHelper.relationships.buildSqlSelectSingleRelated(t,i,n),params:null}},readMany:function(e,i,n){return{sql:t[e].buildSqlSelectMany(n),params:null}},readManyRelated:function(t,i,n){return{sql:e.offline.SqlHelper.relationships.buildSqlSelectManyRelated(t,i,n),params:null}},readModuleRecords:function(e,i){return t[e]?{sql:t[e].buildSqlReadModuleRecordsByIds(i.id),params:null}:null},createSingle:function(i,n,r){n.id=n.id||e.utils.generateUUID();var a=l(i,n),s=[],o=this.updateRelationships(i,n,r);s.push({sql:t[i].sqlCreate,params:a});if(!_.isEmpty(o)){s=s.concat(o)}return{sql:s}},resetDateModified:function(i,n){return t[i]?{sql:e.offline.SqlHelper.getResetDateModifiedStatement(i,n)}:null},updateValuesSingle:function(i,n,r){if(_.isEmpty(n.id)){e.error.throwErrorWithCallStack("Undefined id passed to updateValuesSingle")}if(_.isUndefined(t[i])){return null}var a=["id","_client_date_modified","_acl"];_.each(t[i]?t[i].fields:[],function(e){a.push(e.name)});n=_.pick(n,a);var s=[],o=[],l=n.id,f=[],c=e.metadata.getModule(i).fields,d=this.updateRelationships(i,n,r);if(n.name){var p=e.offline.SqlHelper.relationships.buildSqlUpdateChildren(i,n);if(p){_.each(p,function(e){f.push({sql:e,params:null})})}}if(!_.isEmpty(d)){f=f.concat(d)}delete n.id;delete n._module;delete n._search;if(_.isEmpty(n)){return null}_.each(n,function(e,t){o.push(t);s.push(u(e,t,i,c))});s.push(l);f.push({sql:t[i].buildSqlUpdate(l,o),params:s});return{sql:f}},updateRelationships:function(t,i,n){var r=[],a=e.metadata.getModule(t).fields,s={};_.each(i,function(t,i){if(a[i]&&a[i].link&&a[a[i].link]){var n=e.metadata.getRelationship(a[a[i].link].relationship);if(n&&!s[n.name]){s[n.name]=n;s[n.name].create=!!t}}});_.each(s,function(a){var s=a.create?e.offline.SqlHelper.relationships.buildSqlReplaceRelationship:e.offline.SqlHelper.relationships.buildDeleteRelationship,o=a.rhs_module===t?a.lhs_module:a.rhs_module,l=e.offline.storage.offlineMeta.relationships[a.name];if(!l){return false}var u=s.call(e.offline.SqlHelper.relationships,o,{related:i,relatedId:i.id,relatedModule:t,relDef:l},_.extend({},n,{skipUpdateRelRecord:true}));if(u&&!_.isArray(u)){u=[{sql:u}]}if(!_.isEmpty(u)){_.each(u,function(e){r.push({sql:e.sql,params:null})})}},this);return r},hardDeleteSingle:function(i,n,r){var a=[],s=[];r=r||{};if(_.isUndefined(t[i])){return null}if(!r.skipRelationshipsClean){s=e.offline.SqlHelper.relationships.buildSqlCleanRelationships(i,n,r)}var o=s.map(function(e){return{sql:e,params:null}});var l=a.concat({sql:t[i].sqlDelete,params:[n.id]},o);return{sql:l}},softDeleteSingle:function(e,i){return{sql:t[e].sqlMarkDeleted,params:[i.id]}},resetDeletedSingle:function(e,i){return t[e]?{sql:t[e].sqlResetDeleted,params:[i.id]}:null},createLink:function(i,n,r){return t[i]?{sql:e.offline.SqlHelper.relationships.buildSqlReplaceRelationship(i,n,r),params:null}:null},deleteLink:function(i,n,r){return t[i]?{sql:e.offline.SqlHelper.relationships.buildDeleteRelationship(i,n,r),params:null}:null},readTransactions:function(t,i,n){if(i&&i.id){return{sql:e.offline.SqlHelper.transactionLog.getTxLog,params:[i.id]}}else{var r=[{sql:e.offline.SqlHelper.transactionLog.getReadTransactionsStatements(n),params:[n.offset||0,n.limit]}];if(n.count){r.push({sql:e.offline.SqlHelper.transactionLog.countTransactions})}return{sql:r}}},readToBeSynced:function(t,i,n){return{sql:e.offline.SqlHelper.sync.getReadToBeSyncedSql(t,i,n),params:null}},markToBeSynced:function(t,i,n){return{sql:e.offline.SqlHelper.sync.getMarkToBeSyncedSql(t,i,n),params:null}},resetToBeSynced:function(t,i,n){return{sql:e.offline.SqlHelper.sync.getResetToBeSyncedSql(t,i,n),params:null}},createTransaction:function(t,i,n){return{sql:e.offline.SqlHelper.transactionLog.sqlTxLogAction,params:e.offline.storage.getCUTransactionParams(t,i,n)}},updateTransaction:function(t,i,n){var r,a=i.txLog,s=["_tx_updated_fields","_tx_error","_tx_error_count","_tx_ts"];if(n&&n.initialState){r=e.offline.storage.getCUTransactionParams(t,i.updatedFields,{action:a._tx_action,txId:a._tx_uid,initialState:n.initialState,relate:n.relate});a._tx_updated_fields=r[6]}return{sql:e.offline.SqlHelper.transactionLog.updateTransaction(a._tx_uid,_.pick(a,s))}},deleteTransaction:function(t,i,n){return{sql:e.offline.SqlHelper.transactionLog._deleteTransaction,params:[n.txId]}},clearTransactionLog:function(){return{sql:e.offline.SqlHelper.transactionLog.clearTransactionLog}},countAssociatedTransactions:function(t,i,n){return{sql:e.offline.SqlHelper.transactionLog.getCountAssociatedTransactionsStatements(n.txData)}},countTransactions:function(){return{sql:e.offline.SqlHelper.transactionLog.countTransactions}},readLastViewed:function(t,i,n){if(n.ids){return{sql:e.offline.SqlHelper.lastViewed.buildReadForRecords(n.ids)}}return{sql:e.offline.SqlHelper.lastViewed.buildRead(n.desc),params:[n.max_num]}},readRecents:function(t,i,n){return{sql:e.offline.SqlHelper.lastViewed.buildReadForModule(t),params:[n.max_num]}},updateLastViewed:function(t,i,n){return{sql:e.offline.SqlHelper.lastViewed.buildReplace(t,i,n)}},deleteLastViewed:function(t,i,n){return{sql:e.offline.SqlHelper.lastViewed.buildDelete(t,i,n)}},findViewedBefore:function(t,i,n){return{sql:e.offline.SqlHelper.lastViewed.buildFindViewedBefore(t,n)}},getStats:function(t,i,n){return{sql:e.offline.SqlHelper.getStatsRetrieveStatements(n)}}},_deserialize:function(e,t){var n=_.clone(e);_.each(n,function(e,r){if(_.isString(e)&&_.contains(i[t],r)){n[r]=JSON.parse(e)}});if(n._acl){n._acl=JSON.parse(n._acl)}return n},_recordSetToArray:function(e,t){var i=[];if(e){for(var n=0;n<e.rows.length;n++){i.push(this._deserialize(e.rows.item(n),t))}}return i},getDetails:function(){var t=e.offline.storage.getDetails;return function(){return _.extend(t(),{dbName:r})}}()})})(SUGAR.App)},357:function(e,t){(function(e){_.extend(e.offline,{declareOfflineBean:function(){var t=e.data.beanModel.prototype.save;e.OfflineBean=e.data.beanModel.extend({save:function(e,i){if(i&&i.fields&&_.contains(i.fields,"email")){var n,r;n=_.find(this.attributes,function(e,t){return this.fields[t]&&this.fields[t].type==="email"},this);if(n){r=_.find(n,function(e){return e.primary_address});if(r){i.fields.push("email1");this.attributes["email1"]=r.email_address}}}t.apply(this,arguments)}});return e.OfflineBean}})})(SUGAR.App)},358:function(e,t){(function(e){_.extend(e.offline,{declareOfflineBeanCollection:function(){var t=e.data.beanCollection;e.OfflineBeanCollection=e.data.beanCollection.extend({initialize:function(e,i){this.cid=_.uniqueId("c");t.prototype.initialize.apply(this,arguments)},fetch:function(e){this._handleFetchWithQuery(this._mergeCollection,e);return t.prototype.fetch.call(this,e)},_handleFetchWithQuery:function i(e,t){t=t||{};t.params=t.params||{};if(t.params.q){t.params.serverSyncSuccess=_.bind(e,this)}},_mergeCollection:function(t,i){var n=t.records,r=t.next_offset;var a=_.filter(n,function(t){var i=this.get(t.id);return!(i&&!e.offline.utils.isDataSynchronized(i))},this);this.update(a,{remove:false});this.offset=r!==-1?r:this.offset+(n||[]).length;this.next_offset=r}});return e.OfflineBeanCollection}})})(SUGAR.App)},359:function(e,t){(function(e){_.extend(e.offline,{declareOfflineMixedBeanCollection:function(){var t=e.data.mixedBeanCollection;e.OfflineMixedBeanCollection=e.data.mixedBeanCollection.extend({fetch:function(i){var n=e.OfflineBeanCollection.prototype;n._handleFetchWithQuery.call(this,n._mergeCollection,i);return t.prototype.fetch.call(this,i)}});return e.OfflineMixedBeanCollection}})})(SUGAR.App)},360:function(e,t){(function(e){e.offline.SyncExecutor=function(e){this.options=e;this.init()};_.extend(e.offline.SyncExecutor.prototype,{_working:false,isWorking:function(){return this._working},_lastSyncTime:null,getLastSyncTime:function(){return this._lastSyncTime},init:function(){},shouldRun:function(){var t=this._lastSyncTime&&(new Date).getTime()-this._lastSyncTime.getTime()<this.options.interval*1e3;if(!this.options.enabled||!e.api.isAuthenticated()||t){return false}return!this._working},beforeSync:function(){this._working=true},sync:function(e){if(!this.shouldRun()){e();return}this.beforeSync();this._sync(_.bind(function(t){this.afterSync();e.apply(this,arguments)},this))},afterSync:function(){this._lastSyncTime=new Date;this._working=false},_sync:function(){e.offline.utils.notImplemented()},getPriority:function(){return this.options.priority},stop:function(){e.offline.utils.notImplemented()}});e.offline.SyncExecutor.extend=Backbone.Model.extend})(SUGAR.App)},361:function(e,t){(function(e){e.offline.WinsSyncExecutor=e.offline.SyncExecutor.extend({SYNC_PHASES:{PRE_SYNC:1,SYNC:2},WINS_STATUS_CACHE_NAME:"sync:wins:status",_status:null,_stopAsyncFlow:null,_updateStatus:function(t){_.each(t,function(e,t){this._status[t]=e},this);e.cache.set(this.WINS_STATUS_CACHE_NAME,this._status)},_loadStatus:function(){var t=e.cache.get(this.WINS_STATUS_CACHE_NAME);if(t&&e.user.get("id")===t.userId){this._status=t;if(this._status.winsStartedTime){this._status.winsInterruptedTimes++;this._updateStatus({winsInterruptedTimes:this._status.winsInterruptedTimes})}}else{this._resetStatus()}},_resetStatus:function(){this._status={phase:this.SYNC_PHASES.PRE_SYNC,preSyncedModules:[],minDate:this._status&&this._status.maxDate||e.cache.get(e.offline.INITIALIZED_TS_KEY),maxDate:null,winsCompletedTime:null,winsStartedTime:null,winsInterruptedTimes:0,syncedRecords:0,userId:e.user.get("id")};this._updateStatus()},_sync:function(t){var i=this;var n=function(n){e.logger.debug("WINS completed.");if(n){i._status.winsInterruptedTimes++;i._updateStatus({winsInterruptedTimes:i._status.winsInterruptedTimes})}else{i._updateStatus({winsCompletedTime:+new Date-i._status.winsStartedTime});e.trigger("offline:wins:completed",_.pick(i._status,["winsCompletedTime","winsInterruptedTimes","syncedRecords"]));i._resetStatus()}if(t){t(n)}};this._loadStatus();if(!this._status.winsStartedTime){this._updateStatus({winsStartedTime:+new Date})}if(_.isEmpty(this._status.minDate)){e.logger.debug("Skipping sync as last synced date is unknown. Fetching and saving current server time");e.offline.utils.getServerTime(function(e,t){if(!e){i._updateStatus({minDate:t})}n(e)})}else if(this._status.phase===this.SYNC_PHASES.PRE_SYNC){this._preSync(function(e){if(!e){i._updateStatus({phase:i.SYNC_PHASES.SYNC});i._recordsSync(n)}else{n(e)}})}else{this._recordsSync(n)}},_preSync:function(t){var i=this,n=[];if(_.isEmpty(this._status.maxDate)){n.push(function(t){e.offline.utils.getServerTime(function(e,n){if(e){t(e)}else{i._updateStatus({maxDate:n});t()}})})}var r=_.difference(e.offline.utils.getOfflineModules(),this._status.preSyncedModules,_.keys(e.config.offline.prefetch.staticModules));r=_.filter(r,function(t){return e.acl.hasAccess("list",t)});if(r.length!==0){_.each(r,function(e){n.push(function(t){i._preSyncModule(e,t)})},this)}this._stopAsyncFlow=e.offline.utils.getStoppableAsyncFlow("series",n,t);

},_preSyncModule:function(t,i){var n=this,r={fields:"id",deleted:true,filter:[{date_modified:{$gte:this._status.minDate,$lt:this._status.maxDate}}]};e.offline.utils.fetchPageByPage(t,r,_.bind(this._markLocalRecordsToBeUpdated,this),null,{maxRecords:this.options.preSyncMaxRecords,pageSize:this.options.preSyncPageSize,callback:function(e){if(!e){n._status.preSyncedModules.push(t);n._updateStatus({preSyncedModules:n._status.preSyncedModules})}i(e)}})},_markLocalRecordsToBeUpdated:function(t){this._processLocalMatchedRecords(t,function(i,n,r){e.offline.storage.markToBeSynced({module:t.module,action:n.deleted?"delete":"update",record:i,callback:r})})},_recordsSync:function(t){var i=this,n=[];_.each(e.offline.utils.getOfflineModules(),function(e){n.push(function(t){i._syncModule(e,t)})},this);this._stopAsyncFlow=e.offline.utils.getStoppableAsyncFlow("series",n,t)},_syncModule:function(t,i){var n=this;e.offline.storage.readToBeSynced({offset:0,max_num:this.options.syncPageSize||20,module:t,callback:function(e){if(e.records.length!==0){n._syncRecords({module:t,records:e.records,callback:function(r){if(r){i(r)}else{n._status.syncedRecords+=e.records.length;n._updateStatus({syncedRecords:n._status.syncedRecords});n._syncModule(t,i)}}})}else{i()}}})},_syncRecords:function(t){var i=_.map(t.records,function(e){return{id:e.bean_id,module:e.bean_module,action:e.action}}),n=t.module,r=_.filter(i,function(e){return e.action==="update"}),a=_.filter(i,function(e){return e.action==="delete"}),s=[];if(r.length>0){var o=_.pluck(r,"id"),l=e.metadata.getModule(n).mergedFields,u={filter:[{id:{$in:o}}]};if(!_.isEmpty(l)){u.fields=l.join(",")}s.push(function(t){e.offline.api.callOriginalApi("records",["read",n,null,u,{success:function(i){i=i||{records:[]};e.offline.storage.saveRecords({serverData:i.records,module:n,callback:function(i){if(i){return t(i)}else{e.offline.storage.resetToBeSynced({records:r,callback:t})}}})},error:t}])})}if(a.length>0){_.each(a,function(t){s.push(function(i){e.offline.storage.readSingleRawRecord(n,{id:t.id},{success:function(t){if(t&&e.offline.utils.isDataSynchronized(t)){e.offline.storage.sync("delete",{id:t.id},n,{hardDelete:true,success:function(){e.offline.storage.resetToBeSynced({records:a,callback:i})},error:i})}else{e.offline.storage.resetToBeSynced({records:a,callback:i})}},error:i})})})}async.series(s,t.callback)},_processLocalMatchedRecords:function(t,i){var n=_.pluck(t.records,"id"),r=t.module;e.offline.storage.readRecordsByIds(r,n,{success:function(e){if(_.isEmpty(e)){return t.callback()}e=_.isArray(e)?e:[e];var n=[];_.each(e,function(e){n.push(function(n){var r=_.find(t.records,function(t){return t.id===e.id});i(e,r,n)})});async.series(n,t.callback)},error:t.callback})},stop:function(){if(this._stopAsyncFlow){this._stopAsyncFlow();this._stopAsyncFlow=null;e.logger.debug("WinsSync interrupted")}}})})(SUGAR.App)},362:function(e,t){(function(e){e.offline.TxLogSyncExecutor=e.offline.SyncExecutor.extend({SYNC_ITERATION_COMPLETE_MESSAGE:"sync_iteration_complete",_immediateStop:false,_getBeanStub:function(e){return{id:e._tx_bean_id,module:e._tx_bean_module,related_id:e._tx_related_id,related_module:e._tx_related_module}},_sync:function(t){var i=this;var n=function(n){e.logger.debug("TxLogSync completed");if(n===i.SYNC_ITERATION_COMPLETE_MESSAGE){n=null}t(n)};function r(){if(i._immediateStop){i._immediateStop=false;e.logger.debug("TxLogSync interrupted");return n()}i._syncOldestTransaction(function(e){if(e){n(e)}else r()})}r()},_syncOldestTransaction:function(t){var i=this;e.offline.storage.readTransactions({limit:1,dateAsc:true,error:t,success:function(n){if(!n){return t(i.SYNC_ITERATION_COMPLETE_MESSAGE)}var r=i._getBeanStub(n);e.offline.storage.readSingleRawRecord(r.module,r,{success:function(a){a=a||{};var s=n._tx_updated_fields?JSON.parse(n._tx_updated_fields):{},o={};if(n._tx_action!==e.offline.SYNC_ACTIONS.LINK&&n._tx_action!==e.offline.SYNC_ACTIONS.UNLINK){_.each(s,function(e,t){o[t]=e.after});if(n._tx_action!==e.offline.SYNC_ACTIONS.CREATE){o.date_modified=a.date_modified||e.utils.getTimestamp()}o.id=a.id||r.id}i._handleSyncTransaction(n,t,o);o={}},error:t})}})},_handleSyncTransaction:function(t,i,n){var r,a={id:t._tx_bean_id,module:t._tx_bean_module,related_id:t._tx_related_id,related_module:t._tx_related_module};if(t._tx_action===e.offline.SYNC_ACTIONS.CREATE||t._tx_action===e.offline.SYNC_ACTIONS.LINK){r="create"}else if(t._tx_action===e.offline.SYNC_ACTIONS.UPDATE){r="update"}else if(t._tx_action===e.offline.SYNC_ACTIONS.DELETE||t._tx_action===e.offline.SYNC_ACTIONS.UNLINK){r="delete"}else if(t._tx_action===e.offline.SYNC_ACTIONS.FAVORITE){r="favorite"}else if(t._tx_action===e.offline.SYNC_ACTIONS.FOLLOW){r="follow"}else{throw new Error("Undefined action in transaction log!")}if(t._tx_related_id&&t._tx_related_module){this._syncRelationships(r,a,t,i,n)}else if(r==="favorite"){this._syncFavorite(r,a,t,i,n)}else if(r==="follow"){this._syncFollow(r,a,t,i,n)}else{this._syncRecords(r,a,t,i,n)}},_syncRecords:function(t,i,n,r,a){var s={};a=this._addXTimestampHeader(a,s);e.offline.api.callOriginalApi("records",[t,i.module,a,{viewed:true},{success:function(t){e.offline.storage.resolveSuccess({module:i.module,transaction:n,serverData:t,callback:r})},error:function(t){e.offline.storage.resolveError({error:t,updatedFields:a,txLog:n,callback:r})}},s])},_syncRelationships:function(t,i,n,r,a){var s={};a=this._addXTimestampHeader(a,s);var o={id:i.related_id,link:n._tx_link,related:a?a:{id:i.id},relatedId:i.id};if(n._tx_action===e.offline.SYNC_ACTIONS.CREATE){o.relatedId=null}e.offline.api.callOriginalApi("relationships",[t,i.related_module,o,{},{success:function(t){var a=_.extend(o,{related:t.related_record,record:t.record,recordModule:i.related_module,relatedModule:i.module});e.offline.storage.resolveSuccess({module:n._tx_related_module,transaction:n,serverData:t,relationshipData:a,callback:r})},error:function(t){e.offline.storage.resolveError({error:t,updatedFields:a,txLog:n,callback:r})}},s])},_syncFavorite:function(t,i,n,r,a){e.offline.api.callOriginalApi("favorite",[i.module,i.id,a.my_favorite,{success:function(t){e.offline.storage.resolveSuccess({module:i.module,transaction:n,serverData:t,callback:r})},error:function(t){e.offline.storage.resolveError({error:t,updatedFields:a,txLog:n,callback:r})}}])},_syncFollow:function(t,i,n,r,a){e.offline.api.callOriginalApi("follow",[i.module,i.id,a.following,{success:function(){e.offline.storage.resolveSuccess({module:i.module,transaction:n,serverData:{id:i.id,following:a.following},callback:r})},error:function(t){e.offline.storage.resolveError({error:t,updatedFields:a,txLog:n,callback:r})}}])},_addXTimestampHeader:function(e,t){if(e&&e.date_modified){t.headers={"X-TIMESTAMP":e.date_modified};e=_.omit(e,"date_modified")}return e},stop:function(){this._immediateStop=true}})})(SUGAR.App)},363:function(e,t){(function(e){Handlebars.registerHelper("field",function(t,i){var n=e.view.createField({def:this,view:t,model:i.hash.model,viewName:i.hash.template});if(i.hash.parent&&_.isArray(i.hash.parent.fields)){i.hash.parent.fields.push(n)}return n.getPlaceholder()});Handlebars.registerHelper("fieldOfType",function(t,i){var n={type:t,name:t,label:i};var r=e.view.createField({def:n,view:this});return r.getPlaceholder()});Handlebars.registerHelper("eachOptions",function(t,i){var n,r="",a;n=_.isString(t)?e.lang.getAppListStrings(t):t;if(_.isArray(n)){a=function(e,t){r=r+i.fn({key:t,value:e})}}else if(_.isObject(n)){a=function(e,t){r=r+i.fn({key:t,value:e})}}else{n=null}if(n)_.each(n,a,this);return r});Handlebars.registerHelper("buildRoute",function(t){var i=t.hash.context,n=t.hash.model||(i&&i.get("model")?i.get("model"):{}),r=t.hash.module||n.module||(i&&i.get("module")?i.get("module"):null),a=t.hash.id||n.id,s=t.hash.action;return e.router.buildRoute(r,a,s)});Handlebars.registerHelper("getFieldValue",function(t,i,n){e.logger.warn("getFieldValue handlebars helper is deprecated and will be removed in 7.8. "+"Please use the fieldValue handlebars helper instead.");n=_.isObject(n)?"":n;return t.get(i)||n||""});Handlebars.registerHelper("fieldValue",function(e,t,i){return e.get(t)||i.hash.defaultValue||""});Handlebars.registerHelper("has",function(e,t,i){if(!_.isArray(t)&&!_.isObject(t)){t=[t]}return _.include(t,e)?i.fn(this):i.inverse(this)});Handlebars.registerHelper("notHas",function(e,t,i){var n=i.fn,r=i.inverse;i.fn=r;i.inverse=n;return Handlebars.helpers["has"].call(this,e,t,i)});Handlebars.registerHelper("isSortable",function(t,i,n){if(e.utils.isSortable(t,i)){return n.fn(this)}else{return""}});Handlebars.registerHelper("eq",function(e,t,i){return e==t?i.fn(this):i.inverse(this)});Handlebars.registerHelper("notEq",function(e,t,i){return e!=t?i.fn(this):i.inverse(this)});Handlebars.registerHelper("match",function(e,t,i){var n=new RegExp(t);if(n.test(e)){return i.fn(this)}else{return i.inverse(this)}});Handlebars.registerHelper("notMatch",function(e,t,i){var n=new RegExp(t);if(!n.test(e)){return i.fn(this)}else{return i.inverse(this)}});Handlebars.registerHelper("log",function(t){e.logger.debug("*****HBS: Current Context*****");e.logger.debug(this);e.logger.debug("*****HBS: Current Value*****");e.logger.debug(t);console.log(t);e.logger.debug("***********************")});Handlebars.registerHelper("str",function(t,i,n){i=_.isString(i)?i:null;return e.lang.get(t,i,n)});Handlebars.registerHelper("relativeTime",function(t,i){var n=e.date(t),r,a;i.hash.title=i.hash.title||n.formatUser(i.hash.dateOnly);r=_.map(i.hash,function(e,t){return t+'="'+Handlebars.Utils.escapeExpression(e)+'"'}).join(" ");a='<time datetime="'+n.format()+'" '+r+">"+n.fromNow()+"</time>";return new Handlebars.SafeString(a)});Handlebars.registerHelper("arrayJoin",function(e,t){return e.join(t)});Handlebars.registerHelper("nl2br",function(e){e=Handlebars.Utils.escapeExpression(e);var t=e.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+"<br>");return new Handlebars.SafeString(t)});Handlebars.registerHelper("formatCurrency",function(t,i){if(_.isObject(i)){i=i.hash.currencyId||undefined}return e.currency.formatAmountLocale(t,i)});Handlebars.registerHelper("firstChars",function(e,t){return e.substring(0,t)});Handlebars.registerHelper("formatDate",function(t,i){var t=e.date(t);return t.formatUser(i.hash.dateOnly)});Handlebars.registerHelper("getModuleName",function(t,i){var i={plural:i.hash.plural,defaultValue:i.hash.defaultValue};return e.lang.getModuleName(t,i)});Handlebars.registerHelper("partial",function(t,i,n,r){var a,s,o;if(!r&&n.hash){r=n;n={}}o=_.extend({templateComponent:i},n,r.hash);a=r.hash.module||i.module;if(i&&i.options.templateOptions&&i.options.templateOptions.partials){s=i.options.templateOptions.partials[t]}else if(i instanceof e.view.Field){var l=r.hash.fallbackTemplate;s=e.template.getField(i.type,t||"detail",a,l)}else if(i instanceof e.view.View){var u=i.tplName;s=e.template.getView(i.name+"."+t,a)||e.template.getView(i.name+"."+t);if(!s&&u){s=e.template.getView(u+"."+t,a)||e.template.getView(u+"."+t)}}else if(i instanceof e.view.Layout){s=e.template.getLayout(i.name+"."+t,a)||e.template.getLayout(i.name+"."+t)}return new Handlebars.SafeString(s?s(o):"")})})(SUGAR.App)},364:function(e,t){(function(e){var t=0;var i=[];var n={reset:function(){_.each(this.layouts,function(e,t){delete this.layouts[t]},this);_.each(this.views,function(e,t){delete this.views[t]},this);_.each(this.fields,function(e,t){delete this.fields[t]},this)},getFieldId:function(){return t},views:{},layouts:{},fields:{},_createComponent:function(e,t,i){var n=this.declareComponent(e,i.type||t,i.module,i.controller,false,this._getPlatform(i));var r=new n(i);r.trigger("init");r.bindDataChange();return r},createView:function(t){t.context=t.context||e.controller.context;t.module=t.module||t.context.get("module");t.meta=t.meta||e.metadata.getView(t.module,t.name);t.type=t.type||(t.meta&&t.meta.type?t.meta.type:t.name||null);return this._createComponent("view",t.name,t)},createLayout:function(t){t.context=t.context||e.controller.context;t.module=t.module||t.context.get("module");t.meta=t.meta||e.metadata.getLayout(t.module,t.name);t.type=t.type||(t.meta?t.meta.type:null);return this._createComponent("layout",t.name||t.type,t)},createField:function(i){var n=i.def.type;i.context=i.context||i.view.context||e.controller.context;i.model=i.model||i.context.get("model");i.module=i.module||(i.model&&i.model.module?i.model.module:i.context.get("module"))||"";i.meta=i.meta||e.metadata.getField(n,i.module);if(i.meta&&i.meta.controller)i.controller=i.meta.controller;i.sfId=++t;var r=this._createComponent("field",n,i);i.view.fields[r.sfId]=r;return r},_getPlatform:function(t){return t.platform||(e.config&&e.config.platform?e.config.platform:"base")},_getController:function(e){var t=this._getBaseComponent(e.type,e.name,e.module,e.platform);if(t.cache[t.moduleBasedClassName]){return t.cache[t.moduleBasedClassName]}return t.baseClass},invokeParent:function(t,i){var n,r;i=i||{};if(!t||!i.type||!i.name||!i.method||i.args&&!_.isArray(i.args)){e.logger.error("view-manager's invoke method requires a context, params.type, params.name, params.method; if params.args is supplied it must be of type array.")}n=this._getController(i);if(!n){return e.logger.error("invokeParent: Unable to load controller for "+i.type+":"+i.name)}t._superStack=t._superStack||{};t._superStack[i.method]=t._superStack[i.method]||[];t._superStack[i.method].push(n.prototype);r=n.prototype[i.method].apply(t,i.args);t._superStack[i.method].pop();return r},componentHasPlugin:function(t){var i;if(!t.type||!t.name||!t.plugin){e.logger.error("componentHasPlugin requires type, name, and plugin parameters");return null}i=this._getController(t);return i&&i.prototype&&_.contains(i.prototype.plugins,t.plugin)},declareComponent:function(t,i,n,r,a,s){var o=this._getBaseComponent(t,i,n,s,a&&r);if(a&&r){if(o.cache[o.moduleBasedClassName])delete o.cache[o.moduleBasedClassName]}return o.cache[o.moduleBasedClassName]||e.utils.extendClass(o.cache,o.baseClass,o.moduleBasedClassName,r,o.platformNamespace)||o.baseClass},_getBaseComponent:function(t,i,n,r,a){r=this._getPlatform({platform:r});var s=e.utils.capitalize(t),o=e.utils.capitalize(r),l=e.utils.capitalizeHyphenated(i)+s,u=o+(n||"")+l,f=o+(n||"")+"Custom"+l,c=e.view[t+"s"],d=e.utils.capitalize(e.config.appId)+s,p=c[o+"Custom"+l]||c[o+l]||c["BaseCustom"+l]||c["Base"+l]||c[l]||c["BaseBase"+s]||e.view["Custom"+d]||e.view[d]||e.view[s];if(c[f]&&!a){u=f}return{cache:c,platformNamespace:o,moduleBasedClassName:u,baseClass:p}}};e.augment("view",n,false)})(SUGAR.App)},365:function(e,t){(function(e){e.view.Component=Backbone.View.extend({initialize:function(t){this.context=t.context||e.controller&&e.controller.context||new Backbone.Model;this.meta=t.meta;this.module=t.module||this.context.get("module");this.model=t.model||this.context.get("model");this.collection=t.collection||this.context.get("collection");if(this.meta&&this.meta.css_class){this.$el.addClass(this.meta.css_class)}this.updateVisibleState(true);e.user.lastState.register(this)},_render:function(){return this},render:function(){if(this.disposed===true){e.logger.error("Unable to render component because it's disposed "+this+"\n");return false}if(!this.triggerBefore("render"))return false;this._render();this.trigger("render");return this},setTemplateOption:function(e,t){this.options=this.options||{};this.options.templateOptions=this.options.templateOptions||{};this.options.templateOptions[e]=_.extend({},this.options.templateOptions[e],t)},bindDataChange:function(){},unbindData:function(){if(this.model)this.model.off(null,null,this);if(this.collection)this.collection.off(null,null,this)},unbind:function(){this.off();this.offBefore();this.undelegateEvents();e.events.off(null,null,this);e.events.unregister(this);if(this.context)this.context.off(null,null,this);if(this.layout)this.layout.off(null,null,this)},loadData:function(){},_dispose:function(){this.unbindData();this.unbind();this.remove();this.model=null;this.collection=null;this.context=null;this.$el=null;this.el=null},dispose:function(){if(this.disposed===true)return;this._dispose();this.disposed=true},toString:function(){return this.cid+"-"+(this.$el&&this.$el.id?this.$el.id:"<no-id>")+"/"+this.module+"/"+this.model+"/"+this.collection},closestComponent:function(e){},show:function(){if(!this.isVisible()){if(!this.triggerBefore("show")){return false}this._show();this.trigger("show")}},hide:function(){if(this.isVisible()){if(!this.triggerBefore("hide")){return false}this._hide();this.trigger("hide")}},isVisible:function(){return this._isVisible},updateVisibleState:function(e){this._isVisible=!!e},_show:function(){this.$el.removeClass("hide").show();this.updateVisibleState(true)},_hide:function(){this.$el.addClass("hide").hide();this.updateVisibleState(false)},_super:function(t,i){if(!t||!_.isString(t)){return e.logger.error("tried to call _super without specifying a parent method in "+this.name)}var n,r=null,a=Object.getPrototypeOf(this);i=i||[];this._superStack=this._superStack||{};this._superStack[t]=this._superStack[t]||[];if(this._superStack[t].length>0){n=Object.getPrototypeOf(_.last(this._superStack[t]));if(_.contains(this._superStack[t],n)){return e.logger.error("Loop detected calling "+t+" from "+this.name)}}else{n=Object.getPrototypeOf(a)}if(!a[t]){return e.logger.error("Unable to find method "+t+" on class "+this.name)}while(!n.hasOwnProperty(t)&&n!==e.view.Component.prototype){n=Object.getPrototypeOf(n)}while(a[t]===n[t]&&n!==e.view.Component.prototype){a=n;n=Object.getPrototypeOf(n)}this._superStack[t].push(n);if(!n){return e.logger.error("Unable to find parent of component "+this.name)}if(!n[t]){return e.logger.error("Unable to find method "+t+" on parent class of "+this.name)}var s=n[t].apply(this,i);this._superStack[t].pop();if(_.isEmpty(this._superStack[t])){this._superStack[t]=null}return s}});_.extend(e.view.Component.prototype,e.beforeEvent)})(SUGAR.App)},366:function(e,t){(function(e){e.view.View=e.view.Component.extend({initialize:function(t){e.plugins.attach(this,"view");e.view.Component.prototype.initialize.call(this,t);this.name=t.name;this.action=t.meta&&t.meta.action?t.meta.action:this.name;this._loadTemplate(t);this.fields={};this.fallbackFieldTemplate=this.fallbackFieldTemplate||"detail";this.layout=this.options.layout;this.primary=t.primary;this._setLabels();e.events.on("app:locale:change",function(){this._setLabels()},this)},_loadTemplate:function(t){var i,n;if(i=t&&t.template){n=null}else if(i=this.meta&&this.meta.template&&e.template.getView(this.meta.template)){n=this.meta.template}else if(i=e.template.getView(this.name,this.module)||e.template.getView(this.name)){n=this.name}else if(i=this.meta&&this.meta.type&&e.template.getView(this.meta.type)){n=this.meta.type}else{i=e.template.empty;n=""}this.tplName=n;this.template=i},getTemplateFromMeta:function(t){e.logger.warn("`getTemplateFromMeta` is deprecated since 7.7 and "+"will be removed in 7.8.");if(t.meta&&t.meta.template){return e.template.getView(t.meta.template)}return null},_renderHtml:function(t,i){if(this.template){try{this.$el.html(this.template(t||this,i||this.options.templateOptions));this.delegateEvents()}catch(n){e.logger.error("Failed to render "+this+"\n"+n);e.error.handleRenderError(this,"_renderHtml")}}},_renderFields:function(){var e=this;var t={};this.$("span[sfuuid]").each(function(){var e=$(this),i=e.attr("sfuuid");t[i]=e});_.each(this.fields,function(i){e._renderField(i,t[i.sfId])})},_renderField:function(t,i){t.setElement(i||this.$("span[sfuuid='"+t.sfId+"']"));try{t.render()}catch(n){e.logger.error("Failed to render "+t+" on "+this+"\n"+n);e.error.handleRenderError(this,"_renderField",t)}},_render:function(){if(e.acl.hasAccessToModel(this.action,this.model)){this._disposeFields();this._renderHtml();this._renderFields()}else{e.logger.info("Current user does not have access to this module view. name: "+this.name+" module:"+this.module);if(this.primary){e.error.handleRenderError(this,"view_render_denied")}}return this},_setLabels:function(){this.modulePlural=e.lang.getAppListStrings("moduleList")[this.module]||this.module;this.moduleSingular=e.lang.getAppListStrings("moduleListSingular")[this.module]||this.modulePlural},loadData:function(t,i){if(e.acl.hasAccess("read",this.module)){i=_.isUndefined(i)?true:i;if(i){this.context.set("fields",this.getFieldNames())}this.context.loadData(t)}},getFieldNames:function(t,i){var n=[];t=t||this.context.get("module");if(this.meta&&this.meta.panels){n=_.reduce(_.map(this.meta.panels,function(e){var t=_.flatten(_.compact(_.pluck(e.fields,"fields")));return _.pluck(e.fields,"name").concat(_.pluck(t,"name")).concat(_.flatten(_.compact(_.pluck(e.fields,"related_fields"))))}),function(e,t){return e.concat(t)},[])}n=_.compact(_.uniq(n));var r=e.metadata.getModule(t,"fields");if(r){n=_.reject(n,function(e){return _.isUndefined(r[e])});var a=[];_.each(n,function(e){if(r[e].type=="relate"){a.push(r[e].id_name)}else if(r[e].type=="parent"){a.push(r[e].id_name);a.push(r[e].type_name)}if(_.isArray(r[e].fields)){a=a.concat(r[e].fields)}});n=_.union(n,a)}return n},getFields:function(e,t){var i={};var n=this.getFieldNames(e);_.each(n,function(e){var n=this.getField(e,t);if(n){i[e]=n.def}},this);return i},getField:function(e,t){return _.find(this.fields,function(i){return i.name==e&&(!t||i.model==t)})},closestComponent:function(e){if(!this.layout){return}if(this.layout.name===e){return this.layout}return this.layout.closestComponent(e)},_show:function(){this._super("_show");_.each(this.fields,function(e){e.updateVisibleState(true)})},_hide:function(){this._super("_hide");_.each(this.fields,function(e){e.updateVisibleState(true)})},_dispose:function(){e.plugins.detach(this,"view");this._disposeFields();e.view.Component.prototype._dispose.call(this)},_disposeFields:function(){_.each(this.fields,function(e){e.dispose()});this.fields={}},toString:function(){return"view-"+this.name+"-"+e.view.Component.prototype.toString.call(this)},getFieldMeta:function(e){var t=_.find(_.flatten(_.pluck(this.meta.panels,"fields")),function(t){return t.name==e});return t},setFieldMeta:function(e,t){_.each(this.meta.panels,function(i){_.each(i.fields,function(n,r){if(n.name==e){i.fields[r]=_.extend(n,t)}})})}})})(SUGAR.App)},367:function(e,t){(function(e){e.view.Layout=e.view.Component.extend({initialize:function(t){e.plugins.attach(this,"layout");e.view.Component.prototype.initialize.call(this,t);this._components=[];this.meta=this.meta||{};this.type=this.meta.type||this.options.type;this.name=this.meta.name||this.options.name||this.type||"";if(this.meta.label){this.label=this.meta.label}else if(this.options.def&&this.options.def.label){this.label=this.options.def.label}else if(this.options.label){this.label=this.options.label}else{this.label=""}this.template=e.template.getLayout(this.name,this.module)||e.template.getLayout(this.type,this.module)||e.template.getLayout(this.name)||e.template.getLayout(this.type);if(this.template){this.$el.html(this.template(this,t))}this.layout=this.options.layout;e.events.on("app:locale:change",function(){this.render()},this)},initComponents:function(e,t,i){if(this.disposed){return}var n,r;e=e||this.meta.components;r=this._components.length;this._addComponentsFromDef(e,t,i);n=this._components.slice(r);_.each(n,function(e){if(_.isFunction(e.initComponents)){e.initComponents()}});this.trigger("init")},createComponentFromDef:function(t,i,n){i=i||this.context;n=n||this.module;if(t.context){if(t.context instanceof e.Context){i=t.context}else{i=i.getChildContext(t.context);i.prepare()}n=i.get("module")}if(t.view){if(_.isString(t.view)){return e.view.createView({context:i,name:t.view,module:n,primary:t.primary,layout:this})}else if(_.isObject(t.view)){return e.view.createView({context:i,module:n,meta:t.view.meta||t.view,name:t.view.name||t.view.type||"",primary:t.view.primary,layout:this})}}else if(t.layout){if(_.isString(t.layout)){return e.view.createLayout({context:i,name:t.layout,def:t,module:n,layout:this})}else if(_.isObject(t.layout)){return e.view.createLayout({context:i,module:n,meta:t.layout.meta||t.layout,name:t.layout.name||t.layout.type||"",def:t,layout:this})}}else{e.logger.warn("Invalid layout definition:\n"+t.layout)}},_addComponentsFromDef:function(e,t,i){e=e||[];_.each(e,function(e){if(e.view||e.layout){this.addComponent(this.createComponentFromDef(e,t,i),e)}},this)},addComponent:function(e,t){if(!e.layout)e.layout=this;this._components.push(e);this._placeComponent(e,t)},_placeComponent:function(e){this.$el.append(e.el)},removeComponent:function(e){var t=_.isNumber(e)?e:this._components.indexOf(e);if(t>-1){var i=this._components.splice(t,1);i[0].layout=null}},getComponent:function(e){return _.find(this._components,function(t){return t.name===e})},_render:function(){if(this._components&&this._components.length>0){_.each(this._components,function(e){e.render()},this)}else{e.logger.info("Can't render anything because the layout has no components: "+this.toString()+"\n"+"Either supply metadata or override Layout.render method")}return this},loadData:function(e,t){if(this.disposed){return}t=_.isUndefined(t)?true:t;if(t){this.context.set("fields",this.getFieldNames())}this.context.loadData(e);_.each(this._components,function(t){t.loadData(e,t.context!=this.context)},this)},getFieldNames:function(e){var t=[];e=e||this.module;_.each(this._components,function(i){if(i.module==e){t=_.union(t,i.getFieldNames(null,true))}},this);return t},getFields:function(e){var t={};_.each(this._components,function(i){_.extend(t,i.getFields(e))});return t},closestComponent:function(e){if(!this.layout){return}if(this.layout.name===e){return this.layout}return this.layout.closestComponent(e)},_show:function(){this._super("_show");_.each(this._components,function(e){e.updateVisibleState(true)})},_hide:function(){this._super("_hide");_.each(this._components,function(e){e.updateVisibleState(true)})},_dispose:function(){e.plugins.detach(this,"layout");_.each(this._components,function(e){e.dispose()});this._components=[];e.view.Component.prototype._dispose.call(this)},toString:function(){return"layout-"+(this.options.type||this.options.name)+"-"+e.view.Component.prototype.toString.call(this)}})})(SUGAR.App)},368:function(e,t){(function(e){e.view.Field=e.view.Component.extend({fieldTag:"input",initialize:function(t){e.plugins.attach(this,"field");e.view.Component.prototype.initialize.call(this,t);this.sfId=t.sfId;this.view=t.view;this.name=this.options.def.name;this.type=this.options.def.type;if(this.model&&this.model.fields){var i=_.clone(this.model.fields[this.name]);this.def=i?_.extend(i,t.def):t.def}else{this.def=this.options.def}this.label=e.lang.get(this.def.label||this.def.vname||this.name,this.module);this.template=e.template.empty;if(this.model){this.model.on("error:validation:"+this.name,this.handleValidationError,this);this.model.on("validation:start attributes:revert",this.removeValidationErrors,this);this.model.on("acl:change:"+this.name,this.handleAclChange,this)}},viewFallbackMap:{edit:"detail"},handleAclChange:function(){this.action=void 0;this.render()},_checkAccessToAction:function(t){return e.acl.hasAccessToModel(t,this.model,this.name)},_getFallbackTemplate:function(e){return this.isDisabled()&&e==="disabled"?"edit":this.view.fallbackFieldTemplate||"detail"},_loadTemplate:function(){var t;var i=this.options.viewName||this.options.def.view||(this.view.meta&&this.view.meta.type?this.view.meta.type:this.view.name);var n=this.action;if(this.isDisabled()&&i==="edit"){i=this.action}else{n=this.action||(this.view.action&&this.view.name!=this.view.action?this.view.action:i)}while(i){if(this._checkAccessToAction(n))break;i=this.viewFallbackMap[i];n=i}if(i){var r=this.module||this.context.get("module");t=this._getFallbackTemplate(i);this.template=e.template.getField(this.type,i,r,t)||e.template.getField("base",i,r,t)||e.template.empty}else{this.template=e.template.empty}this.tplName=i;this.action=n},delegateEvents:function(e){e=e||this.events||(this.def?this.def.events:null);if(!e)return;e=_.clone(e);_.each(e,function(t,i){var n=this[t];if(!n&&_.isString(t)){n=_.bind(function(e){if(_.isFunction(this.triggerMetadataEvent)){this.triggerMetadataEvent(e,t)}},this);this["callback_"+i]=n;e[i]="callback_"+i}if(!_.isFunction(t)&&!n){delete e[i]}},this);Backbone.View.prototype.delegateEvents.call(this,e)},_render:function(){this._loadTemplate();if(this.model instanceof Backbone.Model){this.value=this.getFormattedValue()}this.dir=_.result(this,"direction");if(e.lang.direction===this.dir){delete this.dir}this.unbindDom();this.$el.html(this.template(this)||"");if(this.def&&this.def.css_class){this.getFieldElement().addClass(this.def.css_class)}this.$(this.fieldTag).attr("dir",this.dir);this.bindDomChange();return this},getFieldElement:function(){return this.$el},bindDomChange:function(){if(!(this.model instanceof Backbone.Model))return;var e=this;var t=this.$el.find(this.fieldTag);t.on("change",function(){e.model.set(e.name,e.unformat(t.val()))})},bindDataChange:function(){if(this.model){this.model.on("change:"+this.name,function(e,t){if(this.action==="edit"){this.$(this.fieldTag).val(this.format(t))}else{this.render()}},this)}},hasChanged:function(){return!_.isEqual(this.format(this.model.getSynced(this.name)),this.format(this.model.get(this.name)))},format:function(e){return e},unformat:function(e){return e},getFormattedValue:function(){return this.format(this.model.has(this.name)?this.model.get(this.name):null)},handleValidationError:function(e){},removeValidationErrors:function(){},getPlaceholder:function(){return new Handlebars.SafeString('<span sfuuid="'+this.sfId+'"></span>')},setDisabled:function(e){e=_.isUndefined(e)?true:e;if(e&&this.isDisabled()===false){this._previousAction=this.action;this.action="disabled";this.render()}else if(e===false&&this.isDisabled()){this.action=this._previousAction;delete this._previousAction;this.render()}},isDisabled:function(){return this.action==="disabled"},setViewName:function(e){this.options.viewName=e},setMode:function(e){if(this.isDisabled()){this._previousAction=e}else{this.action=e}this.setViewName(e);this.render()},unbindDom:function(){this.$el.find(this.fieldTag).off()},_dispose:function(){e.plugins.detach(this,"field");this.unbindDom();e.view.Component.prototype._dispose.call(this)},toString:function(){return"field-"+this.name+"-"+this.sfId+"-"+e.view.Component.prototype.toString.call(this)},_show:function(){this.getFieldElement().removeClass("hide").show();this.updateVisibleState(true)},_hide:function(){this.getFieldElement().addClass("hide").hide();this.updateVisibleState(false)},equals:function(e){return this.type===e.type&&_.isEqual(this.getFormattedValue(),e.getFormattedValue())},closestComponent:function(e){if(!this.view){return}if(this.view.name===e){return this.view}return this.view.closestComponent(e)}})})(SUGAR.App)},369:function(e,t){(function(e){e(window.jQuery||window.Zepto,SUGAR.App.date)})(function(e,t){var i=6e4,n=e([]),r;var a=function(){if(!n.length){return}r=setTimeout(a,i);s.update()};var s={update:function(i){i=i||n;i.each(function(i,r){var a=e(r),s=a.data("liveRelativeDate"),o;if(!s){n=n.not(r);return}o=s.date?a.data(s.date):a.attr("datetime");var l=a.html(),u=t(o).fromNow();if(l===u){return}var f=e.Event("change.liveRelativeDate");a.trigger(f,[l,u]);if(!f.isDefaultPrevented()){a.html(u)}})},pause:function(){clearTimeout(r);r=null},resume:function(){if(!r){a()}},interval:function(e){if(e===undefined){return i}i=e}};var o={add:function(e,t){if(!e||e.length===0){return e}t=t||{};e.data("liveRelativeDate",JSON.stringify(t));n=n.add(e);s.resume();return e},destroy:function(e){n=n.not(e);e.removeAttr("data-live-relative-date");return e},isLiveRelativeDate:function(t){var i=true;e.each(t,function(t){if(e(t).data("liveRelativeDate")===undefined){i=false;return true}});return i}};e.liverelativedate=s;e.fn.liverelativedate=function(e,t){if(!o[e]){t=e;

e="add"}return o[e](this,t)}})},370:function(e,t){if(typeof SUGAR=="undefined")SUGAR={};if(typeof SUGAR.util=="undefined")SUGAR.util={};if(typeof SUGAR.expressions=="undefined")SUGAR.expressions={};(function(){SUGAR.util.extend=SUGAR.util.extend||(SUGAR.App?SUGAR.App.utils.extendFrom:null);var e=SUGAR.expressions.Expression=function(e){this.context=e};e.INFINITY=-1;e.STRING_TYPE="string";e.NUMERIC_TYPE="number";e.DATE_TYPE="date";e.TIME_TYPE="time";e.BOOLEAN_TYPE="boolean";e.ENUM_TYPE="enum";e.RELATE_TYPE="relate";e.GENERIC_TYPE="generic";e.TRUE="true";e.FALSE="false";e.isTruthy=function(t){return _.isString(t)?t=="1"||t==e.TRUE:!!t};SUGAR.expressions.NumericConstants={pi:3.14159265,e:2.718281828459045};e.prototype.init=function(e){if(e instanceof Array&&e.length==1){this.params=e[0]}else{this.params=e}this.validateParameters()};e.prototype.getParameters=function(){if(!this.params){return this.params}var i,n,r=[],a=this.getParameterTypes(),s=this.getParamCount()==1,o,l;if(s||!_.isArray(this.params)&&_.isObject(this.params)){i=[this.params]}else{i=this.params}if(!(a instanceof Array)){o=a;a=[];for(l=0;l<i.length;l++){a.push(o)}}var u=this.constructor.TYPE_CAST_MAP;for(l=0;l<i.length;l++){n=i[l];if(n instanceof e){o=t.prototype.getType(n);if(o!=a[l]&&a[l]in u){n=new SUGAR.expressions[u[a[l]]](n,this.context)}}r.push(n)}if(s){r=r.shift()}return r};e.prototype.validateParameters=function(){var t=this.params;var i=this.getParamCount();var n=this.getParameterTypes();if(typeof i!="number"){throw this.getClass()+": Number of paramters required must be a number"}if(typeof n!="string"&&!(n instanceof Array)){throw this.getClass()+": Parameter types must be valid and match the parameter count"}if(n instanceof Array&&i!=e.INFINITY&&i!=n.length){throw this.getClass()+": Parameter types must be valid and match the parameter count"}if(typeof n=="string"){if(e.TYPE_MAP[n]==null){throw this.getClass()+": Invalid type requirement '"+n+"'"}}else{for(var r=0;r<n.length;r++){if(typeof e.TYPE_MAP[n[r]]=="undefined"){throw this.getClass()+": Invalid type requirement '"+n[r]+"'"}}}if(i==0&&typeof t=="undefined"){return}if(i==1&&this.isProperType(t,n)){return}if(i>1&&!(t instanceof Array)){throw this.getClass()+": Requires exactly "+i+" parameter(s)"}if(i==1&&t instanceof Array){throw this.getClass()+": Requires exactly 1 parameter"}if(i!=e.INFINITY&&t instanceof Array&&t.length!=i){throw this.getClass()+": Requires exactly "+i+" parameter(s)"}if(typeof n=="string"){if(!(t instanceof Array)){if(this.isProperType(t,n)){return}throw this.getClass()+": Parameter must be of type '"+n+"'"}for(var r=0;r<t.length;r++){if(!this.isProperType(t[r],n)){throw this.getClass()+": All parameters must be of type '"+n+"'"}}}else{if(!(t instanceof Array)){if(this.isProperType(t,n[0])){return}throw this.getClass()+": Parameter must be of type '"+n[0]+"'"}for(var r=0;r<n.length;r++){if(!this.isProperType(t[r],n[r])){throw this.getClass()+": The parameter at index "+r+" must be of type "+n[r]}}}};e.prototype.getParamCount=function(){return e.INFINITY};e.prototype.isProperType=function(t,i){var n=e;if(i instanceof Array){return false}var r=n.TYPE_MAP[i];if(typeof r=="undefined"||r==null||r==""){return false}if(t instanceof r||t instanceof n.TYPE_MAP.generic||i==n.GENERIC_TYPE)return true;if(t instanceof n){t=t.evaluate()}switch(i){case n.STRING_TYPE:return typeof t=="string"||typeof t=="number"||t instanceof n.TYPE_MAP[n.NUMERIC_TYPE];break;case n.NUMERIC_TYPE:return typeof t=="number"||SUGAR.expressions.isNumeric(t);break;case n.BOOLEAN_TYPE:return t==n.TRUE||t==n.FALSE||t===1||t===0||t==="1"||t==="0"||t==="";break;case n.DATE_TYPE:case n.TIME_TYPE:if(t===null||t===""||typeof t=="string"&&SUGAR.util.DateUtils.guessFormat(t))return true;break;case n.RELATE_TYPE:return true;break}return false};e.prototype.evaluate=function(){};e.prototype.getClass=function(e){for(var t in SUGAR.FunctionMap){if(typeof SUGAR.FunctionMap[t]=="function"&&SUGAR.FunctionMap[t].prototype&&this instanceof SUGAR.FunctionMap[t])return t}return false};e.prototype.getParameterTypes=function(){};SUGAR.expressions.GenericExpression=function(e){};SUGAR.util.extend(SUGAR.expressions.GenericExpression,e,{getParameterTypes:function(){return e.GENERIC_TYPE}});SUGAR.expressions.NumericExpression=function(e){};SUGAR.util.extend(SUGAR.expressions.NumericExpression,e,{getParameterTypes:function(){return e.NUMERIC_TYPE}});SUGAR.expressions.StringExpression=function(e){};SUGAR.util.extend(SUGAR.expressions.StringExpression,e,{getParameterTypes:function(){return e.STRING_TYPE}});SUGAR.expressions.BooleanExpression=function(e){};SUGAR.util.extend(SUGAR.expressions.BooleanExpression,e,{getParameterTypes:function(){return e.BOOLEAN_TYPE}});SUGAR.expressions.EnumExpression=function(e){};SUGAR.util.extend(SUGAR.expressions.EnumExpression,e,{getParameterTypes:function(){return e.ENUM_TYPE}});SUGAR.expressions.DateExpression=function(e){};SUGAR.util.extend(SUGAR.expressions.DateExpression,e,{getParameterTypes:function(){return e.DATE_TYPE}});SUGAR.expressions.TimeExpression=function(e){};SUGAR.util.extend(SUGAR.expressions.TimeExpression,e,{getParameterTypes:function(){return e.TIME_TYPE}});SUGAR.expressions.RelateExpression=function(e){};SUGAR.util.extend(SUGAR.expressions.RelateExpression,e,{getParameterTypes:function(){return e.GENERIC_TYPE}});e.TYPE_MAP={number:SUGAR.expressions.NumericExpression,string:SUGAR.expressions.StringExpression,date:SUGAR.expressions.DateExpression,time:SUGAR.expressions.TimeExpression,"boolean":SUGAR.expressions.BooleanExpression,"enum":SUGAR.expressions.EnumExpression,relate:SUGAR.expressions.RelateExpression,generic:SUGAR.expressions.GenericExpression};e.TYPE_CAST_MAP={number:"ValueOfExpression",string:"DefineStringExpression"};SUGAR.expressions.ConstantExpression=function(e){this.init(e)};SUGAR.util.extend(SUGAR.expressions.ConstantExpression,SUGAR.expressions.NumericExpression,{evaluate:function(){return this.getParameters()},getParamCount:function(){return 1}});SUGAR.expressions.StringLiteralExpression=function(e){this.init(e)};SUGAR.util.extend(SUGAR.expressions.StringLiteralExpression,SUGAR.expressions.StringExpression,{evaluate:function(){return this.getParameters()},getParamCount:function(){return 1}});SUGAR.expressions.FalseExpression=function(e){this.init(e)};SUGAR.util.extend(SUGAR.expressions.FalseExpression,SUGAR.expressions.BooleanExpression,{evaluate:function(){return e.FALSE},getParamCount:function(){return 0}});SUGAR.expressions.TrueExpression=function(e){this.init(e)};SUGAR.util.extend(SUGAR.expressions.TrueExpression,SUGAR.expressions.BooleanExpression,{evaluate:function(){return e.TRUE},getParamCount:function(){return 0}});var t=SUGAR.expressions.ExpressionParser=function(){};t.prototype.getFieldsFromExpression=function(e){return _.map(e.match(/\$(\w+)/g),function(e){return e.replace(/\$/g,"")})};t.prototype._generateRange=function(e,t,i){var n="";var r=parseInt(t);if(typeof i=="undefined")while(this.getElement(e+""+r)!=null)n+="$"+e+""+r++ +",";else for(;r<=i;r++){var a=e+""+r;if(this.getElement(a)!=null)n+="$"+a+","}return n.substring(0,n.length-1)};t.prototype._valueReplace=function(e){if(!/^\$.*$/.test(e)){return e}return this.getValue(e.substring(1))};t.prototype._performRangeReplace=function(e){var t=false;var i;var n;for(var r=0;;r++){if(r==e.length)break;var a=e.charAt(r);if(a=='"'&&i!="\\")t=!t;if(!t&&a=="%"){n=true;var s=e.indexOf("[",r+1);var o=e.indexOf(",",s);var l=e.indexOf("]",s);if(s<0||l<0)throw"Invalid range syntax";var u=e.substring(r+1,s);var f,c;if(o>-1&&o<l){f=e.substring(s+1,o);c=e.substring(o+1,l)}else{f=e.substring(s+1,l)}if(o>-1&&o<l)c=e.substring(o+1,l);var d=this._generateRange(u,this._valueReplace(f),this._valueReplace(c));if(typeof c=="undefined")e=e.replace("%"+u+"["+f+"]",d);else e=e.replace("%"+u+"["+f+","+c+"]",d);r=r+d.length-1}i=a}return e};t.prototype.validate=function(e){if(typeof e!="string")throw"ExpressionParser requires a string expression.";var t=this.toConstant(e);if(t!=null&&typeof t!="undefined")return true;if(/^[\w\-]+\(.*\)$/.exec(e)==null){throw"Syntax Error (Expression Format Incorrect '"+e+"' )"}if(e.indexOf("(")<0)throw"Syntax Error (No opening paranthesis found)";return true};t.prototype.tokenize=function(e){var t=this.toConstant(e);if(t!=null&&typeof t!="undefined"){return{type:"constant",returnType:this.getType(t),value:t.evaluate()}}if(/^[$]\w+$/.test(e)){return{type:"variable",name:$.trim(e).substr(1)}}if(/^[$]\w+\.\w+$/.test(e)){e=$.trim(e);return{type:"variable",name:e.substr(1,e.indexOf(".")-1),relate:e.substr(e.indexOf(".")+1)}}var i=e.indexOf("(");if(i<1)throw e+": Syntax Error, no open parentheses found";if(e.charAt(e.length-1)!=")")throw e+": Syntax Error, no close parentheses found";var n=e.substring(0,i);var r=e.substring(i+1,e.length-1);var a=0;var s=r.length;var o="";var l=new Array;var u=null;var f=null;var c=false;var d=false;var p=false;var h=false;for(var _=0;_<=s;_++){f=u;d=false;if(_==s){o=$.trim(o);if(o!="")l[l.length]=this.tokenize(o);break}h=f=="\\";u=r.charAt(_);if(p&&u!='"'&&!h){o+=u;continue}if(u=='"'&&!h&&a==0){if(p){var g=r.indexOf(",",_);if(g<0)g=r.length-1;var m=_<s-1?_+1:s-1;var v=r.substring(m,g);if(/^\s*$/.exec(v)==null)throw n+": Syntax Error (Improperly Terminated String '"+v+"')"+m+" "+g}p=!p}if(u=="("){a++}else if(u==")"){a--}else if(u==","&&a==0){o=$.trim(o);if(o=="")throw"Syntax Error: Unexpected ','";l[l.length]=this.tokenize(o);o="";d=true;continue}o+=u}if(p)throw"Syntax Error (Unterminated String Literal)";if(a!=0)throw"Syntax Error (Incorrectly Matched Parantheses)";if(d)throw"Syntax Error (No parameter after comma near <b>"+n+"</b>)";return{type:"function",name:$.trim(n),args:l}};t.prototype.getType=function(t){for(var i in e.TYPE_MAP){if(t instanceof e.TYPE_MAP[i]){return i}}return false};t.prototype.evaluate=function(e,t){if(typeof e!="string")throw"ExpressionParser requires a string expression.";e=e.replace(/^\s+|\s+$|\n/g,"");var i=this.toConstant(e);if(i!=null&&typeof i!="undefined")return i;if(e.match(/^\$\w+$/)){if(typeof t=="undefined")throw"Syntax Error: variable "+e+" without context";return t.getValue(e.substring(1))}if(e.match(/^\$\w+\.\w+$/)){return t.getRelatedValue(e.substr(1,e.indexOf(".")-1),e.substr(e.indexOf(".")+1))}if(/^[\w\-]+\(.*\)$/.exec(e)==null){throw"Syntax Error (Expression Format Incorrect '"+e+"' )"}var n=e.indexOf("(");if(n<0)throw"Syntax Error (No opening paranthesis found)";var r=e.substring(0,n);if(SUGAR.FunctionMap[r]==null)throw r+": No such function defined";var a=e.substring(n+1,e.length-1);var s=0;var o=a.length;var l="";var u=new Array;var f=null;var c=null;var d=false;var p=false;var h=false;var _=false;if(o>0){for(var g=0;g<=o;g++){c=f;if(g==o){u[u.length]=this.evaluate(l,t);break}h=c=="\\";f=a.charAt(g);if(p&&f!='"'&&!h){l+=f;continue}if(_&&(f==" "||f==","))_=false;if(f=='"'&&!h&&s==0){if(p){var m=a.indexOf(",",g);if(m<0)m=a.length-1;var v=g<o-1?g+1:o-1;var y=a.substring(v,m);if(/^\s*$/.exec(y)==null)throw r+": Syntax Error (Improperly Terminated String '"+y+"')"+v+" "+m}p=!p}if(f=="$"&&!h&&!p&&s==0){if(_)throw r+": Syntax Error (unexpeted '$' in  '"+l+"')";else{_=true}}if(f=="("){s++}else if(f==")"){s--}else if(f==","&&s==0){u[u.length]=this.evaluate(l,t);l="";continue}l+=f}}if(p)throw"Syntax Error (Unterminated String Literal)";if(s!=0)throw"Syntax Error (Incorrectly Matched Parantheses)";return new SUGAR.FunctionMap[r](u,t)};t.prototype.toConstant=function(e){if(isFinite(e)&&!isNaN(parseFloat(e))){return new SUGAR.expressions.ConstantExpression(parseFloat(e))}var t=SUGAR.expressions.NumericConstants[e];if(t!=null&&typeof t!="undefined")return new SUGAR.expressions.ConstantExpression(parseFloat(t));if(/^"[\s\S]*"$/.exec(e)!=null){e=e.substring(1,e.length-1);return new SUGAR.expressions.StringLiteralExpression(e)}if(e==""){return new SUGAR.expressions.StringLiteralExpression(e)}if(e=="true"){return new SUGAR.expressions.TrueExpression}else if(e=="false"){return new SUGAR.expressions.FalseExpression}if(/^(0[0-9]|1[0-2])\/([0-2][0-9]|3[0-1])\/[0-3][0-9]{3,3}$/.exec(e)!=null){var i=parseFloat(e.substring(0,2));var n=parseFloat(e.substring(3,2));var r=parseFloat(e.substring(6,4));return new SUGAR.DateExpression([i,n,r])}if(/^([0-1][0-9]|2[0-4]):[0-5][0-9]:[0-5][0-9]$/.exec(e)!=null){var a=parseFloat(e.substring(0,2));var s=parseFloat(e.substring(3,2));var o=parseFloat(e.substring(6,2));return new SUGAR.TimeExpression([a,s,o])}return null};t.prototype.getRelatedFieldsFromFormula=function(e){var t=[],i=["related","count","rollupSum","rollupMax","rollupMin","rollupAve","rollupCurrencySum"];var n=function(e){if(e.type=="variable"&&e.relate){t.push({type:"related",link:e.name,relate:e.relate})}else if(e.type=="function"&&i.indexOf(e.name)!=-1){switch(e.name){case"related":if(e.args[1].type=="constant")t.push({type:"related",link:e.args[0].name,relate:e.args[1].value});break;case"count":t.push({type:"count",link:e.args[0].name});break;default:if(e.args[1].type=="constant"){t.push({type:e.name,link:e.args[0].name,relate:e.args[1].value})}}}else if(e.type=="function"){for(var r=0;r<e.args.length;r++){n(e.args[r])}}};try{var r=this.tokenize(e);n(r)}catch(a){}return t};var i=SUGAR.expressions.ExpressionContext=function(){};i.prototype.getValue=function(e){return""};i.prototype.setValue=function(e,t){return""};i.prototype.addListener=function(e,t,i){return""};i.prototype.getRelatedValue=function(e,t){return new SUGAR.RelatedFieldExpression([new SUGAR.expressions.StringLiteralExpression(e),new SUGAR.expressions.StringLiteralExpression(t)])};SUGAR.expressions.isNumeric=function(e){if(typeof e!="number"&&typeof e!="string"){return false}e=SUGAR.expressions.unFormatNumber(e);return isFinite(e)&&!isNaN(parseFloat(e))};SUGAR.expressions.unFormatNumber=function(e){if(typeof e=="string"){var t=SUGAR.expressions;var i=",",n=".";if(t.userPrefs){i=t.userPrefs.num_grp_sep;n=t.userPrefs.dec_sep}e=t.replaceAll(e,i,"");e=t.replaceAll(e,n,".")}return e};SUGAR.expressions.replaceAll=function(e,t,i){if(t==i||e==""||t=="")return e;var n=e;while(n.indexOf(t)>-1){n=n.replace(t,i)}return n};SUGAR.util.DateUtils={parse:function(e,t){if(e instanceof Date)return e;if(t=="user"){if(SUGAR.expressions.userPrefs&&SUGAR.expressions.userPrefs.datef){t=SUGAR.expressions.userPrefs.datef+" "+SUGAR.expressions.userPrefs.timef}else{t=SUGAR.util.DateUtils.guessFormat(e)}}if(t==null||t==""){t=SUGAR.util.DateUtils.guessFormat(e)}if(t==false){if(/^\d+$/.test(e))return new Date(e);return false}var i=new Date("Jan 1, 1970 00:00:00");var n="";var r=$.trim(e);t=$.trim(t)+" ";for(var a=0;a<t.length;a++){var s=t.charAt(a);if(s==":"||s=="/"||s=="-"||s=="."||s==" "||s=="a"||s=="A"||s=="T"){var o=r.indexOf(s);if(o==-1)o=r.length;var l=r.substring(0,o);r=r.substring(o+1);switch(n){case"m":if(!(l>0&&l<13))return false;i.setMonth(l-1);break;case"d":if(!(l>0&&l<32))return false;i.setDate(l);break;case"Y":if(!(l>0))return false;i.setYear(l);break;case"h":var u=t.substring(t.length-4);if(u.toLowerCase()=="i a "||u.toLowerCase()==s+"ia "){if(r.substring(r.length-2).toLowerCase()=="pm"){l=l*1;if(l<12){l+=12}}}case"H":i.setHours(l);break;case"i":l=l.substring(0,2);i.setMinutes(l);break}n=""}else{n=s}}return i},guessFormat:function(e){if(typeof e!="string")return false;var t="";var i;if(e.indexOf(" ")!=-1){i=" "}else if(e.indexOf("T")!=-1){i="T"}if(i){t=e.substring(e.indexOf(i)+1,e.length);e=e.substring(0,e.indexOf(i))}var n="/";if(e.indexOf("/")!=-1){}else if(e.indexOf("-")!=-1){n="-"}else if(e.indexOf(".")!=-1){n="."}else{return false}var r=e.split(n);var a="";var s=new Date("Jan 1, 1970 00:00:00");if(r[0].length==4){a="Y"+n+"m"+n+"d"}else if(r[2].length==4){a="m"+n+"d"+n+"Y"}else{return false}if(t!=""){var o="";var l=":";if(t.indexOf(".")==2){l="."}if(t.indexOf(" ")!=-1){var u=t.split(" ");if(u[1]=="am"||u[1]=="pm"){return a+i+"h"+l+"i a"}else if(u[1]=="AM"||u[1]=="PM"){return a+i+"h"+l+"i A"}}else{var f=t.substring(t.length-2,t.length);if(f=="AM"||f=="PM"){return a+i+"h"+l+"iA"}if(f=="am"||f=="pm"){return a+i+"h"+l+"iA"}return a+i+"H"+l+"i"}}return a},formatDate:function(e,t,i){if(!i&&SUGAR.expressions.userPrefs.datef&&SUGAR.expressions.userPrefs.timef){if(t)i=SUGAR.expressions.userPrefs.datef+" "+SUGAR.expressions.userPrefs.timef;else i=SUGAR.expressions.userPrefs.datef}var n="";for(var r=0;r<i.length;r++){var a=i.charAt(r);switch(a){case"m":var s=e.getMonth()+1;n+=s<10?"0"+s:s;break;case"d":var o=e.getDate();n+=o<10?"0"+o:o;break;case"Y":n+=e.getFullYear();break;case"H":case"h":var l=e.getHours();if(a=="h")l=l>12?l-12:l;n+=l<10?"0"+l:l;break;case"i":var s=e.getMinutes();n+=s<10?"0"+s:s;break;case"a":if(e.getHours()<12)n+="am";else n+="pm";break;case"A":if(e.getHours()<12)n+="AM";else n+="PM";break;default:n+=a}}return n},roundTime:function(e){var t=e.getMinutes();if(t<1){t=0}else if(t<16){t=15}else if(t<31){t=30}else if(t<46){t=45}else{t=0;e.setHours(e.getHours()+1)}e.setMinutes(t);return e},getUserTime:function(){var e=new Date;if(SUGAR.expressions.userPrefs&&typeof SUGAR.expressions.userPrefs.gmt_offset!="undefined"){var t=SUGAR.expressions.userPrefs.gmt_offset;e.setMinutes(e.getMinutes()+(e.getTimezoneOffset()+t))}return e}}})()},371:function(e,t){(function(){SUGAR.forms=SUGAR.forms||{};SUGAR.forms.animation=SUGAR.forms.animation||{};var e=SUGAR.expressions,t=e.SidecarExpressionContext=function(e){this.view=e;this.model=e.model||e.context.get("model")};SUGAR.util.extend(t,e.ExpressionContext,{getValue:function(i){var n=this.model.get(i),r=this.model.fields[i],a;if(r.type=="link")n=i;if(typeof n=="string"){n=n.replace(/\n/g,"");if(/^(\s*)$/.exec(n)!=null||n===""){a=t.parser.toConstant('""')}else if(r.type!=="currency"&&e.isNumeric(n)){a=t.parser.toConstant(e.unFormatNumber(n))}else if(r.type=="date"||r.type=="datetime"){n=App.date.stripIsoTimeDelimterAndTZ(n);n=App.date.parse(n);n.type=r.type;a=this.getDateExpression(n)}else{a=t.parser.toConstant('"'+n+'"')}}else if(typeof n=="object"&&n!=null&&n.getTime){a=this.getDateExpression(n)}else if(typeof n=="number"){a=t.parser.toConstant(""+n)}else if(_.isBoolean(n)){a=n?new SUGAR.expressions.TrueExpression:new SUGAR.expressions.FalseExpression}else{a=t.parser.toConstant('""')}return a},setValue:function(e,t){if(typeof this.model.fields[e]!="object"){return}var i=this.model.fields[e];this.lockedFields=this.lockedFields||[];if(typeof t=="object"&&t.length>0&&i.type!="multienum"){t=t.join(", ")}else if(t&&i.type==="date"){t=App.date(t).formatServer(true)}else if(t&&i.type==="datetimecombo"){t=App.date(t).format()}if(i.type=="bool"&&_.isString(t)){t=SUGAR.expressions.Expression.isTruthy(t)}if(t&&(i.type==="decimal"||i.type==="float")){t=App.utils.formatNumber(t,i.round||6,i.precision||6,null,null)}if(_.isString(t)&&i.len&&t.length>i.len){var n=this;t=t.substring(0,i.len);this.model.once("change:"+e,function(){var t=SUGAR.App.lang.getAppString("LBL_FIELD_TRIMMED");SUGAR.forms.markField(e,n.getElement(e),t)})}else if(SUGAR.forms.markedField[e]){SUGAR.forms.unmarkField(e,this.getElement(e))}if(!this.lockedFields[e]){this.lockedFields[e]=true;var r=this.getElement(e);if(r){SUGAR.forms.FlashField($(r).parents('[data-fieldname="'+e+'"]'),null,e)}var a=this.model.set(e,t);this.lockedFields=[];return a}},addListener:function(e,t,i){if(this.view.collection){this.view.collection.off("change:"+e,t,i);this.view.collection.on("change:"+e,t,i)}else{this.model.off("change:"+e,t,i);this.model.on("change:"+e,t,i)}},getElement:function(e){var t=this.getField(e);if(t&&t.el)return t.el},getField:function(e){return this.view.getField(e,this.model)},addClass:function(e,t,i){var n=this.view.getFieldMeta(e),r=i?["css_class","cell_css"]:["css_class"],a=this.getElement(e),s=$(a).closest("div.record-cell");_.each(r,function(e){if(!n[e]){n[e]=t}else if(n[e].indexOf(t)==-1){n[e]+=" "+t}});this.view.setFieldMeta(e,n);$(a).addClass(t);if(i&&s){s.addClass(t)}},removeClass:function(e,t,i){var n=this.view.getFieldMeta(e),r=this.view.getField(e),a=i?["css_class","cell_css"]:["css_class"],s=this.getElement(e),o=$(s).closest("div.record-cell");_.each([r.def,n],function(e){_.each(a,function(i){if(e[i]&&e[i].indexOf(t)!=-1){e[i]=$.trim((" "+e[i]+" ").replace(new RegExp(" "+t+" "),""))}})});this.view.setFieldMeta(e,n);$(s).removeClass(t);if(i&&o){o.removeClass(t);o.find("."+t).removeClass(t)}},getLink:function(e){var t=this.model;if(t&&t.fields&&t.fields[e])return t.fields[e]},showError:function(e,t){},clearError:function(e){},setStyle:function(e,t){},setRelatedFields:function(e,t){t=!!t;var i=this.model;for(var n in e){var r=i.get(n),a=!!r,s=r||{};_.each(e[n],function(e,t){if(_.isObject(e)){s[t]=_.extend(s[t]||{},e)}else{s[t]=e}});var o={};o[n]=s;i.set(o,{silent:t});if(!t&&a){i.trigger("change:"+n,i)}}},getRelatedFieldValues:function(e,t,i,n){var r=this,a=App.api;if(e.length>0){t=t||this.view.context.get("module");i=i||this.model.get("id");for(var s=0;s<e.length;s++){var o=e[s].link,l={};if(e[s].type=="related"){var u=this.model.fields[o];if(u&&u.id_name&&u.module){var f=this.model.get(u.id_name);if(f){e[s].relId=f;e[s].relModule=u.module}}}if(e[s].relate){l[o]={};l[o][e[s].type]={};l[o][e[s].type][e[s].relate]="";r.setRelatedFields(l,true)}}var c={id:i,action:"related"},d={module:t,fields:JSON.stringify(e)};a.call("read",a.buildURL("ExpressionEngine","related",c,d),c,d,{success:function(e){r.setRelatedFields(e,n);return e}})}return null},getRelatedField:function(e,t,i){var n=this.model.get(e)||{};if(t=="related"&&!this.inCollection){return this._handleRelateExpression(e,i)}if(typeof n[t]!="undefined"){if(!i){return n[t]}else if(typeof n[t][i]!="undefined"){return n[t][i]}}if(this.inCollection){n[t]=n[t]||{};n[t][i]=n[t][i]||"";this.model.set(e,n,{silent:true});return""}if(!this.model.get("id")){return""}var r={link:e,type:t};if(i){r.relate=i}this.getRelatedFieldValues([r]);if(typeof n[t]=="undefined")return"";return n[t]},_handleRelateExpression:function(e,t){this.view.context.set("model",this.model);var i=this.view.context.getChildContext({link:e});i.prepare();var n=i.get("collection"),r=i.get("fields")||[],a=this,s=_.find(this.model.fields,function(t){return t.type&&t.type=="relate"&&t.id_name&&t.link&&t.link==e}),o=i.get("model");if(i.isDataFetched()&&!i.get("modelId")){o=n.length>0?n.models[0]:null}if(s&&(!this.model.get(s.id_name)||o&&o.get("id")!=this.model.get(s.id_name))){i.set({model:null});i.resetLoadFlag();if(!this.model.get(s.id_name))return""}if(_.isUndefined(this.view._loadedRelatedFields)){this.view._loadedRelatedFields={}}var l=e+"_"+t+"_"+this.model.get(s.id_name);if(t&&(!i.isDataFetched()||o&&_.isUndefined(o.get(t)))&&!this.view._loadedRelatedFields.hasOwnProperty(l)){if(!_.contains(r,t)){r.push(t)}this.view._loadedRelatedFields[l]=l;this._loadRelatedData(e,r,i,s);this.addListener(s.id_name,function(){this.view._loadedRelatedFields={}},this)}else if(o){var u=o.get(t);if(u){var f=o.fields[t];if(f.type=="date"||f.type=="datetime"){u=App.date.stripIsoTimeDelimterAndTZ(u);u=App.date.parse(u);u.type=f.type}}return u}else if(!n.page){var c=this.model;SUGAR.App.utils.doWhen(function(){return n.page>0},function(){c.trigger("change:"+e,c)})}return""},getDateExpression:function(t){var i=new e.DateExpression("");i.evaluate=function(){return this.value};i.value=t;return i},_loadRelatedData:function(e,t,i,n){var r=this;if(n&&this.model.get(n.id_name)){var a=this.model.get(n.id_name),s=i.get("model")||SUGAR.App.data.createRelatedBean(this.model,this.model.get(n.id_name),e);i.set({modelId:a,model:s})}else{if(_.isEmpty(this.model.get("id")))return""}i.prepare();i.set({fields:_.union(i.get("fields")||[],t),skipFetch:false});if(i.isDataFetched()){i.resetLoadFlag()}if(n)i.attributes.link=null;var s=this.model;i.loadData({success:function(){s.trigger("change:"+e,s)}});if(n)i.attributes.link=e},_setupLinks:function(e){_.each(e,function(e){if(e.link&&e.relate&&e.type=="related"){var t=this.view.context.getChildContext({link:e.link});if(t){t.set("fields",_.union(t.get("fields")||[],[e.relate]))}}},this)},_requestRollups:function(e){if(this.model.get("id")){this.getRelatedFieldValues(e,null,null,true)}},fireOnLoad:function(e){},getAppListStrings:function(e){return SUGAR.App.lang.getAppListStrings(e)},parseDate:function(e,t){return SUGAR.App.date.parse(e)},setFieldDisabled:function(e,t){t=_.isUndefined(t)?true:t;var i=this.getField(e);if(i){i.setDisabled(t);this.view.$("span.record-edit-link-wrapper[data-name="+e+"]").toggleClass("hide",t);if(_.isEqual(t,false)&&!_.isEqual(i.currentState,"edit")&&_.isEqual(this.view.currentState,"edit")&&!_.isEqual(this.view.inlineEditMode,true)){i.setMode("edit");this.view.editableFields.push(i)}if(_.isFunction(this.view.setEditableFields)){this.view.setEditableFields()}}},setFieldRequired:function(e,t){t=SUGAR.expressions.Expression.isTruthy(t);var i=this.view.getField(e,this.model);if(i){i.def.required=t;i.render()}},setAssignedUserName:function(e,t){if(this.model.has("assigned_user_name")&&this.model.has("assigned_user_id")){var i=this,n={},r=SUGAR.App.data.createBeanCollection("Users");n.filter={filter:[{user_name:t}]};n.success=function(t){var n=t.first();if(n){i.model.set({assigned_user_name:n.get("full_name"),assigned_user_id:n.get("id")});var r=i.view.getField(e,i.model);if(r&&r.el){SUGAR.forms.FlashField(r.el,null,e)}}};n.error=function(){SUGAR.App.alert.show("server-error",{level:"error",title:SUGAR.App.lang.get("ERR_GENERIC_TITLE"),messages:SUGAR.App.lang.get("ERR_ASSIGNTO_ACTION")})};r.fetch({fields:["full_name"],limit:1,params:n.filter,success:n.success,error:n.error})}},setModel:function(e){this.model=e},add:function(e,t){return SUGAR.App.math.add(e,t,6,true)},subtract:function(e,t){return SUGAR.App.math.sub(e,t,6,true)},multiply:function(e,t){return SUGAR.App.math.mul(e,t,6,true)},divide:function(e,t){return SUGAR.App.math.div(e,t,6,true)},round:function(e,t){return SUGAR.App.math.round(e,t,true)}});t.parser=new SUGAR.expressions.ExpressionParser;t.evalVariableExpression=function(e,i){return t.parser.evaluate(e,new t(i))};SUGAR.forms.Dependency=function(e,t,i,n,r){this.actions=t;this.falseActions=i;this.context=r;this.testOnLoad=n;e.setContext(this.context);e.setDependency(this);this.trigger=e;if(n){r.fireOnLoad(this)}};SUGAR.forms.Dependency.fromMeta=function(t,i){var n=t.trigger||"true",r=t.triggerFields||e.ExpressionParser.prototype.getFieldsFromExpression(n),a=t.actions||[],s=t.notActions||[],o=t.onload||false,l=i.model&&_.isEmpty(i.model.get("id")),u=[],f=[];if(_.isEmpty(r)&&!o&&!l)return null;if(_.isEmpty(a)&&_.isEmpty(s))return null;_.each(a,function(e){if(!e.action||!SUGAR.forms[e.action+"Action"])return;var t=true;if(e.action==="SetValue"&&e.params.target){t=App.acl.hasAccess("edit",this.model.module,undefined,e.params.target)}if(t){u.push(new SUGAR.forms[e.action+"Action"](e.params))}},i);_.each(s,function(e){if(!e.action||!SUGAR.forms[e.action+"Action"])return;var t=true;if(e.action==="SetValue"&&e.params.target){t=App.acl.hasAccess("edit",this.model.module,undefined,e.params.target)}if(t){f.push(new SUGAR.forms[e.action+"Action"](e.params))}},i);return new SUGAR.forms.Dependency(new SUGAR.forms.Trigger(r,n,i),u,f,o,i)};SUGAR.forms.Dependency.prototype.fireLinkOnlyDependency=function(){if(!this.testOnLoad){return false}var e=true;if(this.context.model.fields){_.each(this.trigger.variables,function(t){e=e&&this.context.model.fields[t]&&this.context.model.fields[t].type=="link"},this)}return e};SUGAR.forms.Dependency.prototype.fire=function(e){if(this.context.view.disposed||!this.context.view.context){return}try{var t=this.context.model;this.lastTriggeredActions=this.lastTriggeredActions||[];if(t.inSync&&!this.testOnLoad){return}var i=this.actions;if(e&&this.falseActions!=null)i=this.falseActions;_.each(this.lastTriggeredActions,function(e){this.context.view.off(null,null,e)},this);if(i instanceof SUGAR.forms.AbstractAction)i=[i];for(var n in i){var r=i[n];if(typeof r.exec=="function"){r.setContext(this.context);r.exec();if(this.testOnLoad&&r.afterRender){this.context.view.on("render",r.exec,r)}}}this.lastTriggeredActions=i}catch(a){if(!SUGAR.isIE&&console&&console.log){console.log("ERROR: "+a)}return}};SUGAR.forms.Dependency.prototype.getRelatedFields=function(){var e=t.parser,i=e.getRelatedFieldsFromFormula(this.trigger.condition);var n=function(t){if(t instanceof SUGAR.forms.AbstractAction){t=[t]}for(var n in t){var r=t[n];if(typeof r.exec=="function"){for(var a in r){if(typeof r[a]=="string")i=$.merge(i,e.getRelatedFieldsFromFormula(r[a]))}}}};n(this.actions);n(this.falseActions);return i};SUGAR.forms.AbstractAction=function(e){this.target=e};SUGAR.forms.AbstractAction.prototype.exec=function(){};SUGAR.forms.AbstractAction.prototype.setContext=function(e){this.context=e};SUGAR.forms.AbstractAction.prototype.evalExpression=function(e,i){i=i||this.context;return t.parser.evaluate(e,i).evaluate()};SUGAR.forms.AbstractAction.prototype.canSetValue=function(e){if(e.options&&e.options.revert){return false}if(e.isOnLoad){return false}return true};SUGAR.forms.Trigger=function(e,t,i){this.variables=e;this.condition=t;this.context=i;this.dependency={};this._attachListeners()};SUGAR.forms.Trigger.prototype._attachListeners=function(){if(!(this.variables instanceof Array)){this.variables=[this.variables]}for(var e=0;e<this.variables.length;e++){this.context.addListener(this.variables[e],SUGAR.forms.Trigger.fire,this,true)}};SUGAR.forms.Trigger.prototype.setDependency=function(e){this.dependency=e};SUGAR.forms.Trigger.prototype.setContext=function(e){this.context=e};SUGAR.forms.Trigger.fire=function(e,i,n){var r,a;if(e){this.context.setModel(e)}this.context.options=n;try{r=t.parser.evaluate(this.condition,this.context)}catch(s){if(!SUGAR.isIE&&console&&console.log){console.log("ERROR:"+s+"; in Condition: "+this.condition)}}if(typeof r!="undefined")a=r.evaluate();if(a==SUGAR.expressions.Expression.TRUE){if(this.dependency instanceof SUGAR.forms.Dependency){this.dependency.fire(false);return}}else if(a==SUGAR.expressions.Expression.FALSE){if(this.dependency instanceof SUGAR.forms.Dependency){this.dependency.fire(true);return}}};SUGAR.forms.flashInProgress={};SUGAR.forms.markedField={};SUGAR.forms.exclamationMarkTemplate=Handlebars.compile('<span class="warning-tooltip add-on" data-container="body" rel="tooltip" title="{{this}}"><i class="fa fa-warning"></i></span>');SUGAR.forms.FlashField=function(e,t,i){if(typeof e=="undefined"||!i&&!e.id)return;i=i||e.id;if(SUGAR.forms.flashInProgress[i])return;SUGAR.forms.flashInProgress[i]=true;t=t||"#FF8F8F";var n=e.style&&e.style.backgroundColor?e.style.backgroundColor:"#FFFFFF";$(e).css("backgroundColor",n);$(e).animate({backgroundColor:t},200,function(){$(e).animate({backgroundColor:n},200,function(){delete SUGAR.forms.flashInProgress[i]})})};SUGAR.forms.markField=function(e,t,i){if(SUGAR.forms.markedField[e])return;if(!t)return;var n=$(t).parents('[data-fieldname="'+e+'"]');var r=$(t).children();n.addClass("warning");var a=$(SUGAR.forms.exclamationMarkTemplate(i));SUGAR.App.utils.tooltip.initialize(a);r.wrap('<div class="input-append warning">');r.after(a);SUGAR.forms.markedField[e]=a};SUGAR.forms.unmarkField=function(e,t){if(!SUGAR.forms.markedField[e])return;if(!t)return;var i=$(t).parents('[data-fieldname="'+e+'"]');i.removeClass("warning");SUGAR.App.utils.tooltip.destroy(SUGAR.forms.markedField[e]);SUGAR.forms.markedField[e].remove();SUGAR.forms.markedField[e]=null};if(SUGAR.App&&SUGAR.App.plugins){SUGAR.App.plugins.register("SugarLogic","view",{onAttach:function(){this.on("init",function(){this.deps=[];var e=this.slContext=new SUGAR.expressions.SidecarExpressionContext(this),t=_.extend({},this.meta,this.options.meta),i=[],n=function(e,t){if(t.dependency.testOnLoad){t.context.isOnLoad=true;_.each(e,function(e){SUGAR.forms.Trigger.fire.apply(t,[e])});t.context.isOnLoad=null}},r=SUGAR.App.metadata.getModule(this.context.get("module"),"dependencies"),a=_.contains(this.plugins,"Editable")||e.view.name=="edit"||e.view.name=="create"?"edit":"view",s=t.dependencies;
if(!_.isEmpty(r)){var o=_.filter(r,function(e){if(_.contains(e.hooks,"all")||_.contains(e.hooks,a)){return true}return false});s=!_.isEmpty(s)?_.union(s,o):o}_.each(s,function(t){var r=SUGAR.forms.Dependency.fromMeta(t,e);if(r){i=_.union(i,r.getRelatedFields());if(this.context.isCreate()||r.fireLinkOnlyDependency()){SUGAR.forms.Trigger.fire.apply(r.trigger);this.trigger("sugarlogic:initialize")}if(r.testOnLoad){this.context.on("list:editrow:fire",function(){this.context.isOnLoad=true;SUGAR.forms.Trigger.fire.apply(this,arguments);delete this.context.isOnLoad},r.trigger);if(this.collection){this.collection.on("sync",function(e,t){var i,a;if(e instanceof Backbone.Collection){a=_.pluck(t,"id");i=e.filter(function(e){return _.contains(a,e.id)});_.defer(n,i,r.trigger)}else{SUGAR.forms.Trigger.fire.apply(r.trigger,[e])}},this)}}}this.deps.push(r)},this);e._setupLinks(i);e._requestRollups(i)});this.on("render",function(){_.each(this.deps,function(e){if(this.context.isCreate()||e.fireLinkOnlyDependency()){SUGAR.forms.Trigger.fire.apply(e.trigger);this.trigger("sugarlogic:initialize")}},this)})},getFieldNames:function(){var t=e.ExpressionParser.prototype.getFieldsFromExpression,i=Object.getPrototypeOf(this).getFieldNames.apply(this,arguments),n=_.extend({},this.meta,this.options.meta);_.each(n.dependencies,function(e){if(e.trigger){i=_.union(i,t(e.trigger))}_.each(e.actions,function(e){if(e.params){_.each(e.params,function(e){if(_.isString(e)){i=_.union(i,t(e))}})}})});if(this.model){i=_.filter(i,function(e){return this.model.fields[e]&&this.model.fields[e].type!="link"},this)}return i}})}else if(console.error){console.error("unable to find the plugin manager")}})()},372:function(e,t){(function(e){e.events=e.events||{};e.events.on({"offline:enabled":function(e){r("offline",e)},"app:start":function(){r("api",true)},"app:login:success":function(e,t){r("api",true,t)},"app:logout":function(){r("api",false)}});var t={offline:{readSimpleOrRelated:{status:false,operation:"fakeSelect"},readManyRecords:{status:false,operation:"fakeSelect"},readManyRelatedRecords:{status:false,operation:"fakeSelect"},createRecord:{status:false,operation:"fakeInsert"},createRelatedRecord:{status:false,operation:"fakeInsert"},updateRecord:{status:false,operation:"fakeUpdate"},updateRelatedRecord:{status:false,operation:"fakeUpdate"},softDeleteRecord:{status:false,operation:"fakeUpdate"},hardDeleteRecord:{status:false,operation:"fakeUpdate"},unlinkRecord:{status:false,operation:"fakeUpdate"}}},i={api:{records:{status:false,callbackIndex:4,optionsIndex:5,dataIndex:2,crudIndex:0,crud:[{name:"create",status:true},{name:"read one",status:false},{name:"read list",status:false},{name:"update",status:false},{name:"delete",status:false}]},relationships:{status:false,callbackIndex:4,optionsIndex:5,dataIndex:2,crudIndex:0,crud:[{name:"create",status:true},{name:"read one",status:false},{name:"read list",status:false},{name:"update",status:false},{name:"delete",status:false}]},favorite:{status:false,callbackIndex:3,optionsIndex:4},follow:{status:false,callbackIndex:3,optionsIndex:4}},http:[{name:"e0",status:false},{name:"e403",status:false},{name:"e404",status:false},{name:"e409",status:false},{name:"e422",status:false},{name:"e500",status:false}],emulationExceptions:{e409:{operation:"update",methods:["records","relationships"]}}},n={fakeSelect:function(){return{sql:"select xxxx"}},fakeInsert:function(){return{sql:"insert into xxxx"}},fakeUpdate:function(){return{sql:"update xxxx"}}};function r(n,r,u){var f=e.config.errorEmulation.user.toLowerCase();if(e.config.errorEmulation.enabled&&(e.user.get("user_name")===f||u===f)){if(n==="api"){a(r,i);l(r)}else{a(r,t);s(r);o(r);p()}}}function a(t,i){if(t){var n=e.utils.deepCopy(i);_.extend(e.config.errorEmulation,n)}else{_.each(i,function(t,i){delete e.config.errorEmulation[i]})}}function s(t){if(t){e.events.on("app:error:emulation:offline",function(t){var i=e.config.errorEmulation.offline[t],n=i&&i.status,r="_"+t,a=i.operation;u(n,r,a)})}else{e.events.off("app:error:emulation:offline");_.each(e.offline.storage.savedMethods,function(e,t){u(false,t)});delete e.offline.storage.savedMethods}}function o(t){if(t){_.extend(e.offline.storage._sqlHandlers,n)}else{_.each(n,function(t,i){delete e.offline.storage._sqlHandlers[i]})}}function l(t){if(t){if(!e.config.errorEmulation.apiFlag){e.events.on({"app:error:emulation:http":function(e){d(e);f(e)},"app:error:emulation:api":c,"app:error:emulation:crud":c});e.config.errorEmulation.apiFlag=true}}else{e.events.off("app:error:emulation:http app:error:emulation:api app:error:emulation:crud");delete e.config.errorEmulation.apiFlag;d("default");f("default")}}function u(t,i,n){if(t){e.offline.storage.savedMethods=e.offline.storage.savedMethods||{};if(!e.offline.storage.savedMethods[i]){e.offline.storage.savedMethods[i]=e.offline.storage[i]}e.offline.storage[i]=function(){var e=[{op:n,data:null,module:null,options:null}],t=arguments[arguments.length-1];this.exec(e,t.dbSuccess,t.dbFailure)}}else{e.offline.storage[i]=e.offline.storage.savedMethods[i];delete e.offline.storage.savedMethods[i]}}function f(t){var i=e.config.errorEmulation.api,n=[];_.each(i,function(e,t){if(e.status){n.push(t)}});_.each(e.api.savedMethods,function(t,i){e.api[i]=e.api.savedMethods[i]});delete e.api.savedMethods;e.controller.clean();if(t!=="default"){_.each(n,function(n){var r=_.findWhere(i[n].crud,{status:true});e.api.savedMethods=e.api.savedMethods||{};if(!e.api.savedMethods[n]){e.api.savedMethods[n]=e.api[n]}e.api[n]=function(){var e=i[n].callbackIndex,a=i[n].optionsIndex,s=i[n].crudIndex,o=i[n].dataIndex,l=r&&arguments[s]==="read"&&r.name.indexOf("read")>=0,u,f;if(!isNaN(o)){u=arguments[o]?arguments[o].link?arguments[o].relatedId?"one":"list":"one":"list";f=r.name==="read "+u}if(!r||arguments[s]===r.name||l&&f){arguments[e].error(new SUGAR.Api.HttpError({xhr:{status:t.substr(1)-0,responseText:'{"error":"emulated"}',getResponseHeader:function(){return"application/json"}},params:arguments[a]}));arguments[e].complete()}else{this.savedMethods[n].apply(this,arguments)}}})}}function c(){var t=_.findWhere(e.config.errorEmulation.http,{status:true});if(t){f(t.name)}}function d(t){var n=i.emulationExceptions[t],r=n?{code:t,operation:n.operation,methods:n.methods}:{code:"enableAll"};e.trigger("app:error:emulation:exceptions",r)}function p(){_.each(e.api.savedMethods,function(t,i){if(e.offline&&!_.isEmpty(e.offline.api.originalMethods)){e.offline.api.originalMethods[i]=e.api.savedMethods[i]}e.api.savedMethods[i]=e.api[i]});c()}})(SUGAR.App)}});