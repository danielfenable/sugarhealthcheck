/*
 * Your installation or use of this SugarCRM file is subject to the applicable
 * terms available at
 * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
 * If you do not agree to all of the applicable terms or do not have the
 * authority to bind the entity as an authorized representative, then do not
 * install or use this SugarCRM file.
 *
 * Copyright (C) SugarCRM Inc. All rights reserved.
 *//**
 * SugarCRM namespace.
 *
 * @ignore
 */var SUGAR=SUGAR||{};SUGAR.App=function(){function App(e){var t=_.uniqueId("SugarApp_");return e=e||{},_.extend({appId:t,$rootEl:_make$(e.el||"body"),$contentEl:_make$(e.contentEl||"#content"),additionalComponents:{}},this,Backbone.Events)}var _app,_modules={},_make$=function(e){return e instanceof $?e:$(e)};return{init:function(e){_app=_app||_.extend(this,new App(e)),_.extend(_app,_app.beforeEvent),_app.events.register("app:init",this),_app.events.register("app:start",this),_app.events.register("app:sync",this),_app.events.register("app:sync:complete",this),_app.events.register("app:sync:error",this),_app.events.register("app:login:success",this),_app.events.register("app:logout",this),_app.events.register("app:view:change",this),_app.events.register("app:locale:change",this),_app.events.register("lang:direction:change",this),_app.cache&&_app.cache.init(this);var t=_app.utils.capitalize(_app.config?_app.config.appId:"")+"Controller",n=this[t]||this.Controller;return this.controller=new n,_app.api=SUGAR.Api.getInstance({defaultErrorHandler:e&&e.defaultErrorHandler?e.defaultErrorHandler:SUGAR.App.error.handleHttpError,serverUrl:_app.config.serverUrl,platform:_app.config.platform,timeout:_app.config.serverTimeout,keyValueStore:_app[_app.config.authStore||"cache"],clientID:_app.config.clientID,disableBulkApi:_app.config.disableBulkApi,externalLoginUICallback:e&&e.externalLoginUICallback}),this._init(e),_app},_init:function(e){var t=this,n=function(n){if(!_app)return;if(n){t.trigger("app:sync:error",n);return}t._initModules(),t._loadConfig(),e.silent||_app.trigger("app:init",t),e.callback&&_.isFunction(e.callback)&&e.callback(_app)},r=function(e){_app.config.loadCss?_app.loadCss(e):e()};if(_app.config.syncConfig!==!1){var i={getPublic:!0};r(function(){_app.metadata.sync(n,i)})}else r(function(){n()});return _app},_initModules:function(){_.each(_modules,function(e){_.isFunction(e.init)&&e.init(this)},this)},_loadConfig:function(){_app.config=_app.config||{},_app.config=_.extend(_app.config,_app.metadata.getConfig())},loadCss:function(e){_app.api.css(_app.config.platform,_app.config.themeName,{success:function(t){_app.config.loadCss==="url"?_.each(t.url,function(e){$("<link>").attr({rel:"stylesheet",href:_app.utils.buildUrl(e)}).appendTo("head")}):_.each(t.text,function(e){$("<style>").html(e).appendTo("head")}),_.isFunction(e)&&e()}})},start:function(){_app.events.registerAjaxEvents(),_app.trigger("app:start",this),_app.routing.start()},destroy:function(){Backbone.history&&Backbone.history.stop(),_app=null},augment:function(e,t,n){this[e]=t,_modules[e]=t,n&&t.init&&_.isFunction(t.init)&&t.init.call(_app)},sync:function(e){var t=this;e=e||{};if(e.getPublic)return t.syncPublic(e);async.waterfall([function(n){t.isSynced=!1,t.trigger("app:sync");var r=!e.noUserUpdate&&(e.language||_app.cache.get("langHasChanged"));if(r){var i=e.language||_app.lang.getLanguage();t.user.updateLanguage(i,n),_app.cache.cut("langHasChanged")}else n()},function(n){async.parallel([function(e){t.user.load(e)},function(n){t.metadata.sync(function(e){t.data.declareModels(),n(e)},e)}],function(e){n(e)})},function(e){var n=t.metadata.getServerInfo();t.config.sugarLogic=t.config.sugarLogic||{},n&&t.config.sugarLogic.enabled&&t.utils.versionCompare(n.version,t.config.sugarLogic.minServerVersion,">=")?t.fetchSugarLogic(e):(t.config.sugarLogic.enabled=!1,e())},function(e){t.offline?t.offline.start({migrate:!0,callback:e}):e()}],function(n){n?t.trigger("app:sync:error",n):(t.isSynced=!0,t.trigger("app:sync:complete")),_.isFunction(e.callback)&&e.callback(n)})},syncPublic:function(e){e=e||{},e.getPublic=!0,this.metadata.sync(e.callback,e)},navigate:function(e,t,n){var r,i,s;e=e||_app.controller.context,t=t||e.get("model"),i=t.id,s=e.get("module")||t.module,r=this.router.buildRoute(s,i,n),this.router.navigate(r,{trigger:!0})},login:function(e,t,n){n=n||{},t=t||{},t.current_language=_app.lang.getLanguage(),_app.api.login(e,t,{success:function(t){_app.trigger("app:login:success",t,e.username),n.success&&n.success(t)},error:function(e){_app.error.handleHttpError(e),n.error&&n.error(e)},complete:n.complete})},logout:function(e,t,n){var r,i;return e=e||{},r=e.complete,i=e.error,e.complete=function(e){_app.trigger("app:logout",t),r&&r(e)},e.error=function(e){_app.error.handleHttpError(e),i&&i(e)},_app.api.logout(e,n)},fetchSugarLogic:function(e){_app.config.sugarLogic.isDynamic?_app.api.call("read",_app.api.buildURL("ExpressionEngine","functions"),null,{success:function(t){_app.cacheSugarLogicExpressions(t),_app.loadSugarLogic(t,e)},error:function(t){e(t)}},{dataType:"application/text"}):e()},cacheSugarLogicExpressions:function(e){_app.cache.set("sugarlogic",e)},_loadSugarLogic:function(){return _app.cache.get("sugarlogic")},loadSugarLogic:function(e,t){return _app.compileJs(e||_app._loadSugarLogic(),t)},compileJs:function(js,callback){try{eval.call(window,js),callback&&callback()}catch(e){return _app.logger.fatal("Failed to compile js"),callback&&callback(e),e}return null},isServerCompatible:function(e){var t=this.config.supportedServerFlavors,n=this.config.minServerVersion,r,i,s;return _.isEmpty(t)&&!n?!0:(r=!!(_.isEmpty(t)||e&&_.contains(t,e.flavor)),i=!!(!n||e&&this.utils.versionCompare(e.version,n,">=")),r&&i?!0:(i?s={code:"server_flavor_incompatible",label:"ERR_SERVER_FLAVOR_INCOMPATIBLE"}:s={code:"server_version_incompatible",label:"ERR_SERVER_VERSION_INCOMPATIBLE"},s.server_info=e,s))},modules:_modules}}(),function(app){var _doWhenStack=[],_doWhenLocked=!1,_doWhenInterval=!1,_doWhenretryCount=0,_startDoWhenInterval=function(){_doWhenInterval||(_doWhenInterval=window.setInterval(app.utils._doWhenCheck,50))};app.augment("utils",{capitalize:function(e){return e?e.charAt(0).toUpperCase()+(e.length>1?e.substr(1):""):""},capitalizeHyphenated:function(e){return this._classify(e,"-")},classify:function(e){return this._classify(e,"_")},_classify:function(e,t){var n=this,r="";t=t||"_";if(!e||e.lastIndexOf(t)===-1)r=n.capitalize(e);else{var i=e.split(t);_.each(i,function(e){r+=n.capitalize(e)})}return r},extendClass:function(e,t,n,r,i){var s=null,o=null;return _.isObject(r)?(t=_.isObject(r.extendsFrom)?r.extendsFrom:e[i+"Custom"+r.extendsFrom]||e[i+r.extendsFrom]||e["Custom"+r.extendsFrom]||e[r.extendsFrom]||t,s=e[n]=t.extend(r)):s=e[n]=t,s},formatNumber:function(e,t,n,r,i){t=t||n;var s=e;if(_.isNaN(e)||!_.isFinite(e))return s;if(_.isString(e)){e=parseFloat(e,10);if(_.isNaN(e))return s}return _.isNumber(e)?(e=parseFloat(e.toFixed(t),10).toFixed(n).toString(),_.isString(r)&&_.isString(i)?this.addNumberSeperators(e,r,i):e):(!_.isNull(e)&&!_.isUndefined(e)&&app.logger.warn("formatNumber: invalid variable type ("+typeof s+")"),s)},formatNumberLocale:function(e){return this.formatNumber(e,app.user.getPreference("decimal_precision")||2,app.user.getPreference("decimal_precision")||2,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".")},formatName:function(e,t){return t.replace(/(f)|(l)|(s)/g,function(t,n,r,i){return n?e.first_name||"":r?e.last_name||"":i&&(e.last_name||e.first_name)?e.salutation||"":""}).replace(/^( )?,/g,"").replace(/, $/g,"").replace(/  /g," ").trim()},formatNameModel:function(e,t,n){n=n||app.user.getPreference("default_locale_name_format"),t=t||{};var r=app.metadata.getModule(e)||{fields:{}},i=r.nameFormat||{};return _.reduce(n.split(""),function(e,n){if(n<"a"||n>"z")return e+n;if(!i[n])return e;var s,o=r.fields[i[n]]&&r.fields[i[n]].type==="enum"&&!_.isEmpty(r.fields[i[n]].options);if(o){var u=app.lang.getAppListStrings(r.fields[i[n]].options);s=u[t[i[n]]]||t[i[n]]||""}return e+(s||t[i[n]]||"")},"").replace(/^( )?,/g,"").replace(/, $/g,"").replace(/  /g," ").trim()},formatNameLocale:function(e){return this.formatName(e,app.user.getPreference("default_locale_name_format"))},addNumberSeperators:function(e,t,n){var r=e.split("."),i=/(\d+)(\d{3})/;while(t!==""&&i.test(r[0]))r[0]=r[0].toString().replace(i,"$1"+t+"$2");return r[0]+(r.length>1&&r[1]!==""?n+r[1]:"")},unformatNumberString:function(e,t,n,r){r=r||!1;if(typeof t=="undefined"||typeof n=="undefined")return e;_.isString(e)||(_.isFinite(e)?e.toString():e="");if(t!==""){var i=new RegExp("\\"+t,"g");e=e.replace(i,"")}e=e.replace(n,".");if(e.length>0&&r){var s=parseFloat(e);if(s==e)return s}return e},unformatNumberStringLocale:function(e,t){return this.unformatNumberString(e,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".",t)},formatString:function(e,t){for(var n in t)e=e.replace("{"+n+"}",t[n]);return e},regexEscape:function regexEscape(e){if(typeof regexEscape.specialRegExp=="undefined"){var t=["/",".","*","+","?","|","(",")","[","]","{","}","\\","-",",","^","$","#"];regexEscape.specialRegExp=new RegExp("(\\"+t.join("|\\")+")","g")}return e.replace(regexEscape.specialRegExp,"\\$1")},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})},cookie:{setCookie:function(e,t,n,r){var i=new Date,s;i.setDate(i.getDate()+n),s=encodeURIComponent(t),n&&(s+="; expires="+i.toUTCString()),r&&(s+="; path="+r),document.cookie=e+"="+s},getCookie:function(e){var t,n,r,i=document.cookie.split(";");for(t=0;t<i.length;t++){n=i[t].substr(0,i[t].indexOf("=")),r=i[t].substr(i[t].indexOf("=")+1),n=n.replace(/^\s+|\s+$/g,"");if(n===e)return decodeURIComponent(r)}}},isValidEmailAddress:function(e){return/^.+@.+$/ig.test(e)},doWhen:function(e,t,n,r){_doWhenStack.push({check:e,fn:t,obj:n,overrideContext:r}),_doWhenretryCount=50,_startDoWhenInterval()},_doWhenCheck:function(){if(_doWhenStack.length===0){_doWhenretryCount=0,_doWhenInterval&&(clearInterval(_doWhenInterval),_doWhenInterval=null);return}if(_doWhenLocked)return;_doWhenLocked=!0;var tryAgain=$.isReady;tryAgain||(tryAgain=_doWhenretryCount>0&&_doWhenStack.length>0);var notAvail=[],executeItem=function(e,t){t.overrideContext&&(t.overrideContext===!0?e=t.obj:e=t.overrideContext),t.fn&&t.fn.call(e,t.obj)},i,len,item,test;for(i=0,len=_doWhenStack.length;i<len;i+=1)item=_doWhenStack[i],item&&(test=item.check,typeof test=="string"&&eval(test)||typeof test=="function"&&test()?(executeItem(this,item),_doWhenStack[i]=null):notAvail.push(item));_doWhenretryCount--;if(tryAgain){for(i=_doWhenStack.length-1;i>-1;i--)item=_doWhenStack[i],(!item||!item.check)&&_doWhenStack.splice(i,1);_startDoWhenInterval()}else _doWhenInterval&&(clearInterval(_doWhenInterval),_doWhenInterval=null);_doWhenLocked=!1},versionCompare:function(e,t,n){return version_compare(e,t,n)},extendFrom:function(e,t,n){e.prototype=new t,_.extend(e.prototype,n)},deepCopy:function(e){return _.isObject(e)?JSON.parse(JSON.stringify(e)):e},compareBeans:function(e,t){var n;if(e.module!==t.module)throw Error("Only beans of the same module can be compared.");return n=_.reduce(e.attributes,function(n,r,i){return i!=="id"&&i.indexOf("_")!==0&&!this.areBeanValuesEqual(r,t.get(i))&&this.hasDefaultValueChanged(i,e)&&n.push(i),n},[],this),n},areBeanValuesEqual:function(e,t){var n=function(e){return _.isObject(e)&&_.isEmpty(e)?"":!_.isObject(e)&&(_.isUndefined(e)||_.isNull(e))?"":e};return e=n(e),t=n(t),_.isObject(e)&&_.isEqual(e,t)||!_.isObject(e)&&e===t},hasDefaultValueChanged:function(e,t){var n=t._defaults?t._defaults[e]:"";return!this.areBeanValuesEqual(n,t.get(e))},isConnectivityError:function(e){return e.status===0||e.textStatus==="timeout"},getTimestamp:function(e,t){t=t||{};var n=e?new Date(e):new Date,r=n.toISOString();return t.msecPrecision||(r=r.replace(/\.\d{3}/,"")),r.replace(/Z/,"+00:00")},buildUrl:function(e){return e.indexOf("http")!==0&&!_.isEmpty(app.config.siteUrl)&&(e=app.config.siteUrl.replace(/\/+$/,"")+"/"+e),e},getChangedProps:function(e,t,n){function r(e){return _.isObject(e)?_.isArray(e)?"array":"object":"other"}function i(e,t){if(n)return _.isEqual(e,t);var s=r(e),o=r(t);if(s===o&&_.contains(["object","array"],s)){if(s==="array"&&e.length!==t.length)return!1;var u=_.keys(e),a=_.keys(t);return u.length!==a.length||!_.isEqual(u.sort(),a.sort())?!1:!_.any(e,function(n,r){return!i(e[r],t[r])})}return n?e===t:e==t}var s={};return _.each(e,function(n,r){i(e[r],t[r])||(s[r]=n)}),s},getParentLayout:function(e){var t;return e.view&&e.view.layout?t=e.view.layout:t=e.layout,t},isSortable:function(e,t){var n=app.metadata.getModule(e).fields[t.name],r=!0;return n&&!_.isUndefined(n.sortable)&&(r=n.sortable),t&&!_.isUndefined(t.sortable)&&(r=t.sortable),r},stripHttpPrefix:function(e){return e.replace(/^https?:\/\//,"")},hardRefresh:function(){window.location.reload(!0)},isDirectionRTL:function(e){var t="A-Za-zÀ-ÖØ-öø-ʸ̀-֐ࠀ-῿Ⰰ-﬜﷾-﹯﻽-￿",n="֑-߿יִ-﷽ﹰ-ﻼ",r=new RegExp("^[^"+t+"]*["+n+"]");return r.test(e)}})}(SUGAR.App),function(e){var t="",n=function(e){return t+e},r={store:stash,init:function(){t=e.config.env+":"+e.config.appId+":",e.events.register("cache:clean",this)},has:function(e){if(this.store===stash)return window.localStorage.getItem(n(e))!==null;this.store.has(n(e))},get:function(e){return this.store.get(n(e))},set:function(e,t){try{this.store.set(n(e),t)}catch(r){r.name.toLowerCase().indexOf("quota")>-1&&(this.clean(),this.store.set(n(e),t))}},add:function(e,t){try{this.store.add(n(e),t)}catch(r){r.name.toLowerCase().indexOf("quota")>-1&&(this.clean(),this.store.add(n(e),t))}},clean:function(){var e=[],t={};this.trigger("cache:clean",function(t){e=_.union(t,e)}),_.each(e,function(e){t[e]=this.get(e)},this),this.cutAll(),_.each(t,function(e,t){_.isUndefined(e)||this.set(t,e)},this)},cut:function(e){this.store.has(n(e))&&this.store.cut(n(e))},cutAll:function(e){if(e===!0)return this.store.cutAll();_.each(this.store.getAll(),function(e,n){n.indexOf(t)===0&&this.store.cut(n)},this)}};_.extend(r,Backbone.Events),e.augment("cache",r)}(SUGAR.App),function(e){e.augment("events",_.extend({register:function(e,t){t.on(e,function(){var t=[].slice.call(arguments,0);t.unshift(e),this.trigger.apply(this,t)},this)},unregister:function(e,t){e.off(t)},registerAjaxEvents:function(){var e=this;$(document).off("ajaxStop"),$(document).off("ajaxStart"),$(document).on("ajaxStart",function(t){e.trigger("ajaxStart",t)}),$(document).on("ajaxStop",function(t){e.trigger("ajaxStop",t)})}},Backbone.Events))}(SUGAR.App),function(e){_.extend(e,{beforeEvent:{before:function(e,t,n,r){var i=this._before=this._before||{};return i[e]=i[e]||[],i[e].push({fn:t,params:n,overrideContext:r}),this},triggerBefore:function(e,t){var n=!1;if(this._before&&this._before[e]){var r=this._before[e];for(var i=0;i<r.length;i++){var s=r[i],o=this;s.overrideContext&&(s.overrideContext===!0?o=s.params:o=s.overrideContext);var u=t;t&&s.params?u=_.extend({},t,s.params):u=s.params||t,s.fn&&(n=n||s.fn.call(o,u)===!1)}}return!n},offBefore:function(e,t,n){if(!e)return delete this._before;var r=this._before=this._before||{};if(!r[e])return!1;if(!t&&!n)return delete r[e];var i=r[e];for(var s=i.length-1;s>=0;s--){var o=i[s],u=this;o.overrideContext&&(o.overrideContext===!0?u=o.params:u=o.overrideContext),o.fn==t&&(!n||n==u)&&i.splice(s,1)}return!0}}})}(SUGAR.App),function(e){var t={plugins:{view:{},field:{},layout:{},model:{},collection:{}},_get:function(e,t){if(this.plugins[t]&&this.plugins[t][e])return this.plugins[t][e]},attach:function(e,t){_.each(e.plugins,function(n,r){var i=null;if(_.isObject(n)){var s=_.keys(n)[0];i=n[s],n=s}var o=this._get(n,t);if(o&&!this._isPluginDisabled(e,n)){var u=_.extend({},_.isFunction(e.events)?e.events():e.events,o.events);_.extend(e,o),i&&(_.extend(e,i),i.events&&_.extend(u,i.events)),e.events=u,_.isFunction(o.onAttach)&&o.onAttach.call(e,e,o)}},this)},detach:function(e,t){_.each(e.plugins,function(n){var r=this._get(n,t);r&&_.isFunction(r.onDetach)&&r.onDetach.call(e,e,r)},this)},_isPluginDisabled:function(e,t){return!!_.find(e.disabledPlugins,function(e){return e===t})},register:function(e,t,n){_.isArray(t)||(t=[t]),_.each(t,function(t){this.plugins[t]=this.plugins[t]||{},this.plugins[t][e]=n},this)}};e.augment("plugins",t,!1)}(SUGAR.App),function(e){var t={init:function(){this.initialize()},initialize:function(e){e=e||{},this.remoteLogging=e.remoteLogging||!1,this.statusCodes=e.statusCodes?_.extend(this.statusCodes,e.statusCodes):this.statusCodes,e.disableOnError||this.enableOnError()},_callCustomHandler:function(e,t,n){t?t.apply(this,_.union([e],n||[])):this.handleStatusCodesFallback(e)},_handleFineGrainedError:function(t,n){var r="handle"+e.utils.classify(t.code)+"Error";(this[r]||n||this.handleStatusCodesFallback).call(this,t)},statusCodes:{0:function(e,t,n){e.textStatus==="timeout"?this._callCustomHandler(e,this.handleTimeoutError):this.handleStatusCodesFallback(e,t,n)},400:function(e){this._handleFineGrainedError(e,this.handleUnspecified400Error)},401:function(e){this._handleFineGrainedError(e,this.handleUnauthorizedError)},403:function(e){this._callCustomHandler(e,this.handleForbiddenError)},404:function(e){this._callCustomHandler(e,this.handleNotFoundError,_.rest(arguments))},405:function(e){this._callCustomHandler(e,this.handleMethodNotAllowedError)},409:function(e){this._callCustomHandler(e,this.handleMethodConflictError)},412:function(e){this._callCustomHandler(e,this.handleHeaderPreconditionFailed)},422:function(e,t){e.model=t,this._callCustomHandler(e,this.handleValidationError,_.rest(arguments))},424:function(e,t){e.model=t,this._callCustomHandler(e,this.handleMethodFailureError,_.rest(arguments))},500:function(e){this._callCustomHandler(e,this.handleServerError)},503:function(e){this._callCustomHandler(e,this.handleServerError)}},remoteLogging:!1,errorName2Keys:{maxValue:"ERROR_MAXVALUE",minValue:"ERROR_MINVALUE",maxLength:"ERROR_MAX_FIELD_LENGTH",minLength:"ERROR_MIN_FIELD_LENGTH",datetime:"ERROR_DATETIME",required:"ERROR_FIELD_REQUIRED",email:"ERROR_EMAIL",primaryEmail:"ERROR_PRIMARY_EMAIL",duplicateEmail:"ERROR_DUPLICATE_EMAIL",number:"ERROR_NUMBER",isBefore:"ERROR_IS_BEFORE",isAfter:"ERROR_IS_AFTER",greaterThan:"ERROR_IS_GREATER_THAN",lessThan:"ERROR_IS_LESS_THAN"},getErrorString:function(t,n){var r=n.module||"";return e.lang.get(this.errorName2Keys[t]||t,r,n)},handleValidationError:function(t){var n=t.responseText,r=t.model;e.alert.dismissAll(),_.each(n,function(t,n){var r="";_.isObject(t)?_.each(t,function(e,t){r+="(Message) "+this.getErrorString(t,e)+"\n"},this):r=t,e.logger.debug("validation failed for field `"+n+"`:\n"+r)},this)},handleHttpError:function(t,n,r){e.error.statusCodes[t.status]?e.error.statusCodes[t.status].call(e.error,t,n,r):e.error.handleStatusCodesFallback(t)},handleUnhandledError:function(t,n,r){e.logger.fatal(t+" at "+n+" on line "+r)},handleStatusCodesFallback:function(t){e.logger.error(t.toString())},handleRenderError:function(t,n,r){var i="render_error_"+t.module+"_"+t.name,s="error",o,u;switch(n){case"_renderHtml":o=e.lang.get("ERR_RENDER_FAILED_TITLE"),u=[e.lang.get("ERR_RENDER_FAILED_MSG"),e.lang.get("ERR_CONTACT_TECH_SUPPORT")];break;case"_renderField":o=e.lang.get("ERR_RENDER_FIELD_FAILED_TITLE"),u=[e.utils.formatString(e.lang.get("ERR_RENDER_FIELD_FAILED_MSG"),[r.name]),e.lang.get("ERR_CONTACT_TECH_SUPPORT")];break;case"view_render_denied":o=e.lang.get("ERR_NO_VIEW_ACCESS_TITLE"),s="warning",u=[e.utils.formatString(e.lang.get("ERR_NO_VIEW_ACCESS_MSG"),[t.module])];break;case"layout_render":o=e.lang.get("ERR_LAYOUT_RENDER_TITLE"),u=[e.lang.get("ERR_LAYOUT_RENDER_MSG")];break;default:o=e.lang.get("ERR_GENERIC_TITLE"),u=[e.lang.get("ERR_INTERNAL_ERR_MSG"),e.lang.get("ERR_CONTACT_TECH_SUPPORT")],e.logger.error("handleRenderError called for render error caught in "+n+", but we have no corresponding handler!")}e.alert.show(i,{level:s,title:o,messages:u})},enableOnError:function(e,t){var n,r=this;return this.overloaded?!1:(n=window.onerror,window.onerror=function(i,s,o){e?e.call(t):r.handleUnhandledError(i,s,o),n&&n()},this.overloaded=!0,!0)}};e.augment("error",t,!1)}(SUGAR.App),function(app){var _header="(function() {\n  var template = Handlebars.template, templates = Handlebars.templates = Handlebars.templates || {};\n",_footer="})();",_templates={},_sources={},_templateManager;_templateManager={init:function(){_templates=app.config.cacheMeta?app.cache.get("templates")||{}:{};var src="";_.each(_templates,function(e){src+=e});try{eval(_header+src+_footer)}catch(e){app.logger.error("Failed to eval templates retrieved from local storage:\n"+e)}},_add:function(e,t,n){var r=e[0],i=this.get(r,!1);if(i&&!n)return;i&&n&&_sources[r]!=t&&(_templates[r]=Handlebars.templates[r]=null),_sources[r]=t},_compile:function(e,t,n){return Handlebars.templates=Handlebars.templates||{},_templates[e[0]]=Handlebars.templates[e[0]]=n||!e[1]?this.compile(e[0],t):e[1],_templates[e[0]]},compile:function(key,src){try{_templates[key]="templates['"+key+"'] = template("+Handlebars.precompile(src)+");\n",eval(_header+_templates[key]+_footer)}catch(e){app.logger.error("Failed to compile or eval template "+key+".\n"+e)}return this.get(key,!1)||this.empty},get:function(e,t){return t=_.isUndefined(t)||t,t&&!Handlebars.templates[e]&&_sources[e]&&this._compile([e],_sources[e]),Handlebars.templates?Handlebars.templates[e]:null},_getView:function(e,t,n){var r=e+(t?"."+t:"");return[r,this.get(r,n)]},getView:function(e,t){return this._getView(e,t,!0)[1]},_getField:function(e,t,n,r,i,s){var o,u="f."+e+".",a=u+(n?n+".":"")+t;return n+=".",o=this.get(u+n+t,s)||this.get(u+t,s),!o&&!i&&(o=this.get(u+n+r,s)||this.get(u+r,s),o||(o=this.get("f.base."+t,s)||this.get("f.base."+r,s))),[a,o]},getField:function(e,t,n,r){return this._getField(e,t,n,r,!1,!0)[1]},_getLayout:function(e,t,n){var r="l."+(t?t+".":"")+e;return[r,this.get(r,n)]},getLayout:function(e,t){return this._getLayout(e,t,!0)[1]},setView:function(e,t,n,r){return this._add(this._getView(e,t,!1),n,r)},setField:function(e,t,n,r,i){return this._add(this._getField(e,t,n,null,!0,!1),r,i)},setLayout:function(e,t,n,r){return this._add(this._getLayout(e,t,!1),n,r)},set:function(e,t){e.views&&_.each(e.views,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){r=n==r?r:n+"."+r,this.setView(r,null,e,t)},this)},this),e.fields&&_.each(e.fields,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){this.setField(n,r,null,e,t)},this)},this),e.layouts&&_.each(e.layouts,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){r=n==r?r:n+"."+r,this.setLayout(r,null,e,t)},this)},this)},empty:function(){return""}},app.augment("template",_templateManager)}(SUGAR.App),function(e){e.Context=Backbone.Model.extend({initialize:function(e){Backbone.Model.prototype.initialize.call(this,e),this.id=this.cid,this.parent=null,this.children=[],this._fetchCalled=!1},clear:function(e){e=_.extend({clearAllListeners:!0},e||{}),_.each(this.children,function(t){t.clear(e)}),this.children=[],this.parent=null,_.each(this.attributes,function(t){t&&t.off===Backbone.Events.off&&(e.clearAllListeners?(t.off(),_.isFunction(t.dispose)&&t.dispose()):t.off(null,null,this))},this),delete e.clearAllListeners,this.off(),Backbone.Model.prototype.clear.call(this,e),this.resetLoadFlag()},resetLoadFlag:function(e){e=_.isUndefined(e)?!0:e,this._fetchCalled=!1,this.get("model")&&(this.get("model").dataFetched=!1),this.get("collection")&&(this.get("collection").dataFetched=!1),e&&_.each(this.children,function(e){e.resetLoadFlag()})},isCreate:function(){return this.get("create")===!0},getChildContext:function(t){var n,r=t.forceNew||!1;delete t.forceNew;var i=t.cid||t.name||t.link||t.module;i&&!r&&(n=_.find(this.children,function(e){return e.cid==i||e.get("link")==i||e.get("module")==i})),n||(n=e.context.getContext(t),this.children.push(n),n.parent=this);if(t.link){var s=this.get("model");n.set({parentModel:s,parentModule:s?s.module:null})}else t.module||n.set({module:this.get("module")});return this.trigger("context:child:add",n),n},prepare:function(e){if(!e&&(this.get("model")||this.get("collection")))return;var t=this.get("modelId"),n=this.get("create"),r=this.get("link");return this.set(r?this._prepareRelated(r,t,n):this._prepare(t,n)),this},_prepare:function(t,n){var r,i,s=this.get("module"),o=this.get("mixed"),u;return t?(r=e.data.createBean(s,{id:t}),u=[r]):n===!0?(r=e.data.createBean(s),u=[r]):r=e.data.createBean(s),i=o===!0?e.data.createMixedBeanCollection(u):e.data.createBeanCollection(s,u),{collection:i,model:r}},_prepareRelated:function(t,n,r){var i,s,o=this.get("parentModel");return o=o||e.data.createBean(this.get("parentModule"),{id:this.get("parentModelId")}),n?(i=e.data.createRelatedBean(o,n,t),s=e.data.createRelatedCollection(o,t,[i])):r===!0?(i=e.data.createRelatedBean(o,null,t),s=e.data.createRelatedCollection(o,t,[i])):(i=e.data.createRelatedBean(o,null,t),s=e.data.createRelatedCollection(o,t)),this.has("parentModule")||this.set({parentModule:o.module},{silent:!0}),this.has("module")||this.set({module:i.module},{silent:!0}),{parentModel:o,collection:s,model:i}},loadData:function(t){if(this.isDataFetched()||this.get("create")===!0)return;var n,r=this.get("modelId"),i=this.get("module"),s=e.config.orderByDefaults&&i?e.config.orderByDefaults[i]:null;t=t||{},n=r?this.get("model"):this.get("collection"),s&&n instanceof e.BeanCollection&&!n.orderBy&&(n.orderBy=s),n&&(n instanceof e.Bean||n instanceof e.BeanCollection)?(this.get("link")&&(t.relate=!0),this.get("dataView")&&_.isString(this.get("dataView"))&&(t.view=this.get("dataView")),this.get("fields")&&(t.fields=this.get("fields")),this.get("limit")&&(t.limit=this.get("limit")),this.get("module_list")&&(t.module_list=this.get("module_list")),this.get("viewed")&&(t.viewed=!0),t.context=this,n instanceof e.BeanCollection&&n.resetPagination(),this.get("skipFetch")!==!0&&n.fetch(t),this._fetchCalled=!0):e.logger.warn("Skipping fetch because model is not Bean, Bean Collection, or it is not defined, module: "+this.get("module"))},reloadData:function(e){this.resetLoadFlag(e.recursive),this.loadData(e)},isDataFetched:function(){var e=this.get("modelId")?this.get("model"):this.get("collection");return this._fetchCalled||e&&!!e.dataFetched}}),e.augment("context",{getContext:function(t){return new e.Context(t)}})}(SUGAR.App),function(e){var t=Backbone.View.extend({initialize:function(){this.context=e.context.getContext(),e.events.on("app:sync:complete",function(){e.api.setStateProperty("loadingAfterSync",!0),_.each(e.additionalComponents,function(e){e&&_.isFunction(e._setLabels)&&e._setLabels(),e.render()}),e.router.start(),e.api.clearStateProperty("loadingAfterSync")}),e.events.on("app:login:success",function(){e.sync()})},loadView:function(t){var n=this.layout;if(!e.triggerBefore("app:view:change"))return;this.context.clear({silent:!0}),this.context.set(t),this.context.prepare(),this.layout=e.view.createLayout({name:t.layout,module:t.module,context:this.context});if(n){var r=document.createDocumentFragment();r.appendChild(n.el)}e.$contentEl.append(this.layout.$el),(!t||t&&!t.skipFetch)&&this.layout.loadData(),this.layout.render(),n&&n.dispose(),e.trigger("app:view:change",t.layout,t)},loadAdditionalComponents:function(t){_.each(e.additionalComponents,function(e){e&&(e.remove(),e.dispose())}),e.additionalComponents={},_.each(t,function(t,n){t.target?(t.layout?e.additionalComponents[n]=e.view.createLayout({context:this.context,name:t.layout,el:this.$(t.target)}):e.additionalComponents[n]=e.view.createView({name:t.view||n,context:this.context,el:this.$(t.target)}),e.additionalComponents[n].render()):e.logger.error("Unable to create Additional Component '"+n+"'; No target specified.")})}});e.augment("Controller",t,!1),e.events.on("app:init",function(e){e.controller.setElement(e.$rootEl)},e.controller).on("app:start",function(e){e.controller.loadAdditionalComponents(e.config.additionalComponents)})}(SUGAR.App),function(e){var t;e.augment("routing",{beforeRoute:function(t,n){return this.triggerBefore("route",{route:t,args:n})?_.indexOf(e.config.unsecureRoutes,t)>=0?!0:e.api.isAuthenticated()?e.isSynced?!0:(Backbone.history.stop(),e.sync(),!1):(e.router.login(),!1):!1},after:function(e,t){},setRoutes:function(e){t=e},start:function(){var n={};t&&(n.customRoutes=t),e.augment("router",new e.Router(n),!1),e.events.trigger("router:start",e.router),e.router.start()}}),_.extend(e.routing,e.beforeEvent),e.Router=Backbone.Router.extend({initialize:function(e){e=e||{},e.customRoutes&&(this.customRoutes=e.customRoutes,this._bindCustomRoutes())},_bindCustomRoutes:function(){if(!this.customRoutes)return;this.customRoutes.reverse(),_.each(this.customRoutes,function(e){this.route(e.route,e.name,e.callback)},this)},_routeHandler:function(t){var n=Array.prototype.slice.call(arguments,1),r=t.route;e.routing.beforeRoute(r,n)&&(t.apply(this,n),e.routing.after(r,n))},_moduleExists:function(t){return t&&_.isUndefined(e.metadata.getModule(t))?(e.error.handleHttpError({status:404}),!1):!0},route:function(e,t,n){n||(n=this[t]),n.route=t,n=_.wrap(n,this._routeHandler),Backbone.Router.prototype.route.call(this,e,t,n)},goBack:function(){e.logger.debug("Navigating back..."),window.history.back()},go:function(e){window.history.go(e)},start:function(){return e.logger.info("Router Started"),Backbone.history.stop(),Backbone.history.start()},refresh:function(){Backbone.history.loadUrl(Backbone.history.fragment)},buildRoute:function(t,n,r){var i;if(e.utils&&_.isFunction(e.utils.customBuildRoute)){i=e.utils.customBuildRoute.apply(this,arguments);if(!_.isEmpty(i))return i}return t?(i=_.isString(t)?t:t.get("module"),n&&(i+="/"+n),r&&(i+="/"+r)):i=r,i},index:function(){e.logger.debug("Route changed to index"),e.config.defaultModule?this.navigate(e.config.defaultModule,{trigger:!0}):e.acl.hasAccess("read","Home")&&this.navigate("Home",{trigger:!0})},list:function(t){if(!this._moduleExists(t))return;e.logger.debug("Route changed to list of "+t),e.controller.loadView({module:t,layout:"records"})},layout:function(t,n){if(!this._moduleExists(t))return;e.logger.debug("Route changed to layout: "+n+" for "+t),e.controller.loadView({module:t,layout:n})},create:function(t){if(!this._moduleExists(t))return;e.logger.debug("Route changed: create "+t),e.controller.loadView({module:t,create:!0,layout:"edit"})},login:function(){e.logger.debug("Logging in"),e.controller.loadView({module:"Login",layout:"login",create:!0}),e.events.trigger("router:reauth:load"),e.config.externalLogin&&e.api.ping(null,{success:function(){e.events.trigger("router:reauth:success"),e.router.refresh()},error:function(){e.alert.show("needs_login_error",{level:"error",messages:e.lang.getAppString("LBL_PORTAL_INVALID_CREDS_TITLE"),title:e.lang.get("LBL_PORTAL_INVALID_CREDS_TITLE")})}})},logout:function(t){t=t==="1",e.logger.debug("Logging out: "+t),e.logout({complete:function(){e.router.navigate("#"),e.config.externalLogin?e.controller.loadView({module:"Login",layout:"logout",skipFetch:!0,create:!0}):e.router.login()},success:function(t,n){e.events.trigger("app:logout:success",t)}},t)},record:function(t,n,r,i){if(!this._moduleExists(t))return;var s=e.controller.context.get("collection"),o=e.controller.context.get("listCollection"),u={module:t,layout:i||"record",action:r||"detail"};n!=="create"?_.extend(u,{modelId:n}):(_.extend(u,{create:!0}),u.layout="create"),s&&s.module===t&&s.get(n)&&(u.listCollection=s),o&&o.module===t&&o.get(n)&&(u.listCollection=o),e.controller.loadView(u)},redirect:function(e,t){this.navigate(e,_.extend({trigger:!0,replace:!0},t))}})}(SUGAR.App),function(e){e.augment("lang",{direction:"ltr",get:function(e,t,n){var r=this.getModString(e,t,n)||this.getAppString(e,n)||e;return r},getModString:function(e,t,n){var r;return _.isArray(t)?_.find(t,function(t){return r=this._get("mod_strings",e,t,n),!_.isEmpty(r)},this):r=this._get("mod_strings",e,t,n),r},getAppString:function(e,t){return this._get("app_strings",e,null,t)},getAppListStrings:function(t){var n=e.metadata.getStrings("app_list_strings")[t]||{};if(_.isArray(n)){var r={};_.each(n,function(e){_.isString(e)?r[e]=e:_.isArray(e)&&e.length==2&&(r[e[0]]=e[1])}),n=r}return n},getModuleName:function(e,t){t=t||{};var n=!t.plural&&this.getModString("LBL_MODULE_NAME_SINGULAR",e)||this.getModString("LBL_MODULE_NAME",e);return!n&&!_.isUndefined(t.defaultValue)&&(n=this.get(t.defaultValue)),n||e},getAppListKeys:function(t){var n=[],r=e.metadata.getStrings("app_list_strings")[t]||{};return _.isArray(r)?_.each(r,function(e){e.length==2&&n.push(e[0])}):_.isObject(r)&&(n=_.keys(r)),n},_get:function(t,n,r,i){var s,o=e.metadata.getStrings(t);o=r?o[r]:o,s=o?this._sanitize(o[n]):null;if(!s||!_.isString(s))return;return!_.isUndefined(i)&&s.indexOf("{{")>-1&&(n="lang."+(r?n+"."+r:n),s=Handlebars.templates[n]?Handlebars.templates[n](i):e.template.compile(n,s)(i)),s},_sanitize:function(e){return _.isString(e)&&e.lastIndexOf(":")==e.length-1?e.substring(0,e.length-1):e},getLanguage:function(){return this._currentLanguage},setLanguage:function(t,n,r){var i=this;r=r||{},_.each(Handlebars.templates,function(e,t){t.indexOf("lang.")==0&&delete Handlebars.templates[t]});if(r.noSync===!0){this.updateLanguage(t);return}e.sync({callback:function(s){var o=!1;s||(i.updateLanguage(t),o=!e.api.isAuthenticated()&&!r.noUserUpdate,e.cache.set("langHasChanged",o)),n&&n(s)},getPublic:!e.api.isAuthenticated(),noUserUpdate:r.noUserUpdate||!1,language:t,forceRefresh:!0,metadataTypes:["labels"]})},updateLanguage:function(t){e.cache.set("lang",t),e.user.setPreference("language",t),e.trigger("app:locale:change"),this.setCurrentLanguage(t)},setDefaultLanguage:function(e){this._defaultLanguage=e},getDefaultLanguage:function(){return this._defaultLanguage},setCurrentLanguage:function(e){this._currentLanguage=e,this.setDirection(e)},setDirection:function(t){var n=["he_IL","ar_SA"],r=_.contains(n,t),i=this.direction;this.direction=r?"rtl":"ltr",this.direction!==i&&e.trigger("lang:direction:change")}})}(SUGAR.App),function(app){function _setHash(e,t){var n=t?"public:":"";app.cache.set(_keyPrefix+n+"hash",e._hash)}function _cacheMeta(e){app.cache.set(_keyPrefix+"data",e)}function _getCachedMeta(){return app.cache.get(_keyPrefix+"data")}function _injectLabels(e,t){_.each(t,function(n,r){r!=="_hash"&&(e[r]=t[r])}),delete e.labels}function _fetchLabels(e,t){var n,r,i,s=app.user.getLanguage();n=e.ordered_labels||e.labels,app.lang.setDefaultLanguage(n["default"]),t.language&&n[t.language]?r=t.language:n[s]?r=s:(r=app.lang.getDefaultLanguage(),app.user.id&&app.user.updateLanguage(r)),app.lang.setCurrentLanguage(r),i=app.utils.buildUrl(n[r]),app.api.call("read",i,null,{success:function(e){try{e=_.isString(e)?JSON.parse(e):e}catch(n){app.logger.fatal("Failed to parse labels data: "+n),t.error({code:"sync_failed",label:"ERR_SYNC_FAILED"});return}t.success(e)},error:function(e){e.code="sync_failed",e.label="ERR_SYNC_FAILED",t.error(e)}})}function _initCustomComponents(e,t){var n=this,r=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each({layout:"layout",view:"view",fieldTemplate:"field",data:"data"},function(i,s){n._metaTypeIsSeparatedByPlatform(e,s,r)&&_.each(r,function(r){var o=e[s+"s"][r];n._sortAndDeclareComponents(o,i,t,r)}),_.each(e[s+"s"],function(e,n){i==="view"&&e.templates&&_.each(e.templates,function(e,r){var i=n===r;r=i?r:n+"."+r,app.template.setView(r,t,e,!0)}),i==="layout"&&e.templates&&_.each(e.templates,function(e,r){r=n===r?r:n+"."+r,app.template.setLayout(r,t,e,!0)}),i==="field"&&e.templates&&_.each(e.templates,function(e,r){app.template.setField(n,r,t,e,!0)})})},this)}var _keyPrefix="meta:",_metadata={},_mdLoaded={},_syncing=!1;app.augment("metadata",{fieldTypeMap:{varchar:"text",datetime:"datetimecombo",multienum:"enum",text:"textarea",decimal:"float"},_patchMetadata:function(e,t){return!t||t._patched===!0?t:(_.each(t.views,function(n){n.meta&&_.each(n.meta.panels,function(n){n.fields=this._patchFields(e,t,n.fields)},this)},this),t._patched=!0,t)},_patchFields:function(e,t,n){var r=this;return _.each(n,function(i,s){var o=_.isString(i)?i:i.name,u=t.fields[o];if(i.fields){i.fields=r._patchFields(e,t,i.fields);return}_.isEmpty(u)?i===""&&(i={view:"detail"},n[s]=i):(_.isString(i)&&(i={name:i}),_.isObject(i.displayParams)&&(_.extend(i,i.displayParams),delete i.displayParams),i.type=i.type||u.custom_type||u.type||"base",i.type=r.fieldTypeMap[i.type]||i.type,i.label=i.label||u.vname||i.name,n[s]=i)},this),n},_sortControllers:function(type,components,module){var updated={},nameMap={},entries={},updateWeights=function(e){var t=e.controller;_.isObject(t)&&_.isString(t.extendsFrom)&&entries[t.extendsFrom]&&!updated[t.extendsFrom]&&(entries[t.extendsFrom].weight--,updated[t.extendsFrom]=!0,updateWeights(entries[t.extendsFrom]))};return _.each(components,function(entry,name){if(entry.controller){var controller=entry.controller,className=(module||"")+app.utils.capitalizeHyphenated(name)+app.utils.capitalize(type);nameMap[className]=name;if(_.isString(controller))try{controller=eval("["+controller+"][0]")}catch(e){app.logger.error("Failed to eval view controller for "+className+": "+e+":\n"+entry.controller)}entries[className]={type:name,controller:controller,weight:0}}}),_.each(entries,function(e,t){var n=e.controller,r;_.isObject(n)&&_.isString(n.extendsFrom)&&(r="Custom"+n.extendsFrom,r in entries&&t!=r&&(n.extendsFrom=r))}),_.each(entries,function(e){updated={},updateWeights(e)}),_.sortBy(entries,"weight")},_sortAndDeclareComponents:function(e,t,n,r){var i,s=this;if(!_.isUndefined(e)&&e){i=s._sortControllers(t,e,n);if(t==="data"){var o,u;_.each(i,function(e){e.type==="model"?o=e.controller:e.type==="collection"&&(u=e.controller)}),app.data.declareModelClass(n,null,r,o),app.data.declareCollectionClass(n,r,u)}else _.each(i,function(e){app.view.declareComponent(t,e.type,n,e.controller,!0,r)})}},_metaTypeIsSeparatedByPlatform:function(e,t,n){if(!_.isUndefined(e[t+"s"]))for(var r=0;r<n.length;r++)if(!_.isUndefined(e[t+"s"][n[r]])&&_.isUndefined(e[t+"s"][n[r]].controller))return!0;return!1},_declareClasses:function(e){var t=this,n=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each(["field","view","layout","data"],function(r){var i;t._metaTypeIsSeparatedByPlatform(e,r,n)&&_.each(n,function(n){i=e[r+"s"][n],t._sortAndDeclareComponents(i,r,null,n)},this)},this),_.each(e.modules,function(e,t){_initCustomComponents.call(this,e,t)},this)},getModules:function(){return _metadata.modules},getHiddenSubpanels:function(){return _metadata.hidden_subpanels},getModule:function(e,t){var n=this.getModules();return n&&(n=n[e]),n&&t&&(n=n[t]),n},getRelationship:function(e){return _metadata.relationships?_metadata.relationships[e]:null},getField:function(e){var t=_metadata.fields?_metadata.fields[e]||_metadata.base:null;return t?app.metadata.copy(t,{field:e}):t},getView:function(e,t){var n=e?this.getModule(e,"views"):_metadata.views;return t&&(n&&n[t]&&!_.isUndefined(n[t].meta)?n=n[t].meta:_metadata.views&&_metadata.views[t]&&!_.isUndefined(_metadata.views[t].meta)?n=_metadata.views[t].meta:n=null),n?app.metadata.copy(n,{module:e,view:t}):n},getLayout:function(e,t){var n=this.getModule(e,"layouts");return t&&(n&&n[t]?n=n[t].meta:_metadata.layouts&&_metadata.layouts[t]?n=_metadata.layouts[t].meta:n=null),n?app.metadata.copy(n,{module:e,layout:t}):n},getModuleNames:function(e){var t=["enabled","!enabled","visible","!visible","display_tab","!display_tab","show_subpanels","!show_subpanels","quick_create","!quick_create"];arguments=Array.prototype.slice.call(arguments);if(arguments.length>=1&&!_.isObject(arguments[0])){app.logger.warn("getModuleNames no longer accepts visible and access params.");var n=_.clone(arguments);e={},n[0]&&(e.filter="display_tab"),e.access=n[1]}e=e||{};var r=[],i=_.isUndefined(_metadata.modules_info);if(i)return r=_.clone(app.user.get("module_list")),e.access&&(r=_.filter(r,function(t){return app.acl.hasAccess(e.access,t)})),r||[];var s,o=!1;return e.filter&&(_.isArray(e.filter)||(e.filter=[e.filter]),s=[],_.each(e.filter,function(e){e&&_.indexOf(t,e)>-1?(s.push(e),o=e==="display_tab"):e&&app.logger.warn("Can't filter getModuleNames by "+e)}),_.isEmpty(s)&&(s=undefined)),r=_.chain(_metadata.modules_info).keys().without("_hash").value(),s&&_.each(s,function(t){var n=t.charAt(0)==="!";if(n){var i=app.metadata.getModuleNames({filter:t.substring(1),access:e.access});r=_.difference(r,i)}else r=_.filter(r,function(e){return _metadata.modules_info[e][t]})}),_.isEmpty(app.user.get("module_list"))||(o?r=_.intersection(app.user.get("module_list"),r):s||(r=_.union(app.user.get("module_list"),r))),e.access&&(r=_.filter(r,function(t){return app.acl.hasAccess(e.access,t)})),r},getStrings:function(e){return _metadata[e]||{}},getFullModuleList:function(){return _metadata.full_module_list||{}},getConfig:function(){return _metadata.config||{}},getBaseCurrencyId:function(){return"-99"},getCurrency:function(e){return this.getCurrencies()[e]},getCurrencies:function(){return _metadata.currencies||{}},getLogoUrl:function(){return _metadata.logo_url},getServerInfo:function(){return _metadata.server_info||{}},getModuleTabMap:function(){return _metadata.module_tab_map||{}},getTabMappedModule:function(e){var t=this.getModuleTabMap();return t[e]||e},getFilterOperators:function(e){var t=_metadata.filters&&_metadata.filters.operators&&_metadata.filters.operators.meta,n=e&&this.getModule(e,"filters"),r=n&&n.operators&&n.operators.meta;return r||t||{}},get:function(){return _metadata},getEditableDropdownFilter:function(e){var t=_metadata.editable_dropdown_filters;return t&&t[e]?app.metadata.copy(t[e]):{}},copy:function(e,t){return app.utils.deepCopy(e)},set:function(e,t,n){_.each(e.modules,function(e,t){this._patchMetadata(t,e)},this),this._declareClasses(e),app.config=_.extend(app.config||{},e.config),app.template.set(e,e._hash&&e._hash!=this.getHash(t)),_.isEmpty(e._hash)||_setHash(e,t);if(!n){var r=e._override_values||[];delete e._override_values,_.each(e,function(e,t){_metadata[t]=_.isObject(e)&&!_.contains(r,t)?_.extend(_metadata[t]||{},e):e})}else _metadata=e;app.config.cacheMeta&&!t&&_cacheMeta(_metadata),app.config.env!="prod"&&(this._dev_data=_metadata)},getHash:function(e){var t=e?_keyPrefix+"public:hash":_keyPrefix+"hash";return app.cache.get(t)||_metadata._hash||""},sync:function(e,t){_syncing=!0,t=t||{},t.params=t.params||{};var n=this,r=t.metadataTypes||(t.getPublic?app.config.publicMetadataTypes:app.config.metadataTypes)||[],i=function(t){app.logger.debug("Failed fetching metadata"),app.error.handleHttpError(t),e.call(n,t)},s=e;e=function(e){_syncing=!1,_.isFunction(s)&&s(e)},app.api.getMetadata(n.getHash(t.getPublic),r,[],{success:function(s){var o;t=t||{};if(!_.isEmpty(s)){app.logger.debug("Updating metadata");if(_mdLoaded[t.getPublic?"public:md":"md"]&&n.getHash(t.getPublic)==s._hash&&!t.forceRefresh)return app.logger.debug("Skipping update as metadata hash matches"),e.call(n);if(_.isEmpty(r)||_.include(r,"server_info")&&!t.getPublic){o=app.isServerCompatible(s.server_info);if(o!==!0)return e(o)}_mdLoaded[t.getPublic?"public:md":"md"]=!0,s.jssource?n._loadJSSource(s,t,e,i,n):s.labels||s.ordered_labels?_fetchLabels(s,{language:t.language,success:function(r){_injectLabels(s,r),n.set(s,t.getPublic),e.call(n)},error:i}):e.call(n)}else e.call(n,{code:"sync_failed",label:"ERR_SYNC_FAILED"})},error:i},t)},isSyncing:function(){return _syncing},_loadJSSource:function(e,t,n,r,i){var s,o=this._checkJSSourceUpdated(e,!!t.getPublic);if(o==="reload")return app.utils.hardRefresh();o&&(SUGAR.jssource=!1,s=document.createElement("script"),s.src=app.utils.buildUrl(e.jssource),document.head.appendChild(s)),async.parallel([function(e){o?app.utils.doWhen("SUGAR.jssource",function(){i._declareClasses(SUGAR.jssource),e()}):e()},function(n){_fetchLabels(e,{language:t.language,success:function(r){_injectLabels(e,r),i.set(e,t.getPublic),n()},error:function(){r.apply(i,arguments),n()}})}],function(e,t){n&&n.call(i)})},_checkJSSourceUpdated:function(e,t){return t?this._publicJSSourceFile?this._publicJSSourceFile!=e.jssource?"reload":!1:(this._publicJSSourceFile=e.jssource,!0):e.jssource_public&&this._publicJSSourceFile&&e.jssource_public!=this._publicJSSourceFile?(app.utils.hardRefresh(),"reload"):this._jsSourceFile?this._jsSourceFile!=e.jssource?"reload":!1:!0},init:function(){var e=this,t=function(){!_syncing&&(e.getHash()!=_metadata._hash&&_mdLoaded.md||app.api.getUserprefHash()&&app.user.get("_hash")&&app.api.getUserprefHash()!=app.user.get("_hash"))&&(_syncing=!0,window.clearInterval(e._validateMDInterval),this._validateMDInterval=null,window.setTimeout(function(){_mdLoaded.md=!1,app.sync({getPublic:!app.api.isAuthenticated(),callback:function(){e._validateMDInterval=window.setInterval(t,100)}})},500))};if(app.config.cacheMeta){var n=_getCachedMeta();n&&this.set(n,!1)}this._validateMDInterval=window.setInterval(t,100),app.events.on("cache:clean",function(e){e([_keyPrefix+"public:hash",_keyPrefix+"hash",_keyPrefix+"data"])})},clearCache:function(){app.cache.cut(_keyPrefix+"public:hash"),app.cache.cut(_keyPrefix+"hash"),app.cache.cut(_keyPrefix+"data")},reset:function(){_metadata={},this.clearCache()}},!1)}(SUGAR.App),function(e){e.augment("acl",{_accessToAny:{},action2permission:{view:"read",readonly:"read",edit:"write",detail:"read",list:"read",disabled:"write"},init:function(e){e&&e.events.on("app:sync:complete",this.clearCache,this)},clearCache:function(){this._accessToAny={}},_hasAccess:function(e,t){var n;return t.access==="no"?n="no":n=t[e],n!=="no"},_hasAccessToField:function(e,t,n){var r;return e=this.action2permission[e]||e,t.fields[n]&&t.fields[n][e]&&(r=t.fields[n][e]),r!=="no"},hasAccess:function(t,n,r,i,s){var o=e.user.getAcls()[n],u=!0;if(o||s){o=o||{};if(s){o=e.utils.deepCopy(o),o.fields=o.fields||{},_.extend(o.fields,s.fields);var a=o.fields;_.extend(o,s),o.fields=a}u=this._hasAccess(t,o);if(i&&o.fields&&u){u=this._hasAccessToField(t,o,i);var f=e.metadata.getModule(n),l=f&&f.fields?f.fields[i]:null;u&&l&&l.group&&(u=this._hasAccessToField(t,o,l.group))}}return u},hasAccessToModel:function(e,t,n){var r,i,s,o,u=!0;return t&&(r=t.id,i=t.module,s=t.original_assigned_user_id||t.get("assigned_user_id"),o=t.get("_acl")||{fields:{}}),e=="edit"&&!r&&(e="create"),u===!0&&(u=this.hasAccess(e,i,s,n,o)),u},hasAccessToAny:function(t){return _.isUndefined(this._accessToAny[t])&&(this._accessToAny[t]=_.some(e.user.getAcls(),function(e,n){return this.hasAccess(t,n)},this)),this._accessToAny[t]}},!0)}(SUGAR.App),function(e){var t=Backbone.Model.extend({load:function(t){e.api.me("read",null,null,{success:function(n){if(n&&n.current_user){n.current_user._hash&&e.cache.set("userpref:hash",n.current_user._hash),e.user.set(n.current_user);var r=e.user.getPreference("language");e.lang.getLanguage()!=r&&e.lang.setLanguage(r,null,{noUserUpdate:!0,noSync:e.isSynced||e.metadata.isSyncing()})}t&&t()},error:function(n){e.error.handleHttpError(n),t&&t(n)}})},loadLocale:function(t){e.api.call("read",e.api.buildURL("locale"),null,{success:function(n){n&&n._hash&&(e.cache.set("userpref:hash",n._hash),e.user.set({_hash:n._hash})),t&&t(n)},error:function(n){e.error.handleHttpError(n),t&&t(n)}})},getLanguage:function(){return e.user.getPreference("language")||e.cache.get("lang")},updateLanguage:function(t,n){var r=function(r){r||e.lang.updateLanguage(t),n&&n(r)};this.update("update",{preferred_language:t},r)},updateProfile:function(e,t){var n=function(e){t&&t(e)};this.update("update",e,n)},updatePreferences:function(t,n){var r=this;e.api.isAuthenticated()?e.api.call("update",e.api.buildURL("me/preferences"),t,{success:function(i){i._hash&&(e.cache.set("userpref:hash",i._hash),e.user.set({_hash:i._hash})),_.each(t,function(e,t){i[t]&&r.setPreference(t,i[t])}),n&&n()},error:function(t){e.error.handleHttpError(t),n&&n(t)}}):n&&n()},update:function(t,n,r){e.api.isAuthenticated()?e.api.me(t,n,null,{success:function(t){t.current_user&&(t.current_user._hash&&e.cache.set("userpref:hash",t.current_user._hash),e.user.set(t.current_user)),r&&r()},error:function(t){e.error.handleHttpError(t),r&&r(t)}}):r()},getAcls:function(){return e.user.get("acl")||{}},getPreference:function(t){var n=e.user.get("preferences")||{};return n[t]},setPreference:function(t,n){var r=e.user.get("preferences")||{};return r[t]=n,e.user.set("preferences",r)},getCurrency:function(){var t=e.user.get("preferences"),n={};return t&&(n.currency_id=t.currency_id,n.currency_iso=t.currency_iso,n.currency_name=t.currency_name,n.currency_rate=t.currency_rate,n.currency_show_preferred=t.currency_show_preferred,n.currency_symbol=t.currency_symbol),n},lastState:function(){var t=":",n="last-state",r={},i=[],s=function(r){var i=r.split(t),s=[e.user.id,n];return s=s.concat(i),s.join(t)},o=function(e){var t;return e.meta&&e.meta.last_state&&(t=e.meta.last_state.id),t};return{get:function(t){var n,r;return _.isUndefined(t)||(r=s(t),n=e.cache.get(r)||this.defaults(t)),n},set:function(t,n){if(!_.isUndefined(t)&&!_.isUndefined(n)){var r=s(t);e.cache.set(r,n)}},preserve:function(e){_.isUndefined(e)||i.push(e)},key:function(e,t){var n=o(t);return this.buildKey(e,n,t.module)},buildKey:function(e,n,r){var i,s=[];return n&&(r&&s.push(r),s.push(n,e),i=s.join(t)),i},defaults:function(e){return r[e]},register:function(e){var t=o(e);t&&_.each(e.meta.last_state.defaults,function(t,n){r[this.key(n,e)]=t},this)},remove:function(t){var n;_.isUndefined(t)||(n=s(t),e.cache.cut(n))},_getPreservedKeys:function(){var e=[];return _.each(i,function(t){e.push(s(t))}),e}}}()});e.events.on("app:logout",function(t){t===!0&&e.user.clear({silent:!0})}),e.events.on("cache:clean",function(t){t(e.user.lastState._getPreservedKeys())}),e.augment("user",new t,!1)}(SUGAR.App),function(e){e.augment("logger",{levels:{TRACE:{value:1,name:"TRACE"},DEBUG:{value:2,name:"DEBUG"},INFO:{value:3,name:"INFO"},WARN:{value:4,name:"WARN"},ERROR:{value:5,name:"ERROR"},FATAL:{value:6,name:"FATAL"}},ConsoleWriter:{write:function(t,n){window.console||(window.console={}),window.console.log||(window.console.log=function(){}),t.value<=e.logger.levels.INFO.value?console.log(n):t.value==e.logger.levels.WARN.value?console.warn(n):console.error(n)}},ServerWriter:{write:function(t,n){if(t.value<e.logger.levels.WARN.value)return;if(!e.api.isAuthenticated())return;var r=e.config.logger&&e.config.logger.writeToServer||!1;if(!r||!n.trim().length)return;var i=e.api.buildURL(undefined,"logger"),s={level:t.name.toLowerCase(),message:n};e.api.call("create",i,s,{success:function(e){if(!e.status)throw"Failed to write log message {"+n+"} onto server"},error:function(e){throw e}})}},SimpleFormatter:{format:function(e,t,n){var r=n.getUTCFullYear()+"-"+(n.getUTCMonth()+1)+"-"+n.getUTCDate()+" "+n.getUTCHours()+":"+n.getUTCMinutes()+":"+n.getUTCSeconds();return e.name+"["+r+"]: "+t}},trace:function(e){this.log(this.levels.TRACE,e)},debug:function(e){this.log(this.levels.DEBUG,e)},info:function(e){this.log(this.levels.INFO,e)},warn:function(e){this.log(this.levels.WARN,e)},error:function(e){this.log(this.levels.ERROR,e)},fatal:function(e){this.log(this.levels.FATAL,e)},getLevel:function(){var t=e.config.logLevel;return t?this.levels[e.config.logLevel]:(t=e.config.logger&&e.config.logger.level,t=t&&this.levels[t.toUpperCase()]||this.levels.ERROR,t)},log:function(t,n){try{var r=this.getLevel();if(t.value<r.value)return;n=n||"<none>",_.isFunction(n)&&(n=n.call(this));if(_.isObject(n))try{n=JSON.stringify(n)}catch(i){n=n.toString()}var s=e.config.logger,o=this[e.config.logFormatter];o||(o=s&&this[s.formatter]||this.SimpleFormatter),n=o.format(t,n,new Date);var u=this[e.config.logWriter];u||(u=s&&this[s.consoleWriter]||this.ConsoleWriter);var a=s&&this[s.serverWriter]||this.ServerWriter;u.write(t,n),a.write(t,n)}catch(i){console.log("Failed to log message {"+n+"} due to exception: "+i)}}},!1)}(SUGAR.App),function(e){var t=moment;_.extend(t,{InvalidException:function(e,t){this.name="InvalidException",this.message=e,this.date=t},_cachedFormats:{},_serverDateFormat:"YYYY-MM-DD",convertFormat:function(e){if(t._cachedFormats[e])return t._cachedFormats[e];var n={d:"DD",m:"MM",Y:"YYYY",H:"HH",h:"hh",i:"mm"},r=e;return _.each(n,function(e,t){r=r.replace(t,e)}),t._cachedFormats[e]=r,r},compare:function(e,n){var r=moment(e),i=moment(n);if(!r.isValid())throw new t.InvalidException("Invalid date passed for comparison.",e);if(!i.isValid())throw new t.InvalidException("Invalid date passed for comparison.",n);return r.isBefore(i)?-1:r.isAfter(i)?1:0},getUserDateFormat:function(t){return t=t||e.user,this.convertFormat(t.getPreference("datepref"))},getUserTimeFormat:function(t){return t=t||e.user,this.convertFormat(t.getPreference("timepref"))}});var n={};_.extend(t,{parse:function(e,t){var n=new Date("Jan 1, 1970 00:00:00"),r="",i,s,o,u,a,f;if(e instanceof Date)return e;t||(t=this.guessFormat(e));if(t===!1)return/^\d+$/.test(e)?new Date(e):!1;i=$.trim(e),t=$.trim(t)+" ";for(s=0;s<t.length;s++){o=t.charAt(s);if(o===":"||o==="/"||o==="-"||o==="."||o===" "||o==="a"||o==="A"){u=i.indexOf(o),u===-1&&(u=i.length),a=i.substring(0,u),i=i.substring(u+1);switch(r){case"m":if(!(a>0&&a<13))return!1;n.setMonth(a-1);break;case"d":if(!(a>0&&a<32))return!1;n.setDate(a);break;case"Y":if(a>0==0)return!1;n.setYear(a);break;case"h":f=t.substring(t.length-4),a=parseInt(a,10);var l=$.trim(f.toLowerCase());if(l==="i a"||l===o+"ia"){var c=i.substring(i.length-2).toLowerCase();c==="pm"?a<12&&(a+=12):c==="am"&&a===12&&(a=0)}n.setHours(a);break;case"H":n.setHours(a);break;case"i":a=a.substring(0,2),n.setMinutes(a);break;case"s":n.setSeconds(a)}r=""}else r=o}return n},guessFormat:function(e){if(typeof e!="string")return!1;var t="",n,r,i,s,o,u,a,f;e.indexOf(" ")!==-1&&(t=e.substring(e.indexOf(" ")+1,e.length),e=e.substring(0,e.indexOf(" "))),n="/";if(e.indexOf("/")===-1)if(e.indexOf("-")!==-1)n="-";else{if(e.indexOf(".")===-1)return!1;n="."}r=e.split(n),i="";if(r[0].length===4)i="Y"+n+"m"+n+"d";else{if(r[2].length!==4)return!1;i="m"+n+"d"+n+"Y"}return s="",o=[],t!==""&&(o.push("i"),u=":",t.indexOf(".")===2&&(u="."),t.split(u).length===3&&o.push("s"),a="",f=t.substring(t.length-2,t.length),f.toLowerCase()==="am"||f.toLowerCase()==="pm"?(o.unshift("h"),f.toLowerCase()===f?a="lower":a="upper"):o.unshift("H"),s=o.join(u),t.indexOf(" ")!==-1&&(s+=" "),a&&a==="upper"?s+="A":a&&a==="lower"&&(s+="a"),i=i+" "+s),i},parseFormat:function(e){if(!(e in n)){var t={},r,i;for(r=0;r<e.length;r++){i=e.charAt(r);switch(i){case"m":case"n":t.month=i;break;case"d":case"j":t.day=i;break;case"Y":t.year=i;break;case"H":case"h":case"g":t.hours=i;break;case"i":t.minutes=i;break;case"s":t.seconds=i;break;case"A":case"a":t.amPm=i;break;default:}}n[e]=t}return n[e]},format:function(e,t){if(!_.isDate(e))return"";var n="",r,i,s,o,u,a;for(r=0;r<t.length;r++){i=t.charAt(r);switch(i){case"\\":n+=t.charAt(r+1),r++;break;case"m":case"n":u=e.getMonth()+1,n+=u<10&&i==="m"?"0"+u:u;break;case"d":case"j":s=e.getDate(),n+=s<10&&i==="d"?"0"+s:s;break;case"Y":n+=e.getFullYear();break;case"H":case"h":case"g":o=e.getHours();if(i==="h"||i==="g")o=o>12?o-12:o,o=o===0?12:o;n+=o<10&&i!=="g"?"0"+o:o;break;case"i":u=e.getMinutes(),n+=u<10?"0"+u:u;break;case"s":a=e.getSeconds(),n+=a<10?"0"+a:a;break;case"a":case"A":e.getHours()<12?n+=i==="a"?"am":"AM":n+=i==="a"?"pm":"PM";break;default:n+=i}}return n},roundTime:function(e){if(!e.getMinutes)return 0;var t=e.getMinutes();return t<1?t=0:t<16?t=15:t<31?t=30:t<46?t=45:(t=0,e.setHours(e.getHours()+1)),e.setMinutes(t),e},UTCtoLocalTime:function(e){return e instanceof Date?new Date(this.toUTC(e)):e},UTCtoTimezone:function(e,t){return e instanceof Date&&undefined!==t&&null!==t?(t=parseFloat(t)*60*60*1e3,t-=e.getTimezoneOffset()*60*1e3*-1,new Date(this.toUTC(e)+t)):e},toUTC:function(e){if(e instanceof Date){var t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),i=e.getHours(),s=e.getMinutes(),o=e.getSeconds(),u=e.getMilliseconds();return Date.UTC(t,n,r,i,s,o,u)}return e},getRelativeTimeLabel:function(e){var t=new Date,n=t.getTime()<e.getTime(),r=n?e-t:t-e,i=1e3,s=i*60,o=s*60,u=o*24,a={str:"",value:undefined};return isNaN(r)||r<0?a:r<i*2?(a.str="LBL_TIME_AGO_NOW",a):r<s?(a.str=n?"LBL_TIME_UNTIL_SECONDS":"LBL_TIME_AGO_SECONDS",a.value=Math.floor(r/i),a):r<s*2?(a.str=n?"LBL_TIME_UNTIL_MINUTE":"LBL_TIME_AGO_MINUTE",a):r<o?(a.str=n?"LBL_TIME_UNTIL_MINUTES":"LBL_TIME_AGO_MINUTES",a.value=Math.floor(r/s),a):r<o*2?(a.str=n?"LBL_TIME_UNTIL_HOUR":"LBL_TIME_AGO_HOUR",a):r<u?(a.str=n?"LBL_TIME_UNTIL_HOURS":"LBL_TIME_AGO_HOURS",a.value=Math.floor(r/o),a):r>u&&r<u*2?(a.str=n?"LBL_TIME_UNTIL_DAY":"LBL_TIME_AGO_DAY",a):r<u*365?(a.str=n?"LBL_TIME_UNTIL_DAYS":"LBL_TIME_AGO_DAYS",a.value=Math.floor(r/u),a):(a.str=n?"LBL_TIME_UNTIL_YEAR":"LBL_TIME_AGO_YEAR",a)},parseDisplayDefault:function(e,t){var n,r,i,s,o,u,a,f,l=t?t:new Date,c,h,p,d;if(!e)return e;u=function(e,t){var n=e.getDate();return e.setMonth(e.getMonth()+t),e.getDate()<n&&(e.setDate(1),e.setDate(e.getDate()-1)),e},a=function(e){var t,n,r,i;t=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],n=l.getDay(),e=e.toLowerCase();for(var r=7;r--;)if(e===t[r]){e=r<=n?r+7:r;break}return i=e-n,i},n={day:function(e){return new Date(l.setDate(l.getDate()+e))},week:function(e){return new Date(l.setDate(l.getDate()+e*7))},month:function(e){return u(l,e)},year:function(e){return u(l,e*12)},now:function(){return l},"next monday":function(){return new Date(l.setDate(l.getDate()+a("monday")))},"next friday":function(){return new Date(l.setDate(l.getDate()+a("friday")))},"first of next month":function(){l.setDate(1);var e=l.setMonth(l.getMonth()+1);return new Date(e)}},e&&e.indexOf("&")>=0?(i=e.split("&"),s=i[0],o=i[1]):s=e;if(s.match(/\b(now|day|week|month|year)/g)){s.indexOf("now")===0?h="now":s.indexOf("first day of next month")!==-1?h="firstnextmonth":(p=s.split(" "),c=p[0],h=p[1]);if(h.match("now"))r=n.now();else if(h.match("firstnextmonth"))r=n["first of next month"]();else if(h.match("days?"))r=n.day(parseInt(c,10));else if(h.match("weeks?"))r=n.week(parseInt(c,10));else if(h.match("months?"))r=n.month(parseInt(c,10));else if(h.match("years?"))r=n.year(parseInt(c,10));else{if(!n[s])return;r=n[s]()}}else{if(!n[s])return;r=n[s]()}return f=function(e){var t,n,r;t=/^(\d\d?).(\d{2}).?([ap]m)?$/.exec(o),t&&t.length>2&&(n=t[1],n&&(t[3]==="pm"?n<12&&(n=parseInt(n,10)+12):n==="12"&&(n="0"),e.setHours(parseInt(n,10))),r=t[2],r&&e.setMinutes(parseInt(r,10)))}(r),r},toDatepickerFormat:function(e){if(_.isUndefined(e)||!e)return"";var t,n={y:"yy",Y:"yyyy",m:"mm",d:"dd"};return t=e.replace(/[yYmd]/g,function(e){return n[e]}),t},stripIsoTimeDelimterAndTZ:function(e){if(!_.isUndefined(e)&&e)return e.replace("T"," ").substr(0,19)},isIso:function(e){var t,n;t=e.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/);if(t)return!0;if(e.match(/[T\+Z ]/g)){n=e.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])/);if(n)return!0}return!1},compareDates:function(n,r){return e.logger.warn("date.compareDates() was called and is deprecated. Please update code to use date.compare()"),t.compare(n,r)},isDateAfter:function(n,r){return e.logger.warn("date.isDateAfter() was called and is deprecated. Please update code to use date(date1).isAfter(date2)"),t(n).isAfter(r)},isDateBefore:function(n,r){return e.logger.warn("date.isDateBefore() was called and is deprecated. Please update code to use date(date1).isBefore(date2)"),t(n).isBefore(r)},isDateOn:function(n,r){return e.logger.warn("date.isDateOn() was called and is deprecated. Please update code to use date.isSame()"),t(n).isSame(r)},isDateBetween:function(n,r,i,s){return e.logger.warn("date.isDateBetween() was called and is deprecated. Please update code to use date.isBetween()"),t(n).isBetween(r,i,s)}}),_.extend(t.fn,{formatUser:function(e,n){var r=t.getUserDateFormat(n);return e||(r+=" "+t.getUserTimeFormat(n)),this.format(r)},formatServer:function(e){var n=e&&t._serverDateFormat;return this.format(n)},isBetween:function(e,t,n){n=_.isUndefined(n)?!0:n;var r=this.isAfter(e)&&this.isBefore(t);return n&&!r&&(r=this.isSame(e)||this.isSame(t)),r}}),_.extend(t.duration.fn,{format:function(){var t=[],n=this.minutes(),r=this.hours(),i=Math.floor(this.asDays());return i>0&&(t.push(i),t.push(e.lang.get(i===1?"LBL_DURATION_DAY":"LBL_DURATION_DAYS"))),r>0&&(t.push(r),t.push(e.lang.get(r===1?"LBL_DURATION_HOUR":"LBL_DURATION_HOURS"))),n>0&&(t.push(n),t.push(e.lang.get(n===1?"LBL_DURATION_MINUTE":"LBL_DURATION_MINUTES"))),t.join(" ")}}),e.augment("date",t)}(SUGAR.App),function(e){e.augment("math",{_math:function(e,t,n,r,i){r=_.isFinite(r)&&r>=0?parseInt(r):6,i=i||!1;var s,o=Math.pow(10,r),u=parseFloat(t)*o,a=_.isUndefined(n)?undefined:parseFloat(n)*o;switch(e){case"round":s=Math.round(u)/o;break;case"add":s=(u+a)/o;break;case"sub":s=(u-a)/o;break;case"mul":s=this.round(u*a/o/o,r,i);break;case"div":s=this.round(u/a,r,i);break;default:return t}return i&&!_.isString(s)?s.toFixed(r):s},round:function(e,t,n){return this._math("round",e,null,t,n)},add:function(e,t,n,r){return this._math("add",e,t,n,r)},sub:function(e,t,n,r){return this._math("sub",e,t,n,r)},mul:function(e,t,n,r){return this._math("mul",e,t,n,r)},div:function(e,t,n,r){return this._math("div",e,t,n,r)},isDifferentWithPrecision:function(t,n,r){var i=e.metadata.getConfig(),s=r||e.user.getPreference("decimal_precision"),r=_.isFinite(s)?s:i.defaultCurrencySignificantDigits||2,o=this._math("round",this.getDifference(t,n,!0),null,r),u=r===0?0:this._math("div",.1,Math.pow(10,r-1));return o===0?!1:o>=u},getDifference:function(e,t,n){var r=this._math("sub",e,t),n=_.isUndefined(n)?!1:n;return n?Math.abs(r):r}},!1)}(SUGAR.App),function(e){e.augment("currency",{getBaseCurrencyId:function(){return e.metadata.getBaseCurrencyId()},getBaseCurrency:function(){var t=e.metadata.getBaseCurrencyId(),n=e.metadata.getCurrency(t);return n.currency_id=t,n},getCurrenciesSelector:function(t){var n={};return _.each(e.metadata.getCurrencies(),function(e,r){n[r]=t(e)}),n},getCurrencySymbol:function(t){var n=e.metadata.getCurrency(t);return n?n.symbol:""},formatAmount:function(t,n,r,i,s,o){if(!_.isFinite(t))return t;var u,a=e.metadata.getConfig();return n=n||this.getBaseCurrencyId(),o=o||"",_.isFinite(r)||(_.isFinite(a.defaultCurrencySignificantDigits)?r=a.defaultCurrencySignificantDigits:r=2),s=s||a.defaultDecimalSeparator||".",i=_.isUndefined(i)?a.defaultNumberGroupingSeparator||",":i,u=this.getCurrencySymbol(n)||this.getCurrencySymbol(this.getBaseCurrencyId()),t=e.utils.formatNumber(t,r,r,i,s),u+o+t},formatAmountLocale:function(t,n,r){var i=e.user.getPreference("decimal_separator"),s=e.user.getPreference("number_grouping_separator");return r=_.isFinite(r)?r:e.user.getPreference("decimal_precision"),this.formatAmount(t,n,r,s,i)},unformatAmount:function(t,n,r,i){return i=i||!1,t=t.toString().replace(/^[^\d\.\,-]+/,""),e.utils.unformatNumberString(t,n,r,i)},unformatAmountLocale:function(t,n){var r,i,s=e.metadata.getConfig();return r=e.user.getPreference("decimal_separator")||s.defaultDecimalSeparator||".",i=e.user.getPreference("number_grouping_separator")||s.defaultNumberGroupingSeparator||",",this.unformatAmount(t,i,r,n)},convertAmount:function(t,n,r){var i,s;return n==r?e.math.round(t,undefined,!0):(i=e.metadata.getCurrency(n),s=e.metadata.getCurrency(r),this.convertWithRate(t,i.conversion_rate,s.conversion_rate))},convertToBase:function(e,t){return this.convertAmount(e,t,this.getBaseCurrencyId())},convertFromBase:function(e,t){return this.convertAmount(e,this.getBaseCurrencyId(),t)},convertWithRate:function(t,n,r){return n=n||1,r=r||1,e.math.mul(e.math.div(t,n,undefined,!0),r,undefined,!0)}},!1)}(SUGAR.App),function(e){function t(e,t,n,r){if(_.isUndefined(t))return;_.isUndefined(e[n])&&(e[n]={}),e[n][r]=t}Backbone.Model.prototype.doValidate=function(e,t){t(this.isValid())},e.augment("Bean",Backbone.Model.extend({constructor:function(t,n){e.plugins.attach(this,"model"),Backbone.Model.prototype.constructor.call(this,t,n)},initialize:function(t){Backbone.Model.prototype.initialize.call(this,t),this.setSyncedAttributes(t),this.on("sync",function(){this.setSyncedAttributes(this.attributes)},this),this._relatedCollections=null,this.isNew()&&this._defaults&&_.each(this._defaults,function(e,t){this.has(t)||this.set(t,e,{silent:!0})},this),this.fields&&(this.fields=e.metadata.copy(this.fields,{bean:this})),this.addValidationTask("sidecar",_.bind(this._doValidate,this))},dispose:function(){e.plugins.detach(this,"model")},_setRelatedCollection:function(e,t){this._relatedCollections||(this._relatedCollections={}),this._relatedCollections[e]=t},getRelatedCollection:function(t){return this._relatedCollections&&this._relatedCollections[t]?this._relatedCollections[t]:e.data.createRelatedCollection(this,t)},isValidAsync:function(e,t){e=e||this.fields,async.waterfall(_.flatten([function(t){t(null,e,{})},_.sortBy(this._validationTasks)]),function(e,n,r){if(!e){var i=_.isEmpty(r);_.isFunction(t)&&t(i,r)}})},doValidate:function(e,t){var n=this;this.trigger("validation:start"),this.isValidAsync(e,function(e,r){e&&n.trigger("validation:success"),n.trigger("validation:complete",n._processValidationErrors(r)),_.isFunction(t)&&t(e)})},_doValidate:function(n,r,i){var s;_.each(n,function(n,i){_.isString(n)&&(i=n,n=this.fields[i]),s=this.get(i),n&&(t(r,e.validation.requiredValidator(n,n.name,this,s),i,"required"),(s||s===0)&&_.each(e.validation.validators,function(e,o){t(r,e(n,s,this),i,o)},this))},this),i(null,n,r)},addValidationTask:function(e,t){this._validationTasks=this._validationTasks||{},this._validationTasks[e]=t},removeValidationTask:function(e){this._validationTasks&&(this._validationTasks=_.omit(this._validationTasks,e))},_processValidationErrors:function(t){var n=!0;return _.isEmpty(t)||(e.error.handleValidationError(this,t),_.each(t,function(e,t){this.trigger("error:validation:"+t,e)},this),this.trigger("error:validation",t),n=!1),n},save:function(e,t){var n=!0,r=this;if(t&&t.fieldsToValidate){this.doValidate(t.fieldsToValidate,function(n){n&&Backbone.Model.prototype.save.call(r,e,t)});return}return Backbone.Model.prototype.save.call(this,e,t)},canHaveAttachments:function(){return _.has(this.fields,"attachment_list")},getFiles:function(t,n){return n=n||{},n.passOAuthToken=!1,e.api.file("read",{module:this.module,id:this.id},null,t,n)},copy:function(t,n,r){var i={},s=e.metadata.getModule(this.module).fields;n=n||_.pluck(s,"name"),_.each(n,function(n){var r=s[n],o;if(!r||r.duplicate_on_record_copy==="no")return;o=r.duplicate_on_record_copy==="always"||n!=="id"&&r.type!=="link"&&!r.auto_increment;if(o&&t.has(n)){var u=t.get(n);_.isObject(u)&&(u=e.utils.deepCopy(u)),i[n]=u}}),this.set(i,r),this.isCopied=!0},isCopy:function(){return this.isCopied===!0},uploadFile:function(t,n,r,i){return r=r||{},i=i||{},e.api.file("create",{id:i.temp!==!0?this.id:"temp",module:this.module,field:t},n,r,i)},favorite:function(e,t){return t=t||{},t.favorite=!0,this.save({my_favorite:!!e},t)},follow:function(e,t){return t=t||{},e=e||!1,t.following=!0,this.save({following:e},t)},isFavorite:function(){var e=this.get("my_favorite");return e==="1"||e===!0},getChangeDiff:function(e,t){var n={};return e=e||{},t=t||[],_.each(this.attributes,function(r,i){if(_.contains(t,i))return;var s=e[i];_.isEqual(s,r)||(n[i]=s)}),n},toJSON:function(e){var t=e&&e.fields?e.fields:_.keys(this.attributes),n={};return _.each(t,function(t){var r=this.get(t);_.isObject(r)&&_.isFunction(r.toJSON)&&(r=r.toJSON(e)),n[t]=r},this),n},toString:function(){return"bean:"+this.module+"/"+(this.id?this.id:"<no-id>")},revertAttributes:function(t){t=t||{};var n=this.changedAttributes(this.getSyncedAttributes());this.set(e.utils.deepCopy(n)||{},t),t.silent||this.trigger("attributes:revert")},setSyncedAttributes:function(t){this._syncedAttributes=t?e.utils.deepCopy(t):{}},getSyncedAttributes:function(){return this._syncedAttributes},setDefaultAttributes:function(t){e.logger.warn("Data.Bean.setDefaultAttributes is deprecated. Please update your code to use Data.Bean.setDefault"),this._defaults={},this.setDefault(t)},setDefaultAttribute:function(t,n){e.logger.warn("Data.Bean.setDefaultAttribute is deprecated. Please update your code to use Data.Bean.setDefault"),this.setDefault(t,n)},removeDefaultAttribute:function(t){e.logger.warn("Data.Bean.removeDefaultAttribute is deprecated. We consider it as a bad practice so the method will be removed in 7.8. Please update your code to stop using it."),this._defaults&&(this.hasOwnProperty("_defaults")||(this._defaults=_.clone(this._defaults)),delete this._defaults[t])},getDefaultAttribute:function(t){return e.logger.warn("Data.Bean.getDefaultAttribute is deprecated. Please update your code to use Data.Bean.getDefault"),this.getDefault(t)},getDefaultAttributes:function(){return e.logger.warn("Data.Bean.getDefaultAttributes is deprecated. Please update your code to use Data.Bean.getDefault"),this.getDefault()},getDefault:function(e){var t=_.clone(this._defaults)||{};return _.isUndefined(e)?t:t[e]},setDefault:function(e,t){var n;return _.isObject(e)?n=e:(n={})[e]=t,this._defaults=_.extend({},this._defaults,n),this.attributes=_.defaults(this.attributes,n),this}},{merge:function(e,t,n){return _.extend(e,t)}}),!1)}(SUGAR.App),function(e){e.augment("BeanCollection",Backbone.Collection.extend({_activeFetchRequest:null,constructor:function(t,n){e.plugins.attach(this,"collection"),n&&n.link&&(this.link=n.link,delete n.link),Backbone.Collection.prototype.constructor.call(this,t,n)},initialize:function(t,n){this._initOptions=e.utils.deepCopy(n),this.bindCollectionEvents(),Backbone.Collection.prototype.initialize.call(this,t,n),this.total=null,this.on("reset",function(){this.total=null})},bindCollectionEvents:function(){this.on("data:sync:complete",function(){var e=this.getFetchRequest();e&&(this._activeFetchRequest=null)},this)},dispose:function(){e.plugins.detach(this,"collection")},_prepareModel:function(e,t){var n=e._search;return delete e._search,e=Backbone.Collection.prototype._prepareModel.call(this,e,t),e&&!e.link&&(e.link=this.link),n&&(e.searchInfo=n),e},fetch:function(e){return e=_.extend({},this.options,e),this.abortFetchRequest(),e.fields=this.fields=e.fields||this.fields||null,e.myItems=_.isUndefined(e.myItems)?this.myItems:e.myItems,e.favorites=_.isUndefined(e.favorites)?this.favorites:e.favorites,e.query=_.isUndefined(e.query)?this.query:e.query,this.options=e,this._activeFetchRequest=Backbone.Collection.prototype.fetch.call(this,e),this.getFetchRequest()},getFetchRequest:function(){return _.isFunction(this._activeFetchRequest)?this._activeFetchRequest():this._activeFetchRequest},abortFetchRequest:function(){var t=this.getFetchRequest();t&&(e.api.abortRequest(t.uid),this._activeFetchRequest=null)},resetPagination:function(){var e={offset:0,next_offset:0,page:1},t=_.keys(e);this.resetOptions(t),_.each(t,function(t){this.options&&this.options[t]?this[t]=this.options[t]:this[t]=e[t]},this)},resetOptions:function(e){_.isEmpty(this._initOptions)?this.options=null:e?_.each(e,function(e){_.isUndefined(this._initOptions[e])?delete this.options[e]:this.options[e]=this._initOptions[e]},this):this.options=this._initOptions},paginate:function(t){t=t||{};var n=t.limit||e.config.maxQueryResult;t.page=t.page||1,t.page--,n&&(t.offset=this.offset+t.page*n),t.add&&(t=_.extend({update:!0,remove:!1},t)),this.fetch(t)},fetchTotal:function(t,n){t=t||{},n=n||{};if(!_.isNull(this.total)&&_.isFunction(t.success)){t.success.call(this,this.total);return}t.success=_.wrap(t.success,_.bind(function(e,t){this.total=parseInt(t.record_count,10),e&&_.isFunction(e)&&e(this.total)},this));var r=this.module,i=null;return n.filter=n.filterDef||this.filterDef,this.link&&(i={id:this.link.bean.id,link:this.link.name},r=this.link.bean.module),e.api.count(r,i,t,n)},getPageNumber:function(t){var n=1,r=e.config.maxQueryResult;return t&&(r=t.limit||r),this.offset&&r&&(n=Math.ceil(this.offset/r)),n},toString:function(){return"coll:"+(this.link?this.link.bean.module+"/"+this.link.bean.id+"/":"")+this.module+"-"+this.length},getNext:function(e,t){var n=-1,r=null,i=this;this.hasNextModel(e)&&(n=this.getModelIndex(e),n+1>=this.length?this.paginate({add:!0,success:function(e,r,s){t.apply(i,[i.at(n+1),"next"])}}):t.apply(i,[i.at(n+1),"next"]))},getPrev:function(e,t){var n=-1,r=null,i=this;this.hasPreviousModel(e)&&(n=this.getModelIndex(e),r=this.at(n-1)),t.apply(i,[r,"prev"])},hasNextModel:function(e){var t=this.getModelIndex(e),n=_.isUndefined(this.next_offset)?-1:parseInt(this.next_offset,10);return t>=0&&(this.length>t+1||n!==-1)},hasPreviousModel:function(e){return this.getModelIndex(e)>0},getModelIndex:function(e){return this.indexOf(this.get(e.id))}}),!1)}(SUGAR.App),function(e){e.augment("MixedBeanCollection",e.BeanCollection.extend({_prepareModel:function(t,n){var r=t instanceof e.Bean?t.module:t._module;return this.model=e.data.getBeanClass(r),e.BeanCollection.prototype._prepareModel.call(this,t,n)},fetch:function(t){return t=t||{},t.module_list=this.module_list=t.module_list||this.module_list||e.metadata.getModuleNames({filter:"visible"}),e.BeanCollection.prototype.fetch.call(this,t)},groupByModule:function(){return _.groupBy(this.models,function(e){return e.module})},toString:function(){return"mcoll:"+this.length}}),!1)}(SUGAR.App),function(e){var t={},n={},r=_.extend({beanModel:e.Bean,beanCollection:e.BeanCollection,mixedBeanCollection:e.MixedBeanCollection,init:function(){var t=_.bind(this.sync,this);e.Bean.prototype.sync=t,e.BeanCollection.prototype.sync=t,e.events.register("data:sync:start",this),e.events.register("data:sync:complete",this),e.events.register("data:sync:success",this),e.events.register("data:sync:error",this),e.events.register("data:sync:abort",this)},reset:function(e){this.resetModel(e),this.resetCollection(e)},resetModel:function(e){e?delete t[e]:t={}},resetCollection:function(e){e?delete n[e]:n={}},declareModel:function(t,n,r,i,s){r=r||e.config.platform||"base";var o=this.declareModelClass(t,n,r,i);this.declareCollectionClass(t,r,s)},declareModelClass:function(n,r,i,s){var o=e.utils.capitalize(i);n=n||o+"Model",this.resetModel(n);var u=r?r.fields:{},a=null;_.each(_.values(u),function(e){_.isUndefined(e["default"])||(a===null&&(a={}),a[e.name]=e["default"])});var f={_defaults:a,module:n,fields:u},l=t[o+"Model"]||t.BaseModel||this.beanModel;return s=_.extend(s||{},f),e.utils.extendClass(t,l,n,s,o)},declareCollectionClass:function(r,i,s){var o=e.utils.capitalize(i),u=r||o+"Model",a=t[u];r=r||o+"Collection";if(!a)return;this.resetCollection(r);var f={model:a,module:r,offset:0},l=n[o+"Collection"]||n.BaseCollection||this.beanCollection;return s=_.extend(s||{},f),e.utils.extendClass(n,l,r,s,o)},mergeModel:function(e,n){var r=n?n.fields:{},i=null;_.each(_.values(r),function(e){_.isUndefined(e["default"])||(i===null&&(i={}),i[e.name]=e["default"])});var s={_defaults:i,module:e,fields:r};_.extend(t[e].prototype,s)},getModelClasses:function(){return t},getCollectionClasses:function(){return n},declareModels:function(n){n=n||e.metadata.getModules(),_.each(n,function(e,n){t[n]?this.mergeModel(n,e):this.declareModel(n,e)},this)},getBeanClass:function(e){return t[e]||Backbone.Model},createBean:function(n,r,i){return t[n]?new t[n](r,i):new e.data.beanModel(r,i)},createBeanCollection:function(t,r,i){return n[t]?new n[t](r,i):new e.data.beanCollection(r,i)},createRelatedBean:function(e,t,n,r){var i=this.getRelatedModule(e.module,n);return r=r||{},_.isString(t)?(r.id=t,t=this.createBean(i,r)):_.isNull(t)?t=this.createBean(i,r):t.set(r),t.link={name:n,bean:e,isNew:!0},t},createRelatedCollection:function(e,t,n){var r=this.getRelatedModule(e.module,t),i=this.createBeanCollection(r,n,{link:{name:t,bean:e}});return e._setRelatedCollection(t,i),i},createMixedBeanCollection:function(t){return new e.data.mixedBeanCollection(t)},canHaveMany:function(t,n){var r=e.metadata.getModule(t);if(!r||!r.fields||!r.fields[n])return!1;if(r.fields[n].link_type)return r.fields[n].link_type==="many";var i=r.fields[n].relationship,s=e.metadata.getRelationship(i),o=s.relationship_type.split("-"),u;return r.fields[n].side?u=r.fields[n].side==="left"?o[0]:o[2]:s.lhs_module!==s.rhs_module?u=t===s.rhs_module?o[0]:o[2]:u=o[0]==="many"||o[2]==="many"?"many":"one",u==="many"},getRelateFields:function(t,n){var r=e.metadata.getModule(t).fields[n].relationship,i=this.getRelatedModule(t,n),s=e.metadata.getModule(i).fields,o=_.find(s,function(e){return e.type=="link"&&e.relationship==r});return o&&(o=_.filter(s,function(e){return e.type=="relate"&&e.link==o.name})),o||[]},getRelationshipFields:function(t,n){var r=null,i=e.metadata.getModule(t).fields[n];if(i.rel_fields){var s=i.relationship,o=this.getRelatedModule(t,n),u=e.metadata.getModule(o).fields,a=_.find(u,function(e){return e.type=="link"&&e.relationship==s});a&&(a=_.find(u,function(e){return e.link==a.name&&e.link_type=="relationship_info"}));if(a&&a.relationship_fields){var f=_.keys(i.rel_fields);_.each(a.relationship_fields,function(e,t){_.include(f,t)&&(r||(r=[]),r.push(e))})}}return r},getRelatedModule:function(t,n){var r=e.metadata.getModule(t);if(!r||!r.fields||!r.fields[n])return!1;var i=r.fields[n]&&r.fields[n].relationship,s=e.metadata.getRelationship(i);return s?r.fields[n].module||(t===s.rhs_module?s.lhs_module:s.rhs_module):r.fields[n].module||!1},getRelatedNameField:function(t,n){return _.find(e.metadata.getModule(t).fields,function(e){if(e.name!==n&&e.id_name===n)return e},this)},getEditableFields:function(t,n){var r={};return _.each(n,function(n){e.acl.hasAccessToModel("edit",t,n)&&(r[n]=t.get(n))}),r.id=t.get("id"),r},sync:function(t,n,r){e.logger.trace("data-sync-"+(r.relate?"relate-":"")+t+": "+n),r=this.parseOptionsForSync(t,n,r);var i=this.getSyncCallbacks(t,n,r),s=null;n.dataFetched=!1,this.trigger("data:sync:start",t,n,r),n.trigger("data:sync:start",t,r);if(_.isFunction(r.endpoint))r.endpoint(t,n,r,i);else if(r.relate===!0){var o=null;if(t=="create"||t=="update")o=this.getEditableFields(n,r.fields),t=="update"&&n.link.isNew&&(t="create");s=e.api.relationships(t,n.link.bean.module,{id:n.link.bean.id,link:n.link.name,relatedId:n.id,related:o},r.params,i,r.apiOptions)}else r.favorite?s=e.api.favorite(n.module,n.id,n.isFavorite(),i,r.apiOptions):r.following?s=e.api.follow(n.module,n.id,n.get("following"),i,r.apiOptions):r.query||n instanceof e.MixedBeanCollection?s=e.api.search(r.params,i,r.apiOptions):n.module?s=e.api.records(t,n.module,t=="update"||t=="create"?this.getEditableFields(n,r.fields):n.attributes,r.params,i,r.apiOptions):e.logger.error("Unable to sync model with no module");return s},parseOptionsForSync:function(t,n,r){r=r||{},r.params=r.params||{},r.filterDef=r.filter||n.filterDef,r.view&&_.isString(r.view)&&t=="read"&&(r.params.view=r.view),r.fields&&t=="read"&&(r.params.fields=r.fields.join(",")),r.viewed===!0&&(r.params.viewed="1");if(t=="read"&&n instanceof e.BeanCollection){r.offset&&r.offset!==0&&(r.params.offset=r.offset);if(r.limit||e.config&&e.config.maxQueryResult)r.params.max_num=r.limit||e.config.maxQueryResult;n.orderBy&&n.orderBy.field&&(r.params.order_by=n.orderBy.field+":"+n.orderBy.direction),r.myItems===!0&&(r.params.my_items="1"),r.favorites===!0&&(r.params.favorites="1");if(!_.isEmpty(r.filterDef)){var i=e.utils.deepCopy(r.filterDef);_.has(i,"filter")&&(i=i.filter),_.isArray(i)||(i=[i]),r.params.filter=i}_.isEmpty(r.query)||(r.params.q=r.query,_.isEmpty(r.module_list)&&n.module&&(r.module_list=[n.module])),r.module_list&&(r.params.module_list=r.module_list.join(","))}return t==="update"&&r.lastModified&&(r.apiOptions=r.apiOptions||{},r.apiOptions.headers=r.apiOptions.headers||{},r.apiOptions.headers["X-TIMESTAMP"]=r.lastModified),r},getSyncCallbacks:function(e,t,n){return{success:this.getSyncSuccessCallback(e,t,n),error:this.getSyncErrorCallback(e,t,n),complete:this.getSyncCompleteCallback(e,t,n),abort:this.getSyncAbortCallback(e,t,n)}},getSyncSuccessCallback:function(t,n,r){var i=this;return function(s,o){n.inSync=!0,n.original_assigned_user_id=n.get("assigned_user_id"),t=="read"&&n instanceof e.BeanCollection&&(s=s||{},s.next_offset&&(n.offset=s.next_offset!=-1?s.next_offset:n.offset+(s.records||[]).length,n.next_offset=s.next_offset,n.page=n.getPageNumber(r)),s=s.records||[],i._updateCollectionProperties(n,r));if(r.relate===!0){n.link.isNew=!1;if(t!="read"){if(n.link.bean){var u=n.link.bean.getSyncedAttributes(),a=_.reduce(s.record,function(e,t,n){return _.isEqual(u[n],t)||(e[n]=t),e},{});n.link.bean.set(a),n.link.bean.setSyncedAttributes(s.record)}s=s.related_record,t=="delete"&&(n.set(s),delete n.link)}}n.dataFetched=!0,r.success&&r.success(n,s,r),n.trigger("sync",n,s,r,o),i.trigger("data:sync:success",t,n,r,o),n.inSync=null}},getSyncErrorCallback:function(t,n,r){return _.bind(function(i){if(i.request&&i.request.aborted){var s=this.getSyncAbortCallback(t,n,r);return s(i.request)}e.error.handleHttpError(i,n,r),this.trigger("data:sync:error",t,n,r,i),n.trigger("data:sync:error",t,r,i),_.isFunction(r.error)&&r.error(i)},this)},getSyncCompleteCallback:function(e,t,n){return _.bind(function(r){this.trigger("data:sync:complete",e,t,n,r),t.trigger("data:sync:complete",e,n,r),_.isFunction(n.complete)&&n.complete(r),n.previousModels=null,n={}},this)},getSyncAbortCallback:function(e,t,n){return _.bind(function(r){this._updateCollectionProperties(t,n),this.trigger("data:sync:abort",e,t,n,r),t.trigger("data:sync:abort",e,n,r)},this)},_updateCollectionProperties:function(e,t){t=t||{},e.myItems=t.myItems,e.favorites=t.favorites,e.query=t.query,e.modelList=t.modelList,e.filterDef=t.filterDef}},Backbone.Events);e.augment("data",r,!1)}(SUGAR.App),function(e){e.augment("validation",{validators:function(){var t=function(e,t,n){var r=_.isUndefined(e[n])?e.validation?e.validation[n]:null:e[n];if(_.contains(["int","float","decimal","currency"],e.type)&&_.isFinite(r)){e.type=="int"?t=parseInt(t):t=parseFloat(t);if(n=="max"){if(t>r)return r}else if(n=="min"){if(t<r)return r}else if(n=="greaterthan"){if(t<=r)return r}else if(n=="lessthan"&&t>=r)return r}},n=function(t,n,r,i){if(_.indexOf(["date","datetimecombo"],t.type)!==-1&&t.validation&&t.validation.type===r){var s=i.fields[t.validation.compareto];if(!_.isUndefined(s)&&_.indexOf(["date","datetimecombo"],s.type)!=-1){var o=Date.parse(i.get(s.name));n=Date.parse(n.toString());if(!_.isNaN(o)&&!_.isNaN(n)){var u=e.lang.get(s.label||s.vname||s.name,i.module);if(r=="isbefore")return o<n?u:undefined;if(r=="isafter")return o>n?u:undefined}}}};return{maxLength:function(e,t){_.isNumber(t)&&(t=t.toString());if(_.isNumber(e.len)&&_.isString(t)){var n=e.len;t=t||"",t=t.toString();if(t.length>n)return n}},minLength:function(e,t){if(_.isNumber(e.minlen)){var n=e.minlen;t=t||"",t=t.toString();if(t.length<n)return n}},url:function(e,t){},email:function(t,n){var r;if(t.type=="email"||t.type==="email-text"){n.length>0&&_.each(n,function(n){if(!(n.email_address!==""||!_.isUndefined(t.required)&&t.required!=0))return;e.utils.isValidEmailAddress(n.email_address)||(r||(r=[]),r.push(n.email_address))});if(r&&r.length>0)return r}},primaryEmail:function(e,t){if(e.type=="email"&&t.length>0&&!_.find(t,function(e){return e.primary_address=="1"}))return!0},duplicateEmail:function(e,t){if(e.type=="email"){var n=_.pluck(t,"email_address"),r=[],i=n.length,s,o;for(s=0;s<i;s++)for(o=s+1;o<i;o++)n[s]==n[o]&&r.push(n[s]);if(r&&r.length>0)return r}},datetime:function(t,n){function c(e,t,n){var r=parseInt(e,10);return!isNaN(r)&&r>=t&&r<=n}var r,i,s,o,u,a,f,l;if(t.type==="date"||t.type==="datetimecombo"){if(_.isNaN(Date.parse(n))&&_.isNaN(Date.parse(n.replace(/[\.\-]/g,"/"))))return n;if(!e.date.isIso(n)){a=n.replace(/[\.\-]/g,"/").split("/"),i=_.filter(a,function(e,t){return e.length===3||e.length>4});if(i.length)return n;if(/([\.\/\-])\1/.test(n)===!0)return n;s=e.user.getPreference("datepref"),o=s.match(/[.\/\-\s].*?/),u=s.split(o);for(f=0,l=u.length;f<l;f++){r=a[f];switch(u[f].toLowerCase().charAt(0)){case"m":if(!c(r,1,12))return n;break;case"d":if(!c(r,1,31))return n}}}else if(n.charAt(0)==="0")return n}},minValue:function(e,n){return t(e,n,"min")},maxValue:function(e,n){return t(e,n,"max")},greaterThan:function(e,n){return t(e,n,"greaterthan")},lessThan:function(e,n){return t(e,n,"lessthan")},number:function(e,t){if(_.indexOf(["int","float","decimal","currency"],e.type)!=-1)return _.isBoolean(t)||_.isString(t)&&t.trim().length==0||isNaN(parseFloat(t))||!_.isFinite(t)?!0:undefined},isBefore:function(e,t,r){return n(e,t,"isbefore",r)},isAfter:function(e,t,r){return n(e,t,"isafter",r)}}}(),requiredValidator:function(e,t,n,r){if(e.required===!0&&t!=="id"&&e.type!=="image"&&_.isUndefined(e.auto_increment)){var i=n.get(t),s=_.isUndefined(i),o=_.isNull(r)||r===""||r===!1||_.isArray(r)&&this._isArrayEmpty(r)||r instanceof Backbone.Collection&&r.length==0;if(s&&_.isUndefined(r)||o)return!0}},_isArrayEmpty:function(e){return _.every(e,_.isEmpty)}},!1)}(SUGAR.App),function(e){var t="meta:hashes",n,r,i,s=["offline:enabled","offline:failure","offline:prefetch:start","offline:prefetch:complete","offline:prefetch:progress","offline:api:read:success","offline:status:update","offline:server:read","offline:data:updated","offline:data:sync:success","offline:tx:create","offline:tx:success","offline:tx:delete","offline:tx:error","offline:tx:rollback","offline:wins:completed"];e.augment("offline",{INITIALIZED_TS_KEY:"offline:initialized_ts",STATE:{OK:0,WARNING:1,ERROR:2},userEnabled:!0,noConnection:!1,status:null,init:function(){this.SYNC_ACTIONS_SYMBOLS=_.invert(this.SYNC_ACTIONS),e.events.on("app:start",function(){e.isSynced&&this.start()},this).on("app:logout",function(){this.stop()},this).on("app:sync",function(){this.stop()},this)},isSupported:function(t){return e.utils.versionCompare(t.version||"",e.config.offline.minServerVersion,">=")},_registerEvents:function(){_.each(s,function(t){e.events.unregister(e,t),e.events.register(t,e)})},_initialize:function(){if(this._initialized)return;this._uninitialize(),$(document).on("ajaxComplete",this._onAjaxComplete),n=e.data.beanModel,r=e.data.beanCollection,i=e.data.mixedBeanCollection,e.data.beanModel=this.declareOfflineBean(),e.data.beanCollection=this.declareOfflineBeanCollection(),e.data.mixedBeanCollection=this.declareOfflineMixedBeanCollection(),e.data.reset(),e.data.declareModels(),this.storage.init(e.metadata.get()),this.api.override(),this.syncManager.httpErrorHandler=_.bind(e.error.handleStatusCodesFallback,e.error),this.syncManager.init(),this._registerSyncExecutors(),this.status={state:this.STATE.OK},this._initialized=!0,e.logger.debug("Offline initialized")},_registerSyncExecutors:function(){_.each(e.config.offline.syncManager.executors,function(t,n){var r=new(e.offline[e.utils.capitalize(n)+"SyncExecutor"])(t);e.offline.syncManager.registerExecutor(r)})},_initStorage:function(){return e.offline.storage.open({env:e.config.env,name:e.config.appId,size:e.config.offline.storageSize,adapter:e.offline[e.config.offline.storageAdapter+"Adapter"]})},_uninitialize:function(){if(!this._initialized)return;$(document).off("ajaxComplete",this._onAjaxComplete),e.offline.api.restore(),e.data.beanModel=n,e.data.beanCollection=r,e.data.mixedBeanCollection=i,e.data.reset(),e.data.declareModels(),e.status=null,e.offlineEnabled=!1,this._initialized=!1,e.logger.debug("Offline uninitialized")},isUp:function(){return!!this._initialized},start:function(t){t=t||{},e.config.offline=_.extend({enabled:!0,prefetch:{},storageSize:5,storageProvider:"sql",storageAdapter:"webSql",syncTimeout:5e3,debug:{render:!1,online:!0,forceMigrate:!1,syncManagerEnabled:!0,monitorStatus:!0}},e.config.offline||{}),e.config.offline.debug.ignoreEnabled&&(e.config.offlineEnabled=!0);var n=this,r=this.isSupported(e.metadata.getServerInfo());e.offlineEnabled=e.config.offlineEnabled&&e.config.offline.enabled&&this.userEnabled&&r;var i=e.cache.get("offline:version");t.migrate=t.migrate||!i;var s=function(){e.logger.debug("Offline mode disabled"),n._uninitialize(),t.callback&&t.callback()};this._registerEvents();var o=function(){n.startSyncManager(),n.startMonitorStatus(),e.logger.debug("Offline started"),t.callback&&t.callback(),e.trigger("offline:enabled",!0)};if(e.offlineEnabled||i&&!e.offlineEnabled){var u=this._initStorage();if(u&&!e.offlineEnabled){this.dropStorage(function(){s()});return}u?(this._initialize(),t.migrate?async.waterfall([function(n){var r=e.utils.deepCopy(e.metadata.get());r.modules=_.omit(r.modules,e.config.offline.exclude),e.offline.upgrade(r,n)},e.offline.migrate],function(t){t?(e.trigger("offline:failure",t),s()):o()}):o()):(e.logger.error("Storage unavailable"),e.offlineEnabled=!1,e.trigger("offline:failure",n.Error.StorageUnavailableError))}e.offlineEnabled||(s(),e.trigger("offline:enabled",!1))},stop:function(t){if(!this._initialized)return;t=t||{};var n=this,r=function(r){n._uninitialize(t),e.logger.debug("Offline stopped"),e.trigger("offline:enabled",!1),t.callback&&t.callback(r)};this.stopMonitorStatus(),this.syncManager.dispose(),t.dropDb?this.dropStorage(function(e){r(e)}):r()},dropStorage:function(n){e.logger.debug("Dropping storage"),this.storage.drop(function(r){e.cache.cut("offline:version"),e.cache.cut(t),r&&e.logger.error("Failed to drop storage: "+r),n&&n(r)})},SYNC_ACTIONS:{CREATE:1,UPDATE:2,DELETE:3,LINK:4,UNLINK:5,FAVORITE:6,FOLLOW:7},SYNC_ACTIONS_SYMBOLS:null,TRANSACTION_STATUSES:{UNRECOVERABLE:[403,405,422,500]},upgrade:function(n,r){var i=this,s=e.cache.get(t);e.logger.debug("Upgrading offline storage"),e.offline.storage.upgrade(n,s,{success:function(t,n){e.logger.debug("Successfully upgraded offline storage"),i.storeOfflineMeta(t),e.cache.set("offline:version",i.storage.getSqlStorageVersion()),r(null,t,n)},error:function(t){e.logger.error("Failed to upgrade offline storage. "+t),r(t)}})},migrate:function(t,n,r){var i=[],s=!e.config.offline.debug.forceMigrate&&n&&n._hash===t._hash&&n._userId===e.user.get("id")&&n.siteUrl===e.utils.stripHttpPrefix(e.config.siteUrl),o=function(t){t?(t.label=e.lang.get("ERR_OFFLINE_STORAGE_CREATE"),e.logger.error("Failed to migrate offline storage. "+t)):e.logger.debug("Successfully migrated offline storage"),r(t)};e.offline.storage.resetMigrationSummary(),s?o():(e.logger.debug("Migrating offline storage"),i=[function(n){e.offline.utils.getServerTime(function(t,r){t?(e.logger.error("Failed to get server time: "+t),t=new e.offline.Error("server_time_unavailable","Failed to retrieve server time","ERR_OFFLINE_SERVERTIME_UNAVAILABLE",t),n(t)):(e.cache.set(e.offline.INITIALIZED_TS_KEY,r),n())})},function(i){e.offline.storage.migrate(t,n,{forceDrop:e.config.offline.debug.forceMigrate,success:i,error:i})}],async.series(i,o))},compactStorage:function(t){e.offline.storage.compact(t)},clearStorage:function(t){e.offline.storage.migrate(e.metadata.get(),null,{forceDrop:!0,success:t.callback,error:t.callback})},storeOfflineMeta:function(n){var r={};r._hash=n._hash,r._userId=e.user.id,r.relationships={_hash:n.relationships._hash},r.siteUrl=e.utils.stripHttpPrefix(e.config.siteUrl),r.modules={},_.chain(n.modules).omit(e.config.offline.exclude).each(function(e,t){e._hash&&(r.modules[t]={_hash:e._hash,fields:{_hash:e.fields._hash}},_.each(e.fields,function(e,n){if(n==="_hash")return;r.modules[t].fields[n]={type:e.type,name:e.name}}))}),e.cache.set(t,r)},isOnline:function(){return e.config.offline.debug.online&&window.navigator.onLine},getOfflineModules:function(){return _.filter(_.keys(e.metadata.get().modules),function(t){return e.offline.isOfflineEnabled(t)})},isOfflineEnabled:function(t){return(e.config.offline.exclude||[]).indexOf(t)===-1},startSyncManager:function(){e.config.offline.enabled&&!e.offline.syncManager.isStarted&&e.api.isAuthenticated()&&e.offline.syncManager.start()},stopSyncManager:function(){e.offline.syncManager.stop()},startMonitorStatus:function(){if(this._monitorIntervalId||!e.config.offline.debug.monitorStatus)return;var t=this,n=function(){async.parallel({transactions:function(n){t.storage.exec([{op:"countTransactions"}],function(e){n(null,e)},function(r){e.logger.error("Failed to count transactions: "+r),n(r)})},isOutOfSpace:function(e){t.storage.isOutOfSpace(function(t){e(null,t)})}},function(n,r){var i=r.transactions||{};i.noConnection=t.noConnection||!t.isOnline(),i.isSyncing=t.syncManager.isSyncing(),i.lastSyncTs=t.syncManager.lastSyncTs,i.isOutOfSpace=r.isOutOfSpace,i.failedTransactions>0||i.isOutOfSpace?i.state=t.STATE.ERROR:i.noConnection||i.totalTransactions>0?i.state=t.STATE.WARNING:i.state=t.STATE.OK,t.status=i,e.trigger("offline:status:update",i)})};n(),this._monitorIntervalId=window.setInterval(n,e.config.offline.monitorTimeout||1e4)},stopMonitorStatus:function(){window.clearInterval(this._monitorIntervalId),this._monitorIntervalId=null},_onAjaxComplete:function(t,n){e.offline.noConnection=!n.aborted&&!n.status},Error:function(e,t,n,r,i){this.code=e,this.message=t,this.label=n,this.err=r,this.sqlInfo=i}},!1),_.extend(e.offline.Error.prototype,{localizedMessage:function(){var t;try{t=e.lang.get(this.label||"ERR_OFFLINE")}catch(n){t="Offline Error",e.logger.fatal("Failed to localize offline error. "+n)}return t},toString:function(){var t=this.localizedMessage()+": ("+this.code+") "+this.message;if(this.err){var n;try{n=JSON.stringify(this.err)}catch(r){n=this.err.toString()}t+="\nOriginal error: "+n}if(this.sqlInfo){var i=/\\\"/g,s,o;e.config.env==="dev"?(s=this.sqlInfo.failedSql,o=this.sqlInfo.transactionSql):(s=this.sqlInfo.failedSql.sql,o=_.map(this.sqlInfo.transactionSql,function(e){return{module:e.module,sql:_.map(e.sql,function(e){return{sql:e.sql}})}})),t+=". Failed SQL: "+JSON.stringify(s).replace(i,'"'),t+=". All SQL in transaction: "+JSON.stringify(o).replace(i,'"')}return t}}),_.extend(e.offline.Error,{OfflineDisabledError:new e.offline.Error("offline_disabled","Offline Mode is disabled","Offline is not initialized"),OutOfSpaceError:new e.offline.Error("out_of_space","Out of space","ERR_OFFLINE_OUT_OF_SPACE"),StorageUnavailableError:new e.offline.Error("storage_unavailable","Failed to open db","ERR_OFFLINE_STORAGE_UNAVAILABLE"),UnknownError:new e.offline.Error("unknown","Unknown error")})}(SUGAR.App),function(e){e.offline.utils={notImplemented:function(){throw new Error("Not implemented. Please override this method with your implementation")},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})},isDataSynchronized:function(t){return t instanceof e.Bean?t.get("_client_date_modified")===t.get("date_modified"):_.isObject(t)?t._client_date_modified&&t.date_modified&&t._client_date_modified===t.date_modified:!1},prepareHighlightQuery:function(e){var t="(\\*|\\%)+";return e=e?e.trim().replace(/[-\[\]{}()+.,\\\^$|#\s]/g,"\\$&").replace(new RegExp("(^"+t+")|("+t+"$)","g"),"").replace(/%|\*/g,".*").replace(/_|\?/g,"."):"",e},prepareQuery:function(e){return e=e?e.trim().replace(/[-\[\]{}()+.,\\\^$|#\s]/g,"\\$&").replace(/%|\*/g,".*").replace(/_|\?/g,"."):"","^"+e},checkIsEmptyQuery:function(e){return e=e?e:"",e=e.replace(/%|\*/g,"").replace(/_|\?/g,""),e=e.trim(),_.isEmpty(e)},compileHighlightRegExp:function(e){return e=this.prepareHighlightQuery(e),new RegExp("([^\\s:-;,><]*"+e+"[^\\s:-;,><]*)","i")},compileSearchRegExp:function(e){return new RegExp(this.prepareQuery(e))},actionToSymbol:function(t){var n=t._tx_action||t.action,r=t._tx_related_id||t.relate;return e.offline.SYNC_ACTIONS_SYMBOLS[n]+(r?"_RELATED":"")},getTxAge:function(e){return parseInt((new Date-new Date(e._tx_ts))/1e3,10)},getCleanedParams:function(e){return _.omit(e,["changedFields","skipServerSync","skipOfflineRead","serverSyncSuccess","deferSync","initialState","forceServerSync","relate"])},actionToString:function(t){if(t===e.offline.SYNC_ACTIONS.CREATE)return"createSingle";if(t===e.offline.SYNC_ACTIONS.UPDATE||t===e.offline.SYNC_ACTIONS.LINK)return"updateValuesSingle";if(t===e.offline.SYNC_ACTIONS.DELETE||t===e.offline.SYNC_ACTIONS.UNLINK)return"hardDeleteSingle";if(t===e.offline.SYNC_ACTIONS.FAVORITE||t===e.offline.SYNC_ACTIONS.FOLLOW)return"updateValuesSingle";throw new Error("Invalid action")},isRecordAssignedToLoginUser:function(t){return t.assigned_user_id&&t.assigned_user_id===e.user.id},getOfflineModules:function(){return _.filter(_.keys(e.metadata.get().modules),function(t){return e.offline.isOfflineEnabled(t)})},getBeforeAndAfter:function(e,t){t=t||{};var n={};return _.each(e,function(e,r){if(r==="_client_date_modified"||r==="id"||e===t[r])return;n[r]={after:e,before:t[r]?t[r]:null}},this),_.isEmpty(n)?null:n},getInitialState:function(e,t){var n=JSON.parse(e._tx_updated_fields);return _.each(n,function(e,n){if(n==="email")return;t[n]=e.before}),t},fetchPageByPage:function(t,n,r,i,s){var o=s.maxRecords||20,u=s.pageSize||20;i=i||0,_.extend(n,{offset:n.offset||0,max_num:u,order_by:n.order_by||"date_modified:DESC"}),e.offline.api.callOriginalApi("records",["read",t,null,n,{success:function(a){if(_.isEmpty(a.records))return s.callback();r({module:t,records:a.records,callback:function(f){if(f)return s.callback(f);var l=i>=o;i+=u,n.offset+=u,s.iterator&&s.iterator(l?o:i),l||a.next_offset===-1?s.callback():e.offline.utils.fetchPageByPage.call(e.offline.utils,t,n,r,i,s)}})},error:s.callback}])},ping:function(t){var n=+(new Date);e.offline.api.callOriginalApi("ping",[null,{success:function(){var e=new Date-n;t(null,e)},error:function(e){t(e)}}])},getServerTime:function(t){e.offline.api.callOriginalApi("ping",["whattimeisit",{success:function(e){t(null,e)},error:t},{skipMetadataHash:!0}])},shouldUpdateLastViewedDate:function(e){return e&&e.viewed},callOnce:function(e){var t={success:!1,error:!1,complete:!1};_.each(e,function(n,r){e[r]=function(){if(t[r])return;t[r]=!0,n.apply(this,arguments),n=null}})},paginate:function(e,t){function s(e,n){var r=n*t,i=(n+1)*t;return e.slice(r,i)}var n=0,r,i=[];if(_.isEmpty(e))return i;r=s(e,n);while(!_.isEmpty(r))i.push(r),r=s(e,++n);return i},getStoppableAsyncFlow:function(t,n,r){var i=!1,s;return s=_.map(n,function(t){return function(){i?(e.logger.debug("Async flow interrupted"),r()):t.apply(null,arguments)}}),async[t](s,r),function(){i=!0}}}}(SUGAR.App),function(e){e.offline.syncManager={httpErrorHandler:null,lastSyncTs:null,syncExecutors:[],_currentExecutor:null,start:function(){this.intervalId=window.setInterval(this._runSyncIteration,e.config.offline.syncManager.syncTimeout*1e3||1e4)},stop:function(){window.clearInterval(this.intervalId)},dispose:function(){e.events.off("offline:data:sync:success",null,this),this.syncExecutors=[],this.stop()},init:function(){this.dispose(),e.events.on("offline:data:sync:success",function(){this._runSyncIteration()},this)},registerExecutor:function(e){t.syncExecutors.push(e),t.syncExecutors=_.sortBy(t.syncExecutors,function(e){return e.getPriority()})},isSyncing:function(){var e=!1;return _.each(t.syncExecutors,function(t){e=e||t.isWorking()}),e},_syncErrorHandler:function(n){if(n instanceof SUGAR.Api.HttpError){if(e.utils.isConnectivityError(n))return;n.status===412&&t.httpErrorHandler?(t.stop(),t.httpErrorHandler(n)):e.logger.error(n)}else if(n instanceof e.offline.Error){t.stop();var r=n===e.offline.Error.OfflineDisabledError?n:new e.offline.Error("synchronization_error","Synchronization failed","ERR_OFFLINE_SYNC_ERROR",n);e.trigger("offline:failure",r),e.logger.error(n)}else n&&e.logger.error(n)},_runSyncIteration:function(n){if(!e.offline.isOnline()||!e.config.offline.debug.syncManagerEnabled||!e.config.offline.syncManager.enabled||_.isEmpty(t.syncExecutors)){n&&n();return}var r=[];_.each(t.syncExecutors,function(e){r.push(function(){t._currentExecutor=e,e.sync.apply(e,arguments)})}),async.series(r,function(e){t._currentExecutor=null,t.lastSyncTs=new Date,t._syncErrorHandler(e),n&&n(e)})},sync:function(t){e.offlineEnabled&&this._runSyncIteration(t)},startRecordsPreloader:function(e){e=e||{},t.stop(),t._currentExecutor&&t._currentExecutor.stop();var n=e.callback;t.recordsPreloader.start(_.extend(e,{callback:function(e){t.start(),n&&n(e)}}))}};var t=e.offline.syncManager}(SUGAR.App),function(e){var t;e.offline.api={originalMethods:{},NO_CONNECTION_ERROR:{status:0,textStatus:"error",toString:function(){return"No internet connection"}},SERVER_READ_STATUS:{start:1,finish:2,error:3},override:function(){_.extend(this.originalMethods,{records:e.api.records,relationships:e.api.relationships,favorite:e.api.favorite,follow:e.api.follow,search:e.api.search,file:e.api.file}),_.extend(e.api,{records:this.records,relationships:this.relationships,favorite:this.favorite,follow:this.follow,search:this.search,file:this.file})},restore:function(){if(_.isEmpty(this.originalMethods))return;_.extend(e.api,{records:this.originalMethods.records,relationships:this.originalMethods.relationships,favorite:this.originalMethods.favorite,follow:this.originalMethods.follow,search:this.originalMethods.search,file:this.originalMethods.file}),this.originalMethods={}},records:function(n,r,i,s,o,u){return e.offline.isOfflineEnabled(r)||r==="Recents"?t._executeOfflineApi(n,r,i,s,o,t.originalMethods.records,u):t.originalMethods.records.call(e.api,n,r,i,e.offline.utils.getCleanedParams(s),o,u)},relationships:function(n,r,i,s,o,u){var a=e.data.getRelatedModule(r,i.link);return e.offline.isOfflineEnabled(r)&&e.offline.isOfflineEnabled(a)?(s.relate=!0,i.relatedModule=a,t._executeOfflineApi(n,r,i,s,o,t.originalMethods.relationships,u)):t.originalMethods.relationships.call(e.api,n,r,i,e.offline.utils.getCleanedParams(s),o,u)},favorite:function(n,r,i,s,o){return o=o||{},e.offline.isOfflineEnabled(n)?t._executeOfflineApi("favorite",n,{id:r,my_favorite:i},o,s,t.originalMethods.favorite):t.originalMethods.favorite.apply(e.api,arguments)},follow:function(n,r,i,s,o){return o=o||{},e.offline.isOfflineEnabled(n)?t._executeOfflineApi("follow",n,{id:r,following:i},o,s,t.originalMethods.follow):t.originalMethods.follow.apply(e.api,arguments)},search:function(e,n,r){return t._executeOfflineApi("search",null,null,e,n,null,r)},file:function(n,r,i,s,o){var u=s.success,a=r.module;return _.contains(["create","delete"],n)&&(s.success=function(t,n,i){var s={id:r.id};s[r.field]=_.isEmpty(t.record)?"":t.record[r.field],e.offline.storage.saveRecords({serverData:s,module:a,ignoreRecordDirtiness:!0,callback:_.bind(u,e.api,t,n,i)})}),t.originalMethods.file.apply(e.api,arguments)},callOriginalApi:function(n,r){var i,s,o,u,a={search:1,ping:1,follow:3,favorite:3,file:3,records:4,relationships:4};_.isString(n)?n==="read"?(i=e.api.call,s=r[3]):(i=t.originalMethods[n]||e.api[n],s=r[a[n]]):(i=n,_.find(t.originalMethods,function(e,t){if(e===n)return s=r[a[t]],!0})),u=_.last(r)||{};var f=s.error,l=function(){e.logger.debug("Original API callback suppressed. Offline layer is not initialized")},c=u.catchServerRequest||function(){};if(!e.offline.isUp())return f?f.call(this,e.offline.Error.OfflineDisabledError):l();_.each(s,function(t,n){_.isFunction(t)&&(s[n]=function(){c(null);if(!e.offline.isUp())return f?f.call(this,e.offline.Error.OfflineDisabledError):l();t.apply(this,arguments)})}),o=i.apply(e.api,r),c(o)},_executeOfflineApi:function(t,n,r,i,s,o,u){function l(){return a}u=u||{};var a,f={method:t,module:n,data:r,params:i,callbacks:s,originalApi:o,options:u};u.catchServerRequest=function(e){a=e};switch(t){case"search":this.readMixedCollection(f);break;case"read":e.config.offline.httpThrottlingEnabled&&e.offline.api.handleServerSyncSkip(t,n,r,f.params);var c=r&&r.link?r.relatedId:r?r.id:null,h=c?this.readSingle:this.readCollection;h.call(this,f);break;default:this.createUpdateDelete(f)}return l}},t=e.offline.api}(SUGAR.App),function(e){var t={readSingle:function(n){function c(){f.error&&f.error({status:404})}function h(){e.offline.storage.sync("read",u,o,_.extend({},a,{ts:e.utils.getTimestamp(),success:function(t){var n=!a.skipServerSync&&e.offline.isOnline();t?(f.success&&(f.success(t),i=!0),n=n&&e.offline.utils.isDataSynchronized(t)):n||c(),n?p(t):d()},error:function(e){f.error&&f.error(e),v(e)},complete:f.complete}))}function p(t){var n=a.relate?"relationships":"records";e.offline.api.callOriginalApi(n,[s,o,u,e.offline.utils.getCleanedParams(a),{success:function(n){e.offline.api.cacheRequest(s,o,u,a),e.offline.storage.saveRecords({serverData:n,module:o,relationshipData:a.relate?u:null,callback:function(s){s?v(s):(!i&&f.success&&f.success(n),r["offline:data:updated"]={isCollection:!1,action:t?"update":"create",id:u.id,date_modified:e.utils.getTimestamp(n.date_modified)},d())}})},error:function(t){f.error&&f.error(t);if(t===e.offline.Error.OfflineDisabledError)return;var n=a.relate?u.relatedModule:o,i=a.relate?u.relatedId:u.id;switch(t.status){case 412:return;case 403:case 404:r["offline:data:updated"]={isCollection:!1,action:"delete",status:t.status,module:n,data:u,id:u.id}}var s=a.relate?{module:o,data:u,relate:a.relate}:{module:n,id:i,relate:a.relate};e.offline.storage.resolveError({nonTransactionResolve:s,error:t,callback:function(e){e?v(e):d()}})}},l])}function d(){e.logger.debug("readSyncSingle success"),_.each(r,function(t,n){e.trigger(n,t)})}function v(t){e.logger.error("readSyncSingle failed. "+t)}var r={"offline:api:read:success":{}},i=!1,s=n.method,o=n.module,u=n.data,a=n.params,f=n.callbacks,l=n.options;e.offline.utils.callOnce(f),h()}};_.extend(e.offline.api,{readSingle:_.bind(t.readSingle,t),_readSingleScope:t})}(SUGAR.App),function(e){var t={readCollection:function(n){var r=n.method,i=n.module,s=n.data,o=n.params,u=n.callbacks,a=n.options,f=[];e.offline.utils.callOnce(u);if(i==="Recents")return e.offline.utils.callOnce(u),this._readRecentsCollection(r,i,s,o,u,a);o.skipOfflineRead||f.push(_.bind(function(t){this._offlineRead(t,r,i,s,o,u,a)},this));if(e.offline.isOnline())o.skipServerSync||f.push(_.bind(function(e){this._serverRead(e,r,i,s,o,u,a)},this));else if(u.error){var l=_.extend({},e.offline.api.NO_CONNECTION_ERROR,{request:{params:a}});u.error(l)}async.waterfall(f,_.bind(function(t,n){this._onReadCollectionComplete(t,n,o,u)},this))},_offlineRead:function(t,n,r,i,s,o,u){e.offline.storage.sync("read",i,r,_.extend({},s,{ts:e.utils.getTimestamp(),success:function(n){n=n||[],n=_.isArray(n)?n:[n];var r=s.max_num>n.length||s.serverOffset===-1?-1:(s.offset||0)+n.length,i={records:n,next_offset:r};o.success&&o.success(i),t()},error:function(e){o.error&&o.error(e),t(e)},complete:o.complete}))},_serverRead:function(t,n,r,i,s,o,u){var a=s.relate?"relationships":"records",f=e.offline.api.SERVER_READ_STATUS,l=!1,c=!1;e.trigger("offline:server:read",{status:f.start,apiOptions:u}),e.offline.api.callOriginalApi(a,[n,r,i,e.offline.utils.getCleanedParams(s),{success:function(a){e.offline.api.cacheRequest(n,r,i,s),o.success&&o.success(a),a=a||{},s.serverSyncSuccess&&a.records&&s.serverSyncSuccess({records:a.records,next_offset:a.next_offset},s),_.isEmpty(a.records)?t(null,a):(l=!0,e.offline.storage.saveRecords({module:r,serverData:a.records,relationshipData:s.relate?i:null,callback:function(n){t(n,a),!n&&!s.skipOfflineRead&&e.trigger("offline:data:updated",{isCollection:!0,action:"update",module:r,relationsData:i,serverOffset:a.next_offset,requestParams:s,cid:u.cid})}}))},error:function(e){c=!0,o.error&&o.error(e),t(e)},complete:function(){e.trigger("offline:server:read",{status:c?f.error:f.finish,apiOptions:u,dataUpdated:l}),o.complete&&o.complete(arguments)}},u])},_onReadCollectionComplete:function(t,n,r,i){t?(i.error&&i.error(t),t instanceof e.offline.Error&&t!==e.offline.Error.OfflineDisabledError&&e.logger.error("readSyncCollection failed. "+t)):(e.logger.debug("readSyncCollection success"),e.trigger("offline:api:read:success"))},_readRecentsCollection:function(n,r,i,s,o,u){var a=this;async.waterfall([function(n){var r=e.offline.utils.getOfflineModules(),i=s.module_list?s.module_list.split(","):r,u=_.chain(r).without("Teams").intersection(i).value(),a=_.map(u,function(t){return{op:"readRecents",module:t,options:{max_num:e.config.fetchLimit.recents}}}),f=function(e,t){o.complete(e||t),n(e,t)};e.offline.storage.exec(a,function(e){e?_.isArray(e)||(e=[e]):e=[],e=_.sortBy(e,function(e){return-(new Date(e._last_viewed_date))}),o.success({records:e,next_offset:-1}),f(null,e)},f)},function(i,o){if(!e.offline.isOnline()||s.skipServerSync){o();return}var a=e.offline.api.SERVER_READ_STATUS,f=!1,l=!1;s=e.offline.utils.getCleanedParams(s),s.module_list=_.intersection(s.module_list.split(","),e.offline.utils.getOfflineModules()).join(","),e.trigger("offline:server:read",{status:a.start,apiOptions:u}),e.offline.api.callOriginalApi("records",[n,r,null,s,{success:function(t){if(!_.isEmpty(t.records)){var n=t.records,r=[];f=!0,r.push(function(n){e.offline.storage.saveRecords({serverData:t.records,callback:n})}),r.push(function(r){e.offline.storage.exec([{op:"readLastViewed",options:{ids:_.pluck(t.records,"id")}}],function(e){e&&(_.isArray(e)||(e=[e]),n=_.reject(n,function(n){var r=_.findWhere(e,{bean_id:n.id});return r&&new Date(r.date_last_viewed)-0>new Date(n._last_viewed_date)-0})),r()},r)}),async.series(r,function(r,i){r||e.offline.storage.exec(_.map(n,function(t){return{op:"updateLastViewed",data:t,module:t._module,options:{ts:e.utils.getTimestamp(t._last_viewed_date)}}}),function(){e.trigger("offline:data:updated",{isCollection:!0,action:"update",module:"Recents",cid:u.cid}),o()},o),o(r)})}else o()},error:function(e){l=!0,o(e)},complete:function(){e.trigger("offline:server:read",{status:l?a.error:a.finish,apiOptions:u,dataUpdated:f})}},u])}],function(e,t){a._onReadCollectionComplete(e,t,s,o)})}};_.extend(e.offline.api,{readCollection:_.bind(t.readCollection,t),_readCollectionScope:t})}(SUGAR.App),function(e){var t={readMixedCollection:function(n){var r=n.method,i=n.data,s=n.params,o=n.callbacks,u=n.options,a=[];e.offline.utils.callOnce(o),s.skipOfflineRead||a.push(_.bind(function(t){this._offlineRead(t,r,i,s,o,u)},this));if(e.offline.isOnline())s.skipServerSync||a.push(_.bind(function(t){this._serverRead(t,r,i,s,o,u)},this));else if(o.error){var f=_.extend({},e.offline.api.NO_CONNECTION_ERROR,{request:{params:u}});o.error(f)}async.waterfall(a,this._onReadCollectionComplete)},_offlineRead:function(n,r,i,s,o,u){e.offline.storage.sync("search",null,null,_.extend({},s,{ts:e.utils.getTimestamp(),success:function(r){var i=s.module_list&&s.module_list.split(",").length>1,u,a,f,l={};r=r||[],r=_.isArray(r)?r:[r],e.offline.utils.checkIsEmptyQuery(s.q)||(a=e.offline.utils.compileSearchRegExp(s.q),f=e.offline.utils.compileHighlightRegExp(s.q),_.each(s.module_list.split(","),function(t){l[t]=e.metadata.getModule(t).fields}),_.each(r,function(t){u=t._module||t.module,t._search={isOffline:!0},_.each(e.offline.storage.offlineMeta[u].searchFields,function(e){var n=e.name,r=t[n];(_.isString(r)||_.isNumber(r))&&a.test(r)&&(t._search.highlighted=t._search.highlighted||{},t._search.highlighted[n]={module:u,text:r.toString().replace(f,"<strong>$1</strong>"),label:l[u][n].vname})})})),i&&(r=_.sortBy(r,function(e){return e._client_date_modified}).reverse());if(i){var c=s.max_num||e.config.maxQueryResult;r=r.splice(s.offset||0,c)}var h=s.max_num>r.length?-1:(s.offset||0)+r.length,p={records:r,next_offset:h};o.success&&o.success(p),n()},error:function(e){o.error&&o.error(e),n(e)},complete:o.complete}))},_serverRead:function(t,n,r,i,s,o){var u=!1,a=!1,f=e.offline.api.SERVER_READ_STATUS;e.trigger("offline:server:read",{status:f.start,apiOptions:o}),e.offline.api.callOriginalApi(n,[e.offline.utils.getCleanedParams(i),{success:function(n){s.success&&s.success(n),n=n||{},i.serverSyncSuccess&&n.records&&i.serverSyncSuccess({records:n.records,next_offset:n.next_offset},i),_.isEmpty(n.records)?t():(u=!0,e.offline.storage.saveRecords({serverData:n.records,callback:function(n){t(n),!n&&!i.skipOfflineRead&&e.trigger("offline:data:updated",{isCollection:!0,action:"update",mixedCollection:!0,requestParams:i,cid:o.cid})}}))},error:function(e){a=!0,s.error&&s.error(e),t(e)},complete:function(){e.trigger("offline:server:read",{status:a?f.error:f.finish,apiOptions:o,dataUpdated:u}),s.complete&&s.complete(arguments)}},o])},_onReadCollectionComplete:function(t){t?t instanceof e.offline.Error&&t!==e.offline.Error.OfflineDisabledError&&e.logger.error("readSyncMixedCollection failed. "+t):e.logger.debug("Read mixed collection success")}};_.extend(e.offline.api,{readMixedCollection:_.bind(t.readMixedCollection,t),_readMixedCollectionScope:t})}(SUGAR.App),function(e){var t={createUpdateDelete:function(n){var r=this,i=n.method,s=n.module,o=n.data,u=n.params||{},a=n.callbacks,f=n.originalApi,l=n.options;!u.deferSync&&e.offline.isOnline()?async.waterfall([function(n){e.offline.storage.readTransactions({limit:1,success:function(e){n(null,e)},error:n})}],function(n,c){n&&a.error?(e.logger.error("createUpdateDeleteSync failed"+n),a.error(n)):c?r._offlineSync(i,s,o,u,a):r._serverSync(i,s,o,u,a,f,l)}):r._offlineSync(i,s,o,u,a)},_isInitialStateRequired:function(t,n,r,i){return t==="update"||t==="favorite"||t==="follow"||(t==="create"||t==="delete")&&r.link},_offlineSync:function(n,r,i,s,o){var u=this;async.series([function(o){if(u._isInitialStateRequired(n,r,i,s)){var a=s.relate?i.relatedModule:r,f=s.relate?i.relatedId:i.id;e.offline.storage.readSingleRawRecord(a,{id:f},{success:function(e){s.initialState=e,o()},error:o})}else o()}],function(t){if(t){var u="Failed to read initial record during offline sync. Module: {0}, data: {1}";u=e.utils.formatString(u,[r,JSON.stringify(i||{})]),e.logger.error(u),o.error&&o.error(t);return}e.offline.storage.sync(n,i,r,_.extend({},{ts:e.utils.getTimestamp(),success:function(t){e.trigger("offline:data:sync:success",t),o.success&&o.success(t),e.logger.trace("Successfully executed: "+n)},error:function(e){o.error&&o.error(e)},complete:o.complete},s))})},_serverSync:function(n,r,i,s,o,u,a){var f=this,l=function(t){var u,a=e.acl.hasAccessToModel("access",e.data.createBean(r,t));if(n==="delete"||!a)u=[function(t){e.offline.storage.sync("delete",i,r,_.extend(s,{hardDelete:!0,success:function(){t()},error:t}))}],s.relate&&(u.push(function(n){e.offline.storage.saveRecords({serverData:t.record,module:r,callback:n})}),u.push(function(n){e.offline.storage.saveRecords({serverData:t.related_record,module:i.relatedModule,callback:n})})),async.series(u,function(r){r?(e.logger.error(r),o.error(r)):o.success(t)});else{var f=n!=="follow"?t:{id:i.id,following:i.following};_.isObject(f)?(u=[function(t){e.offline.storage.saveRecords({serverData:s.relate?f.record:f,module:r,callback:t})}],s.relate&&u.push(function(t){e.offline.storage.saveRecords({serverData:f.related_record,module:r,relationshipData:i,callback:t})}),(n==="create"&&!s.relate||n==="create"&&s.relate&&!i.relatedId)&&u.push(function(t){e.offline.storage.updateLastViewed(s.relate?f.related_record:f,{module:s.relate?i.relatedModule:r,callback:t})}),n!=="delete"&&u.push(function(t){e.offline.storage.markToBeSynced({module:s.relate?i.relatedModule:r,callback:t,action:"update",record:s.relate?f.related_record:f})}),async.series(u,function(r){r?(e.logger.error(r),o.error(r)):(o.success(t),e.trigger("offline:data:updated",{isCollection:!1,action:"update"}))})):o.success(t)}},c=function(t){t&&e.utils.isConnectivityError(t)?f._offlineSync(n,r,i,s,o):o.error&&o.error(t)};if(n==="favorite"||n==="follow")e.offline.api.callOriginalApi(u,[r,i.id,n==="favorite"?i.my_favorite:i.following,{success:l,error:c,complete:o.complete}]);else{if(n==="create"&&!i.relatedId){var h=i.link?i.related:i;h.id=e.utils.generateUUID()}e.offline.api.callOriginalApi(u,[n,r,i,e.offline.utils.getCleanedParams(s),{success:l,error:c,complete:o.complete},a])}}};_.extend(e.offline.api,{createUpdateDelete:_.bind(t.createUpdateDelete,t),_createUpdateDeleteScope:t})}(SUGAR.App),function(e){var t={_rStack:[],_rTs:{},_getPseudoUrl:function(e,t,n,r){var i=r.relate?n:n?{id:n.id}:null,s=JSON.stringify({module:t,data:i,params:_.pick(r,"max_num","offset","relate","favorites","my_items")});return s},handleServerSyncSkip:function(e,t,n,r){if(r.skipServerSync||r.forceServerSync||r.skipOfflineRead)return;var i=this._getPseudoUrl(e,t,n,r);this._shouldSuppressRemoteSync(i)&&(r.skipServerSync=!0)},_shouldSuppressRemoteSync:function(t){return _.contains(this._rStack,t)&&(new Date).getTime()-this._rTs[t]<e.config.offline.httpThrottleTimeout},cacheRequest:function(t,n,r,i){var s=this._getPseudoUrl(t,n,r,i),o=this._rStack,u=this._rTs,a=e.config.offline.httpThrottleCacheSize,f=o.indexOf(s);return f>-1&&o.splice(f,1),o.splice(0,0,s),u[s]=(new Date).getTime(),o.length>a&&delete u[o.pop()],{rStack:o,rTs:u}}};_.extend(e.offline.api,{handleServerSyncSkip:_.bind(t.handleServerSyncSkip,t),cacheRequest:_.bind(t.cacheRequest,t),_httpThrottlingScope:t})}(SUGAR.App),function(e){function n(e){return e.replace(/'/g,"''")}function i(e){var t;switch(e){case"bool":case"boolean":case"int":case"integer":t=" INTEGER";break;case"float":case"double":case"currency":t=" REAL";break;default:t=" TEXT COLLATE NOCASE"}return t}var t={favorites:function(){return"my_favorite = 1"},following:function(){return"following = 1"},my_items:function(){return e.metadata.getModule(this.name,"fields").assigned_user_id?"assigned_user_id = '"+e.user.get("id")+"'":""}},r=function(e,t,n){this.name=e,this.definition=t,this._tableName=e,this.fields=n;var r=_.map(this.fields,function(e){return'"'+e.name+'"'});r.unshift('"_acl"'),r.unshift('"_deleted"'),r.unshift('"_client_date_modified"'),r.unshift('"id"');var i=_.map(r,function(e){return e+"=?"}),s="("+r.join(",")+")",o="SET "+i.join(","),u=[];_.times(r.length,function(){u.push("?")});var a="("+u.join(",")+")";this.sqlCreate='INSERT INTO "'+this._tableName+'" '+s+" VALUES "+a,this.sqlReplace='REPLACE INTO "'+this._tableName+'" '+s+" VALUES "+a,this.sqlUpdate='UPDATE "'+this._tableName+'" '+o+" WHERE id=?",this.sqlMarkDeleted="UPDATE "+this._tableName+" SET _deleted=1 WHERE id=?",this.sqlResetDeleted="UPDATE "+this._tableName+" SET _deleted=0 WHERE id=?",this.sqlDelete='DELETE FROM "'+this._tableName+'" WHERE id=?',this.sqlSelectOne="SELECT * FROM "+this._tableName+" WHERE id=? AND _deleted!=1",this.sqlSelectOneWithDeleted="SELECT * FROM "+this._tableName+" WHERE id=?"};_.extend(r.prototype,{buildSqlReadModuleRecordsByIds:function(e){var t=" WHERE ";return _.isArray(e)?t+='"id" IN ("'+e.join('","')+'")':t+='"id" = "'+e+'"',"SELECT * FROM "+this._tableName+t},getSchema:function(t,n){function u(e,t){return'"'+e+'"'+t}var r=[],s=[],o=[];return s.push('"id" TEXT PRIMARY KEY COLLATE NOCASE'),s.push('"_client_date_modified" TEXT COLLATE NOCASE'),s.push('"_deleted" INTEGER'),s.push('"_acl" TEXT COLLATE NOCASE'),_.each(this.fields,function(t){if(_.isEmpty(t.name))return;var r=i(t.type),a=u(t.name,r);_.contains(s,a)?e.logger.warn(a+" column already exists in "+this.name+" table. Skipping"):(s.push(a),t.type==="email"&&!n.fields.email1&&s.push(u("email1",r)));if(t.unified_search===!0){var f=this.name+"_"+t.name+"_IDX";o.push("DROP INDEX IF EXISTS "+f),o.push("CREATE INDEX "+f+' ON "'+this._tableName+'" ("'+t.name+'" COLLATE NOCASE)')}},this),r.push('DROP TABLE IF EXISTS "'+this._tableName+'"'),r.push('CREATE TABLE "'+this._tableName+'" ('+s.join(",")+")"),_.each(o,function(e){r.push(e)}),r},buildSqlSelectMany:function(t){var r=t.offset||0,i=t.max_num||e.config.maxQueryResult,s=t.selectFields,o="*",u="SELECT {1} FROM {0} WHERE _deleted!=1",a="",f=(t.order_by||"_client_date_modified:DESC").replace(":"," ");if(t.q){t.q=t.q.trim(),t.q=n(t.q);var l=t.q.indexOf("?")!==-1||t.q.indexOf("*")!==-1,c=0;a=" AND ( ",_.each(e.offline.storage.offlineMeta[this.name].searchFields,function(e){a+=(c===0?"":" OR ")+e.name+(l?" GLOB '":" LIKE '")+t.q+(l?"*":"%")+"'",c++}),a+=")"}return _.isEmpty(s)||(_.isArray(s)||(s=[s]),o=s.join(", ")),u+=(this.name==="Meetings"&&!t.q?" AND date_start >= '"+e.utils.getTimestamp(new Date(new Date-9e5))+"'":"")+this.buildSqlFilter(t)+a+" ORDER BY {4} LIMIT {2},{3}",e.utils.formatString(u,[this._tableName,o,r,i,f])},buildSqlFilter:function(e){var n=e.filterCondition?e.filterCondition.toUpperCase():"AND",r="",i=this,s=_.chain(e).map(function(e,n){return t[n]&&e==1&&t[n].call(i)}).compact().value();return _.isEmpty(s)||(r+=" AND ",s.length>1?r+="( "+s.join(" "+n+" ")+" )":r+=s[0]),r},buildSqlUpdate:function(e,t){var n=_.map(t,function(e){return e+"=?"}),r="SET "+n.join(",");return'UPDATE "'+this._tableName+'" '+r+" WHERE id=?"}}),r.relationships={fieldsBlacklist:{},mtmRelsColumns:{},getCreateSchemaStatements:function(t){var n=[];return _.each(t.relationships,function(t){if(e.offline.storage.getRelationshipType(t)===e.offline.storage.relTypes.MANY_TO_MANY){n.push(e.utils.formatString('DROP TABLE IF EXISTS "{0}"',[t.join_table]));var r="",i=this.mtmRelsColumns[t.name];if(!_.isEmpty(i)){var s=[];_.each(i,function(t,n){s.push(e.utils.formatString('"{0}" TEXT COLLATE NOCASE',[n]))},this),r=s.join(",")}t.primary_flag_column&&(r+='"primary_flag" INTEGER DEFAULT 0');var o='CREATE TABLE "{0}" ("{1}" TEXT COLLATE NOCASE, "{2}" TEXT COLLATE NOCASE, "_client_date_modified" TEXT COLLATE NOCASE, "_deleted" INTEGER,{3} PRIMARY KEY ("{1}","{2}"))';o=o.replace(/\{0\}/g,t.join_table),o=o.replace(/\{1\}/g,t.join_key_lhs),o=o.replace(/\{2\}/g,t.join_key_rhs),o=o.replace(/\{3\}/g,r?r+",":""),n.push(o)}},this),n},_getRelColumnsAliasSql:function(t){var n="";if(!_.isEmpty(t.additionalColumns)){n+=",";var r=[];_.each(t.additionalColumns,function(t,n){r.push(e.utils.formatString("r.{0} AS {1}",[n,t]))},this),n+=r.join(",")}return n},buildSqlSelectSingleRelated:function(t,n){var r=e.offline.storage.getRelationshipByLink(t,n.link),i=e.offline.storage.getRelationshipType(r);if(i===e.offline.storage.relTypes.MANY_TO_MANY){var s=e.offline.storage._wrapManyToManyRelationship(t,n.link),o=this._getRelColumnsAliasSql(s),u=e.utils.formatString('SELECT d.*,r.*{0} FROM {1} AS d JOIN {2} AS r ON (d.id=r.{3} AND r.{5}="{6}") WHERE (d._deleted!=1 AND r._deleted!=1 AND d.id="{4}")',[o,n.relatedModule,s.relationshipTable,s.childIdColumn,n.relatedId,s.parentIdColumn,n.id]);if(s.singleModule){var a=e.utils.formatString('SELECT d.*,r.*{0} FROM {1} AS d JOIN {2} AS r ON (d.id=r.{3} AND r.{5}="{6}") WHERE (d._deleted!=1 AND d.id="{4}")',[o,n.relatedModule,s.relationshipTable,s.parentIdColumn,n.relatedId,s.childIdColumn,n.id]);u=u+" UNION "+a}return u}return e.utils.formatString('SELECT * FROM {0} WHERE id="{1}" AND _deleted!=1',[n.relatedModule,n.relatedId])},buildSqlSelectManyRelated:function(t,n,r){var i='SELECT * FROM {0} WHERE {1}="{2}" AND _deleted!=1',s=e.offline.storage.getRelationshipByLink(t,n.link),o=e.offline.storage.getRelationshipType(s),u,a=r.offset||0,f=r.max_num||e.config.maxQueryResult,l="",c=(r.order_by||"_client_date_modified:DESC").replace(":"," "),h,p;if(o===e.offline.storage.relTypes.MANY_TO_MANY){u=e.offline.storage._wrapManyToManyRelationship(t,n.link),h=this._getRelColumnsAliasSql(u),p='SELECT d.*,r.*{6} FROM {0} AS r JOIN {1} AS d ON r.{2}=d.id WHERE (r._deleted!=1 AND d._deleted!=1 AND r.{4}="{5}") ',l=e.utils.formatString(p,[u.relationshipTable,u.dataTable,u.childIdColumn,u.childIdColumn,u.parentIdColumn,n.id,h]);if(u.singleModule){var d=e.utils.formatString(p,[u.relationshipTable,u.dataTable,u.parentIdColumn,u.childIdColumn,u.childIdColumn,n.id,h]);l=l+" UNION "+d}c=(r.order_by||"d._client_date_modified:DESC, d._last_fetched:ASC").replace(/:/g," ")}else if(o===e.offline.storage.relTypes.ONE_TO_MANY||o===e.offline.storage.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN)u=e.offline.storage._wrapOneToManyRelationship(t,n.link),l=e.utils.formatString(i,[u.tableName,u.parentIdColumn,n.id]);return l+=" ORDER BY {2} LIMIT {0},{1}",e.utils.formatString(l,[a,f,c])},buildSqlReplaceRelationship:function(t,n,r){r=r||{};var i=n.relDef||e.offline.storage.getRelationshipByLink(t,n.link),s=e.offline.storage.getRelationshipType(i),o;if(s===e.offline.storage.relTypes.ONE_TO_MANY||s===e.offline.storage.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN){if(!n.id||r.skipUpdateRelRecord)return;o=e.offline.storage._wrapOneToManyRelationship(t,i);var u=r.ts?e.utils.formatString(', _client_date_modified="{0}"',[r.ts]):"",a=o.parentNameFieldDef;return a&&n.related&&_.isEmpty(n.related[a.name])&&(u+=e.utils.formatString(', {0}=(SELECT {1} FROM {2} WHERE id="{3}")',[a.name,"name",t,n.id]),_.isEmpty(n.related.parent_type)&&s===e.offline.storage.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN&&(u+=e.utils.formatString(', parent_type="{0}"',[t]))),e.utils.formatString('UPDATE {0} SET {1}="{2}"{3} WHERE id="{4}"',[o.tableName,o.parentIdColumn,n.id,u,n.relatedId])}var f='REPLACE INTO "{0}" ({1}) VALUES ({2})',l=[],c;o=e.offline.storage._wrapManyToManyRelationship(t,i),c=[o.parentIdColumn,o.childIdColumn,"_client_date_modified","_deleted"],!n.id&&o&&(n.id=n.related[o.parentIdColumn]);if(!n.id)return;var h=[n.id,n.relatedId,r.ts||e.utils.getTimestamp(),0];_.each(o.additionalColumns,function(e,t){n.related&&!_.isEmpty(n.related[e])&&(c.push(t),h.push(n.related[e]))}),o.primaryFlagModule&&n.id&&(c.push("primary_flag"),h.push(1),l.push({sql:e.utils.formatString('UPDATE "{0}" SET "{3}"={4} WHERE {1}="{2}"',[o.relationshipTable,o.childIdColumn,n.relatedId,"primary_flag","0"])})),c='"'+c.join('","')+'"',h='"'+h.join('","')+'"',i.relationship_type===e.offline.storage.relTypes.ONE_TO_MANY?l.push({sql:e.utils.formatString('DELETE FROM "{0}" WHERE {1}="{2}"',[o.relationshipTable,o.childIdColumn,n.relatedId])}):i.relationship_type===e.offline.storage.relTypes.ONE_TO_ONE&&l.push({sql:e.utils.formatString('DELETE FROM "{0}" WHERE {1}="{2}"',[o.relationshipTable,o.parentIdColumn,n.id])}),l.push({sql:e.utils.formatString(f,[o.relationshipTable,c,h])});if(e.offline.storage._shouldCustomRelUpdateChild(i,r)){var p=o.primaryFlagModule?e.metadata.getModule(o.primaryFlagModule):null,d=p?e.data.getRelateFields(o.primaryFlagModule,o.link)[0]:e.data.getRelateFields(o.parentModule,i.name)[0];d&&[].push.apply(l,this.buildCustomRelUpdateChild(d,o,i,n,!1,r))}return l},buildDeleteRelationship:function(t,n,r){r=r||{};var i=n.relDef||e.offline.storage.getRelationshipByLink(t,n.link),s=e.offline.storage.getRelationshipType(i),o,u;if(s===e.offline.storage.relTypes.ONE_TO_MANY||s===e.offline.storage.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN){if(r.skipUpdateRelRecord)return;var a=r.ts?',_client_date_modified="'+r.ts+'"':"";u=e.offline.storage._wrapOneToManyRelationship(t,i);if(s===e.offline.storage.relTypes.ONE_TO_MANY){var f=u.parentNameFieldDef;f?o="UPDATE {0} SET {1}=NULL, "+f.name+'=NULL {3} WHERE id="{2}"':o='UPDATE {0} SET {1}=NULL {3} WHERE id="{2}"'}else o='UPDATE {0} SET parent_type=NULL, parent_name=NULL, {1}=NULL {3} WHERE id="{2}"';return e.utils.formatString(o,[u.tableName,u.parentIdColumn,n.relatedId,a])}var l=[];u=e.offline.storage._wrapManyToManyRelationship(t,i),!n.id&&u&&(n.id=n.related[u.parentIdColumn]||r.initialState&&r.initialState[u.parentIdColumn]);if(!n.id)return;if(u.singleModule){var c;return r.hardDelete?(o='DELETE FROM {0} WHERE (({1}="{2}" AND {3}="{4}") OR ({3}="{2}" AND {1}="{4}"))',c=o.replace(/\{0\}/g,u.relationshipTable).replace(/\{1\}/g,u.parentIdColumn).replace(/\{2\}/g,n.id).replace(/\{3\}/g,u.childIdColumn).replace(/\{4\}/g,n.relatedId)):(o='UPDATE {0} SET _deleted=1,_client_date_modified="{5}" WHERE (({1}="{2}" AND {3}="{4}") OR ({3}="{2}" AND {1}="{4}"))',c=o.replace(/\{0\}/g,u.relationshipTable).replace(/\{1\}/g,u.parentIdColumn).replace(/\{2\}/g,n.id).replace(/\{3\}/g,u.childIdColumn).replace(/\{4\}/g,n.relatedId).replace(/\{5\}/g,r.ts||e.utils.getTimestamp())),c}var h=u.primaryFlagModule?", primary_flag=0":"";o=r.hardDelete?'DELETE FROM {0} WHERE {1}="{2}" AND {3}="{4}"':"UPDATE {0} SET _deleted=1"+h+',_client_date_modified="{5}" WHERE {1}="{2}" AND {3}="{4}"',l.push({sql:e.utils.formatString(o,[u.relationshipTable,u.parentIdColumn,n.id,u.childIdColumn,n.relatedId,r.ts||e.utils.getTimestamp()])}),u.primaryFlagModule&&l.push({sql:'UPDATE {0} SET primary_flag=1 WHERE {1}="{2}" AND _client_date_modified=(SELECT MAX(_client_date_modified) FROM {0} WHERE {1}="{2}" AND _deleted<>1)'.replace(/\{0\}/g,u.relationshipTable).replace(/\{1\}/g,u.childIdColumn).replace(/\{2\}/g,n.relatedId)});if(e.offline.storage._shouldCustomRelUpdateChild(i,r)){var p=u.primaryFlagModule?e.data.getRelateFields(u.primaryFlagModule,u.link)[0]:e.data.getRelateFields(u.parentModule,i.name)[0];p&&[].push.apply(l,this.buildCustomRelUpdateChild(p,u,i,n,!0,r))}return l},buildCustomRelUpdateChild:function(t,n,r,i,s,o){var u=r.relationship_type===e.offline.storage.relTypes.ONE_TO_ONE,a,f,l,c,h,p,d,v,m=[];u?(a=n.parentIdColumn,f=n.childIdColumn,l=n.parentModule,c=n.dataTable,h=s?"":i.relatedId,p=i.id):(a=n.childIdColumn,f=i.relatedModule?n.parentIdColumn:n.childIdColumn,l=n.dataTable,c=n.parentModule,h=s?"":i.id,p=i.relatedId),d=s?"''":e.utils.formatString("(SELECT name FROM {0} WHERE id='{1}')",[c,h]),v="UPDATE {0} SET {1}={2}, {3}='{4}' WHERE id='{5}'";if(u&&!s){var g="(SELECT {0} FROM {1} WHERE id='{2}')",y="UPDATE {0} SET {1}={2}, {3}='{4}' WHERE id={5}",b=e.utils.formatString(g,[f,l,p]),w=e.utils.formatString(g,[a,c,h]),E=e.utils.formatString(g,["name",c,h]);m.push({sql:e.utils.formatString(y,[c,t.name,"''",a,"",b])}),m.push({sql:e.utils.formatString(y,[l,t.name,"''",f,"",w])}),m.push({sql:e.utils.formatString(v,[l,t.name,E,f,h,p])})}else if(n.primaryFlagModule){h=e.utils.formatString('(SELECT {0} FROM {1} WHERE {2}="{3}" AND primary_flag=1 AND _deleted<>1)',[f,n.relationshipTable,n.childIdColumn,i.relatedId]),d=e.utils.formatString("(SELECT name FROM {0} WHERE id={1})",[t.module,h]);var S="UPDATE {0} SET {1}={2} WHERE id='{3}'",x="UPDATE {0} SET {1}={2} WHERE id='{3}' AND {4}",T=e.utils.formatString("EXISTS (SELECT id FROM {0} WHERE id={1})",[c,h]);m.push({sql:e.utils.formatString(x,[l,t.name,d,p,T])}),m.push({sql:e.utils.formatString(S,[l,f,h,p])})}else m.push({sql:e.utils.formatString(v,[l,t.name,d,f,h,p])});return m},buildSqlUpdateChildren:function(t,r){var i=[],s=e.offline.storage._getModuleRelationships(t),o=_.filter(s,function(n){return e.offline.storage.getRelationshipType(n)!==e.offline.storage.relTypes.MANY_TO_MANY&&e.offline.storage._getParentModule(n)===t},this);return _.each(o,function(s){var o=e.offline.storage._wrapOneToManyRelationship(t,s);o.parentNameFieldDef&&i.push(e.utils.formatString("UPDATE {0} SET {1}='{2}' WHERE {3}='{4}'",[o.childModule,o.parentNameFieldDef.name,n(r.name),o.parentIdColumn,r.id]))},this),i.length>0?i:null},buildSqlCleanRelationships:function(t,n,r){r=r||{};var i,s={},o=[],u,a;return i=e.offline.storage._getModuleRelationships(t),_.each(i,function(i){if(e.offline.storage.getRelationshipType(i)!==e.offline.storage.relTypes.MANY_TO_MANY){if(r.skipOneToManyChildren)return;var f=e.offline.storage._getParentModule(i);if(f===t){var l=e.offline.storage._wrapOneToManyRelationship(f,i),c=l.childModule;u=l.parentIdColumn,a=e.metadata.getModule(c),a.fields[u]&&(s[c]=s[c]||{},s[c][u]="parent_id")}}else{var h=e.offline.storage._wrapManyToManyRelationship(t,i),p=h.relationshipTable;u=h.parentIdColumn,o.push(e.utils.formatString('DELETE FROM {0} WHERE {1}="{2}"',[p,u,n.id]))}},this),_.each(s,function(t,n){var r=e.metadata.getModule(n).fields,i;_.each(t,function(r,i){var s=e.data.getRelatedNameField(n,i);s&&(t[s.name]="parent_name")}),i=_.keys(t),_.contains(i,"parent_id")&&_.contains(i,"parent_name")&&r.parent_type&&(t.parent_type="parent_type")}),_.each(s,function(t,r){var i=[],s=[],u="UPDATE {0} SET {1} WHERE {2}";_.each(t,function(e,t){i.push(t+"=NULL"),e==="parent_id"&&s.push(t+'="'+n.id+'"')}),i=i.join(","),s=s.join(" OR "),o.push(e.utils.formatString(u,[r,i,s]))}),o}},r.init=function(e){this.relationships.fieldsBlacklist=e.fieldsBlacklist,this.relationships.mtmRelsColumns=e.mtmRelsColumns},r.getDropTableStatement=function(e){return"DROP TABLE "+e},r.getSelectTablesStatement=function(){return"SELECT tbl_name FROM sqlite_master WHERE type='table' AND tbl_name!='__WebKitDatabaseInfoTable__'"},r.getDropTableStatements=function(e){return _.map(e,function(e){return r.getDropTableStatement(e)})},r.getAlterTableStatement=function(t,n){var r=n.name,s=i(n.type);return e.utils.formatString('ALTER TABLE {0} ADD COLUMN "{1}" {2}',[t,r,s])},r.getResetDateModifiedStatement=function(t,n){return e.utils.formatString('UPDATE {0} SET _client_date_modified=date_modified WHERE id="{1}"',[t,n.id])},r.getStatsRetrieveStatements=function(e){var t="(SELECT COUNT(*) FROM {0}) AS {0}, (SELECT COUNT(*) FROM {0} JOIN _view_dates ON {0}.id=_view_dates.bean_id) AS {0}_Viewed",n=[];return _.each(e.modules,function(e){var r=t.replace(/\{0\}/g,e);n.push(r)}),"SELECT "+n.join(", ")},r.transactionLog={getCreateSchemaStatements:function(){var e=[];return e.push('DROP TABLE IF EXISTS "_tx_log"'),e.push('CREATE TABLE "_tx_log" ("_tx_uid" TEXT COLLATE NOCASE PRIMARY KEY, "_tx_action" INTEGER, "_tx_ts" TEXT COLLATE NOCASE, "_tx_bean_id" TEXT COLLATE NOCASE,"_tx_bean_module" TEXT COLLATE NOCASE, "_tx_related_id" TEXT COLLATE NOCASE, "_tx_related_module" TEXT COLLATE NOCASE, "_tx_updated_fields" TEXT COLLATE NOCASE, "_tx_link" TEXT COLLATE NOCASE, "_tx_error" TEXT COLLATE NOCASE, "_tx_error_count" INTEGER DEFAULT 0)'),e.push("DROP INDEX IF EXISTS _tx_log_ts_IDX"),e.push('CREATE INDEX _tx_log_ts_IDX ON "_tx_log" ("_tx_ts")'),e.push("DROP INDEX IF EXISTS _tx_log_bean_id_IDX"),e.push('CREATE INDEX _tx_log_bean_id_IDX ON "_tx_log" ("_tx_bean_id" COLLATE NOCASE)'),e},getCountAssociatedTransactionsStatements:function(t){return e.utils.formatString('SELECT COUNT(*) AS count FROM _tx_log WHERE _tx_bean_id="{0}" AND _tx_uid!="{1}"',[t._tx_bean_id,t._tx_uid])},getReadTransactionsStatements:function(t){var n="ORDER BY ";return t.errFirst&&(n+='"_tx_error_count" = 0, '),n+='"_tx_ts" '+(t.dateAsc?"ASC":"DESC"),e.utils.formatString('SELECT * FROM "_tx_log" {0} LIMIT ?,?',[n])},sqlTxLogAction:'INSERT INTO "_tx_log" ("_tx_action", "_tx_ts", "_tx_bean_id", "_tx_bean_module", "_tx_related_id", "_tx_related_module", "_tx_updated_fields", "_tx_uid", "_tx_link") VALUES (?,?,?,?,?,?,?,?,?)',updateTransaction:function(t,n){var r=[];return _.each(n,function(e,t){r.push(t+"="+"'"+e+"'")}),e.utils.formatString("UPDATE _tx_log SET "+r.join(",")+" WHERE _tx_uid='{0}'",[t])},getTxLog:'SELECT * FROM "_tx_log" WHERE _tx_uid = ?',_deleteTransaction:"DELETE FROM _tx_log WHERE _tx_uid = ?",clearTransactionLog:"DELETE FROM _tx_log",countTransactions:"SELECT (SELECT COUNT(*) FROM _tx_log WHERE _tx_error in ("+e.offline.TRANSACTION_STATUSES.UNRECOVERABLE.join(",")+")) AS failedTransactions, (SELECT COUNT(*) FROM _tx_log) AS totalTransactions"},r.lastViewed={buildRead:function(e){return'SELECT * FROM "_view_dates" ORDER BY "date_last_viewed"'+(e?"":"DESC")+" LIMIT ?"},buildReadForRecords:function(e){return'SELECT * FROM "_view_dates" WHERE "bean_id" IN ("'+e.join('","')+'")'},buildReadForModule:function(e){return'SELECT "'+e+'".*, "_view_dates"."date_last_viewed" as "_last_viewed_date" FROM "'+e+'" INNER JOIN "_view_dates" ON "_view_dates"."bean_id" = "'+e+'"."id" WHERE _deleted != 1 ORDER BY "_view_dates"."date_last_viewed" DESC LIMIT ?'},getCreateSchemaStatements:function(){var e=[];return e.push('DROP TABLE IF EXISTS "_view_dates"'),e.push('CREATE TABLE "_view_dates" ("bean_id" TEXT COLLATE NOCASE PRIMARY KEY, "bean_module" TEXT COLLATE NOCASE, "date_last_viewed" TEXT COLLATE NOCASE)'),e},buildReplace:function(t,n,r){var i=r.ts||e.utils.getTimestamp();return e.utils.formatString('REPLACE INTO "_view_dates" ("bean_id","bean_module", "date_last_viewed") VALUES ("{0}","{1}","{2}")',[n.id,t,i])},buildDelete:function(t,n){return e.utils.formatString('DELETE FROM _view_dates WHERE bean_id="{0}"',[n.id])},buildFindViewedBefore:function(t,n){return e.utils.formatString('SELECT name, id, date_last_viewed FROM {0} AS d LEFT JOIN _view_dates AS v on d.id=v.bean_id WHERE (date_last_viewed IS NULL OR date_last_viewed < "{1}")',[t,n.expirationDate])},buildCleanupMyModule:function(t){return e.utils.formatString('DELETE FROM _view_dates WHERE bean_module="{0}"',[t])}},r.sync={getCreateSchemaStatements:function(){var e=[];return e.push('DROP TABLE IF EXISTS "_to_be_synced"'),e.push('CREATE TABLE "_to_be_synced" ("bean_id" TEXT COLLATE NOCASE PRIMARY KEY, "bean_module" TEXT COLLATE NOCASE, "action" TEXT COLLATE NOCASE)'),e},getMarkToBeSyncedSql:function(t,n){return e.utils.formatString('REPLACE INTO "_to_be_synced" ("bean_id","bean_module", "action") VALUES ("{0}","{1}","{2}")',[n.record.id,t,n.action])},getResetToBeSyncedSql:function(e,t){var n=_.pluck(t.records,"id");return'DELETE FROM "_to_be_synced" WHERE "bean_id" IN ("'+n.join('","')+'")'},getReadToBeSyncedSql:function(t,n,r){var i=e.utils.formatString('SELECT * FROM "_to_be_synced" WHERE bean_module="{0}" ORDER BY bean_id',[t]);return _.isUndefined(r.offset)||(i+=e.utils.formatString(" LIMIT {0},{1}",[r.offset,r.max_num])),i}},r.upgrade={getUpgrade1Sql:function(t){var n=[];return _.each(t.relationships,function(t){t.primary_flag_column&&n.push(e.utils.formatString('ALTER TABLE {0} ADD COLUMN "primary_flag" INTEGER DEFAULT 0',[t.join_table]))}),Array.prototype.push.apply(n,r.sync.getCreateSchemaStatements()),n}},e.offline.SqlHelper=r}(SUGAR.App),function(e){function t(){throw new Error("Not implemented. Please override this method with your implementation")}var n={createTransaction:"offline:tx:create",deleteTransaction:"offline:tx:delete"};e.offline.storage={_regularSyncOperations:["create","update","favorite","delete","follow"],relTypes:{ONE_TO_ONE:"one-to-one",ONE_TO_MANY:"one-to-many",MANY_TO_MANY:"many-to-many",ONE_TO_MANY_BY_ROLE_COLUMN:"one-to-many-byRoleColumn"},offlineMeta:{},_execQueue:null,_migrationSummary:{},getMigrationSummary:function(){return this._migrationSummary},resetMigrationSummary:function(){this._migrationSummary={}},exec:function(t,r,i){this._exec(t,function(s){r&&r(s),_.each(t,function(t){var r=n[t.op];r&&e.trigger(r,{txOptions:t.options})})},function(n){i&&i.apply(this,arguments),e.trigger("offline:failure",n||e.offline.UnknownError)})},_exec:function(e,n,r){t()},execAndSpecificReturn:function(t,n){var r=!_.isEmpty(n)&&n.regularSync,i=n.dbSuccess;if(r&&_.contains(this._regularSyncOperations,n.method)){n.method!=="delete"?(t.unshift({op:"createTransaction",data:n.data,module:n.module,options:n}),t.push({op:"readSingle",data:n.data,module:n.module,options:n})):(t.push({op:"readSingle",data:n.data,module:n.module,options:_.extend(n,{readDeleted:!0})}),n.dbSuccess=function(e){i.call(this,e?{id:e.id}:{id:n.data.id})}),n.relate&&(t.push({op:"readSingleRelated",data:n.data,module:n.module,options:n}),n.dbSuccess=function(e){i.call(this,{record:e[0],related_record:e[1]})});var s=n.action===e.offline.SYNC_ACTIONS.LINK||n.action===e.offline.SYNC_ACTIONS.UNLINK;s||t.push({op:"updateLastViewed",data:n.relate?{id:n.data.relatedId}:n.data,module:n.relate?n.data.relatedModule:n.module,options:n}),n.method!=="delete"&&t.push({op:"markToBeSynced",data:{action:"update",record:{id:n.relate?n.data.relatedId:n.data.id}},module:n.relate?n.data.relatedModule:n.module})}this.exec(t,n.dbSuccess,n.dbFailure)},_executeSynchronized:function(e){this._execQueue.push(e)},init:function(e){this.computeOfflineMeta(e),this._init(e),this._execQueue||this.initExecQueue()},initExecQueue:function(){var e=this;this._execQueue=async.queue(function(t,n){t.call(e,n)},1)},_init:function(e){},computeOfflineMeta:function(e){return this._detectOneToManyRelationshipFields(e.relationships),this._detectManyToManyRelationshipFields(e),this.offlineMeta.modules=e.modules,_.each(e.modules,function(t,n){this.offlineMeta[n]={};var r={date_modified:!0};_.each(t.fields,function(e){e.type!=="link"&&(r[e.name]=!0)}),_.isEmpty(this.offlineMeta.oneToManyRels[n])||_.each(this.offlineMeta.oneToManyRels[n],function(e){r[e]=!0},this);var i=this.offlineMeta[n].fields=[{type:"boolean",name:"my_favorite"},{type:"boolean",name:"following"},{type:"date",name:"_last_fetched"}],s=_.map(i,function(e){return e.name});_.each(t.fields,function(e){_.isObject(e)&&e.type!=="link"&&e.name!=="id"&&!_.contains(this.offlineMeta.fieldsBlacklist[n],e.name)&&!_.contains(s,e.name)&&e.name in r&&i.push(e)},this);var o=e.server_info,u=o&&o.fts&&o.fts.enabled&&t.ftsEnabled;this.offlineMeta[n].searchFields=_.select(i,function(e){return e.unified_search||e.name==="name"||u&&e.full_text_search},this)},this),this.offlineMeta},_detectOneToManyRelationshipFields:function(e){var t=this.offlineMeta.oneToManyRels={};return _.each(e,function(e,n){if(n==="_hash")return;var r=this.getRelationshipType(e);if(r===this.relTypes.ONE_TO_MANY||r===this.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN){var i=e.lhs_key==="id"?e.rhs_key:e.lhs_key,s=e.lhs_key==="id"?e.rhs_module:e.lhs_module;s in t||(t[s]=[]),t[s].push(i),r===this.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN&&t[s].push("parent_type")}},this),t},_detectManyToManyRelationshipFields:function(t){this.offlineMeta.mtmRelsColumns={},this.offlineMeta.fieldsBlacklist={},_.each(t.modules,function(t,n){_.each(t.fields,function(r){if(r.link_type==="relationship_info"){var i=t.fields[r.link],s=i.relationship,o=e.metadata.getRelationship(s);if(o&&this.getRelationshipType(o)===this.relTypes.MANY_TO_MANY){this.offlineMeta.fieldsBlacklist[n]=this.offlineMeta.fieldsBlacklist[n]||[];var u=_.omit(r.relationship_fields,"id");this.offlineMeta.mtmRelsColumns[s]=u,this.offlineMeta.fieldsBlacklist[n]=_.union(this.offlineMeta.fieldsBlacklist[n],_.values(u))}}},this)},this)},getRelationshipType:function(e){if(!_.isEmpty(e.join_table))return this.relTypes.MANY_TO_MANY;if(_.isEmpty(e.join_table)&&_.isEmpty(e.relationship_role_column))return this.relTypes.ONE_TO_MANY;if(_.isEmpty(e.join_table)&&!_.isEmpty(e.relationship_role_column))return this.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN},getRelationshipByLink:function(t,n){var r=e.metadata.getModule(t).fields[n].relationship;return e.metadata.getRelationship(r)},getCUTransactionParams:function(t,n,r){var i,s,o,u,a=null,f=null,l=r.txId||e.utils.generateUUID(),c=e.utils.getTimestamp(null,{msecPrecision:!0});if(r.relate){i=n.relatedId,s=n.relatedModule,o=n.id,u=t,a=n.link;if(r.action===e.offline.SYNC_ACTIONS.UNLINK)f={before:{module:n.relatedModule,id:n.relatedId},after:null};else if(r.action===e.offline.SYNC_ACTIONS.LINK){var h=this.getRelationshipByLink(t,n.link),p=this.getRelationshipType(h);if(p===this.relTypes.MANY_TO_MANY)f={before:null,after:{module:n.relatedModule,id:n.relatedId}};else{var d=this._wrapOneToManyRelationship(t,n.link),v=r.initialState[d.parentIdColumn],m=p===this.relTypes.ONE_TO_MANY_BY_ROLE_COLUMN;v?f={before:{module:m?r.initialState.parent_type:t,id:m?r.initialState.parent_id:r.initialState[d.parentIdColumn]},after:{module:n.relatedModule,id:n.relatedId}}:f={before:null,after:{module:n.relatedModule,id:n.relatedId}}}}else f=e.offline.utils.getBeforeAndAfter(n.related,r.initialState)}else i=n.id,s=t,o=null,u=null,r.action!==e.offline.SYNC_ACTIONS.DELETE&&(f=e.offline.utils.getBeforeAndAfter(n,r.initialState));return f&&(f=JSON.stringify(f)),[r.action,c,i,s,o,u,f,l,a]},_wrapOneToManyRelationship:function(t,n){var r;_.isObject(n)?r=n:r=this.getRelationshipByLink(t,n);var i=this._isParentOnRight(t,r),s=i?r.lhs_key:r.rhs_key,o=i?r.lhs_module:r.rhs_module;return{parentModule:t,childModule:o,tableName:i?r.lhs_module:r.rhs_module,parentIdColumn:s,parentNameFieldDef:e.data.getRelatedNameField(o,s)}},_wrapManyToManyRelationship:function(e,t){var n,r;_.isObject(t)?n=t:n=this.getRelationshipByLink(e,t);var i=this._isParentOnRight(e,n);return r={parentModule:e,relationshipTable:n.join_table,dataTable:i?n.lhs_module:n.rhs_module,childIdColumn:i?n.join_key_lhs:n.join_key_rhs,parentIdColumn:i?n.join_key_rhs:n.join_key_lhs,additionalColumns:this.offlineMeta.mtmRelsColumns[n.name],singleModule:n.lhs_module===n.rhs_module},n.primary_flag_column&&(r.primaryFlagModule=n.primary_flag_side==="rhs"?n.lhs_module:n.rhs_module,r.link=n[n.primary_flag_side+"_table"]),r},_isParentOnRight:function(e,t){var n=this.getRelationshipType(t);return n===this.relTypes.MANY_TO_MANY?e===t.rhs_module:t.rhs_key==="id"},_getModuleRelationships:function(t){var n=e.metadata.getModule(t),r=e.offline.getOfflineModules(),i=[];return _.each(n.fields,function(t){if(t.type==="link"){var n=e.metadata.getRelationship(t.relationship);n&&_.contains(r,n.rhs_module)&&_.contains(r,n.lhs_module)&&i.push(e.metadata.getRelationship(t.relationship))}}),i},_shouldCustomRelUpdateChild:function(e,t){return e.relationship_type===this.relTypes.ONE_TO_MANY&&!t.skipUpdateRelRecord&&!e.relationship_role_column||e.relationship_type===this.relTypes.ONE_TO_ONE||e.primary_flag_column},_getParentModule:function(e){return e.rhs_key==="id"?e.rhs_module:e.lhs_module},openDb:function(e,n,r){t()},migrate:function(e,n,r){t()},upgrade:function(t,n,r){r=r||{};var i=parseInt(this.getSqlStorageVersion(),10),s=parseInt(e.cache.get("offline:version"),10),o=i-s,u,a=[],f=r.success||function(){},l=r.error||function(){};if(!o){e.logger.debug("Version has not changed. No actual upgrade required"),f(t,n);return}n=this._getUpgradedMeta(n);while(o--)u=s+o,this._upgrade[u]&&a.unshift(this._upgrade[u](t));_.isEmpty(a)?(e.logger.debug("Storage structure has not changed"),f(t,n)):this._runUpgrade(_.flatten(a),function(){f(t,n)},function(t){l(t)})},_runUpgrade:function(e,n,r){t()},_getUpgradedMeta:function(t){var n={modules:{},relationships:t.relationships,_hash:t.hash,_userId:t.userId};return delete t.relationships,delete t.hash,delete t.userId,_.chain(t).omit(e.config.offline.exclude).each(function(e,t){n.modules[t]={_hash:e.hash,fields:{_hash:e.fieldsHash}}}),n},drop:function(e){t()},getDetails:function(){return{type:e.config.offline.storageAdapter}},isOutOfSpace:function(e){this._isOutOfSpace(e)},open:function(t){t=_.extend({env:"dev",name:"sidecar",size:5,version:"1.0"},t);var n=t.name+"-"+t.env,r=t.size*1024*1024,i=t.version;try{this.openDb(n,i,r)}catch(s){return e.logger.fatal("Failed to open database: "+n+" "+i+" ("+r+" bytes). "+s),!1}return!0},sync:function(t,n,r,i){this._executeSynchronized(function(s){e.logger.trace("storageAdapter: "+t+"-"+r+(n&&n.id?"-"+n.id:"")),i=_.extend({regularSync:!0,method:t,dbSuccess:function(t){s(),i.success&&i.success(t),i.complete&&i.complete(t)},dbFailure:function(t){s(),i.error&&i.error(t),i.complete&&i.complete(t)}},i||{});switch(t){case"read":i.dbSuccess=function(t){s();if(i.success){if(t){var r=!1;i.relate?r=_.isEmpty(n.relatedId):r=_.isUndefined(n),r&&!_.isArray(t)?t=[t]:!r&&_.isArray(t)&&(t=t[0])}else t=null;i.success(t)}i.complete&&i.complete(t)};var o=n&&n.link?n.relatedId:n?n.id:null;o?this._readSimpleOrRelated(r,n,i):i.relate?this._readManyRelatedRecords(r,n,i):this._readManyRecords(r,i);break;case"create":i.relate?this._createRelatedRecord(r,n,i):this._createRecord(r,n,i);break;case"update":i.relate?this._updateRelatedRecord(r,n,i):this._updateRecord(r,n,i);break;case"delete":i.relate?this._unlinkRecord(r,n,i):i.hardDelete?this._hardDeleteRecord(r,n,i):this._softDeleteRecord(r,n,i);break;case"favorite":this._favorite(r,n,i);break;case"follow":this._follow(r,n,i);break;case"search":i.max_num=i.max_num||e.config.maxQueryResult,i.module_list.split(",").length>1&&(i=_.omit(i,"offset"),i.max_num=e.config.offline.maxMixedCollectionQueryResult||30),i.dbSuccess=function(t){s(),i.success&&i.success(t),i.complete&&i.complete(t)},this._search(i);break;default:}})},saveRecords:function(e){var t=e.serverData,n=this;t instanceof Array||(t=[t]),this._executeSynchronized(function(r){var i=_.map(t,function(t){return function(r){n._saveRecord({data:t,module:e.module||t._module,callback:r,ignoreRecordDirtiness:e.ignoreRecordDirtiness,relationshipData:e.relationshipData})}});async.series(i,function(t){r(),e.callback(t)})})},_saveRecord:function(t){var n=t.callback,r=t.relationshipData,i=this;async.waterfall([function(n){i.exec([{op:"readSingle",data:{id:t.data.id},module:r?r.relatedModule:t.module,options:{readDeleted:!0}}],function(e){n(null,e)},n)},function(s,o){var u=[],a=s?e.offline.utils.actionToString(e.offline.SYNC_ACTIONS.UPDATE):e.offline.utils.actionToString(e.offline.SYNC_ACTIONS.CREATE);if(t.ignoreRecordDirtiness||!s||!!e.offline.utils.isDataSynchronized(s)){var f=t.data;f.date_modified&&(f._client_date_modified=f.date_modified),f._last_fetched=e.utils.getTimestamp(),u=[{op:a,module:r?r.relatedModule:t.module,data:f,options:{initialState:s}}];if(r){var l=_.clone(r);_.extend(l,{related:t.data,relatedId:t.data.id}),u.push({op:"createLink",module:t.module,data:l,options:{ts:e.utils.getTimestamp(f.date_modified)}})}}u.length>0?i.exec(u,o,o):o()}],n)},resolveSuccess:function(e){this._executeSynchronized(function(t){this._resolveTransaction({transaction:e.transaction,module:e.module,serverData:e.serverData,relationshipData:e.relationshipData,callback:function(){t(),e.callback&&e.callback.apply(this,arguments)}})})},_resolveTransaction:function(t){var n=t.callback,r=t.relationshipData,i=!1,s=!1,o=e.utils.getTimestamp(),u=this;async.waterfall([function(n){u.exec([{op:"countAssociatedTransactions",options:{txData:t.transaction}}],function(e){i=e&&e.count>0,n()},n)},function(n){if(!r){n();return}u.exec([{op:"countAssociatedTransactions",options:{txData:{_tx_uid:t.transaction._tx_uid,_tx_bean_id:t.transaction._tx_related_id}}}],function(e){s=e&&e.count>0,n()},n)},function(n){u.exec([{op:"readSingle",data:{id:t.serverData.id},module:r?r.relatedModule:t.module,options:{readDeleted:!0}}],function(e){n(null,e)},n)},function(a,f){function d(e){p.push({op:"updateValuesSingle",data:_.pick(e,"id","date_modified"),module:h})}var l=t.transaction,c=l._tx_action,h=l._tx_bean_module;c===e.offline.SYNC_ACTIONS.CREATE&&(c=e.offline.SYNC_ACTIONS.UPDATE);var p=[{op:"deleteTransaction",data:null,module:null,options:{txId:l._tx_uid}}];if(r){if(c===e.offline.SYNC_ACTIONS.UPDATE||c===e.offline.SYNC_ACTIONS.LINK||c===e.offline.SYNC_ACTIONS.UNLINK)r.related&&(i?d(r.related):(r.related._last_fetched=o,p.push({op:"updateValuesSingle",module:r.relatedModule,data:r.related}),p.push({op:"resetDateModified",data:{id:r.related.id},module:r.relatedModule}))),r.record&&!s&&(r.record._last_fetched=o,p.push({op:"updateValuesSingle",module:r.recordModule,data:r.record}),p.push({op:"resetDateModified",data:{id:r.record.id},module:r.recordModule}));c===e.offline.SYNC_ACTIONS.UNLINK&&!s&&!i&&p.push({op:"deleteLink",module:r.recordModule,data:{id:r.id,link:r.link,related:r.related,relatedId:r.relatedId,relatedModule:r.relatedModule},options:{hardDelete:!0}})}else c===e.offline.SYNC_ACTIONS.DELETE?(p.push({op:"hardDeleteSingle",module:h,data:t.serverData}),p.push({op:"deleteLastViewed",data:t.serverData,module:h})):i?d(t.serverData):(t.serverData._last_fetched=o,p.push({op:e.offline.utils.actionToString(c),data:t.serverData,module:h}),p.push({op:"resetDateModified",data:{id:t.serverData.id},module:h}));u.exec(p,function(){e.trigger("offline:tx:success",{tx:l}),f()},function(t){f(t)})}],n)},resolveError:function(t){var n,r,i;if(t.nonTransactionResolve&&t.error.status!==404&&t.error.status!==403){t.callback();return}!e.utils.isConnectivityError(t.error)&&!t.nonTransactionResolve&&e.trigger("offline:tx:error",{tx:t.txLog,errorCode:t.error.status});switch(t.error.status){case 0:t.callback&&_.defer(t.callback,t.error);break;case 409:t.error.record=t.error.record||t.error.payload&&t.error.payload.record||{};var s=t.txLog,o=e.offline.getOfflineModules(),u=[];if(!_.contains(o,s._tx_bean_module)||_.isEmpty(e.utils.getChangedProps(t.updatedFields,t.error.record)))u.push({op:"deleteTransaction",options:{txId:s._tx_uid}});else{var a={op:"updateValuesSingle",data:null,module:s._tx_bean_module};u=[a,{op:"updateTransaction",data:{txLog:_.extend(_.clone(s),{_tx_error_count:s._tx_error_count+1,_tx_error:t.error.status})}}]}this._executeSynchronized(function(n){var r=function(e){n(),t.callback&&t.callback(e)};a?this.exec([{op:"countAssociatedTransactions",options:{txData:s}}],_.bind(function(n){n&&n.count>0?a.data=_.pick(t.error.record,"id","date_modified"):(a.data=e.utils.deepCopy(t.error.record),a.data._last_fetched=e.utils.getTimestamp()),this.exec(u,r,r)},this),r):this.exec(u,r,r)});break;case 404:t.nonTransactionResolve?t.nonTransactionResolve.relate?n=[{op:"deleteLink",module:t.nonTransactionResolve.module,data:t.nonTransactionResolve.data}]:n=[{op:"hardDeleteSingle",module:t.nonTransactionResolve.module,data:{id:t.nonTransactionResolve.id}}]:(r=t.txLog._tx_bean_module,i=t.txLog._tx_bean_id,n=[{op:"hardDeleteSingle",module:r,data:{id:i}}],n.push({op:"deleteTransaction",data:null,module:null,options:{txId:t.txLog._tx_uid}})),this._executeSynchronized(function(e){this.exec(n,function(){e(),t.callback&&t.callback()},function(n){e(),t.callback&&t.callback(n)})});break;case 422:t.txLog&&(n=[{op:"deleteTransaction",data:null,module:null,options:{txId:t.txLog._tx_uid}},{op:"updateValuesSingle",data:{id:t.txLog._tx_bean_id,date_modified:t.txLog._tx_ts,_client_date_modified:t.txLog._tx_ts},module:t.txLog._tx_bean_module}]),this._executeSynchronized(function(e){this.exec(n,function(){e(),t.callback&&t.callback()},function(n){e(),t.callback&&t.callback(n)})});break;case 403:var f;if(t.nonTransactionResolve){r=t.relate?t.nonTransactionResolve.data.relatedModule:t.nonTransactionResolve.module;var l=t.relate?t.nonTransactionResolve.data.id:t.nonTransactionResolve.id;f={op:"hardDeleteSingle",module:r,data:{id:l},options:{skipRelationshipsClean:!0}}}else f={op:"updateTransaction",data:{txLog:_.extend(t.txLog,{_tx_error_count:++t.txLog._tx_error_count,_tx_error:t.error.status})}};this._executeSynchronized(function(e){this.exec([f],function(){e(),t.callback&&t.callback(t.nonTransactionResolve?null:t.error)},function(n){e(),t.callback&&t.callback(n)})});break;case 500:default:this._executeSynchronized(function(e){this.exec([{op:"updateTransaction",data:{txLog:_.extend(t.txLog,{_tx_error_count:++t.txLog._tx_error_count,_tx_error:t.error.status})}}],function(){e(),t.callback&&t.callback(t.error)},function(n){e(),t.callback&&t.callback(n)})})}},rollbackTransaction:function(t,n,r){n=n||{};var i=this;this._executeSynchronized(function(s){this.exec([{op:"countAssociatedTransactions",options:{txData:t}}],function(o){n.resetDirty=!o||o.count===0;var u=[{op:"deleteTransaction",options:{txId:t._tx_uid}}],a;t._tx_action===e.offline.SYNC_ACTIONS.UPDATE?a=i._getRollbackUpdateTasks:t._tx_action===e.offline.SYNC_ACTIONS.CREATE?a=i._getRollbackCreateTasks:t._tx_action===e.offline.SYNC_ACTIONS.DELETE?a=i._getRollbackDeleteTasks:t._tx_action===e.offline.SYNC_ACTIONS.FAVORITE?a=i._getRollbackFavoriteTasks:t._tx_action===e.offline.SYNC_ACTIONS.FOLLOW?a=i._getRollbackFollowTasks:t._tx_action===e.offline.SYNC_ACTIONS.UNLINK?a=i._getRollbackUnlinkTasks:t._tx_action===e.offline.SYNC_ACTIONS.LINK&&(a=i._getRollbackLinkTasks),a=_.bind(a,i),u=u.concat(a(t,n)),i.exec(u,function(){s(),e.trigger("offline:tx:rollback",{tx:t}),r()},function(t){s(),r(t)})},function(t){s(),r(t)})})},_getRollbackUpdateTasks:function(e,t){var n=this._getTxUpdatedFields(e),r=e._tx_bean_module,i={id:e._tx_bean_id};_.each(n,function(e,t){i[t]=e.before},this);var s=[{op:"updateValuesSingle",data:i,module:r,options:t}];return t.resetDirty&&s.push({op:"resetDateModified",module:r,data:i}),s},_getRollbackCreateTasks:function(e,t){return[{op:"hardDeleteSingle",data:{id:e._tx_bean_id},module:e._tx_bean_module,options:t}]},_getRollbackDeleteTasks:function(e){return[{op:"resetDeletedSingle",data:{id:e._tx_bean_id},module:e._tx_bean_module}]},_getRollbackFavoriteTasks:function(e,t){var n=this._getTxUpdatedFields(e),r=e._tx_bean_module,i={id:e._tx_bean_id,my_favorite:n.my_favorite.before};n.following&&(i.following=n.following.before);var s=[{op:"updateValuesSingle",data:i,module:r,options:t}];return t.resetDirty&&s.push({op:"resetDateModified",module:r,data:{id:e._tx_bean_id}}),s},_getRollbackFollowTasks:function(e,t){var n=this._getTxUpdatedFields(e),r=e._tx_bean_module,i=[{op:"updateValuesSingle",data:{id:e._tx_bean_id,following:!!n.following.before},module:r,options:t}];return t.resetDirty&&i.push({op:"resetDateModified",module:r,data:{id:e._tx_bean_id}}),i},_getRollbackUnlinkTasks:function(e,t){var n=[{op:"createLink",module:e._tx_related_module,data:{id:e._tx_related_id,link:e._tx_link,related:{id:e._tx_bean_id},relatedId:e._tx_bean_id,relatedModule:e._tx_bean_module}}];return t.resetDirty&&n.push({op:"resetDateModified",module:e._tx_bean_module,data:{id:e._tx_bean_id}}),n},_getRollbackLinkTasks:function(e,t){var n=this._getTxUpdatedFields(e),r;return n.before?r=[{op:"createLink",module:n.before.module,data:{id:n.before.id,link:e._tx_link,related:{id:e._tx_bean_id},relatedId:e._tx_bean_id,relatedModule:e._tx_bean_module}}]:r=[{op:"deleteLink",module:e._tx_related_module,data:{id:e._tx_related_id,link:e._tx_link,related:{id:e._tx_bean_id},relatedId:e._tx_bean_id,relatedModule:e._tx_bean_module}}],t.resetDirty&&r.push({op:"resetDateModified",module:e._tx_bean_module,data:{id:e._tx_bean_id}}),r},_getTxUpdatedFields:function(e){return _.isString(e._tx_updated_fields)?JSON.parse(e._tx_updated_fields):e._tx_updated_fields},readSingleRawRecord:function(e,t,n){this._executeSynchronized(function(r){this.exec([{op:"readSingle",data:t,module:e,options:_.extend(n,{readDeleted:!0})}],function(){r(),n.success&&n.success.apply(this,arguments)},function(){r(),n.error&&n.error.apply(this,arguments)})})},readRecordsByIds:function(e,t,n){this._executeSynchronized(function(r){this.exec([{op:"readModuleRecords",data:{id:t},module:e}],function(){r(),n.success&&n.success.apply(this,arguments)},function(){r(),n.error&&n.error.apply(this,arguments)})})},readTransactions:function(e,t){this._executeSynchronized(function(n){this.exec([{op:"readTransactions",bean:null,data:t,options:e}],function(r){n(),e.success&&e.success.apply(this,arguments)},function(){n(),e.error&&e.error.apply(this,arguments)})})},getStats:function(t){t=t||{},t=_.defaults(t,{modules:e.offline.utils.getOfflineModules(),success:function(t){e.logger.debug(t)},error:function(t){e.logger.error("getStats failed. "+t)}});var n={count:{},viewed:{}},r=this;this._executeSynchronized(function(e){async.series([function(i){r.getRecordsCount(t,function(e,t){_.each(t,function(e,r){r.indexOf("_Viewed")!==-1&&(n.viewed[r.replace("_Viewed","")]=e,delete t[r])}),n.count=t,i(e,t)})},function(i){r.getStorageSize(t,function(e,t){e||_.extend(n,t),i(e,t)})}],function(i){e(),i?t.error(i):t.success(n)})})},getRecordsCount:function(e,t){this.exec([{op:"getStats",data:null,module:null,options:e}],function(e){t(null,e)},t)},_NO_STORAGE_INFO:{dbSize:-1,totalDiskSpace:-1,freeDiskSpace:-1},getStorageSize:function(e,t){t(null,_.clone(this._NO_STORAGE_INFO))},compact:function(t){t=t||{};var n=(new Date).getTime(),r=new Date(n-864e5*(e.config.offline.defaultPurgeInterval||7)),i=this,s=_.keys(e.config.offline.prefetch.staticModules||[]),o=_.filter(e.offline.utils.getOfflineModules(),function(e){return!_.contains(s,e)});t=_.defaults(t,{modules:o,expirationDate:e.utils.getTimestamp(r),callback:function(t){e.logger.debug(t||"Offline DB cleaning up completed")}});var u=[];t.flushTransactions&&u.push(function(t){i.exec([{op:"clearTransactionLog"}],function(){t()},t)}),_.each(t.modules,function(e){u.push(function(n){i._cleanUpModule(e,t.expirationDate,n)})}),this._executeSynchronized(function(n){async.series(u,function(r){n(),r&&e.logger.error("Failed to clean up database. "+r),t.callback(r)})})},_cleanUpModule:function(e,t,n){var r=this;async.waterfall([function(i){r.exec([{op:"findViewedBefore",module:e,options:{expirationDate:t}}],function(e){i(null,e)},i)},function(n,i){if(_.isEmpty(n))return i();var s=[];n=_.isArray(n)?n:[n],_.each(n,function(t){s.push(function(n){r._hardDeleteRecord(e,{id:t.id},{skipOneToManyChildren:!0,dbSuccess:function(){n()},dbFailure:function(e){n(e)}})})}),async.series(s,i)}],function(t,r){n(t)})},_favorite:function(t,n,r){r.action=e.offline.SYNC_ACTIONS.FAVORITE,n={id:n.id,my_favorite:n.my_favorite,_client_date_modified:r.ts},n.my_favorite&&(n.following=!0),this.execAndSpecificReturn([{op:"updateValuesSingle",data:n,module:t,options:r}],_.extend({data:n,module:t},r))},_follow:function(t,n,r){r.action=e.offline.SYNC_ACTIONS.FOLLOW,this.execAndSpecificReturn([{op:"updateValuesSingle",data:{id:n.id,following:n.following,_client_date_modified:r.ts},module:t,options:r}],_.extend({data:n,module:t},r))},_updateRecord:function(t,n,r){r.action=e.offline.SYNC_ACTIONS.UPDATE,n._client_date_modified=r.ts,e.offline.utils.isRecordAssignedToLoginUser(n)&&(n.following=!0),this.execAndSpecificReturn([{op:"updateValuesSingle",data:n,module:t,options:r}],_.extend({data:n,module:t},r))},_updateRelatedRecord:function(t,n,r){r.action=e.offline.SYNC_ACTIONS.UPDATE,n.related._client_date_modified=r.ts,e.offline.utils.isRecordAssignedToLoginUser(n.related)&&(n.related.following=!0);var i=[{op:"updateValuesSingle",data:n.related,module:n.relatedModule,options:r}],s=this.getRelationshipByLink(t,n.link),o=this.getRelationshipType(s),u=e.data.getRelationshipFields(t,n.link),a=!_.isEmpty(_.pick(n.related,u));o===this.relTypes.MANY_TO_MANY&&a&&i.push({op:"createLink",module:t,data:n,options:r}),this.execAndSpecificReturn(i,_.extend({data:n,module:t},r))},_createRecord:function(t,n,r){n.id=n.id||e.utils.generateUUID(),n._client_date_modified=r.ts,e.offline.utils.isRecordAssignedToLoginUser(n)&&(n.following=!0),r.action=e.offline.SYNC_ACTIONS.CREATE,this.execAndSpecificReturn([{op:"createSingle",data:n,module:t,options:r}],_.extend({data:n,module:t},r))},_createRelatedRecord:function(t,n,r){var i=this;n.related._client_date_modified=r.ts;if(n.relatedId){var s=function(){r.action=e.offline.SYNC_ACTIONS.LINK,i.execAndSpecificReturn([{op:"createLink",module:t,data:n,options:r}],_.extend({data:n,module:t},r))},o=function(e){var t=e[0],n=e[1];if(!_.isEmpty(n))return r.dbSuccess({record:t,relatedRecord:n});s()},u=e.offline.storage.getRelationshipByLink(t,n.link),a=e.offline.storage.getRelationshipType(u);a===e.offline.storage.relTypes.MANY_TO_MANY?i.exec([{op:"readSingle",data:n,module:t,options:_.extend(r,{readDeleted:!0})},{op:"readSingleRelated",module:t,data:n,options:r}],o,r.dbFailure):s()}else{var f=e.utils.generateUUID();n.relatedId=n.related.id=f,r.action=e.offline.SYNC_ACTIONS.CREATE,e.offline.utils.isRecordAssignedToLoginUser(n.related)&&(n.related.following=!0),this.execAndSpecificReturn([{op:"createSingle",module:n.relatedModule,data:n.related,options:r},{op:"createLink",module:t,data:n,options:r}],_.extend({data:n,module:t},r))}},_softDeleteRecord:function(t,n,r){r.action=e.offline.SYNC_ACTIONS.DELETE,this.execAndSpecificReturn([{op:"createTransaction",module:t,data:n,options:r},{op:"softDeleteSingle",module:t,data:n,options:r}],_.extend({data:n,module:t},r))},_hardDeleteRecord:function(t,n,r){r.action=e.offline.SYNC_ACTIONS.DELETE,this.execAndSpecificReturn([{op:"hardDeleteSingle",module:t,data:n,options:r},{op:"deleteLastViewed",data:n,module:t}],_.extend({data:n,module:t},r))},_unlinkRecord:function(t,n,r){r.action=e.offline.SYNC_ACTIONS.UNLINK;var i=[{op:"deleteLink",module:t,data:n,options:r}];r.hardDelete||i.push({op:"createTransaction",module:t,data:n,options:r}),this.execAndSpecificReturn(i,_.extend({data:n,module:t},r))},_readSimpleOrRelated:function(e,t,n){var r={op:n.relate?"readSingleRelated":"readSingle",data:t,module:e,options:n},i=[r];this._shouldUpdateLastViewedDate(n)&&(i.splice(0,0,{op:"updateLastViewed",data:n.relate?{id:t.relatedId}:t,module:n.relate?t.relatedModule:e,options:n}),i.splice(0,0,{op:"markToBeSynced",module:n.relate?t.relatedModule:e,data:{action:"update",record:{id:n.relate?t.relatedId:t.id}}})),this.exec(i,n.dbSuccess,n.dbFailure)},_readManyRecords:function(e,t){this.exec([{op:"readMany",module:e,options:t}],t.dbSuccess,t.dbFailure)},_readManyRelatedRecords:function(e,t,n){this.exec([{op:"readManyRelated",module:e,data:t,options:n}],n.dbSuccess,n.dbFailure)},_search:function(e){_.isString(e.order_by)&&(e.order_by=e.order_by.replace("date_modified","_client_date_modified")),this.exec([{op:"search",options:e}],e.dbSuccess,e.dbFailure)},_shouldUpdateLastViewedDate:function(e){return e&&e.viewed},fillTxLogData:function(e,t){function r(e,t){var r=e["_tx_"+t+"_module"];if(!r)return;_.has(n,r)||(n[r]=[]),n[r].push(e["_tx_"+t+"_id"])}function i(e,t,n){var r=e["_tx_"+t+"_id"];if(!r)return;var i=e["_tx_"+t+"_module"];_.isArray(n[i])?e[t]=_.find(n[i],function(e){return e.id===r}):e[t]=n[i]}_.each(e,function(e){e._tx_updated_fields&&(e._tx_updated_fields=JSON.parse(e._tx_updated_fields))});var n={};_.each(e,function(e){r(e,"bean"),r(e,"related")}),this._executeSynchronized(function(r){this.readModuleRecords(n,function(n,s){r(),n||_.each(e,function(e){i(e,"bean",s),i(e,"related",s)}),t(n,e)})})},readModuleRecords:function(e,t,n){var r=this;_.each(e,function(t,n){var i={op:"readModuleRecords",module:n,data:{id:t},options:{}};e[n]=function(e){r.exec([i],function(t){e(null,t)},e)}}),async.parallel(e,t)},markToBeSynced:function(e){this.exec([{op:"markToBeSynced",module:e.module,data:{action:e.action,record:e.record}}],e.callback,e.callback)},resetToBeSynced:function(e){this.exec([{op:"resetToBeSynced",module:e.module,data:{records:e.records}}],e.callback,e.callback)},readToBeSynced:function(e){this.exec([{op:"readToBeSynced",module:e.module,options:e}],function(t){t=t||[],_.isArray(t)||(t=[t]),e.callback({records:t})},e.callback)},updateLastViewed:function(e,t){this.exec([{op:"updateLastViewed",data:e,module:t.module,options:t}],t.callback,t.callback)}}}(SUGAR.App),function(e){function o(e){return _.isEmpty(e)||_.isEmpty(e.fields)&&_.isEqual(_.keys(e),["fields"])}function u(t,n){return t.code===4?e.offline.Error.OutOfSpaceError:new e.offline.Error(t.code,t.message,null,t,n)}function a(n,r){var i=[r.id,r._client_date_modified?e.utils.getTimestamp(r._client_date_modified):undefined,r._deleted==1?1:0,o(r._acl)?null:JSON.stringify(r._acl)],s=e.metadata.getModule(n).fields;return _.each(t[n].fields,function(e){i.push(f(r[e.name],e.name,n,s))}),i}function f(t,r,i,s){if(r==="_acl")t=o(t)?null:JSON.stringify(t);else if(r==="_deleted")t=t==1?1:0;else if(_.isUndefined(t))t=null;else if(_.isBoolean(t))t=t?1:0;else if(_.contains(n[i],r))t=JSON.stringify(t);else if(r==="_client_date_modified"||t&&s[r]&&(s[r].type==="datetime"||s[r].type==="datetimecombo")&&!isNaN(Date.parse(t)))t=e.utils.getTimestamp(t);return t}var t={},n={},r,i,s=["email","teamset","multienum","metadata","json","tag"];_.extend(e.offline.storage,{_version:"2.0",_getValues:a,_getValue:f,_init:function(){t={},n={},e.offline.SqlHelper.init(this.offlineMeta),_.each(this.offlineMeta.modules,function(r,i){t[i]=new e.offline.SqlHelper(i,r,this.offlineMeta[i].fields),n[i]=[],_.each(r.fields,function(e){_.contains(s,e.type)&&n[i].push(e.name)})},this)},getSqlStorageVersion:function(){return this._version},openDb:function(t,n,s){if(r)return r;r=this._openDb(t,n,s);if(!r)throw new Error("`openDatabase` returned nothing");return i=t,e.logger.debug("Opened database "+t+" "+n+" ("+s+" bytes)"),r},_openDb:function(t,n,r){return e.config.offline.storageAdapter==="native"?window.sqlitePlugin.openDatabase({name:t,bgType:1}):window.openDatabase(t,n,t,r)},migrate:function(n,r,i){var s=this,o=[],u=!1,a=!1,f=!1;i=i||{},r=r||{modules:{},relationships:{},serverInfo:{}},s.init(n);if(i.forceDrop||_.isEmpty(r)||r._userId!==e.user.get("id")||n.relationships._hash!==r.relationships._hash||r.siteUrl!==e.utils.stripHttpPrefix(e.config.siteUrl))u=!0,a=!0,f=!0,s._migrationSummary={storageRebuilt:!0},_.each(n.modules,function(n,r){e.offline.isOfflineEnabled(r)&&o.push(t[r].getSchema(r,n))});else if(n._hash!==r._hash){var l=_.filter(_.keys(r.modules),function(t){return e.offline.isOfflineEnabled(t)}),c=_.filter(_.keys(n.modules),function(t){return e.offline.isOfflineEnabled(t)}),h=[],p=[];_.each(l,function(t){_.contains(c,t)||(h.push(t),o.push(e.offline.SqlHelper.getDropTableStatement(t)),o.push(e.offline.SqlHelper.lastViewed.buildCleanupMyModule(t)),u=!0)},this),_.each(c,function(e){_.contains(l,e)||(p.push(e),o.push(t[e].getSchema(e,n.modules[e])),u=!0)},this),_.each(n.modules,function(t,i){if(_.contains(p,i))return;if(r.modules[i]._hash!==t._hash&&t.fields._hash!==r.modules[i].fields._hash){var s=_.difference(_.keys(n.modules[i].fields),_.keys(r.modules[i].fields));_.each(s,function(t){var r=n.modules[i].fields[t];if(_.isEmpty(r.name))return;o.push(e.offline.SqlHelper.getAlterTableStatement(i,r))})}},this)}u&&o.push(e.offline.SqlHelper.relationships.getCreateSchemaStatements(n)),a&&o.push(e.offline.SqlHelper.transactionLog.getCreateSchemaStatements()),f&&o.push(e.offline.SqlHelper.lastViewed.getCreateSchemaStatements()),o.push(e.offline.SqlHelper.sync.getCreateSchemaStatements());if(o.length===0)return e.logger.debug("No actual migration required"),i.success();this._execRawStatements(_.flatten(o),function(){i.success&&i.success()},function(t){i.error&&i.error(t)})},_upgrade:{1:function(t){return e.offline.SqlHelper.upgrade.getUpgrade1Sql(t)}},_runUpgrade:function(e,t,n){this._execRawStatements(e,t,n)},_execRawStatements:function(t,n,i){var s;r.transaction(function(n){_.each(t,function(t){s=t,e.logger.trace(t),n.executeSql(t)})},function(n){i&&i(u(n),{failedSql:s,transactionSql:t})},n)},_exec:function(t,n,i){function c(e){return _.any(e,function(e){return _.isArray(e.sql)?c(e.sql):/^\s*(UPDATE|INSERT|REPLACE)/i.test(e.sql)})}var s=[],o=[],a,f,l=this;_.each(t,function(e){var t=_.clone(e.data),n=_.clone(e.options),r=l._sqlHandlers[e.op](e.module,t,n);if(!r)return;!r.module&&e.options&&(e.options.relate&&e.op!=="readSingle"?r.module=e.data.relatedModule:r.module=e.module),e.module&&(a=e.module),o.push(r)});if(e.config.offline.debug.outOfSpace&&c(o)){_.defer(function(){i&&i(u({code:4},{failedSql:{sql:"SELECT 1;",params:[]},transactionSql:o}))});return}r.transaction(function(t){_.each(o,function(n){function r(n){e.logger.trace("Executing SQL: "+n.sql),e.logger.trace("Params: "+(n.params?n.params:"(no params)")),f=n,t.executeSql(n.sql,n.params,function(t,r){r=r?l._recordSetToArray(r,n.module||a):[],n.module&&(r=_.map(r,function(e){return e._module=n.module,e})),s=s.concat(r)})}_.isArray(n.sql)?_.each(n.sql,r):r(n)})},function(t){i&&i(u(t,{failedSql:{sql:f.sql,params:f.params},transactionSql:o}))},function(){s.length===1?s=s[0]:s.length===0&&(s=null),n(s)})},_isOutOfSpace:function(t){var n=this;if(e.config.offline.debug.outOfSpace){_.defer(t,!0);return}r.transaction(function(e){var t=n._sqlHandlers.updateTransaction("Module",{txLog:{_tx_uid:"tx_id",_tx_error_count:0}});t.sql+=" AND 1 <> 1",e.executeSql(t.sql,t.params)},function(e){t(e.code===4)},function(){t(!1)})},drop:function(t){var n=this;r.transaction(function(t){t.executeSql(e.offline.SqlHelper.getSelectTablesStatement(),null,function(t,r){var i=e.offline.SqlHelper.getDropTableStatements(_.map(n._recordSetToArray(r),function(e){return e.tbl_name}));_.each(i,function(e){t.executeSql(e)})})},function(n){t&&t(u(n))},function(){t&&t()})},_sqlHandlers:{readSingle:function(e,n,r){return r=r||{},t[e]?{sql:r.readDeleted?t[e].sqlSelectOneWithDeleted:t[e].sqlSelectOne,params:[n.id]}:null},search:function(e,n,r){var i=r.module_list.split(","),s=[];return _.each(i,function(e){s.push({sql:t[e].buildSqlSelectMany(r),params:null,module:e})}),{sql:s}},readSingleRelated:function(t,n,r){return r=r||{},{sql:e.offline.SqlHelper.relationships.buildSqlSelectSingleRelated(t,n,r),params:null}},readMany:function(e,n,r){return{sql:t[e].buildSqlSelectMany(r),params:null}},readManyRelated:function(t,n,r){return{sql:e.offline.SqlHelper.relationships.buildSqlSelectManyRelated(t,n,r),params:null}},readModuleRecords:function(e,n){return t[e]?{sql:t[e].buildSqlReadModuleRecordsByIds(n.id),params:null}:null},createSingle:function(n,r,i){r.id=r.id||e.utils.generateUUID();var s=a(n,r),o=[],u=this.updateRelationships(n,r,i);return o.push({sql:t[n].sqlCreate,params:s}),_.isEmpty(u)||(o=o.concat(u)),{sql:o}},resetDateModified:function(n,r){return t[n]?{sql:e.offline.SqlHelper.getResetDateModifiedStatement(n,r)}:null},updateValuesSingle:function(n,r,i){if(_.isEmpty(r.id))throw new Error("Undefined id passed to updateValuesSingle");if(_.isUndefined(t[n]))return null;var s=["id","_client_date_modified","_acl"];_.each(t[n]?t[n].fields:[],function(e){s.push(e.name)}),r=_.pick(r,s);var o=[],u=[],a=r.id,l=[],c=e.metadata.getModule(n).fields,h=this.updateRelationships(n,r,i);if(r.name){var p=e.offline.SqlHelper.relationships.buildSqlUpdateChildren(n,r);p&&_.each(p,function(e){l.push({sql:e,params:null})})}return _.isEmpty(h)||(l=l.concat(h)),delete r.id,delete r._module,delete r._search,_.isEmpty(r)?null:(_.each(r,function(e,t){u.push(t),o.push(f(e,t,n,c))}),o.push(a),l.push({sql:t[n].buildSqlUpdate(a,u),params:o}),{sql:l})},updateRelationships:function(t,n,r){var i=[],s=e.metadata.getModule(t).fields,o={};return _.each(n,function(t,n){if(s[n]&&s[n].link&&s[s[n].link]){var r=e.metadata.getRelationship(s[s[n].link].relationship);r&&!o[r.name]&&(o[r.name]=r,o[r.name].create=!!t)}}),_.each(o,function(s){var o=s.create?e.offline.SqlHelper.relationships.buildSqlReplaceRelationship:e.offline.SqlHelper.relationships.buildDeleteRelationship,u=s.rhs_module===t?s.lhs_module:s.rhs_module,a=o.call(e.offline.SqlHelper.relationships,u,{related:n,relatedId:n.id,relatedModule:t,relDef:s},_.extend({},r,{skipUpdateRelRecord:!0}));a&&!_.isArray(a)&&(a=[{sql:a}]),_.isEmpty(a)||_.each(a,function(e){i.push({sql:e.sql,params:null})})},this),i},hardDeleteSingle:function(n,r,i){var s=[],o=[];i=i||{};if(_.isUndefined(t[n]))return null;i.skipRelationshipsClean||(o=e.offline.SqlHelper.relationships.buildSqlCleanRelationships(n,r,i));var u=o.map(function(e){return{sql:e,params:null}}),a=s.concat({sql:t[n].sqlDelete,params:[r.id]},u);return{sql:a}},softDeleteSingle:function(e,n){return{sql:t[e].sqlMarkDeleted,params:[n.id]}},resetDeletedSingle:function(e,n){return t[e]?{sql:t[e].sqlResetDeleted,params:[n.id]}:null},createLink:function(n,r,i){return t[n]?{sql:e.offline.SqlHelper.relationships.buildSqlReplaceRelationship(n,r,i),params:null}:null},deleteLink:function(n,r,i){return t[n]?{sql:e.offline.SqlHelper.relationships.buildDeleteRelationship(n,r,i),params:null}:null},readTransactions:function(t,n,r){if(n&&n.id)return{sql:e.offline.SqlHelper.transactionLog.getTxLog,params:[n.id]};var i=[{sql:e.offline.SqlHelper.transactionLog.getReadTransactionsStatements(r),params:[r.offset||0,r.limit]}];return r.count&&i.push({sql:e.offline.SqlHelper.transactionLog.countTransactions}),{sql:i}},readToBeSynced:function(t,n,r){return{sql:e.offline.SqlHelper.sync.getReadToBeSyncedSql(t,n,r),params:null}},markToBeSynced:function(t,n,r){return{sql:e.offline.SqlHelper.sync.getMarkToBeSyncedSql(t,n,r),params:null}},resetToBeSynced:function(t,n,r){return{sql:e.offline.SqlHelper.sync.getResetToBeSyncedSql(t,n,r),params:null}},createTransaction:function(t,n,r){return{sql:e.offline.SqlHelper.transactionLog.sqlTxLogAction,params:e.offline.storage.getCUTransactionParams(t,n,r)}},updateTransaction:function(t,n,r){var i,s=n.txLog,o=["_tx_updated_fields","_tx_error","_tx_error_count","_tx_ts"];return r&&r.initialState&&(i=e.offline.storage.getCUTransactionParams(t,n.updatedFields,{action:s._tx_action,txId:s._tx_uid,initialState:r.initialState,relate:r.relate}),s._tx_updated_fields=i[6]),{sql:e.offline.SqlHelper.transactionLog.updateTransaction(s._tx_uid,_.pick(s,o))}},deleteTransaction:function(t,n,r){return{sql:e.offline.SqlHelper.transactionLog._deleteTransaction,params:[r.txId]}},clearTransactionLog:function(){return{sql:e.offline.SqlHelper.transactionLog.clearTransactionLog}},countAssociatedTransactions:function(t,n,r){return{sql:e.offline.SqlHelper.transactionLog.getCountAssociatedTransactionsStatements(r.txData)}},countTransactions:function(){return{sql:e.offline.SqlHelper.transactionLog.countTransactions}},readLastViewed:function(t,n,r){return r.ids?{sql:e.offline.SqlHelper.lastViewed.buildReadForRecords(r.ids)}:{sql:e.offline.SqlHelper.lastViewed.buildRead(r.desc),params:[r.max_num]}},readRecents:function(t,n,r){return{sql:e.offline.SqlHelper.lastViewed.buildReadForModule(t),params:[r.max_num]}},updateLastViewed:function(t,n,r){return{sql:e.offline.SqlHelper.lastViewed.buildReplace(t,n,r)}},deleteLastViewed:function(t,n,r){return{sql:e.offline.SqlHelper.lastViewed.buildDelete(t,n,r)}},findViewedBefore:function(t,n,r){return{sql:e.offline.SqlHelper.lastViewed.buildFindViewedBefore(t,r)}},getStats:function(t,n,r){return{sql:e.offline.SqlHelper.getStatsRetrieveStatements(r)}}},_deserialize:function(e,t){var r=_.clone(e);return _.each(r,function(e,i){_.isString(e)&&_.contains(n[t],i)&&(r[i]=JSON.parse(e))}),r._acl&&(r._acl=JSON.parse(r._acl)),r},_recordSetToArray:function(e,t){var n=[];if(e)for(var r=0;r<e.rows.length;r++)n.push(this._deserialize(e.rows.item(r),t));return n},getDetails:function(){var t=e.offline.storage.getDetails;return function(){return _.extend(t(),{dbName:i})}}()})}(SUGAR.App),function(e){e.offline.SyncExecutor=function(e){this.options=e,this.init()},_.extend(e.offline.SyncExecutor.prototype,{_working:!1,isWorking:function(){return this._working},_lastSyncTime:null,getLastSyncTime:function(){return this._lastSyncTime},init:function(){},shouldRun:function(){var t=this._lastSyncTime&&(new Date).getTime()-this._lastSyncTime.getTime()<this.options.interval*1e3;return!this.options.enabled||!e.api.isAuthenticated()||t?!1:!this._working},beforeSync:function(){this._working=!0},sync:function(e){if(!this.shouldRun()){e();return}this.beforeSync(),this._sync(_.bind(function(t){this.afterSync(),e.apply(this,arguments)},this))},afterSync:function(){this._lastSyncTime=new Date,this._working=!1},_sync:function(){e.offline.utils.notImplemented()},getPriority:function(){return this.options.priority},stop:function(){e.offline.utils.notImplemented()}}),e.offline.SyncExecutor.extend=Backbone.Model.extend}(SUGAR.App),function(e){e.offline.WinsSyncExecutor=e.offline.SyncExecutor.extend({SYNC_PHASES:{PRE_SYNC:1,SYNC:2},WINS_STATUS_CACHE_NAME:"sync:wins:status",_status:null,_stopAsyncFlow:null,_updateStatus:function(t){_.each(t,function(e,t){this._status[t]=e},this),e.cache.set(this.WINS_STATUS_CACHE_NAME,this._status)},_loadStatus:function(){var t=e.cache.get(this.WINS_STATUS_CACHE_NAME);t&&e.user.get("id")===t.userId?(this._status=t,this._status.winsStartedTime&&(this._status.winsInterruptedTimes++,this._updateStatus({winsInterruptedTimes:this._status.winsInterruptedTimes}))):this._resetStatus()},_resetStatus:function(){this._status={phase:this.SYNC_PHASES.PRE_SYNC,preSyncedModules:[],minDate:this._status&&this._status.maxDate||e.cache.get(e.offline.INITIALIZED_TS_KEY),maxDate:null,winsCompletedTime:null,winsStartedTime:null,winsInterruptedTimes:0,syncedRecords:0,userId:e.user.get("id")},this._updateStatus()},_sync:function(t){var n=this,r=function(r){e.logger.debug("WINS completed."),r?(n._status.winsInterruptedTimes++,n._updateStatus({winsInterruptedTimes:n._status.winsInterruptedTimes})):(n._updateStatus({winsCompletedTime:+(new Date)-n._status.winsStartedTime}),e.trigger("offline:wins:completed",_.pick(n._status,["winsCompletedTime","winsInterruptedTimes","syncedRecords"])),n._resetStatus()),t&&t(r)};this._loadStatus(),this._status.winsStartedTime||this._updateStatus({winsStartedTime:+(new Date)}),_.isEmpty(this._status.minDate)?(e.logger.debug("Skipping sync as last synced date is unknown. Fetching and saving current server time"),e.offline.utils.getServerTime(function(e,t){e||n._updateStatus({minDate:t}),r(e)})):this._status.phase===this.SYNC_PHASES.PRE_SYNC?this._preSync(function(e){e?r(e):(n._updateStatus({phase:n.SYNC_PHASES.SYNC}),n._recordsSync(r))}):this._recordsSync(r)},_preSync:function(t){var n=this,r=[];_.isEmpty(this._status.maxDate)&&r.push(function(t){e.offline.utils.getServerTime(function(e,r){e?t(e):(n._updateStatus({maxDate:r}),t())})});var i=_.difference(e.offline.utils.getOfflineModules(),this._status.preSyncedModules,_.keys(e.config.offline.prefetch.staticModules));i=_.filter(i,function(t){return e.acl.hasAccess("list",t)}),i.length!==0&&_.each(i,function(e){r.push(function(t){n._preSyncModule(e,t)})},this),this._stopAsyncFlow=e.offline.utils.getStoppableAsyncFlow("series",r,t)},_preSyncModule:function(t,n){var r=this,i={fields:"id",deleted:!0,filter:[{date_modified:{$gte:this._status.minDate,$lt:this._status.maxDate}}]};e.offline.utils.fetchPageByPage(t,i,_.bind(this._markLocalRecordsToBeUpdated,this),null,{maxRecords:this.options.preSyncMaxRecords,pageSize:this.options.preSyncPageSize,callback:function(e){e||(r._status.preSyncedModules.push(t),r._updateStatus({preSyncedModules:r._status.preSyncedModules})),n(e)}})},_markLocalRecordsToBeUpdated:function(t){this._processLocalMatchedRecords(t,function(n,r,i){e.offline.storage.markToBeSynced({module:t.module,action:r.deleted?"delete":"update",record:n,callback:i})})},_recordsSync:function(t){var n=this,r=[];_.each(e.offline.utils.getOfflineModules(),function(e){r.push(function(t){n._syncModule(e,t)})},this),this._stopAsyncFlow=e.offline.utils.getStoppableAsyncFlow("series",r,t)},_syncModule:function(t,n){var r=this;e.offline.storage.readToBeSynced({offset:0,max_num:this.options.syncPageSize||20,module:t,callback:function(e){e.records.length!==0?r._syncRecords({module:t,records:e.records,callback:function(i){i?n(i):(r._status.syncedRecords+=e.records.length,r._updateStatus({syncedRecords:r._status.syncedRecords}),r._syncModule(t,n))}}):n()}})},_syncRecords:function(t){var n=_.map(t.records,function(e){return{id:e.bean_id,module:e.bean_module,action:e.action}}),r=t.module,i=_.filter(n,function(e){return e.action==="update"}),s=_.filter(n,function(e){return e.action==="delete"}),o=[];if(i.length>0){var u=_.pluck(i,"id"),a=e.metadata.getModule(r).mergedFields,f={filter:[{id:{$in:u}}]};_.isEmpty(a)||(f.fields=a.join(",")),o.push(function(t){e.offline.api.callOriginalApi("records",["read",r,null,f,{success:function(n){n=n||{records:[]},e.offline.storage.saveRecords({serverData:n.records,module:r,callback:function(n){if(n)return t(n);e.offline.storage.resetToBeSynced({records:i,callback:t})}})},error:t}])})}s.length>0&&_.each(s,function(t){o.push(function(n){e.offline.storage.readSingleRawRecord(r,{id:t.id},{success:function(t){t&&e.offline.utils.isDataSynchronized(t)?e.offline.storage.sync("delete",{id:t.id},r,{hardDelete:!0,success:function(){e.offline.storage.resetToBeSynced({records:s,callback:n})},error:n}):e.offline.storage.resetToBeSynced({records:s,callback:n})},error:n})})}),async.series(o,t.callback)},_processLocalMatchedRecords:function(t,n){var r=_.pluck(t.records,"id"),i=t.module;e.offline.storage.readRecordsByIds(i,r,{success:function(e){if(_.isEmpty(e))return t.callback();e=_.isArray(e)?e:[e];var r=[];_.each(e,function(e){r.push(function(r){var i=_.find(t.records,function(t){return t.id===e.id});n(e,i,r)})}),async.series(r,t.callback)},error:t.callback})},stop:function(){this._stopAsyncFlow&&(this._stopAsyncFlow(),this._stopAsyncFlow=null,e.logger.debug("WinsSync interrupted"))}})}(SUGAR.App),function(e){e.offline.TxLogSyncExecutor=e.offline.SyncExecutor.extend({SYNC_ITERATION_COMPLETE_MESSAGE:"sync_iteration_complete",_immediateStop:!1,_getBeanStub:function(e){return{id:e._tx_bean_id,module:e._tx_bean_module,related_id:e._tx_related_id,related_module:e._tx_related_module}},_sync:function(t){function i(){if(n._immediateStop)return n._immediateStop=!1,e.logger.debug("TxLogSync interrupted"),r();n._syncOldestTransaction(function(e){e?r(e):i()})}var n=this,r=function(r){e.logger.debug("TxLogSync completed"),r===n.SYNC_ITERATION_COMPLETE_MESSAGE&&(r=null),t(r)};i()},_syncOldestTransaction:function(t){var n=this;e.offline.storage.readTransactions({limit:1,dateAsc:!0,error:t,success:function(r){if(!r)return t(n.SYNC_ITERATION_COMPLETE_MESSAGE);var i=n._getBeanStub(r);e.offline.storage.readSingleRawRecord(i.module,i,{success:function(s){s=s||{};var o=r._tx_updated_fields?JSON.parse(r._tx_updated_fields):{},u={};r._tx_action!==e.offline.SYNC_ACTIONS.LINK&&r._tx_action!==e.offline.SYNC_ACTIONS.UNLINK&&(_.each(o,function(e,t){u[t]=e.after}),r._tx_action!==e.offline.SYNC_ACTIONS.CREATE&&(u.date_modified=s.date_modified||e.utils.getTimestamp()),u.id=s.id||i.id),n._handleSyncTransaction(r,t,u),u={}},error:t})}})},_handleSyncTransaction:function(t,n,r){var i,s={id:t._tx_bean_id,module:t._tx_bean_module,related_id:t._tx_related_id,related_module:t._tx_related_module};if(t._tx_action===e.offline.SYNC_ACTIONS.CREATE||t._tx_action===e.offline.SYNC_ACTIONS.LINK)i="create";else if(t._tx_action===e.offline.SYNC_ACTIONS.UPDATE)i="update";else if(t._tx_action===e.offline.SYNC_ACTIONS.DELETE||t._tx_action===e.offline.SYNC_ACTIONS.UNLINK)i="delete";else if(t._tx_action===e.offline.SYNC_ACTIONS.FAVORITE)i="favorite";else{if(t._tx_action!==e.offline.SYNC_ACTIONS.FOLLOW)throw new Error("Undefined action in transaction log!");i="follow"}t._tx_related_id&&t._tx_related_module?this._syncRelationships(i,s,t,n,r):i==="favorite"?this._syncFavorite(i,s,t,n,r):i==="follow"?this._syncFollow(i,s,t,n,r):this._syncRecords(i,s,t,n,r)},_syncRecords:function(t,n,r,i,s){var o={};s=this._addXTimestampHeader(s,o),e.offline.api.callOriginalApi("records",[t,n.module,s,{viewed:!0},{success:function(t){e.offline.storage.resolveSuccess({module:n.module,transaction:r,serverData:t,callback:i})},error:function(t){e.offline.storage.resolveError({error:t,updatedFields:s,txLog:r,callback:i})}},o])},_syncRelationships:function(t,n,r,i,s){var o={};s=this._addXTimestampHeader(s,o);var u={id:n.related_id,link:r._tx_link,related:s?s:{id:n.id},relatedId:n.id};r._tx_action===e.offline.SYNC_ACTIONS.CREATE&&(u.relatedId=null),e.offline.api.callOriginalApi("relationships",[t,n.related_module,u,{},{success:function(t){var s=_.extend(u,{related:t.related_record,record:t.record,recordModule:n.related_module,relatedModule:n.module});e.offline.storage.resolveSuccess({module:r._tx_related_module,transaction:r,serverData:t,relationshipData:s,callback:i})},error:function(t){e.offline.storage.resolveError({error:t,updatedFields:s,txLog:r,callback:i})}},o])},_syncFavorite:function(t,n,r,i,s){e.offline.api.callOriginalApi("favorite",[n.module,n.id,s.my_favorite,{success:function(t){e.offline.storage.resolveSuccess({module:n.module,transaction:r,serverData:t,callback:i})},error:function(t){e.offline.storage.resolveError({error:t,updatedFields:s,txLog:r,callback:i})}}])},_syncFollow:function(t,n,r,i,s){e.offline.api.callOriginalApi("follow",[n.module,n.id,s.following,{success:function(){e.offline.storage.resolveSuccess({module:n.module,transaction:r,serverData:{id:n.id,following:s.following},callback:i})},error:function(t){e.offline.storage.resolveError({error:t,updatedFields:s,txLog:r,callback:i})}}])},_addXTimestampHeader:function(e,t){return e&&e.date_modified&&(t.headers={"X-TIMESTAMP":e.date_modified},e=_.omit(e,"date_modified")),e},stop:function(){this._immediateStop=!0}})}(SUGAR.App),function(e){var t={my_items:{$owner:"_this"},favorites:{$favorite:"_this"},following:{$following:"_this"}},n="No records found using this filter",r="%";e.offline.syncManager.recordsPreloader={_requestTime:0,start:function(t){var n=this;e.trigger("offline:prefetch:start"),t=t||{};var r=t.callback;_.extend(t,{callback:function(t){t?e.logger.error("Prefetch failed. "+t):e.logger.debug("Successfully prefetched modules"),n._requestTime=0,e.trigger("offline:prefetch:complete",t),r&&r(t)}}),_.isEmpty(t.relatedModules)?(_.isEmpty(t.modules)&&(t.modules=e.config.offline.prefetch.staticModules),t.filter=this._getPreparedFilterParams(t.filter),this._prefetch(t)):this.preloadRelationships(t)},preloadRelationships:function(t){var n=this,r=[],i=e.config.offline.prefetch.relationships.pageSize,s=t.relatedModules;_.each(t.filter,function(e){t[e]=1}),_.each(s,function(s,o){r.push(function(r){async.waterfall([function(r){e.offline.storage.sync("read",undefined,o,_.extend(t,{max_num:s.maxThreshold,selectFields:"id",filterCondition:"or",success:function(e){r(null,e)},error:r}))},function(r,u){var a=e.offline.utils.paginate(r,i),f=s.relationships;n._fetchRelatedModules({relatedModules:f,parentModule:o,pagedRecords:a,pageSize:i,callback:u})}],r)})}),async.series(r,t.callback)},_fetchRelatedModules:function(t){var n=[],r=this;if(_.isEmpty(t.pagedRecords))return t.callback(null);_.each(t.pagedRecords,function(i){var s={},o={};_.each(t.relatedModules,function(t,n){var r={};r[t.rhs_key]={$in:_.pluck(i,"id")},s[n]=[r],o[n]=e.config.offline.prefetch.relationships.maxThreshold}),n.push(function(e){r._prefetch({modules:o,parentModule:t.parentModule,relatedModules:t.relatedModules,callback:e,filter:s,skipRecordsCount:!0,pageSize:t.pageSize})})}),async.series(n,t.callback)},_prefetch:function(t){var r=[],i=this,s=t.modules;_.each(s,function(s,o){if(!e.metadata.getModule(o)||!e.acl.hasAccess("list",o)){e.logger.debug("Skipping prefetch of "+o+". Either metadata is missing or no access is given");return}r.push(function(r){var u;u=[function(r){t.skipRecordsCount?r(null,null,e.config.offline.prefetch.maxThreshold):i._calculateEstimatedTimePerModule(o,t,function(t,i,s){t?(e.logger.error("Calculating estimated prefetching time failed in module "+o+"."+t),r(t)):s?(e.logger.debug("Successfully calculated prefetching time for module "+o+". Estimated time is "+i),r(t,i,s)):r(n)})},function(e,n,r){i._prefetchModule(_.extend({},t,{maxRecords:s,moduleName:o,estimatedTime:e,recordsCount:n,callback:r}))}],async.waterfall(u,function(e){e===n?r():r(e)})})},this),async.series(r,function(n){n&&e.error.handleHttpError(n),t.callback&&t.callback(n)})},_prefetchModule:function(t){var n=t.pageSize||e.config.offline.prefetch.pageSize,r=0,i=this,s=+(new Date),o=t.maxRecords||e.config.offline.prefetch.maxThreshold,u=t.recordsCount,a=t.moduleName,f=e.metadata.getModule(a,"mergedFields"),l,c,h,p,d;u&&u<o?c=u:c=o,l={max_num:n,offset:r,fields:f.join(",")},t.filter&&(l.filter=t.filter[a]||t.filter),h=function(t){e.offline.storage.saveRecords.call(e.offline.storage,{module:t.module,serverData:t.records,callback:t.callback})},p=function(e){var n=+(new Date),r;i._requestTime=n-s,r=i._getEstimatedTime(c-e),d=i._getProgressValue(e,c),i._processPrefetchProgress(_.extend({},t,{estimatedTime:r,progressValue:d})),s=n},i._processPrefetchProgress(_.extend({},t,{estimatedTime:t.estimatedTime,progressValue:i._getProgressValue(r,c)})),e.offline.utils.fetchPageByPage(a,l,h,null,{callback:t.callback,maxRecords:c,pageSize:n,iterator:p})},_processPrefetchProgress:function(t){var n=_.extend({},t,{estimatedTime:t.estimatedTime,module:t.moduleName});n.progressValue=t.parentModule?"":t.progressValue+r,e.trigger("offline:prefetch:progress",n)},_calculateEstimatedTimePerModule:function(t,n,r){var i=this;i._requestTime?i._getRecordsCount(t,n,r):e.offline.utils.ping(function(e,s){i._requestTime=s,i._getRecordsCount(t,n,r)})},_getEstimatedTime:function(t){var n=e.config.offline.prefetch.pageSize||20;return this._requestTime&&(t/n/1e3*this._requestTime).toFixed(2)},_getRecordsCount:function(t,n,r){var i=this;e.api.call("create",e.api.buildURL(t,"filter/count"),{filter:n.filter},{success:function(e){var t=parseInt(e.record_count,10);r(null,i._getEstimatedTime(t),t)},error:function(e){r(e)}})},_getPreparedFilterParams:function(e){var n=[];if(_.isEmpty(e))return;return _.each(e,function(e){t[e]&&n.push(t[e])}),[{$or:n}]},_getProgressValue:function(e,t){return e>t&&(e=t),Math.round(e/t*100)}}}(SUGAR.App),function(e){_.extend(e.offline,{declareOfflineBean:function(){var t=e.data.beanModel.prototype.save;return e.OfflineBean=e.data.beanModel.extend({save:function(e,n){if(n&&n.fields&&_.contains(n.fields,"email")){var r,i;r=_.find(this.attributes,function(e,t){return this.fields[t]&&this.fields[t].type==="email"},this),r&&(i=_.find(r,function(e){return e.primary_address}),i&&(n.fields.push("email1"),this.attributes.email1=i.email_address))}t.apply(this,arguments)}}),e.OfflineBean}})}(SUGAR.App),function(e){_.extend(e.offline,{declareOfflineBeanCollection:function(){var t=e.data.beanCollection;return e.OfflineBeanCollection=e.data.beanCollection.extend({initialize:function(t,n){this.cid=_.uniqueId("c"),e.BeanCollection.prototype.initialize.apply(this,arguments)},fetch:function(e){e=e||{},e.params=e.params||{};if(e.query||this.query)e.params.serverSyncSuccess=_.bind(this._mergeCollection,this);return t.prototype.fetch.call(this,e)},_mergeCollection:function(t,n){if(n.q!==this.query||!!this.favorites!=!!n.favorites||!!this.myItems!=!!n.my_items)return;var r=t.records,i=t.next_offset,s=_.filter(r,function(t){var n=this.get(t.id);return!n||!!e.offline.utils.isDataSynchronized(n)},this);this.update(s,{remove:!1}),this.offset=i!==-1?i:this.offset+(r||[]).length,this.next_offset=i}}),e.OfflineBeanCollection}})}(SUGAR.App),function(e){_.extend(e.offline,{declareOfflineMixedBeanCollection:function(){return e.OfflineMixedBeanCollection=e.MixedBeanCollection.extend({fetch:function(t){t=t||{},t.params=t.params||{};if(t.query||this.query)t.params.serverSyncSuccess=_.bind(e.OfflineBeanCollection.prototype._mergeCollection,this);e.MixedBeanCollection.prototype.fetch.call(this,t)}}),e.OfflineMixedBeanCollection}})}(SUGAR.App),function(e){Handlebars.registerHelper("field",function(t,n){var r=e.view.createField({def:this,view:t,model:n.hash.model,viewName:n.hash.template});return n.hash.parent&&_.isArray(n.hash.parent.fields)&&n.hash.parent.fields.push(r),r.getPlaceholder()}),Handlebars.registerHelper("fieldOfType",function(t,n){var r={type:t,name:t,label:n},i=e.view.createField({def:r,view:this});return i.getPlaceholder()}),Handlebars.registerHelper("eachOptions",function(t,n){var r,i="",s;return r=_.isString(t)?e.lang.getAppListStrings(t):t,_.isArray(r)?s=function(e,t){i+=n.fn({key:t,value:e})}:_.isObject(r)?s=function(e,t){i+=n.fn({key:t,value:e})}:r=null,r&&_.each(r,s,this),i}),Handlebars.registerHelper("buildRoute",function(t){var n=t.hash.context,r=t.hash.model||(n&&n.get("model")?n.get("model"):{}),i=t.hash.module||r.module||(n&&n.get("module")?n.get("module"):null),s=t.hash.id||r.id,o=t.hash.action;return e.router.buildRoute(i,s,o)}),Handlebars.registerHelper("getFieldValue",function(t,n,r){return e.logger.warn("getFieldValue handlebars helper is deprecated and will be removed in 7.8. Please use the fieldValue handlebars helper instead."),r=_.isObject(r)?"":r,t.get(n)||r||""}),Handlebars.registerHelper("fieldValue",function(e,t,n){return e.get(t)||n.hash.defaultValue||""}),Handlebars.registerHelper("has",function(e,t,n){return!_.isArray(t)&&!_.isObject(t)&&(t=[t]),_.include(t,e)?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notHas",function(e,t,n){var r=n.fn,i=n.inverse;return n.fn=i,n.inverse=r,Handlebars.helpers.has.call(this,e,t,n)}),Handlebars.registerHelper("isSortable",function(t,n,r){return e.utils.isSortable(t,n)?r.fn(this):""}),Handlebars.registerHelper("eq",function(e,t,n){return e==t?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notEq",function(e,t,n){return e!=t?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("match",function(e,t,n){var r=new RegExp(t);return r.test(e)?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notMatch",function(e,t,n){var r=new RegExp(t);return r.test(e)?n.inverse(this):n.fn(this)}),Handlebars.registerHelper("log",function(t){e.logger.debug("*****HBS: Current Context*****"),e.logger.debug(this),e.logger.debug("*****HBS: Current Value*****"),e.logger.debug(t),console.log(t),e.logger.debug("***********************")}),Handlebars.registerHelper("str",function(t,n,r){return n=_.isString(n)?n:null,e.lang.get(t,n,r)}),Handlebars.registerHelper("timeago",function(t,n){e.logger.warn("The helper `timeago` is deprecated since 7.2.0. Please upgrade your code to use `relativeTime`.");var n=_.isString(n)?" data-label='"+n+"' ":"",r=e.date(t).formatUser(),i='<span class="relativetime" '+n+' title="'+t+'">'+r+"</span>";return new Handlebars.SafeString(i)}),Handlebars.registerHelper("relativeTime",function(t,n){var r=e.date(t),i,s;return n.hash.title=n.hash.title||r.formatUser(n.hash.dateOnly),i=_.map(n.hash,function(e,t){return t+'="'+Handlebars.Utils.escapeExpression(e)+'"'}).join(" "),s='<time datetime="'+r.format()+'" '+i+">"+r.fromNow()+"</time>",new Handlebars.SafeString(s)}),Handlebars.registerHelper("arrayJoin",function(e,t){return e.join(t)}),Handlebars.registerHelper("nl2br",function(e){e=Handlebars.Utils.escapeExpression(e);var t=e.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br>");return new Handlebars.SafeString(t)}),Handlebars.registerHelper("formatCurrency",function(t,n){return _.isObject(n)&&(n=n.hash.currencyId||undefined),e.currency.formatAmountLocale(t,n)}),Handlebars.registerHelper("firstChars",function(e,t){return e.substring(0,t)}),Handlebars.registerHelper("formatDate",function(t,n){var t=e.date(t);return t.formatUser(n.hash.dateOnly)}),Handlebars.registerHelper("getModuleName",function(t,n){var n={plural:n.hash.plural,defaultValue:n.hash.defaultValue};return e.lang.getModuleName(t,n)}),Handlebars.registerHelper("partial",function(t,n,r){var i,s,o;r=r||{},r.hash=r.hash||{},n=n||this,o=r.hash.component||this,i=r.hash.module||o.module;if(o&&o.options.templateOptions&&o.options.templateOptions.partials)s=o.options.templateOptions.partials[t];else if(o instanceof e.view.Field){var u=r.hash.fallbackTemplate;s=e.template.getField(o.type,t||"detail",i,u)}else if(o instanceof e.view.View){var a=o.tplName||o.name;s=e.template.getView(a+"."+t,i)||e.template.getView(a+"."+t)}else o instanceof e.view.Layout&&(s=e.template.getLayout(o.name+"."+t,i)||e.template.getLayout(o.name+"."+t));return new Handlebars.SafeString(s?s(n):"")})}(SUGAR.App),function(e){var t=0,n=[],r={reset:function(){_.each(this.layouts,function(e,t){delete this.layouts[t]},this),_.each(this.views,function(e,t){delete this.views[t]},this),_.each(this.fields,function(e,t){delete this.fields[t]},this)},getFieldId:function(){return t},views:{},layouts:{},fields:{},_createComponent:function(e,t,n){var r=this.declareComponent(e,n.type||t,n.module,n.controller,!1,this._getPlatform(n)),i=new r(n);return i.trigger("init"),i.bindDataChange(),i},createView:function(t){return t.context=t.context||e.controller.context,t.module=t.module||t.context.get("module"),t.meta=t.meta||e.metadata.getView(t.module,t.name),t.type=t.type||(t.meta&&t.meta.type?t.meta.type:t.name||null),this._createComponent("view",t.name,t)},createLayout:function(t){return t.context=t.context||e.controller.context,t.module=t.module||t.context.get("module"),t.meta=t.meta||e.metadata.getLayout(t.module,t.name),t.type=t.type||(t.meta?t.meta.type:null),this._createComponent("layout",t.name||t.type,t)},createField:function(n){var r=n.def.type;n.context=n.context||n.view.context||e.controller.context,n.model=n.model||n.context.get("model"),n.module=n.module||(n.model&&n.model.module?n.model.module:n.context.get("module"))||"",n.meta=n.meta||e.metadata.getField(r,n.module),n.meta&&n.meta.controller&&(n.controller=n.meta.controller),n.sfId=++t;var i=this._createComponent("field",r,n);return n.view.fields[i.sfId]=i,i},_getPlatform:function(t){return t.platform||(e.config&&e.config.platform?e.config.platform:"base")},_getController:function(e){var t=this._getBaseComponent(e.type,e.name,e.module,e.platform);return t.cache[t.moduleBasedClassName]?t.cache[t.moduleBasedClassName]:t.baseClass},invokeParent:function(t,n){var r,i;return n=n||{},(!t||!n.type||!n.name||!n.method||n.args&&!_.isArray(n.args))&&e.logger.error("view-manager's invoke method requires a context, params.type, params.name, params.method; if params.args is supplied it must be of type array."),r=this._getController(n),r?(t._superStack=t._superStack||{},t._superStack[n.method]=t._superStack[n.method]||[],t._superStack[n.method].push(r.prototype),i=r.prototype[n.method].apply(t,n.args),t._superStack[n.method].pop(),i):e.logger.error("invokeParent: Unable to load controller for "+n.type+":"+n.name)},componentHasPlugin:function(t){var n;return!t.type||!t.name||!t.plugin?(e.logger.error("componentHasPlugin requires type, name, and plugin parameters"),null):(n=this._getController(t),n&&n.prototype&&_.contains(n.prototype.plugins,t.plugin))},declareComponent:function(t,n,r,i,s,o){var u=this._getBaseComponent(t,n,r,o,s&&i);return s&&i&&u.cache[u.moduleBasedClassName]&&delete u.cache[u.moduleBasedClassName],u.cache[u.moduleBasedClassName]||e.utils.extendClass(u.cache,u.baseClass,u.moduleBasedClassName,i,u.platformNamespace)||u.baseClass},_getBaseComponent:function(t,n,r,i,s){i=this._getPlatform({platform:i});var o=e.utils.capitalize(t),u=e.utils.capitalize(i),a=e.utils.capitalizeHyphenated(n)+o,f=u+(r||"")+a,l=u+(r||"")+"Custom"+a,c=e.view[t+"s"],h=e.utils.capitalize(e.config.appId)+o,p=c[u+"Custom"+a]||c[u+a]||c["BaseCustom"+a]||c["Base"+a]||c[a]||c["BaseBase"+o]||e.view["Custom"+h]||e.view[h]||e.view[o];return c[l]&&!s&&(f=l),{cache:c,platformNamespace:u,moduleBasedClassName:f,baseClass:p}}};e.augment("view",r,!1)}(SUGAR.App),function(e){e.view.Component=Backbone.View.extend({initialize:function(t){this.context=t.context||e.controller.context,this.meta=t.meta,this.module=t.module||this.context.get("module"),this.model=t.model||this.context.get("model"),this.collection=t.collection||this.context.get("collection"),this.meta&&this.meta.css_class&&this.$el.addClass(this.meta.css_class),e.user.lastState.register(this)},_render:function(){return this},render:function(){return this.disposed===!0?(e.logger.error("Unable to render component because it's disposed "+this+"\n"),!1):this.triggerBefore("render")?(this._render(),this.trigger("render"),this):!1},setTemplateOption:function(e,t){this.options=this.options||{},this.options.templateOptions=this.options.templateOptions||{},this.options.templateOptions[e]=_.extend({},this.options.templateOptions[e],t)},bindDataChange:function(){},unbindData:function(){this.model&&this.model.off(null,null,this),this.collection&&this.collection.off(null,null,this)},unbind:function(){this.off(),this.offBefore(),this.undelegateEvents(),e.events.off(null,null,this),e.events.unregister(this),this.context&&this.context.off(null,null,this),this.layout&&this.layout.off(null,null,this)},loadData:function(){},_dispose:function(){this.unbindData(),this.unbind(),this.remove(),this.model=null,this.collection=null,this.context=null,this.$el=null,this.el=null},dispose:function(){if(this.disposed===!0)return;this._dispose(),this.disposed=!0},toString:function(){return this.cid+"-"+(this.$el&&this.$el.id?this.$el.id:"<no-id>")+"/"+this.module+"/"+this.model+"/"+this.collection},closestComponent:function(e){},show:function(){if(!this.isVisible()){if(!this.triggerBefore("show"))return!1;this.$el.removeClass("hide").show(),this.trigger("show")}},hide:function(){if(this.isVisible()){if(!this.triggerBefore("hide"))return!1;this.$el.addClass("hide").hide(),this.trigger("hide")}},isVisible:function(){return this.$el.css("display")!=="none"},_super:function(t,n){if(!t||!_.isString(t))return e.logger.error("tried to call _super without specifying a parent method in "+this.name);var r,i=null,s=Object.getPrototypeOf(this);n=n||[],this._superStack=this._superStack||{},this._superStack[t]=this._superStack[t]||[];if(this._superStack[t].length>0){r=Object.getPrototypeOf(_.last(this._superStack[t]));if(_.contains(this._superStack[t],r))return e.logger.error("Loop detected calling "+t+" from "+this.name)}else r=Object.getPrototypeOf(s);if(!s[t])return e.logger.error("Unable to find method "+t+" on class "+this.name);while(!r.hasOwnProperty(t)&&r!==e.view.Component.prototype)r=Object.getPrototypeOf(r);while(s[t]===r[t]&&r!==e.view.Component.prototype)s=r,r=Object.getPrototypeOf(r);this._superStack[t].push(r);if(!r)return e.logger.error("Unable to find parent of component "+this.name);if(!r[t])return e.logger.error("Unable to find method "+t+" on parent class of "+this.name);var o=r[t].apply(this,n);return this._superStack[t].pop(),_.isEmpty(this._superStack[t])&&(this._superStack[t]=null),o}}),_.extend(e.view.Component.prototype,e.beforeEvent)}(SUGAR.App),function(e){e.view.View=e.view.Component.extend({initialize:function(t){e.plugins.attach(this,"view"),e.view.Component.prototype.initialize.call(this,t),this.name=t.name,this.action=t.meta&&t.meta.action?t.meta.action:this.name,this._loadTemplate(t),this.fields={},this.fallbackFieldTemplate=this.fallbackFieldTemplate||"detail",this.layout=this.options.layout,this.primary=t.primary,this._setLabels(),e.events.on("app:locale:change",function(){this._setLabels()},this)},_loadTemplate:function(t){var n,r;(n=t&&t.template)?r=null:(n=this.meta&&this.meta.template&&e.template.getView(this.meta.template))?r=this.meta.template:(n=e.template.getView(this.name,this.module)||e.template.getView(this.name))?r=this.name:(n=this.meta&&this.meta.type&&e.template.getView(this.meta.type))?r=this.meta.type:(n=e.template.empty,r=""),this.tplName=r,this.template=n},getTemplateFromMeta:function(t){return e.logger.warn("`getTemplateFromMeta` is deprecated since 7.7 and will be removed in 7.8."),t.meta&&t.meta.template?e.template.getView(t.meta.template):null},_renderHtml:function(t,n){if(this.template)try{this.$el.html(this.template(t||this,n||this.options.templateOptions)),this.delegateEvents()}catch(r){e.logger.error("Failed to render "+this+"\n"+r),e.error.handleRenderError(this,"_renderHtml")}},_renderFields:function(){var e=this,t={};this.$("span[sfuuid]").each(function(){var e=$(this),n=e.attr("sfuuid");t[n]=e}),_.each(this.fields,function(n){e._renderField(n,t[n.sfId])})},_renderField:function(t,n){t.setElement(n||this.$("span[sfuuid='"+t.sfId+"']"));try{t.render()}catch(r){e.logger.error("Failed to render "+t+" on "+this+"\n"+r),e.error.handleRenderError(this,"_renderField",t)}},_render:function(){return e.acl.hasAccessToModel(this.action,this.model)?(this._disposeFields(),this._renderHtml(),this._renderFields()):(e.logger.info("Current user does not have access to this module view. name: "+this.name+" module:"+this.module),this.primary&&e.error.handleRenderError(this,"view_render_denied")),this},_setLabels:function(){this.modulePlural=e.lang.getAppListStrings("moduleList")[this.module]||this.module,this.moduleSingular=e.lang.getAppListStrings("moduleListSingular")[this.module]||this.modulePlural},loadData:function(t,n){e.acl.hasAccess("read",this.module)&&(n=_.isUndefined(n)?!0:n,n&&this.context.set("fields",this.getFieldNames()),this.context.loadData(t))},getFieldNames:function(t,n){var r=[];t=t||this.context.get("module"),this.meta&&this.meta.panels&&(r=_.reduce(_.map(this.meta.panels,function(e){var t=_.flatten(_.compact(_.pluck(e.fields,"fields")));return _.pluck(e.fields,"name").concat(_.pluck(t,"name")).concat(_.flatten(_.compact(_.pluck(e.fields,"related_fields"))))}),function(e,t){return e.concat(t)},[])),r=_.compact(_.uniq(r));var i=e.metadata.getModule(t,"fields");if(i){r=_.reject(r,function(e){return _.isUndefined(i[e])});var s=[];_.each(r,function(e){i[e].type=="relate"?s.push(i[e].id_name):i[e].type=="parent"&&(s.push(i[e].id_name),s.push(i[e].type_name)),_.isArray(i[e].fields)&&(s=s.concat(i[e].fields))}),r=_.union(r,s)}return r},getFields:function(e,t){var n={},r=this.getFieldNames(e);return _.each(r,function(e){var r=this.getField(e,t);r&&(n[e]=r.def)},this),n},getField:function(e,t){return _.find(this.fields,function(n){return n.name==e&&(!t||n.model==t)})},closestComponent:function(e){if(!this.layout)return;return this.layout.name===e?this.layout:this.layout.closestComponent(e)},_dispose:function(){e.plugins.detach(this,"view"),this._disposeFields(),e.view.Component.prototype._dispose.call(this)},_disposeFields:function(){_.each(this.fields,function(e){e.dispose()}),this.fields={}},toString:function(){return"view-"+this.name+"-"+e.view.Component.prototype.toString.call(this)},getFieldMeta:function(e){var t=_.find(_.flatten(_.pluck(this.meta.panels,"fields")),function(t){return t.name==e});return t},setFieldMeta:function(e,t){_.each(this.meta.panels,function(n){_.each(n.fields,function(r,i){r.name==e&&(n.fields[i]=_.extend(r,t))})})}})}(SUGAR.App),function(e){e.view.Layout=e.view.Component.extend({initialize:function(t){e.plugins.attach(this,"layout"),e.view.Component.prototype.initialize.call(this,t),this._components=[],this.meta=this.meta||{},this.type=this.meta.type||this.options.type,this.name=this.meta.name||this.options.name||this.type||"",this.meta.label?this.label=this.meta.label:this.options.def&&this.options.def.label?this.label=this.options.def.label:this.options.label?this.label=this.options.label:this.label="",this.template=e.template.getLayout(this.name,this.module)||e.template.getLayout(this.type,this.module)||e.template.getLayout(this.name)||e.template.getLayout(this.type),this.template&&this.$el.html(this.template(this,t)),this.layout=this.options.layout,this._addComponentsFromDef(this.meta.components),this.trigger("init"),e.events.on("app:locale:change",function(){this.render()},this)},createComponentFromDef:function(t,n,r){n=n||this.context,r=r||this.module,t.context&&(t.context instanceof e.Context?n=t.context:(n=n.getChildContext(t.context),n.prepare()),r=n.get("module"));if(t.view){if(_.isString(t.view))return e.view.createView({context:n,name:t.view,module:r,primary:t.primary,layout:this});if(_.isObject(t.view))return e.view.createView({context:n,module:r,meta:t.view.meta||t.view,name:t.view.name||t.view.type||"",primary:t.view.primary,layout:this})}else if(t.layout){if(_.isString(t.layout))return e.view.createLayout({context:n,name:t.layout,def:t,module:r,layout:this});if(_.isObject(t.layout))return e.view.createLayout({context:n,module:r,meta:t.layout.meta||t.layout,name:t.layout.name||t.layout.type||"",def:t,layout:this})}else e.logger.warn("Invalid layout definition:\n"+t.layout)},_addComponentsFromDef:function(e,t,n){_.each(e||{},function(e){(e.view||e.layout)&&this.addComponent(this.createComponentFromDef(e,t,n),e)},this)},addComponent:function(e,t){e.layout||(e.layout=this),this._components.push(e),this._placeComponent(e,t)},_placeComponent:function(e){this.$el.append(e.el)},removeComponent:function(e){var t=_.isNumber(e)?e:this._components.indexOf(e);if(t>-1){var n=this._components.splice(t,1);n[0].layout=null}},getComponent:function(e){return _.find(this._components,function(t){return t.name===e})},_render:function(){return this._components&&this._components.length>0?_.each(this._components,function(e){e.render()},this):e.logger.info("Can't render anything because the layout has no components: "+this.toString()+"\n"+"Either supply metadata or override Layout.render method"),this},loadData:function(e,t){if(this.disposed)return;t=_.isUndefined(t)?!0:t,t&&this.context.set("fields",this.getFieldNames()),this.context.loadData(e),_.each(this._components,function(t){t.loadData(e,t.context!=this.context)},this)},getFieldNames:function(e){var t=[];return e=e||this.module,_.each(this._components,function(n){n.module==e&&(t=_.union(t,n.getFieldNames(null,!0)))},this),t},getFields:function(e){var t={};return _.each(this._components,function(n){_.extend(t,n.getFields(e))}),t},closestComponent:function(e){if(!this.layout)return;return this.layout.name===e?this.layout:this.layout.closestComponent(e)},_dispose:function(){e.plugins.detach(this,"layout"),_.each(this._components,function(e){e.dispose()}),this._components=[],e.view.Component.prototype._dispose.call(this)},toString:function(){return"layout-"+(this.options.type||this.options.name)+"-"+e.view.Component.prototype.toString.call(this)}})}(SUGAR.App),function(e){e.view.Field=e.view.Component.extend({fieldTag:"input",initialize:function(t){e.plugins.attach(this,"field"),e.view.Component.prototype.initialize.call(this,t),this.sfId=t.sfId,this.view=t.view,this.name=this.options.def.name,this.type=this.options.def.type;if(this.model&&this.model.fields){var n=_.clone(this.model.fields[this.name]);this.def=n?_.extend(n,t.def):t.def}else this.def=this.options.def;this.label=e.lang.get(this.def.label||this.def.vname||this.name,this.module),this.template=e.template.empty,this.model&&(this.model.on("error:validation:"+this.name,this.handleValidationError,this),this.model.on("validation:start attributes:revert",this.removeValidationErrors,this))},viewFallbackMap:{edit:"detail"},_checkAccessToAction:function(t){return e.acl.hasAccessToModel(t,this.model,this.name)},_getFallbackTemplate:function(e){return this.isDisabled()&&e==="disabled"?"edit":this.view.fallbackFieldTemplate||"detail"},_loadTemplate:function(){var t,n=this.options.viewName||this.options.def.view||(this.view.meta&&this.view.meta.type?this.view.meta.type:this.view.name),r=this.action;this.isDisabled()&&n==="edit"?n=this.action:r=this.action||(this.view.action&&this.view.name!=this.view.action?this.view.action:n);while(n){if(this._checkAccessToAction(r))break;n=this.viewFallbackMap[n],r=n}if(n){var i=this.module||this.context.get("module");t=this._getFallbackTemplate(n),this.template=e.template.getField(this.type,n,i,t)||e.template.getField("base",n,i,t)||e.template.empty}else this.template=e.template.empty;this.tplName=n,this.action=r},delegateEvents:function(e){e=e||this.events||(this.def?this.def.events:null);if(!e)return;e=_.clone(e),_.each(e,function(t,n){var r=this[t];!r&&_.isString(t)&&(r=_.bind(function(e){_.isFunction(this.triggerMetadataEvent)&&this.triggerMetadataEvent(e,t)},this),this["callback_"+n]=r,e[n]="callback_"+n),!_.isFunction(t)&&!r&&delete e[n]},this),Backbone.View.prototype.delegateEvents.call(this,e)},_render:function(){return this._loadTemplate(),this.model instanceof Backbone.Model&&(this.value=this.getFormattedValue()),this.dir=_.result(this,"direction"),e.lang.direction===this.dir&&delete this.dir,this.unbindDom(),this.$el.html(this.template(this)||""),this.def&&this.def.css_class&&this.getFieldElement().addClass(this.def.css_class),this.$(this.fieldTag).attr("dir",this.dir),this.bindDomChange(),this},getFieldElement:function(){return this.$el},bindDomChange:function(){if(!(this.model instanceof Backbone.Model))return;var e=this,t=this.$el.find(this.fieldTag);t.on("change",function(){e.model.set(e.name,e.unformat(t.val()))})},bindDataChange:function(){this.model&&this.model.on("change:"+this.name,function(e,t){this.action==="edit"?this.$(this.fieldTag).val(this.format(t)):this.render()},this)},format:function(e){return e},unformat:function(e){return e},getFormattedValue:function(){return this.format(this.model.has(this.name)?this.model.get(this.name):null)},handleValidationError:function(e){},removeValidationErrors:function(){},getPlaceholder:function(){return new Handlebars.SafeString('<span sfuuid="'+this.sfId+'"></span>')},setDisabled:function(e){e=_.isUndefined(e)?!0:e,e&&this.isDisabled()===!1?(this._previousAction=this.action,this.action="disabled",this.render()):e===!1&&this.isDisabled()&&(this.action=this._previousAction,delete this._previousAction,this.render())},isDisabled:function(){return this.action==="disabled"},setViewName:function(e){this.options.viewName=e},setMode:function(e){this.isDisabled()?this._previousAction=e:this.action=e,this.setViewName(e),this.render()},unbindDom:function(){this.$el.find(this.fieldTag).off()},_dispose:function(){e.plugins.detach(this,"field"),this.unbindDom(),e.view.Component.prototype._dispose.call(this)},toString:function(){return"field-"+this.name+"-"+this.sfId+"-"+e.view.Component.prototype.toString.call(this)},show:function(){if(!this.isVisible()){if(!this.triggerBefore("show"))return!1;this.getFieldElement().removeClass("hide").show(),this.trigger("show")}},hide:function(){if(this.isVisible()){if(!this.triggerBefore("hide"))return!1;this.getFieldElement().addClass("hide").hide(),this.trigger("hide")}},isVisible:function(){return this.getFieldElement().css("display")!=="none"},equals:function(e){return this.type===e.type&&_.isEqual(this.getFormattedValue(),e.getFormattedValue())},closestComponent:function(e){if(!this.view)return;return this.view.name===e?this.view:this.view.closestComponent(e)}})}(SUGAR.App),function(e){var t={},n={preventAnyAlert:!1,init:function(){this.$alerts=$(e.config.alertsEl||"#alerts"),this.klass=e.view[e.utils.capitalize(e.config.appId)+"AlertView"]||e.view.views[e.utils.capitalize(e.config.platform)+"AlertView"]||e.view.views.BaseAlertView||e.view[e.utils.capitalize(e.config.platform)+"AlertView"]||e.view.AlertView},show:function(n,r){if(!this.$alerts||this.$alerts.length==0)return null;if(this.preventAnyAlert)return null;r=_.extend({level:"info",autoClose:!1},r||{}),r.level==="confirmation"&&(this.dismissAll(),this.preventAnyAlert=!0),_.isUndefined(r.closeable)&&(r.closeable=r.level!="info"),r.messages&&(r.messages=_.isString(r.messages)?[r.messages]:r.messages);var i=t[n];i||(i=this._create(n,r),t[n]=i),i.level=r.level,!r.autoClose||this._setAutoCloseTimer(i,r.onAutoClose,r.autoCloseDelay),i.render(r);if(r.closeable){var s=i.getCloseSelector();s.off("click"),s.on("click",_.bind(function(){this.dismiss(n)},this)),e.accessibility&&e.accessibility.run(s,"click")}return i},_create:function(e,t){var n=new this.klass(t);return n.key=e,n.$el.prependTo(this.$alerts),n},_setAutoCloseTimer:function(t,n,r){t.timerId&&clearTimeout(t.timerId),t.timerId=setTimeout(_.bind(function(){_.isFunction(n)&&n(t.key),this.dismiss(t.key)},this),r||e.config.alertAutoCloseDelay||9e3)},dismiss:function(e,n){this.preventAnyAlert=!1;var r=t[e];if(!r)return;r.timerId&&clearTimeout(r.timerId),r.close(n),delete t[e]},dismissAll:function(e,n){_.each(t,function(t,r){(!e||t.level==e)&&this.dismiss(r,n)},this)},get:function(e){return t[e]},getAll:function(){return t}};e.augment("alert",n,!1),e.view.AlertView=e.view.View.extend({className:"alert",tpl:"alert",close:function(){this.getCloseSelector().off("click"),this.$el.remove()},getCloseSelector:function(){return this.$(".close")},render:function(t){t=t||{},t.closeable&&this.$el.addClass("closeable"),this.$el.addClass("alert-"+t.level);var n=e.template.get(t.tpl||this.tpl)||e.template.empty;this.$el.html(n(t))}})}(SUGAR.App),typeof SUGAR=="undefined"&&(SUGAR={}),typeof SUGAR.util=="undefined"&&(SUGAR.util={}),typeof SUGAR.expressions=="undefined"&&(SUGAR.expressions={}),function(){SUGAR.util.extend=SUGAR.util.extend||(SUGAR.App?SUGAR.App.utils.extendFrom:null);var e=SUGAR.expressions.Expression=function(e){this.context=e};e.INFINITY=-1,e.STRING_TYPE="string",e.NUMERIC_TYPE="number",e.DATE_TYPE="date",e.TIME_TYPE="time",e.BOOLEAN_TYPE="boolean",e.ENUM_TYPE="enum",e.RELATE_TYPE="relate",e.GENERIC_TYPE="generic",e.TRUE="true",e.FALSE="false",e.isTruthy=function(t){return _.isString(t)?t=="1"||t==e.TRUE:!!t},SUGAR.expressions.NumericConstants={pi:3.14159265,e:2.718281828459045},e.prototype.init=function(e){e instanceof Array&&e.length==1?this.params=e[0]:this.params=e,this.validateParameters()},e.prototype.getParameters=function(){return this.params},e.prototype.validateParameters=function(){var t=this.getParameters(),n=this.getParamCount(),r=this.getParameterTypes();if(typeof n!="number")throw this.getClass()+": Number of paramters required must be a number";if(!(typeof r=="string"||r instanceof Array))throw this.getClass()+": Parameter types must be valid and match the parameter count";if(r instanceof Array&&n!=e.INFINITY&&n!=r.length)throw this.getClass()+": Parameter types must be valid and match the parameter count";if(typeof r=="string"){if(e.TYPE_MAP[r]==null)throw this.getClass()+": Invalid type requirement '"+r+"'"}else for(var i=0;i<r.length;i++)if(typeof e.TYPE_MAP[r[i]]=="undefined")throw this.getClass()+": Invalid type requirement '"+r[i]+"'";if(n==0&&typeof t=="undefined")return;if(n==1&&this.isProperType(t,r))return;if(n>1&&!(t instanceof Array))throw this.getClass()+": Requires exactly "+n+" parameter(s)";if(n==1&&t instanceof Array)throw this.getClass()+": Requires exactly 1 parameter";if(n!=e.INFINITY&&t instanceof Array&&t.length!=n)throw this.getClass()+": Requires exactly "+n+" parameter(s)";if(typeof r=="string"){if(!(t instanceof Array)){if(this.isProperType(t,r))return;throw this.getClass()+": Parameter must be of type '"+r+"'"}for(var i=0;i<t.length;i++)if(!this.isProperType(t[i],r))throw this.getClass()+": All parameters must be of type '"+r+"'"}else{if(!(t instanceof Array)){if(this.isProperType(t,r[0]))return;throw this.getClass()+": Parameter must be of type '"+r[0]+"'"}for(var i=0;i<r.length;i++)if(!this.isProperType(t[i],r[i]))throw this.getClass()+": The parameter at index "+i+" must be of type "+r[i]}},e.prototype.getParamCount=function(){return e.INFINITY},e.prototype.isProperType=function(t,n){var r=e;if(n instanceof Array)return!1;var i=r.TYPE_MAP[n];if(typeof i=="undefined"||i==null||i=="")return!1;if(t instanceof i||t instanceof r.TYPE_MAP.generic||n==r.GENERIC_TYPE)return!0;t instanceof r&&(t=t.evaluate());switch(n){case r.STRING_TYPE:return typeof t=="string"||typeof t=="number"||t instanceof r.TYPE_MAP[r.NUMERIC_TYPE];case r.NUMERIC_TYPE:return typeof t=="number"||SUGAR.expressions.isNumeric(t);case r.BOOLEAN_TYPE:return t==r.TRUE||t==r.FALSE||t===1||t===0||t==="1"||t==="0"||t==="";case r.DATE_TYPE:case r.TIME_TYPE:if(t===null||t===""||typeof t=="string"&&SUGAR.util.DateUtils.guessFormat(t))return!0;break;case r.RELATE_TYPE:return!0}return!1},e.prototype.evaluate=function(){},e.prototype.getClass=function(e){for(var t in SUGAR.FunctionMap)if(typeof SUGAR.FunctionMap[t]=="function"&&SUGAR.FunctionMap[t].prototype&&this instanceof SUGAR.FunctionMap[t])return t;return!1},e.prototype.getParameterTypes=function(){},SUGAR.expressions.GenericExpression=function(e){},SUGAR.util.extend(SUGAR.expressions.GenericExpression,e,{getParameterTypes:function(){return e.GENERIC_TYPE}}),SUGAR.expressions.NumericExpression=function(e){},SUGAR.util.extend(SUGAR.expressions.NumericExpression,e,{getParameterTypes:function(){return e.NUMERIC_TYPE}}),SUGAR.expressions.StringExpression=function(e){},SUGAR.util.extend(SUGAR.expressions.StringExpression,e,{getParameterTypes:function(){return e.STRING_TYPE}}),SUGAR.expressions.BooleanExpression=function(e){},SUGAR.util.extend(SUGAR.expressions.BooleanExpression,e,{getParameterTypes:function(){return e.BOOLEAN_TYPE}}),SUGAR.expressions.EnumExpression=function(e){},SUGAR.util.extend(SUGAR.expressions.EnumExpression,e,{getParameterTypes:function(){return e.ENUM_TYPE}}),SUGAR.expressions.DateExpression=function(e){},SUGAR.util.extend(SUGAR.expressions.DateExpression,e,{getParameterTypes:function(){return e.DATE_TYPE}}),SUGAR.expressions.TimeExpression=function(e){},SUGAR.util.extend(SUGAR.expressions.TimeExpression,e,{getParameterTypes:function(){return e.TIME_TYPE}}),SUGAR.expressions.RelateExpression=function(e){},SUGAR.util.extend(SUGAR.expressions.RelateExpression,e,{getParameterTypes:function(){return e.GENERIC_TYPE}}),e.TYPE_MAP={number:SUGAR.expressions.NumericExpression,string:SUGAR.expressions.StringExpression,date:SUGAR.expressions.DateExpression,time:SUGAR.expressions.TimeExpression,"boolean":SUGAR.expressions.BooleanExpression,"enum":SUGAR.expressions.EnumExpression,relate:SUGAR.expressions.RelateExpression,generic:SUGAR.expressions.GenericExpression},SUGAR.expressions.ConstantExpression=function(e){this.init(e)},SUGAR.util.extend(SUGAR.expressions.ConstantExpression,SUGAR.expressions.NumericExpression,{evaluate:function(){return this.getParameters()},getParamCount:function(){return 1}}),SUGAR.expressions.StringLiteralExpression=function(e){this.init(e)},SUGAR.util.extend(SUGAR.expressions.StringLiteralExpression,SUGAR.expressions.StringExpression,{evaluate:function(){return this.getParameters()},getParamCount:function(){return 1}}),SUGAR.expressions.FalseExpression=function(e){this.init(e)},SUGAR.util.extend(SUGAR.expressions.FalseExpression,SUGAR.expressions.BooleanExpression,{evaluate:function(){return e.FALSE},getParamCount:function(){return 0}}),SUGAR.expressions.TrueExpression=function(e){this.init(e)},SUGAR.util.extend(SUGAR.expressions.TrueExpression,SUGAR.expressions.BooleanExpression,{evaluate:function(){return e.TRUE},getParamCount:function(){return 0}});var t=SUGAR.expressions.ExpressionParser=function(){};t.prototype.getFieldsFromExpression=function(e){return _.map(e.match(/\$(\w+)/g),function(e){return e.replace(/\$/g,"")})},t.prototype._generateRange=function(e,t,n){var r="",i=parseInt(t);if(typeof n=="undefined")while(this.getElement(e+""+i)!=null)r+="$"+e+""+i++ +",";else for(;i<=n;i++){var s=e+""+i;this.getElement(s)!=null&&(r+="$"+s+",")}return r.substring(0,r.length-1)},t.prototype._valueReplace=function(e){return/^\$.*$/.test(e)?this.getValue(e.substring(1)):e},t.prototype._performRangeReplace=function(e){var t=!1,n,r;for(var i=0;;i++){if(i==e.length)break;var s=e.charAt(i);s=='"'&&n!="\\"&&(t=!t);if(!t&&s=="%"){r=!0;var o=e.indexOf("[",i+1),u=e.indexOf(",",o),a=e.indexOf("]",o);if(o<0||a<0)throw"Invalid range syntax";var f=e.substring(i+1,o),l,c;u>-1&&u<a?(l=e.substring(o+1,u),c=e.substring(u+1,a)):l=e.substring(o+1,a),u>-1&&u<a&&(c=e.substring(u+1,a));var h=this._generateRange(f,this._valueReplace(l),this._valueReplace(c));typeof c=="undefined"?e=e.replace("%"+f+"["+l+"]",h):e=e.replace("%"+f+"["+l+","+c+"]",h),i=i+h.length-1}n=s}return e},t.prototype.validate=function(e){if(typeof e!="string")throw"ExpressionParser requires a string expression.";var t=this.toConstant(e);if(t!=null&&typeof t!="undefined")return!0;if(/^[\w\-]+\(.*\)$/.exec(e)==null)throw"Syntax Error (Expression Format Incorrect '"+e+"' )";if(e.indexOf("(")<0)throw"Syntax Error (No opening paranthesis found)";return!0},t.prototype.tokenize=function(e){var t=this.toConstant(e);if(t!=null&&typeof t!="undefined")return{type:"constant",returnType:this.getType(t),value:t.evaluate()};if(/^[$]\w+$/.test(e))return{type:"variable",name:$.trim(e).substr(1)};if(/^[$]\w+\.\w+$/.test(e))return e=$.trim(e),{type:"variable",name:e.substr(1,e.indexOf(".")-1),relate:e.substr(e.indexOf(".")+1)};var n=e.indexOf("(");if(n<1)throw e+": Syntax Error, no open parentheses found";if(e.charAt(e.length-1)!=")")throw e+": Syntax Error, no close parentheses found";var r=e.substring(0,n),i=e.substring(n+1,e.length-1),s=0,o=i.length,u="",a=new Array,f=null,l=null,c=!1,h=!1,p=!1,d=!1;for(var v=0;v<=o;v++){l=f,h=!1;if(v==o){u=$.trim(u),u!=""&&(a[a.length]=this.tokenize(u));break}d=l=="\\",f=i.charAt(v);if(p&&f!='"'&&!d){u+=f;continue}if(f=='"'&&!d&&s==0){if(p){var m=i.indexOf(",",v);m<0&&(m=i.length-1);var g=v<o-1?v+1:o-1,y=i.substring(g,m);if(/^\s*$/.exec(y)==null)throw r+": Syntax Error (Improperly Terminated String '"+y+"')"+g+" "+m}p=!p}if(f=="(")s++;else if(f==")")s--;else if(f==","&&s==0){u=$.trim(u);if(u=="")throw"Syntax Error: Unexpected ','";a[a.length]=this.tokenize(u),u="",h=!0;continue}u+=f}if(p)throw"Syntax Error (Unterminated String Literal)";if(s!=0)throw"Syntax Error (Incorrectly Matched Parantheses)";if(h)throw"Syntax Error (No parameter after comma near <b>"+r+"</b>)";return{type:"function",name:$.trim(r),args:a}},t.prototype.getType=function(t){for(var n in e.TYPE_MAP)if(t instanceof e.TYPE_MAP[n])return n;return!1},t.prototype.evaluate=function(e,t){if(typeof e!="string")throw"ExpressionParser requires a string expression.";e=e.replace(/^\s+|\s+$|\n/g,"");var n=this.toConstant(e);if(n!=null&&typeof n!="undefined")return n;if(e.match(/^\$\w+$/)){if(typeof t=="undefined")throw"Syntax Error: variable "+e+" without context";return t.getValue(e.substring(1))}if(e.match(/^\$\w+\.\w+$/))return t.getRelatedValue(e.substr(1,e.indexOf(".")-1),e.substr(e.indexOf(".")+1));if(/^[\w\-]+\(.*\)$/.exec(e)==null)throw"Syntax Error (Expression Format Incorrect '"+e+"' )";var r=e.indexOf("(");if(r<0)throw"Syntax Error (No opening paranthesis found)";var i=e.substring(0,r);if(SUGAR.FunctionMap[i]==null)throw i+": No such function defined";var s=e.substring(r+1,e.length-1),o=0,u=s.length,a="",f=new Array,l=null,c=null,h=!1,p=!1,d=!1,v=!1;if(u>0)for(var m=0;m<=u;m++){c=l;if(m==u){f[f.length]=this.evaluate(a,t);break}d=c=="\\",l=s.charAt(m);if(p&&l!='"'&&!d){a+=l;continue}v&&(l==" "||l==",")&&(v=!1);if(l=='"'&&!d&&o==0){if(p){var g=s.indexOf(",",m);g<0&&(g=s.length-1);var y=m<u-1?m+1:u-1,b=s.substring(y,g);if(/^\s*$/.exec(b)==null)throw i+": Syntax Error (Improperly Terminated String '"+b+"')"+y+" "+g}p=!p}if(l=="$"&&!d&&!p&&o==0){if(v)throw i+": Syntax Error (unexpeted '$' in  '"+a+"')";v=!0}if(l=="(")o++;else if(l==")")o--;else if(l==","&&o==0){f[f.length]=this.evaluate(a,t),a="";continue}a+=l}if(p)throw"Syntax Error (Unterminated String Literal)";if(o!=0)throw"Syntax Error (Incorrectly Matched Parantheses)";return new SUGAR.FunctionMap[i](f,t)},t.prototype.toConstant=function(e){if(isFinite(e)&&!isNaN(parseFloat(e)))return new SUGAR.expressions.ConstantExpression(parseFloat(e));var t=SUGAR.expressions.NumericConstants[e];if(t!=null&&typeof t!="undefined")return new SUGAR.expressions.ConstantExpression(parseFloat(t));if(/^"[\s\S]*"$/.exec(e)!=null)return e=e.substring(1,e.length-1),new SUGAR.expressions.StringLiteralExpression(e);if(e=="")return new SUGAR.expressions.StringLiteralExpression(e);if(e=="true")return new SUGAR.expressions.TrueExpression;if(e=="false")return new SUGAR.expressions.FalseExpression;if(/^(0[0-9]|1[0-2])\/([0-2][0-9]|3[0-1])\/[0-3][0-9]{3,3}$/.exec(e)!=null){var n=parseFloat(e.substring(0,2)),r=parseFloat(e.substring(3,2)),i=parseFloat(e.substring(6,4));return new SUGAR.DateExpression([n,r,i])}if(/^([0-1][0-9]|2[0-4]):[0-5][0-9]:[0-5][0-9]$/.exec(e)!=null){var s=parseFloat(e.substring(0,2)),o=parseFloat(e.substring(3,2)),u=parseFloat(e.substring(6,2));return new SUGAR.TimeExpression([s,o,u])}return null},t.prototype.getRelatedFieldsFromFormula=function(e){var t=[],n=["related","count","rollupSum","rollupMax","rollupMin","rollupAve","rollupCurrencySum"],r=function(e){if(e.type=="variable"&&e.relate)t.push({type:"related",link:e.name,relate:e.relate});else if(e.type=="function"&&n.indexOf(e.name)!=-1)switch(e.name){case"related":e.args[1].type=="constant"&&t.push({type:"related",link:e.args[0].name,relate:e.args[1].value});break;case"count":t.push({type:"count",link:e.args[0].name});break;default:e.args[1].type=="constant"&&t.push({type:e.name,link:e.args[0].name,relate:e.args[1].value})}else if(e.type=="function")for(var i=0;i<e.args.length;i++)r(e.args[i])};try{var i=this.tokenize(e);r(i)}catch(s){}return t};var n=SUGAR.expressions.ExpressionContext=function(){};n.prototype.getValue=function(e){return""},n.prototype.setValue=function(e,t){return""},n.prototype.addListener=function(e,t,n){return""},n.prototype.getRelatedValue=function(e,t){return new SUGAR.RelatedFieldExpression([new SUGAR.expressions.StringLiteralExpression(e),new SUGAR.expressions.StringLiteralExpression(t)])},SUGAR.expressions.isNumeric=function(e){return typeof e!="number"&&typeof e!="string"?!1:(e=SUGAR.expressions.unFormatNumber(e),isFinite(e)&&!isNaN(parseFloat(e)))},SUGAR.expressions.unFormatNumber=function(e){if(typeof e=="string"){var t=SUGAR.expressions,n=",",r=".";t.userPrefs&&(n=t.userPrefs.num_grp_sep,r=t.userPrefs.dec_sep),e=t.replaceAll(e,n,""),e=t.replaceAll(e,r,".")}return e},SUGAR.expressions.replaceAll=function(e,t,n){if(t==n||e==""||t=="")return e;var r=e;while(r.indexOf(t)>-1)r=r.replace(t,n);return r},SUGAR.util.DateUtils={parse:function(e,t){if(e instanceof Date)return e;t=="user"&&(SUGAR.expressions.userPrefs&&SUGAR.expressions.userPrefs.datef?t=SUGAR.expressions.userPrefs.datef+" "+SUGAR.expressions.userPrefs.timef:t=SUGAR.util.DateUtils.guessFormat(e));if(t==null||t=="")t=SUGAR.util.DateUtils.guessFormat(e);if(t==0)return/^\d+$/.test(e)?new Date(e):!1;var n=new Date("Jan 1, 1970 00:00:00"),r="",i=$.trim(e);t=$.trim(t)+" ";for(var s=0;s<t.length;s++){var o=t.charAt(s);if(o==":"||o=="/"||o=="-"||o=="."||o==" "||o=="a"||o=="A"||o=="T"){var u=i.indexOf(o);u==-1&&(u=i.length);var a=i.substring(0,u);i=i.substring(u+1);switch(r){case"m":if(!(a>0&&a<13))return!1;n.setMonth(a-1);break;case"d":if(!(a>0&&a<32))return!1;n.setDate(a);break;case"Y":if(!(a>0))return!1;n.setYear(a);break;case"h":var f=t.substring(t.length-4);(f.toLowerCase()=="i a "||f.toLowerCase()==o+"ia ")&&i.substring(i.length-2).toLowerCase()=="pm"&&(a*=1,a<12&&(a+=12));case"H":n.setHours(a);break;case"i":a=a.substring(0,2),n.setMinutes(a)}r=""}else r=o}return n},guessFormat:function(e){if(typeof e!="string")return!1;var t="",n;e.indexOf(" ")!=-1?n=" ":e.indexOf("T")!=-1&&(n="T"),n&&(t=e.substring(e.indexOf(n)+1,e.length),e=e.substring(0,e.indexOf(n)));var r="/";if(e.indexOf("/")==-1)if(e.indexOf("-")!=-1)r="-";else{if(e.indexOf(".")==-1)return!1;r="."}var i=e.split(r),s="",o=new Date("Jan 1, 1970 00:00:00");if(i[0].length==4)s="Y"+r+"m"+r+"d";else{if(i[2].length!=4)return!1;s="m"+r+"d"+r+"Y"}if(t!=""){var u="",a=":";t.indexOf(".")==2&&(a=".");if(t.indexOf(" ")==-1){var l=t.substring(t.length-2,t.length);return l=="AM"||l=="PM"?s+n+"h"+a+"iA":l=="am"||l=="pm"?s+n+"h"+a+"iA":s+n+"H"+a+"i"}var f=t.split(" ");if(f[1]=="am"||f[1]=="pm")return s+n+"h"+a+"i a";if(f[1]=="AM"||f[1]=="PM")return s+n+"h"+a+"i A"}return s},formatDate:function(e,t,n){!n&&SUGAR.expressions.userPrefs.datef&&SUGAR.expressions.userPrefs.timef&&(t?n=SUGAR.expressions.userPrefs.datef+" "+SUGAR.expressions.userPrefs.timef:n=SUGAR.expressions.userPrefs.datef);var r="";for(var i=0;i<n.length;i++){var s=n.charAt(i);switch(s){case"m":var o=e.getMonth()+1;r+=o<10?"0"+o:o;break;case"d":var u=e.getDate();r+=u<10?"0"+u:u;break;case"Y":r+=e.getFullYear();break;case"H":case"h":var a=e.getHours();s=="h"&&(a=a>12?a-12:a),r+=a<10?"0"+a:a;break;case"i":var o=e.getMinutes();r+=o<10?"0"+o:o;break;case"a":e.getHours()<12?r+="am":r+="pm";break;case"A":e.getHours()<12?r+="AM":r+="PM";break;default:r+=s}}return r},roundTime:function(e){var t=e.getMinutes();return t<1?t=0:t<16?t=15:t<31?t=30:t<46?t=45:(t=0,e.setHours(e.getHours()+1)),e.setMinutes(t),e},getUserTime:function(){var e=new Date;if(SUGAR.expressions.userPrefs&&typeof SUGAR.expressions.userPrefs.gmt_offset!="undefined"){var t=SUGAR.expressions.userPrefs.gmt_offset;e.setMinutes(e.getMinutes()+(e.getTimezoneOffset()+t))}return e}}}(),function(){SUGAR.forms=SUGAR.forms||{},SUGAR.forms.animation=SUGAR.forms.animation||{};var e=SUGAR.expressions,t=e.SidecarExpressionContext=function(e){this.view=e,this.model=e.model||e.context.get("model")};SUGAR.util.extend(t,e.ExpressionContext,{getValue:function(n){var r=this.model.get(n),i=this.model.fields[n],s;i.type=="link"&&(r=n);if(typeof r=="string")r=r.replace(/\n/g,""),/^(\s*)$/.exec(r)!=null||r===""?s=t.parser.toConstant('""'):i.type!=="currency"&&e.isNumeric(r)?s=t.parser.toConstant(e.unFormatNumber(r)):s=t.parser.toConstant('"'+r+'"');else if(typeof r=="object"&&r!=null&&r.getTime){var o=new e.DateExpression("");o.evaluate=function(){return this.value},o.value=r,s=o}else typeof r=="number"?s=t.parser.toConstant(""+r):_.isBoolean(r)?s=r?new SUGAR.expressions.TrueExpression:new SUGAR.expressions.FalseExpression:s=t.parser.toConstant('""');return s},setValue:function(e,t){if(typeof this.model.fields[e]!="object")return;var n=this.model.fields[e];this.lockedFields=this.lockedFields||[],typeof t=="object"&&t.length>0&&n.type!="multienum"?t=t.join(", "):t&&n.type==="date"?t=App.date(t).formatServer(!0):t&&n.type==="datetimecombo"&&(t=App.date(t).format()),n.type=="bool"&&_.isString(t)&&(t=SUGAR.expressions.Expression.isTruthy(t)),t&&(n.type==="decimal"||n.type==="float")&&(t=App.utils.formatNumber(t,n.round||6,n.precision||6,",","."));if(!this.lockedFields[e]){this.lockedFields[e]=!0;var r=this.getElement(e);r&&SUGAR.forms.FlashField($(r).parents('[data-fieldname="'+e+'"]'),null,e);var i=this.model.set(e,t);return this.lockedFields=[],i}},addListener:function(e,t,n){this.view.collection?(this.view.collection.off("change:"+e,t,n),this.view.collection.on("change:"+e,t,n)):(this.model.off("change:"+e,t,n),this.model.on("change:"+e,t,n))},getElement:function(e){var t=this.getField(e);if(t&&t.el)return t.el},getField:function(e){return this.view.getField(e,this.model)},addClass:function(e,t,n){var r=this.view.getFieldMeta(e),i=n?["css_class","cell_css"]:["css_class"],s=this.getElement(e),o=$(s).closest("div.record-cell");_.each(i,function(e){r[e]?r[e].indexOf(t)==-1&&(r[e]+=" "+t):r[e]=t}),this.view.setFieldMeta(e,r),$(s).addClass(t),n&&o&&o.addClass(t)},removeClass:function(e,t,n){var r=this.view.getFieldMeta(e),i=this.view.getField(e),s=n?["css_class","cell_css"]:["css_class"],o=this.getElement(e),u=$(o).closest("div.record-cell");_.each([i.def,r],function(e){_.each(s,function(n){e[n]&&e[n].indexOf(t)!=-1&&(e[n]=$.trim((" "+e[n]+" ").replace(new RegExp(" "+t+" "),"")))})}),this.view.setFieldMeta(e,r),$(o).removeClass(t),n&&u&&(u.removeClass(t),u.find("."+t).removeClass(t))},getLink:function(e){var t=this.model;if(t&&t.fields&&t.fields[e])return t.fields[e]},showError:function(e,t){},clearError:function(e){},setStyle:function(e,t){},setRelatedFields:function(e,t){t=!!t;var n=this.model;for(var r in e){var i=n.get(r),s=!!i,o=i||{};_.each(e[r],function(e,t){_.isObject(e)?o[t]=_.extend(o[t]||{},e):o[t]=e});var u={};u[r]=o,n.set(u,{silent:t}),!t&&s&&n.trigger("change:"+r,n)}},getRelatedFieldValues:function(e,t,n,r){var i=this,s=App.api;if(e.length>0){t=t||this.view.context.get("module"),n=n||this.model.get("id");for(var o=0;o<e.length;o++){var u=e[o].link,a={};if(e[o].type=="related"){var f=this.model.fields[u];if(f&&f.id_name&&f.module){var l=this.model.get(f.id_name);l&&(e[o].relId=l,e[o].relModule=f.module)}}e[o].relate&&(a[u]={},a[u][e[o].type]={},a[u][e[o].type][e[o].relate]="",i.setRelatedFields(a,!0))}var c={id:n,action:"related"},h={module:t,fields:JSON.stringify(e)};s.call("read",s.buildURL("ExpressionEngine","related",c,h),c,h,{success:function(e){return i.setRelatedFields(e,r),e}})}return null},getRelatedField:function(e,t,n){var r=this.model.get(e)||{};if(t=="related"&&!this.inCollection)return this._handleRelateExpression(e,n);if(typeof r[t]!="undefined"){if(!n)return r[t];if(typeof r[t][n]!="undefined")return r[t][n]}if(this.inCollection)return r[t]=r[t]||{},r[t][n]=r[t][n]||"",this.model.set(e,r,{silent:!0}),"";if(!this.model.get("id"))return"";var i={link:e,type:t};return n&&(i.relate=n),this.getRelatedFieldValues([i]),typeof r[t]=="undefined"?"":r[t]},_handleRelateExpression:function(e,t){this.view.context.set("model",this.model);var n=this.view.context.getChildContext({link:e});n.prepare();var r=n.get("collection"),i=n.get("fields")||[],s=this,o=_.find(this.model.fields,function(t){return t.type&&t.type=="relate"&&t.id_name&&t.link&&t.link==e}),u=n.get("model");n.isDataFetched()&&!n.get("modelId")&&(u=r.length>0?r.models[0]:null);if(o&&(!this.model.get(o.id_name)||u&&u.get("id")!=this.model.get(o.id_name))){n.set({model:null}),n.resetLoadFlag();if(!this.model.get(o.id_name))return""}if(t&&(!n.isDataFetched()||u&&_.isUndefined(u.get(t))))_.contains(i,t)||i.push(t),this._loadRelatedData(e,i,n,o);else{if(u)return u.get(t);if(!r.page){var a=this.model;SUGAR.App.utils.doWhen(function(){return r.page>0},function(){a.trigger("change:"+e,a)})}}return""},_loadRelatedData:function(e,t,n,r){var i=this;if(r&&this.model.get(r.id_name)){var s=this.model.get(r.id_name),o=n.get("model")||SUGAR.App.data.createRelatedBean(this.model,this.model.get(r.id_name),e);n.set({modelId:s,model:o})}else if(_.isEmpty(this.model.get("id")))return"";n.prepare(),n.set({fields:_.union(n.get("fields")||[],t),skipFetch:!1}),n.isDataFetched()&&n.resetLoadFlag(),r&&(n.attributes.link=null);var o=this.model;n.loadData({success:function(){o.trigger("change:"+e,o)}}),r&&(n.attributes.link=e)},_setupLinks:function(e){_.each(e,function(e){if(e.link&&e.relate&&e.type=="related"){var t=this.view.context.getChildContext({link:e.link});t&&t.set("fields",_.union(t.get("fields")||[],[e.relate]))}},this)},_requestRollups:function(e){this.model.get("id")&&this.getRelatedFieldValues(e,null,null,!0)},fireOnLoad:function(e){},getAppListStrings:function(e){return SUGAR.App.lang.getAppListStrings(e)},parseDate:function(e,t){return SUGAR.App.date.parse(e)},setFieldDisabled:function(e,t){t=_.isUndefined(t)?!0:t;var n=this.getField(e);n&&(n.setDisabled(t),t?this.view.$("span.record-edit-link-wrapper[data-name="+e+"]").hide():this.view.$("span.record-edit-link-wrapper[data-name="+e+"]").show(),_.isEqual(t,!1)&&!_.isEqual(n.currentState,"edit")&&_.isEqual(this.view.currentState,"edit")&&!_.isEqual(this.view.inlineEditMode,!0)&&(n.setMode("edit"),this.view.editableFields.push(n)),_.isFunction(this.view.setEditableFields)&&this.view.setEditableFields())},setFieldRequired:function(e,t){t=SUGAR.expressions.Expression.isTruthy(t);var n=this.view.getField(e,this.model);n&&(n.def.required=t,n.render())},setModel:function(e){this.model=e},add:function(e,t){return SUGAR.App.math.add(e,t,6,!0)},subtract:function(e,t){return SUGAR.App.math.sub(e,t,6,!0)},multiply:function(e,t){return SUGAR.App.math.mul(e,t,6,!0)},divide:function(e,t){return SUGAR.App.math.div(e,t,6,!0)},round:function(e,t){return SUGAR.App.math.round(e,t,!0)}}),t.parser=new SUGAR.expressions.ExpressionParser,t.evalVariableExpression=function(e,n){return t.parser.evaluate(e,new t(n))},SUGAR.forms.Dependency=function(e,t,n,r,i){this.actions=t,this.falseActions=n,this.context=i,this.testOnLoad=r,e.setContext(this.context),e.setDependency(this),this.trigger=e,r&&i.fireOnLoad(this)},SUGAR.forms.Dependency.fromMeta=function(t,n){var r=t.trigger||"true",i=t.triggerFields||e.ExpressionParser.prototype.getFieldsFromExpression(r),s=t.actions||[],o=t.notActions||[],u=t.onload||!1,a=n.model&&_.isEmpty(n.model.get("id")),f=[],l=[];return _.isEmpty(i)&&!u&&!a?null:_.isEmpty(s)&&_.isEmpty(o)?null:(_.each(s,function(e){if(!e.action||!SUGAR.forms[e.action+"Action"])return;var t=!0;e.action==="SetValue"&&e.params.target&&(t=App.acl.hasAccess("edit",this.model.module,undefined,e.params.target)),t&&f.push(new SUGAR.forms[e.action+"Action"](e.params))},n),_.each(o,function(e){if(!e.action||!SUGAR.forms[e.action+"Action"])return;var t=!0;e.action==="SetValue"&&e.params.target&&(t=App.acl.hasAccess("edit",this.model.module,undefined,e.params.target)),t&&l.push(new SUGAR.forms[e.action+"Action"](e.params))},n),new SUGAR.forms.Dependency(new SUGAR.forms.Trigger(i,r,n),f,l,u,n))},SUGAR.forms.Dependency.prototype.fireLinkOnlyDependency=function(){if(!this.testOnLoad)return!1;var e=!0;return this.context.model.fields&&_.each(this.trigger.variables,function(t){e=e&&this.context.model.fields[t]&&this.context.model.fields[t].type=="link"},this),e},SUGAR.forms.Dependency.prototype.fire=function(e){if(this.context.view.disposed||!this.context.view.context)return;try{var t=this.context.model;this.lastTriggeredActions=this.lastTriggeredActions||[];if(t.inSync&&!this.testOnLoad)return;var n=this.actions;e&&this.falseActions!=null&&(n=this.falseActions),_.each(this.lastTriggeredActions,function(e){this.context.view.off(null,null,e)},this),n instanceof SUGAR.forms.AbstractAction&&(n=[n]);for(var r in n){var i=n[r];typeof i.exec=="function"&&(i.setContext(this.context),i.exec(),this.testOnLoad&&i.afterRender&&this.context.view.on("render",i.exec,i))}this.lastTriggeredActions=n}catch(s){!SUGAR.isIE&&console&&console.log&&console.log("ERROR: "+s);return}},SUGAR.forms.Dependency.prototype.getRelatedFields=function(){var e=t.parser,n=e.getRelatedFieldsFromFormula(this.trigger.condition),r=function(t){t instanceof SUGAR.forms.AbstractAction&&(t=[t]);for(var r in t){var i=t[r];if(typeof i.exec=="function")for(var s in i)typeof i[s]=="string"&&(n=$.merge(n,e.getRelatedFieldsFromFormula(i[s])))}};return r(this.actions),r(this.falseActions),n},SUGAR.forms.AbstractAction=function(e){this.target=e},SUGAR.forms.AbstractAction.prototype.exec=function(){},SUGAR.forms.AbstractAction.prototype.setContext=function(e){this.context=e},SUGAR.forms.AbstractAction.prototype.evalExpression=function(e,n){return n=n||this.context,t.parser.evaluate(e,n).evaluate()},SUGAR.forms.Trigger=function(e,t,n){this.variables=e,this.condition=t,this.context=n,this.dependency={},this._attachListeners()},SUGAR.forms.Trigger.prototype._attachListeners=function(){this.variables instanceof Array||(this.variables=[this.variables]);for(var e=0;e<this.variables.length;e++)this.context.addListener(this.variables[e],SUGAR.forms.Trigger.fire,this,!0)},SUGAR.forms.Trigger.prototype.setDependency=function(e){this.dependency=e},SUGAR.forms.Trigger.prototype.setContext=function(e){this.context=e},SUGAR.forms.Trigger.fire=function(e){var n,r;e&&this.context.setModel(e);try{n=t.parser.evaluate(this.condition,this.context)}catch(i){!SUGAR.isIE&&console&&console.log&&console.log("ERROR:"+i+"; in Condition: "+this.condition)}typeof n!="undefined"&&(r=n.evaluate());if(r==SUGAR.expressions.Expression.TRUE){if(this.dependency instanceof SUGAR.forms.Dependency){this.dependency.fire(!1);return}}else if(r==SUGAR.expressions.Expression.FALSE&&this.dependency instanceof SUGAR.forms.Dependency){this.dependency.fire(!0);return}},SUGAR.forms.flashInProgress={},SUGAR.forms.FlashField=function(e,t,n){if(typeof e=="undefined"||!n&&!e.id)return;n=n||e.id;if(SUGAR.forms.flashInProgress[n])return;SUGAR.forms.flashInProgress[n]=!0,t=t||"#FF8F8F";var r=e.style&&e.style.backgroundColor?e.style.backgroundColor:"#FFFFFF";$(e).css("backgroundColor",r),$(e).animate({backgroundColor:t},200,function(){$(e).animate({backgroundColor:r},200,function(){delete SUGAR.forms.flashInProgress[n]})})},SUGAR.App&&SUGAR.App.plugins?SUGAR.App.plugins.register("SugarLogic","view",{onAttach:function(){this.on("init",function(){this.deps=[];var e=new SUGAR.expressions.SidecarExpressionContext(this),t=_.extend({},this.meta,this.options.meta),n=[],r=function(e,t){t.context.inCollection=!0,e.each(function(e){SUGAR.forms.Trigger.fire.apply(t,[e])}),t.context.inCollection=null};_.each(t.dependencies,function(t){var i=SUGAR.forms.Dependency.fromMeta(t,e);if(i){n=_.union(n,i.getRelatedFields());if(this.context.isCreate()||i.fireLinkOnlyDependency())SUGAR.forms.Trigger.fire.apply(i.trigger),this.trigger("sugarlogic:initialize");i.testOnLoad&&(this.context.on("list:editrow:fire",SUGAR.forms.Trigger.fire,i.trigger),this.collection&&this.collection.on("sync",function(e){e instanceof Backbone.Collection?_.defer(r,e,i.trigger):SUGAR.forms.Trigger.fire.apply(i.trigger,[e])},this))}this.deps.push(i)},this),e._setupLinks(n),e._requestRollups(n)})},getFieldNames:function(){var t=e.ExpressionParser.prototype.getFieldsFromExpression,n=Object.getPrototypeOf(this).getFieldNames.apply(this,arguments),r=_.extend({},this.meta,this.options.meta);return _.each(r.dependencies,function(e){e.trigger&&(n=_.union(n,t(e.trigger))),_.each(e.actions,function(e){e.params&&_.each(e.params,function(e){_.isString(e)&&(n=_.union(n,t(e)))})})}),this.model&&(n=_.filter(n,function(e){return this.model.fields[e]&&this.model.fields[e].type!="link"},this)),n}}):console.error&&console.error("unable to find the plugin manager")}(),function(e){e(window.jQuery||window.Zepto,SUGAR.App.date)}(function(e,t){var n=6e4,r=e([]),i,s=function(){if(!r.length)return;i=setTimeout(s,n),o.update()},o={update:function(n){n=n||r,n.each(function(n,i){var s=e(i),o=s.data("liveRelativeDate"),u;if(!o){r=r.not(i);return}u=o.date?s.data(o.date):s.attr("datetime");var a=s.html(),f=t(u).fromNow();if(a===f)return;var l=e.Event("change.liveRelativeDate");s.trigger(l,[a,f]),l.isDefaultPrevented()||s.html(f)})},pause:function(){clearTimeout(i),i=null},resume:function(){i||s()},interval:function(e){if(e===undefined)return n;n=e}},u={add:function(e,t){return!e||e.length===0?e:(t=t||{},e.data("liveRelativeDate",JSON.stringify(t)),r=r.add(e),o.resume(),e)},destroy:function(e){return r=r.not(e),e.removeAttr("data-live-relative-date"),e},isLiveRelativeDate:function(t){var n=!0;return e.each(t,function(t){if(e(t).data("liveRelativeDate")===undefined)return n=!1,!0}),n}};e.liverelativedate=o,e.fn.liverelativedate=function(e,t){return u[e]||(t=e,e="add"),u[e](this,t)}})