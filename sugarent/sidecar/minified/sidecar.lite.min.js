var SUGAR=SUGAR||{};SUGAR.Api=function(){var _instance;var _methodsToRequest={read:"GET",update:"PUT",create:"POST","delete":"DELETE"};var _baseActions=["read","update","create","delete"];var _numCallsInProgress=0;var _refreshTokenSuccess=function(c){c()};var _bulkQueues={};var _state={};var HttpError=function(request,textStatus,errorThrown){request=request||{};request.xhr=request.xhr||{};this.request=request;this.status=request.xhr.status;this.responseText=request.xhr.responseText;this.textStatus=textStatus;this.errorThrown=errorThrown;if(typeof this.responseText==="string"&&this.responseText.length>0){try{var contentType=this.request.xhr.getResponseHeader("Content-Type");if(contentType&&contentType.indexOf("application/json")===0){this.payload=JSON.parse(this.responseText);this.code=this.payload.error;this.message=this.payload.error_message}}catch(e){}}};_.extend(HttpError.prototype,{toString:function(){return"HTTP error: "+this.status+"\ntype: "+this.textStatus+"\nerror: "+this.errorThrown+"\nresponse: "+this.responseText+"\ncode: "+this.code+"\nmessage: "+this.message}});var HttpRequest=function(params,debug){this.params=params;this.debug=debug;this.numExecuted=0;this.state={}};_.extend(HttpRequest.prototype,{execute:function(token,mdHash,upHash){if(token){this.params.headers=this.params.headers||{};this.params.headers["OAuth-Token"]=token}if(mdHash){this.params.headers=this.params.headers||{};this.params.headers["X-Metadata-Hash"]=mdHash}if(upHash){this.params.headers=this.params.headers||{};this.params.headers["X-Userpref-Hash"]=upHash}this.state=_.extend(this.state,_state);if(this.debug){console.log("====== Ajax Request Begin ======");console.log(this.params.type+" "+this.params.url);var parsedData=this.params.data?JSON.parse(this.params.data):null;if(parsedData&&parsedData.password)parsedData.password="***";console.log("Payload: ",this.params.data?parsedData:"N/A");var p=$.extend({},this.params);delete p.data;console.log("params: ",p);console.log("====== Request End ======")}if(this.numExecuted==0){var origCallback=this.params.complete;this.params.complete=function(){_numCallsInProgress--;if(_.isFunction(origCallback))origCallback.apply(this,arguments)}}this.xhr=$.ajax(this.params);_numCallsInProgress++;this.numExecuted++}});var bulkXHR=function(result,parentReq){var contents=result.contents||{};this.status=result.status||200;this.statusText=result.status_text||"";this.responseText=_.isObject(contents)?JSON.stringify(contents):contents;this.readyState=4;this._parent=parentReq.xhr;this.headers=result.headers};_.extend(bulkXHR.prototype,{isResolved:function(){return this._parent.isResolved()},getResponseHeader:function(h){return this.headers[h]},getAllResponseHeaders:function(){return _.reduce(this.headers,function(str,value,key){return str.concat(key+": "+value+"\n")},"")}});function SugarApi(args){var _serverUrl,_platform,_keyValueStore,_clientID,_timeout,_refreshingToken,_defaultErrorHandler,_externalLogin,_allowBulk,_externalLoginUICallback=null,_accessToken=null,_refreshToken=null,_downloadToken=null,_rqueue=[],_requests={},_ruid=0;_keyValueStore=args&&args.keyValueStore;_serverUrl=args&&args.serverUrl||"/rest/v10";_defaultErrorHandler=args&&args.defaultErrorHandler||null;_platform=args&&args.platform||"";_clientID=args&&args.clientID||"sugar";_timeout=(args&&args.timeout||30)*1e3;_externalLogin=false;_allowBulk=!(args&&args.disableBulkApi);if(args&&args.externalLoginUICallback&&_.isFunction(args.externalLoginUICallback)){_externalLoginUICallback=args.externalLoginUICallback}if(_keyValueStore){if(!$.isFunction(_keyValueStore.set)||!$.isFunction(_keyValueStore.get)||!$.isFunction(_keyValueStore.cut)){throw new Error("Failed to initialize Sugar API: key/value store provider is invalid")}var init=function(){_accessToken=_keyValueStore.get("AuthAccessToken");_refreshToken=_keyValueStore.get("AuthRefreshToken");_downloadToken=_keyValueStore.get("DownloadToken")};if($.isFunction(_keyValueStore.initAsync)){_keyValueStore.initAsync(init)}else{init()}if($.isFunction(_keyValueStore.on)){_keyValueStore.on("cache:clean",function(callback){callback(["AuthAccessToken","AuthRefreshToken","DownloadToken"])})}}_refreshingToken=false;if(args&&args.reset)_numCallsInProgress=0;var _resetAuth=function(data){if(data){_accessToken=data.access_token;_refreshToken=data.refresh_token;_downloadToken=data.download_token;if(_keyValueStore){_keyValueStore.set("AuthAccessToken",_accessToken);_keyValueStore.set("AuthRefreshToken",_refreshToken);_keyValueStore.set("DownloadToken",_downloadToken)}}else{_accessToken=null;_refreshToken=null;_downloadToken=null;if(_keyValueStore){_keyValueStore.cut("AuthAccessToken");_keyValueStore.cut("AuthRefreshToken");_keyValueStore.cut("DownloadToken")}}};var _handleErrorAndRefreshToken=function(self,request,callbacks){return function(xhr,textStatus,errorThrown){var error=new HttpError(request,textStatus,errorThrown);var onError=function(){if(_rqueue.length==0||self.refreshingToken(request.params.url)){if(callbacks.error){callbacks.error(error)}else if($.isFunction(self.defaultErrorHandler)){self.defaultErrorHandler(error)}}else{for(var i=0;i<_rqueue.length;++i){if(_rqueue[i]._oerror)_rqueue[i]._oerror(error)}}self.setRefreshingToken(false)};var r,refreshFailed=true;if(self.needRefreshAuthToken(request.params.url,error.code)){if(request._dequeuing){if(request._oerror)request._oerror(error);self.resetAuth();return}_rqueue.push(request);self.setRefreshingToken(true);var refreshCallbacks={complete:function(){if(refreshFailed){while(r=_rqueue.shift()){if(r._ocomplete)r._ocomplete.call(this,r)}}},success:function(){self.setRefreshingToken(false);refreshFailed=false;_refreshTokenSuccess(function(){while(r=_rqueue.shift()){r._dequeuing=true;r.execute(self.getOAuthToken())}})},error:onError};if(!("crosstab"in window)||!crosstab.supported){self.login(null,{refresh:true},{complete:refreshCallbacks.complete,success:refreshCallbacks.success,error:refreshCallbacks.error});return}crosstab(function(){crosstab.on("auth:refresh:complete",function(event){var status=event.data;switch(status){case"success":refreshCallbacks.success();break;case"error":refreshCallbacks.error();break;case"complete":refreshCallbacks.complete();crosstab.off("auth:refresh:complete");break}});crosstab.broadcastMaster("auth:refresh")})}else if(self.needQueue(request.params.url)){_rqueue.push(request)}else if(_externalLogin&&error.status==401&&error.payload&&error.payload.url){if(!self.isLoginRequest(request.params.url)){_rqueue.push(request)}self.setRefreshingToken(true);$(window).on("message",function(event){if(!event.originalEvent.origin||event.originalEvent.origin!=window.location.origin){return}$(window).on("message",null);authData=$.parseJSON(event.originalEvent.data);if(!authData||!authData.access_token){onError()}self.setRefreshingToken(false);_resetAuth(authData);_refreshTokenSuccess(function(){while(r=_rqueue.shift()){r.execute(self.getOAuthToken())}})});if(_.isFunction(_externalLoginUICallback)){_externalLoginUICallback(error.payload.url,"_blank","width=600,height=400,centerscreen=1,resizable=1")}}else{onError()}}};return{clientID:_clientID,serverUrl:_serverUrl,defaultErrorHandler:_defaultErrorHandler,timeout:_timeout,debug:false,abortRequest:function(id){var request=_requests[id];if(request){request.aborted=true;if(request.xhr){request.xhr.abort()}}},getRequest:function(id){return _requests[id]},setRefreshTokenSuccessCallback:function(callback){if(_.isFunction(callback))_refreshTokenSuccess=callback},call:function(method,url,data,callbacks,options){var request,args,type=_methodsToRequest[method],self=this,token=this.getOAuthToken();var params={type:type,dataType:"json",headers:{},timeout:this.timeout,contentType:"application/json"};options=options||{};callbacks=callbacks||{};if(!options.url){params.url=url}if(callbacks.success){params.success=function(data,status){request.status=data&&data.status?data.status:status;callbacks.success(data,request)}}params.complete=function(){delete _requests[request.uid];if(!_refreshingToken&&callbacks.complete){callbacks.complete(request)}};if(options.iframe===true){if(token){data=data||{};data["OAuth-Token"]=token;params.data=data}}else{if(data&&(method=="create"||method=="update"||method=="delete")){params.data=JSON.stringify(data)}}if(params.type!=="GET"){params.processData=false}request=new HttpRequest(_.extend(params,options),this.debug);params.error=_handleErrorAndRefreshToken(self,request,callbacks);request._oerror=callbacks.error;request._ocomplete=callbacks.complete;request.uid=_ruid++;_requests[request.uid]=request;args=[token,options.skipMetadataHash?null:this.getMetadataHash(),options.skipMetadataHash?null:this.getUserprefHash()];if(this.isLoginRequest(url)){request.execute()}else if(this.isAuthRequest(url)){request.execute(token)}else if(params.bulk&&_allowBulk){var bulkQueue=_bulkQueues[params.bulk]||[];if(!_bulkQueues[params.bulk]){_bulkQueues[params.bulk]=bulkQueue}bulkQueue.push({request:request,args:args})}else{request.execute.apply(request,args)}return request},triggerBulkCall:function(bulkId){if(!_allowBulk){return}bulkId=bulkId||true;var queue=_bulkQueues[bulkId],requests=[],version=_.last(this.serverUrl.split("/"));if(!queue){return}_.each(queue,function(r){var params=r.request.params,args=r.args,token=args[0],mdHash=args[1],upHash=args[2];if(token){params.headers=params.headers||{};params.headers["OAuth-Token"]=token}if(mdHash){params.headers=params.headers||{};params.headers["X-Metadata-Hash"]=mdHash}if(upHash){params.headers=params.headers||{};params.headers["X-Userpref-Hash"]=upHash}if(params.url!=""){params.url=version+params.url.substring(this.serverUrl.length)}requests.push(params)},this);this.call("create",this.buildURL("bulk"),{requests:requests},{success:function(o,parentReq){_.each(queue,function(r,i){var request=r.request,result=o[i],contents=result.contents||{},xhr=new bulkXHR(result,parentReq),error;request.xhr=xhr;if(request.aborted===true||contents.error){request.status="error";if(_.isFunction(request.params.error)){request.params.error.call(request.params,request,"error",xhr.statusText)}}else{if(_.isFunction(request.params.success)){request.params.success.call(request.params,contents,"success")}}if(_.isFunction(request.params.complete)){request.params.complete.call(request.params,request)}})}});_bulkQueues[bulkId]=null},clearBulkQueue:function(){_bulkQueues={}},buildURL:function(module,action,attributes,params){params=params||{};var parts=[];var url;parts.push(this.serverUrl);if(module){parts.push(module)}if(action!="create"&&attributes&&attributes.id){parts.push(attributes.id)}if(attributes&&attributes.link&&action!="file"){parts.push("link");if(_.isString(attributes.link)){parts.push(attributes.link)}}if(action&&$.inArray(action,_baseActions)===-1){parts.push(action)}if(attributes&&attributes.relatedId){parts.push(attributes.relatedId)}if(attributes&&action=="file"&&attributes.field){parts.push(attributes.field);if(attributes.fileId)parts.push(attributes.fileId)}url=parts.join("/");_.each(params,function(value,key){if(value===null||value===undefined){delete params[key]}});params=$.param(params);if(params.length>0){url+="?"+params}return url},buildFileURL:function(attributes,options){var params={};options=options||{};if(attributes.field&&options.htmlJsonFormat!==false){params.format="sugar-html-json"}if(options.deleteIfFails===true){params.delete_if_fails=true}if(options.passOAuthToken){params.oauth_token=this.getOAuthToken()}if(options.passDownloadToken){params.download_token=this.getDownloadToken()}if(!_.isUndefined(options.forceDownload)){params.force_download=options.forceDownload?1:0}if(options.cleanCache===true){params[(new Date).getTime()]=1}if(options.platform!==undefined){params.platform=options.platform}else if(_platform){params.platform=_platform}if(options.keep===true){params.keep=1}return this.buildURL(attributes.module,"file",attributes,params)},getOAuthToken:function(){return _keyValueStore?_keyValueStore.get("AuthAccessToken")||_accessToken:_accessToken},getRefreshToken:function(){return _keyValueStore?_keyValueStore.get("AuthRefreshToken")||_refreshToken:_refreshToken},getDownloadToken:function(){return _keyValueStore?_keyValueStore.get("DownloadToken")||_downloadToken:_downloadToken},getMetadataHash:function(){return _keyValueStore?_keyValueStore.get("meta:hash"):null},getUserprefHash:function(){return _keyValueStore?_keyValueStore.get("userpref:hash"):null},getMetadata:function(hash,types,modules,callbacks,options){options=options||{};var params=options.params||{},method,url;if(types){params.type_filter=types.join(",")}if(modules){params.module_filter=modules.join(",")}if(_platform){params.platform=_platform}method="read";if(options&&options.getPublic){method="public"}params.module_dependencies=1;url=this.buildURL("metadata",method,null,params);return this.call(method,url,null,callbacks)},records:function(method,module,data,params,callbacks,options){var url=this.buildURL(module,method,data,params);return this.call(method,url,data,callbacks,options)},relationships:function(method,module,data,params,callbacks,options){var url=this.buildURL(module,null,data,params);return this.call(method,url,data.related,callbacks,options)},favorite:function(module,id,favorite,callbacks,options){var action=favorite?"favorite":"unfavorite";var url=this.buildURL(module,action,{id:id});return this.call("update",url,null,callbacks,options)},follow:function(module,id,followed,callbacks,options){callbacks=callbacks||{};options=options||{};var method=followed?"create":"delete",action=followed?"subscribe":"unsubscribe",url=this.buildURL(module,action,{id:id});return this.call(method,url,null,callbacks,options)},enumOptions:function(module,field,callbacks,options){var url=this.buildURL(module+"/enum/"+field);return this.call("read",url,null,callbacks,options)},fileDownload:function(url,callbacks,options){options=options||{};var internalCallbacks={};internalCallbacks.success=function(data){if(options.iframe){options.iframe.prepend('<iframe class="hide" src="'+url+'"></iframe>')}else{window.location.href=url}if(_.isFunction(callbacks.success)){callbacks.success.apply(arguments)}};if(_.isFunction(callbacks.error)){internalCallbacks.error=callbacks.error}if(_.isFunction(callbacks.complete)){internalCallbacks.complete=callbacks.complete}return this.call("read",this.buildURL("ping"),{},internalCallbacks,{processData:false})},file:function(method,data,$files,callbacks,options){var ajaxParams={files:$files,processData:false};if(method==="delete"){ajaxParams.iframe=false}else if(!options||options.iframe!==false){ajaxParams.iframe=true;options=options||{};options.passOAuthToken=true}if(!options||options.deleteIfFails!==false){options=options||{};options.deleteIfFails=true}callbacks.success=_.wrap(callbacks.success,function(success,data,request){if(data.error&&_.isFunction(callbacks.error)){callbacks.error(data)}else if(_.isFunction(success)){success(data)}});return this.call(method,this.buildFileURL(data,options),null,callbacks,ajaxParams)},count:function(module,data,callbacks,options){options=options||{};var url=this.buildURL(module,"count",data,options);return this.call("read",url,null,callbacks)},exportRecords:function(params,$el,callbacks,options){var self=this;var recordListUrl=this.buildURL(params.module,"record_list");options=options||{};return this.call("create",recordListUrl,{records:params.uid},{success:function(response){params=_.omit(params,["uid","module"]);if(options.platform!==undefined){params.platform=options.platform}else if(_platform){params.platform=_platform}self.fileDownload(self.buildURL(response.module_name,"export",{relatedId:response.id},params),callbacks,{iframe:$el})}})},search:function(params,callbacks,options){options=options||{};var data=null;if(options.data){data=options.data;delete options.data}var method="read";if(options.fetchWithPost){method="create"}var endpoint=options.useNewApi?"globalsearch":"search";var url=this.buildURL(null,endpoint,null,params);return this.call(method,url,data,callbacks,options)},login:function(credentials,data,callbacks){var payload,success,error,method,url;credentials=credentials||{};callbacks=callbacks||{};success=function(data){_resetAuth(data);if(callbacks.success)callbacks.success(data)};error=function(error){_resetAuth();if(callbacks.error)callbacks.error(error)};if(data&&data.refresh){payload=_.extend({grant_type:"refresh_token",client_id:this.clientID,client_secret:"",refresh_token:this.getRefreshToken(),platform:_platform?_platform:"base"},data)}else{payload=_.extend({grant_type:"password",username:credentials.username,password:credentials.password,client_id:this.clientID,platform:_platform?_platform:"base",client_secret:""},data);payload.client_info=data}method="create";url=this.buildURL("oauth2","token",payload);return this.call(method,url,payload,{success:success,error:error,complete:callbacks.complete})},me:function(method,data,params,callbacks){var url=this.buildURL("me",method,data,params);return this.call(method,url,data,callbacks)},css:function(platform,themeName,callbacks){var params={platform:platform,themeName:themeName};var url=this.buildURL("css","read",{},params);return this.call("read",url,{},callbacks)},logout:function(callbacks){callbacks=callbacks||{};var payload={token:this.getOAuthToken(),refresh_token:this.getRefreshToken()};var url=this.buildURL("oauth2","logout",payload);var originalComplete=callbacks.complete;callbacks.complete=function(){_resetAuth();if(originalComplete)originalComplete()};return this.call("create",url,payload,callbacks)},ping:function(action,callbacks,options){return this.call("read",this.buildURL("ping",action,null,{platform:_platform}),null,callbacks,_.extend({skipMetadataHash:true},options||{}))},signup:function(contactData,data,callbacks){var payload=contactData;payload.client_info=data;var method="create";var url=this.buildURL("Leads","register",payload);return this.call(method,url,payload,callbacks)},verifyPassword:function(password,callbacks){var payload={password_to_verify:password};var method="create";var url=this.buildURL("me/password",method);return this.call(method,url,payload,callbacks)},updatePassword:function(oldPassword,newPasword,callbacks){var payload={new_password:newPasword,old_password:oldPassword};var method="update";var url=this.buildURL("me/password",method);return this.call(method,url,payload,callbacks)},info:function(callbacks){var url=this.buildURL("ServerInfo");return this.call("read",url,null,callbacks)},isAuthenticated:function(){return typeof this.getOAuthToken()==="string"&&this.getOAuthToken().length>0},resetAuth:function(){_resetAuth()},needRefreshAuthToken:function(url,errorCode){return!_refreshingToken&&(typeof this.getRefreshToken()==="string"&&this.getRefreshToken().length>0)&&!this.isAuthRequest(url)&&errorCode==="invalid_grant"},needQueue:function(url){return _refreshingToken&&!this.isAuthRequest(url)},isAuthRequest:function(url){return new RegExp("/oauth2/").test(url)},isLoginRequest:function(url){return new RegExp("/oauth2/token").test(url)},refreshingToken:function(url){return _refreshingToken&&this.isAuthRequest(url)},setRefreshingToken:function(flag){_refreshingToken=flag},setExternalLogin:function(flag){_externalLogin=flag},setExternalLoginUICallback:function(callback){if(_.isFunction(callback)){_externalLoginUICallback=callback}},getStateProperty:function(key){return _state[key]},setStateProperty:function(key,value){_state[key]=value},clearStateProperty:function(key){delete _state[key]},resetState:function(){_state={}}}}return{getInstance:function(args){return _instance||this.createInstance(args)},createInstance:function(args){_instance=new SugarApi(args);if(!("crosstab"in window)||!crosstab.supported){return _instance}crosstab(function(){crosstab.on("auth:refresh",_.bind(function(){if(this._runningRefreshToken){return}this._runningRefreshToken=true;var self=this;this.login(null,{refresh:true},{complete:function(){crosstab.broadcast("auth:refresh:complete","complete")},success:function(){delete self._runningRefreshToken;crosstab.broadcast("auth:refresh:complete","success")},error:function(){delete self._runningRefreshToken;crosstab.broadcast("auth:refresh:complete","error")}})},_instance))});return _instance},getCallsInProgressCount:function(){return _numCallsInProgress},HttpError:HttpError,HttpRequest:HttpRequest}}();var SUGAR=SUGAR||{};SUGAR.App=function(){var _app,_modules={};var _isSyncing=false;var _syncCallbacks=[];var _make$=function(selector){return selector instanceof $?selector:$(selector)};function App(opts){var appId=_.uniqueId("SugarApp_");opts=opts||{};return _.extend({appId:appId,$rootEl:_make$(opts.el||"body"),$contentEl:_make$(opts.contentEl||"#content"),additionalComponents:{}},this,Backbone.Events)}return{init:function(opts){_app=_app||_.extend(this,new App(opts));_.extend(_app,_app.beforeEvent);_app.events.register("app:init",this);_app.events.register("app:start",this);_app.events.register("app:sync",this);_app.events.register("app:sync:complete",this);_app.events.register("app:sync:error",this);_app.events.register("app:sync:public:error",this);_app.events.register("app:login",this);_app.events.register("app:login:success",this);_app.events.register("app:logout",this);_app.events.register("app:view:change",this);_app.events.register("app:locale:change",this);_app.events.register("lang:direction:change",this);if(_app.cache){_app.cache.init(this)}var className=_app.utils.capitalize(_app.config?_app.config.appId:"")+"Controller";var Klass=this[className]||this.Controller;this.controller=new Klass;_app.api=SUGAR.Api.getInstance({defaultErrorHandler:opts&&opts.defaultErrorHandler?opts.defaultErrorHandler:SUGAR.App.error.handleHttpError,serverUrl:_app.config.serverUrl,platform:_app.config.platform,timeout:_app.config.serverTimeout,keyValueStore:_app[_app.config.authStore||"cache"],clientID:_app.config.clientID,disableBulkApi:_app.config.disableBulkApi,externalLoginUICallback:opts&&opts.externalLoginUICallback});this._init(opts);return _app},_init:function(opts){var self=this;var syncCallback=function(error){if(!_app){return}if(error){self.trigger("app:sync:public:error",error);return}self._initModules();self._loadConfig();if(!opts.silent){_app.trigger("app:init",self)}if(opts.callback&&_.isFunction(opts.callback)){opts.callback(_app)}};var cssCallback=function(callback){if(_app.config.loadCss){_app.loadCss(callback)}else{callback()}};if(_app.config.syncConfig!==false){var options={getPublic:true};cssCallback(function(){_app.metadata.sync(syncCallback,options)})}else{cssCallback(function(){syncCallback()})}return _app},_initModules:function(){_.each(_modules,function(module){if(_.isFunction(module.init)){module.init(this)}},this)},_loadConfig:function(){_app.config=_app.config||{};_app.config=_.extend(_app.config,_app.metadata.getConfig())},loadCss:function(callback){_app.api.css(_app.config.platform,_app.config.themeName,{success:function(rsp){if(_app.config.loadCss==="url"){_.each(rsp.url,function(url){$("<link>").attr({rel:"stylesheet",href:_app.utils.buildUrl(url)}).appendTo("head")})}else{_.each(rsp.text,function(text){$("<style>").html(text).appendTo("head")})}if(_.isFunction(callback)){callback()}}})},start:function(){_app.events.registerAjaxEvents();_app.trigger("app:start",this);_app.routing.start()},destroy:function(){if(Backbone.history){Backbone.history.stop()}_app=null},augment:function(name,obj,init){this[name]=obj;_modules[name]=obj;if(init&&obj.init&&_.isFunction(obj.init)){obj.init.call(obj,_app)}},sync:function(options){var self=this;options=options||{};if(options.getPublic){return self.syncPublic(options)}if(options.callback){_syncCallbacks.push(options.callback)}if(_isSyncing){return}_isSyncing=true;async.waterfall([function(callback){self.isSynced=false;self.trigger("app:sync");var doUpdateLanguage=!options.noUserUpdate&&(options.language||_app.cache.get("langHasChanged"));if(doUpdateLanguage){var language=options.language||_app.lang.getLanguage();self.user.updateLanguage(language,callback);_app.cache.cut("langHasChanged")}else{callback()}},function(cbw){async.parallel([function(callback){self.user.load(callback)},function(callback){self.metadata.sync(function(err){self.data.declareModels();callback(err)},options)}],function(err){cbw(err)})}],function(err){if(err){self.trigger("app:sync:error",err)}else{self.isSynced=true;self.trigger("app:sync:complete")}_.each(_syncCallbacks,function(callback){callback(err)});_isSyncing=false;_syncCallbacks=[]})},syncPublic:function(options){options=options||{};options.getPublic=true;this.metadata.sync(options.callback,options)},navigate:function(context,model,action){var route,id,module;context=context||_app.controller.context;model=model||context.get("model");id=model.id;module=context.get("module")||model.module;route=this.router.buildRoute(module,id,action);this.router.navigate(route,{trigger:true})},login:function(credentials,info,callbacks){callbacks=callbacks||{};info=info||{};info.current_language=_app.lang.getLanguage();_app.api.login(credentials,info,{success:function(data){_app.trigger("app:login:success",data);if(callbacks.success)callbacks.success(data)},error:function(error){_app.error.handleHttpError(error);if(callbacks.error)callbacks.error(error)},complete:callbacks.complete})},logout:function(callbacks,clear){var originalComplete,originalError;callbacks=callbacks||{};originalComplete=callbacks.complete;originalError=callbacks.error;callbacks.complete=function(data){_app.trigger("app:logout",clear);if(originalComplete){originalComplete(data)}};callbacks.error=function(error){_app.error.handleHttpError(error);if(originalError)originalError(error)};return _app.api.logout(callbacks)},isServerCompatible:function(data){var flavors=this.config.supportedServerFlavors,minVersion=this.config.minServerVersion,isSupportedFlavor,isSupportedVersion,error;if(_.isEmpty(flavors)&&!minVersion){return true}isSupportedFlavor=!!(_.isEmpty(flavors)||data&&_.contains(flavors,data.flavor));isSupportedVersion=!!(!minVersion||data&&this.utils.versionCompare(data.version,minVersion,">="));if(isSupportedFlavor&&isSupportedVersion){return true}else if(!isSupportedVersion){error={code:"server_version_incompatible",label:"ERR_SERVER_VERSION_INCOMPATIBLE"}}else{error={code:"server_flavor_incompatible",label:"ERR_SERVER_FLAVOR_INCOMPATIBLE"}}error.server_info=data;return error},modules:_modules}}();(function(app){var _doWhenStack=[],_doWhenLocked=false,_doWhenInterval=false,_doWhenretryCount=0,_startDoWhenInterval=function(){if(!_doWhenInterval){_doWhenInterval=window.setInterval(app.utils._doWhenCheck,50)}};app.augment("utils",{capitalize:function(s){return s?s.charAt(0).toUpperCase()+(s.length>1?s.substr(1):""):""},capitalizeHyphenated:function(s){return this._classify(s,"-")},classify:function(s){return this._classify(s,"_")},_classify:function(s,delimiter){var self=this,result="";delimiter=delimiter||"_";if(!s||s.lastIndexOf(delimiter)===-1){result=self.capitalize(s)}else{var words=s.split(delimiter);_.each(words,function(word){result+=self.capitalize(word)})}return result},extendClass:function(cache,base,className,controller,platformNamespace){var klass=null,evaledController=null;if(_.isObject(controller)){base=_.isObject(controller.extendsFrom)?controller.extendsFrom:cache[platformNamespace+"Custom"+controller.extendsFrom]||cache[platformNamespace+controller.extendsFrom]||cache["Custom"+controller.extendsFrom]||cache[controller.extendsFrom]||base;klass=cache[className]=base.extend(controller)}else{klass=cache[className]=base}return klass},formatNumber:function(value,round,precision,numberGroupSeparator,decimalSeparator){round=round||precision;var original=value;if(_.isNaN(value)||!_.isFinite(value)){return original}if(_.isString(value)){value=parseFloat(value,10);if(_.isNaN(value)){return original}}if(!_.isNumber(value)){if(!_.isNull(value)&&!_.isUndefined(value)){app.logger.warn("formatNumber: invalid variable type ("+typeof original+")")}return original}value=parseFloat(value.toFixed(round),10).toFixed(precision).toString();return _.isString(numberGroupSeparator)&&_.isString(decimalSeparator)?this.addNumberSeparators(value,numberGroupSeparator,decimalSeparator):value},formatNumberLocale:function(value){return this.formatNumber(value,app.user.getPreference("decimal_precision")||2,app.user.getPreference("decimal_precision")||2,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".")},formatName:function(params,format){return format.replace(/(f)|(l)|(s)/g,function(str,firstName,lastName,salutation){if(firstName){return params.first_name||""}if(lastName){return params.last_name||""}if(salutation&&(params.last_name||params.first_name)){return params.salutation||""}return""}).replace(/^( )?,/g,"").replace(/, $/g,"").replace(/  /g," ").trim()},formatNameModel:function(module,data,format){format=format||app.user.getPreference("default_locale_name_format");data=data||{};var metadata=app.metadata.getModule(module)||{fields:{}};var formatMap=metadata.nameFormat||{};return _.reduce(format.split(""),function(formattedString,letter){if(letter<"a"||letter>"z"){return formattedString+letter}if(!formatMap[letter]){return formattedString}var enumLabel,isEnum=metadata.fields[formatMap[letter]]&&metadata.fields[formatMap[letter]].type==="enum"&&!_.isEmpty(metadata.fields[formatMap[letter]].options);if(isEnum){var list=app.lang.getAppListStrings(metadata.fields[formatMap[letter]].options);enumLabel=list[data[formatMap[letter]]]||data[formatMap[letter]]||""}return formattedString+(enumLabel||data[formatMap[letter]]||"")},"").replace(/^( )?,/g,"").replace(/, +$/g,"").replace(/  /g," ").trim()},formatNameLocale:function(params){return this.formatName(params,app.user.getPreference("default_locale_name_format"))},addNumberSeparators:function(numberString,numberGroupSeparator,decimalSeparator){var numberArray=numberString.split(".");var regex=/(\d+)(\d{3})/;while(numberGroupSeparator!==""&&regex.test(numberArray[0])){numberArray[0]=numberArray[0].toString().replace(regex,"$1"+numberGroupSeparator+"$2")}return numberArray[0]+(numberArray.length>1&&numberArray[1]!==""?decimalSeparator+numberArray[1]:"")},addNumberSeperators:function(numberString,numberGroupSeparator,decimalSeparator){app.logger.warn("`addNumberSeperators` is deprecated since 7.7 and will be removed in 7.9."+"Please use `addNumberSeparators` instead.");return this.addNumberSeparators(numberString,numberGroupSeparator,decimalSeparator)},unformatNumberString:function(numberString,numberGroupSeparator,decimalSeparator,toFloat){toFloat=toFloat||false;if(typeof numberGroupSeparator==="undefined"||typeof decimalSeparator==="undefined"){return numberString}if(!_.isString(numberString)){if(_.isFinite(numberString)){numberString.toString()}else{numberString=""}}if(numberGroupSeparator!==""){var num_grp_sep_re=new RegExp("\\"+numberGroupSeparator,"g");numberString=numberString.replace(num_grp_sep_re,"")}numberString=numberString.replace(decimalSeparator,".");if(numberString.length>0&&toFloat){var float=parseFloat(numberString);if(float==numberString){return float}}return numberString},unformatNumberStringLocale:function(value,toFloat){return this.unformatNumberString(value,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".",toFloat)},formatString:function(format,args){for(var idx in args){format=format.replace("{"+idx+"}",args[idx])}return format},regexEscape:function regexEscape(string){if(typeof regexEscape.specialRegExp=="undefined"){var specials=["/",".","*","+","?","|","(",")","[","]","{","}","\\","-",",","^","$","#"];regexEscape.specialRegExp=new RegExp("(\\"+specials.join("|\\")+")","g")}return string.replace(regexEscape.specialRegExp,"\\$1")},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16);

})},cookie:{setCookie:function(cName,value,exdays,path){var exdate=new Date,c_value;exdate.setDate(exdate.getDate()+exdays);c_value=encodeURIComponent(value);if(exdays){c_value+="; expires="+exdate.toUTCString()}if(path){c_value+="; path="+path}document.cookie=cName+"="+c_value},getCookie:function(cName){var i,x,y,ARRcookies=document.cookie.split(";");for(i=0;i<ARRcookies.length;i++){x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);x=x.replace(/^\s+|\s+$/g,"");if(x===cName){return decodeURIComponent(y)}}}},isValidEmailAddress:function(address){return/^.+@.+$/gi.test(address)},doWhen:function(condition,callback,params,scope){_doWhenStack.push({check:condition,fn:callback,obj:params,overrideContext:scope});_doWhenretryCount=50;_startDoWhenInterval()},_doWhenCheck:function(){if(_doWhenStack.length===0){_doWhenretryCount=0;if(_doWhenInterval){clearInterval(_doWhenInterval);_doWhenInterval=null}return}if(_doWhenLocked){return}_doWhenLocked=true;var tryAgain=$.isReady;if(!tryAgain){tryAgain=_doWhenretryCount>0&&_doWhenStack.length>0}var notAvail=[];var executeItem=function(context,item){if(item.overrideContext){if(item.overrideContext===true){context=item.obj}else{context=item.overrideContext}}if(item.fn){item.fn.call(context,item.obj)}};var i,len,item,test;for(i=0,len=_doWhenStack.length;i<len;i=i+1){item=_doWhenStack[i];if(item){test=item.check;if(typeof test=="string"&&eval(test)||typeof test=="function"&&test()){executeItem(this,item);_doWhenStack[i]=null}else{notAvail.push(item)}}}_doWhenretryCount--;if(tryAgain){for(i=_doWhenStack.length-1;i>-1;i--){item=_doWhenStack[i];if(!item||!item.check){_doWhenStack.splice(i,1)}}_startDoWhenInterval()}else{if(_doWhenInterval){clearInterval(_doWhenInterval);_doWhenInterval=null}}_doWhenLocked=false},versionCompare:function(v1,v2,operator){return version_compare(v1,v2,operator)},extendFrom:function(subc,superc,overrides){subc.prototype=new superc;_.extend(subc.prototype,overrides)},deepCopy:function(obj){return _.isObject(obj)?JSON.parse(JSON.stringify(obj)):obj},compareBeans:function(beanA,beanB){var changedFields;if(beanA.module!==beanB.module){throw Error("Only beans of the same module can be compared.")}changedFields=_.reduce(beanA.attributes,function(memo,value,attribute){if(attribute!=="id"&&attribute.indexOf("_")!==0){if(!this.areBeanValuesEqual(value,beanB.get(attribute))&&this.hasDefaultValueChanged(attribute,beanA)){memo.push(attribute)}}return memo},[],this);return changedFields},areBeanValuesEqual:function(value1,value2){var getValueToCompare=function(value){if(_.isObject(value)&&_.isEmpty(value)){return""}else if(!_.isObject(value)&&(_.isUndefined(value)||_.isNull(value))){return""}else{return value}};value1=getValueToCompare(value1);value2=getValueToCompare(value2);return _.isObject(value1)&&_.isEqual(value1,value2)||!_.isObject(value1)&&value1===value2},hasDefaultValueChanged:function(attribute,bean){var defaultValue=bean._defaults?bean._defaults[attribute]:"";return!this.areBeanValuesEqual(defaultValue,bean.get(attribute))},buildUrl:function(url){if(url.indexOf("http")!==0&&!_.isEmpty(app.config.siteUrl)){url=app.config.siteUrl.replace(/\/+$/,"")+"/"+url}return url},getParentLayout:function(component){var parent;if(component.view&&component.view.layout){parent=component.view.layout}else{parent=component.layout}return parent},isSortable:function(module,fieldViewdef){var fieldVardef=app.metadata.getModule(module).fields[fieldViewdef.name],isSortable=true;if(fieldVardef&&!_.isUndefined(fieldVardef.sortable)){isSortable=fieldVardef.sortable}if(fieldViewdef&&!_.isUndefined(fieldViewdef.sortable)){isSortable=fieldViewdef.sortable}return isSortable},hardRefresh:function(){window.location.reload(true)},isDirectionRTL:function(value){var ltrChars="A-Za-zÀ-ÖØ-öø-ʸ̀-֐ࠀ-῿"+"Ⰰ-﬜﷾-﹯﻽-￿",rtlChars="֑-߿יִ-﷽ﹰ-ﻼ",isRTL=new RegExp("^[^"+ltrChars+"]*["+rtlChars+"]");return isRTL.test(value)}})})(SUGAR.App);(function(app){var date=moment;_.extend(date,{InvalidException:function(message,date){this.name="InvalidException";this.message=message;this.date=date},_cachedFormats:{},_serverDateFormat:"YYYY-MM-DD",convertFormat:function(server){if(date._cachedFormats[server]){return date._cachedFormats[server]}var convertTable={d:"DD",m:"MM",Y:"YYYY",H:"HH",h:"hh",i:"mm"};var client=server;_.each(convertTable,function(to,from){client=client.replace(from,to)});date._cachedFormats[server]=client;return client},compare:function(date1,date2){var mDate1=moment(date1),mDate2=moment(date2);if(!mDate1.isValid()){throw new date.InvalidException("Invalid date passed for comparison.",date1)}if(!mDate2.isValid()){throw new date.InvalidException("Invalid date passed for comparison.",date2)}if(mDate1.isBefore(mDate2)){return-1}if(mDate1.isAfter(mDate2)){return 1}return 0},getUserDateFormat:function(user){user=user||app.user;return this.convertFormat(user.getPreference("datepref"))},getUserTimeFormat:function(user){user=user||app.user;return this.convertFormat(user.getPreference("timepref"))}});var _formatStringCache={};_.extend(date,{parse:function(date,oldFormat){var jsDate=new Date("Jan 1, 1970 00:00:00"),part="",dateRemain,j,c,i,v,timeformat;if(date instanceof Date)return date;if(!oldFormat){oldFormat=this.guessFormat(date)}if(oldFormat===false){if(/^\d+$/.test(date)){return new Date(date)}return false}dateRemain=$.trim(date);oldFormat=$.trim(oldFormat)+" ";for(j=0;j<oldFormat.length;j++){c=oldFormat.charAt(j);if(c===":"||c==="/"||c==="-"||c==="."||c===" "||c==="a"||c==="A"){i=dateRemain.indexOf(c);if(i===-1)i=dateRemain.length;v=dateRemain.substring(0,i);dateRemain=dateRemain.substring(i+1);switch(part){case"m":if(!(v>0&&v<13))return false;jsDate.setMonth(v-1);break;case"d":if(!(v>0&&v<32))return false;jsDate.setDate(v);break;case"Y":if(v>0===false)return false;jsDate.setYear(v);break;case"h":timeformat=oldFormat.substring(oldFormat.length-4);v=parseInt(v,10);var timeFormatString=$.trim(timeformat.toLowerCase());if(timeFormatString==="i a"||timeFormatString===c+"ia"){var postfix=dateRemain.substring(dateRemain.length-2).toLowerCase();if(postfix==="pm"){if(v<12){v+=12}}else if(postfix==="am"&&v===12){v=0}}jsDate.setHours(v);break;case"H":jsDate.setHours(v);break;case"i":v=v.substring(0,2);jsDate.setMinutes(v);break;case"s":jsDate.setSeconds(v);break}part=""}else{part=c}}return jsDate},guessFormat:function(date){if(typeof date!=="string")return false;var time="",dateSep,dateParts,dateFormat,timeFormat,timeParts,timeSep,ampmCase,timeEnd;if(date.indexOf(" ")!==-1){time=date.substring(date.indexOf(" ")+1,date.length);date=date.substring(0,date.indexOf(" "))}dateSep="/";if(date.indexOf("/")!==-1){}else if(date.indexOf("-")!==-1){dateSep="-"}else if(date.indexOf(".")!==-1){dateSep="."}else{return false}dateParts=date.split(dateSep);dateFormat="";if(dateParts[0].length===4){dateFormat="Y"+dateSep+"m"+dateSep+"d"}else if(dateParts[2].length===4){dateFormat="m"+dateSep+"d"+dateSep+"Y"}else{return false}timeFormat="";timeParts=[];if(time!==""){timeParts.push("i");timeSep=":";if(time.indexOf(".")===2){timeSep="."}if(time.split(timeSep).length===3){timeParts.push("s")}ampmCase="";timeEnd=time.substring(time.length-2,time.length);if(timeEnd.toLowerCase()==="am"||timeEnd.toLowerCase()==="pm"){timeParts.unshift("h");if(timeEnd.toLowerCase()===timeEnd){ampmCase="lower"}else{ampmCase="upper"}}else{timeParts.unshift("H")}timeFormat=timeParts.join(timeSep);if(time.indexOf(" ")!==-1){timeFormat+=" "}if(ampmCase&&ampmCase==="upper"){timeFormat+="A"}else if(ampmCase&&ampmCase==="lower"){timeFormat+="a"}dateFormat=dateFormat+" "+timeFormat}return dateFormat},parseFormat:function(format){if(!(format in _formatStringCache)){var parts={},i,c;for(i=0;i<format.length;i++){c=format.charAt(i);switch(c){case"m":case"n":parts.month=c;break;case"d":case"j":parts.day=c;break;case"Y":parts.year=c;break;case"H":case"h":case"g":parts.hours=c;break;case"i":parts.minutes=c;break;case"s":parts.seconds=c;break;case"A":case"a":parts.amPm=c;break;default:break}}_formatStringCache[format]=parts}return _formatStringCache[format]},format:function(date,format){if(!_.isDate(date))return"";var out="",i,c,d,h,m,s;for(i=0;i<format.length;i++){c=format.charAt(i);switch(c){case"\\":out+=format.charAt(i+1);i++;break;case"m":case"n":m=date.getMonth()+1;out+=m<10&&c==="m"?"0"+m:m;break;case"d":case"j":d=date.getDate();out+=d<10&&c==="d"?"0"+d:d;break;case"Y":out+=date.getFullYear();break;case"H":case"h":case"g":h=date.getHours();if(c==="h"||c==="g"){h=h>12?h-12:h;h=h===0?12:h}out+=h<10&&c!=="g"?"0"+h:h;break;case"i":m=date.getMinutes();out+=m<10?"0"+m:m;break;case"s":s=date.getSeconds();out+=s<10?"0"+s:s;break;case"a":case"A":if(date.getHours()<12)out+=c==="a"?"am":"AM";else out+=c==="a"?"pm":"PM";break;default:out+=c}}return out},roundTime:function(date){if(!date.getMinutes)return 0;var min=date.getMinutes();if(min<1){min=0}else if(min<16){min=15}else if(min<31){min=30}else if(min<46){min=45}else{min=0;date.setHours(date.getHours()+1)}date.setMinutes(min);return date},UTCtoLocalTime:function(date){if(!(date instanceof Date))return date;return new Date(this.toUTC(date))},UTCtoTimezone:function(date,offset){if(!(date instanceof Date)||undefined===offset||null===offset){return date}offset=parseFloat(offset)*60*60*1e3;offset-=date.getTimezoneOffset()*60*1e3*-1;return new Date(this.toUTC(date)+offset)},toUTC:function(date){if(!(date instanceof Date)){return date}var year=date.getFullYear(),month=date.getMonth(),day=date.getDate(),hours=date.getHours(),minutes=date.getMinutes(),seconds=date.getSeconds(),milliseconds=date.getMilliseconds();return Date.UTC(year,month,day,hours,minutes,seconds,milliseconds)},getRelativeTimeLabel:function(date){var rightNow=new Date;var isFuture=rightNow.getTime()<date.getTime();var diff=isFuture?date-rightNow:rightNow-date;var second=1e3,minute=second*60,hour=minute*60,day=hour*24,ctx={str:"",value:undefined};if(isNaN(diff)||diff<0){return ctx}if(diff<second*2){ctx.str="LBL_TIME_AGO_NOW";return ctx}if(diff<minute){ctx.str=isFuture?"LBL_TIME_UNTIL_SECONDS":"LBL_TIME_AGO_SECONDS";ctx.value=Math.floor(diff/second);return ctx}if(diff<minute*2){ctx.str=isFuture?"LBL_TIME_UNTIL_MINUTE":"LBL_TIME_AGO_MINUTE";return ctx}if(diff<hour){ctx.str=isFuture?"LBL_TIME_UNTIL_MINUTES":"LBL_TIME_AGO_MINUTES";ctx.value=Math.floor(diff/minute);return ctx}if(diff<hour*2){ctx.str=isFuture?"LBL_TIME_UNTIL_HOUR":"LBL_TIME_AGO_HOUR";return ctx}if(diff<day){ctx.str=isFuture?"LBL_TIME_UNTIL_HOURS":"LBL_TIME_AGO_HOURS";ctx.value=Math.floor(diff/hour);return ctx}if(diff>day&&diff<day*2){ctx.str=isFuture?"LBL_TIME_UNTIL_DAY":"LBL_TIME_AGO_DAY";return ctx}if(diff<day*365){ctx.str=isFuture?"LBL_TIME_UNTIL_DAYS":"LBL_TIME_AGO_DAYS";ctx.value=Math.floor(diff/day);return ctx}else{ctx.str=isFuture?"LBL_TIME_UNTIL_YEAR":"LBL_TIME_AGO_YEAR";return ctx}},parseDisplayDefault:function(displayDefault,now){var dateMap,d,dt,humanDate,defaultTime,addMonths,next,setTimePart,dateObj=now?now:new Date,op,timeAway,parts,timeParts;if(!displayDefault)return displayDefault;addMonths=function(d,n){var day=d.getDate();d.setMonth(d.getMonth()+n);if(d.getDate()<day){d.setDate(1);d.setDate(d.getDate()-1)}return d};next=function(day){var days,todayDay,i,daysUntilNext;days=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];todayDay=dateObj.getDay();day=day.toLowerCase();for(var i=7;i--;){if(day===days[i]){day=i<=todayDay?i+7:i;break}}daysUntilNext=day-todayDay;return daysUntilNext};dateMap={day:function(operator){return new Date(dateObj.setDate(dateObj.getDate()+operator))},week:function(operator){return new Date(dateObj.setDate(dateObj.getDate()+operator*7))},month:function(operator){return addMonths(dateObj,operator)},year:function(operator){return addMonths(dateObj,operator*12)},now:function(){return dateObj},"next monday":function(){return new Date(dateObj.setDate(dateObj.getDate()+next("monday")))},"next friday":function(){return new Date(dateObj.setDate(dateObj.getDate()+next("friday")))},"first of next month":function(){dateObj.setDate(1);var sinceEpoch=dateObj.setMonth(dateObj.getMonth()+1);return new Date(sinceEpoch)}};if(displayDefault&&displayDefault.indexOf("&")>=0){dt=displayDefault.split("&");humanDate=dt[0];defaultTime=dt[1]}else{humanDate=displayDefault}if(humanDate.match(/\b(now|day|week|month|year)/g)){if(humanDate.indexOf("now")===0){timeAway="now"}else if(humanDate.indexOf("first day of next month")!==-1){timeAway="firstnextmonth"}else{parts=humanDate.split(" ");op=parts[0];timeAway=parts[1]}if(timeAway.match("now")){d=dateMap.now()}else if(timeAway.match("firstnextmonth")){d=dateMap["first of next month"]()}else if(timeAway.match("days?")){d=dateMap.day(parseInt(op,10))}else if(timeAway.match("weeks?")){d=dateMap.week(parseInt(op,10))}else if(timeAway.match("months?")){d=dateMap.month(parseInt(op,10))}else if(timeAway.match("years?")){d=dateMap.year(parseInt(op,10))}else{if(!dateMap[humanDate]){return}d=dateMap[humanDate]()}}else{if(!dateMap[humanDate]){return}d=dateMap[humanDate]()}setTimePart=function(d){var timeParts,hours,minutes;timeParts=/^(\d\d?).(\d{2}).?([ap]m)?$/.exec(defaultTime);if(timeParts&&timeParts.length>2){hours=timeParts[1];if(hours){if(timeParts[3]==="pm"){if(hours<12){hours=parseInt(hours,10)+12}}else{if(hours==="12"){hours="0"}}d.setHours(parseInt(hours,10))}minutes=timeParts[2];if(minutes){d.setMinutes(parseInt(minutes,10))}}}(d);return d},toDatepickerFormat:function(formatSpec){if(_.isUndefined(formatSpec)||!formatSpec)return"";var normalizedFormatSpec,sugarToDatepickerMap={y:"yy",Y:"yyyy",m:"mm",d:"dd"};normalizedFormatSpec=formatSpec.replace(/[yYmd]/g,function(s){return sugarToDatepickerMap[s]});return normalizedFormatSpec},stripIsoTimeDelimterAndTZ:function(value){if(!_.isUndefined(value)&&value){return value.replace("T"," ").substr(0,19)}},isIso:function(val){var yyyymmddExact,yyyymmddLooseMatch;yyyymmddExact=val.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/);if(yyyymmddExact){return true}if(val.match(/[T\+Z ]/g)){yyyymmddLooseMatch=val.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])/);if(yyyymmddLooseMatch)return true}return false},compareDates:function(date1,date2){app.logger.warn("date.compareDates() was called and is deprecated. "+"Please update code to use date.compare()");return date.compare(date1,date2)},isDateAfter:function(date1,date2){app.logger.warn("date.isDateAfter() was called and is deprecated. "+"Please update code to use date(date1).isAfter(date2)");return date(date1).isAfter(date2)},isDateBefore:function(date1,date2){app.logger.warn("date.isDateBefore() was called and is deprecated. "+"Please update code to use date(date1).isBefore(date2)");return date(date1).isBefore(date2)},isDateOn:function(date1,date2){app.logger.warn("date.isDateOn() was called and is deprecated. "+"Please update code to use date.isSame()");return date(date1).isSame(date2)},isDateBetween:function(date1,startDate,endDate,inclusive){app.logger.warn("date.isDateBetween() was called and is deprecated. "+"Please update code to use date.isBetween()");return date(date1).isBetween(startDate,endDate,inclusive)}});_.extend(date.fn,{formatUser:function(dateOnly,user){var format=date.getUserDateFormat(user);if(!dateOnly){format+=" "+date.getUserTimeFormat(user)}return this.format(format)},formatServer:function(dateOnly){var format=dateOnly&&date._serverDateFormat;return this.format(format)},isBetween:function(startDate,endDate,inclusive){inclusive=_.isUndefined(inclusive)?true:inclusive;var isInRange=this.isAfter(startDate)&&this.isBefore(endDate);if(inclusive&&!isInRange){isInRange=this.isSame(startDate)||this.isSame(endDate)}return isInRange}});_.extend(date.duration.fn,{format:function(){var duration=[],minutes=this.minutes(),hours=this.hours(),days=Math.floor(this.asDays());if(days>0){duration.push(days);duration.push(app.lang.get(days===1?"LBL_DURATION_DAY":"LBL_DURATION_DAYS"))}if(hours>0){duration.push(hours);duration.push(app.lang.get(hours===1?"LBL_DURATION_HOUR":"LBL_DURATION_HOURS"))}if(minutes>0){duration.push(minutes);duration.push(app.lang.get(minutes===1?"LBL_DURATION_MINUTE":"LBL_DURATION_MINUTES"))}return duration.join(" ")}});app.augment("date",date)})(SUGAR.App);(function(app){app.augment("file",function(){return{checkFileFieldsAndProcessUpload:function(view,callbacks,options,showAlert){app.logger.warn("app.file.checkFileFieldsAndProcessUpload is deprecated as of 7.6.0.");callbacks=callbacks||{};options=options||{};showAlert=_.isUndefined(showAlert)?true:showAlert;var fields=this._getAttachmentFields(view);if(fields.length>0){if(showAlert){app.alert.show("upload",{level:"process",title:"LBL_UPLOADING",autoclose:false})}this._recursiveFileUpload(fields,view.model,callbacks,options,showAlert)}else{if(callbacks.success)callbacks.success({})}},_recursiveFileUpload:function(fields,model,callbacks,options,showAlert,results){results=results||{};var $field,fieldName;if(fields.length===0){if(callbacks.success)callbacks.success(results);return}$field=$(fields.shift());fieldName=$field.attr("name");model.uploadFile(fieldName,$field,{field:fieldName,success:_.bind(function(data){_.extend(results,data);if(fields.length===0){app.alert.dismiss("upload");if(callbacks.success)callbacks.success(results)}else{this._recursiveFileUpload(fields,model,callbacks,options,showAlert,results)}},this),error:_.bind(function(error){if(options&&options.deleteIfFails!==false){model.unset("id",{silent:true})}if(showAlert)app.alert.dismiss("upload");this._triggerFieldValidationError(error,model,fieldName);if(callbacks.error)callbacks.error(error)},this)},options)},_triggerFieldValidationError:function(error,model,fieldName){var errors={};errors[fieldName]={};model.trigger("error:validation:"+fieldName,errors);model.trigger("error:validation",errors)},_getAttachmentFields:function(view){return _.filter(view.$(":file"),function(field){var $field=$(field),fieldValue=$field.val();return!_.isEmpty(fieldValue)&&!_.isEmpty($field.attr("name"))},this)}}}(),false)})(SUGAR.App);(function(app){app.augment("math",{_math:function(operator,n1,n2,decimals,fixed){decimals=_.isFinite(decimals)&&decimals>=0?parseInt(decimals):6;fixed=fixed||false;var result;var divisor=Math.pow(10,decimals);var r1=parseFloat(n1)*divisor;var r2=!_.isUndefined(n2)?parseFloat(n2)*divisor:undefined;switch(operator){case"round":result=Math.round(r1)/divisor;break;case"add":result=(r1+r2)/divisor;break;case"sub":result=(r1-r2)/divisor;break;case"mul":result=this.round(r1*r2/divisor/divisor,decimals,fixed);break;case"div":result=this.round(r1/r2,decimals,fixed);break;default:return n1}return fixed&&!_.isString(result)?result.toFixed(decimals):result},round:function(number,decimals,fixed){return this._math("round",number,null,decimals,fixed)},add:function(n1,n2,decimals,fixed){return this._math("add",n1,n2,decimals,fixed)},sub:function(n1,n2,decimals,fixed){return this._math("sub",n1,n2,decimals,fixed)},mul:function(n1,n2,decimals,fixed){return this._math("mul",n1,n2,decimals,fixed)},div:function(n1,n2,decimals,fixed){return this._math("div",n1,n2,decimals,fixed)},isDifferentWithPrecision:function(newValue,oldValue,precision){var config=app.metadata.getConfig(),user_precision=precision||app.user.getPreference("decimal_precision"),precision=_.isFinite(user_precision)?user_precision:config.defaultCurrencySignificantDigits||2,diff=this._math("round",this.getDifference(newValue,oldValue,true),null,precision),diffPrecision=precision===0?0:this._math("div",.1,Math.pow(10,precision-1));return diff===0?false:diff>=diffPrecision},getDifference:function(newValue,oldValue,absolute){var diff=this._math("sub",newValue,oldValue),absolute=_.isUndefined(absolute)?false:absolute;return absolute?Math.abs(diff):diff}},false)})(SUGAR.App);(function(app){app.augment("currency",{getBaseCurrencyId:function(){return app.metadata.getBaseCurrencyId()},getBaseCurrency:function(){var currId=app.metadata.getBaseCurrencyId(),currencyObj=app.metadata.getCurrency(currId);currencyObj.currency_id=currId;return currencyObj},getCurrenciesSelector:function(template){var currencies={};_.each(app.metadata.getCurrencies(),function(currency,id){currencies[id]=template(currency)});return currencies},getCurrencySymbol:function(currencyId){var currency=app.metadata.getCurrency(currencyId);return currency?currency.symbol:""},formatAmount:function(amount,currencyId,decimalPrecision,numberGroupingSeparator,decimalSeparator,symbolSeparator){if(!_.isFinite(amount)){return amount}var currencySymbol,config=app.metadata.getConfig();currencyId=currencyId||this.getBaseCurrencyId();symbolSeparator=symbolSeparator||"";if(!_.isFinite(decimalPrecision)){if(_.isFinite(config.defaultCurrencySignificantDigits)){decimalPrecision=config.defaultCurrencySignificantDigits}else{decimalPrecision=2}}decimalSeparator=decimalSeparator||config.defaultDecimalSeparator||".";numberGroupingSeparator=!_.isUndefined(numberGroupingSeparator)?numberGroupingSeparator:config.defaultNumberGroupingSeparator||",";currencySymbol=this.getCurrencySymbol(currencyId)||this.getCurrencySymbol(this.getBaseCurrencyId());amount=app.utils.formatNumber(amount,decimalPrecision,decimalPrecision,numberGroupingSeparator,decimalSeparator);return currencySymbol+symbolSeparator+amount},formatAmountLocale:function(amount,currencyId,decimalPrecision){var decimalSeparator=app.user.getPreference("decimal_separator");var numberGroupingSeparator=app.user.getPreference("number_grouping_separator");decimalPrecision=_.isFinite(decimalPrecision)?decimalPrecision:app.user.getPreference("decimal_precision");return this.formatAmount(amount,currencyId,decimalPrecision,numberGroupingSeparator,decimalSeparator)},unformatAmount:function(amount,numberGroupingSeparator,decimalSeparator,toFloat){toFloat=toFloat||false;amount=amount.toString().replace(/^[^\d\.\,-]+/,"");return app.utils.unformatNumberString(amount,numberGroupingSeparator,decimalSeparator,toFloat)},unformatAmountLocale:function(amount,toFloat){var decimalSeparator,numberGroupingSeparator,config=app.metadata.getConfig();decimalSeparator=app.user.getPreference("decimal_separator")||config.defaultDecimalSeparator||".";numberGroupingSeparator=app.user.getPreference("number_grouping_separator")||config.defaultNumberGroupingSeparator||",";return this.unformatAmount(amount,numberGroupingSeparator,decimalSeparator,toFloat)},convertAmount:function(amount,fromId,toId){var currency1;var currency2;if(fromId==toId){return app.math.round(amount,undefined,true)}currency1=app.metadata.getCurrency(fromId);currency2=app.metadata.getCurrency(toId);return this.convertWithRate(amount,currency1.conversion_rate,currency2.conversion_rate)},convertToBase:function(amount,fromId){return this.convertAmount(amount,fromId,this.getBaseCurrencyId())},convertFromBase:function(amount,toId){return this.convertAmount(amount,this.getBaseCurrencyId(),toId)},convertWithRate:function(amount,fromRate,toRate){fromRate=fromRate||1;toRate=toRate||1;return app.math.mul(app.math.div(amount,fromRate,undefined,true),toRate,undefined,true)}},false)})(SUGAR.App);(function(app){var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==="object"){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest))}return false}if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest))}return false}return true};var triggerEvents=function(events,args){var stop=false;var ev,tmp,i=-1,l=events.length;switch(args.length){case 0:case 1:case 2:case 3:while(++i<l)stop=(ev=events[i]).callback.call(ev.ctx,args[0],args[1],args[2])===false||stop;break;default:while(++i<l)stop=(ev=events[i]).callback.apply(ev.ctx,args)===false||stop}return!stop};_.extend(app,{beforeEvent:{before:function(name,callback,context){if(!eventsApi(this,"before",name,[callback,context])||!callback){return this}this._before||(this._before={});var events=this._before[name]||(this._before[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this},triggerBefore:function(name){var stop=false;if(!this._before){return!stop}var args=Array.prototype.slice.call(arguments,1);if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){stop=!this["triggerBefore"].apply(this,[names[i]].concat(args))||stop}return!stop}var events=this._before[name];var allEvents=this._before.all;if(events){stop=triggerEvents(events,args)===false}if(allEvents){stop=triggerEvents(allEvents,args)===false||stop}return!stop},offBefore:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._before||!eventsApi(this,"offBefore",name,[callback,context])){return this}if(!name&&!callback&&!context){this._before=void 0;return this}names=name?[name]:_.keys(this._before);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._before[name]){this._before[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if(callback&&callback!==ev.callback||context&&context!==ev.ctx){retain.push(ev)}}}if(!retain.length){delete this._before[name]}}}return this}}})})(SUGAR.App);(function(app){var _keyPrefix="";var _buildKey=function(key){return _keyPrefix+key};var _cache={store:stash,init:function(){_keyPrefix=app.config.env+":"+app.config.appId+":";app.events.register("cache:clean",this)},has:function(key){if(this.store===stash){return window.localStorage.getItem(_buildKey(key))!==null}else{this.store.has(_buildKey(key))}},get:function(key){return this.store.get(_buildKey(key))},set:function(key,value){try{this.store.set(_buildKey(key),value)}catch(e){if(e.name.toLowerCase().indexOf("quota")>-1){this.clean();this.store.set(_buildKey(key),value)}}},add:function(key,value){try{this.store.add(_buildKey(key),value)}catch(e){if(e.name.toLowerCase().indexOf("quota")>-1){this.clean();this.store.add(_buildKey(key),value)}}},clean:function(){var preserveKeys=[],preservedValues={};this.trigger("cache:clean",function(keys){preserveKeys=_.union(keys,preserveKeys)});_.each(preserveKeys,function(key){preservedValues[key]=this.get(key)},this);this.cutAll();_.each(preservedValues,function(value,key){if(!_.isUndefined(value)){this.set(key,value)}},this)},cut:function(key){if(this.store.has(_buildKey(key))){this.store.cut(_buildKey(key))}},cutAll:function(all){if(all===true)return this.store.cutAll();var obj=this.store.getAll();var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){if(keys[i].indexOf(_keyPrefix)===0){this.store.cut(keys[i])}}}};_.extend(_cache,Backbone.Events);app.augment("cache",_cache)})(SUGAR.App);(function(app,location,cookie){var path=location.pathname.replace(/\/[^\/]*$/,"/cookie.html"),getCookie=function(){return{}};app.augment("cookie",{initAsync:function(callback){var frame=document.createElement("iframe");frame.style.display="none";frame.src=path;document.body.appendChild(frame);frame.contentWindow.onload=function(){getCookie=function(){return frame.contentWindow.getCookie()};callback()}},has:function(key){return key in getCookie()},get:function(key){return getCookie()[key]},set:function(key,value){app.utils.cookie.setCookie(key,value,null,path)},cut:function(key){app.utils.cookie.setCookie(key,"",-1,path)}})})(SUGAR.App,window.location);(function(app){app.augment("events",_.extend({register:function(event,context){context.on(event,function(){var args=[].slice.call(arguments,0);args.unshift(event);this.trigger.apply(this,args)},this)},unregister:function(context,event){context.off(event)},registerAjaxEvents:function(){var self=this;$(document).off("ajaxStop");$(document).off("ajaxStart");$(document).on("ajaxStart",function(args){self.trigger("ajaxStart",args)});$(document).on("ajaxStop",function(args){self.trigger("ajaxStop",args)})}},Backbone.Events))})(SUGAR.App);(function(app){var module={init:function(){this.initialize()},initialize:function(opts){opts=opts||{};this.remoteLogging=opts.remoteLogging||false;this.statusCodes=opts.statusCodes?_.extend(this.statusCodes,opts.statusCodes):this.statusCodes;if(!opts.disableOnError){this.enableOnError()}},_callCustomHandler:function(error,fn,params){if(fn){fn.apply(this,_.union([error],params||[]))}else{this.handleStatusCodesFallback(error)}},_handleFineGrainedError:function(error,alternativeCallback){var handlerName="handle"+app.utils.classify(error.code)+"Error";(this[handlerName]||alternativeCallback||this.handleStatusCodesFallback).call(this,error)},statusCodes:{0:function(error){if(error.textStatus==="timeout"){this._callCustomHandler(error,this.handleTimeoutError)}else{this.handleStatusCodesFallback(error)}},400:function(error){this._handleFineGrainedError(error,this.handleUnspecified400Error)},401:function(error){this._handleFineGrainedError(error,this.handleUnauthorizedError)},403:function(error){this._callCustomHandler(error,this.handleForbiddenError)},404:function(error){this._callCustomHandler(error,this.handleNotFoundError,_.rest(arguments))},405:function(error){this._callCustomHandler(error,this.handleMethodNotAllowedError)},409:function(error){this._callCustomHandler(error,this.handleMethodConflictError)},412:function(error){this._callCustomHandler(error,this.handleHeaderPreconditionFailed)},422:function(error,model){error.model=model;this._callCustomHandler(error,this.handleValidationError,_.rest(arguments))},424:function(error,model){error.model=model;this._callCustomHandler(error,this.handleMethodFailureError,_.rest(arguments))},500:function(error){this._callCustomHandler(error,this.handleServerError)},503:function(error){this._callCustomHandler(error,this.handleServerError)}},remoteLogging:false,errorName2Keys:{maxValue:"ERROR_MAXVALUE",minValue:"ERROR_MINVALUE",maxLength:"ERROR_MAX_FIELD_LENGTH",minLength:"ERROR_MIN_FIELD_LENGTH",datetime:"ERROR_DATETIME",required:"ERROR_FIELD_REQUIRED",email:"ERROR_EMAIL",primaryEmail:"ERROR_PRIMARY_EMAIL",duplicateEmail:"ERROR_DUPLICATE_EMAIL",number:"ERROR_NUMBER",isBefore:"ERROR_IS_BEFORE",isAfter:"ERROR_IS_AFTER",greaterThan:"ERROR_IS_GREATER_THAN",lessThan:"ERROR_IS_LESS_THAN"},getErrorString:function(errorKey,context){var module=context.module||"";return app.lang.get(this.errorName2Keys[errorKey]||errorKey,module,context)},handleValidationError:function(error){var errors=error.responseText;var model=error.model;app.alert.dismissAll();_.each(errors,function(fieldError,key){var errorMsg="";if(_.isObject(fieldError)){_.each(fieldError,function(result,fieldName){errorMsg+="(Message) "+this.getErrorString(fieldName,result)+"\n"},this)}else{errorMsg=fieldError}app.logger.debug("validation failed for field `"+key+"`:\n"+errorMsg)},this)},handleHttpError:function(error,model,options){if(app.error.statusCodes[error.status]){app.error.statusCodes[error.status].call(app.error,error,model,options)}else{app.error.handleStatusCodesFallback(error)}},handleUnhandledError:function(message,url,line){app.logger.fatal(message+" at "+url+" on line "+line)},handleStatusCodesFallback:function(error){app.logger.error(error.toString())},handleRenderError:function(component,method,additionalInfo){var id="render_error_"+component.module+"_"+component.name;var level="error";var title,messages;switch(method){case"_renderHtml":title=app.lang.get("ERR_RENDER_FAILED_TITLE");messages=[app.lang.get("ERR_RENDER_FAILED_MSG"),app.lang.get("ERR_CONTACT_TECH_SUPPORT")];break;case"_renderField":title=app.lang.get("ERR_RENDER_FIELD_FAILED_TITLE");messages=[app.utils.formatString(app.lang.get("ERR_RENDER_FIELD_FAILED_MSG"),[additionalInfo.name]),app.lang.get("ERR_CONTACT_TECH_SUPPORT")];break;case"view_render_denied":title=app.lang.get("ERR_NO_VIEW_ACCESS_TITLE");level="warning";messages=[app.utils.formatString(app.lang.get("ERR_NO_VIEW_ACCESS_MSG"),[component.module])];break;case"layout_render":title=app.lang.get("ERR_LAYOUT_RENDER_TITLE");messages=[app.lang.get("ERR_LAYOUT_RENDER_MSG")];break;default:title=app.lang.get("ERR_GENERIC_TITLE");

messages=[app.lang.get("ERR_INTERNAL_ERR_MSG"),app.lang.get("ERR_CONTACT_TECH_SUPPORT")];app.logger.error("handleRenderError called for render error caught in "+method+", but we have no corresponding handler!");break}app.alert.show(id,{level:level,title:title,messages:messages})},enableOnError:function(handler,context){var originalHandler,self=this;if(this.overloaded){return false}originalHandler=window.onerror;window.onerror=function(mesg,url,line){if(handler){handler.call(context)}else{self.handleUnhandledError(mesg,url,line)}if(originalHandler){originalHandler()}};this.overloaded=true;return true}};app.augment("error",module,false)})(SUGAR.App);(function(app){var _header="(function() {\n  var template = Handlebars.template, templates = Handlebars.templates = Handlebars.templates || {};\n",_footer="})();",_templates={},_sources={},_templateManager;_templateManager={init:function(){_templates=app.config.cacheMeta?app.cache.get("templates")||{}:{};var src="";_.each(_templates,function(t){src+=t});try{eval(_header+src+_footer)}catch(e){app.logger.error("Failed to eval templates retrieved from local storage:\n"+e)}},_add:function(tpl,src,force){var key=tpl[0],loaded=this.get(key,false);if(loaded&&!force){return}if(loaded&&force&&_sources[key]!=src){_templates[key]=Handlebars.templates[key]=null}_sources[key]=src},_compile:function(tpl,src,force){Handlebars.templates=Handlebars.templates||{};_templates[tpl[0]]=Handlebars.templates[tpl[0]]=force||!tpl[1]?this.compile(tpl[0],src):tpl[1];return _templates[tpl[0]]},compile:function(key,src){try{_templates[key]="templates['"+key+"'] = template("+Handlebars.precompile(src)+");\n";eval(_header+_templates[key]+_footer)}catch(e){app.logger.error("Failed to compile or eval template "+key+".\n"+e)}return this.get(key,false)||this.empty},get:function(key,compile){compile=_.isUndefined(compile)||compile;if(compile&&!Handlebars.templates[key]&&_sources[key]){this._compile([key],_sources[key])}return Handlebars.templates?Handlebars.templates[key]:null},_getView:function(name,module,compile){var key=name+(module?"."+module:"");return[key,this.get(key,compile)]},getView:function(name,module){return this._getView(name,module,true)[1]},_getField:function(type,view,module,fallbackTemplate,skipFallbacks,compile){var foundTemplate,prefix="f."+type+".",key=prefix+(module?module+".":"")+view;module+=".";foundTemplate=this.get(prefix+module+view,compile)||this.get(prefix+view,compile);if(!foundTemplate&&!skipFallbacks){foundTemplate=this.get(prefix+module+fallbackTemplate,compile)||this.get(prefix+fallbackTemplate,compile);if(!foundTemplate){foundTemplate=this.get("f.base."+view,compile)||this.get("f.base."+fallbackTemplate,compile)}}return[key,foundTemplate]},getField:function(type,view,module,fallbackTemplate){return this._getField(type,view,module,fallbackTemplate,false,true)[1]},_getLayout:function(name,moduleName,compile){var key="l."+(moduleName?moduleName+".":"")+name;return[key,this.get(key,compile)]},getLayout:function(name,moduleName){return this._getLayout(name,moduleName,true)[1]},setView:function(name,module,src,force){return this._add(this._getView(name,module,false),src,force)},setField:function(type,view,module,src,force){return this._add(this._getField(type,view,module,null,true,false),src,force)},setLayout:function(name,moduleName,src,force){return this._add(this._getLayout(name,moduleName,false),src,force)},set:function(metadata,force){if(metadata.views){_.each(metadata.views,function(view,name){if(name!="_hash"){_.each(view.templates,function(src,key){key=name==key?key:name+"."+key;this.setView(key,null,src,force)},this)}},this)}if(metadata.fields){_.each(metadata.fields,function(field,type){if(type!="_hash"){_.each(field.templates,function(src,view){this.setField(type,view,null,src,force)},this)}},this)}if(metadata.layouts){_.each(metadata.layouts,function(layout,type){if(type!="_hash"){_.each(layout.templates,function(src,key){key=type==key?key:type+"."+key;this.setLayout(key,null,src,force)},this)}},this)}},empty:function(){return""}};app.augment("template",_templateManager)})(SUGAR.App);(function(app){app.Context=Backbone.Model.extend({initialize:function(attributes){Backbone.Model.prototype.initialize.call(this,attributes);this.id=this.cid;this.parent=null;this.children=[];this._fetchCalled=false},clear:function(options){var collection=this.get("collection");collection&&collection.abortFetchRequest();options=_.extend({clearAllListeners:true},options||{});_.each(this.children,function(child){child.clear(options)});this.children=[];this.parent=null;_.each(this.attributes,function(value){if(value&&value.off===Backbone.Events.off){if(options.clearAllListeners){value.off();if(_.isFunction(value.dispose)){value.dispose()}}else{value.off(null,null,this)}}},this);delete options.clearAllListeners;this.off();Backbone.Model.prototype.clear.call(this,options);this.resetLoadFlag()},resetLoadFlag:function(recursive){recursive=_.isUndefined(recursive)?true:recursive;this._fetchCalled=false;if(this.get("model")){this.get("model").dataFetched=false}if(this.get("collection")){this.get("collection").dataFetched=false}if(recursive){_.each(this.children,function(child){child.resetLoadFlag()})}},isCreate:function(){return this.get("create")===true},getChildContext:function(def){var context,force=def.forceNew||false;delete def.forceNew;var name=def.cid||def.name||def.link||def.module;if(name&&!force){context=_.find(this.children,function(child){return child.cid==name||child.get("link")==name||child.get("module")==name})}if(!context){context=app.context.getContext(def);this.children.push(context);context.parent=this}if(def.link){var parentModel=this.get("model");context.set({parentModel:parentModel,parentModule:parentModel?parentModel.module:null})}else if(!def.module){context.set({module:this.get("module")})}this.trigger("context:child:add",context);return context},prepare:function(force){if(!force&&(this.get("model")||this.get("collection")))return;var modelId=this.get("modelId"),create=this.get("create"),link=this.get("link");this.set(link?this._prepareRelated(link,modelId,create):this._prepare(modelId,create));return this},_prepare:function(modelId,create){var model,collection,module=this.get("module"),mixed=this.get("mixed"),models;if(modelId){model=app.data.createBean(module,{id:modelId});models=[model]}else if(create===true){model=app.data.createBean(module);models=[model]}else{model=app.data.createBean(module)}collection=mixed===true?app.data.createMixedBeanCollection(models):app.data.createBeanCollection(module,models);return{collection:collection,model:model}},_prepareRelated:function(link,modelId,create){var model,collection,parentModel=this.get("parentModel");parentModel=parentModel||app.data.createBean(this.get("parentModule"),{id:this.get("parentModelId")});if(modelId){model=app.data.createRelatedBean(parentModel,modelId,link);collection=app.data.createRelatedCollection(parentModel,link,[model])}else if(create===true){model=app.data.createRelatedBean(parentModel,null,link);collection=app.data.createRelatedCollection(parentModel,link,[model])}else{model=app.data.createRelatedBean(parentModel,null,link);collection=app.data.createRelatedCollection(parentModel,link)}if(!this.has("parentModule")){this.set({parentModule:parentModel.module},{silent:true})}if(!this.has("module")){this.set({module:model.module},{silent:true})}return{parentModel:parentModel,collection:collection,model:model}},loadData:function(options){if(this.isDataFetched()||this.get("create")===true)return;var objectToFetch,modelId=this.get("modelId"),module=this.get("module"),defaultOrdering=app.config.orderByDefaults&&module?app.config.orderByDefaults[module]:null;options=options||{};objectToFetch=modelId?this.get("model"):this.get("collection");if(defaultOrdering&&objectToFetch instanceof app.BeanCollection&&!objectToFetch.orderBy){objectToFetch.orderBy=defaultOrdering}if(objectToFetch&&(objectToFetch instanceof app.Bean||objectToFetch instanceof app.BeanCollection)){if(this.get("dataView")&&_.isString(this.get("dataView"))){objectToFetch.setOption("view",this.get("dataView"))}if(this.get("fields")){objectToFetch.setOption("fields",this.get("fields"))}if(this.get("limit")){objectToFetch.setOption("limit",this.get("limit"))}if(this.get("module_list")){objectToFetch.setOption("module_list",this.get("module_list"))}if(this.get("viewed")){objectToFetch.setOption("viewed",this.get("viewed"))}options.context=this;if(this.get("skipFetch")!==true){objectToFetch.fetch(options)}this._fetchCalled=true}else{app.logger.warn("Skipping fetch because model is not Bean, Bean Collection, or it is not defined, module: "+this.get("module"))}},reloadData:function(options){options=options||{};this.resetLoadFlag(options.recursive);this.loadData(options);this.trigger("reload",this,options)},isDataFetched:function(){var objectToFetch=this.get("modelId")?this.get("model"):this.get("collection");return this._fetchCalled||objectToFetch&&!!objectToFetch.dataFetched}});app.augment("context",{getContext:function(attributes){return new app.Context(attributes)}})})(SUGAR.App);(function(app){var Controller=Backbone.View.extend({initialize:function(){this.context=app.context.getContext();app.events.on("app:sync:complete",function(){app.api.setStateProperty("loadingAfterSync",true);_.each(app.additionalComponents,function(component){if(component&&_.isFunction(component._setLabels)){component._setLabels()}component.render()});app.router.start();app.api.clearStateProperty("loadingAfterSync")});app.events.on("app:login:success",function(){app.sync()})},loadView:function(params){var oldLayout=this.layout;if(!app.triggerBefore("app:view:change")||!app.triggerBefore("app:view:load")){return}this.context.clear({silent:true});this.context.set(params);this.context.prepare();this.layout=app.view.createLayout({name:params.layout,module:params.module,context:this.context});if(oldLayout){var oldLayoutEl=document.createDocumentFragment();oldLayoutEl.appendChild(oldLayout.el)}app.$contentEl.append(this.layout.$el);this.layout.initComponents();if(!params||params&&!params.skipFetch){this.layout.loadData()}this.layout.render();if(oldLayout){oldLayout.dispose()}app.trigger("app:view:change",params.layout,params)},loadAdditionalComponents:function(components){_.each(app.additionalComponents,function(component){if(component){component.remove();component.dispose()}});app.additionalComponents={};_.each(components,function(component,name){if(component.target){if(component.layout){var $el=this.$(component.target);if(!$el.get(0)){app.logger.error('Unable to place additional component "'+name+'": the target specified does not exist.');return}app.additionalComponents[name]=app.view.createLayout({context:this.context,name:component.layout,el:$el});app.additionalComponents[name].initComponents()}else{app.additionalComponents[name]=app.view.createView({name:component.view||name,context:this.context,el:$el})}app.additionalComponents[name].render()}else{app.logger.error('Unable to place additional component "'+name+'": no target specified.')}})}});app.augment("Controller",Controller,false);app.events.on("app:init",function(app){app.controller.setElement(app.$rootEl)},app.controller).on("app:start",function(app){app.controller.loadAdditionalComponents(app.config.additionalComponents)})})(SUGAR.App);(function(app){var _routes;app.augment("routing",{beforeRoute:function(route,args){if(!this.triggerBefore("route",{route:route,args:args}))return false;if(_.indexOf(app.config.unsecureRoutes,route)>=0)return true;if(!app.api.isAuthenticated()){app.router.login();return false}else if(!app.isSynced){Backbone.history.stop();app.sync();return false}return true},after:function(route,args){},setRoutes:function(customRoutes){_routes=customRoutes},start:function(){var opts={};if(_routes){opts.customRoutes=_routes}app.augment("router",new app.Router(opts),false);app.events.trigger("router:start",app.router);app.router.start()}});_.extend(app.routing,app.beforeEvent);app.Router=Backbone.Router.extend({initialize:function(opts){opts=opts||{};this._previousFragment="";this._currentFragment="";if(opts.customRoutes){this.customRoutes=opts.customRoutes;this._bindCustomRoutes()}},_bindCustomRoutes:function(){if(!this.customRoutes)return;this.customRoutes.reverse();_.each(this.customRoutes,function(route){this.route(route.route,route.name,route.callback)},this)},_routeHandler:function(handler){var args=Array.prototype.slice.call(arguments,1),route=handler.route;if(app.routing.beforeRoute(route,args)){this._previousFragment=this._currentFragment;this._currentFragment=this.getFragment();handler.apply(this,args);app.routing.after(route,args)}},_moduleExists:function(module){if(module&&_.isUndefined(app.metadata.getModule(module))){app.error.handleHttpError({status:404});return false}return true},route:function(route,name,callback){if(!callback)callback=this[name];callback.route=name;callback=_.wrap(callback,this._routeHandler);Backbone.Router.prototype.route.call(this,route,name,callback)},getFragment:function(){return Backbone.history.getFragment()},navigate:function(fragment,options){Backbone.Router.prototype.navigate.apply(this,arguments);if(!(options&&options.trigger)){this._previousFragment=this._currentFragment;this._currentFragment=this.getFragment()}return this},getPreviousFragment:function(){return this._previousFragment},goBack:function(){app.logger.debug("Navigating back...");window.history.back()},go:function(steps){window.history.go(steps)},start:function(){app.logger.info("Router Started");Backbone.history.stop();return Backbone.history.start()},refresh:function(){Backbone.history.loadUrl(Backbone.history.fragment)},buildRoute:function(moduleOrContext,id,action){var route;if(app.utils&&_.isFunction(app.utils.customBuildRoute)){route=app.utils.customBuildRoute.apply(this,arguments);if(!_.isEmpty(route)){return route}}if(moduleOrContext){route=_.isString(moduleOrContext)?moduleOrContext:moduleOrContext.get("module");if(id){route+="/"+id}if(action){route+="/"+action}}else{route=action}return route},index:function(){app.logger.debug("Route changed to index");if(app.config.defaultModule){this.navigate(app.config.defaultModule,{trigger:true})}else if(app.acl.hasAccess("read","Home")){this.navigate("Home",{trigger:true})}},list:function(module){if(!this._moduleExists(module)){return}app.logger.debug("Route changed to list of "+module);app.controller.loadView({module:module,layout:"records"})},layout:function(module,layout){if(!this._moduleExists(module)){return}app.logger.debug("Route changed to layout: "+layout+" for "+module);app.controller.loadView({module:module,layout:layout})},create:function(module){if(!this._moduleExists(module)){return}app.logger.debug("Route changed: create "+module);app.controller.loadView({module:module,create:true,layout:"edit"})},login:function(){app.logger.debug("Logging in");app.controller.loadView({module:"Login",layout:"login",create:true});app.events.trigger("app:login");if(app.config.externalLogin){app.api.ping(null,{success:function(){app.events.trigger("app:login:success");app.router.refresh()},error:function(){app.alert.show("needs_login_error",{level:"error",messages:app.lang.getAppString("LBL_PORTAL_INVALID_CREDS_TITLE"),title:app.lang.get("LBL_PORTAL_INVALID_CREDS_TITLE")})}})}},logout:function(clear){clear=clear==="1";app.logger.debug("Logging out: "+clear);app.logout({complete:function(){app.router.navigate("#");if(clear){window.location.reload()}else{if(app.config.externalLogin){app.controller.loadView({module:"Login",layout:"logout",skipFetch:true,create:true})}else{app.router.login()}}},success:function(data,request){app.events.trigger("app:logout:success",data)}},clear)},record:function(module,id,action,layout){if(!this._moduleExists(module)){return}var oldCollection=app.controller.context.get("collection"),oldListCollection=app.controller.context.get("listCollection"),opts={module:module,layout:layout||"record",action:action||"detail"};if(id!=="create"){_.extend(opts,{modelId:id})}else{_.extend(opts,{create:true});opts.layout="create"}if(oldCollection&&oldCollection.module===module&&oldCollection.get(id)){opts.listCollection=oldCollection}if(oldListCollection&&oldListCollection.module===module&&oldListCollection.get(id)){opts.listCollection=oldListCollection}app.controller.loadView(opts)},redirect:function(route,options){this.navigate(route,_.extend({trigger:true,replace:true},options))}})})(SUGAR.App);(function(app){app.augment("lang",{direction:"ltr",get:function(key,module,context){var str=this.getModString(key,module,context)||this.getAppString(key,context)||key;return str},getModString:function(key,module,context){var moduleString;if(_.isArray(module)){_.find(module,function(moduleName){moduleString=this._get("mod_strings",key,moduleName,context);return!_.isEmpty(moduleString)},this)}else{moduleString=this._get("mod_strings",key,module,context)}return moduleString},getAppString:function(key,context){return this._get("app_strings",key,null,context)},getAppListStrings:function(key){var list=app.metadata.getStrings("app_list_strings")[key]||{};if(_.isArray(list)){var obj={};_.each(list,function(tuple){if(_.isString(tuple)){obj[tuple]=tuple}else if(_.isArray(tuple)&&tuple.length===2){obj[tuple[0]]=tuple[1]}});list=obj}return list},getModuleName:function(module,options){options=options||{};var name=!options.plural&&this.getModString("LBL_MODULE_NAME_SINGULAR",module)||this.getModString("LBL_MODULE_NAME",module);if(!name&&!_.isUndefined(options.defaultValue)){name=this.get(options.defaultValue)}return name||module},getAppListKeys:function(key){var keys=[],list=app.metadata.getStrings("app_list_strings")[key]||{};if(_.isArray(list)){_.each(list,function(tuple){if(tuple.length===2){keys.push(tuple[0])}})}else if(_.isObject(list)){keys=_.keys[list]}return keys},_get:function(type,key,module,context){var str,bundle=app.metadata.getStrings(type);bundle=module?bundle[module]:bundle;if(!bundle||!_.isString(bundle[key])){return}str=this._sanitize(bundle[key]);if(!_.isUndefined(context)&&str.indexOf("{{")>-1){key="lang."+(module?key+"."+module:key);var tpl=Handlebars.templates[key];str=tpl?tpl(context):app.template.compile(key,str)(context)}return str},_sanitize:function(str){return str.slice(-1)===":"?str.slice(0,-1):str},getLanguage:function(){return this._currentLanguage},setLanguage:function(language,callback,options){var self=this;options=options||{};_.each(Handlebars.templates,function(value,key){if(key.indexOf("lang.")===0){delete Handlebars.templates[key]}});if(options.noSync===true){this.updateLanguage(language);return}app.sync({callback:function(err){var langHasChanged=false;if(!err){self.updateLanguage(language);langHasChanged=!app.api.isAuthenticated()&&!options.noUserUpdate;app.cache.set("langHasChanged",langHasChanged)}if(callback)callback(err)},getPublic:!app.api.isAuthenticated(),noUserUpdate:options.noUserUpdate||false,language:language,forceRefresh:true,metadataTypes:["labels"]})},updateLanguage:function(language){app.cache.set("lang",language);app.user.setPreference("language",language);app.trigger("app:locale:change");this.setCurrentLanguage(language)},setDefaultLanguage:function(language){this._defaultLanguage=language},getDefaultLanguage:function(){return this._defaultLanguage},setCurrentLanguage:function(language){this._currentLanguage=language;this.setDirection(language)},setDirection:function(lang){var rtlLanguages=["he_IL","ar_SA"],isRTL=_.contains(rtlLanguages,lang),prevDirection=this.direction;this.direction=isRTL?"rtl":"ltr";if(this.direction!==prevDirection){app.trigger("lang:direction:change")}}})})(SUGAR.App);(function(app){var _keyPrefix="meta:";var _metadata={};var _mdLoaded={};var _syncing=false;function _setHash(data,isPublic){var pKey=isPublic?"public:":"";app.cache.set(_keyPrefix+pKey+"hash",data._hash)}function _cacheMeta(data){app.cache.set(_keyPrefix+"data",data)}function _getCachedMeta(){return app.cache.get(_keyPrefix+"data")}function _injectLabels(serverMetadata,labels){_.each(labels,function(value,key){if(key!=="_hash"){serverMetadata[key]=labels[key]}});delete serverMetadata.labels}function _fetchLabels(metadata,options){var labels,currentLanguage,langStringsUrl,userLang=app.user.getLanguage();labels=metadata.ordered_labels||metadata.labels;app.lang.setDefaultLanguage(labels["default"]);if(options.language&&labels[options.language]){currentLanguage=options.language}else if(labels[userLang]){currentLanguage=userLang}else{currentLanguage=app.lang.getDefaultLanguage();if(app.user.id){app.user.updateLanguage(currentLanguage)}}app.lang.setCurrentLanguage(currentLanguage);langStringsUrl=app.utils.buildUrl(labels[currentLanguage]);app.api.call("read",langStringsUrl,null,{success:function(labelsData){try{labelsData=_.isString(labelsData)?JSON.parse(labelsData):labelsData}catch(ex){app.logger.fatal("Failed to parse labels data: "+ex);options.error({code:"sync_failed",label:"ERR_SYNC_FAILED"});return}options.success(labelsData)},error:function(err){err.code="sync_failed";err.label="ERR_SYNC_FAILED";options.error(err)}})}function _initCustomComponents(module,moduleName){var self=this,platforms=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each({layout:"layout",view:"view",fieldTemplate:"field",data:"data"},function(type,key){if(self._metaTypeIsSeparatedByPlatform(module,key,platforms)){_.each(platforms,function(platform){var components=module[key+"s"][platform];self._sortAndDeclareComponents(components,type,moduleName,platform)})}_.each(module[key+"s"],function(def,name){if(type==="view"&&def.templates){_.each(def.templates,function(tplSource,tplName){var force=name===tplName;tplName=force?tplName:name+"."+tplName;app.template.setView(tplName,moduleName,tplSource,true)})}if(type==="layout"&&def.templates){_.each(def.templates,function(tplSource,key){key=name===key?key:name+"."+key;app.template.setLayout(key,moduleName,tplSource,true)})}if(type==="field"&&def.templates){_.each(def.templates,function(template,view){app.template.setField(name,view,moduleName,template,true)})}})},this)}app.augment("metadata",{fieldTypeMap:{varchar:"text",datetime:"datetimecombo",multienum:"enum",text:"textarea",decimal:"float"},_patchMetadata:function(moduleName,module){if(!module||module._patched===true){return module}_.each(module.views,function(view){if(view.meta){_.each(view.meta.panels,function(panel){panel.fields=this._patchFields(moduleName,module,panel.fields)},this)}},this);module._patched=true;return module},_patchFields:function(moduleName,module,fields){var self=this;_.each(fields,function(field,fieldIndex){var name=_.isString(field)?field:field.name;var fieldDef=module.fields[name];if(field.fields){field.fields=self._patchFields(moduleName,module,field.fields);return}if(!_.isEmpty(fieldDef)){if(_.isString(field)){field={name:field}}if(_.isObject(field.displayParams)){_.extend(field,field.displayParams);delete field.displayParams}field.type=field.type||fieldDef.custom_type||fieldDef.type||"base";field.type=self.fieldTypeMap[field.type]||field.type;field.label=field.label||fieldDef.vname||field.name;fields[fieldIndex]=field}else{if(field===""){field={view:"detail"};fields[fieldIndex]=field}}},this);return fields},_sortControllers:function(type,components,module){var updated={},nameMap={},entries={},updateWeights=function(entry){var controller=entry.controller;if(entry.type==="base"){entries["Base"+app.utils.capitalize(type)].weight=-99999}if(_.isObject(controller)&&_.isString(controller.extendsFrom)&&entries[controller.extendsFrom]&&!updated[controller.extendsFrom]){entries[controller.extendsFrom].weight--;updated[controller.extendsFrom]=true;updateWeights(entries[controller.extendsFrom])}};_.each(components,function(entry,name){if(entry.controller){var controller=entry.controller,className=(module||"")+app.utils.capitalizeHyphenated(name)+app.utils.capitalize(type);nameMap[className]=name;if(_.isString(controller)){try{controller=eval("["+controller+"][0]")}catch(e){app.logger.error("Failed to eval view controller for "+className+": "+e+":\n"+entry.controller)}}entries[className]={type:name,controller:controller,weight:0}}});_.each(entries,function(entry,className){var controller=entry.controller,customExtendsFrom;if(_.isObject(controller)&&_.isString(controller.extendsFrom)){customExtendsFrom="Custom"+controller.extendsFrom;if(customExtendsFrom in entries&&className!=customExtendsFrom){controller.extendsFrom=customExtendsFrom}}});_.each(entries,function(entry){updated={};updateWeights(entry)});return _.sortBy(entries,"weight")},_sortAndDeclareComponents:function(components,type,moduleName,platform){var entries,self=this;if(!_.isUndefined(components)&&components){entries=self._sortControllers(type,components,moduleName);if(type==="data"){var model,collection;_.each(entries,function(entry){if(entry.type==="model"){model=entry.controller}else if(entry.type==="collection"){collection=entry.controller}});app.data.declareModelClass(moduleName,null,platform,model);app.data.declareCollectionClass(moduleName,platform,collection)}else{_.each(entries,function(entry){app.view.declareComponent(type,entry.type,moduleName,entry.controller,true,platform)})}}},_metaTypeIsSeparatedByPlatform:function(data,type,platforms){if(!_.isUndefined(data[type+"s"])){for(var i=0;i<platforms.length;i++){if(!_.isUndefined(data[type+"s"][platforms[i]])){if(_.isUndefined(data[type+"s"][platforms[i]].controller)){return true}}}}return false},_declareClasses:function(data){var self=this,platforms=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each(["field","view","layout","data"],function(type){var components;if(self._metaTypeIsSeparatedByPlatform(data,type,platforms)){_.each(platforms,function(platform){components=data[type+"s"][platform];self._sortAndDeclareComponents(components,type,null,platform)},this)}},this);_.each(data.modules,function(entry,module){_initCustomComponents.call(this,entry,module)},this)},getModules:function(){return _metadata.modules},getHiddenSubpanels:function(){return _metadata.hidden_subpanels},getModule:function(module,type){var metadata=this.getModules();if(metadata)metadata=metadata[module];if(metadata&&type)metadata=metadata[type];return metadata},getRelationship:function(name){return _metadata.relationships?_metadata.relationships[name]:null},getField:function(type){var metadata=_metadata.fields?_metadata.fields[type]||_metadata.base:null;return metadata?app.metadata.copy(metadata,{field:type}):metadata},getView:function(module,view){var metadata=module?this.getModule(module,"views"):_metadata.views;if(view){if(metadata&&metadata[view]&&!_.isUndefined(metadata[view].meta)){metadata=metadata[view].meta}else if(_metadata.views&&_metadata.views[view]&&!_.isUndefined(_metadata.views[view].meta)){metadata=_metadata.views[view].meta}else{metadata=null}}return metadata?app.metadata.copy(metadata,{module:module,view:view}):metadata},getLayout:function(module,layout){var metadata=this.getModule(module,"layouts");if(layout){if(metadata&&metadata[layout]){metadata=metadata[layout].meta}else if(_metadata.layouts&&_metadata.layouts[layout]){metadata=_metadata.layouts[layout].meta}else{metadata=null}}return metadata?app.metadata.copy(metadata,{module:module,layout:layout}):metadata},getModuleNames:function(options){var filters=["enabled","!enabled","visible","!visible","display_tab","!display_tab","show_subpanels","!show_subpanels","quick_create","!quick_create"];arguments=Array.prototype.slice.call(arguments);if(arguments.length>=1&&!_.isObject(arguments[0])){app.logger.warn("getModuleNames no longer accepts visible and access params.");var args=_.clone(arguments);options={};if(args[0]){options.filter="display_tab"}options.access=args[1]}options=options||{};var moduleList=[];var oldClient=_.isUndefined(_metadata.modules_info);if(oldClient){moduleList=_.clone(app.user.get("module_list"));if(options.access){moduleList=_.filter(moduleList,function(module){return app.acl.hasAccess(options.access,module)})}return moduleList||[]}var filter,displayTabFilter=false;if(options.filter){if(!_.isArray(options.filter)){options.filter=[options.filter]}filter=[];_.each(options.filter,function(f){if(f&&_.indexOf(filters,f)>-1){filter.push(f);displayTabFilter=f==="display_tab"}else if(f){app.logger.warn("Can't filter getModuleNames by "+f)}});if(_.isEmpty(filter)){filter=undefined}}moduleList=_.chain(_metadata.modules_info).keys().without("_hash").value();if(filter){_.each(filter,function(f){var opposite=f.charAt(0)==="!";if(opposite){var oppositeList=app.metadata.getModuleNames({filter:f.substring(1),access:options.access});moduleList=_.difference(moduleList,oppositeList)}else{moduleList=_.filter(moduleList,function(module){return _metadata.modules_info[module][f]})}})}if(!_.isEmpty(app.user.get("module_list"))){if(displayTabFilter){moduleList=_.intersection(app.user.get("module_list"),moduleList)}else if(!filter){moduleList=_.union(app.user.get("module_list"),moduleList)}}if(options.access){moduleList=_.filter(moduleList,function(module){return app.acl.hasAccess(options.access,module)})}return moduleList},getStrings:function(type){return _metadata[type]||{}},getFullModuleList:function(){return _metadata.full_module_list||{}},getConfig:function(){return _metadata.config||{}},getBaseCurrencyId:function(){return"-99"},getCurrency:function(currencyId){return this.getCurrencies()[currencyId]},getCurrencies:function(){return _metadata.currencies||{}},getLogoUrl:function(){return _metadata.logo_url},getServerInfo:function(){return _metadata.server_info||{}},getModuleTabMap:function(){return _metadata.module_tab_map||{}},getTabMappedModule:function(module){var map=this.getModuleTabMap();return map[module]||module},getFilterOperators:function(module){var filters=_metadata.filters&&_metadata.filters.operators&&_metadata.filters.operators.meta||{};var moduleData=module&&this.getModule(module,"filters");var moduleFilters=moduleData&&moduleData.operators&&moduleData.operators.meta;if(moduleFilters){return _.extend({},filters,moduleFilters)}return filters},get:function(){return _metadata},getEditableDropdownFilter:function(dropdown){var filters=_metadata.editable_dropdown_filters;if(filters&&filters[dropdown]){return app.metadata.copy(filters[dropdown])}return{}},copy:function(meta,options){return app.utils.deepCopy(meta)},set:function(data,isPublic,reset){_.each(data.modules,function(entry,module){this._patchMetadata(module,entry)},this);this._declareClasses(data);app.config=_.extend(app.config||{},data.config);app.template.set(data,data._hash&&data._hash!=this.getHash(isPublic));if(!_.isEmpty(data._hash))_setHash(data,isPublic);if(!reset){var overrideKeys=data._override_values||[];delete data._override_values;_.each(data,function(value,key){_metadata[key]=_.isObject(value)&&!_.contains(overrideKeys,key)?_.extend(_metadata[key]||{},value):value})}else{_metadata=data}if(app.config.cacheMeta&&!isPublic){_cacheMeta(_metadata)}if(app.config.env!="prod"){this._dev_data=_metadata}},getHash:function(isPublic){var key=isPublic?_keyPrefix+"public:hash":_keyPrefix+"hash";return app.cache.get(key)||_metadata._hash||""},sync:function(callback,options){_syncing=true;options=options||{};options.params=options.params||{};var self=this,metadataTypes=options.metadataTypes||(options.getPublic?app.config.publicMetadataTypes:app.config.metadataTypes)||[],errorCallback=function(error){app.logger.debug("Failed fetching metadata");if(!options.getPublic){app.error.handleHttpError(error)}callback.call(self,error)},cb=callback;callback=function(p){_syncing=false;if(_.isFunction(cb))cb(p)};app.api.getMetadata(self.getHash(options.getPublic),metadataTypes,[],{success:function(metadata){var compatible;options=options||{};if(!_.isEmpty(metadata)){app.logger.debug("Updating metadata");if(_mdLoaded[options.getPublic?"public:md":"md"]&&self.getHash(options.getPublic)==metadata._hash&&!options.forceRefresh){app.logger.debug("Skipping update as metadata hash matches");

return callback.call(self)}if(_.isEmpty(metadataTypes)||_.include(metadataTypes,"server_info")&&!options.getPublic){compatible=app.isServerCompatible(metadata.server_info);if(compatible!==true){return callback(compatible)}}_mdLoaded[options.getPublic?"public:md":"md"]=true;if(metadata.jssource){self._loadJSSource(metadata,options,callback,errorCallback,self)}else{if(metadata.labels||metadata.ordered_labels){_fetchLabels(metadata,{language:options.language,success:function(labelsData){_injectLabels(metadata,labelsData);self.set(metadata,options.getPublic);callback.call(self)},error:errorCallback})}else{callback.call(self)}}}else{callback.call(self,{code:"sync_failed",label:"ERR_SYNC_FAILED"})}},error:errorCallback},options)},isSyncing:function(){return _syncing},_loadJSSource:function(metadata,options,callback,errorCallback,self){var scriptEl,loadJS=this._checkJSSourceUpdated(metadata,!!options.getPublic);if(loadJS==="reload"){return app.utils.hardRefresh()}else if(loadJS){SUGAR.jssource=false;scriptEl=document.createElement("script");scriptEl.src=app.utils.buildUrl(metadata.jssource);document.head.appendChild(scriptEl)}async.parallel([function(cb){if(loadJS){app.utils.doWhen("SUGAR.jssource",function(){self._declareClasses(SUGAR.jssource);cb()})}else{cb()}},function(cb){_fetchLabels(metadata,{language:options.language,success:function(labelsData){_injectLabels(metadata,labelsData);self.set(metadata,options.getPublic);cb()},error:function(){errorCallback.apply(self,arguments);cb()}})}],function(err,results){if(callback){callback.call(self)}})},_checkJSSourceUpdated:function(metadata,isPublic){if(isPublic){if(this._publicJSSourceFile){if(this._publicJSSourceFile!=metadata.jssource){return"reload"}return false}else{this._publicJSSourceFile=metadata.jssource;return true}}if(metadata.jssource_public&&this._publicJSSourceFile&&metadata.jssource_public!=this._publicJSSourceFile){app.utils.hardRefresh();return"reload"}if(this._jsSourceFile){if(this._jsSourceFile!=metadata.jssource){return"reload"}return false}return true},init:function(){_.bindAll(this,"storageHandler");window.addEventListener("storage",this.storageHandler);if(app.config.cacheMeta){var data=_getCachedMeta();if(data)this.set(data,false)}app.events.on("cache:clean",function(cb){cb([_keyPrefix+"public:hash",_keyPrefix+"hash",_keyPrefix+"data"])})},storageHandler:function(){if(!_syncing&&(this.getHash()!=_metadata._hash&&_mdLoaded["md"]||app.api.getUserprefHash()&&app.user.get("_hash")&&app.api.getUserprefHash()!=app.user.get("_hash"))){_syncing=true;_mdLoaded["md"]=false;app.sync({getPublic:!app.api.isAuthenticated()})}},clearCache:function(){app.cache.cut(_keyPrefix+"public:hash");app.cache.cut(_keyPrefix+"hash");app.cache.cut(_keyPrefix+"data")},reset:function(){_metadata={};this.clearCache()}},false)})(SUGAR.App);(function(app){app.augment("acl",{_accessToAny:{},action2permission:{view:"read",readonly:"read",edit:"write",detail:"read",list:"read",disabled:"write"},init:function(app){if(app){app.events.on("app:sync:complete",this.clearCache,this)}},clearCache:function(){this._accessToAny={}},_hasAccess:function(action,acls){var access;if(acls.access==="no"){access="no"}else{access=acls[action]}return access!=="no"},_hasAccessToField:function(action,acls,field){var access;action=this.action2permission[action]||action;if(acls.fields[field]&&acls.fields[field][action]){access=acls.fields[field][action]}return access!=="no"},hasAccess:function(action,module,ownerId,field,recordAcls){var acls=app.user.getAcls()[module];var access=true;if(acls||recordAcls){acls=acls||{};if(recordAcls){acls=app.utils.deepCopy(acls);acls.fields=acls.fields||{};_.extend(acls.fields,recordAcls.fields);var fields=acls.fields;_.extend(acls,recordAcls);acls.fields=fields}access=this._hasAccess(action,acls);if(field&&acls.fields&&access){access=this._hasAccessToField(action,acls,field);var moduleMeta=app.metadata.getModule(module);var fieldMeta=moduleMeta&&moduleMeta.fields?moduleMeta.fields[field]:null;if(access&&fieldMeta&&fieldMeta.group){access=this._hasAccessToField(action,acls,fieldMeta.group)}}}return access},hasAccessToModel:function(action,model,field){var id,module,assignedUserId,acls,access=true;if(model){id=model.id;module=model.module;assignedUserId=model.original_assigned_user_id||model.get("assigned_user_id");acls=model.get("_acl")||{fields:{}}}if(action=="edit"&&!id){action="create"}if(access===true){access=this.hasAccess(action,module,assignedUserId,field,acls)}return access},hasAccessToAny:function(action){if(_.isUndefined(this._accessToAny[action])){this._accessToAny[action]=_.some(app.user.getAcls(),function(obj,module){return this.hasAccess(action,module)},this)}return this._accessToAny[action]}},true)})(SUGAR.App);(function(app){var User=Backbone.Model.extend({load:function(callback){app.api.me("read",null,null,{success:function(data){if(data&&data.current_user){if(data.current_user._hash){app.cache.set("userpref:hash",data.current_user._hash)}app.user.set(data.current_user);var language=app.user.getPreference("language");if(app.lang.getLanguage()!=language){app.lang.setLanguage(language,null,{noUserUpdate:true,noSync:app.isSynced})}}if(callback)callback()},error:function(err){app.error.handleHttpError(err);if(callback)callback(err)}})},loadLocale:function(callback){app.api.call("read",app.api.buildURL("locale"),null,{success:function(data){if(callback)callback(data)},error:function(err){app.error.handleHttpError(err);if(callback)callback(err)}})},getLanguage:function(){return app.user.getPreference("language")||app.cache.get("lang")},updateLanguage:function(language,callback){var done=function(err){if(!err)app.lang.updateLanguage(language);if(callback)callback(err)};this.update("update",{preferred_language:language},done)},updateProfile:function(attributes,callback){var done=function(err){if(callback)callback(err)};this.update("update",attributes,done)},updatePreferences:function(attributes,callback){var self=this;if(app.api.isAuthenticated()){app.api.call("update",app.api.buildURL("me/preferences"),attributes,{success:function(data){if(data._hash){app.cache.set("userpref:hash",data._hash);app.user.set({_hash:data._hash})}_.each(attributes,function(val,key){if(data[key]){self.setPreference(key,data[key])}});if(callback)callback()},error:function(err){app.error.handleHttpError(err);if(callback)callback(err)}})}else{if(callback)callback()}},update:function(method,payload,callback){if(app.api.isAuthenticated()){app.api.me(method,payload,null,{success:function(data){if(data.current_user){if(data.current_user._hash){app.cache.set("userpref:hash",data.current_user._hash)}app.user.set(data.current_user)}if(callback)callback()},error:function(err){app.error.handleHttpError(err);if(callback)callback(err)}})}else{callback()}},getAcls:function(){return app.user.get("acl")||{}},getPreference:function(name){var preferences=app.user.get("preferences")||{};return preferences[name]},setPreference:function(name,value){var preferences=app.user.get("preferences")||{};preferences[name]=value;return app.user.set("preferences",preferences)},getCurrency:function(){var preferences=app.user.get("preferences"),currencyObj={};if(preferences){currencyObj.currency_id=preferences.currency_id;currencyObj.currency_iso=preferences.currency_iso;currencyObj.currency_name=preferences.currency_name;currencyObj.currency_rate=preferences.currency_rate;currencyObj.currency_show_preferred=preferences.currency_show_preferred;currencyObj.currency_symbol=preferences.currency_symbol}return currencyObj},lastState:function(){var keySeparator=":",keyPrefix="last-state",lastStates={},preservedKeys=[];var buildLastStateKeyForStorage=function(key){var keyParts=key.split(keySeparator),storedKey=[app.user.id,keyPrefix];storedKey=storedKey.concat(keyParts);return storedKey.join(keySeparator)};var getLastStateId=function(component){var lastStateId;if(component.meta&&component.meta.last_state){lastStateId=component.meta.last_state.id}return lastStateId};return{get:function(key){var result,storedKey;if(!_.isUndefined(key)){storedKey=buildLastStateKeyForStorage(key);result=app.cache.get(storedKey)||this.defaults(key)}return result},set:function(key,value){if(!_.isUndefined(key)&&!_.isUndefined(value)){var storedKey=buildLastStateKeyForStorage(key);app.cache.set(storedKey,value)}},preserve:function(key){if(!_.isUndefined(key)){preservedKeys.push(key)}},key:function(name,component){var lastStateId=getLastStateId(component);return this.buildKey(name,lastStateId,component.module)},buildKey:function(name,lastStateId,module){var keyString,keyParts=[];if(lastStateId){if(module){keyParts.push(module)}keyParts.push(lastStateId,name);keyString=keyParts.join(keySeparator)}return keyString},defaults:function(key){return lastStates[key]},register:function(component){var lastStateId=getLastStateId(component);if(lastStateId){_.each(component.meta.last_state.defaults,function(defaultState,key){lastStates[this.key(key,component)]=defaultState},this)}},remove:function(key){var storedKey;if(!_.isUndefined(key)){storedKey=buildLastStateKeyForStorage(key);app.cache.cut(storedKey)}},_getPreservedKeys:function(){var ret=[];_.each(preservedKeys,function(key){ret.push(buildLastStateKeyForStorage(key))});return ret}}}()});app.events.on("app:logout",function(clear){if(clear===true){app.user.clear({silent:true})}});app.events.on("cache:clean",function(cb){cb(app.user.lastState._getPreservedKeys())});app.augment("user",new User,false)})(SUGAR.App);(function(app){var _pluginManager={plugins:{view:{},field:{},layout:{},model:{},collection:{}},_get:function(name,type){if(this.plugins[type]&&this.plugins[type][name]){return this.plugins[type][name]}},attach:function(component,type){_.each(component.plugins,function(pluginName,o){var prop=null;if(_.isObject(pluginName)){var n=_.keys(pluginName)[0];prop=pluginName[n];pluginName=n}var p=this._get(pluginName,type);if(p&&!this._isPluginDisabled(component,pluginName)){var events=_.extend({},_.isFunction(component.events)?component.events():component.events,p.events);_.extend(component,p);if(prop){_.extend(component,prop);if(prop.events){_.extend(events,prop.events)}}component.events=events;if(_.isFunction(p.onAttach)){p.onAttach.call(component,component,p)}}},this)},detach:function(component,type){_.each(component.plugins,function(name){var plugin=this._get(name,type);if(plugin&&_.isFunction(plugin.onDetach)){plugin.onDetach.call(component,component,plugin)}},this)},_isPluginDisabled:function(component,pluginName){return!!_.find(component.disabledPlugins,function(name){return name===pluginName})},register:function(name,validTypes,plugin){if(!_.isArray(validTypes)){validTypes=[validTypes]}_.each(validTypes,function(type){this.plugins[type]=this.plugins[type]||{};this.plugins[type][name]=plugin},this)}};app.augment("plugins",_pluginManager,false)})(SUGAR.App);(function(app){app.augment("logger",{levels:{TRACE:{value:1,name:"TRACE"},DEBUG:{value:2,name:"DEBUG"},INFO:{value:3,name:"INFO"},WARN:{value:4,name:"WARN"},ERROR:{value:5,name:"ERROR"},FATAL:{value:6,name:"FATAL"}},ConsoleWriter:{write:function(level,message){if(!window.console)window.console={};if(!window.console.log)window.console.log=function(){};if(level.value<=app.logger.levels.INFO.value){console.log(message)}else if(level.value==app.logger.levels.WARN.value){console.warn(message)}else{console.error(message)}}},ServerWriter:{write:function(level,message){if(level.value<app.logger.levels.WARN.value){return}if(!app.api.isAuthenticated()){return}var write=app.config.logger&&app.config.logger.writeToServer||false;if(!write||!message.trim().length){return}var url=app.api.buildURL(undefined,"logger");var params={level:level.name.toLowerCase(),message:message};app.api.call("create",url,params,{success:function(data){if(!data.status){throw"Failed to write log message {"+message+"} onto server"}},error:function(e){throw e}})}},SimpleFormatter:{format:function(level,message,date){var dateString=date.getUTCFullYear()+"-"+(date.getUTCMonth()+1)+"-"+date.getUTCDate()+" "+date.getUTCHours()+":"+date.getUTCMinutes()+":"+date.getUTCSeconds();return level.name+"["+dateString+"]: "+message}},trace:function(message){this.log(this.levels.TRACE,message)},debug:function(message){this.log(this.levels.DEBUG,message)},info:function(message){this.log(this.levels.INFO,message)},warn:function(message){this.log(this.levels.WARN,message)},error:function(message){this.log(this.levels.ERROR,message)},fatal:function(message){this.log(this.levels.FATAL,message)},getLevel:function(){var level=app.config.logLevel;if(level){return this.levels[app.config.logLevel]}level=app.config.logger&&app.config.logger.level;level=level&&this.levels[level.toUpperCase()]||this.levels.ERROR;return level},log:function(level,message){try{var currentLevel=this.getLevel();if(level.value<currentLevel.value){return}message=message||"<none>";if(_.isFunction(message))message=message.call(this);if(_.isObject(message)){try{message=JSON.stringify(message)}catch(e){message=message.toString()}}var logger=app.config.logger,formatter=this[app.config.logFormatter];if(!formatter){formatter=logger&&this[logger.formatter]||this.SimpleFormatter}message=formatter.format(level,message,new Date);var consoleWriter=this[app.config.logWriter];if(!consoleWriter){consoleWriter=logger&&this[logger.consoleWriter]||this.ConsoleWriter}var serverWriter=logger&&this[logger.serverWriter]||this.ServerWriter;consoleWriter.write(level,message);serverWriter.write(level,message)}catch(e){console.log("Failed to log message {"+message+"} due to exception: "+e)}}},false)})(SUGAR.App);(function(app){Backbone.Model.prototype.doValidate=function(fields,callback){callback(this.isValid())};app.augment("Bean",Backbone.Model.extend({constructor:function(attributes,options){app.plugins.attach(this,"model");Backbone.Model.prototype.constructor.call(this,attributes,options)},initialize:function(attributes){Backbone.Model.prototype.initialize.call(this,attributes);this.setSyncedAttributes(attributes);this._bindEvents();this._relatedCollections=null;this._activeFetchRequest=null;if(this.isNew()&&this._defaults){_.each(this._defaults,function(value,key){if(!this.has(key)){this.set(key,value,{silent:true})}},this)}if(this.fields){this.fields=app.metadata.copy(this.fields,{bean:this})}this.addValidationTask("sidecar",_.bind(this._doValidate,this))},fetch:function(options){options=_.extend({},this.getOption(),options);this.abortFetchRequest();this._activeFetchRequest=Backbone.Model.prototype.fetch.call(this,options);return this._activeFetchRequest},getFetchRequest:function(){return this._activeFetchRequest},abortFetchRequest:function(){var req=this.getFetchRequest();if(req){app.api.abortRequest(req.uid)}},_bindEvents:function(){this.on("sync",function(){this.setSyncedAttributes(this.attributes);this._checkAcl()},this)},_checkAcl:function(){var _acl=this.get("_acl");var acls=_acl&&_acl.fields||{};this._prevAcls=this._prevAcls||{};var aclDiff=_.changed(acls,this._prevAcls);this._prevAcls=acls;if(!aclDiff){return}var aclChange=false;_.each(aclDiff,function(changed,field){if(changed){aclChange=true;this.trigger("acl:change:"+field)}else{delete aclDiff[field]}},this);if(aclChange){this.trigger("acl:change",aclDiff)}},dispose:function(){app.plugins.detach(this,"model")},_setRelatedCollection:function(link,collection){if(!this._relatedCollections)this._relatedCollections={};this._relatedCollections[link]=collection},getRelatedCollection:function(link){if(this._relatedCollections&&this._relatedCollections[link]){return this._relatedCollections[link]}return app.data.createRelatedCollection(this,link)},isValidAsync:function(fields,callback){fields=fields||this.fields;async.waterfall(_.flatten([function(waterfallCallback){waterfallCallback(null,fields,{})},_.sortBy(this._validationTasks)]),function(didWaterfallFail,fields,errors){if(!didWaterfallFail){var isValid=_.isEmpty(errors);if(_.isFunction(callback)){callback(isValid,errors)}}})},doValidate:function(fields,callback){var self=this;this.trigger("validation:start");this.isValidAsync(fields,function(isValid,errors){if(isValid){self.trigger("validation:success")}self.trigger("validation:complete",self._processValidationErrors(errors));if(_.isFunction(callback)){callback(isValid)}})},_doValidate:function(fields,errors,callback){var value;_.each(fields,function(field,fieldName){if(_.isString(field)){fieldName=field;field=this.fields[fieldName]}value=this.get(fieldName);if(field){_addValidationError(errors,app.validation.requiredValidator(field,field.name,this,value),fieldName,"required");if(value||value===0){_.each(app.validation.validators,function(validator,validatorName){_addValidationError(errors,validator(field,value,this),fieldName,validatorName)},this)}}},this);callback(null,fields,errors)},addValidationTask:function(taskName,validate){this._validationTasks=this._validationTasks||{};this._validationTasks[taskName]=validate},removeValidationTask:function(taskName){if(this._validationTasks){this._validationTasks=_.omit(this._validationTasks,taskName)}},_processValidationErrors:function(errors){var isValid=true;if(!_.isEmpty(errors)){app.error.handleValidationError(this,errors);_.each(errors,function(fieldErrors,fieldName){this.trigger("error:validation:"+fieldName,fieldErrors)},this);this.trigger("error:validation",errors);isValid=false}return isValid},save:function(attributes,options){var isValid=true,self=this;if(options&&options.fieldsToValidate){this.doValidate(options.fieldsToValidate,function(isValid){if(isValid)Backbone.Model.prototype.save.call(self,attributes,options)});return}return Backbone.Model.prototype.save.call(this,attributes,options)},canHaveAttachments:function(){return _.has(this.fields,"attachment_list")},getFiles:function(callbacks,options){options=options||{};options.passOAuthToken=false;return app.api.file("read",{module:this.module,id:this.id},null,callbacks,options)},copy:function(source,fields,options){var attrs={};var vardefs=app.metadata.getModule(this.module).fields;fields=fields||_.pluck(vardefs,"name");_.each(fields,function(name){var def=vardefs[name],permitCopy;if(!def||def.duplicate_on_record_copy==="no"){return}permitCopy=def.duplicate_on_record_copy==="always"||name!=="id"&&def.type!=="link"&&!def.auto_increment;if(permitCopy&&source.has(name)){var value=source.get(name);if(_.isObject(value)){value=app.utils.deepCopy(value)}attrs[name]=value}});this.set(attrs,options);this.isCopied=true},isCopy:function(){return this.isCopied===true},uploadFile:function(fieldName,$files,callbacks,options){callbacks=callbacks||{};options=options||{};return app.api.file("create",{id:options.temp!==true?this.id:"temp",module:this.module,field:fieldName},$files,callbacks,options)},favorite:function(flag,options){options=options||{};options.favorite=true;return this.save({my_favorite:!!flag},options)},follow:function(flag,options){options=options||{};flag=flag||false;options.following=true;return this.save({following:flag},options)},isFavorite:function(){var flag=this.get("my_favorite");return flag==="1"||flag===true},toJSON:function(options){var fields=options&&options.fields?options.fields:_.keys(this.attributes),json={};_.each(fields,function(fieldName){var attributeValue=this.get(fieldName);if(_.isObject(attributeValue)&&_.isFunction(attributeValue.toJSON)){attributeValue=attributeValue.toJSON(options)}json[fieldName]=attributeValue},this);return json},toString:function(){return"bean:"+this.module+"/"+(this.id?this.id:"<no-id>")},revertAttributes:function(options){options=options||{};options.revert=true;var changedAttr=this.changedAttributes(this.getSynced());this.set(app.utils.deepCopy(changedAttr)||{},options);if(!options.silent){this.trigger("attributes:revert")}},setSyncedAttributes:function(attributes){this._syncedAttributes=attributes?app.utils.deepCopy(attributes):{}},getSyncedAttributes:function(){app.logger.warn("Data.Bean.getSyncedAttributes is deprecated. "+"Please update your code to use Data.Bean.getSynced");return this._syncedAttributes},getSynced:function(key){return key?this._syncedAttributes[key]:this._syncedAttributes},setDefaultAttributes:function(attributes){app.logger.warn("Data.Bean.setDefaultAttributes is deprecated. "+"Please update your code to use Data.Bean.setDefault");this._defaults={};this.setDefault(attributes)},setDefaultAttribute:function(key,value){app.logger.warn("Data.Bean.setDefaultAttribute is deprecated. "+"Please update your code to use Data.Bean.setDefault");this.setDefault(key,value)},removeDefaultAttribute:function(key){app.logger.warn("Data.Bean.removeDefaultAttribute is deprecated. "+"We consider it as a bad practice so the method will be "+"removed in 7.8. Please update your code to stop using it.");if(this._defaults){if(!this.hasOwnProperty("_defaults")){this._defaults=_.clone(this._defaults)}delete this._defaults[key]}},getDefaultAttribute:function(key){app.logger.warn("Data.Bean.getDefaultAttribute is deprecated. "+"Please update your code to use Data.Bean.getDefault");return this.getDefault(key)},getDefaultAttributes:function(){app.logger.warn("Data.Bean.getDefaultAttributes is deprecated. "+"Please update your code to use Data.Bean.getDefault");return this.getDefault()},getDefault:function(key){var defaults=_.clone(this._defaults)||{};if(_.isUndefined(key)){return defaults}return defaults[key]},setDefault:function(key,val){var attrs;if(_.isObject(key)){attrs=key}else{(attrs={})[key]=val}this._defaults=_.extend({},this._defaults,attrs);this.attributes=_.defaults(this.attributes,attrs);return this},setOption:function(key,val){var attrs;if(_.isObject(key)){attrs=key}else{(attrs={})[key]=val}this._persistentOptions=_.extend({},this._persistentOptions,attrs);return this},unsetOption:function(key){if(key){this.setOption(key,void 0)}else{this._persistentOptions={}}return this},getOption:function(key){if(key){return this._persistentOptions[key]}return this._persistentOptions}}),false);function _addValidationError(errors,result,fieldName,validatorName){if(_.isUndefined(result))return;if(_.isUndefined(errors[fieldName])){errors[fieldName]={}}errors[fieldName][validatorName]=result}})(SUGAR.App);(function(app){app.augment("BeanCollection",Backbone.Collection.extend({constructor:function(models,options){app.plugins.attach(this,"collection");if(options&&options.link){this.link=options.link;delete options.link}Backbone.Collection.prototype.constructor.call(this,models,options)},initialize:function(models,options){if(!_.isEmpty(options)){options=app.utils.deepCopy(options);this.setOption(options);app.logger.warn("You should not pass persistent fetch options in initialize "+"(The options hash is supposed to be Backbone.js options hash, allowing you "+"to pass Backbone options used when setting the models into the collection)."+" Please use setOption() instead.")}this._initOptions=options;this._activeFetchRequest=null;this.on("data:sync:complete",function(){this._activeFetchRequest=null},this);this.on("remove",this._decrementTotal,this);Backbone.Collection.prototype.initialize.call(this,models,options);this.total=null},_decrementTotal:function(){if(this.total){this.total--}},dispose:function(){app.plugins.detach(this,"collection")},_prepareModel:function(model,options){var searchInfo=model._search;delete model._search;model=Backbone.Collection.prototype._prepareModel.call(this,model,options);if(model&&!model.link)model.link=this.link;if(searchInfo){model.searchInfo=searchInfo}return model},fetch:function(options){options=_.extend({},this.getOption(),options);this.abortFetchRequest();options.fields=this.fields=options.fields||this.fields||null;options.myItems=_.isUndefined(options.myItems)?this.myItems:options.myItems;options.favorites=_.isUndefined(options.favorites)?this.favorites:options.favorites;options.query=_.isUndefined(options.query)?this.query:options.query;this._activeFetchRequest=Backbone.Collection.prototype.fetch.call(this,options);return this._activeFetchRequest},getFetchRequest:function(){return this._activeFetchRequest},abortFetchRequest:function(){var req=this.getFetchRequest();if(req){app.api.abortRequest(req.uid)}},resetPagination:function(){var paginationDefaults={offset:0,next_offset:0,page:1};var optKeys=_.keys(paginationDefaults);this.resetOptions(optKeys);var options=this.getOption();_.each(optKeys,function(optKey){this[optKey]=options[optKey]||paginationDefaults[optKey]},this)},resetOptions:function(optionsList){if(_.isEmpty(this._initOptions)&&_.isEmpty(this.getOption())){this.unsetOption()}else{_.each(optionsList,function(option){if(!_.isUndefined(this._initOptions[option])){this.setOption(option,this._initOptions[option])}else if(!_.isEmpty(this.options)&&_.has(this.options,option)){this.unsetOption(option)}},this)}},paginate:function(options){options=options||{};var maxSize=options.limit||app.config.maxQueryResult;options.page=options.page||1;options.page--;if(maxSize){options.offset=this.offset+options.page*maxSize}if(options.add){options=_.extend({update:true,remove:false},options)}this.fetch(options)},fetchTotal:function(options){options=options||{};if(!_.isNull(this.total)&&_.isFunction(options.success)){options.success.call(this,this.total);return}options.success=_.wrap(options.success,_.bind(function(orig,data){this.total=parseInt(data.record_count,10);if(orig&&_.isFunction(orig)){orig(this.total)}},this));var module=this.module;var data=null;options.filter=options.filterDef||this.filterDef;if(this.link){data={id:this.link.bean.id,link:this.link.name};module=this.link.bean.module}var callbacks=_.pick(options,"success","complete","error");options=_.omit(options,"success","complete","error");return app.api.count(module,data,callbacks,options)},hasAtLeast:function(amount,options){options=options||{};var method="read";options.fields=["id"];delete options.view;options.silent=true;options.success=_.wrap(options.success,_.bind(function(orig,data){var length=data.records.length;var hasAtLeastAmount=length>=amount;var properties={length:length,hasMore:data.next_offset!==-1};if(_.isFunction(orig)){orig(hasAtLeastAmount,properties)}this.reset(null,{silent:true})},this));var module=this.module;var data=null;var endpoint="records";options.filter=options.filterDef||this.filterDef;options.limit=options.limit||amount;if(this.link){data={id:this.link.bean.id,link:this.link.name};module=this.link.bean.module;endpoint="relationships"}var callbacks=_.pick(options,"success","complete","error");options=_.omit(options,"success","complete","error");options=app.data.parseOptionsForSync(method,this,options);return app.api[endpoint](method,module,data,options.params,callbacks,options.apiOptions)},getPageNumber:function(options){var pageNumber=1;var maxSize=app.config.maxQueryResult;if(options){maxSize=options.limit||maxSize}if(this.offset&&maxSize){pageNumber=Math.ceil(this.offset/maxSize)}return pageNumber},toString:function(){return"coll:"+(this.link?this.link.bean.module+"/"+this.link.bean.id+"/":"")+this.module+"-"+this.length},getNext:function(current,callback){var ind=-1,result=null,self=this;if(this.hasNextModel(current)){ind=this.getModelIndex(current);if(ind+1>=this.length){this.paginate({add:true,success:function(collection,response,options){callback.apply(self,[self.at(ind+1),"next"])}})}else{callback.apply(self,[self.at(ind+1),"next"])}}},getPrev:function(current,callback){var ind=-1,result=null,self=this;if(this.hasPreviousModel(current)){ind=this.getModelIndex(current);result=this.at(ind-1)}callback.apply(self,[result,"prev"])},hasNextModel:function(current){var index=this.getModelIndex(current),offset=!_.isUndefined(this.next_offset)?parseInt(this.next_offset,10):-1;return index>=0&&(this.length>index+1||offset!==-1)},hasPreviousModel:function(current){return this.getModelIndex(current)>0},getModelIndex:function(model){return this.indexOf(this.get(model.id))},setOption:function(key,val){var attrs;if(_.isObject(key)){attrs=key}else{(attrs={})[key]=val}this._persistentOptions=_.extend({},this._persistentOptions,attrs);return this},unsetOption:function(key){if(key){this.setOption(key,void 0)}else{this._persistentOptions={}}return this},getOption:function(key){if(key){return this._persistentOptions[key]}return this._persistentOptions},clone:function(){var newCol=Backbone.Collection.prototype.clone.call(this);newCol.link=_.clone(this.link);newCol.setOption(_.clone(this.getOption()));return newCol}}),false)})(SUGAR.App);(function(app){app.augment("MixedBeanCollection",app.BeanCollection.extend({_prepareModel:function(model,options){var module=model instanceof app.Bean?model.module:model._module;this.model=app.data.getBeanClass(module);return app.BeanCollection.prototype._prepareModel.call(this,model,options)},fetch:function(options){options=options||{};options.module_list=this.module_list=options.module_list||this.module_list||app.metadata.getModuleNames({filter:"visible"});return app.BeanCollection.prototype.fetch.call(this,options)},groupByModule:function(){return _.groupBy(this.models,function(model){return model.module})},toString:function(){return"mcoll:"+this.length}}),false)})(SUGAR.App);(function(app){var _models={};var _collections={};var _dataManager=_.extend({beanModel:app.Bean,beanCollection:app.BeanCollection,mixedBeanCollection:app.MixedBeanCollection,init:function(){var sync=_.bind(this.sync,this);app.Bean.prototype.sync=sync;app.BeanCollection.prototype.sync=sync;app.events.register("data:sync:start",this);app.events.register("data:sync:complete",this);app.events.register("data:sync:success",this);app.events.register("data:sync:error",this);app.events.register("data:sync:abort",this)},reset:function(module){this.resetModel(module);this.resetCollection(module)},resetModel:function(module){if(module){delete _models[module]}else{_models={}}},resetCollection:function(module){if(module){delete _collections[module]}else{_collections={}}},declareModel:function(moduleName,module,platform,modelController,collectionController){platform=platform||app.config.platform||"base";var model=this.declareModelClass(moduleName,module,platform,modelController);this.declareCollectionClass(moduleName,platform,collectionController)},declareModelClass:function(moduleName,module,platform,modelController){var platformNamespace=app.utils.capitalize(platform);moduleName=moduleName||platformNamespace+"Model";this.resetModel(moduleName);var fields=module?module.fields:{};var defaults=null;_.each(_.values(fields),function(field){if(!_.isUndefined(field["default"])){if(defaults===null){defaults={}}defaults[field.name]=field["default"]}});var baseProperties={_defaults:defaults,module:moduleName,fields:fields};var superModel=_models[platformNamespace+"Model"]||_models["BaseModel"]||this.beanModel;modelController=_.extend(modelController||{},baseProperties);return app.utils.extendClass(_models,superModel,moduleName,modelController,platformNamespace)},declareCollectionClass:function(moduleName,platform,collectionController){var platformNamespace=app.utils.capitalize(platform);var modelName=moduleName||platformNamespace+"Model";var model=_models[modelName];moduleName=moduleName||platformNamespace+"Collection";if(!model){return}this.resetCollection(moduleName);var baseCollectionProperties={model:model,module:moduleName,offset:0};var superCollection=_collections[platformNamespace+"Collection"]||_collections["BaseCollection"]||this.beanCollection;collectionController=_.extend(collectionController||{},baseCollectionProperties);return app.utils.extendClass(_collections,superCollection,moduleName,collectionController,platformNamespace)},mergeModel:function(name,module){var fields=module?module.fields:{};var defaults=null;_.each(_.values(fields),function(field){if(!_.isUndefined(field["default"])){if(defaults===null){defaults={}}defaults[field.name]=field["default"]}});var baseProperties={_defaults:defaults,module:name,fields:fields};_.extend(_models[name].prototype,baseProperties)},getModelClasses:function(){return _models},getCollectionClasses:function(){
return _collections},declareModels:function(modules){modules=modules||app.metadata.getModules();_.each(modules,function(module,name){if(!_models[name]){this.declareModel(name,module)}else{this.mergeModel(name,module)}},this)},getBeanClass:function(module){return _models[module]||Backbone.Model},createBean:function(module,attrs,options){return _models[module]?new _models[module](attrs,options):new app.data.beanModel(attrs,options)},createBeanCollection:function(module,models,options){return _collections[module]?new _collections[module](models,options):new app.data.beanCollection(models,options)},createRelatedBean:function(bean1,beanOrId2,link,attrs){var relatedModule=this.getRelatedModule(bean1.module,link);attrs=attrs||{};if(_.isString(beanOrId2)){attrs.id=beanOrId2;beanOrId2=this.createBean(relatedModule,attrs)}else if(_.isNull(beanOrId2)){beanOrId2=this.createBean(relatedModule,attrs)}else{beanOrId2.set(attrs)}beanOrId2.link={name:link,bean:bean1,isNew:true};return beanOrId2},createRelatedCollection:function(bean,link,models){var relatedModule=this.getRelatedModule(bean.module,link);var collection=this.createBeanCollection(relatedModule,models,{link:{name:link,bean:bean}});collection.setOption("relate",true);bean._setRelatedCollection(link,collection);return collection},createMixedBeanCollection:function(models){return new app.data.mixedBeanCollection(models)},canHaveMany:function(module,link){var meta=app.metadata.getModule(module);if(!meta||!meta.fields||!meta.fields[link]){return false}if(meta.fields[link].link_type){return meta.fields[link].link_type==="many"}var name=meta.fields[link].relationship;var relationship=app.metadata.getRelationship(name);var t=relationship.relationship_type.split("-");var type;if(meta.fields[link].side){type=meta.fields[link].side==="left"?t[0]:t[2]}else if(relationship.lhs_module!==relationship.rhs_module){type=module===relationship.rhs_module?t[0]:t[2]}else{type=t[0]==="many"||t[2]==="many"?"many":"one"}return type==="many"},getRelateFields:function(parentModule,link){var relationship=app.metadata.getModule(parentModule).fields[link].relationship;var relatedModule=this.getRelatedModule(parentModule,link);var fields=app.metadata.getModule(relatedModule).fields;var f=_.find(fields,function(field){return field.type=="link"&&field.relationship==relationship});if(f){f=_.filter(fields,function(field){return field.type=="relate"&&field.link==f.name})}return f||[]},getRelationshipFields:function(parentModule,link){var ff=null;var linkField=app.metadata.getModule(parentModule).fields[link];if(linkField.rel_fields){var relationship=linkField.relationship;var relatedModule=this.getRelatedModule(parentModule,link);var fields=app.metadata.getModule(relatedModule).fields;var f=_.find(fields,function(field){return field.type=="link"&&field.relationship==relationship});if(f){f=_.find(fields,function(field){return field.link==f.name&&field.link_type=="relationship_info"})}if(f&&f.relationship_fields){var fieldNames=_.keys(linkField.rel_fields);_.each(f.relationship_fields,function(field,name){if(_.include(fieldNames,name)){if(!ff)ff=[];ff.push(field)}})}}return ff},getRelatedModule:function(module,link){var meta=app.metadata.getModule(module);if(!meta||!meta.fields||!meta.fields[link]){return false}var name=meta.fields[link]&&meta.fields[link].relationship;var relationship=app.metadata.getRelationship(name);if(!relationship){return meta.fields[link].module||false}return meta.fields[link].module||(module===relationship.rhs_module?relationship.lhs_module:relationship.rhs_module)},getEditableFields:function(model,fields,options){var editableFields=["id"],ignoreTypeList=["parent","relate"];fields=fields||[];if(fields.length==0){fields=_.keys(model.attributes)}_.each(fields,function(fieldName){var fieldValue;if(model.has(fieldName)&&(model.fields[fieldName]&&(!model.fields[fieldName].source||model.fields[fieldName].source!=="non-db"||!model.fields[fieldName].type||ignoreTypeList.indexOf(model.fields[fieldName].type)===-1))&&app.acl.hasAccessToModel("edit",model,fieldName)){fieldValue=model.get(fieldName);if(fieldValue&&model.fields[fieldName].type==="collection"){_.each(fieldValue.links,function(link){editableFields.push(link.link.name)})}else{editableFields.push(fieldName)}}});return model.toJSON({fields:editableFields})},sync:function(method,model,options){app.logger.trace("data-sync-"+(options.relate?"relate-":"")+method+": "+model);options=this.parseOptionsForSync(method,model,options);var callbacks=this.getSyncCallbacks(method,model,options),request=null;model.dataFetched=false;this.trigger("data:sync:start",method,model,options);model.trigger("data:sync:start",method,options);if(_.isFunction(options.endpoint)){options.endpoint(method,model,options,callbacks)}else if(model.link&&model.link.bean&&options.relate===true){var relatedData=null;if(method=="create"||method=="update"){relatedData=this.getEditableFields(model,options.fields);if(method=="update"&&model.link.isNew){method="create"}}request=app.api.relationships(method,model.link.bean.module,{id:model.link.bean.id,link:model.link.name,relatedId:model.id,related:relatedData},options.params,callbacks,options.apiOptions)}else if(options.favorite){request=app.api.favorite(model.module,model.id,model.isFavorite(),callbacks,options.apiOptions)}else if(options.following){request=app.api.follow(model.module,model.id,model.get("following"),callbacks,options.apiOptions)}else{if(options.query||model instanceof app.MixedBeanCollection){request=app.api.search(options.params,callbacks,options.apiOptions)}else if(model.module){request=app.api.records(method,model.module,method=="update"||method=="create"?this.getEditableFields(model,options.fields):model.attributes,options.params,callbacks,options.apiOptions)}else{app.logger.error("Unable to sync model with no module")}}return request},parseOptionsForSync:function(method,model,options){options=options||{};options.params=_.extend({},options.params);options.filterDef=options.filter||model.filterDef;options.method=method;if(options.view&&_.isString(options.view)&&method=="read"){options.params.view=options.view}if(options.fields&&method=="read"){options.params.fields=options.fields.join(",")}if(options.viewed===true){options.params.viewed="1"}if(method=="read"&&model instanceof app.BeanCollection){if(options.offset&&options.offset!==0){options.params.offset=options.offset}if(options.limit||app.config&&app.config.maxQueryResult){options.params.max_num=options.limit||app.config.maxQueryResult}if(model.orderBy&&model.orderBy.field){options.params.order_by=model.orderBy.field+":"+model.orderBy.direction}if(options.myItems===true){options.params.my_items="1"}if(options.favorites===true){options.params.favorites="1"}if(!_.isEmpty(options.filterDef)){var filterDef=app.utils.deepCopy(options.filterDef);if(_.has(filterDef,"filter")){filterDef=filterDef.filter}if(!_.isArray(filterDef)){filterDef=[filterDef]}options.params.filter=filterDef}if(!_.isEmpty(options.query)){options.params.q=options.query;if(_.isEmpty(options.module_list)&&model.module){options.module_list=[model.module]}}if(options.module_list){options.params.module_list=options.module_list.join(",")}}if(method==="update"&&options.lastModified){options.apiOptions=options.apiOptions||{};options.apiOptions.headers=options.apiOptions.headers||{};options.apiOptions.headers["X-TIMESTAMP"]=options.lastModified}return options},getSyncCallbacks:function(method,model,options){return{success:this.getSyncSuccessCallback(method,model,options),error:this.getSyncErrorCallback(method,model,options),complete:this.getSyncCompleteCallback(method,model,options),abort:this.getSyncAbortCallback(method,model,options)}},getSyncSuccessCallback:function(method,model,options){var self=this;return function(data,request){model.inSync=true;model.original_assigned_user_id=model.get("assigned_user_id");if(method=="read"&&model instanceof app.BeanCollection){data=data||{};if(data.next_offset){model.offset=data.next_offset!=-1?data.next_offset:model.offset+(data.records||[]).length;model.next_offset=data.next_offset;model.page=model.getPageNumber(options)}model.total=_.isNumber(data.total)?data.total:null;if(model instanceof app.MixedBeanCollection){model.xmod_aggs=data.xmod_aggs||null;model.tags=data.tags||null}data=data.records||[];self._updateCollectionProperties(model,options)}if(options.relate===true){model.link.isNew=false;if(method!="read"){if(model.link.bean){var syncedAttributes=model.link.bean.getSynced(),updatedAttributes=_.reduce(data.record,function(memo,val,key){if(!_.isEqual(syncedAttributes[key],val)){memo[key]=val}return memo},{});model.link.bean.set(updatedAttributes);model.link.bean.setSyncedAttributes(data.record)}data=data.related_record;if(method=="delete"){model.set(data);delete model.link}}}model.dataFetched=true;if(options.success)options.success(model,data,options);model.trigger("sync",model,data,options,request);self.trigger("data:sync:success",method,model,options,request);model.inSync=null}},getSyncErrorCallback:function(method,model,options){return _.bind(function(error){if(error.request.aborted){var abortCallback=this.getSyncAbortCallback(method,model,options);return abortCallback(error.request)}app.error.handleHttpError(error,model,options);this.trigger("data:sync:error",method,model,options,error);model.trigger("data:sync:error",method,options,error);if(_.isFunction(options.error)){options.error(error)}},this)},getSyncCompleteCallback:function(method,model,options){return _.bind(function(request){this.trigger("data:sync:complete",method,model,options,request);model.trigger("data:sync:complete",method,options,request);if(_.isFunction(options.complete)){options.complete(request)}},this)},getSyncAbortCallback:function(method,model,options){return _.bind(function(request){this.trigger("data:sync:abort",method,model,options,request);model.trigger("data:sync:abort",method,options,request)},this)},_updateCollectionProperties:function(model,options){options=options||{};model.myItems=options.myItems;model.favorites=options.favorites;model.query=options.query;model.modelList=options.modelList;model.filterDef=options.filterDef}},Backbone.Events);app.augment("data",_dataManager,false)})(SUGAR.App);(function(app){app.augment("validation",{validators:function(){var _minMaxValue=function(field,value,type){var limit=_.isUndefined(field[type])?field.validation?field.validation[type]:null:field[type];if(_.contains(["int","float","decimal","currency"],field.type)&&_.isFinite(limit)){if(field.type=="int"){value=parseInt(value)}else{value=parseFloat(value)}if(type=="max"){if(value>limit)return limit}else if(type=="min"){if(value<limit)return limit}else if(type=="greaterthan"){if(value<=limit)return limit}else if(type=="lessthan"){if(value>=limit)return limit}}};var _isBeforeAfter=function(field,value,type,model){if(_.indexOf(["date","datetimecombo"],field.type)!==-1&&field.validation&&field.validation.type===type){var compareTo=model.fields[field.validation.compareto];if(!_.isUndefined(compareTo)&&_.indexOf(["date","datetimecombo"],compareTo.type)!=-1){var compareToValue=Date.parse(model.get(compareTo.name));value=Date.parse(value.toString());if(!_.isNaN(compareToValue)&&!_.isNaN(value)){var compareToLabel=app.lang.get(compareTo.label||compareTo.vname||compareTo.name,model.module);if(type=="isbefore"){return compareToValue<value?compareToLabel:undefined}if(type=="isafter"){return compareToValue>value?compareToLabel:undefined}}}}};return{maxLength:function(field,value){if(_.isNumber(value)){value=value.toString()}if(_.isNumber(field.len)&&_.isString(value)){var maxLength=field.len;value=value||"";value=value.toString();if(value.length>maxLength){return maxLength}}},minLength:function(field,value){if(_.isNumber(field.minlen)){var minLength=field.minlen;value=value||"";value=value.toString();if(value.length<minLength){return minLength}}},url:function(field,value){},email:function(field,emails){var results;if(field.type=="email"||field.type==="email-text"){if(emails.length>0){_.each(emails,function(email){if(email.email_address===""&&(_.isUndefined(field.required)||field.required==false)){return}if(!app.utils.isValidEmailAddress(email.email_address)){if(!results)results=[];results.push(email.email_address)}})}if(results&&results.length>0){return results}}},primaryEmail:function(field,emails){if(field.type=="email"){if(emails.length>0&&!_.find(emails,function(email){return email.primary_address=="1"})){return true}}},duplicateEmail:function(field,emails){if(field.type=="email"){var values=_.pluck(emails,"email_address"),duplicates=[],n=values.length,i,j;for(i=0;i<n;i++){for(j=i+1;j<n;j++){if(values[i]==values[j])duplicates.push(values[i])}}if(duplicates&&duplicates.length>0){return duplicates}}},datetime:function(field,value){var val,invalidNumberOfDigits,format,sep,formatParts,parts,i,len;function inRange(val,min,max){var value=parseInt(val,10);return!isNaN(value)&&value>=min&&value<=max}if(field.type==="date"||field.type==="datetimecombo"){if(_.isNaN(Date.parse(value))&&_.isNaN(Date.parse(value.replace(/[\.\-]/g,"/")))){return value}else{if(!app.date.isIso(value)){parts=value.replace(/[\.\-]/g,"/").split("/");invalidNumberOfDigits=_.filter(parts,function(part,index){return part.length===3||part.length>4});if(invalidNumberOfDigits.length){return value}if(/([\.\/\-])\1/.test(value)===true){return value}format=app.user.getPreference("datepref");sep=format.match(/[.\/\-\s].*?/);formatParts=format.split(sep);for(i=0,len=formatParts.length;i<len;i++){val=parts[i];switch(formatParts[i].toLowerCase().charAt(0)){case"m":if(!inRange(val,1,12)){return value}break;case"d":if(!inRange(val,1,31)){return value}break}}}else{if(value.charAt(0)==="0")return value}}}},minValue:function(field,value){return _minMaxValue(field,value,"min")},maxValue:function(field,value){return _minMaxValue(field,value,"max")},greaterThan:function(field,value){return _minMaxValue(field,value,"greaterthan")},lessThan:function(field,value){return _minMaxValue(field,value,"lessthan")},number:function(field,value){if(_.indexOf(["int","float","currency"],field.type)!=-1){return _.isBoolean(value)||_.isString(value)&&value.trim().length==0||isNaN(parseFloat(value))||!_.isFinite(value)?true:undefined}},isBefore:function(field,value,model){return _isBeforeAfter(field,value,"isbefore",model)},isAfter:function(field,value,model){return _isBeforeAfter(field,value,"isafter",model)}}}(),requiredValidator:function(field,fieldName,model,value){if(field.required===true&&fieldName!=="id"&&field.type!=="image"&&_.isUndefined(field.auto_increment)){var currentValue=model.get(fieldName);var currentUndefined=_.isUndefined(currentValue);var valueEmpty=_.isNull(value)||value===""||value===false||_.isArray(value)&&this._isArrayEmpty(value)||value instanceof Backbone.Collection&&value.length==0;if(currentUndefined&&_.isUndefined(value)||valueEmpty){return true}}},_isArrayEmpty:function(value){return _.every(value,_.isEmpty)}},false)})(SUGAR.App);(function(app){Handlebars.registerHelper("field",function(view,options){var field=app.view.createField({def:this,view:view,model:options.hash.model,viewName:options.hash.template});if(options.hash.parent&&_.isArray(options.hash.parent.fields)){options.hash.parent.fields.push(field)}return field.getPlaceholder()});Handlebars.registerHelper("fieldOfType",function(type,label){var def={type:type,name:type,label:label};var field=app.view.createField({def:def,view:this});return field.getPlaceholder()});Handlebars.registerHelper("eachOptions",function(key,hbsOptions){var options,ret="",iterator;options=_.isString(key)?app.lang.getAppListStrings(key):key;if(_.isArray(options)){iterator=function(element,index){ret=ret+hbsOptions.fn({key:index,value:element})}}else if(_.isObject(options)){iterator=function(value,key){ret=ret+hbsOptions.fn({key:key,value:value})}}else{options=null}if(options)_.each(options,iterator,this);return ret});Handlebars.registerHelper("buildRoute",function(options){var ctx=options.hash.context,model=options.hash.model||(ctx&&ctx.get("model")?ctx.get("model"):{}),module=options.hash.module||model.module||(ctx&&ctx.get("module")?ctx.get("module"):null),id=options.hash.id||model.id,action=options.hash.action;return app.router.buildRoute(module,id,action)});Handlebars.registerHelper("getFieldValue",function(bean,field,defaultValue){app.logger.warn("getFieldValue handlebars helper is deprecated and will be removed in 7.8. "+"Please use the fieldValue handlebars helper instead.");defaultValue=_.isObject(defaultValue)?"":defaultValue;return bean.get(field)||defaultValue||""});Handlebars.registerHelper("fieldValue",function(bean,field,options){return bean.get(field)||options.hash.defaultValue||""});Handlebars.registerHelper("has",function(val,array,options){if(!_.isArray(array)&&!_.isObject(array)){array=[array]}return _.include(array,val)?options.fn(this):options.inverse(this)});Handlebars.registerHelper("notHas",function(val,array,options){var fn=options.fn,inverse=options.inverse;options.fn=inverse;options.inverse=fn;return Handlebars.helpers["has"].call(this,val,array,options)});Handlebars.registerHelper("isSortable",function(module,fieldViewdef,options){if(app.utils.isSortable(module,fieldViewdef)){return options.fn(this)}else{return""}});Handlebars.registerHelper("eq",function(val1,val2,options){return val1==val2?options.fn(this):options.inverse(this)});Handlebars.registerHelper("notEq",function(val1,val2,options){return val1!=val2?options.fn(this):options.inverse(this)});Handlebars.registerHelper("match",function(val1,val2,options){var re=new RegExp(val2);if(re.test(val1)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("notMatch",function(val1,val2,options){var re=new RegExp(val2);if(!re.test(val1)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("log",function(value){app.logger.debug("*****HBS: Current Context*****");app.logger.debug(this);app.logger.debug("*****HBS: Current Value*****");app.logger.debug(value);console.log(value);app.logger.debug("***********************")});Handlebars.registerHelper("str",function(key,module,content){module=_.isString(module)?module:null;return app.lang.get(key,module,content)});Handlebars.registerHelper("relativeTime",function(iso8601,options){var date=app.date(iso8601),attrs,html;options.hash.title=options.hash.title||date.formatUser(options.hash.dateOnly);attrs=_.map(options.hash,function(attr,key){return key+'="'+Handlebars.Utils.escapeExpression(attr)+'"'}).join(" ");html='<time datetime="'+date.format()+'" '+attrs+">"+date.fromNow()+"</time>";return new Handlebars.SafeString(html)});Handlebars.registerHelper("arrayJoin",function(array,glue){return array.join(glue)});Handlebars.registerHelper("nl2br",function(s){s=Handlebars.Utils.escapeExpression(s);var nl2br=s.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+"<br>");return new Handlebars.SafeString(nl2br)});Handlebars.registerHelper("formatCurrency",function(number,currencyId){if(_.isObject(currencyId)){currencyId=currencyId.hash.currencyId||undefined}return app.currency.formatAmountLocale(number,currencyId)});Handlebars.registerHelper("firstChars",function(text,n){return text.substring(0,n)});Handlebars.registerHelper("formatDate",function(date,options){var date=app.date(date);return date.formatUser(options.hash.dateOnly)});Handlebars.registerHelper("getModuleName",function(module,options){var options={plural:options.hash.plural,defaultValue:options.hash.defaultValue};return app.lang.getModuleName(module,options)});Handlebars.registerHelper("partial",function(name,component,properties,options){var module,template,data;if(!options&&properties.hash){options=properties;properties={}}data=_.extend({templateComponent:component},properties,options.hash);module=options.hash.module||component.module;if(component&&component.options.templateOptions&&component.options.templateOptions.partials){template=component.options.templateOptions.partials[name]}else if(component instanceof app.view.Field){var fallbackTemplate=options.hash.fallbackTemplate;template=app.template.getField(component.type,name||"detail",module,fallbackTemplate)}else if(component instanceof app.view.View){var templateName=component.tplName;template=app.template.getView(component.name+"."+name,module)||app.template.getView(component.name+"."+name);if(!template&&templateName){template=app.template.getView(templateName+"."+name,module)||app.template.getView(templateName+"."+name)}}else if(component instanceof app.view.Layout){template=app.template.getLayout(component.name+"."+name,module)||app.template.getLayout(component.name+"."+name)}return new Handlebars.SafeString(template?template(data):"")})})(SUGAR.App);(function(app){var _sfId=0;var _classes=[];var _viewManager={reset:function(){_.each(this.layouts,function(layout,name){delete this.layouts[name]},this);_.each(this.views,function(view,name){delete this.views[name]},this);_.each(this.fields,function(field,name){delete this.fields[name]},this)},getFieldId:function(){return _sfId},views:{},layouts:{},fields:{},_createComponent:function(type,name,params){var Klass=this.declareComponent(type,params.type||name,params.module,params.controller,false,this._getPlatform(params));var component=new Klass(params);component.trigger("init");component.bindDataChange();return component},createView:function(params){params.context=params.context||app.controller.context;params.module=params.module||params.context.get("module");params.meta=params.meta||app.metadata.getView(params.module,params.name);params.type=params.type||(params.meta&&params.meta.type?params.meta.type:params.name||null);return this._createComponent("view",params.name,params)},createLayout:function(params){params.context=params.context||app.controller.context;params.module=params.module||params.context.get("module");params.meta=params.meta||app.metadata.getLayout(params.module,params.name);params.type=params.type||(params.meta?params.meta.type:null);return this._createComponent("layout",params.name||params.type,params)},createField:function(params){var type=params.def.type;params.context=params.context||params.view.context||app.controller.context;params.model=params.model||params.context.get("model");params.module=params.module||(params.model&&params.model.module?params.model.module:params.context.get("module"))||"";params.meta=params.meta||app.metadata.getField(type,params.module);if(params.meta&&params.meta.controller)params.controller=params.meta.controller;params.sfId=++_sfId;var field=this._createComponent("field",type,params);params.view.fields[field.sfId]=field;return field},_getPlatform:function(params){return params.platform||(app.config&&app.config.platform?app.config.platform:"base")},_getController:function(params){var c=this._getBaseComponent(params.type,params.name,params.module,params.platform);if(c.cache[c.moduleBasedClassName]){return c.cache[c.moduleBasedClassName]}return c.baseClass},invokeParent:function(context,params){var controller,ret;params=params||{};if(!context||!params.type||!params.name||!params.method||params.args&&!_.isArray(params.args)){app.logger.error("view-manager's invoke method requires a context, params.type, params.name, params.method; if params.args is supplied it must be of type array.")}controller=this._getController(params);if(!controller){return app.logger.error("invokeParent: Unable to load controller for "+params.type+":"+params.name)}context._superStack=context._superStack||{};context._superStack[params.method]=context._superStack[params.method]||[];context._superStack[params.method].push(controller.prototype);ret=controller.prototype[params.method].apply(context,params.args);context._superStack[params.method].pop();return ret},componentHasPlugin:function(params){var controller;if(!params.type||!params.name||!params.plugin){app.logger.error("componentHasPlugin requires type, name, and plugin parameters");return null}controller=this._getController(params);return controller&&controller.prototype&&_.contains(controller.prototype.plugins,params.plugin)},declareComponent:function(type,name,module,controller,overwrite,platform){var c=this._getBaseComponent(type,name,module,platform,overwrite&&controller);if(overwrite&&controller){if(c.cache[c.moduleBasedClassName])delete c.cache[c.moduleBasedClassName]}return c.cache[c.moduleBasedClassName]||app.utils.extendClass(c.cache,c.baseClass,c.moduleBasedClassName,controller,c.platformNamespace)||c.baseClass},_getBaseComponent:function(type,name,module,platform,ignoreCustom){platform=this._getPlatform({platform:platform});var ucType=app.utils.capitalize(type),platformNamespace=app.utils.capitalize(platform),className=app.utils.capitalizeHyphenated(name)+ucType,moduleBasedClassName=platformNamespace+(module||"")+className,customModuleBasedClassName=platformNamespace+(module||"")+"Custom"+className,cache=app.view[type+"s"],customBaseClassName=app.utils.capitalize(app.config.appId)+ucType,baseClass=cache[platformNamespace+"Custom"+className]||cache[platformNamespace+className]||cache["BaseCustom"+className]||cache["Base"+className]||cache[className]||cache["BaseBase"+ucType]||app.view["Custom"+customBaseClassName]||app.view[customBaseClassName]||app.view[ucType];if(cache[customModuleBasedClassName]&&!ignoreCustom){moduleBasedClassName=customModuleBasedClassName}return{cache:cache,platformNamespace:platformNamespace,moduleBasedClassName:moduleBasedClassName,baseClass:baseClass}}};app.augment("view",_viewManager,false)})(SUGAR.App);(function(app){app.view.Component=Backbone.View.extend({initialize:function(options){this.context=options.context||app.controller&&app.controller.context||new Backbone.Model;this.meta=options.meta;this.module=options.module||this.context.get("module");this.model=options.model||this.context.get("model");this.collection=options.collection||this.context.get("collection");if(this.meta&&this.meta.css_class){this.$el.addClass(this.meta.css_class)}this.updateVisibleState(true);app.user.lastState.register(this)},_render:function(){return this},render:function(){if(this.disposed===true){app.logger.error("Unable to render component because it's disposed "+this+"\n");return false}if(!this.triggerBefore("render"))return false;this._render();this.trigger("render");return this},setTemplateOption:function(key,option){this.options=this.options||{};this.options.templateOptions=this.options.templateOptions||{};this.options.templateOptions[key]=_.extend({},this.options.templateOptions[key],option)},bindDataChange:function(){},unbindData:function(){if(this.model)this.model.off(null,null,this);if(this.collection)this.collection.off(null,null,this)},unbind:function(){this.off();this.offBefore();this.undelegateEvents();app.events.off(null,null,this);app.events.unregister(this);if(this.context)this.context.off(null,null,this);if(this.layout)this.layout.off(null,null,this)},loadData:function(){},_dispose:function(){this.unbindData();this.unbind();this.remove();this.model=null;this.collection=null;this.context=null;this.$el=null;this.el=null},dispose:function(){if(this.disposed===true)return;this._dispose();this.disposed=true},toString:function(){return this.cid+"-"+(this.$el&&this.$el.id?this.$el.id:"<no-id>")+"/"+this.module+"/"+this.model+"/"+this.collection},closestComponent:function(name){},show:function(){if(!this.isVisible()){if(!this.triggerBefore("show")){return false}this._show();this.trigger("show")}},hide:function(){if(this.isVisible()){if(!this.triggerBefore("hide")){return false}this._hide();this.trigger("hide")}},isVisible:function(){return this._isVisible},updateVisibleState:function(visible){this._isVisible=!!visible},_show:function(){this.$el.removeClass("hide").show();this.updateVisibleState(true)},_hide:function(){this.$el.addClass("hide").hide();this.updateVisibleState(false)},_super:function(method,args){if(!method||!_.isString(method)){return app.logger.error("tried to call _super without specifying a parent method in "+this.name)}var parent,resetSuper=null,thisProto=Object.getPrototypeOf(this);args=args||[];this._superStack=this._superStack||{};this._superStack[method]=this._superStack[method]||[];if(this._superStack[method].length>0){parent=Object.getPrototypeOf(_.last(this._superStack[method]));if(_.contains(this._superStack[method],parent)){return app.logger.error("Loop detected calling "+method+" from "+this.name)}}else{parent=Object.getPrototypeOf(thisProto)}if(!thisProto[method]){return app.logger.error("Unable to find method "+method+" on class "+this.name)}while(!parent.hasOwnProperty(method)&&parent!==app.view.Component.prototype){parent=Object.getPrototypeOf(parent)}while(thisProto[method]===parent[method]&&parent!==app.view.Component.prototype){thisProto=parent;parent=Object.getPrototypeOf(parent)}this._superStack[method].push(parent);if(!parent){return app.logger.error("Unable to find parent of component "+this.name)}if(!parent[method]){return app.logger.error("Unable to find method "+method+" on parent class of "+this.name)}var ret=parent[method].apply(this,args);this._superStack[method].pop();if(_.isEmpty(this._superStack[method])){this._superStack[method]=null}return ret}});_.extend(app.view.Component.prototype,app.beforeEvent)})(SUGAR.App);(function(app){app.view.View=app.view.Component.extend({initialize:function(options){app.plugins.attach(this,"view");app.view.Component.prototype.initialize.call(this,options);this.name=options.name;this.action=options.meta&&options.meta.action?options.meta.action:this.name;this._loadTemplate(options);this.fields={};this.fallbackFieldTemplate=this.fallbackFieldTemplate||"detail";this.layout=this.options.layout;this.primary=options.primary;this._setLabels();app.events.on("app:locale:change",function(){this._setLabels()},this)},_loadTemplate:function(options){var template,templateName;if(template=options&&options.template){templateName=null}else if(template=this.meta&&this.meta.template&&app.template.getView(this.meta.template)){templateName=this.meta.template}else if(template=app.template.getView(this.name,this.module)||app.template.getView(this.name)){templateName=this.name}else if(template=this.meta&&this.meta.type&&app.template.getView(this.meta.type)){templateName=this.meta.type}else{template=app.template.empty;templateName=""}this.tplName=templateName;this.template=template},getTemplateFromMeta:function(options){app.logger.warn("`getTemplateFromMeta` is deprecated since 7.7 and "+"will be removed in 7.8.");if(options.meta&&options.meta.template){return app.template.getView(options.meta.template)}return null},_renderHtml:function(ctx,options){if(this.template){try{this.$el.html(this.template(ctx||this,options||this.options.templateOptions));this.delegateEvents()}catch(e){app.logger.error("Failed to render "+this+"\n"+e);app.error.handleRenderError(this,"_renderHtml")}}},_renderFields:function(){var self=this;var fieldElems={};this.$("span[sfuuid]").each(function(){var $this=$(this),sfId=$this.attr("sfuuid");fieldElems[sfId]=$this});_.each(this.fields,function(field){self._renderField(field,fieldElems[field.sfId])})},_renderField:function(field,$fieldEl){field.setElement($fieldEl||this.$("span[sfuuid='"+field.sfId+"']"));try{field.render()}catch(e){app.logger.error("Failed to render "+field+" on "+this+"\n"+e);app.error.handleRenderError(this,"_renderField",field)}},_render:function(){if(app.acl.hasAccessToModel(this.action,this.model)){this._disposeFields();this._renderHtml();this._renderFields()}else{app.logger.info("Current user does not have access to this module view. name: "+this.name+" module:"+this.module);if(this.primary){app.error.handleRenderError(this,"view_render_denied")}}return this},_setLabels:function(){this.modulePlural=app.lang.getAppListStrings("moduleList")[this.module]||this.module;this.moduleSingular=app.lang.getAppListStrings("moduleListSingular")[this.module]||this.modulePlural},loadData:function(options,setFields){if(app.acl.hasAccess("read",this.module)){
setFields=_.isUndefined(setFields)?true:setFields;if(setFields){this.context.set("fields",this.getFieldNames())}this.context.loadData(options)}},getFieldNames:function(module,onlyDataFields){var fields=[];module=module||this.context.get("module");if(this.meta&&this.meta.panels){fields=_.reduce(_.map(this.meta.panels,function(panel){var nestedFields=_.flatten(_.compact(_.pluck(panel.fields,"fields")));return _.pluck(panel.fields,"name").concat(_.pluck(nestedFields,"name")).concat(_.flatten(_.compact(_.pluck(panel.fields,"related_fields"))))}),function(memo,field){return memo.concat(field)},[])}fields=_.compact(_.uniq(fields));var fieldMetadata=app.metadata.getModule(module,"fields");if(fieldMetadata){fields=_.reject(fields,function(name){return _.isUndefined(fieldMetadata[name])});var relates=[];_.each(fields,function(name){if(fieldMetadata[name].type=="relate"){relates.push(fieldMetadata[name].id_name)}else if(fieldMetadata[name].type=="parent"){relates.push(fieldMetadata[name].id_name);relates.push(fieldMetadata[name].type_name)}if(_.isArray(fieldMetadata[name].fields)){relates=relates.concat(fieldMetadata[name].fields)}});fields=_.union(fields,relates)}return fields},getFields:function(module,model){var fields={};var fieldNames=this.getFieldNames(module);_.each(fieldNames,function(name){var field=this.getField(name,model);if(field){fields[name]=field.def}},this);return fields},getField:function(name,model){return _.find(this.fields,function(field){return field.name==name&&(!model||field.model==model)})},closestComponent:function(name){if(!this.layout){return}if(this.layout.name===name){return this.layout}return this.layout.closestComponent(name)},_show:function(){this._super("_show");_.each(this.fields,function(component){component.updateVisibleState(true)})},_hide:function(){this._super("_hide");_.each(this.fields,function(component){component.updateVisibleState(true)})},_dispose:function(){app.plugins.detach(this,"view");this._disposeFields();app.view.Component.prototype._dispose.call(this)},_disposeFields:function(){_.each(this.fields,function(field){field.dispose()});this.fields={}},toString:function(){return"view-"+this.name+"-"+app.view.Component.prototype.toString.call(this)},getFieldMeta:function(field){var ret=_.find(_.flatten(_.pluck(this.meta.panels,"fields")),function(def){return def.name==field});return ret},setFieldMeta:function(field,meta){_.each(this.meta.panels,function(panel){_.each(panel.fields,function(def,i){if(def.name==field){panel.fields[i]=_.extend(def,meta)}})})}})})(SUGAR.App);(function(app){app.view.Field=app.view.Component.extend({fieldTag:"input",initialize:function(options){app.plugins.attach(this,"field");app.view.Component.prototype.initialize.call(this,options);this.sfId=options.sfId;this.view=options.view;this.name=this.options.def.name;this.type=this.options.def.type;if(this.model&&this.model.fields){var clonedVarDef=_.clone(this.model.fields[this.name]);this.def=clonedVarDef?_.extend(clonedVarDef,options.def):options.def}else{this.def=this.options.def}this.label=app.lang.get(this.def.label||this.def.vname||this.name,this.module);this.template=app.template.empty;if(this.model){this.model.on("error:validation:"+this.name,this.handleValidationError,this);this.model.on("validation:start attributes:revert",this.removeValidationErrors,this);this.model.on("acl:change:"+this.name,this.handleAclChange,this)}},viewFallbackMap:{edit:"detail"},handleAclChange:function(){this.action=void 0;this.render()},_checkAccessToAction:function(action){return app.acl.hasAccessToModel(action,this.model,this.name)},_getFallbackTemplate:function(viewName){return this.isDisabled()&&viewName==="disabled"?"edit":this.view.fallbackFieldTemplate||"detail"},_loadTemplate:function(){var fallbackFieldTemplate;var viewName=this.options.viewName||this.options.def.view||(this.view.meta&&this.view.meta.type?this.view.meta.type:this.view.name);var actionName=this.action;if(this.isDisabled()&&viewName==="edit"){viewName=this.action}else{actionName=this.action||(this.view.action&&this.view.name!=this.view.action?this.view.action:viewName)}while(viewName){if(this._checkAccessToAction(actionName))break;viewName=this.viewFallbackMap[viewName];actionName=viewName}if(viewName){var moduleName=this.module||this.context.get("module");fallbackFieldTemplate=this._getFallbackTemplate(viewName);this.template=app.template.getField(this.type,viewName,moduleName,fallbackFieldTemplate)||app.template.getField("base",viewName,moduleName,fallbackFieldTemplate)||app.template.empty}else{this.template=app.template.empty}this.tplName=viewName;this.action=actionName},delegateEvents:function(events){events=events||this.events||(this.def?this.def.events:null);if(!events)return;events=_.clone(events);_.each(events,function(eventHandler,handlerName){var callback=this[eventHandler];if(!callback&&_.isString(eventHandler)){callback=_.bind(function(event){if(_.isFunction(this.triggerMetadataEvent)){this.triggerMetadataEvent(event,eventHandler)}},this);this["callback_"+handlerName]=callback;events[handlerName]="callback_"+handlerName}if(!_.isFunction(eventHandler)&&!callback){delete events[handlerName]}},this);Backbone.View.prototype.delegateEvents.call(this,events)},_render:function(){this._loadTemplate();if(this.model instanceof Backbone.Model){this.value=this.getFormattedValue()}this.dir=_.result(this,"direction");if(app.lang.direction===this.dir){delete this.dir}this.unbindDom();this.$el.html(this.template(this)||"");if(this.def&&this.def.css_class){this.getFieldElement().addClass(this.def.css_class)}this.$(this.fieldTag).attr("dir",this.dir);this.bindDomChange();return this},getFieldElement:function(){return this.$el},bindDomChange:function(){if(!(this.model instanceof Backbone.Model))return;var self=this;var el=this.$el.find(this.fieldTag);el.on("change",function(){self.model.set(self.name,self.unformat(el.val()))})},bindDataChange:function(){if(this.model){this.model.on("change:"+this.name,function(model,value){if(this.action==="edit"){this.$(this.fieldTag).val(this.format(value))}else{this.render()}},this)}},hasChanged:function(){return!_.isEqual(this.format(this.model.getSynced(this.name)),this.format(this.model.get(this.name)))},format:function(value){return value},unformat:function(value){return value},getFormattedValue:function(){return this.format(this.model.has(this.name)?this.model.get(this.name):null)},handleValidationError:function(errors){},removeValidationErrors:function(){},getPlaceholder:function(){return new Handlebars.SafeString('<span sfuuid="'+this.sfId+'"></span>')},setDisabled:function(disable){disable=_.isUndefined(disable)?true:disable;if(disable&&this.isDisabled()===false){this._previousAction=this.action;this.action="disabled";this.render()}else if(disable===false&&this.isDisabled()){this.action=this._previousAction;delete this._previousAction;this.render()}},isDisabled:function(){return this.action==="disabled"},setViewName:function(view){this.options.viewName=view},setMode:function(name){if(this.isDisabled()){this._previousAction=name}else{this.action=name}this.setViewName(name);this.render()},unbindDom:function(){this.$el.find(this.fieldTag).off()},_dispose:function(){app.plugins.detach(this,"field");this.unbindDom();app.view.Component.prototype._dispose.call(this)},toString:function(){return"field-"+this.name+"-"+this.sfId+"-"+app.view.Component.prototype.toString.call(this)},_show:function(){this.getFieldElement().removeClass("hide").show();this.updateVisibleState(true)},_hide:function(){this.getFieldElement().addClass("hide").hide();this.updateVisibleState(false)},equals:function(other){return this.type===other.type&&_.isEqual(this.getFormattedValue(),other.getFormattedValue())},closestComponent:function(name){if(!this.view){return}if(this.view.name===name){return this.view}return this.view.closestComponent(name)}})})(SUGAR.App);(function(app){app.view.Layout=app.view.Component.extend({initialize:function(options){app.plugins.attach(this,"layout");app.view.Component.prototype.initialize.call(this,options);this._components=[];this.meta=this.meta||{};this.type=this.meta.type||this.options.type;this.name=this.meta.name||this.options.name||this.type||"";if(this.meta.label){this.label=this.meta.label}else if(this.options.def&&this.options.def.label){this.label=this.options.def.label}else if(this.options.label){this.label=this.options.label}else{this.label=""}this.template=app.template.getLayout(this.name,this.module)||app.template.getLayout(this.type,this.module)||app.template.getLayout(this.name)||app.template.getLayout(this.type);if(this.template){this.$el.html(this.template(this,options))}this.layout=this.options.layout;app.events.on("app:locale:change",function(){this.render()},this)},initComponents:function(components,context,module){if(this.disposed){return}var newSubComponents,initialLength;components=components||this.meta.components;initialLength=this._components.length;this._addComponentsFromDef(components,context,module);newSubComponents=this._components.slice(initialLength);_.each(newSubComponents,function(comp){if(_.isFunction(comp.initComponents)){comp.initComponents()}});this.trigger("init")},createComponentFromDef:function(def,context,module){context=context||this.context;module=module||this.module;if(def.context){if(def.context instanceof app.Context){context=def.context}else{context=context.getChildContext(def.context);context.prepare()}module=context.get("module")}if(def.view){if(_.isString(def.view)){return app.view.createView({context:context,name:def.view,module:module,primary:def.primary,layout:this})}else if(_.isObject(def.view)){return app.view.createView({context:context,module:module,meta:def.view.meta||def.view,name:def.view.name||def.view.type||"",primary:def.view.primary,layout:this})}}else if(def.layout){if(_.isString(def.layout)){return app.view.createLayout({context:context,name:def.layout,def:def,module:module,layout:this})}else if(_.isObject(def.layout)){return app.view.createLayout({context:context,module:module,meta:def.layout.meta||def.layout,name:def.layout.name||def.layout.type||"",def:def,layout:this})}}else{app.logger.warn("Invalid layout definition:\n"+def.layout)}},_addComponentsFromDef:function(components,context,module){components=components||[];_.each(components,function(def){if(def.view||def.layout){this.addComponent(this.createComponentFromDef(def,context,module),def)}},this)},addComponent:function(component,def){if(!component.layout)component.layout=this;this._components.push(component);this._placeComponent(component,def)},_placeComponent:function(component){this.$el.append(component.el)},removeComponent:function(component){var i=_.isNumber(component)?component:this._components.indexOf(component);if(i>-1){var removed=this._components.splice(i,1);removed[0].layout=null}},getComponent:function(name){return _.find(this._components,function(component){return component.name===name})},_render:function(){if(this._components&&this._components.length>0){_.each(this._components,function(component){component.render()},this)}else{app.logger.info("Can't render anything because the layout has no components: "+this.toString()+"\n"+"Either supply metadata or override Layout.render method")}return this},loadData:function(options,setFields){if(this.disposed){return}setFields=_.isUndefined(setFields)?true:setFields;if(setFields){this.context.set("fields",this.getFieldNames())}this.context.loadData(options);_.each(this._components,function(component){component.loadData(options,component.context!=this.context)},this)},getFieldNames:function(module){var fields=[];module=module||this.module;_.each(this._components,function(component){if(component.module==module){fields=_.union(fields,component.getFieldNames(null,true))}},this);return fields},getFields:function(module){var fields={};_.each(this._components,function(component){_.extend(fields,component.getFields(module))});return fields},closestComponent:function(name){if(!this.layout){return}if(this.layout.name===name){return this.layout}return this.layout.closestComponent(name)},_show:function(){this._super("_show");_.each(this._components,function(component){component.updateVisibleState(true)})},_hide:function(){this._super("_hide");_.each(this._components,function(component){component.updateVisibleState(true)})},_dispose:function(){app.plugins.detach(this,"layout");_.each(this._components,function(component){component.dispose()});this._components=[];app.view.Component.prototype._dispose.call(this)},toString:function(){return"layout-"+(this.options.type||this.options.name)+"-"+app.view.Component.prototype.toString.call(this)}})})(SUGAR.App);(function(app){var _alerts={};var _alert={preventAnyAlert:false,init:function(){this.$alerts=$("#alerts");this.klass=app.view.AlertView;if(app.config){this.$alerts=$(app.config.alertsEl).length?$(app.config.alertsEl):this.$alerts;this.klass=app.view[app.utils.capitalize(app.config.appId)+"AlertView"]||app.view.views[app.utils.capitalize(app.config.platform)+"AlertView"]||app.view.views.BaseAlertView||app.view[app.utils.capitalize(app.config.platform)+"AlertView"]||this.klass}_.each(this.$alerts.find(".alert-wrapper"),function(el,i){var key="init-"+i;if(!_alerts[key]){_alerts[key]=this._create(key,{el:el})}},this)},show:function(key,options){if(!this.$alerts||this.$alerts.length==0)return null;if(this.preventAnyAlert)return null;options=_.extend({level:"info",autoClose:false},options||{});if(options.level==="confirmation"){this.dismissAll();this.preventAnyAlert=true}if(options.messages){options.messages=_.isString(options.messages)?[options.messages]:options.messages}var alert=_alerts[key];if(!alert){alert=this._create(key,options);_alerts[key]=alert}alert.level=options.level;if(!!options.autoClose)this._setAutoCloseTimer(alert,options.onAutoClose,options.autoCloseDelay);alert.render();return alert},_create:function(key,options){var alert=new this.klass(options);alert.key=key;alert.$el.prependTo(this.$alerts);return alert},_setAutoCloseTimer:function(alert,onAutoClose,autoCloseDelay){if(alert.timerId)clearTimeout(alert.timerId);alert.timerId=setTimeout(_.bind(function(){if(_.isFunction(onAutoClose)){onAutoClose(alert.key)}this.dismiss(alert.key)},this),autoCloseDelay||app.config.alertAutoCloseDelay||9e3)},dismiss:function(key,options){this.preventAnyAlert=false;var alert=_alerts[key];if(!alert)return;if(alert.timerId)clearTimeout(alert.timerId);alert.close(options);delete _alerts[key]},dismissAll:function(level,options){_.each(_alerts,function(alert,key){if(!level||alert.level==level){this.dismiss(key,options)}},this)},get:function(key){return _alerts[key]},getAll:function(){return _alerts}};app.view.AlertView=app.view.Component.extend({tpl:'<div class="alert alert-block">{{#if title}}<strong>{{title}}</strong>{{/if}}{{#each messages}}{{./this}}{{/each}}</div>',close:function(){this.remove()},render:function(){var tpl=Handlebars.compile(this.tpl);this.$el.html(tpl(this.options));this.$(".alert").addClass("alert-"+this.options.level)}});app.augment("alert",_alert,true)})(SUGAR.App);(function(app){var animationSpeed=500;var scrollOffset=25;var scrollViewReduction=75;app.augment("tutorial",{instance:null,hasTutorial:function(layout,module){if(_.isUndefined(module))module=app.controller.context.get("module");if(_.isUndefined(layout))layout=app.controller.context.get("layout");var meta=app.metadata.getModule(module);var defaultMeta=app.metadata.getView("","tutorial");if(defaultMeta){this.data=defaultMeta}if(meta&&meta.views&&meta.views.tutorial&&meta.views.tutorial.meta&&meta.views.tutorial.meta[layout]){return true}else if(this.data&&this.data[layout]){return true}else{return false}},show:function(name,params){if(app.config.skipTutorial){return}else if(app.tutorial.data){this.doTutorial(name,params)}else if(app.metadata.getView("","tutorial")){app.tutorial.data=app.metadata.getView("","tutorial");this.doTutorial(name,params)}else{var self=this;$.getJSON(app.config.tutorualURL||"tutorial.json",function(data){app.tutorial.data=data;self.doTutorial(name,params)})}},doTutorial:function(name,params){var tutorialData=app.tutorial.data[name];var prefKey=name;if(params&&params.module){var meta=app.metadata.getModule(params.module);if(meta.views&&meta.views.tutorial&&meta.views.tutorial.meta&&meta.views.tutorial.meta[name]){tutorialData=meta.views.tutorial.meta[name];prefKey=name+params.module}}var prefs=this.getPrefs();if(tutorialData&&(!prefs.skipVersion[prefKey]||prefs.skipVersion[prefKey]<tutorialData.version)&&(!prefs.viewedVersion[prefKey]||prefs.viewedVersion[prefKey]<tutorialData.version)){var params=_.extend(tutorialData,{type:"Tutorial"});app.tutorial.instance=app.view.createView(params);app.tutorial.instance.show();prefs.viewedVersion[prefKey]=tutorialData.version;app.cache.set("tutorialPrefs",prefs)}},getPrefs:function(){var prefs=app.cache.get("tutorialPrefs")||{};prefs.viewedVersion=prefs.viewedVersion||{};prefs.skipVersion=prefs.skipVersion||{};return prefs},resetPrefs:function(prefs){prefs=prefs||{};prefs.viewedVersion={};prefs.skipVersion={};app.cache.set("tutorialPrefs",prefs)},skipTutorial:function(){var prefs=this.getPrefs();_.each(app.tutorial.data,function(data,name){prefs.skipVersion[name]=app.tutorial.data[name].version});app.user.setPreference("tutorialPrefs",prefs)}});app.view.TutorialView=app.view.View.extend({events:{"click .btn.disabled":function(e){return false},"click .back-btn:not(.disabled)":"back","click .next-btn:not(.disabled)":"next","click .done-btn":"hide",swipeLeft:"onSwipeLeft"},_duringAnimate:false,initialize:function(options){options=_.extend({},options||{});this.index=0;this.setIntro(options.intro);this.setContent(options.content);this.setScroll(options.scroll);app.events.on("app:login app:logout",this.hide,this)},setContent:function(content){this.content=content},setIntro:function(intro){this.intro=intro},setScroll:function(scroll){this.scroll=scroll},reset:function(){this.index=0},onSwipeLeft:function(e){app.tutorial.skipTutorial();this.hide(e)},show:function(options){options=_.extend({},options||{});if(options.content)this.setContent(options.content);if(options.intro)this.setIntro(options.intro);if(options.scroll)this.setScroll(options.scroll);if(options.reset)this.reset();this.render();if(this.intro&&!this.introShown){this.index=-1;this.introShown=true;this.showMessageOnly(this.intro)}else{this.highlightItem(this.index)}},hide:function(event){if(event){event.preventDefault()}this.dispose()},back:function(event){if(event){event.preventDefault()}if(this._duringAnimate){return}this.highlightItem(this.index-1)},next:function(event){if(event){event.preventDefault()}if(this._duringAnimate){return}this.highlightItem(this.index+1)},highlightItem:function(index){var self=this;if(index<0){return}if(index>=this.content.length){this.hide();return}var content=this.content[index];if(!content.name){this.showMessageOnly(content.text)}else{var item=$(content.name);var direction=this.index>index?-1:1;if(item.length===0||item.css("display")==="none"||item.parents(".hide").length>0){return this.highlightItem(index+direction)}var highlightCallback=function(){if(!this.highlight){this.highlight=$("<div/>");this.highlight.attr("id","highlight");this.highlightText=$("<div/>");this.highlightText.attr("id","highlight-text");this.highlight.html(this.highlightText);$("#tutorial-content").html(this.highlight)}this.highlightText.hide();this.hideGlow();this._duringAnimate=true;this.highlight.animate({top:item.offset().top+(content.vertAdj||0),left:item.offset().left+(content.horizAdj||0),width:content.full?item.offset().width:"",height:content.full?item.offset().height:""},animationSpeed,"linear",function(){self._duringAnimate=false;if(content.glow===undefined||content.glow!==false)self.showGlow();self.showHighlightText(content.text)})};highlightCallback=_.bind(highlightCallback,this);this.scrollToEl(item,highlightCallback)}if(index<=0)this.$el.find(".back-btn").addClass("disabled");else this.$el.find(".back-btn").removeClass("disabled");if(index>=this.content.length-1)this.$el.find(".next-btn").addClass("disabled");else this.$el.find(".next-btn").removeClass("disabled");this.index=index},showGlow:function(){this.$el.find("#mask").css("background-image","-webkit-radial-gradient("+(this.highlight.offset().left+this.highlight.width()/2)+"px "+(this.highlight.offset().top+this.getTotalHeight(this.highlight)/2)+"px , "+this.highlight.width()+"px "+this.highlight.height()+"px, transparent, black "+Math.max(this.highlight.width(),this.highlight.height())+"px)");this.$el.find("#mask").css("background","radial-gradient(circle closest-side at "+(this.highlight.offset().left+this.highlight.width()/2)+"px "+(this.highlight.offset().top+this.getTotalHeight(this.highlight)/2)+"px , "+" transparent 0%, black "+Math.max(this.highlight.width(),this.highlight.height())+"px)");this.$el.find("#mask").css("background-color","transparent")},hideGlow:function(){this.$el.find("#mask").css("background-color","");this.$el.find("#mask").css("background-image","")},showHighlightText:function(message){var top;this.highlightText.html(app.lang.get(message,app.controller.context.get("module")));this.highlightText.show();if(this.highlight.offset().left-this.getTotalWidth(this.highlightText)>0&&this.findIntersectors([this.highlight.offset().left-this.getTotalWidth(this.highlightText),this.highlight.offset().left],[this.highlight.offset().top+this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2,this.highlight.offset().top+this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2+this.getTotalHeight(this.highlightText)],".btn-group").length===0){var highlightBorderOffset=parseInt(this.highlight.css("border-left-width"));this.highlightText.css("left",0-(this.getTotalWidth(this.highlightText)+highlightBorderOffset));top=this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2;this.highlightText.css("top",top>=0?top:0);this.highlightText.css("text-align","right")}else if(this.highlight.offset().left+this.getTotalWidth(this.highlight)+this.getTotalWidth(this.highlightText)<$(window).width()&&this.findIntersectors([this.highlight.offset().left+this.getTotalWidth(this.highlight),this.highlight.offset().left+this.getTotalWidth(this.highlight)+this.getTotalWidth(this.highlightText)],[this.highlight.offset().top+this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2,this.highlight.offset().top+this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2+this.getTotalHeight(this.highlightText)],".btn-group").length===0){var highlightBorderOffset=parseInt(this.highlight.css("border-right-width"));this.highlightText.css("left",this.getTotalWidth(this.highlight)+highlightBorderOffset);top=this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2;this.highlightText.css("top",top>=0?top:0);this.highlightText.css("text-align","left")}else{var newLeftVal=this.getTotalWidth(this.highlight)/2-this.getTotalWidth(this.highlightText)/2;var leftEdge=this.highlight.offset().left+newLeftVal;newLeftVal=leftEdge<0?0-this.highlight.offset().left:newLeftVal;var rightEdge=this.highlight.offset().left+newLeftVal+this.getTotalWidth(this.highlightText);newLeftVal=rightEdge>$(window).width()?newLeftVal-(rightEdge-$(window).width()):newLeftVal;var newTopVal;if(this.highlight.offset().top+this.getTotalHeight(this.highlight)+this.getTotalHeight(this.highlightText)<$(window).height()&&this.findIntersectors([this.highlight.offset().left+newLeftVal,this.highlight.offset().left+newLeftVal+this.getTotalWidth(this.highlightText)],[this.highlight.offset().top+this.getTotalHeight(this.highlight),this.highlight.offset().top+this.getTotalHeight(this.highlight)+this.getTotalHeight(this.highlightText)],".btn-group").length===0){newTopVal=this.getTotalHeight(this.highlight)}else{newTopVal=-5-this.getTotalHeight(this.highlightText)}this.highlightText.css("left",newLeftVal);this.highlightText.css("top",newTopVal);this.highlightText.css("text-align","center")}},findIntersectors:function(t_x,t_y,intersectorsSelector){var intersectors=[],self=this;this.$el.find(intersectorsSelector).each(function(){var $this=$(this);var thisPos=$this.offset();var i_x=[thisPos.left,thisPos.left+self.getTotalWidth($this)];var i_y=[thisPos.top,thisPos.top+self.getTotalHeight($this)];if(t_x[0]<i_x[1]&&t_x[1]>i_x[0]&&t_y[0]<i_y[1]&&t_y[1]>i_y[0]){intersectors.push($this)}});return intersectors},showMessageOnly:function(message){$("#tutorial-content").html("<div class='text-container'><div class='text'>"+app.lang.get(message,app.controller.context.get("module"))+"</div></div>");this.highlight=null;this.hideGlow()},getTotalWidth:function(el){var totalWidth=el.width();totalWidth+=parseInt(el.css("padding-left"),10)+parseInt(el.css("padding-right"),10);totalWidth+=parseInt(el.css("margin-left"),10)+parseInt(el.css("margin-right"),10);return totalWidth},getTotalHeight:function(el){var totalHeight=el.height();totalHeight+=parseInt(el.css("padding-top"),10)+parseInt(el.css("padding-bottom"),10);totalHeight+=parseInt(el.css("margin-top"),10)+parseInt(el.css("margin-bottom"),10);return totalHeight},scrollToEl:function($targetEl,callback){var viewportHeight=$(window).height(),elTop=$targetEl.offset().top,elHeight=$targetEl.height(),headerHeight=$(".navbar").height()+3||0,footerHeight=$("footer").height()||0,buffer=125,direction;if($.contains(".navbar",$targetEl)){headerHeight=0}if($.contains("footer",$targetEl)){footerHeight=0}if(elTop+elHeight>window.pageYOffset+viewportHeight-footerHeight){direction="down";buffer*=-1}else if(elTop+elHeight<window.pageYOffset+elHeight+headerHeight){direction="up"}else{direction="none";if(callback&&_.isFunction(callback)){callback()}}if(direction!=="none"){$("#content, .main-pane, .side-pane").animate({scrollTop:elTop+buffer},{duration:"fast",complete:function(){if(callback&&_.isFunction(callback)){callback()}}})}},render:function(){var tutorial=app.template.get("tutorial");$("body").append(tutorial());app.$contentEl.attr("aria-hidden",true);this.$el=$("#tutorial");this.delegateEvents();this.$el.show();return this},remove:function(){app.$contentEl.removeAttr("aria-hidden");if(app.tutorial.instance===this){app.tutorial.instance=null}if(this.highlight){this.highlight.stop(true,true)}delete this.highlight;delete this.highlightText;Backbone.View.prototype.remove.call(this)}})})(SUGAR.App);var SUGAR=SUGAR||{};(function(app){var _analytics={eventSplitter:/\s{2,}/,currentViewId:"",init:function(){if(!app.config.analytics||!app.config.analytics.enabled||!app.config.analytics.connector||!app.analytics.connectors[app.config.analytics.connector]){this.trackPageView=function(){};this.trackEvent=function(){};return}app.on("app:init",function(){app.events.register("app:analytics:init",this);app.analytics.connector=app.analytics.connectors[app.config.analytics.connector];app.analytics.connector.initialize();var origLayoutDispose=app.view.Layout.prototype._dispose;app.view.Layout.prototype._dispose=function(){app.analytics.detachAnalytics(this.$el);origLayoutDispose.call(this)};var origViewRender=app.view.View.prototype._render;app.view.View.prototype._render=function(){app.analytics.detachAnalytics(this.$el);origViewRender.call(this);app.analytics.attachAnalytics(this.$el)}}).on("app:start",function(){app.trigger("app:analytics:init");var id=app.config.analytics.id;if(_.isObject(id)){app.logger.warn("Analytics config id needs to be a valid tracking ID.");id=app.isNative?id.native:id.web}app.analytics.connector.start(id,app.config.analytics)}).on("app:sync:complete",function(){var serverInfo=app.metadata.getServerInfo();app.analytics.connector.set("appName","SugarCRM:"+app.config.platform+":"+(serverInfo.flavor||"").toLowerCase());app.analytics.connector.set("appVersion",serverInfo.version+":"+serverInfo.build)}).on("app:locale:change",function(){app.analytics.connector.set("language",app.user.getLanguage())}).on("app:view:change",function(layout,params){app.analytics.currentViewId=layout+(params.module?"/"+params.module:"");app.analytics.trackPageView(app.analytics.currentViewId)})},trackPageView:function(page){app.logger.debug("GAN-page: "+page);app.analytics.connector.trackPageView(page)},trackEvent:function(category,action,event,value){action=(_.isEmpty(action)&&event?event.currentTarget.id:action)||"[unknown]";app.logger.debug("GAN-event: "+category+":"+action+"("+value+")"+" on "+this.currentViewId);app.analytics.connector.trackEvent({category:category,action:action,label:this.currentViewId,value:value})},detachAnalytics:function($el){var $els=this.getTrackableElements($el);$els.unbind(".analytics")},attachAnalytics:function($el){var self=this;var $els=this.getTrackableElements($el);$els.unbind(".analytics");$els.each(function(i,el){self._attachAnalytics(el)})},getTrackableElements:function($el){var items=this._getTrackableElements($el);if($el.attr("track")){items=items.add($el)}return items},_getTrackableElements:function(scope){return $("[track]",scope)},_attachAnalytics:function(el){var $el=$(el);var track=($el.attr("track")||"").trim();if(track==="")return;var eventArgs=this.parseTrackTag(track);this._attachEvents(eventArgs.events,eventArgs.action,eventArgs.css,$el)},parseTrackTag:function(track){var result={events:"",action:"",css:""};var pieces=track.split(":");var actionCss=pieces[1]?pieces[1].split("."):pieces[0].split(".");result.events=pieces[0];result.action=actionCss[0];result.css=actionCss[1]||"";var ee=result.events.replace(this.eventSplitter," ").split(" ");ee=_.map(ee,function(e){return e+".analytics"});result.events=ee.join(" ");return result},_attachEvents:function(events,action,css,$el){if(events){$el.off(events);$el.on(events,function(e){app.analytics.trackEvent(e.type,action,e,css&&$(this).hasClass(css)?1:0)})}},dispose:function(){app.off(null,null,this)}};app.augment("analytics",_analytics)})(SUGAR.App);(function(app){var optOut;app.analytics=app.analytics||{};app.analytics.connectors=app.analytics.connectors||{};app.analytics.connectors.GoogleAnalytics={initialize:function(){(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date;a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","//www.google-analytics.com/analytics.js","ga")},start:function(id,options){options.gaOptions=options.gaOptions||{};_.defaults(options.gaOptions,{cookieDomain:"none"});ga("create",id,options.gaOptions);optOut=options.optOut;if(optOut){window["ga-disable-"+id]=true}},trackPageView:function(pageUri){ga("send","pageview",pageUri)},trackEvent:function(event){ga("send","event",event.category,event.action,event.label,event.value)},set:function(key,value){ga("set",key,value)}}})(SUGAR.App);(function($){var SearchAhead=function(element,options){this.options=$.extend({},$.fn.searchahead.defaults,options);this.$element=$(element);this.request=this.options.request;this.compiler=this.options.compiler;this.context=options.context||null;this.$button=this.options.buttonElement?$(this.options.buttonElement):null;this.throttle=this.options.throttle||this.throttle;this.throttleMillis=this.options.throttleMillis||this.throttleMillis;this.$menu=$(this.options.menu).appendTo(this.$element.parent().next(".typeahead-wrapper"));this.shown=false;this.minChars=this.options.minChars||1;this.patchIfZepto();this.listen();this.onEnterFn=this.options.onEnterFn||null};SearchAhead.prototype={constructor:SearchAhead,compile:function(data){return this.compiler({data:data,term:encodeURIComponent(this.query)})},disabled:false,enable:function(){this.disabled=false},disable:function(millis){var self=this;self.disabled=true;self.hide();setTimeout(function(){self.hide()},self.throttleMillis);setTimeout(function(){self.enable()},millis)},throttleMillis:250,throttle:function(callback,millis){var timerId=null;timerId=setTimeout(function(){
callback()},millis)},go:function(){var activeItem=null,href=null,term=null;activeItem=this.$menu.find(".active");href=activeItem.find("a").attr("href");if(href){if(this.onEnterFn){if(this.context){this.onEnterFn.call(this.context,href,true)}else{this.onEnterFn(href,true)}}else{window.location=href}}else{term=encodeURIComponent(this.$element.val());if(term&&term.length){if(this.onEnterFn){if(this.context){this.onEnterFn.call(this.context,term,false)}else{this.onEnterFn(term,false)}}}}return this.hide()},show:function(){this.$menu.show();this.shown=true;if(!this.disabled){this.$menu.show();this.shown=true;return this}return null},hide:function(){this.$menu.hide();this.shown=false;return this},buttonLookup:function(evt){evt.stopPropagation();evt.preventDefault();this.lookup(evt);this.$element.focus()},lookup:function(evt){var that=this,items;this.query=this.$element.val();if(!this.query){return this.shown?this.hide():this}this.onSearch(evt)},onSearch:function(evt){var self=this;if($.inArray(evt.keyCode,[40,38,9,13,27])===-1){evt.preventDefault();self.throttle(function(){self.query=self.$element.val();if(self.query&&self.query.length>=self.minChars){if(self.context){self.request.call(self.context,self.query)}else{self.request(self.query)}}else{self.hide()}},self.throttleMillis)}},provide:function(data){var trimmed,markup=this.compile(data),self=this;trimmed=markup.replace(/^\s+/,"").replace(/\s+$/,"");if(trimmed.length){self.$menu.html(markup);if(!self.disabled){return self.show()}}return null},move:function(event,direction){var active=this.$menu.find(".active").removeClass("active"),move;if(direction==="next"){move=active.next()}else{move=active.prev()}if(!move.length){move=$(this.$menu.find("li")[0])}move.addClass("active")},next:function(e){this.move(e,"next")},prev:function(e){this.move(e,"prev")},patchIfZepto:function(){if(!_.isUndefined(window.Zepto)){$.support={};$.proxy=function(fn,context){var args,tmp,proxy;if(typeof context==="string"){tmp=fn[context];context=fn;fn=tmp}if(!$.isFunction(fn)){return undefined}args=Array.prototype.slice.call(arguments,2);proxy=function(){return fn.apply(context,args.concat(Array.prototype.slice.call(arguments)))};proxy.guid=fn.guid=fn.guid||proxy.guid||$.guid++;return proxy}}},listen:function(){this.$element.on("blur",$.proxy(this.blur,this)).on("keypress",$.proxy(this.keypress,this)).on("keyup",$.proxy(this.keyup,this));if($.browser.webkit||$.browser.msie){this.$element.on("keydown",$.proxy(this.keypress,this))}if(this.$button){this.$button.on("click",$.proxy(this.buttonLookup,this));if(app.accessibility){app.accessibility.run(this.$button,"click")}}this.$menu.on("mouseenter","li",$.proxy(this.mouseenter,this))},keyup:function(e){switch(e.keyCode){case 40:case 38:break;case 9:if(!this.options.tabToSelect)break;case 13:if(this.onEnterFn){this.go();break}if(!this.shown)return;this.lookup(e);break;case 27:if(!this.shown)return;this.hide();break;default:this.lookup(e)}e.stopPropagation();e.preventDefault()},keypress:function(e){if(!this.shown)return;switch(e.keyCode){case 9:case 13:case 27:e.preventDefault();break;case 38:if(e.type!=="keydown")break;e.preventDefault();this.prev();break;case 40:if(e.type!=="keydown")break;e.preventDefault();this.next();break}e.stopPropagation()},blur:function(e){var that=this;setTimeout(function(){that.hide()},500)},mouseenter:function(e){this.$menu.find(".active").removeClass("active");$(e.currentTarget).addClass("active")}};$.fn.searchahead=function(){var option=arguments[0],args=Array.prototype.slice.call(arguments,1);return this.each(function(){var $this=$(this),data=$this.data("searchahead"),options=typeof option==="object"&&option;if(!data){$this.data("searchahead",data=new SearchAhead(this,options))}if(typeof option==="string"){data[option].apply(data,args)}})};$.fn.searchahead.defaults={items:10,menu:'<ul class="typeahead dropdown-menu"></ul>'};$.fn.searchahead.Constructor=SearchAhead})(window.$);(function(plugin){plugin(jQuery||Zepto,SUGAR.App.date)})(function($,date){var updateInterval=6e4,$liveDates=$([]),timeout;var run=function(){if(!$liveDates.length){return}timeout=setTimeout(run,updateInterval);liveRelativeDateGlobal.update()};var liveRelativeDateGlobal={update:function($el){$el=$el||$liveDates;$el.each(function(i,el){var $this=$(el),options=$this.data("liveRelativeDate"),value;if(!options){$liveDates=$liveDates.not(el);return}value=options.date?$this.data(options.date):$this.attr("datetime");var from=$this.html(),to=date(value).fromNow();if(from===to){return}var e=$.Event("change.liveRelativeDate");$this.trigger(e,[from,to]);if(!e.isDefaultPrevented()){$this.html(to)}})},pause:function(){clearTimeout(timeout);timeout=null},resume:function(){if(!timeout){run()}},interval:function(interval){if(interval===undefined){return updateInterval}updateInterval=interval}};var liveRelativeDateLocal={add:function($el,options){if(!$el||$el.length===0){return $el}options=options||{};$el.data("liveRelativeDate",options);$liveDates=$liveDates.add($el);liveRelativeDateGlobal.resume();return $el},destroy:function($el){$liveDates=$liveDates.not($el);$el.each(function(el){$(el).removeData("liveRelativeDate")});return $el},isLiveRelativeDate:function($els){var tracked=true;$.each($els,function(el){if($(el).data("liveRelativeDate")===undefined){tracked=false;return true}});return tracked}};$.liverelativedate=liveRelativeDateGlobal;$.fn.liverelativedate=function(method,options){if(!liveRelativeDateLocal[method]){options=method;method="add"}return liveRelativeDateLocal[method](this,options)}});SUGAR=SUGAR||{};(function(S){S.util=S.util||{};var oldFunction=S.util.ajaxCallInProgress;S.util.ajaxCallInProgress=function(){if(oldFunction&&oldFunction())return true;return SUGAR.Api.getCallsInProgressCount()>0}})(SUGAR);(function(app){app.augment("accessibility",{init:function(app){if(app.accessibility.helpers&&!_.isEmpty(app.accessibility.helpers)){app.view.Component.prototype.initialize=_.wrap(app.view.Component.prototype.initialize,function(func,options){func.call(this,options);this.on("render",function(){app.accessibility.run(this)},this)})}},run:function(component,helper){var helpers=this.whichHelpers(helper);_.each(helpers,function(klass,name){if(_.isFunction(klass.run)){app.logger.debug("Applying accessibility helper `"+name+"`");klass.run(component)}else{app.logger.debug("Unable to apply accessibility helper `"+name+"`")}})},whichHelpers:function(helper){var helpers;if(_.isUndefined(helper)){return app.accessibility.helpers}if(!_.isArray(helper)){helper=[helper]}helpers=_.reduce(helper,function(memo,name){if(!!app.accessibility.helpers[name]){memo[name]=app.accessibility.helpers[name]}return memo},{});return helpers},getElementTag:function($el){var tagName=($el.prop("tagName")||"").toLowerCase(),attributes=[tagName];if($el[0]&&$el[0].attributes){_.each($el[0].attributes,function(attr){attributes.push("["+attr.name+'="'+attr.value+'"]')})}else if($el.selector){return $el.selector}return attributes.join("")}},false)})(SUGAR.App);(function(app){app.accessibility=app.accessibility||{};app.accessibility.helpers=app.accessibility.helpers||{};app.accessibility.helpers.click={run:function(component){var self=this,$el=component instanceof app.view.Component?component.$el:component,events=$el.data("events");if(!events||!events.click){app.logger.debug("Found no events on "+app.accessibility.getElementTag($el));return}_.each(events.click,function(clickEvent){if(clickEvent.selector){$el.find(clickEvent.selector).each(function(){self._makeElementCompliant($(this))})}else{self._makeElementCompliant($el)}})},_isElementCompliant:function($el){var tag=$el.prop("tagName");if(!tag){app.logger.debug("The element does not have a tag name");return true}switch(tag.toLowerCase()){case"button":case"input":case"select":case"textarea":return true;case"a":case"area":return!!$el.attr("href");default:return $el[0].hasAttribute("tabindex")}},_makeElementCompliant:function($el){var tag=app.accessibility.getElementTag($el);if(this._isElementCompliant($el)){app.logger.debug("Found "+tag+" to be compliant")}else{app.logger.debug("Made "+tag+" compliant");$el.attr("tabindex",-1)}}}})(SUGAR.App);(function(app){app.accessibility=app.accessibility||{};app.accessibility.helpers=app.accessibility.helpers||{};app.accessibility.helpers.label={run:function(component){var self=this;if(!(component instanceof app.view.Field)){return}if(component.label&&component.fieldTag){component.$el.find(component.fieldTag).each(function(){self._makeElementCompliant($(this),component.label)})}},_isElementCompliant:function($el){var tag=$el.prop("tagName").toLowerCase(),ariaLabel=$el.attr("aria-label");return!_.contains(["input","button","select","textarea"],tag)||!_.isUndefined(ariaLabel)},_makeElementCompliant:function($el,label){if(!this._isElementCompliant($el)){$el.attr("aria-label",label)}}}})(SUGAR.App);(function(J,r,f){function s(a,b,d){a.addEventListener?a.addEventListener(b,d,!1):a.attachEvent("on"+b,d)}function A(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);a.shiftKey||(b=b.toLowerCase());return b}return h[a.which]?h[a.which]:B[a.which]?B[a.which]:String.fromCharCode(a.which).toLowerCase()}function t(a){a=a||{};var b=!1,d;for(d in n)a[d]?b=!0:n[d]=0;b||(u=!1)}function C(a,b,d,c,e,v){var g,k,f=[],h=d.type;if(!l[a])return[];"keyup"==h&&w(a)&&(b=[a]);for(g=0;g<l[a].length;++g)if(k=l[a][g],!(!c&&k.seq&&n[k.seq]!=k.level||h!=k.action||("keypress"!=h||d.metaKey||d.ctrlKey)&&b.sort().join(",")!==k.modifiers.sort().join(","))){var m=c&&k.seq==c&&k.level==v;(!c&&k.combo==e||m)&&l[a].splice(g,1);f.push(k)}return f}function K(a){var b=[];a.shiftKey&&b.push("shift");a.altKey&&b.push("alt");a.ctrlKey&&b.push("ctrl");a.metaKey&&b.push("meta");return b}function x(a,b,d,c){m.stopCallback(b,b.target||b.srcElement,d,c)||!1!==a(b,d)||(b.preventDefault?b.preventDefault():b.returnValue=!1,b.stopPropagation?b.stopPropagation():b.cancelBubble=!0)}function y(a){"number"!==typeof a.which&&(a.which=a.keyCode);var b=A(a);b&&("keyup"==a.type&&z===b?z=!1:m.handleKey(b,K(a),a))}function w(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function L(a,b,d,c){function e(b){return function(){u=b;++n[a];clearTimeout(D);D=setTimeout(t,1e3)}}function v(b){x(d,b,a);"keyup"!==c&&(z=A(b));setTimeout(t,10)}for(var g=n[a]=0;g<b.length;++g){var f=g+1===b.length?v:e(c||E(b[g+1]).action);F(b[g],f,c,a,g)}}function E(a,b){var d,c,e,f=[];d="+"===a?["+"]:a.split("+");for(e=0;e<d.length;++e)c=d[e],G[c]&&(c=G[c]),b&&"keypress"!=b&&H[c]&&(c=H[c],f.push("shift")),w(c)&&f.push(c);d=c;e=b;if(!e){if(!p){p={};for(var g in h)95<g&&112>g||h.hasOwnProperty(g)&&(p[h[g]]=g)}e=p[d]?"keydown":"keypress"}"keypress"==e&&f.length&&(e="keydown");return{key:c,modifiers:f,action:e}}function F(a,b,d,c,e){q[a+":"+d]=b;a=a.replace(/\s+/g," ");var f=a.split(" ");1<f.length?L(a,f,b,d):(d=E(a,d),l[d.key]=l[d.key]||[],C(d.key,d.modifiers,{type:d.action},c,a,e),l[d.key][c?"unshift":"push"]({callback:b,modifiers:d.modifiers,action:d.action,seq:c,level:e,combo:a}))}var h={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},B={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},H={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},G={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},p,l={},q={},n={},D,z=!1,I=!1,u=!1;for(f=1;20>f;++f)h[111+f]="f"+f;for(f=0;9>=f;++f)h[f+96]=f;s(r,"keypress",y);s(r,"keydown",y);s(r,"keyup",y);var m={bind:function(a,b,d){a=a instanceof Array?a:[a];for(var c=0;c<a.length;++c)F(a[c],b,d);return this},unbind:function(a,b){return m.bind(a,function(){},b)},trigger:function(a,b){if(q[a+":"+b])q[a+":"+b]({},a);return this},reset:function(){l={};q={};return this},stopCallback:function(a,b){return-1<(" "+b.className+" ").indexOf(" mousetrap ")?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable},handleKey:function(a,b,d){var c=C(a,b,d),e;b={};var f=0,g=!1;for(e=0;e<c.length;++e)c[e].seq&&(f=Math.max(f,c[e].level));for(e=0;e<c.length;++e)c[e].seq?c[e].level==f&&(g=!0,b[c[e].seq]=1,x(c[e].callback,d,c[e].combo,c[e].seq)):g||x(c[e].callback,d,c[e].combo);c="keypress"==d.type&&I;d.type!=u||w(a)||c||t(b);I=g&&"keydown"==d.type}};J.Mousetrap=m;"function"===typeof define&&define.amd&&define(m)})(window,document);(function(app){var bindShortcutKeys=function(keys,func,component){var wrapper=_.wrap(func,function(callback){var args=Array.prototype.slice.call(arguments,1);if(!component.disposed){callback.apply(component,args)}return false});Mousetrap.bind(keys,wrapper)};var unbindShortcutKeys=function(keys){Mousetrap.unbind(keys)};var findCallOnFocus=function(shortcuts,key){var callOnFocus=false,shortcutKey=_.find(shortcuts,function(shortcut,id){return _.contains(shortcut.keys,key)});if(shortcutKey){callOnFocus=!!shortcutKey.callOnFocus}return callOnFocus};var originalStopCallback=Mousetrap.stopCallback;Mousetrap.stopCallback=function(e,element,combo){var isInInputField=function(){return element.tagName==="INPUT"||element.tagName==="SELECT"||element.tagName==="TEXTAREA"||element.isContentEditable};if(!app.shortcuts.isEnabled()){return true}if(isInInputField()&&app.shortcuts.shouldCallOnFocus(combo)){$(element).blur();return false}else{return originalStopCallback(e,element)}};app.events.on("app:login:success",function(){app.shortcuts.enable()});app.events.on("app:logout:success",function(){app.shortcuts.disable()});app.events.once("app:init",function(){app.before("app:view:change",function(){app.shortcuts.clearSession();return true})});app.augment("shortcuts",{GLOBAL:"Global:",_currentSession:null,_savedSessions:[],_globalShortcuts:{},_enable:false,createSession:function(shortcutIds,layout){var self=this;this.clearSession();this._currentSession=new ShortcutSession(shortcutIds,layout);this._currentSession.activate();layout._dispose=_.wrap(layout._dispose,function(func){var args=Array.prototype.slice.call(arguments,1);func.apply(layout,args);self.deleteSavedSession(layout)})},clearSession:function(){if(this._currentSession){this._currentSession.deactivate();this._currentSession=null}},register:function(id,keys,func,component,callOnFocus){var session;if(!_.isArray(keys)){keys=[keys]}if(this._isGlobalShortcutKey(keys)){return}if(id.indexOf(this.GLOBAL)===0){this._globalShortcuts[id]={keys:keys,func:func,component:component};if(callOnFocus){this._globalShortcuts[id].callOnFocus=callOnFocus}bindShortcutKeys(keys,func,component)}else{session=this._getShortcutSessionForComponent(component);if(session){session.register(id,keys,func,component,callOnFocus)}}},unregister:function(id,component){var session=this._getShortcutSessionForComponent(component);if(session){session.unregister(id)}},saveSession:function(){this._savedSessions.push(this._currentSession);this.clearSession()},restoreSession:function(){if(this._savedSessions.length===0){return}this.clearSession();this._currentSession=this._savedSessions.pop();if(!this._currentSession){return}if(this._currentSession.layout.disposed){this.restoreSession()}else{this._currentSession.activate()}},enable:function(){this._enable=true},disable:function(){this._enable=false},isEnabled:function(){return this._enable},getCurrentSession:function(){return this._currentSession},getLastSavedSession:function(){return _.last(this._savedSessions)},deleteSavedSession:function(layout){var savedSessionToDelete,savedSession;for(var index=0;index<this._savedSessions.length;index++){savedSession=this._savedSessions[index];if(savedSession&&savedSession.layout===layout){savedSessionToDelete=index;break}}if(!_.isUndefined(savedSessionToDelete)){this._savedSessions.splice(savedSessionToDelete,1)}},getRegisteredGlobalShortcuts:function(){return _.map(this._globalShortcuts,function(shortcut,id){return{id:id,keys:shortcut.keys}})},shouldCallOnFocus:function(key){var shouldCall=false;if(this._currentSession){shouldCall=this._currentSession.shouldCallOnFocus(key)}if(!shouldCall){shouldCall=findCallOnFocus(this._globalShortcuts,key)}return shouldCall},_getShortcutSessionForComponent:function(component){var session,parentLayout=app.utils.getParentLayout(component);if(this._currentSession&&this._currentSession.layout===component){session=this._currentSession}else{session=_.find(this._savedSessions,function(shortcuts){return shortcuts&&shortcuts.layout===component})}if(_.isUndefined(session)&&parentLayout){session=this._getShortcutSessionForComponent(parentLayout)}return session},_isGlobalShortcutKey:function(keys){return!_.every(keys,function(key){return _.every(this._globalShortcuts,function(shortcut){return _.indexOf(shortcut.keys,key)===-1})},this)}},false);var ShortcutSession=function(shortcutIds,layout){this.layout=layout;this._active=false;this._shortcuts={};_.each(shortcutIds,function(id){this._allowShortcut(id)},this)};_.extend(ShortcutSession.prototype,{activate:function(){this.deactivate();this._active=true;_.each(this._shortcuts,function(shortcuts){if(!_.isEmpty(shortcuts)){bindShortcutKeys(shortcuts.keys,shortcuts.func,shortcuts.component)}},this)},deactivate:function(){if(this.isActive()){_.each(this._shortcuts,function(shortcuts){_.each(shortcuts.keys,function(key){unbindShortcutKeys(key)})},this);this._active=false}},isActive:function(){return this._active},register:function(id,keys,func,component,callOnFocus){if(!this._isShortcutAllowed(id)||this._isInDashboard(component)){return}if(!_.isArray(keys)){keys=[keys]}this.unregister(id);this._bindShortcutKeys(id,keys,func,component,callOnFocus)},unregister:function(id){if(!this._isShortcutAllowed(id)){return}if(this.isActive()){_.each(this._shortcuts[id].keys,function(key){unbindShortcutKeys(key)})}this._shortcuts[id]={}},getRegisteredShortcuts:function(){var registeredShortcuts=[];_.each(this._shortcuts,function(shortcut,id){if(!_.isEmpty(shortcut)){registeredShortcuts.push({id:id,keys:shortcut.keys})}});return registeredShortcuts},shouldCallOnFocus:function(key){var shouldCall=false;if(this.isActive()){shouldCall=findCallOnFocus(this._shortcuts,key)}return shouldCall},_bindShortcutKeys:function(id,keys,func,component,callOnFocus){if(!this._isShortcutAllowed(id)){return}this._shortcuts[id].keys=keys;this._shortcuts[id].func=func;this._shortcuts[id].component=component;if(callOnFocus){this._shortcuts[id].callOnFocus=callOnFocus}if(this.isActive()){bindShortcutKeys(keys,func,component)}},_allowShortcut:function(id){this._shortcuts[id]={}},_isShortcutAllowed:function(id){return!_.isUndefined(this._shortcuts[id])},_isInDashboard:function(component){var layout=component.layout||!_.isUndefined(component.view)&&component.view.layout;return layout.type==="dashlet"||layout.type==="dashboard"}})})(SUGAR.App);(function(app){app.events.on("app:init",function(){_.mixin({isEmptyValue:function(value){return!_.isNumber(value)&&!_.isBoolean(value)&&!_.isDate(value)&&_.isEmpty(value)},changed:function(obj1,obj2){if(_.isEmpty(obj1)&&_.isEmpty(obj2)){return}var result={};var allKeys=_.keys(_.extend(result,obj2,obj1));_.each(allKeys,function(key){var changed=false;if(!_.has(obj1,key)||!_.has(obj2,key)||!_.isEqual(obj1[key],obj2[key])){changed=true}result[key]=changed});return result}})})})(SUGAR.App);