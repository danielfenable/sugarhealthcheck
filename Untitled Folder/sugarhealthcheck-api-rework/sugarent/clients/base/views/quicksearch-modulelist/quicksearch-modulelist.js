/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({className:'table-cell quicksearch-modulelist-wrapper',plugins:['Dropdown','EllipsisInline'],dropdownItemSelector:'[data-action=select-module], [data-action=select-all]',events:{'click [data-action=select-all]':'selectAllModules','click [data-action=select-module]':'selectModule','keydown [data-action=select-all]':'allModulesKeydownHandler','keydown [data-action=select-module]':'moduleKeydownHandler','click [data-toggle=dropdown]':'moduleDropdownClick'},blacklistModules:['Tags'],initialize:function(options){this._super('initialize',[options]);this.hide();this.collection=this.layout.collection||app.data.createMixedBeanCollection();this.searchModuleFilter=new Backbone.Collection(null,{comparator:function(model){return app.lang.getModuleName(model.id,{plural:true});}});this.stateKey=app.user.lastState.buildKey('quicksearch','modulelist',this.name);this._moduleIconTemplate=app.template.getView(this.name+'.module-avatar');this.moduleIcons={};app.events.on('app:sync:complete',function(){this.populateModules();var previousModuleSelection=app.user.lastState.get(this.stateKey);if(_.isEmpty(previousModuleSelection)){this.searchModuleFilter.allSelected=true;}else{_.each(previousModuleSelection,function(module){this.searchModuleFilter.get(module).set('selected',true);},this);}
this._setSelectedModules();var moduleIconObj=this._buildModuleIconList();this.moduleIcons={icon:moduleIconObj};this.render();this.layout.off('route:search',this.populateModuleSelectionFromContext);this.layout.on('route:search',this.populateModuleSelectionFromContext,this);this.populateModuleSelectionFromContext();},this);this.layout.on('quicksearch:expanded',this.show,this);this.layout.on('quicksearch:collapse',this.hide,this);this.layout.on('navigate:next:component navigate:previous:component navigate:to:component',function(){this.$el.removeClass('open');},this);},populateModuleSelectionFromContext:function(){var previousModuleSelection=this.context.get('module_list');this.searchModuleFilter.invoke('set',{selected:false});this.$('[data-action=select-module]').removeClass('selected');if(_.isEmpty(previousModuleSelection)){this.searchModuleFilter.allSelected=true;this.$('[data-action=select-all]').addClass('selected');}else{this.searchModuleFilter.allSelected=false;this.$('[data-action=select-all]').removeClass('selected');_.each(previousModuleSelection,function(module){var moduleFilter=this.searchModuleFilter.get(module);if(moduleFilter){moduleFilter.set('selected',true);this.$('[data-action=select-module][data-module='+module+']').addClass('selected');}},this);}
this._setSelectedModules();this._updateModuleIcons();},selectModule:function(event){event.stopImmediatePropagation();var $li=$(event.currentTarget);var module=$li.data('module');var moduleModel=this.searchModuleFilter.get(module);if(this.searchModuleFilter.allSelected){this.$('[data-action=select-all]').removeClass('selected',false);this.searchModuleFilter.allSelected=false;}
var checkModule=!moduleModel.get('selected');moduleModel.set('selected',checkModule);$li.toggleClass('selected',checkModule);var selectedLength=this.searchModuleFilter.where({'selected':true}).length;if(selectedLength===this.searchModuleFilter.length){this.searchModuleFilter.invoke('set',{selected:false});selectedLength=0;}
if(selectedLength===0){this.searchModuleFilter.allSelected=true;this.$('[data-action=select-all]').addClass('selected');this.$('[data-action=select-module]').removeClass('selected');}
this._setSelectedModules();this._updateModuleIcons();},selectAllModules:function(event){event.stopImmediatePropagation();this.$('[data-action=select-all]').addClass('selected');this.$('[data-action=select-module]').removeClass('selected');this.searchModuleFilter.invoke('set',{selected:false});this.searchModuleFilter.allSelected=true;this._setSelectedModules();this._updateModuleIcons();},allModulesKeydownHandler:function(event){if(event.keyCode===32){this.selectAllModules(event);event.preventDefault();}},moduleKeydownHandler:function(event){if(event.keyCode===32){this.selectModule(event);event.preventDefault();}},moduleDropdownClick:function(){this.layout.trigger('quicksearch:results:close');},_updateModuleIcons:function(){var $moduleIconContainer=this.$('[data-label=module-icons]');$moduleIconContainer.empty();var moduleIconObj=this._buildModuleIconList();$moduleIconContainer.append(this._moduleIconTemplate({icon:moduleIconObj}));},_buildModuleIconList:function(){var moduleIconObj=[];if(this.collection.selectedModules.length===0){moduleIconObj.push({});}else if(this.collection.selectedModules.length<=3){_.each(this.collection.selectedModules,function(module){moduleIconObj.push({module:module});},this);}else{moduleIconObj.push({multiple:true});}
return moduleIconObj;},populateModules:function(){if(this.disposed){return;}
this.searchModuleFilter.reset();var modules=app.metadata.getModules()||{};_.each(modules,function(meta,module){if(meta.globalSearchEnabled&&app.acl.hasAccess.call(app.acl,'view',module)&&!_.contains(this.blacklistModules,module)){var moduleModel=new Backbone.Model({id:module,selected:false});this.searchModuleFilter.add(moduleModel);}},this);},_setSelectedModules:function(){var selectedModules=[];if(!this.searchModuleFilter.allSelected){this.searchModuleFilter.each(function(model){if(model.get('selected')){selectedModules.push(model.id);}});}
this.collection.selectedModules=selectedModules;app.user.lastState.set(this.stateKey,this.collection.selectedModules);}})