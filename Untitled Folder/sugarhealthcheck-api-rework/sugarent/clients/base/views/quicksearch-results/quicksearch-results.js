/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({events:{'click .view-all-results':'viewAllResultsClicked'},initialize:function(options){this._super('initialize',[options]);this._fieldsMeta={};this.collection=this.layout.collection||app.data.createMixedBeanCollection();this.selectedTags=this.layout.selectedTags||[];this.activeIndex=null;this.layout.on('quicksearch:search:underway',function(){this.close();this.render();this.open();},this);this.layout.on('quicksearch:close quicksearch:results:close',function(){this.close();},this);this.on('navigate:focus:receive',function(next){if(next){this.activeIndex=0;}else{this.activeIndex=this.countRecordElements()-1;}
this._highlightActive();this.attachKeydownEvent();},this);this.on('navigate:focus:lost',function(){this.activeIndex=null;this.$('.active').removeClass('active');this.disposeKeydownEvent();},this);app.events.on('app:sync:complete',this._clearFieldsMeta,this);},_clearFieldsMeta:function(){this._fieldsMeta={};},bindDataChange:function(){this.collection.on('sync',function(collection){if(this.disposed){return;}
var gsUtils=app.utils.GlobalSearch;gsUtils.formatRecords(collection,false);_.each(this.collection.models,function(model){model.link='#'+app.router.buildRoute(model.module,model.id);if(this.layout.v2){var moduleMeta=this._fieldsMeta[model.module]||gsUtils.getFieldsMeta(model.module,{linkablePrimary:false});this._fieldsMeta[model.module]=moduleMeta;model.primaryFields=gsUtils.highlightFields(model,moduleMeta.primaryFields);model.secondaryFields=gsUtils.highlightFields(model,{},true);model.primaryFields=_.values(model.primaryFields);model.secondaryFields=_.values(model.secondaryFields).slice(0,3);}else{if(model.searchInfo.highlighted){_.find(model.searchInfo.highlighted,function(val,key){if(key==='name'){model.name=new Handlebars.SafeString(val.text);}else{model.field_name=app.lang.get(val.label,val.module);model.field_value=new Handlebars.SafeString(val.text);return true;}});}}},this);this.searchLink=app.utils.GlobalSearch.buildSearchRoute(collection.query,{modules:this.collection.selectedModules,tags:_.pluck(this.selectedTags,'name')});this.activeIndex=null;this.render();this.open();var shownTags=_.pluck(collection.tags,'name');var selectedTags=_.pluck(this.selectedTags,'name');shownTags=_.difference(shownTags,selectedTags);this.$('.typeahead').toggleClass('tagsShown',shownTags.length>0);this.layout.trigger('quicksearch:tag:'+shownTags.length>0?'open':'close');},this);},open:function(){this.$('.typeahead').show();},close:function(){this.clearActive();this.collection.reset();this.$('.typeahead').hide();},clearActive:function(){this.activeIndex=null;this.$('.active').removeClass('active');this.disposeKeydownEvent();},isFocusable:function(){return this.collection.models.length>0;},moveForward:function(){if(this.activeIndex<this.countRecordElements()-1){this.activeIndex++;this._highlightActive();}else{this._handleBoundary(true);}},moveBackward:function(){if(this.activeIndex>0){this.activeIndex--;this._highlightActive();}else{this._handleBoundary(false);}},_highlightActive:function(){this.$('.active').removeClass('active');var nthChild=this.activeIndex+1;this.$('li:nth-child('+nthChild+')').addClass('active').find('a').focus();},countRecordElements:function(){var hasMore=(this.collection.next_offset>-1)?1:0;return this.collection.models.length+hasMore;},_handleBoundary:function(next){var event='navigate:next:component';if(!next){event='navigate:previous:component';}
if(this.layout.triggerBefore(event)){this.clearActive();this.layout.trigger(event);}},attachKeydownEvent:function(){this.$el.on('keydown',_.bind(this.keydownHandler,this));},disposeKeydownEvent:function(){this.$el.off();},keydownHandler:function(e){switch(e.keyCode){case 40:this.moveForward();break;case 38:this.moveBackward();break;case 9:this.close();this.trigger('navigate:focus:lost');}},viewAllResultsClicked:function(e){this.close();},unbind:function(){this.disposeKeydownEvent();this._super('unbind');}})