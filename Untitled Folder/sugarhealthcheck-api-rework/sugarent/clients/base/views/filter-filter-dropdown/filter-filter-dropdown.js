/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({tagName:"span",className:"table-cell",events:{"click .choice-filter.choice-filter-clickable":"handleEditFilter","click .choice-filter-close":"handleClearFilter"},labelDropdownTitle:'LBL_FILTER',labelCreateNewFilter:'LBL_FILTER_CREATE_NEW',labelAllRecords:'LBL_FILTER_ALL_RECORDS',labelAllRecordsFormatted:null,initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this._select2formatSelectionTemplate=app.template.get("filter-filter-dropdown.selection-partial");this._select2formatResultTemplate=app.template.get("filter-filter-dropdown.result-partial");this.listenTo(this.layout,"filter:select:filter",this.handleSelect);this.listenTo(this.layout,"filter:change:module",this.handleModuleChange);this.listenTo(this.layout,"filter:render:filter",this._renderHtml);},filterDropdownEnabled:true,_renderHtml:function(){if(!this.layout.filters){return;}
this._super('_renderHtml');this.filterList=this.getFilterList();this._renderDropdown(this.filterList);},getFilterList:function(){var filters=[];if(this.layout.canCreateFilter()){filters.push({id:"create",text:app.lang.get(this.labelCreateNewFilter)});}
if(this.layout.filters.collection.get('all_records')&&this.labelAllRecordsFormatted){this.layout.filters.collection.get('all_records').set('name',this.labelAllRecordsFormatted);this.layout.filters.collection.sort();}
var firstNonEditable=false;this.layout.filters.collection.each(function(model){var opts={id:model.id,text:this.layout.filters.collection._getTranslatedFilterName(model)};if(model.get("editable")===false&&!firstNonEditable){opts.firstNonUserFilter=true;firstNonEditable=true;}
filters.push(opts);},this);return filters;},_renderDropdown:function(data){var self=this;this.filterNode=this.$(".search-filter");this.filterNode.select2({data:data,multiple:false,minimumResultsForSearch:7,formatSelection:_.bind(this.formatSelection,this),formatResult:_.bind(this.formatResult,this),formatResultCssClass:_.bind(this.formatResultCssClass,this),dropdownCss:{width:'auto'},dropdownCssClass:'search-filter-dropdown',initSelection:_.bind(this.initSelection,this),escapeMarkup:function(m){return m;},shouldFocusInput:function(){return false;},width:'off'});app.shortcuts.register('Filter:Create',['f c','ctrl+alt+8'],function(){this.filterNode.select2('val','create',true);},this);app.shortcuts.register('Filter:Edit','f e',function(){this.$('.choice-filter.choice-filter-clickable').click();},this);app.shortcuts.register('Filter:Show','f m',function(){this.filterNode.select2('open');},this);if(!this.filterDropdownEnabled){this.filterNode.select2("disable");}
this.filterNode.off("change");this.filterNode.on("change",function(e){self.layout.trigger('filter:change:filter',e.val);});},handleSelect:function(id){this.filterNode.select2('val',id,true);},initSelection:function(el,callback){var data,model,val=el.val();if(val==='create'){data={id:"create",text:app.lang.get(this.labelCreateNewFilter)};}else{model=this.layout.filters.collection.get(val);if(!model){data={id:"all_records",text:app.lang.get(this.labelAllRecords)};}else if(val==="all_records"){data=this.formatAllRecordsFilter(null,model);}else{data={id:model.id,text:this.layout.filters.collection._getTranslatedFilterName(model)};}}
callback(data);},formatSelection:function(item){var ctx={},safeString;item=_.clone(item);this.toggleFilterCursor(this.isFilterEditable(item.id));if(item.id==='all_records'){item=this.formatAllRecordsFilter(item);}
safeString=Handlebars.Utils.escapeExpression(item.text);this.$('.choice-filter-label').html(safeString);if(item.id!=='all_records'){this.$('.choice-filter-close').show();}else{this.$('.choice-filter-close').hide();}
ctx.label=app.lang.get(this.labelDropdownTitle);ctx.enabled=this.filterDropdownEnabled;return this._select2formatSelectionTemplate(ctx);},formatResult:function(option){if(option.id===this.layout.getLastFilter(this.layout.layout.currentModule,this.layout.layoutType)){option.icon='fa-check';}else if(option.id==='create'){option.icon='fa-plus';}else{option.icon=undefined;}
return this._select2formatResultTemplate(option);},formatResultCssClass:function(item){if(item.id==='create'){return'select2-result-border-bottom';}
if(item.firstNonUserFilter){return'select2-result-border-top';}},isFilterEditable:function(id){if(!this.layout.canCreateFilter()||!this.filterDropdownEnabled||this.layout.showingActivities){return false;}
if(id==="create"||id==='all_records'){return true;}else{return!this.layout.filters.collection.get(id)||this.layout.filters.collection.get(id).get('editable')!==false;}},toggleFilterCursor:function(editable){if(editable){this.$('.choice-filter').css("cursor","pointer").addClass('choice-filter-clickable');}else{this.$('.choice-filter').css("cursor","not-allowed").removeClass('choice-filter-clickable');}},formatAllRecordsFilter:function(item,model){item=item||{id:'all_records'};var allRelatedModules=_.indexOf([this.module,'all_modules'],this.layout.layout.currentModule)>-1;if(this.isFilterEditable(item.id)){item.text=app.lang.get(this.labelCreateNewFilter);}else if(this.layout.layoutType==='record'&&allRelatedModules){item.text=app.lang.get(this.labelAllRecords);this.toggleFilterCursor(false);}else if(model){item.text=this.layout.filters.collection._getTranslatedFilterName(model);}
return item;},handleEditFilter:function(){var filterId=this.filterNode.val(),filterModel;if(filterId==='all_records'){this.layout.trigger("filter:select:filter",'create');}else{filterModel=this.layout.filters.collection.get(filterId);}
if(filterModel&&filterModel.get("editable")!==false){this.layout.trigger("filter:create:open",filterModel);}},handleModuleChange:function(linkModuleName,linkName){this.filterDropdownEnabled=(linkName!=="all_modules");},handleClearFilter:function(evt){evt.stopPropagation();this.layout.clearLastFilter(this.layout.layout.currentModule,this.layout.layoutType);var filterId;if(this.context.get('currentFilterId')===this.layout.filters.collection.defaultFilterFromMeta){filterId='all_records';}else{filterId=this.layout.filters.collection.defaultFilterFromMeta;}
this.layout.trigger('filter:select:filter',filterId);},_dispose:function(){if(!_.isEmpty(this.filterNode)){this.filterNode.select2('destroy');}
app.view.View.prototype._dispose.call(this);}})