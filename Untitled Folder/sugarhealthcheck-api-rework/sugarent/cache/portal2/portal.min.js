
(function(app){app.error=_.extend(app.error);function backToLogin(bDismiss){if(bDismiss)app.alert.dismissAll();app.router.login();}
function alertUser(key,title,msg){app.alert.show(key,{level:'error',title:app.lang.get(title),messages:app.lang.get(msg)});}
app.events.on('app:sync:public:error',function(error){alertUser('public_sync_failure','Unable to load the application.');});app.error.handleNeedLoginError=function(error){backToLogin(true);alertUser("needs_login_error","LBL_PORTAL_INVALID_CREDS_TITLE","LBL_PORTAL_INVALID_CREDS");};app.error.handleInvalidGrantError=function(error){backToLogin(true);alertUser("invalid_grant_error","LBL_PORTAL_INVALID_GRANT_TITLE","LBL_PORTAL_INVALID_GRANT");};app.error.handleInvalidClientError=function(error){backToLogin(true);alertUser("invalid_client_error","LBL_PORTAL_AUTH_FAILED_TITLE","LBL_PORTAL_AUTH_FAILED");};app.error.handleInvalidRequestError=function(error){backToLogin(true);alertUser("invalid_request_error","LBL_PORTAL_INVALID_REQUEST_TITLE","LBL_PORTAL_INVALID_REQUEST");};app.error.handleUnspecified400Error=function(error){app.controller.loadView({layout:'error',errorType:'400',module:'Error',create:true});};app.error.handleTimeoutError=function(error){backToLogin(true);alertUser("timeout_error","LBL_PORTAL_REQUEST_TIMEOUT_TITLE","LBL_PORTAL_REQUEST_TIMEOUT");};app.error.handleUnauthorizedError=function(error){backToLogin(true);alertUser("unauthorized_request_error","LBL_PORTAL_UNAUTHORIZED_TITLE","LBL_PORTAL_UNAUTHORIZED");};app.error.handleForbiddenError=function(error){app.alert.dismissAll();if(error.code=="portal_not_configured"){backToLogin(true);}
alertUser("forbidden_request_error","LBL_PORTAL_RESOURCE_UNAVAILABLE_TITLE",error.message?error.message:"LBL_PORTAL_RESOURCE_UNAVAILABLE");};app.error.handleNotFoundError=function(error){app.controller.loadView({layout:"error",errorType:"404",module:"Error",create:true});};app.error.handleMethodNotAllowedError=function(error){backToLogin(true);alertUser("not_allowed_error","LBL_PORTAL_METHOD_NOT_ALLOWED_TITLE","LBL_PORTAL_METHOD_NOT_ALLOWED");};app.error.handleHeaderPreconditionFailed=function(error){app.sync();};app.error.handleMethodFailureError=function(error){backToLogin(true);alertUser("precondtion_failure_error","LBL_PORTAL_PRECONDITION_MISSING_TITLE","LBL_PORTAL_PRECONDITION_MISSING");};app.error.handleServerError=function(error){app.controller.loadView({layout:"error",errorType:error.status||"500",module:"Error",error:error,create:true});};})(SUGAR.App);
/* End of File portal2/error.js */


(function(app){app.user=_.extend(app.user);app.user.isSupportPortalUser=function(){return this.get('type')==='support_portal';};})(SUGAR.App);
/* End of File portal2/user.js */


(function(app){app.events.on("app:init",function(){var routes;routes=[{name:"dashboard",route:"",callback:function(){app.controller.loadView({layout:"dashboard"});}},{name:"logout",route:"logout/?clear=:clear"},{name:"logout",route:"logout"},{name:"signup",route:"signup",callback:function(){app.controller.loadView({module:"Signup",layout:"signup",create:true});}},{name:"search",route:"search/:query",callback:function(query){try{var decodedQuery=decodeURIComponent(query);app.controller.loadView({mixed:true,module:"Search",layout:"search",query:decodedQuery,skipFetch:true});}catch(err){app.logger.error("Search term not a valid URI component.  Will not route search/"+query);}}},{name:"create",route:":module/create",callback:function(module){app.controller.loadView({module:module,layout:"records"});app.drawer.open({layout:'create',context:{create:true}},_.bind(function(context,model){var module=context.get("module")||model.module,route=app.router.buildRoute(module);app.router.navigate(route,{trigger:true});},this));}},{name:"profile",route:"profile",callback:function(){app.controller.loadView({layout:"record",module:"Contacts",modelId:app.user.get("id")});}},{name:"listHome",route:"Home",callback:function(){app.controller.loadView({layout:"dashboard"});}},{name:"list",route:":module"},{name:"record",route:":module/:id"}];app.routing.setRoutes(routes);});var oHandleRenderError=app.error.handleRenderError;app.error.handleRenderError=function(component,method,additionalInfo){function handlePortalRenderDenied(c){var title,message;title=app.lang.get('ERR_NO_VIEW_ACCESS_TITLE');message=app.utils.formatString(app.lang.get('ERR_NO_VIEW_ACCESS_MSG'),[c.module]);app.logger.warn(title+":\n"+message);}
if(method==='view_render_denied'){handlePortalRenderDenied(component);}else{oHandleRenderError(component,method,additionalInfo);}};var oRoutingBefore=app.routing.beforeRoute;app.routing.beforeRoute=function(route,args){var dm,nonModuleRoutes;nonModuleRoutes=["search","error","profile","profileedit","logout"];app.logger.debug("Loading route. "+(route?route:'No route or undefined!'));if(!oRoutingBefore.call(this,route,args))return false;function alertUser(msg){msg=msg||"LBL_PORTAL_MIN_MODULES";app.alert.show("no-sidecar-access",{level:"error",title:app.lang.get("LBL_PORTAL_ERROR"),messages:[app.lang.get(msg)]});}
if(route==='index'){dm=typeof(app.config)!==undefined&&app.config.defaultModule?app.config.defaultModule:null;if(dm&&app.metadata.getModule(dm)&&app.acl.hasAccess('read',dm)){app.router.list(dm);}else if(app.acl.hasAccess('read','Home')){app.router.index();}else{alertUser();return false;}}else if(!_.include(nonModuleRoutes,route)&&args[0]&&!app.metadata.getModule(args[0])||!app.acl.hasAccess('read',args[0])){app.logger.error("Module not loaded or user does not have access. ",route);alertUser("LBL_PORTAL_ROUTE_ERROR");return false;}
return true;};app.Controller=app.Controller.extend({loadView:function(params){var self=this,callbackAppNotAvailable,options;if(params.layout==='login'){app.Controller.__super__.loadView.call(this,params);}
if(app.config&&app.config.appStatus=='offline'){if(params.layout!=='login'){options={module:"Login",layout:"login",create:true};app.Controller.__super__.loadView.call(self,options);}
callbackAppNotAvailable=function(data){app.alert.show('appOffline',{level:"error",title:app.lang.get('LBL_PORTAL_ERROR'),messages:app.lang.get('LBL_PORTAL_OFFLINE'),autoclose:false});};if(app.api.isAuthenticated()){app.logout({success:callbackAppNotAvailable,error:callbackAppNotAvailable},{clear:true});}else{callbackAppNotAvailable();}
return;}
if(params.layout!=='login'){app.Controller.__super__.loadView.call(this,params);}}});var __superBeanSave__=app.Bean.prototype.save;app.Bean.prototype.save=function(attributes,options){var defaultParams={portal_flag:1,portal_viewable:1};var moduleFields=app.metadata.getModule(this.module).fields||{};for(var field in defaultParams){if(moduleFields[field]){this.set(field,defaultParams[field],{silent:true});}}
__superBeanSave__.call(this,attributes,options);};app.events.on('app:sync:complete',function(){app.date.lang(app.user.getPreference('language'));});})(SUGAR.App);
/* End of File portal2/portal.js */

