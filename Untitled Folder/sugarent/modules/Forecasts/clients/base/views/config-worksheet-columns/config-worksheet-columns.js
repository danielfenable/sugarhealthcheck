/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({extendsFrom:'ConfigPanelView',wkstColumnsSelect2:undefined,selectedOptions:[],allOptions:[],likelyFieldObj:{},bestFieldObj:{},worstFieldObj:{},initialize:function(options){if(app.metadata.getModule('Opportunities','config').opps_view_by==='Opportunities'){_.each(_.first(options.meta.panels).fields,function(field){if(field.label_module&&field.label_module==='RevenueLineItems'){field.label_module='Opportunities';}});}
this._super('initialize',[options]);this.allOptions=[];this.selectedOptions=[];var cfgFields=this.model.get('worksheet_columns'),index=0;_.each(this.meta.panels[0].fields,function(field){var obj={id:field.name,text:app.lang.get(field.label,this._getLabelModule(field.name,field.label_module)),index:index,locked:field.locked||false},cField=_.find(cfgFields,function(cfgField){return cfgField==field.name;},this),addFieldToFullList=true;if(field.name=='best_case'){this.bestFieldObj=obj;addFieldToFullList=(this.model.get('show_worksheet_best')===1);}else if(field.name=='likely_case'){this.likelyFieldObj=obj;addFieldToFullList=(this.model.get('show_worksheet_likely')===1);}else if(field.name=='worst_case'){this.worstFieldObj=obj;addFieldToFullList=(this.model.get('show_worksheet_worst')===1);}
if(addFieldToFullList){this.allOptions.push(obj);}
if(!_.isUndefined(cField)){this.selectedOptions.push(obj);}
index++;},this);},_updateTitleValues:function(){},bindDataChange:function(){this.model.on('change:worksheet_columns',function(){var arr=[],cfgFields=this.model.get('worksheet_columns'),metaFields=this.meta.panels[0].fields;_.each(metaFields,function(metaField){_.each(cfgFields,function(field){if(metaField.name==field){arr.push(app.lang.get(metaField.label,this._getLabelModule(metaField.name,metaField.label_module)));}},this);},this);this.titleSelectedValues=arr.join(', ');this.titleSelectedValues=this.titleSelectedValues.slice(0,50)+'...';this.updateTitle();},this);this.model.trigger('change:worksheet_columns');this.model.on('change:scenarios',function(){if(this.model.get('show_worksheet_best')){this.addOption(this.bestFieldObj);}else{this.removeOption(this.bestFieldObj);}
if(this.model.get('show_worksheet_likely')){this.addOption(this.likelyFieldObj);}else{this.removeOption(this.likelyFieldObj);}
if(this.model.get('show_worksheet_worst')){this.addOption(this.worstFieldObj);}else{this.removeOption(this.worstFieldObj);}
this._render();var arr=[];_.each(this.selectedOptions,function(field){arr.push(field.id);},this);this.model.set('worksheet_columns',arr);},this);},addOption:function(fieldObj){if(!_.contains(this.allOptions,fieldObj)){this.allOptions.splice(fieldObj.index,0,fieldObj);this.selectedOptions.splice(fieldObj.index,0,fieldObj);}},removeOption:function(fieldObj){this.allOptions=_.without(this.allOptions,fieldObj);this.selectedOptions=_.without(this.selectedOptions,fieldObj);},_render:function(){this._super('_render');this.wkstColumnsSelect2=this.$('#wkstColumnsSelect').select2({data:this.allOptions,multiple:true,containerCssClass:'select2-choices-pills-close',initSelection:_.bind(function(element,callback){callback(this.selectedOptions);},this)});this.wkstColumnsSelect2.select2('val',this.selectedOptions);this.wkstColumnsSelect2.on('change',_.bind(this.handleColumnModelChange,this));},handleColumnModelChange:function(evt){if(!_.isUndefined(evt.added)){this.selectedOptions.push(evt.added);}
if(!_.isUndefined(evt.removed)){this.selectedOptions=_.without(this.selectedOptions,evt.removed);}
this.model.set('worksheet_columns',evt.val);},_dispose:function(){if(this.wkstColumnsSelect2){this.wkstColumnsSelect2.off();this.wkstColumnsSelect2.select2('destroy');this.wkstColumnsSelect2=null;}
this._super('_dispose');},_getLabelModule:function(fieldName,setModule){var labelModule=setModule||'Forecasts';if(fieldName==='parent_name'){labelModule=this.model.get('forecast_by');}
return labelModule;}})